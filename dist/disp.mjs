var ra=Object.create;var Ze=Object.defineProperty;var ia=Object.getOwnPropertyDescriptor;var sa=Object.getOwnPropertyNames;var la=Object.getPrototypeOf,na=Object.prototype.hasOwnProperty;var oa=(e,t,r)=>t in e?Ze(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var ca=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var ha=(e,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of sa(t))!na.call(e,n)&&n!==r&&Ze(e,n,{get:()=>t[n],enumerable:!(a=ia(t,n))||a.enumerable});return e};var Et=(e,t,r)=>(r=e!=null?ra(la(e)):{},ha(t||!e||!e.__esModule?Ze(r,"default",{value:e,enumerable:!0}):r,e));var Y=(e,t,r)=>(oa(e,typeof t!="symbol"?t+"":t,r),r);var it=ca((Pf,rt)=>{(function(){"use strict";let e={fatal:!0},t=[new TextDecoder("iso-8859-15",e),new TextDecoder("utf-8",e),new TextDecoder("sjis",e),new TextDecoder("euc-jp",e),new TextDecoder("ascii")],r={debug:!1,parse:function(a,n){if(a instanceof Uint8Array)return r.Uint8(a);if(typeof a=="string")return r.Base64(a);if(a instanceof HTMLElement&&a.type==="file")return r.addListener(a,n);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(a,n){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(a===void 0||!(a instanceof HTMLElement)||a.tagName!=="INPUT"||a.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;n=n||function(){},a.addEventListener("change",function(m){if(!m.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let u=new FileReader;u.readAsArrayBuffer(m.target.files[0]),u.onload=function(y){n(r.Uint8(new Uint8Array(y.target.result)))}})},Base64:function(a){let n=function(y){var E="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(y=y.replace(/^.*?base64,/,""),y=String(y).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(y))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");y+="==".slice(2-(3&y.length));let C,f="",o,s,i=0;for(;i<y.length;)C=E.indexOf(y.charAt(i++))<<18|E.indexOf(y.charAt(i++))<<12|(o=E.indexOf(y.charAt(i++)))<<6|(s=E.indexOf(y.charAt(i++))),f+=o===64?String.fromCharCode(C>>16&255):s===64?String.fromCharCode(C>>16&255,C>>8&255):String.fromCharCode(C>>16&255,C>>8&255,255&C);return f}(a=String(a));var m=n.length;let u=new Uint8Array(new ArrayBuffer(m));for(let y=0;y<m;y++)u[y]=n.charCodeAt(y);return r.Uint8(u)},Uint8:function(u){let n={data:null,pointer:0,movePointer:function(o){return this.pointer+=o,this.pointer},readInt:function(o){if((o=Math.min(o,this.data.byteLength-this.pointer))<1)return-1;let s=0;if(1<o)for(let i=1;i<=o-1;i++)s+=this.data.getUint8(this.pointer)*Math.pow(256,o-i),this.pointer++;return s+=this.data.getUint8(this.pointer),this.pointer++,s},readStr:function(o){let s=new Uint8Array(o),i=!1,l;s.forEach((h,c)=>{s[c]=this.readInt(1)});for(let h=0;h<t.length;h++)if(!i)try{if(l=t[h].decode(s),h===0)for(let c=0;c<l.length;c++){let p=l.charCodeAt(c);if(p>191||p>127&&p<160)throw new RangeError(`Invalid code point: ${p}`)}i=!0,console.debug(`String byte sequence in ${t[h].encoding}`)}catch(c){console.debug(`SMF string ${c}`)}return l||"String byte sequence read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let o=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)o=this.readInt(1);else{let i=[];for(;128<=this.data.getUint8(this.pointer);)i.push(this.readInt(1)-128);var s=this.readInt(1);for(let l=1;l<=i.length;l++)o+=i[i.length-l]*Math.pow(128,l);o+=s}return o}};if(n.data=new DataView(u.buffer,u.byteOffset,u.byteLength),n.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;n.readInt(4);let m={};m.formatType=n.readInt(2),m.tracks=n.readInt(2),m.track=[];var u=n.readInt(1),y=n.readInt(1);128<=u?(m.timeDivision=[],m.timeDivision[0]=u-128,m.timeDivision[1]=y):m.timeDivision=256*u+y;for(let o=1;o<=m.tracks;o++){m.track[o-1]={event:[]};var E,C=n.readInt(4);if(C===-1)break;if(C!==1297379947)return!1;n.readInt(4);let s=0,i=!1,l,h;for(;!i&&(s++,m.track[o-1].event[s-1]={},m.track[o-1].event[s-1].deltaTime=n.readIntVLV(),(l=n.readInt(1))!==-1);)if(128<=l?h=l:(l=h,n.movePointer(-1)),l===255){m.track[o-1].event[s-1].type=255,m.track[o-1].event[s-1].metaType=n.readInt(1);var f=n.readIntVLV();switch(m.track[o-1].event[s-1].metaType){case 47:case-1:i=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:m.track[o-1].event[s-1].data=n.readStr(f);break;case 33:case 89:case 81:m.track[o-1].event[s-1].data=n.readInt(f);break;case 84:m.track[o-1].event[s-1].data=[],m.track[o-1].event[s-1].data[0]=n.readInt(1),m.track[o-1].event[s-1].data[1]=n.readInt(1),m.track[o-1].event[s-1].data[2]=n.readInt(1),m.track[o-1].event[s-1].data[3]=n.readInt(1),m.track[o-1].event[s-1].data[4]=n.readInt(1);break;case 88:m.track[o-1].event[s-1].data=[],m.track[o-1].event[s-1].data[0]=n.readInt(1),m.track[o-1].event[s-1].data[1]=n.readInt(1),m.track[o-1].event[s-1].data[2]=n.readInt(1),m.track[o-1].event[s-1].data[3]=n.readInt(1);break;default:this.customInterpreter!==null&&(m.track[o-1].event[s-1].data=this.customInterpreter(m.track[o-1].event[s-1].metaType,n,f)),this.customInterpreter!==null&&m.track[o-1].event[s-1].data!==!1||(n.readInt(f),m.track[o-1].event[s-1].data=n.readInt(f),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((l=l.toString(16).split(""))[1]||l.unshift("0"),m.track[o-1].event[s-1].type=parseInt(l[0],16),m.track[o-1].event[s-1].channel=parseInt(l[1],16),m.track[o-1].event[s-1].type){case 15:this.customInterpreter!==null&&(m.track[o-1].event[s-1].data=this.customInterpreter(m.track[o-1].event[s-1].type,n,!1)),this.customInterpreter!==null&&m.track[o-1].event[s-1].data!==!1||(E=n.readIntVLV(),m.track[o-1].event[s-1].data=n.readInt(E),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:m.track[o-1].event[s-1].data=[],m.track[o-1].event[s-1].data[0]=n.readInt(1),m.track[o-1].event[s-1].data[1]=n.readInt(1);break;case 12:case 13:m.track[o-1].event[s-1].data=n.readInt(1);break;case-1:i=!0;break;default:if(this.customInterpreter!==null&&(m.track[o-1].event[s-1].data=this.customInterpreter(m.track[o-1].event[s-1].metaType,n,!1)),this.customInterpreter===null||m.track[o-1].event[s-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return m},customInterpreter:null};if(typeof rt<"u")rt.exports=r;else{let a=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;a.MidiParser=r}})()});var wt=function(e,t){let r=Math.min(e.length,t.length),a=e.slice(0,r),n=t.slice(0,r),m=0,u=0;for(;u<r&&m==0;)m=Math.sign(a[u]-n[u]),u++;return m},ae=function(e=""){this.name=e,this.pool=[],this.point=function(t,r=!1){if(this.pool.length>0){let a=this.pool.length,n=1<<Math.floor(Math.log2(a)),m=n,u=64;for(;n>=1&&u>=0;){if(u<=0)throw new Error("TTL reached.");if(m==a)m-=n;else{let E=wt(t,this.pool[m]);switch(E){case 0:{u=0;break}case 1:{m+n<=a&&(m+=n);break}case-1:{m!=0&&(m-=n);break}default:console.warn(`Unexpected result ${E}.`)}}n=n>>1,u--}let y=!0;if(m>=this.pool.length)y=!1;else{let E=this;this.pool[m].forEach(function(C,f,o){y&&C!=t[f]&&(y=!1)}),!y&&wt(t,this.pool[m])>0&&m++}return y||r?m:-1}else return r?0:-1},this.add=function(t,r){return t.data=r,this.pool.splice(this.point(t,!0),0,t),this},this.default=function(t){console.warn(`No match in "${this.name||"(unknown)"}" for "${t}". Default action not defined.`)},this.get=function(t){let r=this.point(t);if(r>-1)return this.pool[r].data;this.default(t)},this.run=function(t,...r){let a=this.point(t);a>-1?t.subarray?this.pool[a].data(t.subarray(this.pool[a].length),...r):this.pool[a].data(t.slice(this.pool[a].length),...r):this.default(t,...r)}};var Ne=class{#t={};addEventListener(e,t){this.#t[e]||(this.#t[e]=[]),this.#t[e].unshift(t)}removeEventListener(e,t){if(this.#t[e]){let r=this.#t[e].indexOf(t);r>-1&&this.#t[e].splice(r,1),this.#t[e].length<1&&delete this.#t[e]}}dispatchEvent(e,t){let r=new Event(e),a=this;r.data=t,this.#t[e]?.length>0&&this.#t[e].forEach(function(n){try{n?.call(a,r)}catch(m){console.error(m)}}),this[`on${e}`]&&this[`on${e}`](r)}};var da=["MSB","PRG","LSB","NME","ELC","DRM","LVL","VXP"],ua={krs:"KR",s90es:"ES",motif:"ES"},pa={krs:"Kr",s90es:"SE",motif:"ME"},je=function(e){let t=Math.floor(e/10),r=e%10;return`${t.toString(16)}${r}`},Je=class{#t;get bankInfo(){return this.#t}strictMode=!1;get(e=0,t=0,r=0,a,n=0){let m=[e,t,r],u,y=1,E=0,C,f,o,s=Array.from(arguments);switch(a){case"xg":{switch(e){case 0:{r===126?s[2]=125:r===127&&(s[2]=0);break}case 16:{r===126&&(s[2]=0);break}case 32:{r>125&&(s[2]=0),s[2]+=4;break}case 33:{(r>125||r===3)&&(s[2]=0),s[2]+=5;break}case 34:case 35:case 36:{r>125&&(s[2]=0),s[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:s[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{r===126&&(s[2]=0);break}case 48:case 64:case 126:case 127:{r===126&&(e===127&&t===0||(s[2]=0));break}case 121:{switch(r){case 126:{s[2]=0;break}case 16:{s[2]=15;break}default:s[2]=s[2]&15}break}}break}case"gs":case"sc":{e===0&&r<5?s[0]=49:e<128&&e>125&&r<5&&r!==2&&(s[2]=e,s[0]=49);break}case"mt32":{e===0&&(s[0]=49);break}case"sd":{switch(e){case 121:{s[0]=96;break}case 120:{s[0]=104;break}}s[0]>>1===40?s[2]|=16:s[0]>95&&s[0]<100&&(s[2]|=16,t>>4===7&&(s[0]=96));break}case"pa":{switch(e){case 120:{r==64?s[2]=2:s[2]=1;break}case 121:{switch(r){case 127:{s[2]=79;break}default:s[2]=(s[2]&63)+32}break}}break}case"g2":{e>>1===40?s[2]|=16:e>95&&e<100&&(s[2]|=16,t>>4===7&&(s[0]=96));break}case"sg":{e===8&&r===0&&(s[2]=5);break}case"05rw":case"x5d":{e&&e<56&&(s[0]=56);break}case"s90es":case"motif":case"an1x":case"cs1x":case"cs6x":{if(e===0)break;switch(e){case 63:{switch(a){case"s90es":{r<8?s[2]+=17:r<32?s[2]+=13:s[2]=(s[2]>>3)+19;break}case"motif":{r<8?s[2]+=28:r<32?s[2]+=13:s[2]=(s[2]>>3)+19;break}case"cs1x":{switch(r>>1){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:{s[2]+=34;break}case 32:{s[2]=34+((r&1)<<2);break}case 33:{s[2]=47+((r&1)<<2);break}case 61:{s[2]=34+((r&1)<<2);break}case 62:{s[2]=47+((r&1)<<2);break}}break}}break}case 32:{r>125&&(s[2]=0),s[2]+=4;break}case 33:{(r>125||r===3)&&(s[2]=0),s[2]+=5;break}case 34:case 35:case 36:{r>125&&(s[2]=0),s[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:s[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{r===126&&(s[2]=0);break}}break}}let i=" ",l="M",h="",c=0,p=0;switch(s[0]){case 0:{switch(s[2]){case 127:{l="GM-a";break}case 126:{l="GM-n";break}case 7:{l="GM-k",h="GLX";break}case 5:{l="SG-a",h="000";break}case 4:{a==="gs"||a==="sc"?(l="GM-a",h="000"):(l="SP-l",h="C/M");break}case 3:case 2:case 1:{(a==="gs"||a==="sc")&&(l="GM-a",h="000");break}case 0:{l="GM-a";break}default:l="y",c=3}break}case 8:{a==="sg"?l="GM-s":l="r:";break}case 32:case 33:case 34:case 35:case 36:{a==="xg"&&(l=`${["AP","VL","PF","DX","AN"][e&7]}-${"abcdefgh"[r]}`,c=3);break}case 48:{h=`M${(s[2]>>3).toString().padStart(2,"0")}`,l=`y${h}`,c=1;break}case 49:{s[2]>>1===63?(l=`MT-${"ba"[s[2]&1]}`,h=`C${"-/"[s[2]&1]}M`):(l="GM-a",h="000");break}case 56:{l="GM-b";break}case 57:l=["yDOC","QY10","QY20"][s[2]-112]||"yMxv",h=["DOC","QY1","QY2"][s[2]-112]||"057";case 61:case 128:{l="rDrm";break}case 120:{l="gDrm";break}case 62:{l="kDrm";break}case 63:{if(s[2]<17){let w=s[2];l=w<10?"kP:":"kC:",l+=w%10}else if(s[2]<34)l=["Pre1","Pre2","Pre3","Pre4","Usr1","Usr2","DrmP","DrmU","Plg1","Plg2","Plg3","Pre1","Pre2","Pre3","Pre4","Pre5","Pre6"][s[2]-17];else if(s[2]<55){let w=s[2]-34;switch(w>12&&w--,r>>1){case 32:case 33:{l=`Pr${r-63}U`;break}case 61:case 62:{l=`Pr${r-121}U`;break}default:l=s[2]===46?"PrDr":`Pr${(w>>2)+1}${String.fromCharCode(65+(w&3))}`}}else l="Ds";c=1;break}case 64:{l="ySFX",h="SFX";break}case 67:{l="DX:S";break}case 80:case 81:case 82:case 83:{l=`Prg${"UABC"[s[0]-80]}`;break}case 88:case 89:case 90:case 91:{l=`Cmb${"UABC"[s[0]-88]}`;break}case 95:{l=`${["DR","PC"][s[2]]}-d`;break}case 96:{l=s[2]===106?"AP-a":s[2]>>4===1?"SDg":"PF",s[2]>63?p=63:s[2]>>4===1&&(p=16),c=3;break}case 97:{l=s[2]>>4===1?"SDa":"VL:",c=3,s[2]>>4===1?p=16:p=112;break}case 98:{l=s[2]>>4===1?"SDb":"SG-a",c=3,p=16;break}case 99:{l=s[2]>>4===1?"SDc":"DX",s[2]>63?p=63:s[2]>>4===1&&(p=16),c=3;break}case 100:{l="AN",s[2]>63?p=63:s[2]>>4===1&&(p=16),c=3;break}case 104:case 105:case 106:case 107:{l="SDd",p=104;break}case 121:{l=`GM${s[2]?"":"-a"}`,c=1;break}case 122:{l="lDrm";break}case 126:{l="yDrS";break}case 127:{s[2]===127?l="rDrm":l="yDrm";break}default:s[0]<48?l="r:":l="M"}l.length<4&&(l+=`${[e,r,s[0],s[2]][c]-p}`.padStart(4-l.length,"0")),h.length<3&&(h+=`${[e,r,e,r][c]}`.padStart(3-h.length,"0")),a==="xg"&&(e===0?s[2]<100?l=l.replace("y0","y:"):s[2]===125&&(l="y126"):e===16?(u=`Voice${((s[2]<<7)+s[1]+1).toString().padStart(3,"0")}`,i=" "):e===35&&r>>1===2&&(u=`DXCH_${(((s[2]&1)<<7)+t+1).toString().padStart(3,"0")}`,i=" "));let d=[s[0],s[1],s[2]];for(;!(u?.length>=0);)if(u=this.#t[s[1]||0][(s[0]<<8)+s[2]]?.name,u){let w=this.#t[s[1]||0][(s[0]<<8)+s[2]];y=w?.poly||y,E=w?.type||E,C=w?.drum,f=w?.level,o=w?.voice}else if(this.strictMode)u="",i="?";else if(s[0]===0&&s[1]===0&&s[2]===0)u="Unloaded";else if(this.#t[s[1]||0][s[0]<<8])s[0]===0?(s[2]=0,i="^"):s[2]<1?(s[0]=0,i="*"):(s[2]--,i="^");else if(e===48)s[0]=0,s[2]=0,i="!";else if(e===62)s[1]--,i=" ",s[1]<1&&!u?.length&&(s[0]=0,i="!");else if(e<63)s[0]===0?(s[2]=0,i="^"):s[2]<1?(s[0]=0,i="*"):s[2]--;else if(e===80)u=`PrgU:${t.toString().padStart(3,"0")}`,i="!";else if(e===88)u=`CmbU:${t.toString().padStart(3,"0")}`,i="!";else if(e===121)u=`GM2Vox0${r}`,i="#";else if(e===122)if(s[1]===32?s[1]:s[1]%=7,u=this.#t[s[1]||0][(s[0]<<8)+s[2]]?.name,u){i=" ";let w=this.#t[s[1]||0][(s[0]<<8)+s[2]];y=w?.poly||y,E=w?.type||E,C=w?.drum,f=w?.level}else u="",i="*";else s[1]===0?(u=`${e.toString().padStart(3,"0")} ${t.toString().padStart(3,"0")} ${r.toString().padStart(3,"0")}`,i="!"):s[0]===0?(s[2]=0,i="^"):s[2]>0?s[2]--:s[1]>0?(s[1]=0,i="!"):(s[0]=0,i="?");let b=[s[0],s[1],s[2]];switch(i){case"^":{switch(a){case"gs":case"sc":case"ns5r":{i=" ";break}case"xg":{r===126&&(i=" ");break}}e===127&&(i=" ");break}case"*":break;case"!":break;case"?":break}let g="??";switch(s[0]){case 0:{s[2]===0?g="GM":s[2]===5||s[2]===7?g="KG":s[2]<126&&(g="XG");break}case 32:case 33:case 35:case 36:{s[2]>4?g=["AP","VL","PF","DX","AN"][s[0]-32]:g="GS";break}case 48:{g="MU";break}case 49:{s[2]>>1===63?g="MT":s[2]<5&&(g="GM");break}case 56:{g="AG";break}case 61:case 80:case 83:case 88:case 89:case 91:{g="AI";break}case 62:case 82:case 90:{g="XD";break}case 63:{s[2]<17?g="KR":s[2]<34?g="ES":s[2]<55?g="CS":g="DS";break}case 64:case 126:{g="XG";break}case 67:case 99:{g=s[2]>>4===1?"SD":"DX";break}case 81:{g="RW";break}case 95:{g=["DR","PC"][s[2]];break}case 96:{g=s[2]===106?"AP":s[2]>>4===1?"SD":"PF";break}case 97:{g=s[2]>>4===1?"SD":"VL";break}case 98:{g=s[2]>>4===1?"SD":"SG";break}case 100:{g="AN";break}case 104:case 105:case 106:case 107:{g="SD";break}case 120:{g=t===0?"GM":["G2","PA","PA"][s[2]]??"G2";break}case 128:{g=t===0?"GM":"GS";break}case 121:{g=s[2]?["G2","XG","PA","PA","PA"][s[2]>>4]:"GM";break}case 122:{g="KG";break}case 127:{g=s[2]===127?"MT":t===0?"GM":"XG";break}default:s[0]<48&&(s[0]===16&&a==="xg"?g="XG":g="GS")}if(i!==" ")switch(a){case"krs":case"s90es":case"motif":{u="",g=ua[a],i="?";break}case"g2":{u="GM2 Ext?",i="?";break}case"pa":{i==="^"&&(u="Unknown",i="?");break}default:self.debugMode&&(u="",i="?")}return{name:u||`${pa[a]||a.toUpperCase()}${je(e||0)}${je(t||0)}${je(r||0)}`,poly:y,type:E,drum:C,level:f,voice:o,iid:d,eid:b,sid:m,ending:i,sect:l,bank:h,standard:g,mode:a}}async load(e,t,r="(internal)",a){let n=this,m=[],u=0,y=0,E=0;e.split(`
`).forEach(function(C,f){let o=C.split("	"),s=[];if(f===0){if(o.forEach(function(i,l){m[da.indexOf(i)]=l}),m.length<4){console.debug("Debugger launched.");debugger}}else{let i=0,l=0,h=0,c,p=1,d=0,b,g,w;o.forEach(function(x,R){switch(R){case m[0]:{i=parseInt(x);break}case m[1]:{l=parseInt(x);break}case m[2]:{h=parseInt(x);break}case m[3]:{c=x;break}case m[4]:{x=parseInt(x),x<16?p=x+1:(d=(x&15)+1,p=d);break}case m[5]:{g=x;break}case m[6]:{typeof x=="string"&&(b=parseInt(x));break}case m[7]:{w=x;break}}}),n.#t[l]=n.#t[l]||[];let v=n.#t[l],$={msb:i,prg:l,lsb:h,name:c,poly:p,type:d,drum:g,level:b,voice:w,priority:a},S=!1;a<v[i<<8|h]?.priority&&(S=!0,E++),(!v[i<<8|h]||S||t)&&(v[i<<8|h]=$,u++),y++}}),t||console.debug(`Map: From "${r}", ${y} total, ${u} loaded (${u-E} + ${E}).`)}clearRange(e){let t=e.prg!==void 0?e.prg.constructor===Array?e.prg:[e.prg,e.prg]:[0,127],r=e.msb!==void 0?e.msb.constructor===Array?e.msb:[e.msb,e.msb]:[0,127],a=e.lsb!==void 0?e.lsb.constructor===Array?e.lsb:[e.lsb,e.lsb]:[0,127];for(let n=r[0];n<=r[1];n++){let m=n<<8;for(let u=a[0];u<=a[1];u++){let y=m+u;for(let E=t[0];E<=t[1];E++)delete this.#t[E][y]}}}init(){this.#t=[];for(let e=0;e<128;e++)this.#t.push([""])}async loadFiles(...e){this.init();let t=this;e.forEach(async function(r,a){try{t.load(await(await fetch(`./data/bank/${r}.tsv`)).text(),!1,r,a)}catch{console.error(`Failed loading "${r}.tsv".`)}})}constructor(...e){this.loadFiles(...e)}};var Ct=class{#t={};context;set(e,t){this.#t[e]=t}has(e){return!!this.#t[e]}async read(e,t){if(!this.has(e))throw new Error(`No decoder registered for "${e}"`);return await this.#t[e].call(this.context||this,t)}};var ga=function(e,t){let r=!0;return t.forEach((a,n)=>{r=r&&e[n]===a}),r},Me=function(e){let t=0;return e.forEach(r=>{t*=256,t+=r}),t},he=new TextDecoder,Te=new Ct;Te.set("s7e",async function(e){let t=new Uint8Array(await e.slice(0,65536).arrayBuffer()),r="MSB	LSB	PRG	NME",a=[0,0,0,0],n=32,m=0,u=0,y=!0,E=[],C=0;for(;y;){let f=t.subarray(m);([()=>{he.decode(f.subarray(0,4))==="YSFC"?(m+=80,u=1):m++},()=>{if(ga(f.subarray(0,4),a))E.forEach((o,s,i)=>{let l=Me(t.subarray(o.start+4,o.start+8));o.length=l}),u=2;else{let o=he.decode(f.subarray(0,4)),s=Me(f.subarray(4,8));E.push({type:o,start:s}),m+=8}},()=>{let o=E[C],s=t.subarray(o.start,o.start+o.length),i=32;switch(o.type){case"ENVC":{let l=n;for(;l<s.length;){let h=s.subarray(l,l+i),c=he.decode(h.subarray(0,10)).trimEnd();c.slice(0,5)==="Init "&&(c=""),c&&(r+=`
063	${(h[17]+13).toString().padStart(3,"0")}	${h[19].toString().padStart(3,"0")}	${c}`),l+=i}break}case"EDVC":{let l=n;for(;l<s.length;){let h=s.subarray(l,l+i),c=he.decode(h.subarray(0,10)).trimEnd();c.slice(0,5)==="Init "&&(c=""),c&&(r+=`
063	024	${h[19].toString().padStart(3,"0")}	${c}`),l+=i}break}case"EPVC":{let l=32,h=n;for(;h<s.length;){let c=s.subarray(h,h+l),p=he.decode(c.subarray(0,10)).trimEnd();p==="----------"&&(p=""),p&&(r+=`
063	${(c[17]+1).toString().padStart(3,"0")}	${c[19].toString().padStart(3,"0")}	${p}`),h+=l}break}}C++,C>=E.length&&(u=3,y=!1)}][u]||(()=>{y=!1}))()}return r});Te.set("pcg",async function(e){let t=new Uint8Array(await e.arrayBuffer()),r="MSB	LSB	PRG	NME",a=100,n=0,m=0,u=!0,y=[],E=0;for(;u;){let C=t.subarray(a);([()=>{u=he.decode(C.subarray(0,4))==="INI2",m=C[15],a+=16,n=1},()=>{let f=he.decode(C.subarray(0,4)),o=C[5],s=C[7],i=C[11],l=Me(C.subarray(12,16)),h=Me(C.subarray(16,20)),c=Me(C.subarray(36,40)),p=he.decode(C.subarray(44,44+i));y.push({type:f,tipMsb:o,tipLsb:s,nameLen:i,length:l,start:h,entryLen:c,name:p}),a+=64,m--,m<1&&(n=2)},()=>{let f=y[E],o=t.subarray(f.start,f.start+f.length);switch(f.type){case"PRG1":break;case"PBK1":{let s=63,i=(f.tipMsb?6:0)+f.tipLsb;for(let l=0;l<128;l++){let h=l*f.entryLen,c=o.subarray(h,h+f.entryLen),p=he.decode(c.subarray(0,24)).trimEnd().replace("InitProg","");p.length&&i>5&&(r+=`
${s.toString().padStart(3,"0")}	${i.toString().padStart(3,"0")}	${l.toString().padStart(3,"0")}	${p}`)}break}case"CBK1":{let s=63,i=(f.tipMsb?3:0)+f.tipLsb+10;for(let l=0;l<128;l++){let h=l*f.entryLen,c=o.subarray(h,h+f.entryLen),p=he.decode(c.subarray(0,24)).trimEnd().replace("InitCombi","");p.length&&i>12&&(r+=`
${s.toString().padStart(3,"0")}	${i.toString().padStart(3,"0")}	${l.toString().padStart(3,"0")}	${p}`)}break}}E++,E>=y.length&&(n=3,u=!1)}][n]||(()=>{u=!1}))()}return r});var xe=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]),Pe=["melodic","drums","drum set 1","drum set 2","drum set 3","drum set 4","drum set 5","drum set 6","drum set 7","drum set 8"],ma=[17.1,18.6,20.2,21.8,23.3,24.9,26.5,28,29.6,31.2,32.8,34.3,35.9,37.5,39,40.6,42.2,43.7,45.3,46.9,48.4,50],Ce=[20,22,25,28,32,36,40,45,50,56,63,70,80,90,100,110,125,140,160,180,200,225,250,280,315,355,400,450,500,560,630,700,800,900,1e3,1100,1200,1400,1600,1800,2e3,2200,2500,2800,3200,3600,4e3,4500,5e3,5600,6300,7e3,8e3,9e3,1e4,11e3,12e3,14e3,16e3,18e3,2e4],kt=[0,.04,.08,.13,.17,.21,.25,.29,.34,.38,.42,.46,.51,.55,.59,.63,.67,.72,.76,.8,.84,.88,.93,.97,1.01,1.05,1.09,1.14,1.18,1.22,1.26,1.3,1.35,1.39,1.43,1.47,1.51,1.56,1.6,1.64,1.68,1.72,1.77,1.81,1.85,1.89,1.94,1.98,2.02,2.06,2.1,2.15,2.19,2.23,2.27,2.31,2.36,2.4,2.44,2.48,2.52,2.57,2.61,2.65,2.69,2.78,2.86,2.94,3.03,3.11,3.2,3.28,3.37,3.45,3.53,3.62,3.7,3.87,4.04,4.21,4,37,4.54,4.71,4.88,5.05,5.22,5.38,5.55,5.72,6.06,6.39,6.73,7.07,7.4,7.74,8.08,8.41,8.75,9.08,9.42,9.76,10.1,10.8,11.4,12.1,12.8,13.5,14.1,14.8,15.5,16.2,16.8,17.5,18.2,19.5,20.9,22.2,23.6,24.9,26.2,27.6,28.9,30.3,31.6,33,34.3,37,39.7],vt=function(e){let t=.1,r=-.3;return e>66?(t=5,r=315):e>56?(t=1,r=47):e>46&&(t=.5,r=18.5),t*e-r},St=function(e){return e>105?ma[e-106]:e>100?e*1.1-100:e/10},$t=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),et={};`hi*,
ka,か
ki,き
ku,く
ke,け
ko,こ
ky,き!
kw,くl
tsu,つ
ts,つl
sa,さ
si,すぃ
su,す
se,せ
so,そ
shi,し
sh,し!
ta,た
ti,てぃ
tu,とぅ
te,て
to,と
tchy,ち!
tchi,ち
na,な
ni,に
nu,ぬ
ne,ね
no,の
ny,に!
nn,ん
ha,は
hi,ひ
hu,ほぅ
he,へ
ho,ほ
hy,ひ!
fa,ふぁ
fi,ふぃ
fu,ふ
fe,ふぇ
fo,ふぉ
ma,ま
mi,み
mu,む
me,め
mo,も
my,み!
mm,ㇺ
ra,ら
ri,り
ru,る
re,れ
ro,ろ
ry,り!
wa,わ
wi,ゐ
we,ゑ
wo,を
nga,か゚
ngi,き゚
ngu,く゚
nge,け゚
ngo,こ゚
ngy,き゚!
ng,ン
ga,が
gi,ぎ
gu,ぐ
ge,げ
go,ご
gy,ぎ!
gw,ぐl
za,ざ
zi,ずぃ
zu,ず
ze,ぜ
zo,ぞ
ja,じゃ
ji,じ
ju,じゅ
je,じぇ
jo,じょ
jy,じ!
da,だ
di,でぃ
du,どぅ
de,で
do,ど
dy,で!
ba,ば
bi,び
bu,ぶ
be,べ
bo,ぼ
by,び!
va,ゔぁ
vi,ゔぃ
vu,ゔ
ve,ゔぇ
vo,ゔぉ
pa,ぱ
pi,ぴ
pu,ぷ
pe,ペ
po,ぽ
py,ぴ!
!ya,ゃ
!yu,ゅ
!ye,ぇ
!yo,ょ
ya,や
yu,ゆ
ye,𛀁
yo,よ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
la,ぁ
li,ぃ
lu,ぅ
le,ぇ
lo,ぉ
a,あ
i,い
u,う
e,え
o,お
*,っ
~,
^,
_,`.split(`
`).forEach(e=>{let t=e.split(",");et[t[0]]=t[1]});var Mt=function(e){let t=e;e[0]=="*"&&(t=t.slice(1)),["aa","ii","uu","ee","oo"].forEach(a=>{for(;t.indexOf(a)>-1;)t=t.replace(a,a[0])});for(let a in et)t=t.replaceAll(a,et[a]);t.indexOf("ん")==0&&t.length>1&&(t=t.slice(1));let r=t.indexOf("!");return r>-1&&t.length>1&&(t=t.slice(r+1)),t},Tt=function(e){return e?e<96?`cc${e}`:["aftertouch","velocity","pitch bend"][e-96]:"off"},xt={u8:["utf-8","Unicode"],l1:["l9","Pan-Latin"],jp:["sjis","Japanese"],kr:["iso-2022-kr","Korean"],hz:["gb18030","Simplified Chinese"],b5:["big5","Traditional Chinese"],cy:["koi8-ru","Cyrillic"],vn:["tcvn-5773-1993","Vietnamese"]},Pt={m:"Male",f:"Female",c:"Chorus",s:"Solo",p:"Plural",w:"Words",x:"Non-vocal"};var tt=["room 1","room 2","room 3","hall 1","hall 2","plate","delay","panning delay"],At=["chorus 1","chorus 2","chorus 3","chorus 4","feedback","flanger","short delay","short delay feedback"],Lt=["delay 1","delay 2","delay 3","delay 4","pan delay 1","pan delay 2","pan delay 3","pan delay 4","delay to reverb","pan repeat"];var ba={0:"thru",256:"stereo EQ",257:"spectrum",258:"enhancer",259:"humanizer",272:"overdrive",273:"distortion",288:"phaser",289:"auto wah",290:"rotary",291:"stereo flanger",292:"step flanger",293:"tremelo",294:"auto pan",304:"compressor",305:"limiter",320:"hexa chorus",321:"tremelo chorus",322:"stereo chorus",323:"space D",324:"3D chorus",336:"stereo delay",337:"modulated delay",338:"3-tap delay",339:"4-tap delay",340:"tremelo control delay",341:"reverb",342:"gate reverb",343:"3D delay",352:"2-pitch shifter",353:"feedback pitch shifter",368:"3D auto",369:"3D manual",370:"Lo-Fi 1",371:"Lo-Fi 2",512:"overdrive - chorus",513:"overdrive - flanger",514:"overdrive - delay",515:"distortion - chorus",516:"distortion - flanger",517:"distortion - delay",518:"enhancer - chorus",519:"enhancer - flanger",520:"enhancer - delay",521:"chorus - delay",522:"flanger - delay",523:"chorus - flanger",524:"rotary multi",1024:"guitar multi 1",1025:"guitar multi 2",1026:"guitar multi 3",1027:"clean guitar multi 1",1028:"clean guitar multi 2",1029:"bass multi",1030:"rhodes multi",1280:"keyboard multi",4352:"chorus / delay",4353:"flanger / delay",4354:"chorus / flanger",4355:"overdrive / distortion",4356:"overdrive / rotary",4357:"overdrive / phaser",4358:"overdrive / auto wah",4359:"phaser / rotary",4360:"phaser / auto wah"},ya={66307:["drive"],66309:["vowel",e=>"aiueo"[e]],94723:["pre-filter"],94724:["Lo-Fi type"],94725:["post-filter"],94979:["Lo-Fi type"],94980:["fill type",e=>["off","LPF","HPF"][e]],94984:["noise type",e=>["white","pink"][e]],94987:["disc type",e=>["LP","SP","EP","RND"]],94990:["hum type",e=>`${e+5}0Hz`],94993:["M/S",e=>["mono","stereo"][e]]},at=function(e){return ba[(e[0]-32<<8)+e[1]]||`0x${e[0].toString(16).padStart(2,"0")}${e[1].toString(16).padStart(2,"0")}`},Rt=function(e,t,r){let a=(e[0]-32<<16)+(e[1]<<8)+t,n=ya[a]||{},m=n[0];if(m?.length)return m+=`: ${(n[1]||function(){})(r)||r}`,m},ft=[68,48,95,78,41,3,110,122,0];var Bt=(e,t)=>{let r=Math.min(e.length,t.length),a=0;for(let n=0;n<r;n++)if(a=e[n]-t[n],a!==0)return[n,a];return e.length!==t.length?[r,e.length-t.length]:[0,0]},Z=function(e=64){return Math.round(2e3*Math.log10(e/64))/100},Dt=function(e,t,r){let a=[],n=r==!1?t.readIntVLV():r;e==0||e==127;for(let m=0;m<n;m++){let u=t.readInt(1);if(a.push(u),u!=247){if(u!=240){if(u>127)return console.debug(`Early termination: ${a}`),a.pop(),t.backOne(),t.backOne(),new Uint8Array(a)}}}return new Uint8Array(a)},Ee=function(e){let t=0;return e.forEach(r=>{t+=r,t=t&127}),~t+1&127},fe=function(e,t){let r=0,a=0;for(let n=0;n<e.length;n++){let m=(n&7)-1,u=(a>>m&1)<<7,y=e[n];y+=u,n&7?(t(y,r,e),r++):a=e[n]}};var Ea=function(e,t){let r=0;for(let a=0;a<e.length;a++)if(a&1){r=r<<4|e[a]&15;let n=a>>1;t(r,n,e)}else r=e[a]&15},It=function(e){let t=e.length>>1,r=new Uint8Array(t);return Ea(e,(a,n)=>{r[n]=a}),r},Ae=function(e){let t=Math.floor(e*14.2);return t<128?t:0},D=function(){return self.Bun?!0:self.debugMode??!1},Ut=function(e){let t=(e.length+1)*3>>2,r=new Uint8Array(t),a=e.length+3>>2;for(let n=0;n<a;n++){let m=n<<2,u=n*3,y=0;for(let E=0;E<4;E++)y<<=6,y|=e.charCodeAt(m+E)-32&63;r[u]=y>>16,r[u+1]=y>>8&255,r[u+2]=y&255}return r};var Tf="♭𝄫,𝄫,♭,,♯,𝄪,𝄪♯".split(",");var Vf=Et(it(),1),G=["?","gm","gs","sc","xg","g2","mt32","doc","qy10","qy20","ns5r","x5d","05rw","k11","sg","sd","pa","krs","s90es","motif","cs6x","trin","an1x","cs1x"],wa={gm2:"g2","mt-32":"mt32","c/m":"mt32",ag10:"05rw","ag-10":"05rw","05r/w":"05rw",x5:"05rw",x5dr:"x5d",gmega:"k11","kross 2":"krs","motif es":"motif","s90 es":"s90es",trinity:"trin","tr-rack":"trin"},Ca=["melodic","drum","menu"],Le={"?":[0,0,120,0,0],gm:[0,0,120,0,0],gs:[0,0,128,0,0],sc:[0,0,128,0,0],xg:[0,0,127,0,0],g2:[0,0,120,0,0],mt32:[0,127,127,0,127],doc:[57,112,127,57,112],qy10:[57,113,127,57,113],qy20:[57,114,127,57,114],ns5r:[0,0,61,0,0],x5d:[82,0,62,56,0],"05rw":[81,0,62,56,0],k11:[0,0,122,0,0],sg:[0,0,122,0,0],sd:[97,0,105,0,0],pa:[0,0,120,121,0],krs:[121,0,120,0,0],s90es:[0,0,127,0,0],motif:[0,0,127,0,0],cs6x:[0,0,127,0,0],trin:[0,0,61,0,0],an1x:[36,3,127,0,0],cs1x:[0,0,127,63,0],cs2x:[0,0,127,63,0]},ka=[9,25,41,57,73,89,105,121],va=[0,3,81,84,88],Ot={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},Xe={0:0,1:1,2:3,5:4},_t={0:0,1:1,2:2,5:3},Nt=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],lt=[36,37,48,49,52,53],Fe=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65],Xt={26:127,29:0,30:0,31:0,52:12,53:54},we=[0,1,2,4,5,6,7,8,10,11,12,13,14,15,16,17,18,19,20,21,22,26,28,32,38,40,41,42,43,44,45,46,47,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,80,81,82,83,84,91,92,93,94,95,98,99,100,101,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],Sa=[2,4,12,13,14,15,16,17,18,19,20,21,40,41,42,43,44,45,46,47,80,81,83,136,130,131,132,133,134,135,137,138,139,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],$a=[33,102,99,32,100,8,9,10],Ht=[0,16,25,40,32,64,24,48],Re="reverb,chorus,delay,insert0,insert1,insert2,insert3,insert4".split(","),re=[["VL",32,8,1],["SG",8,1,1],["DX",16,1,16],["AN",16,2,5],["PF",2,1,64],["DR",2,1,32],["PC",2,1,32],["AP",2,1,64]],T={};G.forEach((e,t)=>{T[e]=t});var M=[];we.forEach((e,t)=>{M[e]=t});var j={length:Fe.length};Fe.forEach((e,t)=>{j[e]=t});var Ma={};Ca.forEach((e,t)=>{Ma[e]=t});var Ta=function(e){let t=[],r=0;return e?.forEach(function(a,n){a===247?t.push(e.subarray(r,n)):a===240&&(r=n+1)}),t.length||t.push(e.subarray(0)),D()&&console.debug(t),t};var st=8,k={port:st,ch:st<<4,chShift:Math.ceil(Math.log2(st))+4,cc:we.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,rpnt:4,nrpn:lt.length,ace:8,drm:8,dpn:Fe.length,dnc:128,ext:3,efx:8,cvn:12,redir:32,vxPrim:3,invalidCh:255};k.chcc=k.cc*k.ch;var ie={bank0:255},xa=new TextDecoder("l9"),H=new Uint16Array(k.ch),ke=new Uint16Array(k.ch),Pa=new Uint16Array(k.ch),He=new Uint16Array(k.ch),Aa=new Uint16Array(k.ch),ve=new Uint16Array(k.ch),Ft=new Array(k.drm);for(let e=0;e<k.ch;e++)H[e]=e*k.cc,ke[e]=e*k.rpn,Pa[e]=e*k.nrpn,He[e]=e*k.ace,Aa[e]=e*k.ext,ve[e]=e*k.cvn;for(let e=0;e<k.drm;e++){Ft[e]=new Uint16Array(k.dpn);let t=e*k.dpn*k.dnc;for(let r=0;r<k.dpn;r++)Ft[e][r]=t+r*k.dnc}var J=class extends Ne{NOTE_IDLE=0;NOTE_ATTACK=1;NOTE_DECAY=2;NOTE_SUSTAIN=3;NOTE_HELD=4;NOTE_RELEASE=5;NOTE_SOSTENUTO_ATTACK=8;NOTE_SOSTENUTO_DECAY=9;NOTE_SOSTENUTO_SUSTAIN=10;NOTE_SOSTENUTO_HELD=11;NOTE_MUTED_RECOVERABLE=16;CH_MELODIC=0;CH_DRUMS=1;CH_DRUM1=2;CH_DRUM2=3;CH_DRUM3=4;CH_DRUM4=5;CH_DRUM5=6;CH_DRUM6=7;CH_DRUM7=8;CH_DRUM8=9;DUMP_ALL=0;DUMP_ONCE=1;DUMP_MODE=2;EXT_NONE=0;EXT_VL=1;EXT_DX=3;VLBC_SYSTEM=0;VLBC_BRTHEXPR=1;VLBC_VELOINIT=2;VLBC_VELOALL=3;CH_INACTIVE=0;CH_ACTIVE=1;CH_DISABLED=2;KARAOKE_NONE=0;KARAOKE_TEXT=1;KARAOKE_XF=2;#t=0;#a=0;#l=0;#r=new Array(11);get#g(){return this.#r[this.#a]}set#g(e){this.#r[this.#a]=e}#s=new Uint8Array(k.ch);#i=new Uint8Array(k.ch);#n=new Uint8Array(k.ch);#e=new Uint8Array(k.chcc<<1);#c=new Uint8Array(k.ch*k.ace);#f=new Uint8Array(k.ch*k.vxPrim);#o=new Uint8Array(k.ch*k.nn);#h=new Uint8Array(k.ch);#d=new Uint16Array(k.pl);#u=new Uint8Array(k.pl);#E=new Int16Array(k.ch);#m=new Uint8Array(k.ch);#v=new Uint8Array(k.ch);#C=new Uint8Array(k.ch*k.ext);#p=new Uint8Array(k.ch*k.rpn);#b=new Uint8Array(k.ch*k.rpnt);#L=new Int8Array(k.ch*lt.length);#A=new Uint8Array(k.drm*k.dpn*k.dnc);#U=new Uint8Array(k.drm*2);#R=new Uint8Array(k.efx*3);#q=new Uint8Array(k.ch);#W=new Uint8Array(k.ch*k.redir);#S=new Uint8Array(k.port);#ie=new Uint8Array(k.port);#z=new Uint8Array(k.ch);#D=new Uint8Array(k.ch);#Q=new Uint8Array(k.ch*k.cvn);#se=new Uint8Array(k.ch);#F=new Uint8Array(128);#O=new Uint8Array(k.cmt*8);#le=new Uint8Array(1024);#G=new Uint8Array(k.cmt*64);#M={};modelEx={xg:{varSys:!1,insPart:new Uint8Array(5)},yPlg:[],sc:{showBar:!0,invBar:!1,invDisp:!1,peakHold:1},cs1x:{perfCh:0},kross:{chToggle:!1},sg:{convLastSyll:0,runLineLen:0,maxLineLen:32,splitMask:!1}};#y;get detect(){return structuredClone(this.#y)}#N;#he;#k=100;#Z=0;#ne=500;#be=0;#ye=0;#Ee=32;#we=!1;#V="";#K=0;#de=0;#oe=0;#X=!0;#w=0;#ge=1;#ue;#$=!1;#ce=0;#j=new Array(k.ch);#B=[];#H=new Uint8Array(k.ch);#Y=new Uint8Array(k.tr);baseBank=new Je("gm2","ns5r","xg","gs","sd","gmega","plg-vl","plg-pf","plg-dx","plg-an","plg-dr","plg-sg","kross","s90es","cs2x","pa");userBank=new Je("gm2");initOnReset=!1;aiEfxName="";polyIndexShrink=!0;polyIndexLatest=0;polyIndexLast=0;chRedir(e,t,r){let a=this;if(a.#Y[t])return(a.#Y[t]-1)*16+e;if(a.#t===T.sc||a.#t===T.sd){if(r===1)return e;let n=0,m=!0;for(;m;)a.#H[e+n]===0?(a.#H[e+n]=t,console.debug(`Assign track ${t} to channel ${e+n+1}.`),m=!1):this.#H[e+n]===t?m=!1:(n+=16,n>=128&&(n=0,m=!1));return e+n}else return e}getTrackPort(e){return this.chRedir(0,e,!0)>>4}forceVoiceRefresh(){for(let e=0;e<k.ch;e++)this.#s[e]&&this.dispatchEvent("voice",{part:e})}#P=[];#J;#T={nOff:(e,t)=>{let r=e*128+t,a=this.#d.lastIndexOf(r);if(a>-1)if(this.getChCc(e,64)>>6)this.#u[a]=this.NOTE_HELD,this.dispatchEvent("note",{part:e,note:t,velo:this.#o[r],state:this.NOTE_HELD});else if(this.getChCc(e,66)>>6&&this.#u[a]===this.NOTE_SOSTENUTO_SUSTAIN)this.#u[a]=this.NOTE_SOSTENUTO_HELD,this.dispatchEvent("note",{part:e,note:t,velo:this.#o[r],state:this.NOTE_SOSTENUTO_HELD});else{this.#d[a]=0,this.#o[r]=0,this.#u[a]=this.NOTE_IDLE;let n=this.getExt(e)[1];(n===this.VLBC_VELOINIT||n===this.VLBC_VELOALL)&&this.setChCc(e,129,0),this.dispatchEvent("note",{part:e,note:t,velo:0,state:this.NOTE_IDLE})}if(this.#h[e]){for(let n=this.polyIndexLast;n>=0;n--)if(this.#d[n]>>7===e&&this.#u[n]!==0){this.#u[n]===this.NOTE_MUTED_RECOVERABLE&&(this.#u[n]=this.NOTE_SUSTAIN);break}}if(this.polyIndexShrink&&this.polyIndexLast>0){let m=!1,u=this.polyIndexLast-8,y=this.polyIndexLast;for(;y>u&&this.#u[y]===0;y--)m=!0;m&&(this.polyIndexLast=y,this.#u[y+1]!==0&&console.error("Polyphonic slot shrinking edge case."))}},nOn:(e,t,r)=>{let a=e*128+t,n=0;if(this.#h[e])for(let m=0;m<=this.polyIndexLast;m++)this.#d[m]>>7===e&&this.#u[m]!==0&&(this.#u[m]=this.NOTE_MUTED_RECOVERABLE);for(;this.#u[n]>0&&this.#d[n]!==a;)n++;if(n<k.pl){this.#d[n]=a,this.#o[a]=r,this.#u[n]=this.NOTE_SUSTAIN,this.#m[e]<r&&(this.#m[e]=r);let m=this.getExt(e)[1];(m===this.VLBC_VELOINIT||m===this.VLBC_VELOALL)&&this.setChCc(e,129,r),this.dispatchEvent("note",{part:e,note:t,velo:r,state:this.NOTE_SUSTAIN}),this.polyIndexLatest=n+1,n>this.polyIndexLast&&(this.polyIndexLast=n)}else console.error("Polyphony exceeded.")},nAt:(e,t,r)=>{},cAt:(e,t)=>{},hoOf:e=>{this.#u.forEach((t,r)=>{if(t===this.NOTE_HELD){let a=this.#d[r],n=a>>7;e===n&&(this.#u[r]=this.NOTE_IDLE,this.#d[r]=0,this.#o[a]=0,this.dispatchEvent("note",{part:e,note:a&127,velo:0,state:this.NOTE_IDLE}))}})},soOn:e=>{this.#u.forEach((t,r)=>{let a;switch(t){case this.NOTE_ATTACK:{a=this.NOTE_SOSTENUTO_ATTACK;break}case this.NOTE_DECAY:{a=this.NOTE_SOSTENUTO_DECAY;break}case this.NOTE_SUSTAIN:{a=this.NOTE_SOSTENUTO_SUSTAIN;break}}if(a){this.#u[r]=a;let n=this.#d[r];this.dispatchEvent("note",{part:e,note:n&127,velo:this.#o[n],state:a})}})},soOf:e=>{this.#u.forEach((t,r)=>{if(t===this.NOTE_SOSTENUTO_HELD){let a=this.#d[r],n=a>>7;e===n&&(this.#u[r]=this.NOTE_IDLE,this.#d[r]=0,this.#o[a]=0,this.dispatchEvent("note",{part:e,note:a&127,velo:0,state:this.NOTE_IDLE}))}})},ano:e=>{this.#d.forEach(t=>{let r=t>>7,a=t&127;t===0&&this.#o[0]===0||r===e&&this.#T.nOff(r,a)})}};#pe={8:function(e){let t=e.channel,r=e.data[0];this.#T.nOff(t,r)},9:function(e){let t=e.channel,r=this;if(r.getChModeId(t)===T.xg&&r.#n[t]>1){let m=r.getChDrumFirstWrite(t);m[0]&&m[1]!==k.invalidCh&&!r.#s[t]&&(r.copyChSetup(m[1],t),r.pushChPrimitives(t),console.debug(`Part CH${t+1} copied from CH${m[1]+1}.`))}r.setChActive(t,1);let a=e.data[0],n=e.data[1];n>0?r.#T.nOn(t,a,n):r.#T.nOff(t,a)},10:function(e){let t=e.channel,r=t*128+e.data[0];this.#d.indexOf(r)>-1&&(this.#o[r]=data[1],this.getExt(t)[1]===this.VLBC_VELOALL&&this.setChCc(t,129,data[1]),this.dispatchEvent("note",{part:t,note:e.data[0],velo:e.data[1],state:this.NOTE_SUSTAIN}))},11:function(e){let t=e.channel,r=this,a=r.#j[t],n=a[e.data[0]];n&&(e.data[0]=n),[0,32].indexOf(e.data[0])>-1&&(()=>{switch(this.#t){case T.s90es:case T.motif:{if(e.data[0]===0){[0,63].indexOf(e.data[1])>-1&&r.setChActive(t,1);break}e.data[1]&&r.setChActive(t,1);break}default:break}})();let m=t*k.ext,u=r.getChModeId(t);switch(e.data[0]){case 96:return;case 97:return;case 120:return;case 121:{this.#T.ano(t),this.#E[t]=0,r.resetChCc(t,1,0),r.resetChCc(t,5,0),r.resetChCc(t,64,0),r.resetChCc(t,65,0),r.resetChCc(t,66,0),r.resetChCc(t,67,0),r.resetChCc(t,11,127),r.resetChCc(t,101,127),r.resetChCc(t,100,127),r.resetChCc(t,99,127),r.resetChCc(t,98,127);return}case 123:{this.#T.ano(t);return}case 124:{this.#T.ano(t);return}case 125:{this.#T.ano(t);return}case 126:{this.#h[t]=1,this.#T.ano(t);return}case 127:{this.#h[t]=0,this.#T.ano(t);return}}if(M[e.data[0]]===void 0)console.warn(`cc${e.data[0]} is not accepted.`);else{switch(Sa.indexOf(e.data[0])>-1&&this.allocateAce(t,e.data[0]),e.data[0]){case 0:{switch(D()&&console.debug(`${G[this.#t]}, CH${t+1}: ${e.data[1]}`),this.#t===0?e.data[1]<48?(this.#n[t]>0&&(e.data[1]=this.getChPrimitive(t,1,!1),e.data[1]=Le.gs[2],console.debug(`Forced channel ${t+1} to stay drums.`)),e.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${e.data[1]}`),this.switchMode("gs"))):e.data[1]===56?this.switchMode(this.#y.x5===82?"x5d":"05rw"):e.data[1]===62?this.switchMode(this.#y.x5===82?"x5d":"05rw"):e.data[1]===63?this.switchMode(G[this.#y.ds]):e.data[1]===64||e.data[1]===127?this.switchMode("xg"):(e.data[1]===120||e.data[1]===121)&&this.switchMode("g2"):this.#t===T.gs||this.#t===T.sc?e.data[1]<56&&this.#n[t]>0&&(e.data[1]=this.getChPrimitive(t,1,!1),e.data[1]=Le.gs[2],console.debug(`Forced channel ${t+1} to stay drums.`)):this.#t===T.gm&&(e.data[1]<48?this.#n[t]>0&&(e.data[1]=Le.gs[2],this.switchMode("gs",!0),console.debug(`Forced channel ${t+1} to stay drums.`)):(e.data[1]===64||e.data[1]===127)&&this.switchMode("xg",!0)),this.#t){case T.xg:{[79,95,126,127].indexOf(e.data[1])>-1?this.#n[t]===0&&(this.setChType(t,this.CH_DRUM2),console.debug(`CH${t+1} set to drums by MSB.`)):this.#n[t]>0&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`)),[33,81,97].indexOf(e.data[1])>-1?this.#C[m]=this.EXT_VL:[35,67,83,99].indexOf(e.data[1])>-1?this.#C[m]=this.EXT_DX:this.#C[m]=this.EXT_NONE;break}case T["05rw"]:case T.x5d:case T.ns5r:{[61,62,126,127].indexOf(e.data[1])>-1?this.#n[t]===this.CH_MELODIC&&(this.setChType(t,this.CH_DRUM2),console.debug(`CH${t+1} set to drums by MSB.`)):[80,81,82,83].indexOf(e.data[1])>-1||this.#n[t]!==this.CH_MELODIC&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`));break}case T.sd:{[104,105,106,107,120].indexOf(e.data[1])>-1?this.#n[t]===0&&(this.setChType(t,this.CH_DRUM2),console.debug(`CH${t+1} set to drums by MSB.`)):this.#n[t]>0&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`));break}case T.g2:{e.data[1]===120?this.#n[t]===0&&(this.setChType(t,this.CH_DRUMS),console.debug(`CH${t+1} set to drums by MSB.`)):this.#n[t]>0&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`));break}}break}case 2:{this.getExt(t)[1]===this.VLBC_BRTHEXPR&&this.setChCc(t,129,e.data[1]);break}case 6:{if(this.#v[t]){[T.xg,T.gs,T.sc,T.ns5r].indexOf(this.#t)<0&&console.warn(`NRPN commits are not available under "${G[this.#t]}" mode, even when they are supported in Octavia.`);let y=this.getChCc(t,99),E=this.getChCc(t,98);if(y===1){let C=$a.indexOf(E);if(C>-1)this.setChCc(t,71+C,e.data[1]),D()&&console.debug(`Redirected NRPN 1 ${E} to cc${71+C}.`),this.dispatchEvent("cc",{part:t,cc:71+C,data:e.data[1]});else{let f=lt.indexOf(E);f>-1?this.#L[t*10+f]=e.data[1]-64:console.warn(`NRPN 0x01${E.toString(16).padStart(2,"0")} is not supported.`),D()&&console.debug(`CH${t+1} voice NRPN ${E} commit`)}}else{if(Fe.indexOf(y)<0){let f=`NRPN 0x${y.toString(16).padStart(2,"0")}${E.toString(16).padStart(2,"0")} `;console.warn(y===127?`${f}is not necessary. Consider removing it.`:`${f}is not supported.`)}else{let f=this.#n[t]-2;f<0?console.warn(`CH${t+1} cannot accept drum NRPN as type ${Pe[this.#n[t]]}.`):this.#A[(f*k.dpn+j[y])*k.dnc+E]=e.data[1]}D()&&console.debug(`CH${t+1} (${Pe[this.#n[t]]}) drum NRPN ${y} commit`)}}else{let y=Xe[this.getChCc(t,100)],E=_t[this.getChCc(t,100)];if(this.getChCc(t,101)===0&&y!==void 0)switch(D()&&console.debug(`CH${t+1} RPN 0 ${this.getChCc(t,100)} commit: ${e.data[1]}`),e.data[1]=Math.min(Math.max(e.data[1],Nt[y][0]),Nt[y][1]),this.#p[t*k.rpn+y]=e.data[1],this.#b[t*k.rpnt+E]=1,u){case T.xg:case T.gs:case T.sc:case T.mt32:case T.s90es:case T.motif:case T.cs1x:case T.cs6x:{switch(this.getChCc(t,100)){case 1:case 2:{this.dispatchEvent("pitch",{part:t,pitch:this.getPitchShift(t)});break}}break}default:this.dispatchEvent("pitch",{part:t,pitch:this.getPitchShift(t)})}}break}case 32:{switch(D()&&console.debug(`${G[this.#t]}, CH${t+1} LSB: ${e.data[1]}`),this.#t){case T.s90es:case T.motif:{this.setChType(t,[32,40].indexOf(e.data[1])>-1?this.CH_DRUMS:this.CH_MELODIC,this.#t,!0);break}}this.getExt(t)[0],this.EXT_DX;break}case 38:{if(!this.#v[t]){let y=Xe[this.getChCc(t,100)],E=_t[this.getChCc(t,100)];this.getChCc(t,101)===0&&y!==void 0&&(this.#p[t*k.rpn+y+1]=e.data[1],this.#b[t*k.rpnt+E]=1)}break}case 64:{e.data[1]<64&&this.#T.hoOf(t);break}case 66:{e.data[1]>>6?this.#T.soOn(t):this.#T.soOf(t);break}case 98:case 99:{this.#v[t]=1;break}case 100:case 101:{this.#v[t]=0;break}}this.setChCc(t,e.data[0],e.data[1]),this.dispatchEvent("cc",{part:t,cc:e.data[0],data:e.data[1]})}r.getChModeId(t)===T.xg&&r.#n[t]&&r.setDrumFirstWrite(t)},12:function(e){let t=e.channel,r=this;switch(r.#t){case T.s90es:case T.motif:{e.data&&r.setChActive(t,1);break}default:r.setChActive(t,1)}let a=H[t];switch(r.getExt(t)[0]){case r.EXT_VL:break}r.#f[t]=e.data,r.#D[t]=0,r.pushChPrimitives(t),D()&&console.debug(`T:${e.track} C:${t} P:${e.data}`),r.getChModeId(t)===T.xg&&r.#n[t]&&r.setDrumFirstWrite(t)},13:function(e){let t=this,r=e.channel;this.#d.forEach(function(a){let n=a>>7;r===n&&(t.#o[a]=e.data,t.dispatchEvent("note",{part:r,note:a&127,velo:e.data,state:t.NOTE_SUSTAIN}))})},14:function(e){let t=e.channel;this.#E[t]=e.data[1]*128+e.data[0]-8192,this.dispatchEvent("pitch",{part:t,pitch:this.getPitchShift(t)})},15:function(e){Ta(e.data).forEach(t=>{let r=t[0],a=t[1];this.#ce=t.length,(this.#me[r]||function(){console.debug(`Unknown manufacturer ${r}.`)})(a,t.subarray(2),e.track)})},248:function(e){},250:function(e){},251:function(e){},252:function(e){},254:function(e){},255:function(e){(this.#P[e.meta]||function(r,a,n){}).call(this,e.data,e.track,e.meta),e.meta!==32&&(this.#Z=0);let t=va.indexOf(e.meta)>-1;if(D()&&console.debug(e),t)return e.reply="meta",e}};#me={64:(e,t,r)=>{this.#ae.run(t,r,e)},65:(e,t,r)=>{if(t[0]<16)if(t[1]===72){let a=t[t.length-1],n=Ee(t.subarray(3,t.length-1));a===n?this.#I.run(t.subarray(0,t.length-1),r,e):console.warn(`Bad SD checksum ${a} - should be ${n}.`)}else this.#I.run(t,r,e);else{let a=t[t.length-1],n=Ee(t.subarray(2,t.length-1));a===n?this.#I.run(t.subarray(0,t.length-1),r,e):console.warn(`Bad GS checksum ${a} - should be ${n}.`)}},66:(e,t,r)=>{this.#_.run(t,r,e)},67:(e,t,r)=>{switch(e>>4){case 0:{let a=0;for(;t[a]===127&&a<4;)a++;let n=t[1+a]<<7|t[2+a];if(n+7+a!==t.length){console.warn(`Yamaha bulk dump length mismatch! Expected ${t.length-7-a}, received ${n}.`),console.debug(t);break}let m=Ee(t.subarray(1+a,t.length-1)),u=t[t.length-1];if(t[t.length-1]>>7)console.warn(`Yamaha bulk dump checksum invalid! Expected ${m}, received ${u}:
`),console.debug(t);else if(m!==u)console.warn(`Yamaha bulk dump checksum mismatch! Expected ${m}, received ${u}:
`),console.debug(t);else{let y=t.slice(2,t.length-1);for(let E=0;E<=a;E++)y[E]=t[E];this.#x.run(y,r,e&15)}break}case 1:{this.#x.run(t,r,e&15);break}case 2:{console.warn("Octavia doesn't yet support Yamaha bulk dump requests.");break}case 3:{console.warn("Octavia doesn't yet support Yamaha parameter requests.");break}case 7:{switch(e&15){case 14:{let a=new Uint8Array(t.length+1);a[0]=126,a.set(t,1),this.#x.run(a,r,0);break}default:console.warn(`Unknown Yamaha special SysEx type: ${e}.`)}break}default:console.warn(`Unknown Yamaha SysEx type: ${e>>4}.`)}},68:(e,t,r)=>{this.#re.run(t,r,e)},71:(e,t,r)=>{this.#fe.run(t,r,e)},126:(e,t,r)=>{this.#ee.run(t,r,e)},127:(e,t,r)=>{this.switchMode("gm"),this.#te.run(t,r,e)}};#ee;#te;#x;#I;#_;#ae;#fe;#re;buildRchTree(){let e=[];this.#i.forEach((t,r)=>{t<k.ch&&(e[t]?.constructor||(e[t]=[]),e[t].push(r))}),this.#ue=e}buildRccMap(){let e=this;for(let t=0;t<k.ch;t++)e.#j[t]={};e.#W.forEach((t,r)=>{t&&(e.#j[Math.floor(r/k.redir)][t]=r%k.redir|128)}),D()&&console.debug(e.#j)}invokeSysExIndicator(){this.dispatchEvent("mupromptex",this.#ce)}getActive(){return this.#s}getChActive(e){return this.#s[e]}getCc(e){if(typeof e!="number"||e<0||e>=k.ch)throw new RangeError(`Invalid part number: CH${e+1}`);let t=this,r=H[e];return t.#e.subarray(r,r+k.cc)}getChCc(e,t){let r=this;if(we.indexOf(t)<0)throw new Error("CC number not accepted");return r.#e[H[e]+M[t]]}getChCcWritten(e,t){let r=this;if(we.indexOf(t)<0)throw new Error("CC number not accepted");return r.#e[k.chcc+H[e]+M[t]]}setChCc(e=0,t,r){let a=this;if(we.indexOf(t)<0)throw new Error("CC number not accepted");if(r?.constructor!==Number)throw new TypeError("Expected numbers for value");let n=r&255,m=H[e]+M[t];a.#e[m]=n,a.#e[m+k.chcc]=1,a.dispatchEvent("cc",{part:e,cc:t,data:n})}getCcAll(){return this.#e.slice()}resetCc(e){let t=this,r=H[e]+k.chcc;t.#e.fill(0,r,r+k.cc)}resetChCc(e,t,r){let a=this;r?.constructor&&a.setChCc(e,t,r),a.#e[H[e]+M[t]+k.chcc]=0}resetCcAll(){this.#e.fill(0,k.chcc,k.chcc<<1)}isChCcWritten(e,t){if(we.indexOf(t)<0)throw new Error("CC number not accepted");return upThis.#e[H[e]+M[t]+k.chcc]}getChSource(){return this.#i}getChType(e=0){return this.#n[e]}getChTypes(){return this.#n}setChType(e,t,r=0,a=!1){t&=15;let n=this;r=r||n.getChModeId(e),n.#n[e]=t,t>0&&!a&&(n.setChCc(e,0,n.#M[r][2]),n.pushChPrimitives(e))}setChActive(e,t=0){this.#s[e]!==t&&this.dispatchEvent("channeltoggle",{part:e,active:t}),this.#s[e]=t}getExt(e){let t=k.ext*e,r=this.#C.subarray(t,t+k.ext),a=new Uint8Array(r.length);return a.set(r),a[1]=a[1]||this.#ge,a}getPitch(){return this.#E}getProgram(){return this.#f}getTexts(){return this.#B.slice()}getVel(e){let t=new Map,r=this;return r.#d.forEach(function(a,n){let m=a>>7,u=a&127;e===m&&r.#o[a]>0&&t.set(u,{v:r.#o[a],s:r.#u[n]})}),t}getBitmap(){return{bitmap:this.#g,expire:this.#l}}getLetter(){return{text:this.#V,set:this.#de,expire:this.#K}}getMode(){return G[this.#t]}getMaster(){return{volume:this.#k}}getRpn(){return this.#p}getNrpn(){return this.#L}getSubDb(){return self?.structuredClone(this.#M)}getDetect(){return self?.structuredClone(this.#y)}getVoice(e,t,r,a="?"){let n=this;T[a]?.constructor||(a="?");let m=T[a],u=e||n.#M[m][0],y=t,E=r||n.#M[m][1];u===ie.bank0&&(u=0),E===ie.bank0&&(E=0),a==="ns5r"&&u>0&&u<56&&(E=3);let C=n.userBank.get(u,y,E,a);if(a==="mt32"&&C.name.indexOf("MT-m:")===0){let f=parseInt(C.name.slice(5)),o=f*k.cmt,s="";n.#G.subarray(o,o+10).forEach(l=>{l>31&&(s+=String.fromCharCode(l))});let i=`MSB	LSB	PRG	NME
49	127	${y}	${s}`;n.userBank.load(i,!0),C.name=s,C.ending=" "}return(C.ending!==" "||!C.name.length)&&(C=n.baseBank.get(u,y,E,a)),C}getChPrimitive(e,t,r){if(t>=k.vxPrim||t?.constructor!==Number)throw new RangeError(`Invalid voice primitive component "${t}"`);if(typeof e!="number"||e<0||e>=k.ch)throw new RangeError(`Invalid part number: CH${e+1}`);let a=this,n=a.#f[t<<k.chShift|e];switch(t){case 1:case 2:{a.getChCcWritten(e,[255,0,32][t])||(n=n||a.#M[a.getChModeId(e)][t+2]),r&&(n=n||a.#M[a.getChModeId(e)][t-1]),n===ie.bank0&&(n=0);break}}return n}getChPrimitives(e,t){let r=this,a=new Uint8Array(3);return a[1]=r.#f[e],a[0]=r.getChPrimitive(e,1,t),a[2]=r.getChPrimitive(e,2,t),a}pushChPrimitives(e){let t=this;t.#f[1<<k.chShift|e]=t.getChCc(e,0),t.#f[2<<k.chShift|e]=t.getChCc(e,32),t.dispatchEvent("voice",{part:e})}getChCvnBuffer(e,t=k.cvn){if(t>k.cvn||t<1)throw new RangeError("Invalid custom voice name buffer length");let r=ve[e];return this.#Q.subarray(r,r+t)}getChCvnRegister(e,t){if(t>=k.cvn||t<0)throw new RangeError("Invalid custom voice name register");return this.#Q[ve[e]+t]}setChCvnRegister(e,t,r=32){if(t>=k.cvn||t<0)throw new RangeError("Invalid custom voice name register");this.#se[e]=1,this.#Q[ve[e]+t]=Math.max(32,r&255)}resetChCvn(e){this.#Q.fill(32,ve[e],ve[e]+k.cvn),this.#se[e]=0}getChCvnString(e,t){let r=xa.decode(this.getChCvnBuffer(e));return t||(r=r.trimEnd()),r}getChCvnIsWritten(e){return this.#se[e]}getChVoice(e){let t=this,r=t.getVoice(...t.getChPrimitives(e),t.getChMode(e));if(t.#D[e]){let a="";switch(t.#t){case T.mt32:{t.#O.subarray(k.cmt*(e-1),k.cmt*(e-1)+10).forEach(n=>{a+=String.fromCharCode(Math.max(n,32))}),a=a.trimEnd();break}default:a=t.getChCvnString(e)}a.length&&(r.ending="~",r.name=a)}return r}getRawPitch(){return this.#E}getPitchShift(e){let t=this,r=e*k.rpn,a=t.#p[r];return t.#b[e*k.rpnt]?a>>7&&(a-=256):t.#t===T.mt32&&(a=12),t.#E[e]/8192*a+(t.#p[r+3]-64)+((t.#p[r+1]<<7)+t.#p[r+2]-8192)/8192}getEffectType(e=0){let t=3*e+1;return this.#R.subarray(t,t+2)}getPolyState(e=0){return this.#u[e]}setEffectTypeRaw(e=0,t,r){let a=3*e;this.#R[a]=1,this.#R[a+1+ +t]=r}setEffectType(e=0,t,r){this.setEffectTypeRaw(e,!1,t),this.setEffectTypeRaw(e,!0,r)}pushEffectType(e=0,t=!1){if(e<0||e>=k.efx)throw new RangeError(`Invalid EFX slot ${e}`);let r=this.getEffectType(e);t||r[0]===0&&r[1]>>4===15&&(t=!0),this.dispatchEvent(`efx${Re[e]}`,{id:r,hidden:t})}getEffectSink(){return this.#q}getChEffectSink(e){return this.#q[e]}setChEffectSink(e,t=0){let r=this;if(t<0||t>=k.efx)throw new RangeError(`Invalid EFX slot ${t}`);if(e<0||e>=k.ch)throw new RangeError(`Invalid CH${e+1}`);this.#q[e]=t,this.dispatchEvent("partefxtoggle",{part:e,active:t})}setXgChEffectSink(e,t=0){let r=this,a=r.modelEx.xg,n=t-2;if(t<0||n>=a.insPart.length)throw new RangeError(`Invalid XG insertion slot ${n}`);let m=a.insPart[n];a.insPart[n]=e,m!==k.invalidCh&&r.setChEffectSink(m,0),e===k.invalidCh?m!==k.invalidCh&&r.setChEffectSink(m,0):r.setChEffectSink(e,t)}setLetterDisplay(e,t,r=0,a=3200){let n=this,m;n.#V=" ".repeat(r),e.forEach(u=>{n.#V+=String.fromCharCode(u>31?u:32),u<32&&(m=m||new Set,m.add(u))}),n.#de=Date.now(),n.#K=Date.now()+a,n.dispatchEvent("letter"),m&&(m=Array.from(m),m.forEach((u,y,E)=>{E[y]=u.toString(16).padStart(2,"0")}),console.warn(`${t}${t?" ":""}invalid code point${m.length>1?"s":""}: 0x${m.join(", 0x")}`))}setDetectionTargets(e="?",t=0){let r=this,a=-1;switch(e.replaceAll(", ",",").split(",").forEach(n=>{n=n.toLowerCase();let m=G.indexOf(wa[n]||n);D()&&console.debug(`Mapped mode "${n}" to ID "${m}".`),m>-1&&(a=m)}),D()&&console.debug(`Set detection target to ID "${a}".`),a>0&&(r.#y.x5=82,r.#y.ds=T.krs,r.#y.gm=T.gm,r.#y.g2=T.g2),a){case T["05rw"]:{r.#y.x5=81;break}case T.s90es:{r.#y.ds=T.s90es,r.#y.smotif=T.s90es;break}case T.motif:{r.#y.ds=T.motif,r.#y.smotif=T.motif;break}case T.sd:{r.#y.g2=T.sd;break}case T.pa:{r.#y.g2=T.pa;break}}}setGsTargets(e=!1,t=4){if(!t)t=e?3:4;else{if(t>4||t<0)throw new Error(`Invalid GS level ${t}`);if(e&&t>>1!==1)throw new Error(`Invalid SC level ${t}`)}let r=this;r.#y[e?"sc":"gs"]=t,r.#M[T[e?"sc":"gs"]][1]=t,r.forceVoiceRefresh()}getConfigs(){return this.#he}setDumpLimit(e){if(e>2||e<0)throw new RangeError("Invalid dump limit.");this.#N.dumpLimit=e}allocateAce(e=0,t){let r=this;if(!t||t<128&&t>95){console.warn(`cc${t} cannot be allocated as an active custom effect.`);return}let a=!0,n=0,m=k.ace*e;for(;a&&n<k.ace;)r.#c[n+m]===t?a=!1:r.#c[n+m]||(a=!1,r.#c[n+m]=t,console.debug(`Allocated cc${t} to ACE slot ${n} in CH${e+1}.`)),n++;n>=k.ace&&console.warn(`ACE slots are full in CH${e+1}.`)}allocateAceAll(e){let t=this;if(!e||e<128&&e>95){console.warn(`cc${e} cannot be allocated as an active custom effect.`);return}for(let r=0;r<k.ch;r++){let a=!0,n=0,m=k.ace*r;for(;a&&n<k.ace;)t.#c[n+m]===e?a=!1:t.#c[n+m]||(a=!1,t.#c[n+m]=e),n++;n>=k.ace&&console.warn(`ACE slots are full in CH${r+1}.`)}}resetAce(){this.#c.fill(0),console.info("All ACE slots have been reset.")}resetChAceAll(e=0){this.#c.subarray(He[e],He[e]+k.ace).fill(0)}resetChAce(e=0,t){let r=!0,a=He[e],n=a+k.ace;for(;r&&a<n;)this.#c[a]===t&&(this.#c[a]=0,r=!1),a++;r&&D()&&console.debug(`No ACE slot was allocated to cc${t} in CH${e+1}.`)}getAce(){return this.#c}getChAce(e=0,t=0){if(t<0||t>=k.ace)throw new RangeError("No such ACE slot");let r=this.#c[k.ace*e+t];if(r){if(we.indexOf(r)>=0)return this.getChCc(e,r);throw new Error(`Invalid ACE source in CH${e+1}: ${r}`)}else return 0}initDrums(){let e=this;e.#A.fill(64);for(let t=0;t<k.drm;t++){let r=t*k.dpn;for(let a in Xt){let n=Xt[a],m=(r+j[a])*k.dnc;e.#A.subarray(m,m+k.dnc).fill(n)}}}init(e=0){let t=this;t.#Z=0,t.#M[T.xg][1]=0,t.dispatchEvent("banklevel",{mode:"xg",data:0}),t.#s.fill(0),t.#e.fill(0),t.#c.fill(0),t.#f.fill(0),t.#o.fill(0),t.#d.fill(0),t.#u.fill(0),t.#h.fill(0),t.#m.fill(0),t.#E.fill(0),t.#L.fill(0),t.#b.fill(0),t.#C.fill(0),t.#S.fill(0),t.#ie.fill(0),t.#z.fill(0),t.#W.fill(0),t.#k=100,t.#B=[],t.#ne=500,t.modelEx.sg.convLastSyll=0,t.modelEx.sg.runLineLen=0,t.modelEx.sg.splitMask=!1,t.#l=0,t.#a=0;for(let r=0;r<t.#r.length;r++)t.#g.fill(0);t.#w=t.KARAOKE_NONE,t.#oe=0,t.#X=!0,t.#$=!1,t.#ce=0,t.initDrums(),t.polyIndexLatest=0,t.polyIndexLast=0,t.#i.forEach(function(r,a,n){n[a]=a}),e===0&&(t.dispatchEvent("mode","?"),t.#t=0,t.#H.fill(0),t.#Y.fill(0),t.#K=0,t.#V=""),ka.forEach(r=>{t.setChCc(r,0,t.#M[t.getChModeId(r)][2])}),t.#n.fill(t.CH_MELODIC),t.#n[9]=t.CH_DRUM1,t.#n[25]=t.CH_DRUM3,t.#n[41]=t.CH_DRUMS,t.#n[57]=t.CH_DRUMS,t.#n[73]=t.CH_DRUM5,t.#n[89]=t.CH_DRUM7,t.#n[105]=t.CH_DRUMS,t.#n[121]=t.CH_DRUMS;for(let r=0;r<k.drm;r++)t.#U[r<<1]=0,t.#U[r<<1|1]=k.invalidCh;t.#le.fill(0),t.#G.fill(0),t.#F.fill(0),t.#O.fill(0),t.#D.fill(0),t.#R.fill(0),t.#q.fill(0),t.aiEfxName="",t.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),t.modelEx.xg.varSys=!1,t.modelEx.xg.insPart.fill(k.invalidCh);for(let r=0;r<re.length;r++){let a=t.modelEx.yPlg[r];a.fill(0,0,re[r][2]),a.fill(k.invalidCh,re[r][2])}t.modelEx.sc.showBar=!0,t.modelEx.sc.invBar=!1,t.modelEx.sc.invDisp=!1,t.modelEx.sc.peakHold=1,t.modelEx.cs1x.perfCh=0;for(let r=0;r<k.ch;r++){t.resetChCvn(r);let a=H[r];t.#e[a+M[7]]=100,t.#e[a+M[11]]=127,t.#e[a+M[2]]=127,t.#e[a+M[10]]=64,t.#e.subarray(a+M[71],a+M[71]+8).fill(64),t.#e[a+M[128]]=127,t.#e.subarray(a+M[130],a+M[157]+1).fill(64),t.#e[a+M[91]]=40,t.#e[a+M[101]]=127,t.#e[a+M[100]]=127,t.#e[a+M[99]]=127,t.#e[a+M[98]]=127;let n=r*k.rpn;t.#p[n]=2,t.#p[n+1]=64,t.#p[n+2]=0,t.#p[n+3]=64,t.#p[n+4]=0,t.#p[n+5]=0;let m=r*k.ext;t.#C[m+1]=t.VLBC_BRTHEXPR;let u=r*k.redir;t.#W[u+8]=13}t.buildRchTree(),t.buildRccMap(),t.dispatchEvent("mastervolume",t.#k);for(let r=0;r<Re.length;r++)t.pushEffectType(r);t.dispatchEvent("reset"),t.switchMode("?")}setChMode(e,t){let r=this;if(typeof e!="number"||e<0||e>=k.ch)throw new RangeError(`Invalid part number: CH${e+1}`);if(e<0||t>=G.length)throw new RangeError(`Invalid mode ID ${t}`);r.#z[e]=t,r.dispatchEvent("chmode",{part:e,id:t,mode:G[t]}),r.pushChPrimitives(e)}getChMode(e,t){return G[this.getChModeId(e,t)]}getChModeId(e,t){return t?this.#z[e]||this.#S[e>>4]:this.#z[e]||this.#S[e>>4]||this.#t}getPortMode(e,t){return G[this.getPortModeId(e,t)]}getPortModeId(e,t){return t?this.#S[e]:this.#S[e]||this.#t}setPortMode(e,t,r){let a=this;if(e<0||e>=k.ch>>4)throw new RangeError(`Invalid port ${e+1}`);if(t<1)throw new RangeError("Range must be a positive integer");if(e+t>=k.ch>>4)throw new RangeError("Range must be in bound");if(e<0||r>=G.length)throw new RangeError(`Invalid mode ID ${r}`);a.#ie[e]=r;for(let n=e;n<e+t;n++){let m=a.#ie[n];if(t>1&&m!==0&&m!==r)break;a.#S[n]=r;for(let u=n<<4;u<n+1<<4;u++)a.dispatchEvent("chmode",{part:u,id:r,mode:G[r]}),a.pushChPrimitives(u)}}copyChSetup(e,t,r){if(e===t){console.warn(`Failed attempt at overwriting CH${e+1} with its own data.`);return}let a=this;if(r&&a.#s[t]){console.warn(`Failed attempt at copying setup data from CH${e+1} to CH${t+1}.`);return}let n=H[e],m=H[t];a.#f[t]=a.#f[e],a.#e.set(a.#e.subarray(n,n+k.cc),m),a.pushChPrimitives(t)}setDrumFirstWrite(e,t){let r=this,a=r.#n[e];if(a<2)return;let n=a-2;if(r.#U[n<<1])if(t)r.#U[n<<1]=0,D()&&console.debug(`First write part for drum set ${n+1} has been reset.`);else return;else t?console.warn(`First write part for drum set ${n+1} is already blank.`):(r.#U[n<<1]=1,r.#U[n<<1|1]=e,console.debug(`First write part for drum set ${n+1} is set to CH${e+1}.`))}getChDrumFirstWrite(e){let t=this,r=t.#n[e];if(r<2)return;let a=r-2;return t.#U.subarray(a<<1,a+1<<1)}getDrumFirstWrite(e){if(e>=0&&e<k.drm)return this.#U.subarray(e<<1,e+1<<1)}switchMode(e,t=!1,r=!1){let a=this,n=T[e];if(n>-1){if(a.#t===0||t){switch(a.initOnReset&&t&&a.init(1),a.#a=0,n){case T.gm:{n=a.#y.gm;break}case T.g2:{n=a.#y.g2;break}}switch(a.#t=n,n){case T.gs:case T.sc:{a.#M[T[e]][1]=a.#y[e];break}}for(let y=0;y<k.ch;y++){let E=a.getChModeId(y,!0);a.#n[y]>0&&E===T["?"]&&(a.setChCc(y,0,a.#M[n][2]),D()&&console.debug(`CH${y+1} (${a.#n[y]}) (${a.getChMode(y)}), ${G[E]} (${a.#M[E][2]}) -> ${G[n]} (${a.#M[n][2]})`),a.pushChPrimitives(y))}switch(n){case T.mt32:{ft.forEach((y,E)=>{let C=E+1;a.#s[C]||(a.#f[C]=y,a.setChCc(C,91,127),a.pushChPrimitives(C))});for(let y=1;y<10;y++)a.pushChPrimitives(y);break}}let m,u;switch(n){case T["?"]:case T.g2:{m=[52,4,52,18,0,255,0,255,0,255,0,255,0,255,0,255];break}case T.xg:case T.cs1x:{m=[1,0,65,0,5,0,64,0,64,0,64,0,64,0,0,255],u=[64,0];break}case T.gm:case T.gs:case T.sc:{m=[40,4,40,18,40,32,32,0,0,255,0,255,0,255,0,255],u=[32,0];break}case T.sd:{m=[58,0,60,0,61,0,61,0],u=[61,0];break}case T["05rw"]:case T.x5d:case T.ns5r:{m=[44,1,44,19,0,255,0,255,0,255,0,255,0,255,0,255];break}case T.k11:case T.sg:{m=[24,0,0,255,0,255,0,255,0,255,0,255,0,255,0,255];break}case T.mt32:{m=[40,4,0,255,0,255,0,255,0,255,0,255,0,255,0,255];break}case T.doc:{m=[24,16,0,255,0,255,0,255,0,255,0,255,0,255,0,255];break}case T.motif:case T.s90es:case T.cs6x:{m=[129,0,133,0,130,0,128,0,128,0,0,255,0,255,0,255],u=[128,0];break}case T.pa:{m=[28,52,28,16,28,0,28,0,0,255,0,255,0,255,0,255],u=[28,0];break}case T.krs:{m=[45,0,45,0,0,255,45,0,45,0,45,0,45,0,45,0],u=[45,0];break}default:m=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}for(let y=0;y<k.efx;y++)if(!a.#R[3*y]&&typeof m[y<<1]=="number"){a.#R[3*y+1]=m[y<<1],a.#R[3*y+2]=m[y<<1|1];let E=!1;u?.length>0&&m[y<<1]===u[0]&&m[y<<1|1]===u[1]&&(E=!0),a.pushEffectType(y,E)}r&&a.setDetectionTargets(e),a.dispatchEvent("mode",G[n]),a.forceVoiceRefresh()}}else throw new Error(`Unknown mode ${e}`)}getRawStrength(){let e=this;return this.#d.forEach(function(t){let r=t>>7;e.#o[t]>e.#m[r]&&(e.#m[r]=e.#o[t])}),this.#m}getStrength(){let e=[],t=this;return this.getRawStrength().forEach(function(r,a){e[a]=Math.floor(r*t.getChCc(a,7)*t.getChCc(a,11)*t.#k/803288)}),e}newStrength(){this.#m.fill(0)}runJson(e){if(e.type>14)return e.type===15&&e.data.constructor!==Uint8Array&&(e.data=Uint8Array.from(e.data)),this.#pe[e.type].call(this,e);{let t=this.chRedir(e.part,e.track),r=!1;this.#ue[t]?.forEach(a=>{e.channel=a,r=!0,this.#pe[e.type].call(this,e)}),r||console.warn(`${Ot[e.type]?Ot[e.type]:e.type}${[11,12].includes(e.type)?(e.data[0]!==void 0?e.data[0]:e.data).toString():""} event sent to CH${t+1} without any recipient.`)}this.#B.length>100&&this.#B.splice(100,this.#B.length-99)}runRaw(e){}async loadBank(e,t){let r=this;switch(e=e.toLowerCase(),e){case"s7e":{r.userBank.clearRange({msb:63,lsb:[21,22]}),r.userBank.clearRange({msb:63,lsb:[24,27]});break}case"pcg":{r.userBank.clearRange({msb:63,lsb:[6,9]}),r.userBank.clearRange({msb:63,lsb:[13,16]});break}default:throw new Error(`Unknown bank format ${e}`)}switch(e){case"s7e":case"pcg":{Te.context=this,await r.userBank.load(await Te.read(e,t),!1);break}}r.forceVoiceRefresh()}constructor(){super();let e=this;for(let f=0;f<10;f++)e.#r[f]=new Uint8Array(256);e.#r[10]=new Uint8Array(512),e.#J=new ae,e.#y={x5:82,ds:T.krs,smotif:T.s90es,gs:4,sc:3,gm:T.gm,g2:T.g2},e.#N={dumpLimit:e.DUMP_MODE},e.#he=new Proxy(e.#N,{set:()=>{}});for(let f in Le){let o=T[f];o===void 0?console.debug(`SubDB build error: "${f}" does not exist`):e.#M[o]=new Uint8Array(Le[f])}for(let f of re)e.modelEx.yPlg.push(new Uint8Array(f[1]));e.userBank.strictMode=!0,e.userBank.load(`MSB	PRG	LSB	NME
062	000	000	
122	000	000	
122	001	000	
122	002	000	
122	003	000	
122	004	000	
122	005	000	
122	006	000	`),e.addEventListener("metacommit",function(f){let{data:o}=f;e.#B[0]?.type===o.type&&e.#B[0]?.amend?(e.#B[0].amend=o.amend,e.#B[0].data+=o.data):e.#B.unshift(o)}),e.#P[1]=function(f){switch(f=f.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),f.substring(0,2)){case"@I":{e.#w=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"Kar.Info",data:f.substring(2)?.trimStart()});break}case"@K":{e.#w=e.KARAOKE_TEXT;let o=f.substring(2);o!=="MIDI KARAOKE FILE"&&e.dispatchEvent("metacommit",{type:"Kar.Mode",data:o?.trimStart()}),console.debug(`Karaoke mode active: ${o}`);break}case"@L":{e.#w=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"Kar.Lang",data:f.substring(2)?.trimStart()});break}case"@T":{e.#w=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"KarTitle",data:f.substring(2)?.trimStart()});break}case"@V":{e.#w=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"Kar.Ver.",data:f.substring(2)?.trimStart()});break}case"Mi":{if(f.substring(2,16)==="dStamp-1.00: 0"){let o=f.length;for(let i=f.length;i>0;i--)if((f.charCodeAt(i-1)>>5)+1>>1===1){o=i;break}let s=f.substring(16,o);e.dispatchEvent("metacommit",{type:"MidStamp",data:Ut(s)})}else f.split(`
`).forEach((o,s)=>{e.dispatchEvent("metacommit",{type:"Cmn.Text",data:o,mask:s!==0})});break}case"XF":{let o=f.slice(2).split(":");switch(o[0]){case"hd":{o.slice(1).forEach((s,i)=>{s.length&&e.dispatchEvent("metacommit",{type:["XfSngDte","XfSngRgn","XfSngCat","XfSongBt","XfSngIns","XfSngVoc","XfSngCmp","XfSngLrc","XfSngArr","XfSngPer","XfSngPrg","XfSngTag"][i],data:s})});break}case"ln":{o.slice(1).forEach((s,i)=>{s.length&&e.dispatchEvent("metacommit",{type:["XfKarLng","XfKarNme","XfKarCmp","XfKarLrc","XfKarArr","XfKarPer","XfKarPrg"][i],data:s})});break}default:e.dispatchEvent("metacommit",{type:"XfUnData",data:f})}break}default:switch(e.#w){case e.KARAOKE_TEXT:{switch(f[0]){case"\\":{e.dispatchEvent("metacommit",{type:"KarLyric",data:"",amend:!1}),e.dispatchEvent("metacommit",{type:"KarLyric",data:f.substring(1),amend:!0});break}case"/":{e.dispatchEvent("metacommit",{type:"KarLyric",data:"",mask:!0,amend:!1}),e.dispatchEvent("metacommit",{type:"KarLyric",data:f.substring(1),mask:!0,amend:!0});break}default:e.dispatchEvent("metacommit",{type:"KarLyric",data:f,amend:!0})}break}default:f.split(`
`).forEach((o,s)=>{e.dispatchEvent("metacommit",{type:"Cmn.Text",data:o,mask:s!==0})})}}},e.#P[2]=function(f){e.dispatchEvent("metacommit",{type:"Copyrite",data:f})},e.#P[3]=function(f,o){o<1&&e.#Z<1&&e.dispatchEvent("metacommit",{type:"TrkTitle",data:f})},e.#P[4]=function(f,o){e.dispatchEvent("metacommit",{type:"Instrmnt",data:f})},e.#P[5]=function(f){switch(e.#w){case e.KARAOKE_XF:{let o="";for(let s of f)switch(s){case"^":case"%":{o+=" ";break}case">":{o+="	";break}case"<":{e.dispatchEvent("metacommit",{type:"KarLyric",data:o,mask:e.#$,amend:!1}),o="",e.#$=!1;break}case"/":{e.dispatchEvent("metacommit",{type:"KarLyric",data:o,mask:!1,amend:!1}),o="",e.#$=!0;break}default:o+=s}o.length>0&&(e.dispatchEvent("metacommit",{type:"KarLyric",data:o,mask:e.#$,amend:!0}),e.#$=!1);break}default:{let o=0,s=!0,i=f.length-1;for(;s&&o<8;)switch(f.charCodeAt(o)){case 32:{o++;break}default:s=!1}switch(o>0&&(e.dispatchEvent("metacommit",{type:"C.Lyrics",data:f.substring(0,o),amend:!0,mask:e.#$,untimed:!0}),e.#$=!1),f.charCodeAt(i)){case 10:{e.dispatchEvent("metacommit",{type:"C.Lyrics",data:f.substring(o,i),amend:!1,mask:e.#$}),e.#$=!1;break}case 11:case 13:{e.dispatchEvent("metacommit",{type:"C.Lyrics",data:f.substring(o,i),amend:!1,mask:e.#$}),e.#$=!0;break}case 32:{e.dispatchEvent("metacommit",{type:"C.Lyrics",data:f.substring(o,i),amend:!0,mask:e.#$}),e.dispatchEvent("metacommit",{type:"C.Lyrics",data:" ",amend:!0,mask:!1,untimed:!0}),e.#$=!1;break}default:f.trim()===""?console.info("Blank line? Shouldn't happen."):e.dispatchEvent("metacommit",{type:"C.Lyrics",data:f,amend:!0,mask:e.#$}),e.#$=!1}break}}},e.#P[6]=function(f){e.dispatchEvent("metacommit",{type:"C.Marker",data:f})},e.#P[7]=function(f){switch(f[0]){case"$":{if(f.substring(1,5)==="Lyrc"){e.#w=e.KARAOKE_XF;let o=f.substring(6).split(":"),s=o[0].replaceAll(" ","").split(",");s.forEach((l,h,c)=>{c[h]=parseInt(l)-1});let i=xt[o[2].substring(0,2).toLowerCase()];e.dispatchEvent("metacommit",{type:"XfMeloCh",data:`CH${o[0].replaceAll(" ","").split(",").join(", CH")}`,parsed:s}),e.dispatchEvent("metacommit",{type:"XfLyrOff",data:o[1],parsed:parseInt(o[1])}),e.dispatchEvent("metacommit",{type:"XfLyrEnc",data:i[1],parsed:i[0]}),e.#$=!1}else e.dispatchEvent("metacommit",{type:"CuePoint",data:f});break}case"#":{e.dispatchEvent("metacommit",{type:"XfScneNo",data:f.substring(1)});break}case"&":{f.length===2?(e.dispatchEvent("metacommit",{type:"XfSngPrt",data:Pt[f[1]]||`Unknown "${f[1]}"`}),e.#$=!1):e.dispatchEvent("metacommit",{type:"CuePoint",data:f});break}default:e.dispatchEvent("metacommit",{type:"CuePoint",data:f})}},e.#P[32]=function(f){e.#Z=f[0]+1},e.#P[33]=function(f,o){D()&&console.debug(`Track ${o} requests getting assigned to port ${f}.`),e.#Y[o]=f+1},e.#P[81]=function(f,o){e.#ne=f/1e3},e.#P[127]=function(f,o){e.#J.run(f,o)},e.#J.default=function(f){let o=[];for(let s=0;s<8&&s<f.length;s++)o.push(f[s].toString(16).padStart(2,"0").toUpperCase());console.warn(`Unrecognized implementation-specific byte sequence: ${o.join(" ")}${f.length>8?" ...":""}
%o`,f)},e.#J.add([67,0,1],(f,o)=>{D()&&console.debug(`XGworks port assign requests assigning track ${o} to port ${f[0]}.`),e.#Y[o]=f[0]+1}).add([67,123,1],(f,o)=>{let s=[];for(let i=0;i<f.length;i+=2){let l=f[i]>>4,h=f[i]&15;if(l<7&&h&&h<8){let c=new Uint8Array(5);c[0]=h-1,c[1]=l-3<<2,c[2]=f[i|1],s.push(c)}}e.dispatchEvent("metacommit",{type:"ChordCtl",src:"yxf",data:s}),console.debug("Yamaha XF chord data: %o",s)}).add([67,123,2],(f,o)=>{let s=new Uint8Array(2);s[0]=f[0]&15,s[1]=f[0]>>4,e.dispatchEvent("metacommit",{type:"RhrslMrk",src:"yxf",data:s}),console.debug(`Yamaha XF rehearsal mark: ${["Intro","Ending","Fill-in"][s[0]]??String.fromCharCode(62+s[0])}${"'".repeat(s[1])} %o`,s)}).add([67,123,96],(f,o)=>{let s=[0,0];f.subarray(1,3).forEach(i=>{s[0]=s[0]<<7,s[0]|=i&127}),f.subarray(3,5).forEach(i=>{s[1]=s[1]<<7,s[1]|=i&127}),e.dispatchEvent("metacommit",{type:"YStyleId",data:s}),console.debug(`Yamaha style ID: model ${s[0].toString(16)}, style ${s[1]+1}`)}),e.#ee=new ae("universal non-realtime"),e.#te=new ae("universal realtime"),e.#x=new ae("Yamaha"),e.#I=new ae("Roland"),e.#_=new ae("Korg"),e.#ae=new ae("Kawai"),e.#fe=new ae("Akai"),e.#re=new ae("Casio");let t=new ae("DX7+ Dump"),r=function(f){let o=[];for(let s=0;s<8&&s<f.length;s++)o.push(f[s].toString(16).padStart(2,"0").toUpperCase());console.info(`Unrecognized SysEx in "${this.name}" set: ${o.join(" ")}${f.length>8?" ...":""}
%o`,f)};e.#ee.default=r,e.#te.default=r,e.#x.default=r,e.#I.default=r,e.#_.default=r,e.#ae.default=r,e.#fe.default=r,e.#re.default=r,t.default=r,e.#ee.add([9],(f,o,s)=>{e.switchMode(["gm","?","g2"][f[0]-1],!0),e.setPortMode(e.getTrackPort(o),1,[T.gm,T["?"],e.#y.g2][f[0]-1]),e.#w=e.#w||e.KARAOKE_NONE,console.info(`MIDI reset: ${["GM","Init","GM2"][f[0]-1]}`),f[0]===2&&e.init()}),e.#te.add([4,1],(f,o,s)=>{e.invokeSysExIndicator(),e.#k=((f[1]<<7)+f[0])/16383*100,e.dispatchEvent("mastervolume",e.#k)}).add([4,3],(f,o,s)=>((f[1]<<7)+f[0]-8192)/8192).add([4,4],(f,o,s)=>f[1]-64).add([4,5],(f,o,s)=>{e.invokeSysExIndicator();let i=f[0],l=f[1],h=f[2],c=3,p=c+(i<<1),d=p+l;if(i!==1){console.error(`Unsupported GM2 global parameter set: slotpath length too long (${i})!
`,f);return}let b=0,g=0,w=0;switch(f.subarray(c,p).forEach(v=>{b=b<<7,b|=v}),f.subarray(p,d).forEach((v,$)=>{g|=v<<$*7}),f.subarray(d).forEach((v,$)=>{w|=v<<$*7}),D()&&console.debug(`GM2 global parameter: (${f.subarray(3,p)}; p: ${g}, v: ${w})`),b){case 129:{g===0&&(e.setEffectType(0,52,w),e.pushEffectType(0));break}case 130:{g===0&&(e.setEffectType(1,52,w|16),e.pushEffectType(1));break}default:D()&&console.debug("GM2 global paramater slot path unknown.")}}),this.#x.add([76,0,0],(f,o,s)=>{switch(f[0]){case 125:{e.initDrums(),console.info(`XG drum setup reset on drum kit ${f[1]}.`);break}case 126:{e.switchMode("xg",!0),e.setPortMode(e.getTrackPort(o),4,T.xg),e.#w=e.#w||e.KARAOKE_NONE,console.info("MIDI reset: XG");break}default:{e.invokeSysExIndicator();let i=[0,0,0,0],l=(h,c)=>{i[c]=h};if(f.subarray(1).forEach((h,c)=>{let p=c+f[0];([l,l,l,l,d=>{this.#k=d*129/16383*100,e.dispatchEvent("mastervolume",e.#k)},d=>{},d=>{}][p]||(()=>{}))(h,c)}),f[0]<4){let h=0;i.forEach(c=>{h=h<<4,h+=c}),h-=1024,console.debug(`Master tune: ${h}`)}}}}).add([76,2,1],(f,o,s)=>{e.invokeSysExIndicator();let i="XG ";f[0]<32?(i+="reverb ",f.subarray(1).forEach((l,h)=>{([c=>{e.setEffectTypeRaw(0,!1,c),console.info(`${i}main type: ${xe[c]}`),e.pushEffectType(0)},c=>{e.setEffectTypeRaw(0,!0,c),console.debug(`${i}sub type: ${c+1}`),e.pushEffectType(0)},c=>{console.debug(`${i}time: ${vt(c)}s`)},c=>{console.debug(`${i}diffusion: ${c}`)},c=>{console.debug(`${i}initial delay: ${c}`)},c=>{console.debug(`${i}HPF cutoff: ${Ce[c]}Hz`)},c=>{console.debug(`${i}LPF cutoff: ${Ce[c]}Hz`)},c=>{console.debug(`${i}width: ${c}`)},c=>{console.debug(`${i}height: ${c}`)},c=>{console.debug(`${i}depth: ${c}`)},c=>{console.debug(`${i}wall type: ${c}`)},c=>{console.debug(`${i}dry/wet: ${c}`)},c=>{console.debug(`${i}send: ${Z(c)}dB`)},c=>{console.debug(`${i}pan: ${c-64}`)},!1,!1,c=>{console.debug(`${i}delay: ${c}`)},c=>{console.debug(`${i}density: ${c}`)},c=>{console.debug(`${i}balance: ${c}`)},c=>{},c=>{console.debug(`${i}feedback: ${c}`)},c=>{}][f[0]+h]||function(){console.warn(`Unknown XG reverb address: ${f[0]}.`)})(l)})):f[0]<64?(i+="chorus ",f.subarray(1).forEach((l,h)=>{([c=>{e.setEffectTypeRaw(1,!1,c),console.info(`${i}main type: ${xe[c]}`),e.pushEffectType(1)},c=>{e.setEffectTypeRaw(1,!0,c),console.debug(`${i}sub type: ${c+1}`),e.pushEffectType(1)},c=>{console.debug(`${i}LFO: ${kt[c]}Hz`)},c=>{},c=>{console.debug(`${i}feedback: ${c}`)},c=>{console.debug(`${i}delay offset: ${St(c)}ms`)},c=>{},c=>{console.debug(`${i}low: ${Ce[c]}Hz`)},c=>{console.debug(`${i}low: ${c-64}dB`)},c=>{console.debug(`${i}high: ${Ce[c]}Hz`)},c=>{console.debug(`${i}high: ${c-64}dB`)},c=>{console.debug(`${i}dry/wet: ${c}`)},c=>{console.debug(`${i}send: ${Z(c)}dB`)},c=>{console.debug(`${i}pan: ${c-64}`)},c=>{console.debug(`${i}to reverb: ${Z(c)}dB`)},!1,c=>{},c=>{},c=>{},c=>{console.debug(`${i}LFO phase diff: ${(c-64)*3}deg`)},c=>{console.debug(`${i}input mode: ${c?"stereo":"mono"}`)},c=>{}][f[0]-32+h]||function(){console.warn(`Unknown XG chorus address: ${f[0]}.`)})(l)})):f[0]<86?(i+="variation ",f.subarray(1).forEach((l,h)=>{([c=>{e.setEffectTypeRaw(2,!1,c),console.info(`${i}main type: ${xe[c]}`),e.pushEffectType(2)},c=>{e.setEffectTypeRaw(2,!0,c),console.debug(`${i}sub type: ${c+1}`),e.pushEffectType(2)}][f[0]-64+h]||function(){})(l)})):f[0]<97?(i+="variation ",f.subarray(1).forEach((l,h)=>{[c=>{console.debug(`${i}send: ${Z(c)}dB`)},c=>{console.debug(`${i}pan: ${c-64}`)},c=>{console.debug(`${i}to reverb: ${Z(c)}dB`)},c=>{console.debug(`${i}to chorus: ${Z(c)}dB`)},c=>{e.modelEx.xg.varSys=!!c,console.debug(`${i}connection: ${c?"system":"insertion"}`)},c=>{if(e.modelEx.xg.varSys){console.warn(`${i}effect is applied system-wide. Setting its effective channel to CH${c+1} will not have any effect.`);return}if(c<64){let p=e.chRedir(c,o,!0);e.setXgChEffectSink(p,2),console.debug(`${i}channel: CH${c+1} (CH${p+1})`)}else e.setXgChEffectSink(k.invalidCh,2),console.info(`${i}channel: CH${c+1} (unsupported)`)},c=>{console.debug(`${i}mod wheel: ${c-64}`)},c=>{console.debug(`${i}bend wheel: ${c-64}`)},c=>{console.debug(`${i}channel after touch: ${c-64}`)},c=>{console.debug(`${i}AC1: ${c-64}`)},c=>{console.debug(`${i}AC2: ${c-64}`)}][f[0]-86+h](l)})):f[0]>111&&f[0]<118?i+="variation ":console.warn(`Unknown XG variation address: ${f[0]}`)}).add([76,2,64],(f,o,s)=>{f.subarray(1).forEach((i,l)=>{let h=l+f[0];if(h===0)console.debug(`XG EQ preset: ${["flat","jazz","pop","rock","classic"][i]}`);else{let c=h-1>>2,p=h-1&3,d=`XG EQ ${c} ${["gain","freq","Q","shape"][p]}: `;[()=>{console.debug(`${d}${i-64}dB`)},()=>{console.debug(`${d}${i} (raw)`)},()=>{console.debug(`${d}${i/10}`)},()=>{console.debug(`${d}${["shelf","peak"][+!!i]}`)}][p]()}})}).add([76,3],(f,o,s)=>{e.invokeSysExIndicator();let i=f[0],l=f[1],h=`XG Insertion ${f[0]+1} `;f.subarray(2).forEach((c,p)=>{([()=>{e.setEffectTypeRaw(3+i,!1,c),console.info(`${h}main type: ${xe[c]}`),e.pushEffectType(3+i)},()=>{e.setEffectTypeRaw(3+i,!0,c),console.debug(`${h}sub type: ${c+1}`),e.pushEffectType(3+i)},!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,()=>{if(c<64){let d=e.chRedir(c,o,!0);e.setXgChEffectSink(d,3+i),console.debug(`${h}channel: CH${c+1} (CH${d+1})`)}else e.setXgChEffectSink(k.invalidCh,3+i),console.info(`${h}channel: CH${c+1} (unsupported)`)}][l+p]||function(){})(c)})}).add([76,6,0],(f,o,s)=>{let i=f[0];i<64?e.setLetterDisplay(f.subarray(1),"XG letter display",i):e.#K=Date.now()}).add([76,7,0],(f,o,s)=>{let i=f[0];e.#a=0,e.#l=Date.now()+3200,f.subarray(1).forEach(function(h,c){let p=c+i,d=p>>4,b=p&15,g=(b*3+d)*7,w=7,v=0;for(g-=b*5,d===2&&(w=2);v<w;)e.#g[g+v]=h>>6-v&1,v++})}).add([76,8],(f,o)=>{e.invokeSysExIndicator();let s=e.chRedir(f[0],o,!0),i=f[1],l=H[s],h=`XG CH${s+1} `,c=`Unknown XG part address ${i}.`,p=!0;f.subarray(2).forEach((d,b)=>{p=!0,i<1?console.debug(c):i<41?([()=>{e.setChCc(s,0,d),e.pushChPrimitives(s)},()=>{e.setChCc(s,32,d),e.pushChPrimitives(s)},()=>{e.#f[s]=d,e.pushChPrimitives(s)},()=>{p=!1;let g=e.chRedir(d,o,!0),w=e.#i[s];e.#i[s]=g,(s!==g||g!==w)&&(e.buildRchTree(),console.info(`${h}receives from CH${g+1}`)),e.#s[s]||(e.copyChSetup(g,s,!0),console.debug(`${h}copied from CH${g+1}.`),e.setChActive(s,1),e.pushChPrimitives(s))},()=>{e.#h[s]=+!d},()=>{},()=>{p=!1,e.setChType(s,d,T.xg),console.debug(`${h}type: ${Pe[d]||d}`),e.pushChPrimitives(s)},()=>{e.#p[k.rpn*s+3]=d,e.#b[k.rpnt*s+2]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},!1,!1,()=>{e.setChCc(s,7,d)},!1,!1,()=>{e.setChCc(s,10,d||128)},!1,!1,()=>{e.setChCc(s,128,d),e.allocateAce(s,128)},()=>{e.setChCc(s,93,d)},()=>{e.setChCc(s,91,d)},()=>{e.setChCc(s,94,d)},()=>{e.setChCc(s,76,d)},()=>{e.setChCc(s,77,d)},()=>{e.setChCc(s,78,d)},()=>{e.setChCc(s,74,d)},()=>{e.setChCc(s,71,d)},()=>{e.setChCc(s,73,d)},()=>{e.setChCc(s,75,d)},()=>{e.setChCc(s,72,d)}][i+b-1]||(()=>{}))():i<48?console.debug(c):i<111?i>102&&i<105&&e.setChCc(s,[5,65][i&1],d):i<114?console.debug(c):i<116?console.debug(`${h}EQ ${["bass","treble"][i&1]} gain: ${d-64}dB`):i<118?console.debug(c):i<120?console.debug(`${h}EQ ${["bass","treble"][i&1]} freq: ${d}`):console.debug(c)}),p&&e.#n[s]>1&&e.setDrumFirstWrite(s)}).add([76,9],(f,o)=>{let s=e.chRedir(f[0],o,!0),i=f[1],l=H[s],h=`PLG-VL CH${s+1} `;f.subarray(2).forEach((c,p)=>{let d=p+i;switch(d){case 1:{console.info(`${h}breath mode: ${["system","breath","velocity","touch EG"][c]}`);break}case 0:case 27:case 28:break;default:if(d<27){let b=d-3>>1,g=["pressure","embouchure","tonguing","scream","breath noise","growl","throat formant","harmonic enhancer","damping","absorption","amplification","brightness"][b];d&1?d<23?(console.debug(`${h}${g} control source: ${Tt(c)}`),c&&c<96&&e.allocateAce(s,130+b),e.#W[k.redir*s+b+2]=c,e.buildRccMap()):console.debug(`${h}${g} scale break point: ${c}`):(console.debug(`${h}${g} depth: ${c-64}`),e.setChCc(s,130+b,c))}}})}).add([76,10],(f,o,s)=>{}).add([76,16],(f,o,s)=>{}).add([76,17,0,0],(f,o,s)=>{}).add([76,112],(f,o,s)=>{if(f[0]>=re.length){console.error(`Supplied invalid plugin board ID: ${f[0]}`);return}if(f[1]>=re[f[0]][1]){console.error(`Supplied invalid slot ID for board type "${re[f[0]][0]}" (${f[0]}): ${f[1]} (#${f[1]+1}))`);return}switch(f[1]>=re[f[0]][2]?console.warn(`While enabled in Octavia, slot #${f[1]+1} for board type "${re[f[0]][0]}" (${f[0]}) may not function outside software recreation.`):f[2]>63?console.debug(`XG disable PLG-${re[f[0]][0]} (${f[0]}) slot #${f[1]+1} as it's set to CH${f[2]+1}.`):console.debug(`XG enable PLG-${re[f[0]][0]} (${f[0]}) slot #${f[1]+1} for CH${f[2]+1}.`),e.modelEx.yPlg[f[0]][f[1]]=f[2]<64?e.chRedir(f[2],o,!0):k.invalidCh,f[0]){case 0:{e.#C[k.ext*f[2]]=e.EXT_VL;break}case 2:{e.#C[k.ext*f[2]]=e.EXT_DX;break}default:e.#C[k.ext*f[2]]=e.EXT_NONE}}).add([73,0,0],(f,o)=>{let s=f[0],i="MU1000 System - ";f.subarray(1).forEach((l,h)=>{let c=s+h;c===8?console.debug(`${i}LCD contrast: ${l}.`):c===18?(e.#M[T.xg][1]=l?126:0,console.debug(`${i}default bank: ${l?"MU100 Native":"MU Basic"}.`),e.dispatchEvent("banklevel",{mode:"xg",data:+!!l}),e.forceVoiceRefresh()):c>=64&&c<69&&[()=>{e.dispatchEvent("channelactive",l)},()=>{l<8?(e.dispatchEvent("channelmin",l<<4),console.debug(`Octavia System: Minimum CH${(l<<4)+1}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{l<8?(e.dispatchEvent("channelmax",(l<<4)+15),console.debug(`Octavia System: Maximum CH${(l<<4)+16}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges")},()=>{e.#X=!!l,console.info(`Octavia System: RS receiving ${["dis","en"][l]}abled.`)}][c-64]()})}).add([73,10,0],(f,o)=>{let s=f[0],i=`MU1000 RS${e.#X?"":" (ignored)"}: `;if(s<16)switch(s){case 2:{let l=e.chRedir(0,o,!0);e.#X&&(e.dispatchEvent("portrange",4),e.dispatchEvent("portstart",l)),console.info(`${i}Show CH${l+1}~CH${l+64}`);break}case 3:{let l=e.chRedir(f[1]<<5,o,!0);e.#X&&(e.dispatchEvent("portrange",2),e.dispatchEvent("portstart",l)),console.info(`${i}Show CH${l+1}~CH${l+32}`);break}default:console.debug(`${i}unknown switch ${s} invoked.`)}else if(s<32){if(e.#X){let l=e.chRedir(s-16+(e.#oe<<4),o,!0);e.dispatchEvent("channelactive",l)}}else if(s<36){let l=e.chRedir(s-32<<4,o,!0);e.#X&&(e.dispatchEvent("portrange",1),e.dispatchEvent("portstart",l>>4),e.#oe=s-32),console.info(`${i}Show CH${l+1}~CH${l+16}`)}}).add([73,11,0],(f,o)=>{let s="MU1000 System - channel ",i="Octavia System - channel ",l=f[0];f.subarray(1).forEach((h,c)=>{let p=l+c;([()=>{e.setChActive(h,1),e.dispatchEvent("channelactive",h),D()&&console.debug(`${s}current part: CH${h+1}`)},()=>{h<5?(e.dispatchEvent("portrange",1<<h),console.debug(`${s}port range: ${1<<h} port(s)`)):(e.dispatchEvent("portrange",0),console.debug(`${s}port range: reset`))},()=>{h<16?(e.dispatchEvent("portstart",h),console.debug(`${i}start port: ${"ABCDEFGHIJKLMNOP"[h]}`)):(e.dispatchEvent("portstart",255),console.debug(`${i}start port: reset`))}][p]||(()=>{console.debug(`${s}unknown address: ${p}`)}))()})}).add([93,3],(f,o)=>{let s=e.chRedir(f[0],o,!0),i=`PLG-SG CH${s+1} `,l=Date.now(),h=e.modelEx.sg;if(f[1]===0){let c="",p=0;f.subarray(2).forEach((d,b)=>{b%2===0?c+=$t[d]||d.toString().padStart("0"):p+=d*13}),(l>=h.convLastSyll||h.runLineLen>=h.maxLineLen)&&(e.dispatchEvent("metacommit",{type:"SGLyrics",data:"",amend:!1}),h.splitMask=l<h.convLastSyll,h.runLineLen=0),e.dispatchEvent("metacommit",{type:"SGLyrics",data:`${Mt(c)}`,amend:!0,mask:h.splitMask}),h.runLineLen++,h.splitMask=!1,h.convLastSyll=l+Math.ceil(p/2)+e.#ne,D()&&console.debug(`${i}vocals: ${c}`)}else console.warn(`Unknown PLG-SG data: ${f}`)}).add([98,96],(f,o,s,i)=>{let l=e.chRedir(f[0],o,!0),h=H[l],c=f[1];f.subarray(2).forEach((p,d)=>{let b=c+d;if(!(b<10)){if(b===10)e.resetAce();else if(b<27){let g=b+131;e.setChCc(l,g,p),!i?.noAce&&p>0&&p!==64&&e.allocateAce(l,g),e.dispatchEvent("cc",{part:l,cc:g,data:p})}}})}).add([1,20],(f,o,s)=>{s===115?(e.switchMode("doc",!0),e.setPortMode(e.getTrackPort(o),1,T.doc),console.info("MIDI reset: DOC")):console.debug(`Unknown Yamaha SysEx: 67, ${s}, ${f.join(", ")}`)}).add([1,17,15,89],(f,o,s)=>{s===115?(e.setEffectType(0,24,f[0]|16),e.pushEffectType(0)):console.debug(`Unknown Yamaha SysEx: 67, ${s}, ${f.join(", ")}`)}).add([1,24],(f,o,s)=>{if(s===115){for(let i=0;i<16;i++){let l=e.chRedir(i,o,!0);e.setChCc(l,91,127)}console.info("DOC Global Reverb: on")}else console.debug(`Unknown Yamaha SysEx: 67, ${s}, ${f.join(", ")}`)}).add([126,0],(f,o,s)=>{switch(f[1]){case 0:{e.dispatchEvent("metacommit",{type:"YMCSSect",data:"Disabled",raw:"Intro "}),console.debug("Yamaha Section Control is off.");break}case 127:{e.dispatchEvent("metacommit",{type:"YMCSSect",data:["Intro","Main A","Main B","Fill-in AB","Fill-in BA","Ending","Blank"][f[0]-8]??`invalid section ${f[0]}`,raw:["Intro ","Main A","Main B","FillAB","FillBA","Ending","Blank "][f[0]-8]??`ID: ${f[0]}`}),console.debug(`Yamaha Section Control switches to "${["intro","main A","main B","fill-in AB","fill-in BA","ending","blank"][f[0]-8]??`Invalid section ${f[0]}`}".`);break}default:console.debug(`Unknown YMCS section control: ${f[1]}`)}}).add([126,2],(f,o,s)=>{let i=[];for(let l=0;l<f.length;l+=2){let h=f[l]>>4,c=f[l]&15;if(h<7&&c&&c<8){let p=new Uint8Array(5);p[0]=c-1,p[1]=h-3<<2,p[2]=f[l|1],i.push(p)}}e.dispatchEvent("metacommit",{type:"ChordCtl",src:"ymcs",data:i}),console.debug("YMCS chord data: %o",i)});let a=function(f,o,s,i){},n=function(f,o){e.invokeSysExIndicator();let s=f*k.dpn,i=o[0],l=o[1];o.subarray(2).forEach((h,c)=>{let p=c+l,d=-1;p<16?([()=>{d=24},()=>{d=25},()=>{d=26},()=>{},()=>{d=28},()=>{d=29},()=>{d=30},()=>{d=31},()=>{},()=>{},()=>{},()=>{d=20},()=>{d=21},()=>{d=22},()=>{d=23},()=>{}][p]||(()=>{console.debug(`Unknown XG-style drum param ${p} on set ${f+1}.`)}))():p<32||(p<40?([()=>{d=48},()=>{d=49},!1,!1,()=>{d=52},()=>{d=53}][p-32]||(()=>{console.debug(`Unknown XG-style drum param ${p} on set ${f+1}.`)}))():p<80||([()=>{d=36}][p-80]||(()=>{console.debug(`Unknown XG-style drum param ${p} on set ${f+1}.`)}))()),d>=0?(D()&&console.debug(s,d,i,h),e.#A[(s+j[d])*k.dnc+i]=h):D()&&console.debug(`XG-style drum param ${p} has no writes.`)})},m=function(f,o,s){e.invokeSysExIndicator();let i=f*k.dpn,l=(o<<7)+s[0];s.subarray(1).forEach((h,c)=>{let p=c+l,d=p&127,b=p>>7,g=-1;b>1&&([()=>{g=26},()=>{},()=>{g=28},()=>{g=29},()=>{g=30},()=>{},()=>{},()=>{g=31}][b-2]||(()=>{console.debug(`Unknown GS-style drum param ${b} on set ${f+1}.`)}))(),g>-1?(D()&&console.debug(i,g,d,h),e.#A[(i+j[g])*k.dnc+d]=h):D()&&console.debug(`GS-style drum param ${b} has no writes.`)})};this.#x.add([76,48],(f,o,s)=>{n(0,f)}).add([76,49],(f,o,s)=>{n(1,f)}).add([76,50],(f,o,s)=>{n(2,f)}).add([76,51],(f,o,s)=>{n(3,f)}).add([76,52],(f,o,s)=>{n(4,f)}).add([76,53],(f,o,s)=>{n(5,f)}).add([76,54],(f,o,s)=>{n(6,f)}).add([76,55],(f,o,s)=>{n(7,f)}),this.#x.add([89,0],(f,o,s)=>{if(e.eprom){let i=f[0],l=(f[1]<<14)+(f[2]<<7)+f[3]+(e.eprom.offset||0);D()&&console.debug(`MU1000 EPROM trail to 0x${l.toString(16).padStart(6,"0")}, ${i} bytes.`);let h=e.eprom.data;f.subarray(4).forEach((c,p)=>{let d=p>>3,b=p&7;if(b===7)for(let g=0;g<7;g++)h[l+7*d+g]+=(c>>6-g&1)<<7;else h[l+7*d+b]=c})}}).add([89,1],(f,o,s)=>{let i=(f[0]<<21)+(f[1]<<14)+(f[2]<<7)+f[3];D()&&console.debug(`MU1000 EPROM jump to 0x${i.toString(16).padStart(6,"0")}.`),e.eprom&&(e.eprom.offset=i)}).add([89,2],(f,o,s)=>{if(e.eprom){let i=(f[0]<<21)+(f[1]<<14)+(f[2]<<7)+f[3]+(e.eprom.offset||0);D()&&console.debug(`MU1000 EPROM write to 0x${i.toString(16).padStart(6,"0")}.`);let l=e.eprom.data;f.subarray(4).forEach((h,c)=>{let p=c>>3,d=c&7;if(d===7)for(let b=0;b<7;b++)l[i+7*p+b]+=(h>>6-b&1)<<7;else l[i+7*p+d]=h})}}).add([89,3],(f,o,s)=>{}),this.#x.add([39,48],(f,o,s)=>{}).add([43,0,0],(f,o,s)=>{e.invokeSysExIndicator();let i=[0,0,0,0],l=(h,c)=>{i[c]=h};if(f.subarray(1).forEach((h,c)=>{let p=c+f[0];[l,l,l,l,()=>{this.#k=h*129/16383*100,e.dispatchEvent("mastervolume",e.#k)},()=>h-64,()=>h||128,()=>h,()=>h,()=>{console.debug(`TG300 variation on cc${h}.`)}][p](h,p)}),f[0]<4){let h=0;i.forEach(c=>{h=h<<4,h+=c}),h-=1024,console.debug(`Master tune: ${h}`)}}).add([43,1,0],(f,o,s)=>{e.invokeSysExIndicator()}).add([43,2],(f,o,s)=>{e.invokeSysExIndicator();let i=e.chRedir(f[0],o,!0),l=f[1],h=H[i],c=`TG300 CH${i+1} `;f.subarray(2).forEach((p,d)=>{d<5?([()=>{},()=>{e.setChCc(i,0,p),e.pushChPrimitives(i)},()=>{e.setChCc(i,32,p),e.pushChPrimitives(i)},()=>{e.#f[i]=p,e.pushChPrimitives(i)},()=>{let b=e.chRedir(p,o,!0),g=e.#i[i];e.#i[i]=b,(i!==b||b!==g)&&(e.buildRchTree(),console.info(`${c}receives from CH${b+1}`))}][d+l]||(()=>{}))(p,d+l):d<21||(d<47?([()=>{e.#h[i]=+!p},()=>{},()=>{},()=>{e.#p[k.rpn*i+3]=p,e.#b[k.rpnt*i+2]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{},()=>{e.setChCc(i,7,p)},!1,!1,()=>{e.setChCc(i,10,p||128)},!1,!1,()=>{console.debug(`${c} AC1 at cc${p}`)},()=>{console.debug(`${c} AC2 at cc${p}`)},()=>{e.#e[h+M[128]]=p,e.allocateAce(i,128)},()=>{e.#e[h+M[93]]=p},()=>{e.#e[h+M[91]]=p},()=>{e.#e[h+M[94]]=p},()=>{e.#e[h+M[76]]=p},()=>{e.#e[h+M[77]]=p},()=>{e.#e[h+M[74]]=p},()=>{e.#e[h+M[71]]=p},()=>{e.#e[h+M[73]]=p},()=>{e.#e[h+M[75]]=p},()=>{e.#e[h+M[72]]=p},()=>{e.#e[h+M[78]]=p}][d+l-21]||(()=>{}))(p,d+l):d<95||([()=>{e.#e[h+M[65]]=p},()=>{e.#e[h+M[5]]=p}][d+l-95]||(()=>{}))(p,d+l))})}).add([43,7,0],(f,o,s)=>{let i=f[0];e.setLetterDisplay(f.subarray(1),"TG300 letter display",i)}).add([43,7,1],(f,o,s)=>{e.#a=0,e.#l=Date.now()+3200,f.forEach(function(i,l){let h=l>>4,c=l&15,p=(c*3+h)*7,d=7,b=0;for(p-=c*5,h===2&&(d=2);b<d;)e.#g[p+b]=i>>6-b&1,b++})}),this.#I.add([66,18,0,0,127],(f,o,s)=>{e.switchMode("sc",!0),e.setPortMode(e.getTrackPort(o),2,T.sc),e.#w=e.KARAOKE_NONE,e.#H.fill(0),console.info(`GS system to ${["single","dual"][f[0]]} mode.`)}).add([66,18,64,0],(f,o,s)=>{switch(f[0]){case 127:{e.switchMode("gs",!0),e.setPortMode(e.getTrackPort(o),4,T.gs),e.#w=e.KARAOKE_NONE,e.#H.fill(0),console.info("MIDI reset: GS");break}default:{e.invokeSysExIndicator();let i=[0,0,0,0],l=(h,c)=>{i[c]=h};if(f.subarray(1).forEach((h,c)=>{let p=c+f[0];[l,l,l,l,d=>{this.#k=d*129/16383*100,e.dispatchEvent("mastervolume",e.#k)},d=>{},d=>{}][p](h,c)}),f[0]<4){let h=0;i.forEach(c=>{h=h<<4,h+=c}),h-=1024,console.debug(`Master tune: ${h}`)}}}}).add([66,18,64,1],(f,o,s)=>{e.invokeSysExIndicator();let i=f[0];if(i<16){let l="".padStart(i," ");f.subarray(1).forEach((h,c)=>{l+=String.fromCharCode(Math.max(32,h))}),l=l.padEnd(16," "),console.debug(`GS patch name: ${l}`)}else i<48||(i<65?f.subarray(1).forEach((l,h)=>{let c=`GS ${i+h>55?"chorus":"reverb"} `;([()=>{console.info(`${c}type: ${tt[l]}`),e.setEffectType(0,40,l),e.pushEffectType(0)},()=>{},()=>{},()=>{},()=>{},()=>{},!1,()=>{console.debug(`${c}predelay: ${l}ms`)},()=>{console.info(`${c}type: ${At[l]}`),e.setEffectType(1,40,16+l),e.pushEffectType(1)},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${c}to reverb: ${Z(l)}`)},()=>{console.debug(`${c}to delay: ${Z(l)}`)}][i+h-48]||(()=>{}))()}):i<80?console.debug(`Unknown GS patch address: ${i}`):i<91?f.subarray(1).forEach((l,h)=>{let c="GS delay ";([()=>{console.info(`${c}type: ${Lt[l]}`),e.setEffectType(2,40,32+l),e.pushEffectType(2)},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${c}to reverb: ${Z(l)}`)}][i+h-80]||(()=>{}))()}):console.debug(`Unknown GS patch address: ${i}`))}).add([66,18,64,2],(f,o,s)=>{let i="GS EQ ";f.subarray(1).forEach((l,h)=>{([()=>{console.debug(`${i}low freq: ${[200,400][l]}Hz`)},()=>{console.debug(`${i}low gain: ${l-64}dB`)},()=>{console.debug(`${i}high freq: ${[3e3,6e3][l]}Hz`)},()=>{console.debug(`${i}high gain: ${l-64}dB`)}][f[0]+h]||function(){console.warn(`Unknown GS EQ address: ${f[0]+h}`)})()})}).add([66,18,64,3],(f,o,s)=>{e.invokeSysExIndicator();let i="GS EFX ",l=function(h,c){let p=Rt(e.#R.subarray(10,12),c,h);p&&console.debug(`${i}${at(e.#R.subarray(10,12))} ${p}`)};f.subarray(1).forEach((h,c)=>{([()=>{e.setEffectTypeRaw(3,!1,32+h),e.pushEffectType(3)},()=>{e.setEffectTypeRaw(3,!0,h),console.info(`${i}type: ${at(e.#R.subarray(10,12))}`),e.pushEffectType(3)},!1,l,l,l,l,l,l,l,l,l,l,l,l,l,l,l,l,l,l,l,l,()=>{console.debug(`${i}to reverb: ${Z(h)}dB`)},()=>{console.debug(`${i}to chorus: ${Z(h)}dB`)},()=>{console.debug(`${i}to delay: ${Z(h)}dB`)},!1,()=>{console.debug(`${i}1 source: ${h}`),h&&h<96&&e.allocateAceAll(h)},()=>{console.debug(`${i}1 depth: ${h-64}`)},()=>{console.debug(`${i}2 source: ${h}`),h&&h<96&&e.allocateAceAll(h)},()=>{console.debug(`${i}2 depth: ${h-64}`)},()=>{console.debug(`${i}to EQ: ${h?"ON":"OFF"}`)}][f[0]+c]||function(p,d){console.warn(`Unknown GS EFX address: ${d}`)})(h,f[0]+c)})}).add([66,18,65],(f,o,s)=>{m((f[0]>>4)+1<<1,f[0]&15,f.subarray(1))}).add([66,18,72],(f,o,s)=>{let i=(f[0]&127)<<7|f[1]&127;console.debug(i,It(f.subarray(2)))}).add([69,18,16],(f,o,s)=>{switch(f[0]){case 0:{let i=f[1];e.setLetterDisplay(f.subarray(2),"GS display text",i);break}case 8:{let i=f[1],l=e.modelEx.sc;f.subarray(2).forEach((h,c)=>{([()=>{l.showBar=!(h&1),l.invBar=h>>1&1,l.invDisp=h>>2&1},()=>{l.peakHold=h<4?h:1}][c+i]||(()=>{console.debug("Unsupported GS display type SysEx.")}))()});break}case 32:{e.#l=Date.now()+3200,f[1]===0&&(f[2]?(e.#a=Math.max(Math.min(f[2]-1,9),0),D()&&console.debug(`GS switch display page ${f[2]-1}.`)):(e.#a=0,e.#l=Date.now(),D()&&console.debug("GS disable display page.")));break}default:if(f[0]<6){e.#a>9&&(e.#a=0);let i=f[0]-1<<1|f[1]>>6;e.#a===i&&(e.#l=Date.now()+3200),e.#r[i]?.length||(e.#r[i]=new Uint8Array(256));let l=e.#r[i];D()&&console.debug(`GS frame draw page ${i}.`);let h=f[1]&63;f.subarray(2).forEach(function(p,d){let b=d+h,g=b>>4,w=b&15,v=(w*4+g)*5,$=5,S=0;for(v-=w*4,g===3&&($=1);S<$;)l[v+S]=p>>4-S&1,S++})}else console.warn(`Unknown GS display section: ${f[0]}`)}}).add([69,18,32],(f,o,s)=>{let i=f[0],l=f[1],h=f.subarray(2);if(i>>4){console.warn(`SC-8850 partial screen dump out of bounds: invalid bundle.
`,f);return}let c=l+h.length,p=l*6-(l*2428>>16<<1),d=c*6-(c*2428>>16<<1);if(p>640){console.warn(`SC-8850 partial screen dump out of bounds: invalid buffer range.
`,f);return}d>640&&(console.info(`SC-8850 partial screen dump out of bounds: invalid buffer end, automatically restricted.
`,f),d=640);let b=new Uint8Array(d-p);h.forEach((v,$)=>{let S=$+l,x=(S*2428&65535)*27>>16===26,R=S*6-(S*2428>>16<<1),A=x?2:0;for(;A<6;)b[R+(5-A)]=v>>A&1,A++});let g=i*108+l,w=g*6-(g*2428>>16<<1);e.dispatchEvent("screen",{type:"sc8850",offset:w,data:b}),D()&&console.debug(`SC-8850 screen dump: bundle ${i+1}, range ${p}~${d}`)});let u=function(f,o,s){e.invokeSysExIndicator();let i=f[0],l=H[o],h=ke[o],c=`GS CH${o+1} `;i<3?(f.subarray(1).forEach((p,d)=>{[()=>{e.#e[l+M[0]]=p,e.pushChPrimitives(o)},()=>{e.#f[o]=p},()=>{let b=0;p<16?b=e.chRedir(p,s,!0):b=k.ch;let g=e.#i[o];e.#i[o]=b,(o!==b||b!==g)&&(e.buildRchTree(),console.info(`${c}receives from CH${b+1}`))}][i+d]()}),e.pushChPrimitives(o)):i<19||(i<44?f.subarray(1).forEach((p,d)=>{([()=>{e.#h[o]=+!p},!1,()=>{e.setChType(o,p<<1,T.gs),console.debug(`${c}type: ${p?"drum ":"melodic"}${p||""}`)},()=>{e.#p[h+3]=p,e.#b[k.rpnt*o+2]=1,e.dispatchEvent("pitch",{part:o,pitch:e.getPitchShift(o)})},!1,()=>{e.#e[l+M[7]]=p},!1,!1,()=>{e.#e[l+M[10]]=p||128},!1,!1,()=>{console.debug(`${c}CC 1: cc${p}`)},()=>{console.debug(`${c}CC 2: cc${p}`)},()=>{e.#e[l+M[93]]=p},()=>{e.#e[l+M[91]]=p},!1,!1,()=>{e.#p[h+1]=p,e.#b[k.rpnt*o+1]=1,e.dispatchEvent("pitch",{part:o,pitch:e.getPitchShift(o)})},()=>{e.#p[h+2]=p,e.#b[k.rpnt*o+1]=1,e.dispatchEvent("pitch",{part:o,pitch:e.getPitchShift(o)})},()=>{e.#e[l+M[94]]=p}][i+d-19]||(()=>{}))()}):i<76||console.debug(`Unknown GS part address: ${i}`))},y=function(f,o){let s=f[0],i=`GS CH${o+1} `;s<2?f.subarray(1).forEach((l,h)=>{[()=>{e.setChCc(o,32,l)},()=>{}][s+h]()}):s<32?console.warn(`Unknown GS misc address: ${s}`):s<35?f.subarray(1).forEach((l,h)=>{[()=>{console.debug(`${i}EQ: o${["ff","n"][l]}`)},()=>{},()=>{console.debug(`${i}EFX: o${["ff","n"][l]}`),e.setChEffectSink(o,l?3:0)}][s+h-32]()}):console.warn(`Unknown GS misc address: ${s}`)};this.#I.add([66,18,64,16],(f,o)=>{u(f,e.chRedir(9,o,!0),o)}).add([66,18,64,17],(f,o)=>{u(f,e.chRedir(0,o,!0),o)}).add([66,18,64,18],(f,o)=>{u(f,e.chRedir(1,o,!0),o)}).add([66,18,64,19],(f,o)=>{u(f,e.chRedir(2,o,!0),o)}).add([66,18,64,20],(f,o)=>{u(f,e.chRedir(3,o,!0),o)}).add([66,18,64,21],(f,o)=>{u(f,e.chRedir(4,o,!0),o)}).add([66,18,64,22],(f,o)=>{u(f,e.chRedir(5,o,!0),o)}).add([66,18,64,23],(f,o)=>{u(f,e.chRedir(6,o,!0),o)}).add([66,18,64,24],(f,o)=>{u(f,e.chRedir(7,o,!0),o)}).add([66,18,64,25],(f,o)=>{u(f,e.chRedir(8,o,!0),o)}).add([66,18,64,26],(f,o)=>{u(f,e.chRedir(10,o,!0),o)}).add([66,18,64,27],(f,o)=>{u(f,e.chRedir(11,o,!0),o)}).add([66,18,64,28],(f,o)=>{u(f,e.chRedir(12,o,!0),o)}).add([66,18,64,29],(f,o)=>{u(f,e.chRedir(13,o,!0),o)}).add([66,18,64,30],(f,o)=>{u(f,e.chRedir(14,o,!0),o)}).add([66,18,64,31],(f,o)=>{u(f,e.chRedir(15,o,!0),o)}).add([66,18,64,64],(f,o)=>{y(f,e.chRedir(9,o,!0))}).add([66,18,64,65],(f,o)=>{y(f,e.chRedir(0,o,!0))}).add([66,18,64,66],(f,o)=>{y(f,e.chRedir(1,o,!0))}).add([66,18,64,67],(f,o)=>{y(f,e.chRedir(2,o,!0))}).add([66,18,64,68],(f,o)=>{y(f,e.chRedir(3,o,!0))}).add([66,18,64,69],(f,o)=>{y(f,e.chRedir(4,o,!0))}).add([66,18,64,70],(f,o)=>{y(f,e.chRedir(5,o,!0))}).add([66,18,64,71],(f,o)=>{y(f,e.chRedir(6,o,!0))}).add([66,18,64,72],(f,o)=>{y(f,e.chRedir(7,o,!0))}).add([66,18,64,73],(f,o)=>{y(f,e.chRedir(8,o,!0))}).add([66,18,64,74],(f,o)=>{y(f,e.chRedir(10,o,!0))}).add([66,18,64,75],(f,o)=>{y(f,e.chRedir(11,o,!0))}).add([66,18,64,76],(f,o)=>{y(f,e.chRedir(12,o,!0))}).add([66,18,64,77],(f,o)=>{y(f,e.chRedir(13,o,!0))}).add([66,18,64,78],(f,o)=>{y(f,e.chRedir(14,o,!0))}).add([66,18,64,79],(f,o)=>{y(f,e.chRedir(15,o,!0))}),this.#_.add([54,65],(f,o)=>{let s=e.#y.x5===81?"05rw":"x5d";e.switchMode(s,!0),e.setPortMode(e.getTrackPort(o),1,T[s]);let i=f[f.length-1],l=f.subarray(0,f.length-1),h=Ee(l);h!==i&&(console.info(`X5D multi parameters checksum mismatch! Expected ${h}, got ${i}.`),console.debug(f));let c=(f[1]<<7)+f[0],p=(f[3]<<7)+f[2],d=e.chRedir(c&15,o,!0),b=H[d];[()=>{p<1||(p<101?(e.setChType(d,e.CH_MELODIC,T.x5d),e.#f[d]=p-1,e.#e[b+M[0]]=e.#y.x5):p<229?(e.setChType(d,e.CH_MELODIC,T.x5d),e.#f[d]=p-101,e.#e[b+M[0]]=56):(e.setChType(d,e.CH_DRUMS,T.x5d),e.#f[d]=Ht[p-229]||0,e.#e[b+M[0]]=62)),e.pushChPrimitives(d)},()=>{e.#e[b+M[7]]=p},()=>{p<31&&(e.#e[b+M[10]]=Math.round((p-15)*4.2+64))},()=>{e.#e[b+M[93]]=Ae(p)},()=>{e.#e[b+M[91]]=Ae(p)},()=>{e.#p[d*k.rpn+3]=p>8191?p-16320:64+p,e.#b[k.rpnt*d+2]=1,e.dispatchEvent("pitch",{part:d,pitch:e.getPitchShift(d)})},()=>{e.#p[d*k.rpn+1]=p>8191?p-16320:64+p,e.#b[k.rpnt*d+1]=1,e.dispatchEvent("pitch",{part:d,pitch:e.getPitchShift(d)})},()=>{p>0&&(e.#p[d*k.rpn]=p,e.#b[k.rpnt*d]=1,e.dispatchEvent("pitch",{part:d,pitch:e.getPitchShift(d)}))},()=>{}][c>>4]()}).add([54,76,0],(f,o)=>{e.invokeSysExIndicator();let s=e.#y.x5===81?"05rw":"x5d";e.switchMode(s),e.setPortMode(e.getTrackPort(o),1,T[s]);let i="",l=e.#y.x5,h=0,c=0,p="MSB	PRG	LSB	NME";fe(f,function(d,b){if(b<16400){let g=b%164;switch(!0){case g<10:{d>31&&(i+=String.fromCharCode(d));break}case g===10:break;case g===11:{p+=`
${l}	${h}	${c}	${i.trim().replace("Init Voice","")}`,h++,i="";break}}h>99&&(l=90,h=0)}}),e.userBank.clearRange({msb:e.#y.x5,prg:[0,99],lsb:0}),e.userBank.load(p),D()&&console.debug(p),e.forceVoiceRefresh()}).add([54,77,0],(f,o)=>{e.invokeSysExIndicator();let s=e.#y.x5===81?"05rw":"x5d";e.switchMode(s),e.setPortMode(e.getTrackPort(o),1,T[s]);let i="",l=90,h=0,c=0,p="MSB	PRG	LSB	NME";fe(f,function(d,b){if(b<13600){let g=b%136;switch(!0){case g<10:{d>31&&(i+=String.fromCharCode(d));break}case g===11:{p+=`
${l}	${h}	${c}	${i.trim().replace("Init Combi","")}`,h++,i="";break}}}}),e.userBank.clearRange({msb:90,prg:[0,99],lsb:0}),e.userBank.load(p),D()&&console.debug(p),e.forceVoiceRefresh()}).add([54,78],(f,o)=>{let s=e.#y.x5===81?"05rw":"x5d";e.switchMode(s),e.setPortMode(e.getTrackPort(o),1,T[s]),console.debug(`X5D mode switch requested: ${["combi","combi edit","prog","prog edit","multi","global"][f[0]]} mode.`)}).add([54,85],(f,o)=>{e.invokeSysExIndicator();let s=e.#y.x5===81?"05rw":"x5d";e.switchMode(s),e.setPortMode(e.getTrackPort(o),1,T[s]),fe(f,(i,l)=>{l>0&&l<3&&(e.setEffectType(l-1,44,i),e.pushEffectType(l-1))})}).add([54,104],(f,o)=>{e.invokeSysExIndicator();let s=e.#y.x5===81?"05rw":"x5d";e.switchMode(s,!0);let i=e.getTrackPort(o);if(e.#S[i]&&e.#S[i]!==T[s])if(e.#N.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${o}. Port ${String.fromCharCode(65+i)} mode "${G[e.#S[i]]}" mismatch, should be "${s}".`);return}else console.info(`Track ${o} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+i)}.`);e.setPortMode(i,1,T[s]),fe(f,function(l,h,c,p){if(h<192){let d=e.chRedir(Math.floor(h/12),o,!0),b=H[d];switch(h%12){case 0:{l<128?(e.setChType(d,e.CH_MELODIC,T.x5d),e.#e[b+M[0]]=e.#y.x5,e.#f[d]=l):(e.setChType(d,e.CH_DRUMS,T.x5d),e.#e[b+M[0]]=62,e.#f[d]=Ht[l-128]),l>0&&e.setChActive(d,1),e.pushChPrimitives(d);break}case 1:{e.#e[b+M[7]]=l;break}case 2:{e.#p[d*k.rpn+3]=l>127?l-192:64+l,e.#b[k.rpnt*d+2]=1,e.dispatchEvent("pitch",{part:d,pitch:e.getPitchShift(d)});break}case 3:{e.#p[d*k.rpn+1]=l>127?l-192:64+l,e.#b[k.rpnt*d+1]=1,e.dispatchEvent("pitch",{part:d,pitch:e.getPitchShift(d)});break}case 4:{l<31&&(e.#e[b+M[10]]=Math.round((l-15)*4.2+64));break}case 5:{let g=l>>4,w=l&15;e.#e[b+M[91]]=Ae(w),e.#e[b+M[93]]=Ae(g);break}case 10:{e.#n[d]||(e.#e[b+M[0]]=l>>6?56:e.#y.x5,e.pushChPrimitives(d));break}case 11:{let g=e.chRedir(l&15,o,!0),w=l>>4;e.#i[d]=l,(g!==d||w)&&console.info(`X5D Part CH${d+1} receives from CH${g+1}.`)}}}else{let d=e.chRedir(h-192,o,!0)}}),e.buildRchTree()}),this.#I.add([22,18,127],(f,o,s)=>{e.switchMode("mt32",!0),e.setPortMode(e.getTrackPort(o),1,T.mt32),e.#w=e.KARAOKE_NONE,e.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),console.info("MIDI reset: MT-32")}).add([22,18,0],(f,o,s)=>{e.switchMode("mt32");let i=e.chRedir(s,o,!0),l=f[1];f.subarray(2).forEach((h,c)=>{let p=c+l;e.#F[p+(i-1)*16]=h,([!1,()=>{let d=e.#F[i-1<<4];if(d<3){if(e.#D[i]=1,d===2)for(let b=0;b<name.length;b++)e.#O[(i-1)*k.cmt+b]=e.#G[h*k.cmt+b];else{let b=e.baseBank.get(0,h+(d<<6),127,"mt32").name;for(let g=0;g<b.length;g++)e.#O[(i-1)*k.cmt+g]=b.charCodeAt(g)}e.pushChPrimitives(i)}},()=>{e.#p[i*k.rpn+3]=h+40,e.#b[k.rpnt*i+2]=1},()=>{e.#p[i*k.rpn+1]=h+14,e.#b[k.rpnt*i+1]=1},()=>{e.#p[i*k.rpn]=h,e.#b[k.rpnt*i]=1},!1,()=>{e.setChCc(i,91,h?127:0)},!1,()=>{e.setChCc(i,7,h)},()=>{e.setChCc(i,10,Math.ceil(h*9.05))}][p]||(()=>{}))()})}).add([22,18,1],(f,o,s)=>{e.switchMode("mt32");let i=s&7;console.debug(`MT-32 slot #${s+1} Drum: ${f}`);let l=f[0]<<7|f[1];f.subarray(2).forEach((h,c)=>{let p=c+l,d=(p>>2)+24,b=p&3,g=i*k.dpn;if(D()&&console.debug(`MT-32 temp drum note ${d} param ${b}: ${h}`),d<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${d}`);return}[()=>{},()=>{e.#A[(g+j[26])*k.dnc+d]=Math.round(h*1.27)},()=>{e.#A[(g+j[26])*k.dnc+d]=h*9+1&127},()=>{e.#A[(g+j[26])*k.dnc+d]=h?127:0}][b]()})}).add([22,18,2],(f,o,s)=>{e.switchMode("mt32");let i=e.chRedir(s,o,!0),l=f[1]+(f[0]<<7);l<10&&(e.#D[i]=1),f.subarray(2).forEach((h,c)=>{let p=c+l;p<14&&(e.#O[(i-1)*k.cmt+p]=h)}),e.pushChPrimitives(i)}).add([22,18,3],(f,o,s)=>{e.switchMode("mt32");let i=s&7;if(f[0]){let l=(f[0]-1<<7)+f[1]-16;f.subarray(2).forEach((h,c)=>{let p=c+l,d=(p>>2)+24,b=p&3,g=i*k.dpn;if(D()&&console.debug(`MT-32 dev drum note ${d} param ${b}: ${h}`),d<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${d}`);return}[()=>{},()=>{e.#A[(g+j[26])*k.dnc+d]=Math.round(h*1.27)},()=>{e.#A[(g+j[26])*k.dnc+d]=h*9+1&127},()=>{e.#A[(g+j[26])*k.dnc+d]=h?127:0}][b]()})}else{let l=f[1];f.subarray(2).forEach((h,c)=>{let p=c+l;e.#F[p]=h;let d=e.chRedir(1+(p>>4),o,!0),b=p&15;([!1,()=>{let g=e.#F[d-1<<4];if(g<3)if(e.#D[d]=1,g===2)for(let w=0;w<name.length;w++)e.#O[(d-1)*k.cmt+w]=e.#G[h*k.cmt+w];else{let w=e.baseBank.get(0,h+(g<<6),127,"mt32").name;for(let v=0;v<w.length;v++)e.#O[(d-1)*k.cmt+v]=w.charCodeAt(v)}e.pushChPrimitives(d)},()=>{e.#p[d*k.rpn+3]=h+40,e.#b[k.rpnt*d+2]=1},()=>{e.#p[d*k.rpn+1]=h+14,e.#b[k.rpnt*d+1]=1},()=>{e.#p[d*k.rpn]=h,e.#b[k.rpnt*d]=1},!1,()=>{e.setChCc(d,91,h?127:0)},!1,()=>{e.setChCc(d,7,h)},()=>{e.setChCc(d,10,Math.ceil(h*9.05))}][b]||(()=>{}))()})}}).add([22,18,4],(f,o,s)=>{e.switchMode("mt32");let i=f[1]+(f[0]<<7),l=[];f.subarray(2).forEach((h,c)=>{let p=c+i,d=e.chRedir(Math.floor(p/246+1),o,!0),b=p%246;b<14&&(e.#O[(d-1)*k.cmt+b]=h),b<10&&(e.#D[d]=1),l.indexOf(d)<0&&l.push(d)}),l.forEach(h=>{e.pushChPrimitives(h)})}).add([22,18,5],(f,o,s)=>{e.switchMode("mt32");let i=(f[0]<<7)+f[1];f.subarray(2).forEach((l,h)=>{let c=i+h,p=Math.floor(c/8),d=c&7,b=p*8;e.#le[c]=l,([!1,()=>{let g=e.#le[b];if(g<3){let w="";if(g===2){let $=k.cmt*p;w=`MT-m:${l.toString().padStart(3,"0")}`}else w=e.baseBank.get(0,l+(g<<6),127,"mt32").name;e.userBank.clearRange({msb:0,lsb:127,prg:p});let v=`MSB	LSB	PRG	NME
49	127	${p}	${w}`;e.userBank.load(v,!0)}}][d]||(()=>{}))()}),e.forceVoiceRefresh()}).add([22,18,8],(f,o,s)=>{e.switchMode("mt32");let i=((f[0]&1)<<7)+f[1],l=f[0]>>1,h=!1;if(f.subarray(2).forEach((c,p)=>{let d=i+p;d<k.cmt&&(e.#G[l*k.cmt+d]=c,h=!0)}),h){e.userBank.clearRange({msb:0,lsb:127,prg:l});let c=`MSB	LSB	PRG	NME
49	127	${l}	MT-m:${l}`;e.userBank.load(c,!0)}e.forceVoiceRefresh()}).add([22,18,16],(f,o,s)=>{e.switchMode("mt32");let i=f[1],l=!1,h=function(c,p){e.#i[p-12]=c,l=!0};f.subarray(2).forEach((c,p)=>{let d=p+i;([!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,h,h,h,h,h,h,h,h,h,()=>{e.#k=c,e.dispatchEvent("mastervolume",e.#k)}][d]||(()=>{}))(c,p)}),l&&e.buildRchTree()}).add([22,18,32],(f,o,s)=>{e.switchMode("mt32");let i=f[1],l=" ".repeat(i);f.subarray(2).forEach(h=>{h>31?l+=String.fromCharCode(h):l+=" "}),e.#V=l.padStart(20," "),e.#K=Date.now()+3200}).add([22,18,82],(f,o)=>{let s=e.chRedir(0,o,!0);for(let i=0;i<16;i++)e.#T.ano(s+i),i&&i<10&&(e.#f[s+i]=ft[i-1]);console.info("MT-32 alt reset complete.")}),this.#_.add([66,0],(f,o)=>{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(o),2,T.ns5r),e.#w=e.KARAOKE_NONE,console.debug(`NS5R mode switch requested: ${["global","multi","prog edit","comb edit","drum edit","effect edit"][f[0]]} mode.`)}).add([66,1],(f,o)=>{let s=["ns5r","05rw"][f[0]];e.switchMode(s,!0),e.setPortMode(e.getTrackPort(o),2,T[s]),e.#w=e.KARAOKE_NONE}).add([66,18,0,0],(f,o)=>{let s=f[0];switch(s){case 124:case 126:case 127:{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(o),2,T.ns5r),e.#w=e.KARAOKE_NONE;break}case 125:{e.initDrums(),console.info(`NS5R drum setup reset on drum kit ${f[1]}.`);break}default:if(s<10){let i=[0,0,0,0],l=(h,c)=>{i[c]=h};if(f.subarray(1).forEach((h,c)=>{[l,l,l,l,()=>{e.#k=h*129/16383*100,e.dispatchEvent("mastervolume",e.#k)},()=>h-64,()=>h-64,()=>{},()=>{},()=>{}][s+c]()}),f[0]<4){let h=0;i.forEach(c=>{h=h<<4,h+=c}),h-=1024,console.debug(`Master tune: ${h}`)}}}}).add([66,18,0,1],(f,o)=>{}).add([66,18,0,2],(f,o)=>{}).add([66,18,1],(f,o)=>{e.invokeSysExIndicator();let s=e.chRedir(f[0],o,!0),i=H[s],l=f[1],h=`NS5R CH${s+1} `;f.subarray(2).forEach((c,p)=>{let d=l+p;d<3?([()=>{e.#e[i+M[0]]=c||ie.bank0,e.pushChPrimitives(s)},()=>{e.#e[i+M[32]]=c,e.pushChPrimitives(s)},()=>{e.#f[s]=c}][d](),e.pushChPrimitives(s)):d<8||(d<14?[()=>{let b=e.chRedir(c,o,!0),g=e.#i[s];e.#i[s]=b,(s!==b||b!==g)&&(e.buildRchTree(),console.info(`${h}receives from CH${b+1}`))},()=>{e.#h[s]=+!c},()=>{e.setChType(s,c,T.ns5r),console.debug(`${h}type: ${Pe[c]}`)},()=>{e.#p[k.rpn*s+3]=c,e.#b[k.rpnt*s+2]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},()=>{},()=>{}][d-8]():d<16||(d<33?[()=>{e.#e[i+M[7]]=c},()=>{e.#e[i+M[11]]=c},()=>{},()=>{},()=>{e.#e[i+M[10]]=c||128},()=>{},()=>{},()=>{e.#e[i+M[93]]=c},()=>{e.#e[i+M[91]]=c},()=>{e.#e[i+M[76]]=c},()=>{e.#e[i+M[77]]=c},()=>{e.#e[i+M[78]]=c},()=>{e.#e[i+M[74]]=c},()=>{e.#e[i+M[71]]=c},()=>{e.#e[i+M[73]]=c},()=>{e.#e[i+M[75]]=c},()=>{e.#e[i+M[72]]=c}][d-16]():d<112||d<114&&[()=>{e.#e[i+M[5]]=c},()=>{e.#e[i+M[65]]=c}][d-112]()))})}).add([66,18,8,0],(f,o)=>{let s=f[0];if(s<32)e.setLetterDisplay(f.subarray(1,33),"NS5R letter display");else{let i=s-32;e.#l=Date.now()+3200,e.#a=10;let l=f.subarray(1),h=4;l.forEach(function(c,p){let d=p+i,b=d>>4,g=d&15;if(d<80){let w=b<h?c:c>>3,v=0,$=b<h?6:3;for(;w>0;)e.#g[g*32+b*7+($-v)]=w&1,w=w>>1,v++}})}}).add([66,18,48],(f,o,s)=>{n(0,f)}).add([66,18,49],(f,o,s)=>{n(1,f)}).add([66,18,50],(f,o,s)=>{n(2,f)}).add([66,18,51],(f,o,s)=>{n(3,f)}).add([66,18,52],(f,o,s)=>{n(4,f)}).add([66,18,53],(f,o,s)=>{n(5,f)}).add([66,18,54],(f,o,s)=>{n(6,f)}).add([66,18,55],(f,o,s)=>{n(7,f)}).add([66,52],(f,o)=>{e.switchMode("ns5r"),e.#w=e.KARAOKE_NONE;let s="";fe(f,(i,l)=>{l<8?(i>31&&(s+=String.fromCharCode(i)),l===7&&(e.aiEfxName=s)):l<10&&(e.setEffectType(l-8,44,i),e.pushEffectType(l-8))})}).add([66,53],(f,o)=>{e.invokeSysExIndicator(),e.switchMode("ns5r"),e.#w=e.KARAOKE_NONE;let s="",i=f[f.length-1],l=f.subarray(0,f.length-1),h=Ee(l);h!==i&&(console.info(`NS5R current multi dump checksum mismatch! Expected ${h}, got ${i}.`),console.debug(f));let c=e.getTrackPort(o);if(e.#S[c]&&e.#S[c]!==T.ns5r)if(e.#N.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${o}. Port ${String.fromCharCode(65+c)} mode "${G[e.#S[c]]}" mismatch, should be "ns5r".`);return}else console.info(`Track ${o} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+c)}.`);e.setPortMode(c,2,T.ns5r),fe(l,function(p,d){switch(!0){case d<2944:{let b=e.chRedir(Math.floor(d/92),o,!0),g=H[b];switch(d%92){case 0:{e.#e[g+M[0]]=p,e.pushChPrimitives(b),e.pushChPrimitives(b);break}case 1:{e.#e[g+M[32]]=p,!p&&!e.#e[g+M[0]]&&(e.#e[g+M[0]]=ie.bank0),e.pushChPrimitives(b);break}case 2:{e.#f[b]=p,p>0&&e.setChActive(b,1);break}case 3:{let w=e.chRedir(p,o,!0);e.#i[b]=w,b!==w&&console.info(`NS5R CH${b+1} receives from CH${w+1}.`);break}case 7:{e.#n[b]=p,e.pushChPrimitives(b);break}case 8:{e.#p[b*k.rpn+3]=p<40||p>88?p+(p>63?-192:64):p,e.#b[k.rpnt*b+2]=1,e.dispatchEvent("pitch",{part:b,pitch:e.getPitchShift(b)});break}case 9:case 10:{e.#e[g+M[7]]=p;break}case 11:{e.#e[g+M[11]]=p;break}case 14:{e.#e[g+M[10]]=p||128;break}case 19:{e.#e[g+M[93]]=p;break}case 20:{e.#e[g+M[91]]=p;break}case 84:{e.#e[g+M[65]]=p;break}case 85:{e.#e[g+M[5]]=p;break}}break}case d<3096:break;case d<3134:{let b=d-3096;b<8?(p>31&&(s+=String.fromCharCode(p)),b===7&&(e.aiEfxName=s)):b<10&&(e.setEffectType(b-8,44,p),e.pushEffectType(b-8));break}case d<8566:break}}),e.buildRchTree()}).add([66,54],(f,o)=>{e.invokeSysExIndicator(),e.switchMode("ns5r");let s="",i=80,l=0,h=0,c="MSB	PRG	LSB	NME";fe(f,function(p,d){let b=d%158;switch(!0){case b<10:{p>31&&(s+=String.fromCharCode(p));break}case b===10:break;case b===11:{i=p&127;break}case b===12:{h=p&127;break}case b===13:{c+=`
${i}	${l}	${h}	${s.trim().replace("Init Voice","")}`,l++,s="";break}}}),e.userBank.clearRange({msb:80,lsb:0}),e.userBank.load(c),D()&&console.debug(c),e.forceVoiceRefresh()}).add([66,55],(f,o)=>{e.invokeSysExIndicator(),e.switchMode("ns5r");let s="",i=88,l=0,h=0,c="MSB	PRG	LSB	NME";fe(f,function(p,d){let b=d%126;switch(!0){case b<10:{p>31&&(s+=String.fromCharCode(p));break}case b===11:break;case b===12:break;case b===13:{c+=`
${i}	${l}	${h}	${s.trim().replace("Init Combi","")}`,l++,s="";break}}}),e.userBank.clearRange({msb:88,lsb:0}),e.userBank.load(c),D()&&console.debug(c),e.forceVoiceRefresh()}).add([66,125],(f,o,s)=>{e.dispatchEvent("backlight",["green","orange","red",!1,"yellow","blue","purple"][f[0]]||"white")}).add([66,127],(f,o,s)=>{let i=f[f.length-1],l=f.subarray(0,f.length-1),h=Ee(l);h!==i&&(console.info(`NS5R screen dump checksum mismatch! Expected ${h}, got ${i}.`),console.debug(f));let c=new Uint8Array(5760);fe(f,(p,d,b)=>{if(d<720)for(let g=0;g<8;g++)c[d*8+g]=p>>7-g&1}),e.dispatchEvent("screen",{type:"ns5r",data:c})}).add([76],(f,o,s)=>{e.#_.run([66,...f],o,s)}),e.#ae.add([16,0,8,0],(f,o,s)=>{let i=(f[2]<<4)+f[3],l="K11 ";([()=>{e.switchMode("k11",!0),e.setPortMode(e.getTrackPort(o),2,T.k11),e.#w=e.KARAOKE_NONE,e.#M[T.k11][1]=i?4:0,console.info("MIDI reset: GMega/K11")},()=>{e.setEffectType(0,24,i),console.debug(`${l}reverb type: ${i}`),e.pushEffectType(0)},()=>{console.debug(`${l}reverb time: ${i}`)},()=>{console.debug(`${l}reverb time: ${i}`)},()=>{console.debug(`${l}reverb predelay: ${i}`)},()=>{console.debug(`${l}reverb predelay: ${i}`)},()=>{console.debug(`${l}depth high: ${i}`)},()=>{console.debug(`${l}depth high: ${i}`)},()=>{console.debug(`${l}depth low: ${i}`)},()=>{console.debug(`${l}depth low: ${i}`)}][f[0]]||(()=>{}))()}).add([16,0,8,1],(f,o,s)=>{e.invokeSysExIndicator();let i=e.chRedir(f[1],o,!0),l=H[i],h=ke[i],c=(f[3]<<4)+f[4],p=`GMega CH${i+1} `;([()=>{c<128?(e.setChType(i,e.CH_MELODIC,T.k11),e.#e[l+M[0]]=0,e.#f[i]=c):(e.setChType(i,e.CH_DRUMS,T.k11),e.#f[i]=c-128),e.pushChPrimitives(i)},()=>{let d=e.chRedir(c,o,!0),b=e.#i[i];e.#i[i]=d,(i!==d||d!==b)&&(e.buildRchTree(),console.info(`${p}receives from CH${d+1}`))},()=>{e.#e[l+M[7]]=c},()=>{uupThis.setChActive(i,c)},()=>{e.#e[l+M[10]]=c},()=>{e.#p[h+3]=c+40,e.#b[k.rpnt*i+2]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{e.#p[h+1]=c>>1,e.#p[h+2]=c&1,e.#b[k.rpnt*i+1]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{e.#e[l+M[91]]=c?127:0},()=>{},()=>{e.#e[l+M[74]]=c},()=>{e.#e[l+M[73]]=c},()=>{e.#e[l+M[72]]=c}][f[0]]||(()=>{}))()}).add([16,0,9,0],(f,o,s)=>{e.invokeSysExIndicator();let i=(f[2]<<4)+f[3],l="GMLX ";([()=>{console.debug(`${l}reverb type: ${i}`)},()=>{console.debug(`${l}reverb time: ${i}`)},()=>{console.debug(`${l}reverb predelay: ${i}`)},()=>{console.debug(`${l}depth high: ${i}`)},()=>{console.debug(`${l}depth low: ${i}`)}][f[0]]||(()=>{}))()}).add([16,0,9,3],(f,o,s)=>{e.invokeSysExIndicator();let i=(f[2]<<4)+f[3],l=e.chRedir(f[1],o,!0),h=H[l],c=`GMLX CH${l+1} `;[()=>{i<128?(e.setChType(l,e.CH_MELODIC,T.k11),e.#e[h+M[0]]=0,e.#e[h+M[32]]=0,e.#f[l]=i):i<160?(e.setChType(l,e.CH_MELODIC,T.k11),e.#e[h+M[0]]=0,e.#e[h+M[32]]=7,e.#f[l]=i-100):(e.setChType(l,e.CH_DRUMS,T.k11),e.#e[h+M[0]]=122,e.#e[h+M[32]]=0,e.#f[l]=i-160),e.pushChPrimitives(l)},()=>{let p=e.chRedir(i,o,!0),d=e.#i[l];e.#i[l]=p,(l!==p||p!==d)&&(e.buildRchTree(),console.info(`${c}receives from CH${p+1}`))}][f[0]]()}).add([16,0,9,4],(f,o,s)=>{e.invokeSysExIndicator();let i=(f[2]<<4)+f[3],l=e.chRedir(f[1],o,!0),h=H[l],c=ke[l];[()=>{e.setChActive(l,i)},()=>{e.#e[h+M[7]]=i},()=>{e.#e[h+M[10]]=i},()=>{e.#e[h+M[91]]=i?127:0},()=>{e.#p[c+3]=i+40,e.#b[k.rpnt*l+2]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)})},()=>{e.#p[c+1]=i,e.#b[k.rpnt*l+1]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)})},()=>{e.#p[c]=i,e.#b[k.rpnt*l]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)})},()=>{}][f[0]]()}),this.#fe.add([66,93,64],(f,o,s)=>{let i=f[2];switch(f[0]){case 0:{switch(f[1]){case 4:{e.invokeSysExIndicator(),e.#k=i*129/16383*100,e.dispatchEvent("mastervolume",e.#k);break}case 5:{e.invokeSysExIndicator(),i-64;break}case 6:{e.invokeSysExIndicator(),console.debug(`SG global reverb: ${i?"on":"off"}`);break}case 127:{e.switchMode("sg",!0),e.setPortMode(e.getTrackPort(o),1,T.sg);break}}break}case 1:{switch(f[1]){case 48:{e.invokeSysExIndicator(),console.debug(`SG reverb type: ${tt[i]}`);break}}break}default:if(f[0]>>4===1){e.invokeSysExIndicator();let l=e.chRedir(f[0]&15,o,!0);if(f[1]===2){let h=e.chRedir(i,o,!0),c=e.#i[l];e.#i[l]=h,(l!==h||h!==c)&&(e.buildRchTree(),console.info(`SG CH${l+1} receives from CH${h+1}`))}else f[1]===19&&e.setChCc(l,7,i)}else console.warn(`Unknown AKAI SG SysEx: ${f}`)}}),this.#re.add([9],(f,o,s)=>{e.invokeSysExIndicator(),console.debug(`GZ set effect: ${["stage reverb","hall reverb","room reverb","chorus","tremolo","phaser","rotary speaker","enhancer","flanger","EQ"][f[0]]||"off"}`)}),this.#x.add([127,0],(f,o,s)=>{e.switchMode("motif");let i=new Uint8Array([127,1,...f]);e.#x.run(i,o,s)}).add([127,1,0,0],(f,o,s)=>{e.switchMode("s90es");let i="S90/Motif ES system ",l=f[0];f.subarray(1).forEach((h,c)=>{([()=>{e.#k=h*12900/16383,e.dispatchEvent("mastervolume",e.#k)}][l+c]||(()=>{console.info(`Unrecognized ${i}ID: ${l+c}`)}))()})}).add([127,1,14],(f,o,s)=>{e.switchMode("s90es");let i="S90/Motif ES bulk header ",l=[];l[95]=(h,c,p)=>{console.debug(`${i}multi edit buffer: ${h[1]}`)},(l[f[0]]||(()=>{console.info(`Unrecognized ${i}ID: ${f[0]}.`)}))(f.subarray(1))}).add([127,1,15],(f,o,s)=>{e.switchMode("s90es");let i="S90/Motif ES bulk footer ",l=[];l[95]=(h,c,p)=>{console.debug(`${i}multi edit buffer: ${h[1]}`)},(l[f[0]]||(()=>{console.info(`Unrecognized ${i}ID: ${f[0]}.`)}))(f.subarray(1))}).add([127,1,54,1],(f,o,s)=>{e.switchMode("s90es");let i="S90/Motif ES reverb ",l=f[0];f.subarray(1).forEach((h,c)=>{([()=>{e.setEffectTypeRaw(0,!1,h&15|128)},()=>{e.setEffectTypeRaw(0,!0,h)}][l+c]||(()=>{}))()}),e.pushEffectType(0)}).add([127,1,54,2],(f,o,s)=>{e.switchMode("s90es");let i="S90/Motif ES chorus ",l=f[0];f.subarray(1).forEach((h,c)=>{([()=>{e.setEffectTypeRaw(1,!1,h&15|128)},()=>{e.setEffectTypeRaw(1,!0,h)}][l+c]||(()=>{}))()}),e.pushEffectType(1)}).add([127,1,54,3],(f,o,s)=>{e.switchMode("s90es");let i="S90/Motif ES insert 1 ",l=f[0];f.subarray(1).forEach((h,c)=>{([()=>{e.setEffectTypeRaw(3,!1,h&15|128)},()=>{e.setEffectTypeRaw(3,!0,h)}][l+c]||(()=>{}))()}),e.pushEffectType(3)}).add([127,1,54,4],(f,o,s)=>{e.switchMode("s90es");let i="S90/Motif ES insert 2 ",l=f[0];f.subarray(1).forEach((h,c)=>{([()=>{e.setEffectTypeRaw(4,!1,h&15|128)},()=>{e.setEffectTypeRaw(4,!0,h)}][l+c]||(()=>{}))()}),e.pushEffectType(4)}).add([127,1,54,16],(f,o,s)=>{e.switchMode("s90es");let i=f[0];f.subarray(1).forEach((l,h)=>{let p=`S90/Motif ES EQ${(h>>2)+1} `;([()=>{let d=l-64},()=>{let d=Ce[l]},()=>{let d=l/10},()=>{let d=l}][i+h&3]||(()=>{}))()})}).add([127,1,54,17],(f,o,s)=>{e.switchMode("s90es");let i="S90/Motif ES variation ",l=f[0];f.subarray(1).forEach((h,c)=>{([()=>{e.setEffectTypeRaw(2,!1,h&15|128)},()=>{e.setEffectTypeRaw(2,!0,h)}][l+c]||(()=>{}))()}),e.pushEffectType(2)}).add([127,1,55],(f,o,s)=>{e.invokeSysExIndicator(),e.switchMode("s90es");let i=e.getTrackPort(o);if(e.#S[i]&&e.#S[i]!==e.#y.smotif)if(e.#N.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${o}. Port ${String.fromCharCode(65+i)} mode "${G[e.#S[i]]}" mismatch, should be "${G[e.#y.smotif]}".`);return}else console.info(`Track ${o} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+i)}.`);let l=e.chRedir(f[0],o,!0),h=H[l],c=f[1];f[0]>15&&(l=f[0]+32);let p=`Track ${o} S90/Motif ES bulk CH${l<128?l+1:"U"+(l-127)} `;console.debug(p,f),!(f[0]>15)&&f.subarray(2).forEach((d,b)=>{([()=>{e.setChCc(l,0,d),e.pushChPrimitives(l)},()=>{d&&e.setChActive(l,1),e.setChCc(l,32,d),e.getChPrimitive(l,1)===63&&e.setChType(l,[32,40].indexOf(d)>-1?e.CH_DRUMS:e.CH_MELODIC,e.#t,!0),e.pushChPrimitives(l)},()=>{d&&e.setChActive(l,1),e.#f[l]=d,e.pushChPrimitives(l)},()=>{let g=e.chRedir(d,o,!0),w=e.#i[l];e.#i[l]=g,(l!==g||g!==w)&&(e.buildRchTree(),console.info(`${p}receives from CH${g+1}`))},()=>{e.#h[l]=d?0:1},!1,!1,!1,!1,!1,!1,!1,!1,()=>{d!==100&&e.setChActive(l,1),e.#e[h+M[7]]=d},()=>{d!==64&&e.setChActive(l,1),e.#e[h+M[10]]=d},!1,!1,!1,()=>{e.#e[h+M[91]]=d},()=>{d&&e.setChActive(l,1),e.#e[h+M[93]]=d},()=>{d&&e.setChActive(l,1),e.#e[h+M[94]]=d},()=>{e.setChCc(l,128,d),d!==127&&(e.setChActive(l,1),e.allocateAce(l,128))},()=>{},()=>{d!==64&&e.setChActive(l,1),e.#e[h+M[74]]=d},()=>{d!==64&&e.setChActive(l,1),e.#e[h+M[71]]=d},!1,()=>{e.#e[h+M[65]]=d},()=>{e.#e[h+M[5]]=d},()=>{}][c+b]||(()=>{}))()})}),e.#x.add([100,14],(f,o,s)=>{e.switchMode("cs6x"),e.setPortMode(e.getTrackPort(o),1,T.cs6x);let i=["normal voice","plugin voice PLG","drums",,"performance",,"phrase clip"][f[0]>>4]??"invalid";f[0]&!0?i+=" edit buffer":f[0]>>4==1?i+=`${(f[0]&1)+1}`:i+=` ${["INT","EXT"][f[0]&1]}`,console.debug(`CS6x bulk dump for ${i} started.`)}).add([100,15],(f,o,s)=>{e.switchMode("cs6x");let i=["normal voice","plugin voice PLG","drums",,"performance",,"phrase clip"][f[0]>>4]??"invalid";f[0]&!0?i+=" edit buffer":f[0]>>4==1?i+=`${(f[0]&1)+1}`:i+=` ${["INT","EXT"][f[0]&1]}`,console.debug(`CS6x bulk dump for ${i} ended.`)}).add([100,76,112],(f,o,s)=>{e.switchMode("cs6x");let i=0,l=f[0];f.subarray(1).forEach((h,c)=>{let p=c+l;p<10?(e.setChCvnRegister(i,c,h&127),e.#D[i]=1):p<12||p<13&&console.debug(`Plugin voice type: ${h}`)}),e.pushChPrimitives(i)}).add([100,76,0],(f,o,s)=>{e.switchMode("cs6x"),e.setPortMode(e.getTrackPort(o),1,T.cs6x);let i=0,l=f[0];f.subarray(1).forEach((h,c)=>{let p=c+l;([()=>{e.setChCc(i,7,h),h!==100&&e.setChActive(i,1)},,,()=>{e.#h[i]=h==0,e.setChCc(i,64,0),e.#T.ano(i),e.resetChAceAll(i)},,()=>{},,,()=>{e.setChCc(i,65,h?127:0)},()=>{e.setChCc(i,5,h)},,()=>{e.setChCc(i,91,h),h!==40&&e.setChActive(i,1)},()=>{e.setChCc(i,93,h),h&&e.setChActive(i,1)}][p]||(()=>{}))()})}).add([100,76,1],(f,o,s)=>{e.switchMode("cs6x");let i=0,l=f[0],h=!1;f.subarray(1).forEach((c,p)=>{let d=p+l;([()=>{e.setEffectTypeRaw(0,!1,c&15|128),h=!0},()=>{e.setEffectTypeRaw(0,!0,c),h=!0}][d]||(()=>{}))()}),h&&e.pushEffectType(0)}).add([100,76,2],(f,o,s)=>{e.switchMode("cs6x");let i=0,l=f[0],h=!1;f.subarray(1).forEach((c,p)=>{let d=p+l;([()=>{e.setEffectTypeRaw(1,!1,c&15|128),h=!0},()=>{e.setEffectTypeRaw(1,!0,c),h=!0}][d]||(()=>{}))()}),h&&e.pushEffectType(1)}).add([100,76,3],(f,o,s)=>{e.switchMode("cs6x");let i=0,l=f[0],h=!1;f.subarray(1).forEach((c,p)=>{let d=p+l;([()=>{e.setEffectTypeRaw(2,!1,c&15|128),h=!0},()=>{e.setEffectTypeRaw(2,!0,c),h=!0}][d]||(()=>{}))()}),h&&e.pushEffectType(2)}).add([100,76,5],(f,o,s)=>{e.switchMode("cs6x")}).add([100,76,16],(f,o,s)=>{e.switchMode("cs6x");let i=0,l=f[0],h=!1;if(f.subarray(1).forEach((c,p)=>{let d=p+l;([()=>{e.setChCc(i,0,c),h=!0},()=>{e.setChCc(i,32,c),h=!0,c&&e.setChActive(i,1)},()=>{e.#f[i]=c,h=!0,c&&e.setChActive(i,1)},()=>{e.#b[ke[i]+Xe[2]]=1,e.#p[ke[i]+Xe[2]]=c,c&&e.setChActive(i,1)}][d]||(()=>{}))()}),h){switch(e.pushChPrimitives(i),e.getChVoice(i).standard){case"DX":{e.#C[i]=e.EXT_DX;break}case"VL":{e.#C[i]=e.EXT_VL;break}}e.dispatchEvent("metacommit",{type:"OSysMeta",msg:"part.rename",data:{part:i}})}}).add([100,76,32],(f,o,s)=>{e.switchMode("cs6x");let i=0,l=f[0],h=e.#C[i];switch(h){case e.EXT_DX:{f.length>2&&console.debug(f),f.subarray(1).forEach((c,p)=>{let d=p+l;if(d<6){let b=d+142;e.setChCc(i,b,c),c!==64&&e.allocateAce(i,b)}else if(d<12){let b=d+144;e.setChCc(i,b,c),c!==64&&e.allocateAce(i,b)}else([()=>{},()=>{},()=>{},()=>{}][d]||(()=>{}))()});break}case e.EXT_VL:{console.info(`Support for Modular System Plug-in writes is not yet present for plugin type ${h}.`);break}default:console.warn(`Unsupported plug-in type: ${h}`)}}),this.#I.add([0,72,18,0,0,0,0],(f,o,s)=>{e.switchMode("sd",!0),e.setPortMode(e.getTrackPort(o),2,T.sd),console.info("MIDI reset: SD")}).add([0,72,18,16,0],(f,o,s)=>{e.invokeSysExIndicator();let i=f[0]>>5,l=f[0]&31;switch(i){case 0:{let h=f[0]>>1,c=f[1];switch(h){case 1:{f.subarray(2).forEach((p,d,b)=>{let g=d+c;switch(g){case 0:{p&&(e.setEffectType(1,60,p-1),e.pushEffectType(1),console.debug(`SD MFX Cho: ${g} - ${p}`));break}}});break}case 2:{f.subarray(2).forEach((p,d)=>{let b=d+c;switch(b){case 0:{p&&(e.setEffectType(0,55+p,0),e.pushEffectType(0),console.debug(`SD MFX Rev: ${b} - ${p}`));break}}});break}case 3:case 4:case 5:{let p=h-1;f.subarray(2).forEach((d,b)=>{let g=b+c;switch(console.debug(`SD MFX ${p-2}: ${g} - ${d}`),g){case 0:{e.setEffectTypeRaw(p,62,d),e.pushEffectType(p);break}}}),console.debug(`SD MFX message:
%o`,f);break}default:console.debug(`Unknown SD-90 global effects message:
%o`,f)}break}case 1:{let h=e.chRedir(l,o,!0),c=f[1],p=H[h];f.subarray(2).forEach((d,b)=>{let g=c+b;g<37?([()=>{},()=>{},0,()=>{},()=>{switch(d){case 104:case 105:case 106:case 107:case 120:case 128:{e.#n[h]||e.setChType(h,e.CH_DRUMS);break}default:e.#n[h]&&e.setChType(h,e.CH_MELODIC)}e.setChCc(h,0,d),e.pushChPrimitives(h)},()=>{e.#e[p+M[32]]=d,e.pushChPrimitives(h)},()=>{e.#f[h]=d},()=>{e.#e[p+M[7]]=d},()=>{e.#e[p+M[10]]=d},()=>{},()=>{},()=>{d<2&&(e.#h[h]=d)},()=>{d<2&&(e.#e[p+M[68]]=d?127:0)},()=>{},()=>{d<2&&(e.#e[p+M[65]]=d?127:0)},()=>{e.#e[p+M[5]]=d&15<<4|e.#e[p+M[5]]&15},()=>{e.#e[p+M[5]]=d&15|(e.#e[p+M[5]]&240)>>4},()=>{e.#e[p+M[74]]=d},()=>{e.#e[p+M[71]]=d},()=>{e.#e[p+M[73]]=d},()=>{e.#e[p+M[72]]=d},0,0,0,0,0,0,0,()=>{e.#e[p+M[128]]=d,e.allocateAce(128)},()=>{e.#e[p+M[93]]=d},()=>{e.#e[p+M[91]]=d},0,0,()=>{e.#e[p+M[75]]=d},()=>{e.#e[p+M[76]]=d},()=>{e.#e[p+M[77]]=d},()=>{e.#e[p+M[78]]=d}][g]||(()=>{}))():g<63||(g<64?(e.#n[h]?(e.#e[p+M[0]]=104|d,e.pushChPrimitives(h)):(e.#e[p+M[0]]=96|d,e.pushChPrimitives(h)),e.pushChPrimitives(h)):console.debug(`Unknown SD-90 global CH${h+1} param setup message:
%o`,f))});break}case 2:{let h=e.chRedir(l,o,!0),c=f[1];console.debug(`Unknown SD-90 global CH${h+1} MIDI setup message:
%o`,f.subarray(2));break}default:console.warn(`Unknown SD-90 global part setup message:
%o`,f)}}),e.#_.add([0,1,73,78],(f,o,s)=>{e.switchMode("krs"),e.setPortMode(e.getTrackPort(o),1,T.krs),console.debug("Might be KORG KROSS 2 mode reset... Not sure.")}).add([0,1,73,117,2,37],(f,o,s)=>{e.switchMode("krs");let i=e.getTrackPort(o);if(e.#S[i]&&e.#S[i]!==T.krs)if(e.#N.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled. Port ${String.fromCharCode(65+i)} mode "${G[e.#S[i]]}" mismatch, should be "krs".`);return}else console.info(`Track ${o} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+i)}.`);e.setPortMode(e.getTrackPort(o),1,T.krs);let l="KROSS 2 BMT1 ",h="";fe(f,(c,p)=>{if(p<24)h+=String.fromCharCode(Math.max(32,c));else if(!(p<88)){if(p<468){let d=p-88,b=d*863>>16,g=d-b*76;([()=>{e.setEffectType(b+3,45,c),e.pushEffectType(b+3)},!1,()=>{console.debug(`${l}IFX${b+1} sends to ${c<=5&&c>0?`IFX${c}`:"direct out"}.`)}][g]||(()=>{}))()}else if(p<604){let d=p-468,b=d*964>>16,g=d-b*68;([()=>{e.setEffectType(1-b,45,c),e.dispatchEvent(["efxreverb","efxchorus"][1-b],{id:e.getEffectType(1-b)})},!1][g]||(()=>{}))()}else if(!(p<1276)){let d=p-1276,b=d*1490>>16,g=e.chRedir(b,o,!0),w=d-b*44;w<22?([()=>{c&&e.setChActive(g,1),e.#f[g]=c,e.pushChPrimitives(g)},()=>{c&&e.setChActive(g,1),c<10?(e.setChCc(g,0,63),e.setChCc(g,32,c)):c<20?(e.setChCc(g,0,121),e.setChCc(g,32,c-10)):c<24&&(e.setChCc(g,0,[120,0,56,62][c-20]),e.setChCc(g,32,0)),e.pushChPrimitives(g)},()=>{let v=e.chRedir(c&15,o,!0);e.#i[g]=v,v!==g&&console.info(`${l}CH${g+1} receives from CH${v+1}`);let $=c>>5&1;e.modelEx.kross.chToggle&&(e.setChActive(g,$),$||console.debug(`KORG KROSS 2 CH${g+1} is disabled.`))},!1,!1,()=>{e.setChCc(g,7,c)},!1,()=>{},()=>{},!1,!1,!1,!1,!1,()=>{e.setChCc(g,10,c||128)}][w]||(()=>{}))():w<36?([()=>{let v=c&7;c&8&&(v=1),v>1&&console.debug(`${l}CH${g+1} sends to ${v>1?`IFX${v-1}`:"direct out"} (${c.toString(16)}).`),e.setChEffectSink(g,c>1&&c<7?c+1:0)}][w-22]||(()=>{}))():([()=>{e.setChCc(g,74,(c+128&255)-64)},()=>{e.setChCc(g,71,(c+128&255)-64)},!1,!1,()=>{e.setChCc(g,73,(c+128&255)-64)},()=>{e.setChCc(g,75,(c+128&255)-64)},!1,()=>{e.setChCc(g,72,(c+128&255)-64)}][w-36]||(()=>{}))()}}}),h=h.trimEnd(),e.dispatchEvent("metacommit",{type:"EORTitle",data:h})});let E=function(f,o,s){let i=e.chRedir(f,o,!0);e.setChMode(i,T.an1x),e.pushChPrimitives(i),console.debug(`Yamaha AN1x slot ${s+1} receives from CH${i+1}(${f+1}).`),e.modelEx.yPlg[3][s]=i};e.#x.add([92,0,0],(f,o,s)=>{let i=f[0];f.subarray(1).forEach((l,h)=>{let c=h+i;c<2||([!1,!1,!1,!1,!1,!1,()=>{E(l,o,0)},()=>{E(l,o,1)}][c-2]||(()=>{}))()})}),e.#x.add([75,80,0],(f,o,s)=>{let i=f[0];f.subarray(1).forEach((l,h)=>{let c=h+i;([()=>{e.modelEx.cs1x.perfCh=l,e.pushChPrimitives(l),console.debug(`Yamaha CS1x performance on CH${l+1}.`)},!1,!1,!1,()=>{},!1,()=>{switch(l){case 1:{e.switchMode("xg",!0),e.setPortMode(e.getTrackPort(o),1,T.xg),console.debug("Yamaha CS1x set to XG mode.");break}case 3:{e.switchMode("cs1x",!0),e.setPortMode(e.getTrackPort(o),1,T.cs1x),console.debug("Yamaha CS1x set to performance mode.");break}default:console.warn(`Unknown Yamaha CS1x mode: ${l}`)}},()=>{}][c]||(()=>{}))()})}).add([75,96,0],(f,o,s)=>{let i=f[0],l=!1,h=e.modelEx.cs1x.perfCh;f.subarray(1).forEach((c,p)=>{let d=p+i;d<8?(l=!0,e.#D[h]=1,e.setChCvnRegister(h,d,c)):d<48?([!1,()=>{e.setChCc(h,7,c)}][d]||(()=>{}))():d<80?([()=>{e.setEffectTypeRaw(0,!1,c)},()=>{e.setEffectTypeRaw(0,!0,c),e.pushEffectType(0)},()=>{e.setEffectTypeRaw(1,!1,c)},()=>{e.setEffectTypeRaw(1,!0,c),e.pushEffectType(1)},()=>{e.setEffectTypeRaw(2,!1,c)},()=>{e.setEffectTypeRaw(2,!0,c),e.pushEffectType(2)}][d-48]||(()=>{}))():D()&&console.debug(`Unknown CS1x effect register: ${d}.`)}),l&&(e.setChActive(h,1),e.pushChPrimitives(h))});let C=(f,o,s)=>{let i=0;s.forEach((l,h)=>{([()=>{i=(l&1)<<7|i&127,e.setEffectTypeRaw(f,!1,28),e.setEffectTypeRaw(f,!0,i)},()=>{i=i&128|l&127,e.setEffectTypeRaw(f,!1,28),e.setEffectTypeRaw(f,!0,i),e.pushEffectType(f)}][h+o]||(()=>{}))()})};e.#_.add([96,0,1],(f,o,s)=>{let i=f[0];switch(f[1]){case 0:{C(0,f[2],f.subarray(3)),console.debug(`Partially parsed KORG PA EFX SysEX:
`,f);break}case 1:{C(1,f[2],f.subarray(3)),console.debug(`Partially parsed KORG PA EFX SysEX:
`,f);break}case 2:{C(2,f[2],f.subarray(3)),console.debug(`Partially parsed KORG PA EFX SysEX:
`,f);break}case 3:{C(3,f[2],f.subarray(3)),console.debug(`Partially parsed KORG PA EFX SysEX:
`,f);break}default:console.debug(`Unparsed KORG PA SysEX:
`,f)}})}};var dt=Et(it(),1);var Gt=class{#t=!1;constructor(e,t,r,a){this.#t=e,this.start=t,this.end=r,this.data=a}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#t}},nt=class extends Gt{constructor(e,t,r){super(!0,e,t,r)}},Vt=class extends Gt{constructor(e,t){super(!1,e,e,t)}},ot=class extends Array{#t=-1;constructor(){super(...arguments)}resetIndex(e){this.#t=-1}fresh(){this.sort(function(e,t){return e.start==t.start?0:(+(e.start>t.start)<<1)-1}),this.forEach(function(e,t){e.index=t})}step(e,t=!1){let r=[];if(t)for(let a=0;a<this.length&&!(this[a].start>e);a++){if(this[a].end<e)continue;r.push(this[a])}else{let a=this.getRange(this.#t==-1?0:e-1,e),n=this;a.forEach(function(m){m.index>n.#t&&(r.push(m),n.#t=m.index)})}return r}getRange(e,t){e>t&&([e,t]=[t,e]);let r=[],a=-1,n=Math.ceil(Math.sqrt(this.length)),m=!0;for(let u=0;u<this.length;u+=n)this[u+n]?a<0&&this[u+n].start>=e&&(a=u):a=a<0?u:a;for(;m;)this[a]?.end<t?this[a].start>=e&&r.push(this[a]):m=!1,a++;return r}};var La=0xffffffffffff,Kt=function(e){let t=new ot,r=this,a=e.timeDivision,n=120,m=new ot,u=0,y=0;m.push(new nt(0,La,[120,0])),e.track.forEach(function(o){u=0,o.event.forEach(function(s){u+=s.deltaTime,s.type===255&&s?.metaType===81&&(n=6e7/s.data,m[m.length-1]&&m.push(new nt(u,0xffffffffffff,[n,0])))})}),m.fresh(),m.forEach(function(o,s,i){s>0&&(i[s-1].end=o.start)});let E=120;m.forEach(function(o,s,i){s>0&&(o.end===o.start?i.splice(i.indexOf(o),1):E===o.data[0]&&(i[s-1].end=o.end,i.splice(i.indexOf(o),1)),E=o.data[0])});let C=0,f=120;return m.forEach(function(o){let s=o.start,i=s/f/a*60+C;f=o.data[0],C=i-s/f/a*60,o.data[1]=C}),console.debug("All tempo changes: ",m),n=120,u=0,y=0,e.track.forEach(function(o,s){u=0,y=0;let i=s+1;o.event.forEach(function(l,h){u+=l.deltaTime;let c=m.step(u,!0)[0];c&&(n=c.data[0],y=c.data[1]);let p={type:l.type,data:l.data,track:i,part:0};l.type>14?p.meta=l.metaType:p.part=l.channel,t.push(new Vt(u/n/a*60+y,p))})}),t.fresh(),self.midiEvents=t,console.debug(`Parsed a type ${e.formatType} MIDI sequence.`),t};var Ra={866:"cp866","utf-8":"utf-8",utf8:"utf-8","utf-16":"utf-16",utf16:"utf-16","utf-16le":"utf-16",utf16le:"utf-16",unicode:"utf-16",unicodefeff:"utf-16","ucs-2":"utf-16","utf-16be":"utf-16be",utf16be:"utf-16be","utf-24":"utf-24",utf24:"utf-24","utf-24le":"utf-24",utf24le:"utf-24","utf-24be":"utf-24be",utf24be:"utf-24be","utf-32":"utf-32",utf32:"utf-32","utf-32le":"utf-32",utf32le:"utf-32","utf-32be":"utf-32be",utf32be:"utf-32be",latin1:"latin1",l1:"latin1",ascii:"latin1","us-ascii":"latin1","iso-8859-1":"latin1","iso8859-1":"latin1",cp1252:"latin1","windows-1252":"latin1",cp819:"latin1",ibm819:"latin1",latin2:"latin2",l2:"latin2","iso-8859-2":"latin2","iso8859-2":"latin2",latin3:"latin3",l3:"latin3","iso-8859-3":"latin3","iso8859-3":"latin3",latin4:"latin4",l4:"latin4","iso-8859-4":"latin4","iso8859-4":"latin4",latin5:"latin5",l5:"latin5","iso-8859-9":"latin5","iso8859-9":"latin5",cp1254:"latin5","windows-1254":"latin5",latin6:"latin6",l6:"latin6","iso-8859-10":"latin6","iso8859-10":"latin6",latin9:"latin9",l9:"latin9","iso-8859-15":"latin9","iso8859-15":"latin9","iso-8859-5":"iso-8859-5","iso8859-5":"iso-8859-5",cyrillic:"iso-8859-5","iso-8859-6":"iso-8859-6","iso8859-6":"iso-8859-6","iso-8859-6-e":"iso-8859-6","iso8859-6e":"iso-8859-6","iso-8859-6-i":"iso-8859-6","iso8859-6i":"iso-8859-6","asmo-708":"iso-8859-6","ecma-114":"iso-8859-6",arabic:"iso-8859-6","iso-8859-7":"iso-8859-7","iso8859-7":"iso-8859-7","ecma-118":"iso-8859-7",greek:"iso-8859-7",greek8:"iso-8859-7","iso-8859-8":"iso-8859-8","iso8859-8":"iso-8859-8","iso-8859-8-e":"iso-8859-8","iso8859-8e":"iso-8859-8",hebrew:"iso-8859-8",visual:"iso-8859-8","iso-8859-8-i":"iso-8859-8-i","iso8859-8i":"iso-8859-8-i",logical:"iso-8859-8-i","iso-8859-11":"iso-8859-11","iso8859-11":"iso-8859-11","windows-874":"iso-8859-11","dos-874":"iso-8859-11",cp874:"iso-8859-11","tis-620":"iso-8859-11","iso-8859-13":"iso-8859-13","iso8859-13":"iso-8859-13",latin7:"iso-8859-13",l7:"iso-8859-13","iso-8859-14":"iso-8859-14","iso8859-14":"iso-8859-14",latin8:"iso-8859-14",l8:"iso-8859-14","iso-8859-16":"iso-8859-16","iso8859-16":"iso-8859-16",cp866:"cp866",ibm866:"cp866",cp1250:"cp1250","windows-1250":"cp1250",cp1251:"cp1251","windows-1251":"cp1251",cp1253:"cp1253","windows-1253":"cp1253",cp1255:"cp1255","windows-1255":"cp1255",cp1256:"cp1256","windows-1256":"cp1256",cp1257:"cp1257","windows-1257":"cp1257",cp1258:"cp1258","windows-1258":"cp1258","euc-jp":"euc-jp",cp954:"euc-jp","euc-kr":"euc-kr",koi8:"koi8",koi:"koi8","koi8-r":"koi8","koi8-u":"koi8-u","koi8-ru":"koi8-u",mac:"mac",macintosh:"mac","mac-cyrillic":"x-mac-cyrillic","x-mac-cyrillic":"x-mac-cyrillic","x-mac-ukrainian":"x-mac-cyrillic",gbk:"gbk",gb2312:"gbk",chinese:"gbk","euc-cn":"gbk",gb18030:"gb18030",big5:"big5","big5-hkscs":"big5",sjis:"sjis","shift-jis":"sjis",ms932:"sjis","windows-31j":"sjis"},Ba={"utf-8":1,"utf-16":2,"utf-16be":3,"utf-24":4,"utf-24be":5,"utf-32":6,"utf-32be":7,latin1:0,latin2:0,latin3:0,latin4:0,latin5:0,latin6:0,latin9:0,"iso-8859-5":0,"iso-8859-6":0,"iso-8859-7":0,"iso-8859-8":0,"iso-8859-8-i":0,"iso-8859-11":0,"iso-8859-13":0,"iso-8859-14":0,"iso-8859-16":0,cp866:0,cp1250:0,cp1251:0,cp1253:0,cp1255:0,cp1256:0,cp1257:0,cp1258:0,"euc-jp":1,"euc-kr":1,koi8:0,"koi8-u":0,mac:0,"x-mac-cyrillic":0,gbk:1,gb18030:1,big5:1,sjis:1},de,ge=(de=class{static getUnitSize(e){if(e>7)throw new RangeError("Cannot decode encodings with more than 4 bits per unit.");return(e>>1)+1}static isBigEndian(e){return(e&1)===1}static collapse(e){let t=Ra[e];if(typeof t!="string")throw new TypeError(`Provided label "${e}" is not supported.`);return t}static indicator(e){let t=Ba[e];if(typeof t!="number")throw new TypeError(`Provided collapsed label "${e}" is not supported.`);return t}},Y(de,"BYTE_1",0),Y(de,"BYTE_1_VL",1),Y(de,"BYTE_2_LE",2),Y(de,"BYTE_2_BE",3),Y(de,"BYTE_3_LE",4),Y(de,"BYTE_3_BE",5),Y(de,"BYTE_4_LE",6),Y(de,"BYTE_4_BE",7),de),W=(e,t)=>{e.unsent=!1,e.enqueue(t)},Ge=(e,t,r=1,a=!0)=>{if(typeof r!="number"||r<=0||r>4)throw new RangeError(`Invalid byte size ${r}.`);if(!(e instanceof Uint8Array||e instanceof Uint8ClampedArray))throw new TypeError("Input buffer is not Uint8Array.");if(typeof t!="number"||t<0||t>=e.length)throw new RangeError(`Provided offset ${t} is out of buffer range.`);if(r===1)return e[t];{let n=0;if(a)for(let m=0;m<r;m++)n<<=8,n|=e[t+m];else for(let m=0;m<r;m++)n|=e[t+m]<<(m<<3);return n<0?n+4294967296:n}},Da=class{static lineRaw(e,t=0){if(typeof t!="number"||t<0||t>7)throw new TypeError("Invalid split mode.");if(!e||e?.constructor!==ReadableStream)throw new TypeError("Not a readable stream.");let r=ge.getUnitSize(t),a=ge.isBigEndian(t),n=e.getReader(),m,u=!1,y=[],E=0,C=0,f=0;return new ReadableStream({pull:async o=>{for(o.unsent=!0;o.unsent;){if(!m||E>=m.length){E>C&&(y.push(m.subarray(C)),C=0);let s=await n.read();m=s.value,u=s.done,E=0}if(m){let s=0;if(r===1)s=m[E];else if(a)for(let l=0;l<r;l++)s<<=8,s|=m[E+l];else for(let l=0;l<r;l++)s|=m[E+l]<<(l<<3);let i=!1;switch(s){case 10:{f===13?C+=r:i=!0;break}case 13:{i=!0;break}}if(i){if(y.length){y.push(m.subarray(C,E));let l=0;for(let p=0;p<y.length;p++)l+=y[p].length;let h=new Uint8Array(l),c=0;for(let p=0;p<y.length;p++)h.set(y[p],c),c+=y[p].length;W(o,h),y=[]}else W(o,m.subarray(C,E));C=E+=r}f=s}if(u){if(C!==E&&m&&y.push(m.subarray(C,E)),y.length){let s=0;for(let h=0;h<y.length;h++)s+=y[h].length;let i=new Uint8Array(s),l=0;for(let h=0;h<y.length;h++)i.set(y[h],l),l+=y[h].length;W(o,i)}o.unsent=!1,o.close()}E+=r}}},new ByteLengthQueuingStrategy({highWaterMark:256}))}static chunkRaw(e,t="utf-8"){if(!e||e?.constructor!==ReadableStream)throw new TypeError("Not a readable stream.");let r=ge.indicator(t),a=ge.getUnitSize(r),n=ge.isBigEndian(r),m=e.getReader(),u;return new ReadableStream({pull:async y=>{y.unsent=!0;let{value:E,done:C}=await m.read();if(E){let f=0,o=E.length;if(r!==0&&typeof u?.length=="number"){let s=!1;switch(t){case"big5":case"gbk":case"sjis":case"euc-kr":{f=1;let i=new Uint8Array(2);i[0]=u[0],i[1]=E[0],W(y,i);break}case"euc-jp":{let i=3;u[0]===143?f=3-u.length:u[0]>127?(f=1,i=2):i=u.length;let l=new Uint8Array(3);l.set(u),l.set(E.subarray(0,f),u.length),W(y,l.subarray(0,i));break}case"gb18030":{let i=new Uint8Array(4),l=4;i.set(u),i.set(E.subarray(0,4-u.length),u.length),i[0]<128?l=u.length:i[1]>=64?(f=1,l=2):f=4-u.length,W(y,i.subarray(0,l));break}case"utf-8":{let i=4;u[0]>=240?f=4-u.length:u[0]>=224?(f=3-u.length,i=3):u[0]>=192?(f=1,i=2):i=u.length;let l=new Uint8Array(4);l.set(u),l.set(E.subarray(0,f),u.length),W(y,l.subarray(0,i));break}case"utf-16":case"utf-16be":{let i=new Uint8Array(4);i.set(u),i.set(E.subarray(0,4-u.length)),f=4-u.length,Ge(transientSize,0,2,n)>=55296&&Ge(transientSize,2,2,n)>=55296?W(y,i):(W(y,i.subarray(0,2)),W(y,i.subarray(2)));break}default:{let i=new Uint8Array(a);i.set(u),i.set(E.subarray(0,a-u.length),u.length),W(y,i)}}}if(u=void 0,r===0)W(y,E.subarray(f));else{switch(t){case"utf-24":case"utf-24be":{o=Math.floor((E.length-f)/a)*a+f;break}case"utf-32":case"utf-32be":{o=(E.length-f>>2<<2)+f;break}case"utf-8":{if(E[E.length-1]>127){let s=!0,i=E.length,l=E.length-8;for(;s&&i>l;)i--,E[i]<128?o=i+1:E[i]>192&&(o=i)}break}case"utf-16":case"utf-16be":{if(o=(E.length-f>>1<<1)+f,Ge(E,o-2,2,n)>=55296){let s=!0,i=o,l=o-6;for(;s&&i>l;)i-=2,Ge(E,i,2,n)>>10===54&&(o=i)}break}default:throw new TypeError("Maybe someday the rest of the decoders will be implemented")}W(y,E.subarray(f,o))}o<E.length&&(u=E.subarray(o))}C&&(typeof u?.length=="number"&&W(y,u),y.unsent=!1,y.close())}},new ByteLengthQueuingStrategy({highWaterMark:256}))}static line(e,t="utf-8",r){let a=ge.collapse(t),n=ge.indicator(a),m=this.lineRaw(e,n).getReader(),u=new TextDecoder(a,onlostpointercapture);return new ReadableStream({pull:async y=>{let{value:E,done:C}=await m.read();E&&y.enqueue(u.decode(E)),C&&y.close()}})}static chunk(e,t="utf-8",r){let a=ge.collapse(t);if(self.TextDecoderStream){let n=new TextDecoderStream(a,r);return e.pipeTo(n.writable),n.readable}else{let n=this.chunkRaw(e,a).getReader(),m=new TextDecoder(a);return new ReadableStream({pull:async u=>{let{value:y,done:E}=await n.read();y&&(console.debug(y),u.enqueue(m.decode(y))),E&&u.close()}})}}},Yt=Da;var ct={0:"\0",a:"\x07",b:"\b",e:"\x1B",f:"\f",n:`
`,r:"\r",t:"	",v:"\v","\\":"\\","'":"'",'"':'"'},ht=new Uint8Array(128);ht.fill(1,48,58);ht.fill(1,65,71);ht.fill(1,97,103);var Se=new Uint8Array(256);Se.fill(1,0,32);Se.fill(1,128,160);Se[127]=1;var Ia={};for(let e in ct){let t=ct[e];Ia[t]=`\\${e}`,Se[t.charCodeAt(0)]=2}Se[34]=3;Se[39]=3;var qt=e=>{let t="",r=!1;for(let a=0;a<e.length;a++){let n=e[a];if(r){let m=0;switch(n){case"x":{m=2;break}case"u":{m=4;break}case"U":{m=8;break}default:{let u=ct[n];if(typeof u=="string")t+=u;else throw new Error(`Invalid escape identifier "${n}" at index ${a}`);r=!1;continue}}if(m>0){let u=a+1,y=e.substring(u,u+m);if(y.length<m)throw new RangeError(`Insufficient code point buffer "${y}" at index ${u}`);let E=parseInt(y,16);if(Number.isNaN(E))throw new RangeError(`Malformed code point representation "${y}" at index ${u}`);if(E>=1114112)throw new RangeError(`Code point "${y}" exceeds 0x10ffff at index ${u}`);t+=String.fromCodePoint(E),r=!1,a+=m}}else n==="\\"?r=!0:t+=n}return t},Ua=(e,t=0)=>{};self.TextEscape=Ua;var me,Ve=(me=class{static parse(e,t){let r=e&this.MASK_TYPE,a=e&this.MASK_DATA,n=0,m=0,u,y=0,E,C=t.getReader();return new ReadableStream({pull:async f=>{let{value:o,done:s}=await C.read();if(typeof o=="string"){switch(r){case this.TYPE_TSV:{u=[];try{for(let i of o.split("	"))switch(a){case this.DATA_TEXT:{u.push(qt(i));break}case this.DATA_JSON:{u.push(n===0?qt(i):JSON.parse(i));break}default:throw new TypeError(`Unknown DSV value type ${r}`)}}catch(i){console.debug(`The following error appeared when parsing on line ${n+1}.`),console.error(i)}break}case this.TYPE_CSV:{if(a!==this.DATA_TEXT)throw new TypeError(`Invalid type ${r} for CSV, only plain text is allowed`);break}default:throw new TypeError(`Unknown DSV type ${r}`)}f.enqueue(u),n++}s&&f.close()}})}static parseObjects(e,t){let r=0,a=this.parse(e,t).getReader(),n;return new ReadableStream({start:async m=>{let{value:u,done:y}=await a.read();typeof u?.length=="number"&&(n=u),y&&m.close()},pull:async m=>{let{value:u,done:y}=await a.read();if(typeof u?.length=="number"){let E={};for(let C=0;C<u.length;C++)u[C]&&(E[n[C]]=u[C]);m.enqueue(E)}y&&m.close()}})}},Y(me,"MASK_TYPE",3),Y(me,"MASK_DATA",12),Y(me,"TYPE_TSV",0),Y(me,"TYPE_CSV",1),Y(me,"DATA_TEXT",0),Y(me,"DATA_JSON",4),me);dt.default.customInterpreter=Dt;var F=(e,t,r)=>{e.addEventListener(r,a=>{t.dispatchEvent(r,a.data)})},Wt=e=>{let t=e.split("/");return t[t.length-1]||t[t.length-2]||"(remote)"},ee=class extends Ne{device;#t;#a={};#l=[];#r=new Map;#g="";#s=[];#i=[];#n=new Uint8ClampedArray(128);#e=new Uint8ClampedArray(128);#c=.5;#f=120;#o=4;#h=4;#d=0;#u=0;#E=new Array(k.ch);#m=new Uint8Array(k.ch);#v=0;smoothAttack=0;smoothDecay=0;reset(){let e=this;e.dispatchEvent("reset"),e.#t?.resetIndex(),e.device.init(),e.#g="",e.#c=.5,e.#f=120,e.#o=4,e.#h=4,e.#d=0,e.#u=0,e.dispatchEvent("tempo",e.#f),e.dispatchEvent("title",e.#g),e.dispatchEvent("tsig",e.getTimeSig())}init(){this.reset(),this.#t=void 0}async loadFile(e){this.#t=Kt(dt.default.parse(new Uint8Array(await e.arrayBuffer())))}async loadMap(e,t,r,a="(internal)"){let n=this,m=0,u=0,y=0,E=0,C,f;e.split(`
`).forEach((o,s)=>{if(!o)return;let i=o.split("	");if(s){if(!E)return;let l="",h="";i.forEach((p,d)=>{switch(d){case C:{l=p;break}case f:{h=p;break}}});let c=!1;n.#a[l]?.priority>r&&(c=!0,y++),!n.#a[l]||c||t?(n.#a[l]={name:h,priority:r},m++):self.debugMode&&console.debug(`Voice "${h}" (${l}) seems to be in conflict with (${n.#a[l]}).`),u++}else i.forEach((l,h)=>{switch(l){case"ID":{C=h,E++;break}case"Name":{f=h,E++;break}default:console.debug(`Unknown map field: ${l}`)}})}),console.debug(`Voice names: From "${a}", ${u} total, ${m} loaded (${m-y} + ${y}).`),n?.device.forceVoiceRefresh()}async loadMapPaths(e){let t=this;e.forEach(async(r,a)=>{t.loadMap(await(await fetch(r)).text(),0,a,Wt(r))})}async loadEfx(e,t){let r=this,a=0,n=0,m,u,y;e.split(`
`).forEach((E,C)=>{if(E)if(C){let f=0,o;E.split("	").forEach((s,i)=>{switch(i){case m:{f|=(parseInt(s,16)&255)<<8;break}case u:{f|=parseInt(s,16)&255;break}case y:{o=s;break}}}),!r.#l[f]||t?(r.#l[f]=o,a++):self.debugMode&&console.debug(`EFX ID 0x${f.toString(16).padStart(4,"0")} (${o}) seems to be in conflict.`),n++}else E.split("	").forEach((f,o)=>{switch(f){case"MSB":{m=o;break}case"LSB":{u=o;break}case"Name":{y=o;break}default:console.debug(`Unknown EFX field: ${f}`)}})}),console.debug(`EFX: ${n} total, ${a} loaded.`);for(let E=0;E<Re.length;E++){let C=!1,f=r.device.getEffectType(E);f[0]===0&&f[1]>>4===15&&(C=!0),r.dispatchEvent(`efx${Re[E]}`,{id:f,hidden:C})}}async loadModels(e,t){let r=this,a=0,n=0}async loadStyles(e,t){let r=this,a=0,n=0}async loadProps(e,t,r=0,a="(internal)"){let n=this,m=0,u=0,y=0;for await(let E of Ve.parseObjects(Ve.DATA_TEXT|Ve.TYPE_TSV,Yt.line(e)))if(typeof E?.voiceId=="string")if(u++,!(n.#r.has(E.voiceId)||n.#r.get(E.voiceId)?.priority<=r)||t){if(Object.keys(E).length<2)continue;n.#r.get(E.voiceId)?.priority>r&&y++,E.priority=r,n.handleProp&&await n.handleProp(E),n.#r.set(E.voiceId,E),m++}else console.debug(`Tried to write a pre-existing entry "${E.voiceId}" on entry ${u}.`);console.debug(`Voice properties: From "${a}", ${u} total, ${m} loaded (${m-y} + ${y}).`)}async loadPropsPaths(e){let t=this;e.forEach(async(r,a)=>{let n=r.split("/");t.loadProps((await fetch(r)).body,0,a,Wt(r))})}switchMode(e,t=!1){this.device.switchMode(e,t)}getMode(){return this.device.getMode()}getVoice(){return this.device.getVoice(...arguments)}getChVoice(e){return this.device.getChVoice(e)}refreshCachedChVoice(e,t){let r=this,a=t??r.device.getChVoice(e),n=r.#E[e],m=!0;if(r.#v++,!t)switch(r.device.getChMode(e)){case"xg":{r.device.getChType(e)>0&&a.ending==="!"&&(m=!1,n.refreshFailure=!0,console.debug("Cached voice persisted due to invalid drum kit."));break}case"gs":case"sc":{a.ending!==" "&&(a.sid[2]===1?(a.name="Silence",a.refreshFailure=!0,console.debug("Cached voice nullified due to invalid SC-55 voice.")):(m=!1,n.refreshFailure=!0,console.debug("Cached voice persisted due to invalid GS voice.")));break}}return m?(r.#E[e]=a,r.#m[e]=a.poly??1,r.#v>1?console.debug(`Bubbling prevented at instance #${r.#v}.`):r.dispatchEvent("cachedvoice",{part:e}),r.#v--,a):(r.#v--,n)}getCachedChVoice(e){let t=this,r=t.#E[e],a=t.device?.getChPrimitives(e,!0);if(r&&t.device?.getChCvnIsWritten(e)===0)switch(r.ending){case"?":case"!":return t.refreshCachedChVoice(e,void 0);default:return Bt(r.sid,a)[1]!==0?t.refreshCachedChVoice(e):r}else return t.refreshCachedChVoice(e)}getChPrimitive(e,t,r){return this.device.getChPrimitive(e,t,r)}getChPrimitives(e,t){return this.device.getChPrimitives(e,t)}getMapped(e){return this.#a[e]?.name||e}getEfx(e){let[t,r]=e,a=t<<8|r;return this.#l[a]||`0x${a.toString(16).padStart(4,"0")}`}getVoxBm(e){if(!e)throw new Error("Voice object must be valid");let t=this;if(!t.voxBm)throw new Error("Voice bitmap repository isn't yet initialized");let r=t.voxBm.getBm(e.name);if(!r)switch(e.mode){case"xg":{switch(e.sid[0]){case 0:case 80:case 81:case 83:case 84:case 96:case 97:case 99:case 100:{r=t.voxBm.getBm(t.getVoice(ie.bank0,e.sid[1],ie.bank0,e.mode).name);break}}break}case"g2":case"sd":{switch(e.sid[0]){case 96:case 97:case 98:case 99:{r=t.voxBm.getBm(t.getVoice(ie.bank0,e.sid[1],ie.bank0,e.mode).name);break}case 104:case 105:case 106:case 107:{r=t.voxBm.getBm(t.getVoice(120,e.sid[1],ie.bank0,e.mode).name);break}}break}case"gs":case"sc":case"k11":case"sg":case"gm":{switch(e.sid[0]){case 120:break;case 122:case 127:{r=t.voxBm.getBm(t.getVoice(120,e.sid[1],0,e.mode).name);break}default:r=t.voxBm.getBm(t.getVoice(0,e.sid[1],0,e.mode).name)}break}default:switch(e.sid[0]){case 56:{r=t.voxBm.getBm(t.getVoice(0,e.sid[1],0,e.mode).name);break}}}return r||(r=t.voxBm.getBm(t.getVoice(e.sid[0],e.sid[1],0,e.mode).name)),r}getChBm(e,t){let r=this;t=t??r.getChVoice(e);let a=r.getVoxBm(t);if(!a){if(!r.sysBm)return;switch(t.mode){case"xg":{switch(t.sid[0]){case 126:{t.sid[1]>>1===56&&(a=r.sysBm.getBm("cat_smpl"));break}case 16:{a=r.sysBm.getBm("cat_smpl");break}case 64:case 67:{a=r.sysBm.getBm("cat_sfx");break}case 32:case 33:case 34:case 35:case 36:case 48:case 82:{a=r.sysBm.getBm("cat_xg");break}}break}default:switch(t.sid[0]){case 63:case 32:case 33:case 34:case 35:case 36:case 48:case 82:{a=r.sysBm.getBm("cat_mex");break}}}}return a||(r.device.getChType(e)?a=r.sysBm.getBm("cat_drm"):a=r.sysBm.getBm("no_vox")),a}getProps(e){let t=this,r,a,n=0,m=e;for(;n<8&&r==null&&(!a?.constructor||a instanceof Array&&(a[1]!==e.eid[1]||a[2]!==e.eid[2]));)a=e.eid,typeof e.voice=="string"&&(t.#r.has(e.voice)?r=t.#r.get(e.voice):e=t.getVoice(a[0],a[2]===0?0:a[1],a[2]===0?0:a[2]-1));return!r&&n===8&&console.info(`Voice property fetching failed for "${e.name}" (${e.eid.join(" ")}).`),r}get noteProgress(){return this.#u/this.#c}get noteOverall(){return(this.noteProgress-this.#d)*this.#h/4}get noteBar(){return Math.floor(this.noteOverall/this.#o)}get noteBeat(){let e=this.noteOverall%this.#o;return e<0&&(e+=this.#o),e}get noteOffset(){return this.#d}getTimeSig(){return[this.#o,this.#h]}getTempo(){return this.#f}getChCachedVoice(e){return this.#E[e]}eachVoice(e,t=!1){let r=this;for(let a=0;a<r.#E.length;a++)(t||r.device?.getChActive(a))&&e(r.#E[a],a,r.#E)}sendCmd(e){this.device.runJson(e)}render(e){e>this.#u&&(this.#u=e);let t=this.#t?.step(e)||[],r=0,a=0,n=new Set,m={},u=[],y=this,E=[];for(y.device.getStrength().forEach((g,w)=>{y.#e[w]=g}),y.device.newStrength(),t.forEach(function(g){let w=g.data,v=y.device.runJson(w);switch(v?.reply){case"meta":{E.push(v);break}}v?.reply&&delete v.reply});y.#i.length>0;){let g=y.#i.shift(),w=g.part<<7|g.note;g.state?(n.add(w),m[w]=g.velo):n.has(w)&&(u.push({part:g.part,note:g.note,velo:m[w],state:y.device.NOTE_SUSTAIN}),r++,a+=y.#m[g.part])}E?.length>0&&y.dispatchEvent("meta",E);let C=y.device.getActive(),f=[],o=y.device.getPitch(),s=y.device.getCcAll(),i=y.device.getProgram(),l=y.device.getChTypes(),h=[],c=y.device.getStrength();c.forEach(function(g,w,v){v[w]=Math.max(y.#e[w],g);let $=v[w]-y.#n[w];if($>=0){let S=4*.25**(y.device.getChCc(w,73)/64);y.#n[w]+=Math.ceil($-$*y.smoothAttack**S)}else{let S=4*.25**(y.device.getChCc(w,72)/64);y.#n[w]+=Math.floor($-$*y.smoothDecay**S)}});let p=0,d=0;return C.forEach(function(g,w){g&&(f[w]=y.device.getVel(w),h[w]=y.device.getExt(w),p+=f[w].size,d+=f[w].size*y.#m[w])}),{extraPoly:r,extraPolyEC:a,extraNotes:u,curPoly:p,curPolyEC:d,chInUse:C,chKeyPr:f,chPitch:o,chProgr:i,chContr:s,chType:l,chExt:h,eventCount:t.length,title:y.#g,bitmap:y.device.getBitmap(),letter:y.device.getLetter(),texts:y.device.getTexts(),master:y.device.getMaster(),mode:y.device.getMode(),strength:y.#n.slice(),velo:c,rpn:y.device.getRpn(),tSig:y.getTimeSig(),tempo:y.getTempo(),noteBar:y.noteBar,noteBeat:y.noteBeat,ace:y.device.getAce(),rawVelo:y.device.getStrength(),rawStrength:y.device.getRawStrength(),rawPitch:y.device.getRawPitch(),efxSink:y.device.getEffectSink()}}constructor(e,t=.5,r=.5){super();let a=this;a.smoothAttack=t,a.smoothDecay=r,a.device=e,a.addEventListener("meta",function(n){n?.data?.forEach(function(m){(a.#s[m.meta]||console.debug).call(a,m.meta,m.data)})}),F(a.device,a,"mode"),F(a.device,a,"mastervolume"),F(a.device,a,"channelactive"),F(a.device,a,"channelmin"),F(a.device,a,"channelmax"),F(a.device,a,"portrange"),F(a.device,a,"portstart"),F(a.device,a,"channelreset"),F(a.device,a,"channeltoggle"),F(a.device,a,"screen"),F(a.device,a,"metacommit"),F(a.device,a,"voice"),F(a.device,a,"pitch"),F(a.device,a,"note"),F(a.device,a,"reset"),F(a.device,a,"banklevel"),F(a.device,a,"efxreverb"),F(a.device,a,"efxchorus"),F(a.device,a,"efxdelay"),F(a.device,a,"efxinsert0"),F(a.device,a,"efxinsert1"),F(a.device,a,"efxinsert2"),F(a.device,a,"efxinsert3"),F(a.device,a,"efxinsert4"),F(a.device,a,"partefxtoggle"),F(a.device,a,"chmode"),a.addEventListener("note",function({data:n}){a.#i.push(n)}),a.addEventListener("voice",({data:n})=>{a.refreshCachedChVoice(n.part)}),a.addEventListener("reset",({data:n})=>{a.#m.fill(1)}),a.#m.fill(1),a.#s[3]=function(n,m){a.#g?.length<1&&(a.#g=m,a.dispatchEvent("title",a.#g))},a.#s[81]=function(n,m){let u=a.noteProgress,y=a.#c||.5;a.#f=6e7/m,a.#c=m/1e6,a.#d+=u*(y/a.#c)-u,a.dispatchEvent("tempo",a.#f)},a.#s[88]=function(n,m){let u=a.noteBar,y=a.noteBeat,E=a.#o,C=a.#h;a.#o=m[0],a.#h=1<<m[1];let f=Math.round(u+y/E);E!==a.#o&&(a.#d-=f*(a.#o-E)*(4/a.#h)),C!==a.#h&&(console.debug(`${u}/${y}`),C<a.#h?a.#d+=f*(a.#h-C)*(C/a.#h):a.#d+=f*(a.#h-C)*(a.#h/C)),a.dispatchEvent("tsig",a.getTimeSig())},a.addEventListener("metacommit",({data:n})=>{switch(n.type){case"KarTitle":case"EORTitle":{a.#g?.length<1&&(a.#g=n.data,a.dispatchEvent("title",a.#g));break}}})}};var Oa=class extends EventTarget{static sleep(e){return new Promise(t=>{self.AbortSignal?AbortSignal.timeout(e).addEventListener("abort",t):setTimeout(t,e)})}#t;#a;#l=!1;get finished(){return this.#l}finish(){this.#l=!0,this.#a&&this.#a()}wait(){if(!this.#l)return this.#t}constructor(){super(),this.#t=new Promise(e=>{this.#a=()=>{this.#l=!0,e()}})}},Be=Oa;var Ke=new Uint8Array(40),De=0,Ie,Er=setInterval(()=>{Ie&&(Ke[De]=!Ke[De],De++,De>34&&(De=0))},1e3/50);Uint8Array.prototype.render=function(e){let t=0,r=0,a=this.width||5,n=this.height||8;for(let m=0;m<this.length;m++)e(this[m],t,r,this),t++,t>=a&&(t=0,r++)};var V=class{#t=[];loaded=new Be;async load(e,t=!1,r="(internal)"){let a=this,n=0,m=0;console.debug(`Font "${r||"(internal)"}": loading started.`),e.split(`
`).forEach(function(u,y){if(y>0&&u?.length>0){let E=u.split("	"),C=parseInt(E[0],16);if(m++,a.#t[C]&&!t)return;let f=new Uint8Array(40);Array.from(E[1]).forEach(async function(o,s){let i=s&1?4:0,l=s>>1,h=parseInt(o,16),c=3;for(;h>0||c>=0;){let p=(i+c)*5+l;f[p]=h&1,h=h>>1,c--}}),f.width=5,f.height=8,a.#t[C]=f,n++}}),a.loaded.finished||a.loaded.finish(),console.debug(`Font "${r||"(internal)"}": ${m} total, ${n} loaded.`)}async loadFile(e,t=!1){let r=this;console.debug(`Requested font file from "${e}".`),await r.load(await(await fetch(e)).text(),t,e),Ie=!1}constructor(...e){Ie=!0,(async()=>{for(let t=0;t<e.length;t++)await this.loadFile(e[t])})()}getCP(e){return this.#t[e]}getStr(e){let t=[],r=this;return Array.from(e).forEach(function(a){t.push(r.#t[a.charCodeAt(0)]||r.#t[32]||Ke)}),t}keys(){return Object.keys(this.#t)}data(e){return this.#t[e]}},zt=class{#t=[];loaded=new Be;async load(e,t=!1,r="(internal)"){let a=this,n=0,m=0;console.debug(`Font "${r||"(internal)"}": loading started.`),e.split(`
`).forEach(function(u,y){if(y>0&&u?.length>0){let E=u.split("	"),C=parseInt(E[0],16);if(m++,a.#t[C]&&!t)return;let f=new Uint8Array(176);Array.from(E[1]).forEach(async function(o,s){let i=(s&3)<<2,l=s>>2,h=parseInt(o,16),c=3;for(;h>0||c>=0;){let p=(i+c)*11+l;f[p]=h&1,h=h>>1,c--}}),f.width=11,f.height=16,a.#t[C]=f,n++}}),a.loaded.finished||a.loaded.finish(),console.debug(`Font "${r||"(internal)"}": ${m} total, ${n} loaded.`)}async loadFile(e,t=!1){let r=this;console.debug(`Requested font file from "${e}".`),await r.load(await(await fetch(e)).text(),t,e),Ie=!1}constructor(...e){Ie=!0,(async()=>{for(let t=0;t<e.length;t++)await this.loadFile(e[t])})()}getCP(e){return this.#t[e]}getStr(e){let t=[],r=this;return Array.from(e).forEach(function(a){t.push(r.#t[a.charCodeAt(0)]||r.#t[32]||Ke)}),t}keys(){return Object.keys(this.#t)}data(e){return this.#t[e]}},se=class{#t={};loaded=new Be;async load(e){let t=this;e.split(`
`).forEach(function(r,a){if(a>0&&r?.length>0){let n=r.split("	");if(n[1][0]!=="@"){let m=new Uint8Array(256);Array.from(n[1]).forEach(function(u,y){let E=y*4,C=parseInt(u,16),f=3;for(;C>0||f>=0;){let o=E+f;m[o]=C&1,C=C>>1,f--}}),m.width=16,m.height=16,t.#t[n[0]]=m}else t.#t[n[0]]=t.#t[n[1].slice(1)]}}),t.loaded.finished||t.loaded.finish()}async loadFile(e){let t=this;console.debug(`Requested fixed 256 bitmap file from "${e}".`),await t.load(await(await fetch(e)).text())}constructor(...e){(async()=>{for(let t=0;t<e.length;t++)await this.loadFile(e[t])})()}getBm(e){return this.#t[e]?.slice()}keys(){return Object.keys(this.#t)}data(e){return this.#t[e]}},le=class{#t={};loaded=new Be;async load(e){let t=this;e.split(`
`).forEach(function(r,a){if(a>0&&r?.length>0){let n=r.split("	");if(n[1][0]!=="@"){let m=parseInt(n[1].slice(0,4),16),u=parseInt(n[1].slice(4,8),16),y=new Uint8Array(m*u);Array.from(n[1]).slice(8).forEach(function(E,C){let f=C*4,o=parseInt(E,16),s=3;for(;o>0||s>=0;){let i=f+s;i<=y.length&&(y[i]=o&1,o=o>>1),s--}}),y.width=m,y.height=u,t.#t[n[0]]=y}else t.#t[n[0]]=t.#t[n[1].slice(1)]}}),t.loaded.finished||t.loaded.finish()}async loadFile(e){let t=this;console.debug(`Requested pre-defined bitmap file from "${e}".`),await t.load(await(await fetch(e)).text()),self.mxDef=t}constructor(...e){(async()=>{for(let t=0;t<e.length;t++)await this.loadFile(e[t])})()}getBm(e){return this.#t[e]}keys(){return Object.keys(this.#t)}data(e){return this.#t[e]}};var ne={red:"#ff7986",orange:"#fca022",grYellow:"#c9e10a",green:"#c1ff0a",white:"#b7e5e3",blue:"#2280ff"},z={black:"#000000",blue:"#0516bb",purple:"#48009a",inactive:22,medium:59,active:170,range:148},q={},_a="06,68,2a,16,aa,3b".split(",");for(let e in z)q[e]=[],_a.forEach(t=>{q[e].push(`${z[e]}${t}`)});var be=`${ne.orange}64`,te=`${ne.green}64`,Ue=`${ne.white}64`,ut=`${ne.red}64`,U=q.black[0],Oe=q.black[2],I=q.black[1];var pe=8,ye=7,qe=4,Na=3,bt=200,Qt=bt*5,Xa=bt<<1,Zt=400,Ha=new Uint8Array(256),Fa={"?":0,gm:0,gs:1,sc:1,xg:0,sd:1,g2:0,mt32:2,ns5r:3,k11:0,"05rw":3,sg:1,x5d:3,s90es:0,krs:3,motif:0},jt=[95,3,117,115,43,122,126,19,127,123,0],Ga=(e,t)=>e>>t&1,mt=e=>e?I:U,pt=function(e,t,r){let a=pe*4-1,n=qe*1.5-1,m=e>>4;for(let u=0;u<8;u++){e>0&&m>=0?r.fillStyle=I:r.fillStyle=U,m--;let y=7-u;r.fillRect(t,181+y*pe,a,n)}},Va=Math.PI*255/180,Ka=Math.PI*285/180,gt=function(e,t,r,a,n){let m=pe*4-1,u=qe*1.5-1,y=e>>4;for(let E=0;E<8;E++){a?n[E]?r.strokeStyle=I:r.strokeStyle=U:(e>0&&y>=0?r.strokeStyle=I:r.strokeStyle=U,y--);let C=7-E;r.beginPath(),r.arc(t,256,(9-C)*pe,Va,Ka),r.lineWidth=u,r.stroke()}},oe=function(e,t,r,a=!1){e.beginPath(),e.moveTo(t-ye,r),e.lineTo(t,r+ye),e.lineTo(t+ye,r),e.closePath();let n=e.fillStyle;e.fillStyle=a?I:U,e.fill(),e.fillStyle=n},Ye=function(e,t,r,a=!1){e.beginPath(),e.moveTo(t,r),e.lineTo(t+8,r+5),e.lineTo(t,r+10),e.closePath(),e.fillStyle=a?I:U,e.fill()},Jt=function(e,t,r,a){let n=0,m=0,u=0,y=0;for(let E=0;E<7;E++)e.fillStyle=mt(Ga(a,E)),n=E>>2?11:3,m=E>>2?3:13,u=E>>1?E>>2?4:0:16,y=[4,22,22,4,0,18,36][E],e.fillRect(t+u,r+y,n,m)};Math.sum=function(...e){let t=0;return e.forEach(r=>{t+=r}),t};CanvasRenderingContext2D.prototype.radial=function(e,t,r,a,n){let m=r-1.5707963267948966,u=Math.sin(m),y=Math.cos(m);this.beginPath(),this.moveTo(e+u*a,t+y*a),this.lineTo(e+u*n,t+y*n),this.stroke()};var Ya=class extends ee{#t=new Uint8Array(1360);#a=new Uint8Array(200);#l=new Uint8Array(256);#r=0;#g=0;#s=0;#i=0;#n=255;#e=0;#c=0;#f=0;#o=0;#h=0;inWB=!1;#d=new Uint8Array(8);#u=new Uint8Array(7);#E=0;#m=0;trueFont=new V("./data/bitmaps/korg/font.tsv","./data/bitmaps/xg/font.tsv");xgFont=new V("./data/bitmaps/xg/font.tsv");sysBm=new se("./data/bitmaps/xg/system.tsv");voxBm=new se("./data/bitmaps/xg/voices.tsv");aniBm=new se("./data/bitmaps/xg/animation.tsv");isMetreAffectedByPan=!1;clockSource;constructor(){super(new J);let e=this;e.addEventListener("mode",function(t){(e.sysBm.getBm(`st_${{gm:"gm1",g2:"gm2","?":"gm1",ns5r:"korg",ag10:"korg",x5d:"korg","05rw":"korg",krs:"korg",sg:"gm1",k11:"gm1",sd:"gm2",sc:"gs"}[t.data]||t.data}`)||[]).forEach(function(r,a){e.#l[a]=r}),e.#r=2,e.#g=Date.now()+Zt*4}),e.addEventListener("channelactive",t=>{e.#s=t.data}),e.addEventListener("channelmin",t=>{t.data>=0&&(e.#e=t.data+1)}),e.addEventListener("channelmax",t=>{t.data>e.#e-1?e.#c=t.data+1:(e.#e=0,e.#c=0)}),e.addEventListener("channelreset",()=>{e.#e=0,e.#c=0,e.#d.fill(0),e.demoInfo=!1}),e.addEventListener("portrange",t=>{t&&t.data!==1<<Math.log2(t.data)&&console.debug(`MU display rejected port range value ${t.data}.`),e.#i=t.data}),e.addEventListener("portstart",t=>{t!==255&&t>=k.port&&console.debug(`MU display rejected port range value ${t.data}.`),e.#n=t.data}),e.device.addEventListener("mupromptex",({data:t})=>{e.#f=t,D()&&console.debug("Scheduled a SysEx prompt.")}),e.clockSource=e.clockSource||{now:()=>Date.now()/1e3},(async()=>(await Promise.all([e.trueFont.loaded.wait(),e.xgFont.loaded.wait(),e.sysBm.loaded.wait(),e.aniBm.loaded.wait()]),e.#E=1))()}setCh(e){this.#s=e}getCh(){return this.#s}reset(){super.reset(),this.#e=0,this.#c=0,this.#i=0,this.#n=255,this.demoInfo&&delete this.demoInfo}render(e,t){let r=super.render(e),a=this,n=Date.now();if(t.fillStyle=`${ne.grYellow}64`,t.fillRect(0,0,t.canvas.width,t.canvas.height),a.#t.fill(0),a.#a.fill(0),a.#f>0){let d=a.#f*85+4095>>12;n-a.#h>bt?(a.#o+=d*204+4095>>12,D()&&console.debug(`SysEx prompt submitted: ${a.#o}.`)):((n-a.#h)*41>>12&1&&a.#o<8&&a.#o==8,a.#o+=d+1>>1,D()&&console.debug(`SysEx prompt too busy: ${a.#o}.`)),a.#f=0}let m=!1,u=0,y=0;r.chInUse.forEach(function(d,b){d&&(m||(m=!0,u=b),y=b)}),u=u>>4<<4,y=(y>>4<<4)+15,a.#s>y&&(a.#s=u+a.#s&15),a.#s<u&&(a.#s=y-15+(a.#s&15)),a.#e&&a.#e>0&&(u=a.#e-1),a.#c&&a.#c<=128&&(y=a.#c-1),a.#i&&(a.#n===255?u=Math.floor((a.#s>>4)/a.#i)*a.#i<<4:u=a.#n<<4,y=u+a.#i*16-1);let C=Math.ceil(Math.log2(y-u+1)-4),f=0,o=a.getChPrimitive(a.#s,1)===0;if(n<=r.letter.expire&&r.letter.text.length>0)a.xgFont.getStr(r.letter.text.padEnd(32," ")).forEach(function(d,b){let g=b%16*5+5,w=Math.floor(b/16)*8;d.forEach(function(v,$){let S=$%5,x=Math.floor($/5);a.#t[(w+x)*85+g+S]=v})});else{a.#t[1275]=1,a.#t[1276]=1,a.#t[1278]=1,a.#t[1279]=1;for(let d=u;d<=y;d++){let b=r.strength[d],g=b,w=b,v=a.device.getChCc(d,10);if(v===64||v>>7===1||!a.isMetreAffectedByPan||(v<64?w=Math.round(w*v>>6):v>64&&(g=Math.round(w*(128-v)>>6))),C?(g>>=5,w>>=5):(g>>=4,w>>=4),C===0||C===1)for(let $=0;$<=b;$++){let S=5+f*3+(15-$)*85-(f>>1);$<=g&&(a.#t[S]=1),$<=w&&(a.#t[S+1]=1)}else for(let $=0;$<=b;$++){let S=5+f*3+(15-$)*85-(f>>1);f>31&&(S-=760),$<=g&&(a.#t[S]=1),$<=w&&(a.#t[S+1]=1)}f++}if(C<2){let d=a.getChVoice(a.#s),b=d.name.slice(0,8).padEnd(8," "),g=a.getChPrimitives(a.#s),w=(g[0]||g[2]||0).toString().padStart(3,"0");switch(g[0]){case 64:case 67:{a.device.getChMode(0)==="xg"&&(w="SFX");break}}[63].indexOf(g[0])>-1&&(w=`${g[2]||0}`.padStart(3,"0"),o=!0),a.getMode()==="xg"&&[32,33,34,35,36,48,79,80,81,82,83,84,95,96,97,98,99,100].indexOf(g[0])>-1&&(w=`${g[2]||0}`.padStart(3,"0"),o=!0);let v=`${w}${((r.chProgr[a.#s]||0)+1).toString().padStart(3,"0")}`;a.xgFont.getStr(v+b).forEach(function(S,x){let R=0,A=0;C===1?R=x*5:C||(R=x%8*5+45,A=8-Math.floor(x/8)*8),S.forEach(function(L,N){let O=N%5,X=Math.floor(N/5);C===1&&x>7&&(O=O+5),a.#t[(A+X)*85+R+O]=L})})}}for(let d=0;d<1360;d++){let b=d%85,g=Math.floor(d/85);t.fillStyle=U,a.#t[d]&&(t.fillStyle=I),t.fillRect(16+(b+Math.floor(b/5))*pe,12+g*pe,ye,ye)}t.textAlign="center",t.font='400 12px "Public Sans"',t.textRendering="geometricPrecision";{let d=71.5;for(let b=-2;b<32;b++){t.fillStyle=I,b+u===a.#s&&(t.fillStyle=U);let g="";b>=0?g=(b+1).toString().padStart(2,"0"):g=`A${b+3}`,t.fillText(g,d+24*b,150)}}t.fillStyle=I,t.fillText("CHANNEL     SEC     PART",118,254),t.fillText("VOL",420,254),t.fillText("EXP",468,254),t.fillText("BRT",516,254),t.fillText("REV",643,254),t.fillText("CHO",692.5,254),t.fillText("VAR",741,254),t.fillText("KEY",799,254),t.fillText("PAN",583,254),t.fillStyle=!o&&!C?I:U,t.fillText("MSB",515,162.5),t.fillStyle=o&&!C?I:U,t.fillText("LSB",564,162.5),t.fillStyle=C?U:I,t.fillText("BANK",467.5,162.5),t.fillText("PGM#",660,162.5),t.fillStyle=!o&&C?I:U,t.fillText("MSB",131,162.5),t.fillStyle=o&&C?I:U,t.fillText("LSB",180,162.5),t.fillStyle=C?I:U,t.fillText("BANK",83.5,162.5),t.fillText("PGM#",276,162.5),a.xgFont.getStr(`${(a.#s+1).toString().padStart(2,"0")}${"ABCDEFGH"[a.#s>>4]}${(a.#s%16+1).toString().padStart(2,"0")}`).forEach(function(d,b){let g=b*5;d.forEach(function(w,v){let $=v%5,S=Math.floor(v/5);a.#a[S*25+g+$]=w})});for(let d=0;d<200;d++){let b=d%25,g=Math.floor(d/25);t.fillStyle=U,a.#a[d]&&(t.fillStyle=I),t.fillRect(16+(b+Math.floor(b/5))*pe,180+g*pe,ye,ye)}let s;if(n<=r.bitmap.expire)a.#o&&(a.#o=0,D()&&console.debug("SysEx prompt cancelled.")),s=r.bitmap.bitmap;else if(a.demoInfo&&e>0){a.#o&&(a.#o=0,D()&&console.debug("SysEx prompt cancelled."));let d=a.demoInfo.class||"boot",b=a.demoInfo.fps||2,g=a.demoInfo.size||4,w=a.demoInfo.offset||0,v=Math.floor((e*b+w)%g),$=`${d}_${v}`;s=a.aniBm?.getBm($)||a.sysBm?.getBm($)||a.sysBm?.getBm("no_abm"),s||(s=a.#l.slice())}else if(s=a.#l.slice(),n>=a.#g){a.#o>0&&n-a.#h>=Xa?(a.#o-=16,a.#h=n,D()&&console.debug(`SysEx prompt resolved: ${a.#o}.`)):a.#o<0&&(a.#o=0),a.#r=0;let d=a.getChVoice(a.#s).standard.toLowerCase();if(s=a.voxBm.getBm(a.getChVoice(a.#s).name)||a.voxBm.getBm(a.getVoice(a.getChPrimitive(a.#s,1),a.getChPrimitive(a.#s,0),0,r.mode).name),["an","ap","dr","dx","pc","pf","sg","vl"].indexOf(d)>-1)switch(a.getChPrimitive(a.#s,1)>>4){case 2:{s=a.sysBm.getBm(`ext_${d}I`);break}case 6:{s=a.sysBm.getBm(`ext_${d}P`);break}default:{s=a.sysBm.getBm(`ext_${d}`);break}}else r.chType[a.#s]?s=a.sysBm.getBm("cat_drm"):["mu","es"].indexOf(d)>-1?s=a.sysBm.getBm("boot_3"):d==="kr"&&(s=a.sysBm.getBm("st_korg"));!s&&(a.getChPrimitive(a.#s,1)<48||a.getChPrimitive(a.#s,1)===56||a.getChPrimitive(a.#s,1)===121||a.getChPrimitive(a.#s,1)&&a.getChPrimitive(a.#s,1))&&(s=a.voxBm.getBm(a.getVoice(0,r.chProgr[a.#s],0,r.mode).name)),!s&&a.getChPrimitive(a.#s,1)===126&&(s=a.sysBm.getBm("cat_smpl")),!s&&a.getChPrimitive(a.#s,1)===64&&(s=a.sysBm.getBm("cat_sfx")),s||(s=a.sysBm.getBm("no_abm")),s=s?.slice()||Ha;let b=n-a.#h;b<=Qt&&(a.sysBm.getBm("sysex_m").forEach((g,w)=>{g&&(s[w]=0)}),a.sysBm.getBm(`sysex_${Math.floor(b/Qt*5)&1}`).forEach((g,w)=>{g&&(s[w]=1)}))}else a.#r===2&&(a.#o&&(a.#o=0,D()&&console.debug("SysEx prompt cancelled.")),s.forEach((d,b,g)=>{let w=Math.floor((a.#g-n)/Zt);g[b]=(w&1)===d}));for(let d=0;d<256;d++){let b=d%16,g=Math.floor(d/16);t.fillStyle=U,s&&s[d]&&(t.fillStyle=I),t.fillRect(260+b*pe,180+g*qe,ye,Na)}let i=e&&a.demoInfo;if(i&&Math.floor(e*50)){for(let d=6;d>=0;d--)a.#d[d+1]=a.#d[d];a.#d[0]=+(r.velo[a.#s]>159)}pt(a.device.getChCc(a.#s,7),404,t),pt(a.device.getChCc(a.#s,11),452,t),pt(a.device.getChCc(a.#s,74),500,t),gt(a.device.getChCc(a.#s,91),644,t,i,a.#d),gt(a.device.getChCc(a.#s,93),692,t,i,a.#d),gt(a.device.getChCc(a.#s,94),740,t,i,a.#d),t.beginPath(),t.arc(582,216,34,2.356194490192345,7.068583470577034),t.lineWidth=2,t.strokeStyle="#000f",t.stroke();let l=a.device.getChCc(a.#s,10);a.#u.fill(0),l===0?a.#u[0]=1:l===64?a.#u[3]=1:l===128||(l<64?a.#u[Math.floor(l/21)]=1:a.#u[4+Math.floor((l-65)/21)]=1),t.lineWidth=qe;for(let d=0;d<7;d++)t.strokeStyle=U,a.#u[d]&&(t.strokeStyle=I),t.radial(582,216,[7.068583470577034,6.283185307179586,5.497787143782138,4.71238898038469,3.9269908169872414,3.141592653589793,2.356194490192345][d],8,26);oe(t,180,170,!1),oe(t,292,170,!1),oe(t,356,170,!(a.demoInfo&&e)&&Math.floor((e||a.clockSource.now())*20)%8),oe(t,420,170,!1),oe(t,468,170,!1),oe(t,516,170,!1),oe(t,582,170,!1),oe(t,644,170,!1),oe(t,692,170,!1),oe(t,740,170,!1),oe(t,800,170,!1);let h=Fa[r.mode];h?.constructor!==Number&&(h=-1),Ye(t,826,170,h===0),Ye(t,826,188,h===1),Ye(t,826,206,h===2),Ye(t,826,224,h===3),t.fillStyle=mt(!(a.demoInfo&&e)),t.fillRect(15,153,42,11),t.fillStyle=U,t.fillRect(15,166,42,11),t.fillStyle=ne.grYellow,t.fillText("MIC",36,162.5),t.fillText("LINE",36,175.5);let c=a.device.getPitchShift(a.#s),p=c>=0;c=Math.round(Math.abs(c)),t.fillStyle=I,t.fillRect(757,218,18,3),t.fillStyle=mt(p),t.fillRect(765,207,3,10),t.fillRect(765,222,3,10),Jt(t,779,200,jt[Math.floor(c/10)||10]),Jt(t,801,200,jt[c%10])}},qa=Ya;var We=[0,95,190,285,380,475,570],$e=7,ea=6,ta=31,Wa=12,za=29,Qa=10,Za=$e*(17+2),ja=$e*(7+3)+1,Ja=class extends ee{#t;#a=0;#l=255;#r=0;#g=new Uint8Array(1656);#s=new Uint8Array(1656);#i=new Uint8Array(1656);#n;#e;#c;#f=new Uint8Array(k.ch);#o=new Uint8Array(k.ch);#h=new Uint16Array(k.ch);#d=new Uint16Array(k.ch);#u=new Uint16Array(k.ch);#E=new Uint8Array(k.ch);#m=0;#v=0;#C=0;useBlur=!1;#p=0;#b=0;bootBm=new le;xgFont=new V("./data/bitmaps/korg/font.tsv","./data/bitmaps/xg/font.tsv");constructor(e){super(new J,0,.4);let t=this;t.useBlur=!!e?.useBlur,t.#n=t.#g.subarray(0,665),t.#e=t.#g.subarray(665,1400),t.#c=t.#g.subarray(1400,1656),t.addEventListener("mode",function(r){switch(r.data){case"?":return;case"sc":{t.#t="    Mode 1";break}case"gm":{t.#t="GM System On";break}case"g2":{t.#t="GM2 System On";break}case"gs":{t.#t="GS Reset";break}case"xg":{t.#t="XG System On";break}default:t.#t=`Sys:${{"?":"Init",g2:"GM2",mt32:"MT-32",ag10:"AG-10","05rw":"05R/W",k11:"GMega",krs:"KROSS 2",s90es:"S90 ES",motif:"Motif ES"}[r.data]||r.data.toUpperCase()}`}t.#a=Date.now()+800}),t.addEventListener("channelactive",r=>{t.#m=r.data}),t.addEventListener("note",({data:r})=>{r.state===3&&(t.#E[r.part]=10,r.state===3&&r.velo&&(t.#u[r.part]=1))}),t.bootBm.load(`RsrcName	Bitmap
boot	002a000c71c0e38f003ef87df3e008a211448802080451220082011448803c8338e3ea67a0df7cf3bc28045120c90a0114482262884512089fbe1f7c823dc7038e2086
mask	0008001080804040202010100808040402020101
text	005f001f000000880080008000000000000001b00100030000000000000002a71a70020000000000000005514d10040000000000000008a28be008000000000000001145140010000000000000002271e700700000000000000000000000000000000071c8bc8befbc01e88089ce1d145b45111044041131b1121208aa8a222088082262a222241155e44479e00e5405444448228a0888828002a98888889145141111048005531111211c72281c23e880f140227387000000000000000000000000c1c880f00780600000f00001911101101000400c01100000423202202070801802271cb1045407803911000007910594089808800be200600a3e7a1311101100140430c01241140672203c03c71c60002271e8000000000000000000000000f0001020000001e89efbe881100020000f30041140441b02271ce18b2260082280882a079144811944000e28e11e5408a2890222798002202220881145124444130004404441103c71c31c89c000f08f08fa200`),t.xgFont.loaded.wait().then(()=>{t.#b=1})}async handleProp(e){e.scSqr=parseInt(e.scSqr),e.scScale=Math.ceil(parseFloat(e.scScale)*256)}reset(){super.reset(),this.#d.fill(0)}setCh(e){this.#m=e}getCh(){return this.#m}render(e,t){let r=super.render(e),a=this,n=Date.now(),m=!1,u=a.device.modelEx.sc;if(a.#g.fill(0),a.#C<10&&n-a.#v>=1e3){t.fillStyle=be.slice(0,7),t.fillRect(0,0,t.canvas.width,t.canvas.height),a.#v=n,t.fillStyle="#000",t.textAlign="left",t.font='420 23px "Work Sans"',t.textRendering="geometricPrecision",t.scale(1,.8),t.letterSpacing="-1px",t.fillText("PART",23,25),t.fillText("INSTRUMENT",156,25),t.fillText("LEVEL",23,113.75),t.fillText("PAN",156,113.75),t.fillText("REVERB",23,202.5),t.fillText("CHORUS",156,202.5),t.fillText("KEY SHIFT",23,291.25),t.fillText("MIDI CH",156,291.25),t.resetTransform(),t.scale(1,.85),t.textAlign="center",t.textRendering="auto",t.fontStretch="extra-expanded";for(let f=1;f<=16;f++)t.fillText(`${f}`,308+ta*f,352.94);t.resetTransform(),t.lineWidth=1,t.strokeStyle="#000";let C=2*Math.PI;for(let f=0;f<16;f++){let o=f%8;t.beginPath(),o?o===4?(t.ellipse(316,(15-f)*12+100,3,3,0,0,C),t.fill()):(t.ellipse(316,(15-f)*12+100,2,2,0,0,C),t.stroke()):(t.ellipse(316,(15-f)*12+100,4,4,0,0,C),t.fill())}m=!0,a.#C++}let y=22,E=24;if(a.#p<50)a.#p++;else if(a.#p<250||a.#b<1){let C=a.bootBm.getBm("boot"),f=a.bootBm.getBm("mask");if(C){let o=a.#p-68>>2;o=Math.max(-6,Math.min(27,o));let s=a.#p-178>>1;for(let h=0;h<224;h++){let c=h&15,p=h>>4,d=c+o;if(d>=0&&d<C.width){let b=C[d+p*C.width];if(f&&s>=0){s>>6&&(s=s&63);let g=7-s,w=c+g;w>=0&&w<8&&f[(p+2<<3)+w]>0&&(b=0)}a.#c[c+(p+2<<4)]=b?255:0}}let i=a.bootBm.getBm("text"),l=Math.min(3,a.#p-50>>5)<<3;for(let h=0;h<95;h++)for(let c=0;c<7;c++)a.#n[h+We[c]]=i[h+(c+l)*95]?255:0;a.#p++}}else{let C=!1,f=0,o=0;r.chInUse.forEach(function(S,x){S&&(C||(C=!0,f=x),o=x)}),f=f>>4<<4,o=(o>>4<<4)+15,a.#m>o&&(a.#m=f+(a.#m&15)),a.#m<f&&(a.#m=o-15+(a.#m&15));let i=a.#m*M.length,l,h=r.letter.text.trim();for(;h.indexOf("  ")>-1;)h=h.replaceAll("  "," ");let c=a.getChVoice(a.#m);if(n<=a.#a)a.xgFont.getStr(a.#t||"No system text!").forEach(function(S,x){S.forEach(function(R,A){let L=x*6+A%5,N=Math.floor(A/5);a.#g[We[N]+L]=R?a.#l:a.#r})});else if(n<=r.letter.expire&&(r.mode!=="gs"&&r.mode!=="sc"||r.letter.text?.length<=16)){l=h;let S=r.letter.text,x=S.length-S.trimLeft().length,R=S.length-S.trimRight().length;if(S.length>16&&S.length>l.length&&l.length<16){if(x>0){for(;l.length<15;)l=` ${l} `;l.length<16&&(x<R?l=` ${l}`:l=`${l} `)}}else S.length<=16&&(l=S);let A=0;if(l.length>16){A=Math.floor((r.letter.expire-n)/33)-96;let L=(l.length-16)*-6;A<L?A=L:A>0&&(A=0)}a.xgFont.getStr(l).forEach(function(L,N){L.forEach(function(O,X){let ue=N*6+X%5+A,Qe=Math.floor(X/5);ue>=0&&ue<95&&(a.#g[We[Qe]+ue]=O?a.#l:a.#r)})})}else{let S=a.device?.getChMode(a.#m);l=`${r.chProgr[a.#m]+1}`.padStart(3,"0");let x=a.device.getChPrimitives(a.#m);switch(x[0]){case 0:{switch(x[2]){case 0:{switch(S){case"gm":{l+="_";break}default:l+=" "}break}case 125:{l+=" ";break}case 126:case 127:{switch(S){case"gs":case"sc":{l+="#";break}default:l+=" "}break}default:switch(S){case"gs":case"sc":{l+=" ";break}default:l+=c.eid[2]===c.iid[2]||c.ending===" "?"+":"!"}}break}case 56:{l+=" ";break}case 61:case 62:case 63:case 120:case 122:case 128:{l+=a.device?.getChType(a.#m)===0?" ":"*";break}case 126:case 127:{switch(S){case"gs":case"sc":{l+=x[0]===127?"#":"@";break}default:l+=a.device?.getChType(a.#m)===0?" ":"*"}break}default:l+=c.eid[2]===c.iid[2]||c.ending===" "?"+":"!"}l+=a.getMapped(c.name).slice(0,12).padEnd(12," ");let R=0;if((r.mode==="gs"||r.mode==="sc")&&r.letter.text.length>16&&n<r.letter.set+15e3){let A=`${l}<${r.letter.text}<${l}`,L=r.letter.set+(A.length-16)*300;n<L&&(l=A,R=L-n)}if(R){let A=l.length-Math.floor(R/300);l=l.slice(Math.max(0,A-16),Math.max(16,A))}a.xgFont.getStr(l).forEach(function(A,L){A.forEach(function(N,O){let X=L*6+O%5,ue=Math.floor(O/5);a.#g[We[ue]+X]=N?a.#l:a.#r})})}let p="";p+=`${"ABCDEFGH"[a.#m>>4]}${((a.#m&15)+1).toString().padStart(2,"0")}`,p+=r.chContr[i+M[7]].toString().padStart(3," "),p+=r.chContr[i+M[91]].toString().padStart(3," ");let d=a.device.getPitchShift(a.#m);d<0?p+="-":d===0?p+="±":p+="+",p+=Math.round(d<0?Math.abs(d):d).toString().padStart(2," ");let b=r.chContr[i+M[10]];b===64?p+="C 0":b===128?p+="RND":b<1?p+="L63":(b>64?p+="R":p+="L",p+=Math.abs(b-64).toString().padStart(2," ")),p+=r.chContr[i+M[93]].toString().padStart(3," ");let g=a.device.getChSource()[a.#m];g<128?(p+="ABCDEFGH"[g>>4],p+=((g&15)+1).toString().padStart(2,"0")):p+=`${"ABCDEFGH"[a.#m>>4]}--`,a.xgFont.getStr(p).forEach(function(S,x){S.forEach(function(R,A){let L=Math.floor(x/3)*90+x*5+A%5,N=Math.floor(A/5);N<7&&(a.#g[N*15+L+665]=R?a.#l:a.#r)})});let w=Math.ceil(Math.log2(o-f+1)-4),v=a.device?.getRawStrength();for(let S=0;S<k.ch;S++){a.#u[S]>0&&v[S]>0&&(a.#o[S]=v[S]);let x=r.strength[S],R=a.getChVoice(S),A=a.getProps(R),L=A?.scScale??256;switch(a.#f[S]=x*L>>8,A?.scSqr){case 16:{a.#f[S]=(a.#f[S]*L>>8)*a.#o[S]>>7;break}case 4:case 3:case 2:case 1:{for(let N=0;N<A?.scSqr;N++)a.#f[S]=a.#f[S]*a.#o[S]>>7;break}default:}}for(let S=0;S<k.ch;S++){let x=a.#f[S];if(u.peakHold===3&&a.#u[S]&&(a.#u[S]--,a.#d[S]=40,x!==a.#h[S]&&(a.#h[S]=x<<8)),x>>4<<4>a.#h[S]>>8)u.peakHold!==3&&a.#u[S]&&(a.#h[S]=x<<8,a.#d[S]=40);else if(a.#d[S]>>4)a.#d[S]>1?a.#d[S]-=1:a.#d[S]=0;else{let A;switch(u.peakHold){case 3:{if(a.#h[S]===0)break;A=a.#h[S]+(384<<w),A>65535&&(A=0);break}case 2:{A=0;break}case 1:case 0:{A=a.#h[S]-(384<<w),A<0&&(A=0);break}}a.#h[S]=A}}let $=a.#g.subarray(1400,1656);if(n<=r.bitmap.expire)r.bitmap.bitmap.forEach((S,x)=>{S&&($[x]=a.#l)});else{let S=0;for(let x=f;x<=o;x++){let R=S>>4,L=a.#f[x]>>4+w,N=a.#h[x]>>12+w;switch(w){case 2:{let O=4*(3-R);if(u.invBar)if(u.showBar)for(let X=L;X>=0;X--)$[(S&15)+(X+O<<4)]=a.#l;else $[(S&15)+(L+O<<4)]=a.#l;else if(u.showBar)for(let X=3-L;X<4;X++)$[(S&15)+(X+O<<4)]=a.#l;else $[(S&15)+(3-L+O<<4)]=a.#l;break}case 1:{let O=8*(1-R);if(u.invBar){if(u.showBar)for(let X=L;X>=0;X--)$[(S&15)+(X+O<<4)]=a.#l;else $[(S&15)+(O<<4)]=a.#l,L&&($[(S&15)+(L+O<<4)]=a.#l);u.peakHold&&N&&($[(S&15)+(N+O<<4)]=a.#l)}else{if(u.showBar)for(let X=7-L;X<8;X++)$[(S&15)+(X+O<<4)]=a.#l;else $[(S&15)+(7+O<<4)]=a.#l,L&&($[(S&15)+(7-L+O<<4)]=a.#l);u.peakHold&&N&&($[(S&15)+(7-N+O<<4)]=a.#l)}break}case 0:{if(u.invBar){if(u.showBar)for(let O=L;O>=0;O--)$[(S&15)+(O<<4)]=a.#l;else $[S&15]=a.#l,L&&($[(S&15)+(L<<4)]=a.#l);u.peakHold&&N&&($[S+(N<<4)]=a.#l)}else{if(u.showBar)for(let O=15-L;O<16;O++)$[(S&15)+(O<<4)]=a.#l;else $[(S&15)+240]=a.#l,L&&($[(S&15)+(15-L<<4)]=a.#l);u.peakHold&&N&&($[S+(15-N<<4)]=a.#l)}break}}S++}if(u.invDisp)for(let x=0;x<$.length;x++)$[x]=a.#l-$[x]}}a.#g.forEach((C,f)=>{if(a.#s[f]!==C)if(a.useBlur){let o=C-a.#s[f],s=80;Math.abs(o)>s?a.#s[f]+=Math.sign(o)*s:a.#s[f]=C}else a.#s[f]=C}),a.#s.forEach((C,f)=>{if(m||a.#i[f]!==C){let o,s,i=ea,l=ea;if(f<665){let h=f,c=h%95,p=Math.floor(h/95);o=y+133+c*$e,s=E+p*$e}else if(f<1400){let h=f-665,c=h>419?1:0,p=0,d=h%15+Math.floor(h%15/5),b=Math.floor(h%105/15);c?p=Math.floor((h-315)/105):p=Math.floor(h/105),o=y+Za*c+d*$e,s=E+ja*p+b*$e}else{let h=f-1400,c=h&15,p=Math.floor(h/16);o=y+302+c*ta,s=E+71+p*Wa,i=za,l=Qa}if(t.fillStyle=be.slice(0,7),t.fillRect(o,s,i,l),C<=a.#r)t.fillStyle=q.black[3];else if(C>=a.#l)t.fillStyle=q.black[4];else{let h=`${z.black}${(Math.ceil(C*z.range/255)+z.inactive).toString(16)}`;t.fillStyle=h}t.fillRect(o,s,i,l),self.pixelUpdates=(self.pixelUpdates||0)+1}}),a.#s.forEach((C,f)=>{a.#i[f]!==C&&(a.#i[f]=C)})}},ef=Ja;var tf=class extends ee{#t=new Uint8Array(5760);#a=new Uint8Array(5760);#l=new Uint8Array(5760);#r;#g=0;#s="?";#i=0;#n;#e=255;#c=0;#f=!0;#o=!1;useBlur=!1;#h=0;#d=0;#u=0;bootBm=new le;xgFont=new V("./data/bitmaps/xg/font.tsv");trueFont=new V("./data/bitmaps/korg/font.tsv","./data/bitmaps/xg/font.tsv");element=new le("./data/bitmaps/korg/element.tsv");constructor(e={}){super(new J,.1,.9);let t=this;t.#n=Ue,t.addEventListener("mode",r=>{t.#n={gs:be,sc:be,mt32:be,xg:te,ns5r:te,x5d:te,ag10:ut,"05rw":te,k11:te,gmlx:te,sg01:ut,sd:be,s90es:te,motif:te,doc:te,qy10:te,qy20:te}[r.data]||Ue,t.#s=r.data,t.#f=!0}),t.addEventListener("screen",r=>{console.debug(r),r.data.type==="ns5r"&&(t.#r=r.data.data,t.#g=Date.now()+1600)}),t.useBlur=!!e?.useBlur,t.addEventListener("channelactive",r=>{t.#i=r.data}),t.bootBm.load(`RsrcName	Bitmap
boot_0	0052001aff0ff07ff83fff81fc0fffc3fc7fff8ffff07f83fff0ff1fffe3fffc1fe0fffc3fcffffcffff87f83fff0ff3ffff3fdfe1ff0fffc3fcffffcfe3f87fc3fff0ff3fc7f3f8fe1ff0fffc3fcfe0fcfe3f87fe3fff0ff3f83f3f8fe1ff8fffc3fcfe0fcff7f07fe3ffffff3f83f3fffc1fbcffffffcfe0fcfffe07ef3ffffff3f83f3ffe01fbcffffffcfe0fcfffe07e7bffffff3f83f3fffe1f9effffffcfe0fcfe7f87e7bfff0ff3f83f3f9fe1f8ffffc3fcfe0fcfe7f87e3ffff0ff3f83f3f9fe1f8ffffc3fcff1fcfe7fc7e1ffff0ff3ffff3f8ff1f87fffc3fcffffcfe3fc7e1ffff0ff3ffff3f8ff1f83fffc3fc7fff8fe3fe7e0ffff0ff1fffe3f8ff9f83fffc3fc1ffe0fe1fe7e07f
boot_1	005f001a07c00f803fe001fff81fffe01fc01f01fff003fff07ffff03f803e07fff007ffe0fffff07f807c1ffff00fff81ffffe0ff01f83f8ff03fff03f00fe1fe03f0fc07e07c0007c00fc7fe07c1f807c0f8001f801f8ffc0f83f00f83f0003f003f1ff81f07f00007ff007e007e3ef87e0ff8000fff80f801fc7df0fc0ffc001fff81f01ff1fbf1f00ffe007fff07ffffe3f3e3e00fff00fc7f0fffff87c7c7c00fff01f07e1ffffe0f8fdf8007ff0000fc3ffff01f0fbe0003fe0000f87c3f807e1ffc0001fe0003f1f81f00fc1ff80000fc0007e3f03f01f03ff0fc01f8f80fc7e03f03e07fe1f803f1f81f0f807e07c07f83f00fc3f07e3f007e1f80ff03f83f83f3f87e00fc3f00fe07fffe07ffe0fc01f87c01fc07fff807ffc1f801f8f803f807ffe007fe03e003f1f003e003ff0007f00fc003f0
bs_0	000700073880000000000
bs_1	000700073888081020000
bs_2	0007000738080810288e0
bs_3	00070007388a0c18288e0
bs_4	00070007000a0c18288e0
bs_5	0007000700020408088e0
bs_6	000700070002040808000
bs_7	000700070000000000000`),(async()=>(await Promise.all([t.xgFont.loaded.wait(),t.trueFont.loaded.wait(),t.element.loaded.wait()]),t.#d=1))()}setCh(e){this.#i=e}getCh(){return this.#i}#E(e,t){let r=this;for(let n=0;n<180;n++){let m=n%12,u=Math.floor(n/12);u===0&&m<11||u===14&&m>0||u===13?r.#a[u*144+m+e]=r.#e:u>0&&u<13&&(m===0||m>9||m===5&&u>1&&u<12)&&(r.#a[u*144+m+e]=r.#e)}let a=t>>4;for(let n=0;n<21;n++){let m=n%7,u=Math.floor(n/7),y=u+(9-a);u!==1||m===0||m===6?r.#a[y*144+m+e+2]=r.#e:r.#a[y*144+m+e+2]=r.#c}}#m(e,t,r,a){let n=this;if(e=(e<0?Math.ceil:Math.floor)(e),t=(t<0?Math.ceil:Math.floor)(t),r=Math.round(r),a=Math.round(a),Math.abs(r)<Math.abs(a)){let m=r/a;if(a<0)for(let u=0;u>=a;u--)n.#a[Math.round(m*u+e)+(t+u)*144]=n.#e;else for(let u=0;u<=a;u++)n.#a[Math.round(m*u+e)+(t+u)*144]=n.#e}else{let m=a/r;if(r<0)for(let u=0;u>=r;u--)n.#a[Math.round(m*u+t)*144+e+u]=n.#e;else for(let u=0;u<=r;u++)n.#a[Math.round(m*u+t)*144+e+u]=n.#e}}#v(e,t,r){let a=this,n=7,m=40;for(let u=0;u<m;u++){let y=Math.PI*u*2/m,E=n*Math.sin(y),C=Math.sign(E)*Math.round(Math.abs(E)),f=n*Math.cos(y),o=Math.sign(f)*Math.round(Math.abs(f));a.#a[(o+t)*144+C+e]=a.#e}if(r<128){let u=Math.floor(r/9.85)*22.5,y=5,E=Math.PI*(315-u)/180,C=Math.sin(E),f=Math.cos(E);a.#m(e,t,C*y,f*y)}else a.#a[t*144+e]=a.#e}render(e,t,r){let a=super.render(e),n=this,m=Date.now();n.#u<500&&(n.#u%50===0&&(n.#f=!0),n.#u++);let u=!1,y=0,E=0;a.chInUse.forEach(function(s,i){s&&(u||(u=!0,y=i),E=i)}),y=y>>4<<4,E=(E>>4<<4)+15,n.#i>E&&(n.#i=y+n.#i&15),n.#i<y&&(n.#i=E-15+(n.#i&15));let f=n.#i*M.length;if(m<n.#g)n.#r?.forEach((s,i)=>{n.#a[i]=s?n.#e:n.#c});else if(n.#h<250||n.#d<1){let s=n.#h>150?1:0,i=n.bootBm.getBm(`boot_${s}`);i&&(n.#h<50||(n.#h<250?i.render((l,h,c)=>{let p=n.#h-50;p-=s*100,s?Math.abs(c-13)<<2<p&&(n.#a[h+25+(c+6)*144]=l?255:0):p||(n.#a[h+31+(c+6)*144]=l?255:0)}):n.bootBm.getBm(`bs_${n.#h-200>>3&7}`)?.render((l,h,c)=>{n.#a[h+136+(c+16)*144]=l?255:0})),n.#h++)}else{n.#a.forEach((b,g,w)=>{w[g]=n.#c});let s=r?n.trueFont:n.xgFont;s.getStr(`${"ABCDEFGH"[n.#i>>4]}${((n.#i&15)+1).toString().padStart(2,"0")}`).forEach((b,g)=>{let w=g*6+1;b.forEach((v,$)=>{let S=$%5,x=Math.floor($/5);n.#a[x*144+w+S]=v?n.#e:n.#c})});let i=n.device.getPitchShift(n.#i);s.getStr(`${"+-"[+(i<0)]}${Math.round(Math.abs(i)).toString().padStart(2,"0")}`).forEach((b,g)=>{let w=g*6+1;b.forEach((v,$)=>{let S=$%5,x=Math.floor($/5)+8;n.#a[x*144+w+S]=v?n.#e:n.#c})});let l=n.getChVoice(n.#i),h=l.sect;for(let b=0;b<225;b++){let g=b%25,w=Math.floor(b/25)+15;n.#a[w*144+g]=n.#e}s.getStr(h).forEach((b,g)=>{let w=g*6+1;b.forEach((v,$)=>{let S=$%5,x=Math.floor($/5)+16;v&&(n.#a[x*144+w+S]=n.#c)})});let c=n.getMapped(l.name).slice(0,12).padEnd(10," ");s.getStr(`:${(a.chProgr[n.#i]+1).toString().padStart(3,"0")}`).forEach((b,g)=>{let w=g*6+25;b.forEach((v,$)=>{let S=$%5,x=Math.floor($/5)+16;n.#a[x*144+w+S]=v?n.#e:n.#c})}),s.getStr(c).forEach((b,g)=>{let w=g*6+53;b.forEach((v,$)=>{let S=$%5,x=Math.floor($/5)+16;n.#a[x*144+w+S]=v?n.#e:n.#c})}),s.getStr(`${n.#i+1}`.padStart(2,"0")).forEach((b,g)=>{let w=g*6;b.forEach((v,$)=>{let S=$%5,x=Math.floor($/5)+32;n.#a[x*144+w+S]=v?n.#e:n.#c})});let p=22;E>63&&(p=43);for(let b=a.strength.length-1;b>=0;b--){let g=a.strength[b];if(!(E<32&&b>31)&&!(E<64&&b>63))for(let w=Math.floor(g/p);w>=0;w--){let v=b%32*4+12+(b>>5&1)+1,$=39-((b>>5&1)<<1)-w-(b>>6<<3);n.#a[$*144+v]=n.#e,n.#a[$*144+v+1]=n.#e,n.#a[$*144+v+2]=n.#e}}let d=n.device.aiEfxName.slice(0,7+ +r)||"Rev/Cho";if(s.getStr(r?`Fx A:001${d}`:`FxA:001${d}`).forEach((b,g)=>{let w=r?8:7,v=g%w*6+(r?95:102),$=Math.floor(g/w)*8;b.forEach((S,x)=>{let R=x%5,A=Math.floor(x/5)+$;n.#a[A*144+v+R]=S?n.#e:n.#c})}),m<a.letter.expire){let b=19+ +r*3;for(let g=0;g<2e3;g++){let w=g%100,v=Math.floor(g/100);(v===0&&w<99||v===18||v===19&&w>0)&&(n.#a[v*144+w+b]=n.#e),v>0&&v<18&&(n.#a[v*144+w+b]=+(w<1||w>97)?n.#e:n.#c)}s.getStr(a.letter.text).forEach((g,w)=>{let v=w%16*6+b+2,$=Math.floor(w/16)*8+2;g.forEach((S,x)=>{let R=x%5,A=Math.floor(x/5)+$;n.#a[A*144+v+R]=S?n.#e:n.#c})})}else{let b=r?2:0;n.#E(20+b,a.chContr[f+M[7]]),n.#E(33+b,a.chContr[f+M[11]]),r?a.chContr[f+M[10]]<128?n.element.getBm(`Pan_${Math.floor(a.chContr[f+M[10]]/9.85)}`)?.render((g,w,v)=>{n.#a[v*144+w+48]=g?n.#e:n.#c}):n.element.getBm("PanRndm")?.render((g,w,v)=>{n.#a[v*144+w+48]=g?n.#e:n.#c}):n.#v(53,7,a.chContr[f+M[10]]),n.#E(62+2*+r+b-+r,a.chContr[f+M[91]]),n.#E(75+2*+r+b-+r,a.chContr[f+M[93]]),r||n.#E(88,a.chContr[f+M[74]])}if(m<a.bitmap.expire){for(let g=0;g<777;g++){let w=g%37,v=Math.floor(g/37),$=w+78,S=v+19;(v===0&&w<36||v===19||v===20&&w>0)&&(n.#a[S*144+$]=n.#e),v>0&&v<19&&(n.#a[S*144+$]=+(w<1||w>34)?n.#e:n.#c)}let b=a.bitmap.bitmap.length>256?1:2;for(let g=0;g<512;g+=b){let w=g&31,v=g>>5,$=w+80,S=v+21,x=a.bitmap.bitmap[g>>b-1]?n.#e:n.#c;n.#a[S*144+$]=x,b===2&&(n.#a[S*144+$+1]=x)}}}let o=!1;if(n.#o!==r&&(n.#f=!0),n.#f){t.fillStyle=n.#n.replace("64",""),t.fillRect(0,0,t.canvas.width,t.canvas.height),t.textAlign="center",t.font='12px "Jost"',t.fillStyle="#000e",t.fillText("MIDI. CH",58,10),t.fillText("VOL",153.5+ +r*12,10),t.fillText("EXP",231.5+ +r*12,10),t.fillText("PAN",322.5+ +r*12,10),t.fillText("REV",405+ +r*18,10),t.fillText("CHO",484+ +r*18,10),!r&&t.fillText("BRT",561.5,10),t.fillText("EFFECT TYPE",738-+r*18,10),t.fillText("PART",34,262);let s=2*Math.PI;for(let i=1;i<33;i++)i===1||i===32||i%5===0?t.fillText(`${i}`,24*i+64,262):(t.beginPath(),t.ellipse(24*i+64,258,2,2,0,0,s),t.fill());o=!0,n.#f=!1}n.#a.forEach((s,i)=>{if(n.useBlur){let l=s-n.#l[i],h=48;Math.abs(l)>h?n.#l[i]+=Math.sign(l)*h:l!==0&&(n.#l[i]=s)}else n.#l[i]!==s&&(n.#l[i]=s)}),n.#l.forEach((s,i)=>{let l=i%144,h=Math.floor(i/144),c=n.#t[i]!==s;!o&&c&&(t.fillStyle=n.#n.slice(0,7),t.fillRect(6*l+1,12+6*h,6,6)),(o||c)&&(s>=n.#e?t.fillStyle=q.black[4]:s<=n.#c?t.fillStyle=q.black[3]:t.fillStyle=`${z.black}${(Math.ceil(s*z.range/255)+z.inactive).toString(16)}`,o&&(t.fillStyle=t.fillStyle.slice(0,7)),t.fillRect(6*l+1,12+6*h,5.5,5.5))}),n.#l.forEach((s,i)=>{n.#t[i]!==s&&(n.#t[i]=s)}),n.#o=r}},af=tf;var ff=400,aa=1e3,_=160,rf=64,ze=_*rf,fa=(e,t,r,a,n,m)=>{let u=r+n,y=a+m;for(let E=a;E<y;E++){let C=E*t;for(let f=r;f<u;f++)e[C+f]=e[C+f]?0:255}},Q=(e,t,r,a,n,m,u=255)=>{let y=r+n,E=a+m;for(let C=a;C<E;C++){let f=C*t;for(let o=r;o<y;o++)e[f+o]=u}},sf={"?":"  ",mt32:"mt",doc:"dc",qy10:"qy",qy20:"qy",ns5r:"n5",x5d:"xd","05rw":"rw",k11:"kg",krs:"kr",s90es:"es",motif:"es",trin:"tr"},lf=class extends ee{#t=255;#a=0;#l=0;#r=new Uint8Array(ze);#g=new Uint8Array(ze);#s=new Uint8Array(ze);#i=new Uint8Array(ze);#n=new Uint8Array(k.ch);#e=new Uint8Array(k.ch);#c=new Uint8Array(k.ch);#f=0;#o=0;#h=255;#d="?";useBlur=!1;#u=!1;#E=!1;#m=0;#v=0;#C=0;#p=0;#b=0;#L;font55=new V("./data/bitmaps/sc/libre55.tsv");font56=new V("./data/bitmaps/sc/libre56.tsv");bootBm=new le;sysBm=new le("./data/bitmaps/sc/system.tsv");font7a=new zt("./data/bitmaps/sc/libre7a.tsv");voxBm=new le("./data/bitmaps/sc/voices.tsv");constructor(e){super(new J,.25,.5);let t=this;t.useBlur=!!e?.useBlur,t.addEventListener("channelactive",r=>{t.#f=r.data}),t.addEventListener("portrange",r=>{r&&r.data!==1<<Math.log2(r.data)&&console.debug(`MU display rejected port range value ${r.data}.`),t.#o=r.data}),t.addEventListener("portstart",r=>{r!==255&&r>=k.port&&console.debug(`MU display rejected port range value ${r.data}.`),t.#h=r.data}),t.device.addEventListener("mode",r=>{t.#d=r.data}),t.device.addEventListener("mupromptex",()=>{t.#u=!0,D()&&console.debug("Scheduled a SysEx prompt.")}),t.device.addEventListener("reset",r=>{t.#C=0,t.#i.fill(0)}),t.device.addEventListener("screen",r=>{let a=r.data;if(a.type==="sc8850")for(let n=0;n<a.data.length;n++)t.#i[a.offset+n]=a.data[n]?255:0;t.#C=Date.now()+5e3}),t.device.addEventListener("letter",r=>{t.#L=t.#d}),t.device.addEventListener("note",r=>{if(r.data){let a=r.data;a.state===3&&a.velo&&(t.#c[a.part]=1)}}),t.bootBm.load(`RsrcName	Bitmap
boot_mr	009e003efffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00ffffffffffffffffe3ffffffffffffffffffe0007fffffffffffffff8ffffffffffffffffffe0000fffffe3ffffffffffffffffffffffffffff01e01fffff8ffffffffffffffffffffffffffff03ff07f83f007c0787e187f01ffffffffffffff83ffe0f003803800e1f8e3e003fffffffffffffe1fff83838787c18187c70f0607fffffffffffff07ffe0c3f3e3e1f861e3c787e1fffffffffffffc3fff863fff0f1fe1871e1c7f87ffffffffffffe0fffc10fffc787f8e18f8e1fe3fffffffffffff83fff0c7fff1e3fe3847e38ff8fffffffffffffe0fff831fff878ff0e03f0e3fc3fffffffffffffc1ff81c7f3e3e3f8781fc78fe1ffffffffffffff00f01f06070f8301e0fe1e0c07fffffffffffffe0000fe003c7e000f83f8f8003ffffffffffffffc000ffc07e1fe063e1fc3f818fffffffffffffffe01fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
bs_0	000700073880000000000
bs_1	000700073888081020000
bs_2	0007000738080810288e0
bs_3	00070007388a0c18288e0
bs_4	00070007000a0c18288e0
bs_5	0007000700020408088e0
bs_6	000700070002040808000
bs_7	000700070000000000000`),(async()=>(await Promise.all([t.font55.loaded.wait(),t.font56.loaded.wait(),t.font7a.loaded.wait()]),t.#p=1,await Promise.all([t.sysBm.loaded.wait(),t.voxBm.loaded.wait()]),t.#p=2))()}setCh(e){this.#f=e}getCh(){return this.#f}reset(){super.reset(),this.#o=0,this.#h=255,this.#e.fill(0)}render(e,t){let r=super.render(e),a=this,n=Date.now(),m=!1,u=a.device.modelEx.sc;if(n>=a.#C&&a.#r.fill(0),n-a.#l>=36e5&&(t.fillStyle=ne.orange,t.fillRect(0,0,808,t.canvas.height),t.fillStyle="#000",t.fillRect(808,0,t.canvas.width-808,t.canvas.height),t.fillStyle=ne.orange,t.textAlign="left",t.font='400 14px "Work Sans"',t.textRendering="geometricPrecision",t.fillText("EFX",810,121),t.fillText("8850",810,166),t.fillText("Pro",810,192),t.fillText("88",810,216),t.fillText("55",810,241),a.#l=n,m=!0),n<a.#C)a.#r.set(a.#i);else if(a.#p>0&&a.#b>99){a.#u&&(a.#u=!1,n-a.#v>ff?(a.#E=!0,D()&&console.debug("SysEx prompt submitted.")):D()&&console.debug("SysEx prompt too busy."),a.#m=n);let y=!1,E=0,C=0;r.chInUse.forEach(function(b,g){b&&(y||(y=!0,E=g),C=g)}),E=E>>4<<4,C=(C>>4<<4)+15,a.#f>C&&(a.#f=E+a.#f&15),a.#f<E&&(a.#f=C-15+(a.#f&15)),a.#o&&(a.#h===255?E=Math.floor((a.#f>>4)/a.#o)*a.#o<<4:E=a.#h<<4,C=E+a.#o*16-1);let o=a.#f*M.length,s=Math.ceil(Math.log2(C-E+1)-4);a.font56.getStr(`${"ABCDEFGH"[a.#f>>4]}${`${(a.#f&15)+1}`.padStart(2,"0")}`).forEach((b,g)=>{let w=g*6+1;b.forEach((v,$)=>{let S=$%5+w,x=Math.floor($/5)+2;v&&(a.#r[x*_+S]=255)})});let i=a.getChVoice(a.#f),l=a.#L==="gs"||a.#L==="sc",h=0;if(l&&r.letter.set<=n&&n<r.letter.set+15e3)if(r.letter.text.length<=16)h=n<r.letter.expire?1:0;else{let b=r.letter.set+Math.min(19+r.letter.text.length,51)*300;h=n<b?2:0}if(!l||h===0)a.font56.getStr(i.bank).forEach((b,g)=>{let w=g*6+21;b.forEach((v,$)=>{let S=$%5+w,x=Math.floor($/5)+2;v&&(a.#r[x*_+S]=255)})}),a.font56.getStr(`${r.chProgr[this.#f]+1}`.padStart(3,"0")).forEach((b,g)=>{let w=g*6+43;b.forEach((v,$)=>{let S=$%5+w,x=Math.floor($/5)+2;v&&(a.#r[x*_+S]=255)})}),fa(a.#r,_,42,1,19,8),a.font7a.getStr(a.getMapped(i.name).slice(0,12).padEnd(12," ")).forEach((b,g)=>{let w=g*8;b.forEach((v,$)=>{let S=$%11+w+63,x=Math.floor($/11);v&&(a.#r[x*_+S]=255)})});else{let b;switch(h){case 1:{b=r.letter.text;break}case 2:{let g=a.getMapped(i.name).padEnd(12," ");b=`    ${g}<${r.letter.text}<    ${g}`;let w=Math.floor((n-r.letter.set)/300);b=b.substring(w,w+16);break}}h!==0&&a.font7a.getStr(b).forEach((g,w)=>{let v=w*8;g.forEach(($,S)=>{let x=S%11+v+31,R=Math.floor(S/11);$&&(a.#r[R*_+x]=255)})})}switch(a.getChBm(a.#f,i)?.render((b,g,w)=>{a.#r[(w+18)*_+g+2]=b?255:0}),s){case 0:{let b=a.#f>>6<<2,g=a.#f>>4,w=+!(b>>6&1);for(let v=0;v<4;v++){let $=b+v,S=v*40+2+w,x=$===g?59:58;a.font55.getStr(`PART-${"ABCDEFGH"[$]}`).forEach((R,A)=>{let L=A*6;R.forEach((N,O)=>{let X=O%5+L+S,ue=Math.floor(O/5)+x;N&&(a.#r[ue*_+X]=255)})}),a.sysBm.getBm($===g?"tabSel":"tabIdle")?.render((R,A,L)=>{if(R){let N=40*v+A+w+(L+57)*_;a.#r[N]=a.#r[N]?0:255}})}break}case 1:case 2:case 3:{let b=a.#f>>4;for(let g=0;g<4;g++){let w=g*40+2,v=s===g?59:58,$=g===3?"128CH":`${16<<g}CH-${"ABCDEFGH"[E>>4]}`;a.font55.getStr($).forEach((S,x)=>{let R=x*6;S.forEach((A,L)=>{let N=L%5+R+w,O=Math.floor(L/5)+v;A&&(a.#r[O*_+N]=255)})}),a.sysBm.getBm(s===g?"tabSel":"tabIdle")?.render((S,x,R)=>{if(S){let A=40*g+x+(R+57)*_;a.#r[A]=a.#r[A]?0:255}})}break}}switch((n>=r.letter.expire||a.#L==="gs"||a.#L==="sc")&&a.font56.getStr("123456789").forEach((b,g)=>{let w=g*6;b.forEach((v,$)=>{let S=$%5+w+49,x=Math.floor($/5)+49;v&&(a.#r[x*_+S]=255)})}),a.#d){case"?":case"gs":case"sc":case"gm":break;default:{let b=(sf[a.device.getChMode(a.#f)]||a.device.getChMode(a.#f)).toUpperCase();a.font56.getStr(b).forEach((w,v)=>{let $=v*6;w.forEach((S,x)=>{let R=x%5+$+148,A=Math.floor(x/5)+49;S&&(a.#r[A*_+R]=255)})}),i.standard!=="GM"&&b!==i.standard&&a.font56.getStr(i.standard).forEach((w,v)=>{let $=v*6;w.forEach((S,x)=>{let R=x%5+$+148,A=Math.floor(x/5)+42;S&&(a.#r[A*_+R]=255)})}),a.#E&&(a.#E=!1,a.#v=n,D()&&console.debug("SysEx prompt resolved."));let g=n-a.#v;g<=aa&&!(Math.floor(g/aa*5)&1)&&a.font56.getStr("Ex").forEach((w,v)=>{let $=v*6;w.forEach((S,x)=>{let R=x%5+$+148,A=Math.floor(x/5)+35;S&&(a.#r[A*_+R]=255)})});break}}let c=1<<s,p=(35-c+1)/c,d=256/p;if(r.velo.forEach(function(b,g){if(u.peakHold===3&&a.#c[g]&&(a.#c[g]--,a.#e[g]=127,b!==a.#n[g]&&(a.#n[g]=b)),b>a.#n[g])u.peakHold!==3&&a.#c[g]&&(a.#n[g]=b,a.#e[g]=127);else if(a.#e[g]>>4)a.#e[g]-=6;else{let v;switch(u.peakHold){case 3:{if(a.#n[g]===0)break;v=a.#n[g]+2*c,v>255&&(v=0);break}case 2:{v=0;break}case 1:case 0:{v=a.#n[g]-4*c,v<0&&(v=0);break}}a.#n[g]=v}}),n<r.bitmap.expire){let b=r.bitmap.bitmap.length>256?1:2;for(let g=0;g<512;g+=b){let w=g&31,v=g>>5,$=w*3+49,S=(v<<1)+15,x=r.bitmap.bitmap[g>>b-1]?a.#t:a.#a;Q(a.#r,_,$,S,2,2,x),b===2&&Q(a.#r,_,$+2,S,3,2,x)}}else{for(let b=0;b<c;b++){let g=E+(b<<4);for(let w=0;w<16;w++){let v=g+w,$=Math.floor(r.strength[v]/d)+1;if(u.showBar?u.invBar?Q(a.#r,_,49+6*w,13+b*p+b,5,$):Q(a.#r,_,49+6*w,48-b*p-$-b,5,$):u.invBar?(Q(a.#r,_,49+6*w,12+b*p+$+b,5,1),$&&Q(a.#r,_,49+6*w,13+b,5,1)):(Q(a.#r,_,49+6*w,48-b*p-$-b,5,1),$&&Q(a.#r,_,49+6*w,47-b,5,1)),u.peakHold){let S=Math.floor(a.#n[v]/d)+1;u.invBar?S&&Q(a.#r,_,49+6*w,12+b*p+S+b,5,1):S&&Q(a.#r,_,49+6*w,48-b*p-S-b,5,1)}}}u.invDisp&&fa(a.#r,_,48,12,97,44)}if(n<r.letter.expire)switch(a.#L){case"gs":case"sc":break;default:Q(a.#r,_,48,57,97,6,0),Q(a.#r,_,47,63,99,1,255),Q(a.#r,_,47,47,1,16,255),Q(a.#r,_,145,47,1,16,255),a.font56.getStr(r.letter.text).forEach((b,g)=>{let w=(g&15)*6;b.forEach((v,$)=>{let S=$%5+w+49,x=Math.floor($/5)+49+7*(g>>4);v&&(a.#r[x*_+S]=255)})})}if(a.device.getEffectSink()[a.#f]){let b=153,g=19;a.sysBm.getBm("efxOn")?.render((w,v,$)=>{w&&(a.#r[b+v+($+g)*_]=255)})}switch(a.device.getChMode(a.#f)){case"gs":case"sc":{let b=a.getChPrimitive(a.#f,2,!0);if(b>0&&b<5){let g=153,w=48-b*5;a.sysBm.getBm("bankSel")?.render((v,$,S)=>{v&&(a.#r[g+$+(S+w)*_]=255)})}break}}}else if(a.#b>49){let y=a.bootBm?.getBm("boot_mr");y&&(y.render((E,C,f)=>{a.#r[C+1+(f+1)*160]=E?255:0}),a.#b++)}else a.#b++;if(a.#b>99&&a.#p<2){let y=a.bootBm?.getBm(`bs_${a.#b-50>>3&7}`);y&&(y.render((E,C,f)=>{E&&(a.#r[C+151+(f+11)*160]=a.#r[C+152+(f+11)*160]?0:255)}),a.#p&&a.#b++)}a.#r.forEach((y,E)=>{if(a.#g[E]!==y)if(a.useBlur){let C=y-a.#g[E],f=48;Math.abs(C)>f?a.#g[E]+=Math.sign(C)*f:a.#g[E]=y}else a.#g[E]=y}),a.#g.forEach((y,E)=>{let C=E%_,f=Math.floor(E/_);if(m||a.#s[E]!==y){let o=4+5*C,s=4+5*f;t.clearRect(o,s,5,5),t.fillStyle=ne.orange,t.fillRect(o,s,5,5),y<=a.#a?t.fillStyle=q.black[3]:y>=a.#t?t.fillStyle=q.black[4]:t.fillStyle=`${z.black}${(Math.ceil(y*z.range/255)+z.inactive).toString(16)}`,t.fillRect(o,s,4.5,4.5),self.pixelUpdates=(self.pixelUpdates||0)+1}}),a.#g.forEach((y,E)=>{a.#s[E]!==y&&(a.#s[E]=y)})}},nf=lf;var of=class extends ee{#t=new Uint8Array(8192);#a=new Uint8Array(8192);#l="?";#r=0;#g=!0;#s=Ue;#i=0;#n=0;#e=new Uint8Array(256);songTitle="";xgFont=new V("./data/bitmaps/xg/font.tsv");qyFont=new V("./data/bitmaps/xg/qyTrue.tsv","./data/bitmaps/xg/font.tsv");sqrFont=new V("./data/bitmaps/xg/qySqr.tsv");qy35Font=new V("./data/bitmaps/xg/qyCh35.tsv");qy55Font=new V("./data/bitmaps/xg/qyCh55.tsv");qyRsrc=new le("./data/bitmaps/xg/qyRsrc.tsv");sysBm=new se("./data/bitmaps/xg/system.tsv");voxBm=new se("./data/bitmaps/xg/voices.tsv");constructor(){super(new J,0,.95);let e=this;e.addEventListener("mode",function(t){(e.sysBm.getBm(`st_${{gm:"gm1",g2:"gm2","?":"gm1",ns5r:"korg",ag10:"korg",x5d:"korg","05rw":"korg",krs:"korg",sg:"gm1",k11:"gm1",sd:"gm2",sc:"gs"}[t.data]||t.data}`)||[]).forEach(function(r,a){e.#e[a]=r}),e.#i=2,e.#n=Date.now()+1600}),e.addEventListener("channelactive",t=>{e.#r=t.data})}setCh(e){this.#r=e}getCh(){return this.#r}#c(e,t,r,a){let n=r*a,m=e+t*128;for(let u=0;u<n;u++){let y=u%r,E=Math.floor(u/r);(y===0&&E<a-1||E===0&&y<r-1||y===r-1&&E>0||E===a-1&&y>0||y===r-2)&&(this.#a[m+y+E*128]=1)}}#f(e,t,r,a,n=1){let m=r*a,u=e+t*128;for(let y=0;y<m;y++){let E=y%r,C=Math.floor(y/r);this.#a[u+E+C*128]=n}}#o(e,t,r,a,n=1){let m=!n,u=e+t*128,y=r*a;for(let E=0;E<y;E++){let C=E%r,f=Math.floor(E/r);C===0&&f>0&&r%2===0||(m=!m),this.#a[u+C+f*128]=+m}}#h(e,t,r=64){r<128&&this.qyRsrc.getBm(`Pan_${((r+4)*7282>>16).toString(16)}`)?.render((a,n,m)=>{a&&(this.#a[e+n+(m+t)*128-259]=1)})}#d(e,t,r){let a=this.getChVoice(e),n;if(["GM","AG","XG","GS","G2"].indexOf(a.standard)>-1)switch(t){case 64:{n="sfx";break}case 120:case 122:case 126:case 127:{n="dr";break}default:n=(r>>3).toString(16)}else n=a.standard,n=`${n[0]}${n[1].toLowerCase()}`;return n}render(e,t,r,a=0,n=!1){let m=super.render(e),u=this,y=Date.now(),E=n?this.qyFont:this.xgFont,C=!1,f=0,o=0;m.chInUse.forEach(function(h,c){h&&(C||(C=!0,f=c),o=c)}),f=f>>4<<4,o=(o>>4<<4)+15,this.#r>o&&(this.#r=f+this.#r&15),this.#r<f&&(this.#r=o-15+(this.#r&15));let i=this.#r*M.length;if(this.#a.forEach((h,c,p)=>{p[c]=0}),r){u.qyRsrc.getBm("MixPill")?.render((g,w,v)=>{g&&(u.#a[w+(v<<7)]=1)}),u.qyRsrc.getBm("MixIcon")?.render((g,w,v)=>{g&&(u.#a[10+w+(v<<7)]=1)}),u.qyRsrc.getBm("MsVoice")?.render((g,w,v)=>{u.#a[2176+w+(v<<7)]=g}),u.qyRsrc.getBm("ElPan")?.render((g,w,v)=>{u.#a[4096+w+(v<<7)]=g}),u.qyRsrc.getBm("ElVol")?.render((g,w,v)=>{u.#a[4864+w+(v<<7)]=g}),u.qyRsrc.getBm("ElMsPa")?.render((g,w,v)=>{u.#a[5634+w+(v<<7)]=g}),u.#o(0,50,5,14,1),u.#f(5,50,1,14),u.#o(7,50,10,14,0),u.#f(10,52,1,10),u.#f(11,52,1,10,0),u.#f(17,50,1,14),u.#o(19,50,10,14,0),u.#f(22,52,1,10),u.#f(23,52,1,10,0);let h=9-(m.master.volume*6489>>16);u.qyRsrc.getBm("VolSlid")?.render((g,w,v)=>{u.#a[7+w+(50+h+v<<7)]=g}),u.#f(8,53+h,8,1),u.qyRsrc.getBm("VolSlid")?.render((g,w,v)=>{u.#a[6419+w+(v<<7)]=g}),u.#f(20,53,8,1),u.#f(29,24,1,40);let c=u.getChVoice(u.#r),p=u.device.getChPrimitives(u.#r);E.getStr(`${(m.chProgr[u.#r]+1).toString().padStart(3,"0")}${"+ "[+(["GM","MT","AG"].indexOf(c.standard)>-1||p[0]>=120)]}${c.name.slice(0,8)}`).forEach((g,w)=>{g.render((v,$,S)=>{u.#a[55+$+w*6+(S<<7)]=v})});let d=u.#d(u.#r,m.chContr[u.#r*M.length],m.chProgr[u.#r]),b=u.qyRsrc.getBm(`Vox_${d}`);b?b.render((g,w,v)=>{u.#a[37+w+(v<<7)]=g}):E.getStr(d).forEach((g,w)=>{g.render((v,$,S)=>{u.#a[37+$+w*6+(S<<7)]=v})})}else{if(u.qyRsrc.getBm("NorPill")?.render((p,d,b)=>{p&&(u.#a[d+(b<<7)]=1)}),E.getStr("SONG").forEach((p,d)=>{p.render((b,g,w)=>{b&&(u.#a[5+g+d*6+(w<<7)]=0)})}),u.#c(34,6,65,11),u.#f(35,7,13,9),u.#c(100,6,28,11),m.letter.expire<y){if(E.getStr(`${a+1}`.padStart(2,"0")).forEach((p,d)=>{p.render((b,g,w)=>{b&&(u.#a[1060+g+d*6+(w<<7)]=0)})}),u.songTitle.length<9)E.getStr(u.songTitle||"Unknown").forEach((p,d)=>{p.render((b,g,w)=>{u.#a[1073+g+d*6+(w<<7)]=b})});else{let p=u.songTitle;for(;p.indexOf("  ")>-1;)p=p.replaceAll("  "," ");let d=Math.floor(e*25)%(6*(10+p.length))-47;E.getStr(`${p}  ${p.slice(0,8)}`).forEach((b,g)=>{b.render((w,v,$)=>{let S=v+g*6,x=d;d<0&&(x=d>=-48?0:d+48),S>=x&&S<x+47&&(u.#a[1073-x+S+($<<7)]=w)})})}{let p=m.noteBeat%1;u.sqrFont.getStr(`${"$%"[+(p>0&&p<=.25)]}${(m.noteBar+1).toString().padStart(3,"0")}`).forEach((d,b)=>{d.render((g,w,v)=>{u.#a[1126+w+b*6+(v<<7)]=g})})}}u.sqrFont.getStr(`&=${Math.round(m.tempo).toString().padStart(3,"0")}`).forEach((p,d)=>{p.render((b,g,w)=>{u.#a[2048+g+d*6+(w<<7)]=b})}),E.getStr(`${m.tSig[0].toString().padStart(2," ")}/${m.tSig[1].toString().padEnd(2," ")}`).forEach((p,d)=>{p.render((b,g,w)=>{u.#a[3072+g+d*6+(w<<7)]=b})}),u.qyRsrc.getBm("Vtfj")?.render((p,d,b)=>{u.#a[2338+d+(b<<7)]=p});{let p=u.device.getPitchShift(u.#r),d=p<0?"-":"+";d+=`${Math.round(Math.abs(p))}`.padStart(2,"0"),E.getStr(d).forEach((b,g)=>{b.render((w,v,$)=>{u.#a[3127+v+g*6+($<<7)]=w})})}E.getStr("001").forEach((p,d)=>{p.render((b,g,w)=>{u.#a[3181+g+d*6+(w<<7)]=b})}),u.#f(71,48,1,16),u.qyRsrc.getBm("Mod_Usr")?.render((p,d,b)=>{u.#a[6253+d+(b<<7)]=p});let h=u.device.getChPrimitives(u.#r);{let p=u.getChVoice(this.#r);E.getStr(`${h[0].toString().padStart(3,"0")} ${h[1].toString().padStart(3,"0")} ${h[2].toString().padStart(3,"0")}`).forEach((d,b)=>{d.render((g,w,v)=>{u.#a[6145+6*b+w+(v<<7)]=g})}),E.getStr(`${p.standard}:${p.name.slice(0,8)}`).forEach((d,b)=>{d.render((g,w,v)=>{u.#a[7169+6*b+w+(v<<7)]=g})})}let c;if(y<m.bitmap.expire)c=m.bitmap.bitmap;else if(c=this.#e.slice(),y>=this.#n){this.#i=0;let p=u.getChVoice(this.#r).standard.toLowerCase();c=this.voxBm.getBm(u.getChVoice(this.#r).name)||this.voxBm.getBm(u.getVoice(h[0],h[1],0,m.mode).name),["an","ap","dr","dx","pc","pf","sg","vl"].indexOf(p)>-1&&(c=this.sysBm.getBm(`ext_${p}`)),!c&&(h[0]<48||m.chContr[i+M[0]]===56)&&(c=this.voxBm.getBm(u.getVoice(0,m.chProgr[this.#r],0,m.mode).name)),!c&&h[0]===126&&(c=this.sysBm.getBm("cat_smpl")),!c&&h[0]===64&&(c=this.sysBm.getBm("cat_sfx")),c||(c=this.sysBm.getBm("no_abm"))}else this.#i===2&&c.forEach((p,d,b)=>{let g=Math.floor((this.#n-y)/400);b[d]=(g&1)===p});c&&(c.width=c.length>>4),c?.render((p,d,b)=>{c.width<32?(u.#a[6217+(d<<1)+(b<<7)]=p,u.#a[6218+(d<<1)+(b<<7)]=p):u.#a[6217+d+(b<<7)]=p})}{let h=this.#r>>3,c=r?1310:4254,p=r?10:33;r?(u.#f(28,p-1,99,15),u.#f(29,p,97,13,0)):u.#c(0,p-1,128,15),h<o>>3&&u.qyRsrc.getBm(`ArrowR${+r+1}`)?.render((d,b,g)=>{u.#a[c+735+b+(g<<7)]=d}),h>f>>3&&u.qyRsrc.getBm(`ArrowL${+r+1}`)?.render((d,b,g)=>{u.#a[c+610+ +r*27+b+(g<<7)]=d}),r||(u.qyRsrc.getBm("PtCdTm")?.render((d,b,g)=>{u.#a[4227+b+(g<<7)]=d}),m.tempo!==120&&u.qyRsrc.getBm("ActPill")?.render((d,b,g)=>{u.#a[5141+b+(g<<7)]=d}));for(let d=0;d<8;d++){let b=(h<<3)+d,g=1,w=d*12;if(u.qyRsrc.getBm("CTabOff")?.render((v,$,S)=>{u.#a[c+w+$+(S<<7)]=v}),m.chInUse[b]){let v=m.strength[b]*1286>>16;u.#f(31+w,p+11-v,9,v+1)}if(this.#r===b&&(g=0,u.#f(31+w,p,9,5),r&&u.#f(30+w,p+14,13,8)),b<19?u.qy55Font.getStr(String.fromCharCode(48+b))[0].render((v,$,S)=>{v&&(u.#a[c+3+w+$+(S<<7)]=g)}):u.qy35Font.getStr((b+1).toString()).forEach((v,$)=>{v.render((S,x,R)=>{S&&(u.#a[c+2+4*$+w+x+(R<<7)]=g)})}),r){u.#o(31+w,32,10,32,0),u.#f(41+w,32,1,32),u.#f(34+w,43,1,18),u.#f(35+w,45,1,16,0),u.#f(31+w,63,10,1),u.qyRsrc.getBm("PanIcon")?.render((R,A,L)=>{u.#a[4255+w+A+(L<<7)]=R}),u.#h(w+35,36,m.chContr[b*M.length+M[10]]);let v=15-(m.chContr[b*M.length+M[7]]>>3);u.qyRsrc.getBm("VolSlid")?.render((R,A,L)=>{u.#a[5535+w+A+(v+L<<7)]=R}),u.#f(32+w,46+v,8,1);let $=u.device.getChType()[b],S=u.#d(b,m.chContr[b*M.length],m.chProgr[b]),x=u.qyRsrc.getBm(`Vox_${[`${S}`,"dr","ds1","ds2","ds3","ds4","ds5","ds6","ds7","ds8"][$]}`);x?x.render((R,A,L)=>{R&&(u.#a[3103+w+A+(L<<7)]=g)}):E.getStr(S).forEach((R,A)=>{R.render((L,N,O)=>{L&&(u.#a[3103+w+N+A*6+(O<<7)]=g)})})}}}y<=m.letter.expire&&(u.qyRsrc.getBm("TxtDisp")?.render((h,c,p)=>{u.#a[(r?655:1036)+c+(p<<7)]=h}),E.getStr(m.letter.text).forEach((h,c)=>{let p=c%16*6,d=c>>4;h.render((b,g,w)=>{u.#a[(r?1686:2067)+p+g+(w+(d<<3)<<7)]=b})}));let l=!1;this.#g&&(t.fillStyle=this.#s.replace("64",""),t.fillRect(0,0,t.canvas.width,t.canvas.height),l=!0,this.#g=!1),this.#a.forEach((h,c)=>{let p=c&127,d=c>>7,b=this.#t[c]!==h;!l&&b&&(t.fillStyle=this.#s.slice(0,7),t.fillRect(6*p+7,7+(d<<3),6,8)),(l||b)&&(t.fillStyle=q.black[h+3],l&&(t.fillStyle=t.fillStyle.slice(0,7)),t.fillRect(6*p+7,7+(d<<3),5.5,7.5))}),this.#a.forEach((h,c)=>{this.#t[c]!==h&&(this.#t[c]=h)})}},cf=of;var hf=class extends ee{#t=new Uint8Array(61);#a=new Uint8Array(22);#l=new Uint8Array(15);#r=new Uint8Array(256);#g=0;#s=0;#i=0;#n=0;#e=0;#c=0;#f=0;#o="";#h="        ";xgFont=new V("./data/bitmaps/xg/font.tsv");trueFont=new V("./data/bitmaps/korg/font.tsv","./data/bitmaps/xg/font.tsv");sysBm=new se("./data/bitmaps/xg/system.tsv");voxBm=new se("./data/bitmaps/xg/voices.tsv");aniBm=new se("./data/bitmaps/xg/animation.tsv");clefs=new Path2D("M110 163.5c0 -3.9 3.2 -7.1 7.1 -7.1s7.1 3.2 7.1 7.1s-3.2 7.1 -7.1 7.1s-7.1 -3.2 -7.1 -7.1zM110 128.5c0 -3.9 3.2 -7.1 7.1 -7.1s7.1 3.2 7.1 7.1s-3.2 7.1 -7.1 7.1s-7.1 -3.2 -7.1 -7.1zM64.5 109.2c24.1 0 41 12.3 41 35.1c0 36.8 -36.8 58 -72.2 72.9c-0.4 0.4 -0.8 0.6 -1.3 0.6c-1 0 -1.8 -0.8 -1.8 -1.8c0 -0.4 0.1 -0.8 0.6 -1.3c28.3 -16.5 57.7 -37.1 57.7 -69c0 -16.8 -8.8 -32.9 -23.9 -32.9c-10.4 0 -18.1 7.6 -21.6 17.6c1.5 -0.7 3.1 -1.1 4.8 -1.1c7.7 0 14 6.3 14 14c0 8.1 -6.2 14.8 -14 14.8c-8.4 0 -15.7 -6.6 -15.7 -14.8c0 -18.6 14.3 -34.2 32.5 -34.2z M408.6 181.3c0.6 0 1.3 -0.1 1.8 -0.1c21.7 0 35.8 17.9 35.8 36.5c0 10.6 -4.6 21.6 -15 29.4c-3.1 2.4 -6.6 3.9 -10.2 5c0.4 4.9 0.7 9.8 0.7 14.7c0 2.7 -0.1 5.5 -0.3 8.1c-1 16.8 -12.6 31.9 -29.1 31.9c-15.1 0 -27.3 -12.3 -27.3 -27.6c0 -8.1 7.4 -14.4 15.7 -14.4c7.6 0 13.3 6.6 13.3 14.4c0 7.3 -6 13.3 -13.3 13.3 c-1.5 0 -2.9 -0.3 -4.3 -0.8c3.6 5.5 9.5 9.1 16.4 9.1c13.4 0 22 -12.9 22.8 -26.7c0.1 -2.5 0.3 -5.2 0.3 -7.7c0 -4.3 -0.1 -8.5 -0.6 -12.9c-4.1 0.7 -8.1 1.1 -12.5 1.1c-26.3 0 -46.6 -24.1 -46.6 -52.4c0 -24.8 18.3 -42.8 34.7 -61.7c-2.7 -8.7 -5.2 -17.5 -6.3 -26.6c-0.8 -7.3 -1 -14.6 -1 -21.8c0 -16.1 7.7 -31.4 20.9 -40.9c0.4 -0.3 1 -0.4 1.4 -0.4c0.6 0 1 0 1.4 0.4 c9.9 11.8 18.6 34.3 18.6 50.1c0 20 -12 35.7 -25.2 51c2.9 9.5 5.5 19.3 7.8 29zM420.5 246.4c9.5 -3.4 15.8 -13.3 15.8 -23c0 -12.6 -9.2 -25.1 -24.2 -26.6c3.4 16.2 6.4 32.3 8.4 49.6zM366.4 214.1c0 18.9 18.1 34.6 37 34.6c3.9 0 7.7 -0.3 11.5 -0.8c-2 -17.8 -5.2 -34.3 -8.8 -51c-11.1 1.1 -17.4 8.5 -17.4 16.7 c0 6.2 3.5 12.7 11.3 17.2c0.7 0.7 1 1.4 1 2.1c0 1.5 -1.4 3.1 -3.1 3.1c-0.4 0 -0.8 -0.1 -1.3 -0.3c-11.2 -6 -16.4 -16.1 -16.4 -25.9c0 -12.3 8.1 -24.4 22.4 -27.6c-2 -8.1 -4.1 -16.4 -6.4 -24.5c-15 16.9 -29.8 34 -29.8 56.4zM413.1 71.7c-13.9 6.7 -22.7 20.9 -22.7 36.3c0 10.4 2.5 18.6 5 27.2 c11.2 -13.6 20.4 -27.7 20.4 -45.4c0 -7.7 -0.6 -11.1 -2.8 -18.1z");keyboard=new Path2D("M224 318 L380 318 L380 380 L224 380 Z M246 350 L246 380 M268 350 L268 380 M291 318 L291 380 M313 350 L313 380 M335 350 L335 380 M358 350 L358 380 M235 318 L235 350 L254 350 L254 318 M260 318 L260 350 L279 350 L279 318 M301 318 L301 350 L320 350 L320 318 M326 318 L326 350 L345 350 L345 318 M350 318 L350 350 L370 350 L370 318 M387 318 L543 318 L543 380 L387 380 Z M409 350 L409 380 M431 350 L431 380 M454 318 L454 380 M476 350 L476 380 M498 350 L498 380 M521 350 L521 380 M398 318 L398 350 L417 350 L417 318 M423 318 L423 350 L442 350 L442 318 M464 318 L464 350 L483 350 L483 318 M489 318 L489 350 L508 350 L508 318 M513 318 L513 350 L533 350 L533 318 M550 318 L706 318 L706 380 L550 380 Z M572 350 L572 380 M594 350 L594 380 M617 318 L617 380 M639 350 L639 380 M661 350 L661 380 M684 350 L684 380 M561 318 L561 350 L580 350 L580 318 M586 318 L586 350 L605 350 L605 318 M627 318 L627 350 L646 350 L646 318 M652 318 L652 350 L671 350 L671 318 M676 318 L676 350 L696 350 L696 318 M713 318 L869 318 L869 380 L713 380 Z M735 350 L735 380 M757 350 L757 380 M780 318 L780 380 M802 350 L802 380 M824 350 L824 380 M847 350 L847 380 M724 318 L724 350 L743 350 L743 318 M749 318 L749 350 L768 350 L768 318 M790 318 L790 350 L809 350 L809 318 M815 318 L815 350 L834 350 L834 318 M839 318 L839 350 L859 350 L859 318 M876 318 L1032 318 L1032 380 L876 380 Z M898 350 L898 380 M920 350 L920 380 M943 318 L943 380 M965 350 L965 380 M987 350 L987 380 M1010 350 L1010 380 M887 318 L887 350 L906 350 L906 318 M912 318 L912 350 L931 350 L931 318 M953 318 L953 350 L972 350 L972 318 M978 318 L978 350 L997 350 L997 318 M1002 318 L1002 350 L1022 350 L1022 318 M1032 318 L1055 318 L1055 380 L1032 380");bracket=new Path2D("M83 23 L49 23 L49 86 L83 86 M264 23 L297 23 L297 86 L264 86");staffLines=new Path2D("M30 110 L344 110 M356 110 L1074 110 M30 146 L344 146 M356 146 L1074 146 M30 182 L344 182 M356 182 L1074 182 M30 218 L344 218 M356 218 L1074 218 M30 254 L344 254 M356 254 L775 254 M894 254 L1074 254");downbeatStar=new Path2D("m 160.263,824.43605 c 0.939,1.039 1.482,2.434 1.482,3.833 0,1.402 -0.543,2.796 -1.482,3.834 1.038,-0.944 2.43,-1.483 3.837,-1.483 1.398,0 2.791,0.539 3.828,1.483 -0.948,-1.038 -1.482,-2.432 -1.482,-3.834 0,-1.399 0.534,-2.794 1.482,-3.833 -1.037,0.945 -2.43,1.483 -3.828,1.483 -1.407,0 -2.799,-0.538 -3.837,-1.483");downbeatHand=new Path2D("m 166.418,820.55105 c 0.13,0 0.253,-0.054 0.351,-0.143 0.089,-0.094 0.143,-0.223 0.143,-0.351 v -1.969 l 1.847,-6.897 c 0.706,-2.627 0.966,-5.371 0.78,-8.09 l -0.184,-2.644 1.188,-2.055 h -5.175 l -1.268,3.499 -1.278,-3.499 h -5.171 l 1.185,2.055 -0.185,2.644 c -0.185,2.719 0.076,5.463 0.782,8.09 l 1.847,6.897 v 1.969 c 0,0.128 0.054,0.257 0.145,0.351 0.089,0.089 0.218,0.143 0.348,0.143 h 0.214 c 0.423,0 0.841,-0.11 1.213,-0.321 0.364,-0.204 0.68,-0.509 0.9,-0.871 0.213,0.362 0.527,0.667 0.89,0.871 0.373,0.211 0.79,0.321 1.208,0.321 h 0.22 m -0.22,-1.304 c 0,0.111 -0.034,0.217 -0.095,0.303 -0.069,0.085 -0.164,0.147 -0.268,0.178 -0.103,0.024 -0.22,0.016 -0.317,-0.027 -0.315,-0.132 -0.588,-0.357 -0.78,-0.645 -0.185,-0.283 -0.289,-0.626 -0.289,-0.968 v -6.306 c 0.262,0.159 0.562,0.23 0.865,0.213 0.308,-0.023 0.595,-0.138 0.836,-0.329 0.233,-0.192 0.406,-0.454 0.488,-0.748 l 0.007,-0.017 c 0.379,-1.35 0.631,-2.734 0.747,-4.134 0.496,-0.497 0.797,-1.176 0.839,-1.876 0.046,-0.701 -0.172,-1.411 -0.591,-1.967 l -0.625,0.356 c 0.371,0.453 0.556,1.058 0.501,1.64 -0.054,0.584 -0.349,1.143 -0.801,1.517 -0.112,1.448 -0.365,2.889 -0.756,4.288 -0.055,0.178 -0.165,0.336 -0.323,0.436 -0.15,0.099 -0.343,0.145 -0.522,0.119 -0.184,-0.026 -0.356,-0.115 -0.472,-0.257 -0.124,-0.136 -0.193,-0.319 -0.193,-0.503 v -7.524 l 1.413,-3.887 h 3.453 l -0.687,1.18 0.199,2.865 c 0.186,2.636 -0.068,5.301 -0.756,7.853 l -1.873,6.989 z m -4.143,-1.251 -1.873,-6.989 c -0.681,-2.552 -0.94,-5.217 -0.755,-7.853 l 0.198,-2.865 -0.68,-1.18 h 3.446 l 1.412,3.887 v 7.524 c 0,0.184 -0.066,0.367 -0.185,0.503 -0.124,0.142 -0.295,0.231 -0.472,0.257 -0.185,0.026 -0.372,-0.02 -0.529,-0.119 -0.151,-0.1 -0.267,-0.258 -0.315,-0.436 -0.4,-1.399 -0.652,-2.84 -0.756,-4.288 -0.453,-0.374 -0.747,-0.933 -0.803,-1.517 -0.059,-0.582 0.125,-1.187 0.495,-1.64 l -0.618,-0.356 c -0.424,0.556 -0.637,1.266 -0.597,1.967 0.049,0.7 0.349,1.379 0.838,1.876 0.122,1.4 0.371,2.784 0.753,4.134 v 0.017 c 0.084,0.294 0.262,0.556 0.497,0.748 0.233,0.191 0.527,0.306 0.83,0.329 0.299,0.017 0.608,-0.054 0.862,-0.213 v 6.306 c 0,0.342 -0.095,0.685 -0.288,0.968 -0.184,0.288 -0.459,0.513 -0.774,0.645 -0.103,0.043 -0.212,0.051 -0.316,0.027 -0.104,-0.031 -0.199,-0.093 -0.268,-0.178 -0.069,-0.086 -0.102,-0.192 -0.102,-0.303 v -1.251");upbeatHand=new Path2D("m 143.496,764.85205 -1.915,5.26 c -0.152,0.404 -0.158,0.856 -0.029,1.267 0.13,0.408 0.406,0.767 0.756,1.01 0.356,0.244 0.795,0.362 1.221,0.338 l -1.483,4.067 c -0.15,0.417 -0.136,0.885 0.035,1.291 0.163,0.409 0.494,0.744 0.893,0.926 0.403,0.186 0.87,0.209 1.288,0.075 -0.06,0.409 0.02,0.841 0.234,1.199 0.213,0.357 0.557,0.63 0.949,0.765 0.397,0.133 0.835,0.123 1.219,-0.032 0.384,-0.155 0.714,-0.445 0.913,-0.813 0.22,0.315 0.563,0.543 0.941,0.628 0.369,0.084 0.781,0.03 1.118,-0.151 0.336,-0.183 0.603,-0.496 0.733,-0.858 l 0.885,-2.412 c 0.222,0.306 0.565,0.529 0.94,0.611 0.371,0.083 0.776,0.029 1.112,-0.158 0.338,-0.186 0.596,-0.494 0.726,-0.851 l 2.074,-5.687 c 0.988,-2.715 0.803,-5.834 -0.493,-8.414 v -0.005 l -7.014,-2.549 c -1.152,0.262 -2.237,0.812 -3.128,1.595 -0.886,0.779 -1.577,1.784 -1.975,2.898 m 9.357,8.148 -0.665,-0.24 -2.484,6.824 c -0.076,0.217 -0.247,0.402 -0.453,0.497 -0.212,0.099 -0.459,0.11 -0.679,0.031 -0.218,-0.079 -0.406,-0.246 -0.501,-0.455 -0.096,-0.213 -0.109,-0.46 -0.026,-0.68 l 2.482,-6.823 -0.666,-0.241 -2.845,7.822 c -0.098,0.261 -0.303,0.48 -0.551,0.6 -0.253,0.118 -0.556,0.13 -0.815,0.036 -0.261,-0.097 -0.482,-0.3 -0.597,-0.55 -0.118,-0.253 -0.13,-0.551 -0.041,-0.813 l 2.846,-7.826 -0.666,-0.24 -2.483,6.823 c -0.095,0.262 -0.294,0.482 -0.548,0.602 -0.256,0.117 -0.549,0.129 -0.809,0.033 -0.262,-0.095 -0.488,-0.298 -0.606,-0.548 -0.115,-0.253 -0.13,-0.552 -0.035,-0.814 l 1.662,-4.569 c 0.398,-0.227 0.706,-0.597 0.865,-1.023 l 1.091,-3.001 c 0.83,-0.093 1.625,-0.392 2.304,-0.868 0.674,-0.477 1.236,-1.124 1.6,-1.866 l -0.672,-0.248 c -0.351,0.683 -0.893,1.269 -1.545,1.671 -0.658,0.404 -1.421,0.625 -2.196,0.631 l -1.25,3.438 c -0.108,0.306 -0.341,0.563 -0.635,0.7 -0.295,0.136 -0.647,0.151 -0.955,0.04 -0.303,-0.11 -0.557,-0.345 -0.693,-0.637 -0.137,-0.294 -0.158,-0.646 -0.049,-0.955 l 1.923,-5.259 c 0.35,-0.967 0.94,-1.847 1.702,-2.542 0.767,-0.687 1.7,-1.193 2.695,-1.452 l 6.539,2.38 c 1.103,2.359 1.236,5.158 0.343,7.605 l -2.073,5.685 c -0.076,0.22 -0.246,0.404 -0.459,0.499 -0.205,0.101 -0.453,0.109 -0.671,0.033 -0.22,-0.08 -0.406,-0.248 -0.503,-0.457 -0.094,-0.212 -0.109,-0.461 -0.026,-0.68 l 1.145,-3.163 M 184.684,764.85205 c -0.405,-1.114 -1.093,-2.119 -1.985,-2.898 -0.883,-0.783 -1.974,-1.333 -3.128,-1.595 l -7.004,2.549 v 0.005 c -1.303,2.58 -1.49,5.699 -0.501,8.414 l 2.072,5.687 c 0.13,0.357 0.397,0.665 0.732,0.851 0.332,0.187 0.736,0.241 1.113,0.158 0.37,-0.082 0.712,-0.305 0.94,-0.611 l 0.88,2.412 c 0.13,0.362 0.397,0.675 0.739,0.858 0.336,0.181 0.741,0.235 1.12,0.151 0.368,-0.085 0.712,-0.313 0.94,-0.628 0.19,0.368 0.52,0.658 0.905,0.813 0.383,0.155 0.83,0.165 1.219,0.032 0.393,-0.135 0.735,-0.408 0.955,-0.765 0.213,-0.358 0.296,-0.79 0.227,-1.199 0.418,0.134 0.891,0.111 1.289,-0.075 0.398,-0.182 0.729,-0.517 0.9,-0.926 0.173,-0.406 0.179,-0.874 0.028,-1.291 l -1.481,-4.067 c 0.429,0.024 0.862,-0.094 1.219,-0.338 0.358,-0.243 0.625,-0.602 0.755,-1.01 0.138,-0.411 0.123,-0.863 -0.02,-1.267 l -1.914,-5.26 m -8.213,11.311 c 0.074,0.219 0.068,0.468 -0.035,0.68 -0.095,0.209 -0.282,0.377 -0.501,0.457 -0.211,0.076 -0.467,0.068 -0.673,-0.033 -0.212,-0.095 -0.377,-0.279 -0.459,-0.499 l -2.071,-5.685 c -0.886,-2.447 -0.762,-5.246 0.342,-7.605 l 6.539,-2.38 c 1,0.259 1.935,0.765 2.695,1.452 0.762,0.695 1.352,1.575 1.71,2.542 l 1.914,5.259 c 0.109,0.309 0.094,0.661 -0.041,0.955 -0.138,0.292 -0.398,0.527 -0.7,0.637 -0.309,0.111 -0.66,0.096 -0.948,-0.04 -0.294,-0.137 -0.534,-0.394 -0.643,-0.7 l -1.248,-3.438 c -0.771,-0.006 -1.539,-0.227 -2.192,-0.631 -0.657,-0.402 -1.192,-0.988 -1.55,-1.671 l -0.671,0.248 c 0.371,0.742 0.926,1.389 1.605,1.866 0.68,0.476 1.476,0.775 2.298,0.868 l 1.092,3.001 c 0.159,0.426 0.467,0.796 0.865,1.023 l 1.66,4.569 c 0.096,0.262 0.081,0.561 -0.035,0.814 -0.118,0.25 -0.336,0.453 -0.596,0.548 -0.261,0.096 -0.563,0.084 -0.816,-0.033 -0.248,-0.12 -0.454,-0.34 -0.551,-0.602 l -2.482,-6.823 -0.666,0.24 2.845,7.826 c 0.099,0.262 0.084,0.56 -0.032,0.813 -0.124,0.25 -0.343,0.453 -0.604,0.55 -0.261,0.094 -0.556,0.082 -0.811,-0.036 -0.253,-0.12 -0.451,-0.339 -0.548,-0.6 l -2.847,-7.822 -0.666,0.241 2.484,6.823 c 0.076,0.22 0.069,0.467 -0.033,0.68 -0.097,0.209 -0.282,0.376 -0.494,0.455 -0.221,0.079 -0.467,0.068 -0.68,-0.031 -0.214,-0.095 -0.379,-0.28 -0.459,-0.497 l -2.485,-6.824 -0.665,0.24 1.153,3.163");noteHead=new Path2D("M19.8 -12.4c5 0 9.8 2.6 9.8 8.2c0 6.5 -5 10.9 -9.3 13.4c-3.2 1.9 -6.8 3.2 -10.5 3.2c-5 0 -9.8 -2.6 -9.8 -8.2c0 -6.5 5 -10.9 9.3 -13.4c3.2 -1.9 6.8 -3.2 10.5 -3.2 z");sideIndicator1=new Path2D("m 379.0355,823.51955 h -2.213 c -0.229,0 -0.436,-0.096 -0.587,-0.243 -0.162,-0.163 -0.243,-0.377 -0.243,-0.591 v -8.298 c 0,-0.229 0.092,-0.439 0.243,-0.586 0.162,-0.163 0.376,-0.244 0.587,-0.244 h 2.213 v -2.767 h -3.597 c -0.354,0 -0.708,0.136 -0.978,0.406 -0.251,0.251 -0.402,0.594 -0.402,0.977 v 12.726 c 0,0.356 0.133,0.709 0.402,0.98 0.251,0.251 0.598,0.406 0.978,0.406 h 3.597 v -2.766");sideIndicator2=new Path2D("m 379.0085,813.83755 h -2.21 c -0.144,0 -0.285,0.054 -0.391,0.159 -0.1,0.105 -0.163,0.242 -0.159,0.395 0,0 0,8.281 -0.004,8.281 0,0.142 0.055,0.284 0.163,0.39 0.103,0.103 0.239,0.162 0.391,0.162 h 2.21 v -9.387");sharpSign=new Path2D("M216 -312c0 -10 -8 -19 -18 -19s-19 9 -19 19v145l-83 -31v-158c0 -10 -9 -19 -19 -19s-18 9 -18 19v145l-32 -12c-2 -1 -5 -1 -7 -1c-11 0 -20 9 -20 20v60c0 8 5 16 13 19l46 16v160l-32 -11c-2 -1 -5 -1 -7 -1c-11 0 -20 9 -20 20v60c0 8 5 15 13 18l46 17v158 c0 10 8 19 18 19s19 -9 19 -19v-145l83 31v158c0 10 9 19 19 19s18 -9 18 -19v-145l32 12c2 1 5 1 7 1c11 0 20 -9 20 -20v-60c0 -8 -5 -16 -13 -19l-46 -16v-160l32 11c2 1 5 1 7 1c11 0 20 -9 20 -20v-60c0 -8 -5 -15 -13 -18l-46 -17v-158zM96 65v-160l83 30v160z");flatSign=new Path2D("M27 41l-1 -66v-11c0 -22 1 -44 4 -66c45 38 93 80 93 139c0 33 -14 67 -43 67c-31 0 -52 -30 -53 -63zM-15 -138l-12 595c8 5 18 8 27 8s19 -3 27 -8l-7 -345c25 21 58 34 91 34c52 0 89 -48 89 -102c0 -80 -86 -117 -147 -169c-15 -13 -24 -38 -45 -38 c-13 0 -23 11 -23 25z");constructor(){super(new J);let e=this;this.addEventListener("mode",function(t){(e.sysBm.getBm(`st_${{gm:"gm1",g2:"gm2","?":"gm1",ns5r:"korg",ag10:"korg",x5d:"korg","05rw":"korg",krs:"korg",sg:"gm1",k11:"gm1",sd:"gm2",sc:"gs"}[t.data]||t.data}`)||[]).forEach(function(r,a){e.#r[a]=r}),e.#g=2,e.#s=Date.now()+1600}),this.addEventListener("channelactive",t=>{this.#i=t.data}),this.addEventListener("metacommit",t=>{let r=t.data;(r.type==="SGLyrics"||r.type==="C.Lyrics"||r.type==="KarLyric")&&(this.#o=r.data)})}setCh(e){this.#i=e}getCh(){return this.#i}reset(){super.reset(),this.demoInfo&&delete this.demoInfo}#d(e,t,r,a,n=1,m=1,u=-.15){let y=[new Path2D,new Path2D("M36 160 L48 148 L144 148 L156 160 L144 172 L48 172 Z"),new Path2D("M32 156 L20 144 L20 48 L32 36 L44 48 L44 144 Z"),new Path2D("M32 284 L20 272 L20 176 L32 164 L44 176 L44 272 Z"),new Path2D("M156 288 L144 300 L48 300 L36 288 L48 276 L144 276 Z"),new Path2D("M160 164 L172 176 L172 272 L160 284 L148 272 L148 176 Z"),new Path2D("M160 36 L172 48 L172 144 L160 156 L148 144 L148 48 Z"),new Path2D("M36 32 L48 20 L144 20 L156 32 L144 44 L48 44 Z")],E={0:new Uint8Array([0,0,1,1,1,1,1,1]),1:new Uint8Array([0,0,0,0,0,1,1,0]),2:new Uint8Array([0,1,0,1,1,0,1,1]),3:new Uint8Array([0,1,0,0,1,1,1,1]),4:new Uint8Array([0,1,1,0,0,1,1,0]),5:new Uint8Array([0,1,1,0,1,1,0,1]),6:new Uint8Array([0,1,1,1,1,1,0,1]),7:new Uint8Array([0,0,1,0,0,1,1,1]),8:new Uint8Array([0,1,1,1,1,1,1,1]),9:new Uint8Array([0,1,1,0,1,1,1,1])," ":new Uint8Array(8),A:new Uint8Array([0,1,1,1,0,1,1,1]),B:new Uint8Array([0,1,1,1,1,1,0,0]),C:new Uint8Array([0,0,1,1,1,0,0,1]),D:new Uint8Array([0,1,0,1,1,1,1,0]),E:new Uint8Array([0,1,1,1,1,0,0,1]),F:new Uint8Array([0,1,1,1,0,0,0,1]),G:new Uint8Array([0,0,1,1,1,1,0,1]),H:new Uint8Array([0,1,1,1,0,1,1,0]),I:new Uint8Array([0,0,1,1,0,0,0,0]),J:new Uint8Array([0,0,0,0,1,1,1,0]),K:new Uint8Array([0,1,1,1,0,0,1,0]),L:new Uint8Array([0,0,1,1,1,0,0,0]),M:new Uint8Array([0,1,0,1,0,1,0,1]),N:new Uint8Array([0,1,0,1,0,1,0,0]),O:new Uint8Array([0,1,0,1,1,1,0,0]),P:new Uint8Array([0,1,1,1,0,0,1,1]),Q:new Uint8Array([0,1,1,0,0,1,1,1]),R:new Uint8Array([0,1,0,1,0,0,0,0]),S:new Uint8Array([0,0,1,0,1,1,0,1]),T:new Uint8Array([0,1,1,1,1,0,0,0]),U:new Uint8Array([0,0,1,1,1,1,1,0]),X:new Uint8Array([0,0,1,1,0,1,1,0]),Y:new Uint8Array([0,1,1,0,1,1,1,0]),Z:new Uint8Array([0,0,0,1,1,0,1,1]),"-":new Uint8Array([0,1,0,0,0,0,0,0])};Array.from(e).forEach((C,f)=>{t.setTransform(n,0,u*m,m,190*n*f+r,a);for(let o=0;o<8;o++)t.fillStyle=E[C][o]?I:U,t.fill(y[o])}),t.resetTransform()}#u(e,t,r=!1,a,n,m=-1,u=8,y=8,E=-.15){let C=this,f=Date.now();t.setTransform(1,0,E,1,0,0);let o=r?C.trueFont:C.xgFont,s=!1,i=e.length;e.length>8?(s=!0,e=`${e}  ${e.slice(0,8)}`,e=e.slice(C.#e,C.#e+8)):e=e.padEnd(8," "),o.getStr(e).forEach((l,h)=>{l.render((c,p,d)=>{d===7&&m===h?t.fillStyle=c?U:I:t.fillStyle=c?I:U,t.fillRect(a+(p+6*h)*u,n+d*y,u-1,y-1)})}),t.resetTransform(),s&&Math.floor(f/60)!==C.#n?C.#c>0?C.#c--:C.#e>i+1?(C.#e=0,C.#c=8):(C.#e++,C.#c=1):s||(C.#e=0,C.#c=0),C.#n=Math.floor(f/60)}render(e,t,r="#b7bfaf64",a,n,m=0,u=!1,y=!0){let E=super.render(e),C=this,f=Date.now(),o=!1,s=0,i=0;E.chInUse.forEach(function(P,B){P&&(o||(o=!0,s=B),i=B)}),s=s>>4<<4,i=(i>>4<<4)+15,this.#i>i&&(this.#i=s+this.#i&15),this.#i<s&&(this.#i=i-15+(this.#i&15));let h=this.#i*M.length;this.#t.forEach((P,B,K)=>{K[B]=0}),this.#a.forEach((P,B,K)=>{K[B]=0}),this.#l.forEach((P,B,K)=>{K[B]=0}),t.fillStyle=r,t.fillRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="#000c",t.textAlign="left",t.font='22px "Arial Web"',t.fillText("C4",548,399),t.strokeStyle="#000c",t.stroke(C.bracket),t.stroke(C.staffLines),t.fill(C.clefs),t.stroke(C.keyboard),E.noteBeat&1?(t.fillStyle=I,t.setTransform(3.2,0,0,-3.2,455,2733),t.fill(C.upbeatHand),t.fillStyle=U,t.setTransform(3.2,0,0,-3.2,455,2855),t.fill(C.downbeatHand)):(t.fillStyle=U,t.setTransform(3.2,0,0,-3.2,455,2733),t.fill(C.upbeatHand),t.fillStyle=I,t.setTransform(3.2,0,0,-3.2,455,2855),t.fill(C.downbeatHand)),t.fillStyle=E.noteBeat<1?I:U,t.setTransform(3.2,0,0,-3.2,455,2855),t.fill(C.downbeatStar),t.resetTransform();let c=new Path2D("M199 349 L214 329 L214 369 Z"),p=new Path2D("M1080 349 L1065 369 L1065 329 Z"),d=!1,b=!1,g;E.extraNotes.forEach(P=>{let{part:B,note:K,velo:ce,state:_e}=P;_e&&ce&&E.chKeyPr[B].set(K,{v:ce,s:_e})});for(let P=36;P<97;P++){let B=0,K=E.chKeyPr[this.#i];K?.has(P)&&(B=K.get(P).s<4?2:1),this.#t[P-36]=B}for(let P=0;P<36;P++)if(E.chKeyPr[this.#i]?.has(P)){d=!0,g=P%12;let B=E.chKeyPr[this.#i]?.get(P).s<4?2:1;this.#t[g]=Math.max(this.#t[g],B)}for(let P=97;P<128;P++)if(E.chKeyPr[this.#i]?.has(P)){b=!0,g=(P-1)%12+1;let B=E.chKeyPr[this.#i]?.get(P).s<4?2:1;this.#t[g+48]=Math.max(this.#t[g],B)}t.fillStyle=d?I:U,t.fill(c),t.fillStyle=b?I:U,t.fill(p);let w=new Uint8Array([0,0,1,2,2,3,3,4,5,5,6,6,7]),v=new Uint8Array([0,1,0,2,0,0,1,0,2,0,2,0]),$=new Uint8Array([0,0,0,0,0,0,1,0,1,0,2,0]),S=!1,x=!1,R=!1,A=!1;for(let P=48;P<85;P++)if(E.chKeyPr[this.#i]?.has(P)){let B=E.chKeyPr[this.#i]?.get(P).s<4?2:1;this.#a[(Math.floor(P/12)-4)*7+w[P%12]]=B,v[P%12]&&(v[P%12]===1?this.#l[(Math.floor(P/12)-4)*2+$[P%12]]=B:this.#l[(Math.floor(P/12)-4)*3+$[P%12]+6]=B)}for(let P=0;P<48;P++)if(E.chKeyPr[this.#i]?.has(P)){let B=E.chKeyPr[this.#i]?.get(P).s<4?2:1;this.#a[w[P%12]]=Math.max(this.#a[w[P%12]],B),Math.floor(P/12)===3?S=!0:x=!0,v[P%12]&&(v[P%12]===1?this.#l[$[P%12]]=Math.max(this.#l[$[P%12]],B):this.#l[$[P%12]+6]=Math.max(this.#l[$[P%12]+6],B))}for(let P=85;P<128;P++)if(E.chKeyPr[this.#i]?.has(P)){let B=E.chKeyPr[this.#i]?.get(P).s<4?2:1;this.#a[14+w[(P-1)%12+1]]=Math.max(this.#a[14+w[(P-1)%12+1]],B),Math.floor((P-1)/12)===7?R=!0:A=!0,v[P%12]&&(v[P%12]===1?this.#l[4+$[P%12]]=Math.max(this.#l[4+$[P%12]],B):this.#l[12+$[P%12]]=Math.max(this.#l[12+$[P%12]],B))}if(t.font='24px "Arial Web"',t.fillStyle=S?I:U,t.fillText("8va",280,208),t.fillStyle=R?I:U,t.fillText("8va",876,70),t.fillStyle=x?I:U,t.fillText("15va+",253,244),t.fillStyle=A?I:U,t.fillText("15va+",874,40),this.#d(`${"ABCDEFGH"[this.#i>>4]}${((this.#i&15)+1).toString().padStart(2,"0")}`,t,25,260,.1,.1),t.font='23px "Arial Web"',t.fillStyle=n?U:I,t.fillText("MEASURE",664,296),t.fillStyle=n?I:U,t.fillText("TEMPO",795,242),n?this.#d(Math.round(E.tempo).toString().padStart(3,"0"),t,791,245,.17,.17):this.#d((E.noteBar+1).toString().padStart(3,"0"),t,791,245,.17,.17),y?this.#d(`${"ABCDEFGH"[this.#i>>4]}${((this.#i&15)+1).toString().padStart(2,"0")}`,t,112,15,.24,.24):a?this.#d(`${E.chProgr[this.#i]+1}`.padStart(3,"0"),t,112,15,.24,.24):this.#d(`${m+1}`.padStart(3,"0"),t,112,15,.24,.24),f<=E.letter.expire){let P=E.letter.text.trim();this.#u(P,t,u,454,32)}else if(y){let P=Math.round(E.noteBeat*2-.5);if(E.noteBar!==C.#f&&(C.#h="        "),C.#o!==""){let B=Array.from(C.#h);B.splice(P,C.#o.length,C.#o),C.#h=B.join("")}this.#u(this.#h.slice(0,8),t,u,454,32,P),C.#f=E.noteBar,C.#o=""}else if(a)this.#u(C.getChVoice(this.#i).name,t,u,454,32);else{let P=C.songTitle;for(;P.indexOf("  ")>-1;)P=P.replaceAll("  "," ");this.#u(P||"Unknown",t,u,454,32)}t.fillStyle=I,t.setTransform(4.5,0,0,4.5,-605,-3642),t.fill(C.sideIndicator1),t.fillStyle=a?U:I,t.fill(C.sideIndicator2),t.setTransform(4.5,0,0,4.5,-605,-3484),t.fillStyle=a?I:U,t.fill(C.sideIndicator2),t.resetTransform();let L;if(f<=E.bitmap.expire)L=E.bitmap.bitmap;else if(this.demoInfo&&e>0){let P=this.demoInfo.class||"boot",B=this.demoInfo.fps||2,K=this.demoInfo.size||4,ce=this.demoInfo.offset||0,_e=Math.floor((e*B+ce)%K),yt=`${P}_${_e}`;L=this.aniBm?.getBm(yt)||this.sysBm?.getBm(yt)||this.sysBm?.getBm("no_abm"),L||(L=this.#r.slice())}else if(L=this.#r.slice(),f>=this.#s){this.#g=0;let P=C.getChVoice(this.#i).standard.toLowerCase();L=this.voxBm.getBm(C.getChVoice(this.#i).name)||this.voxBm.getBm(C.getVoice(E.chContr[h]+M[0],E.chProgr[this.#i],0,E.mode).name),["an","ap","dr","dx","pc","pf","sg","vl"].indexOf(P)>-1&&(L=this.sysBm.getBm(`ext_${P}`)),!L&&(E.chContr[h+M[0]]<48||E.chContr[h+M[0]]===56)&&(L=this.voxBm.getBm(C.getVoice(0,E.chProgr[this.#i],0,E.mode).name)),!L&&E.chContr[h]+M[0]===126&&(L=this.sysBm.getBm("cat_smpl")),!L&&E.chContr[h]+M[0]===64&&(L=this.sysBm.getBm("cat_sfx")),L||(L=this.sysBm.getBm("no_abm"))}else this.#g===2&&L.forEach((P,B,K)=>{let ce=Math.floor((this.#s-f)/400);K[B]=ce%2===P});L&&(L.width=L.length/16),L?.render((P,B,K)=>{t.fillStyle=P?I:U,t.fillRect(224+B*6,261+K*3,5,2)}),t.fillStyle=U,t.font='18px "Arial Web"',t.fillText("ACMP",430,275),t.fillText("ON",430,295),t.fill(new Path2D("M482 296 L482 312 L462 304 Z")),this.#d(" ",t,32,300,.25,.25),t.font='bold 53px "Arial Web"',t.fillText("m",82,375),t.fillText("M",130,375),t.font='40px "Arial Web"',t.fillText("7",175,375),t.font='30px "Arial Web"',t.fillText("♯",88,328),t.fillText("♭",113,328),t.fillText("6",185,328),t.fillText("dim",132,328),t.font='25px "Arial Web"',t.fillText("♭  5",105,277),t.fillText("sus4",157,300),t.fillText("aug",82,300),t.fillText("(9)",157,277);let N=new Uint16Array([228,238.5,250.3,263.5,272.6,295,304.5,317.3,330,339.5,354,361.8]);this.#t.forEach((P,B)=>{t.fillStyle=[U,Oe,I][P];let K=Math.floor(B/12),ce=B%12;B!==60?v[ce]?t.fillRect(N[ce]+163*K,321,12,26):t.fillRect(N[ce]+163*K,355,14,21):t.fillRect(1036,355,14,21)}),this.#a.forEach((P,B)=>{B<7?t.setTransform(1,0,0,1,100+36*B,200-18*B):t.setTransform(1,0,0,1,538+36*(B-7),290-18*(B-7)),t.fillStyle=[U,Oe,I][P],t.fill(C.noteHead),t.resetTransform()});let O=new Uint16Array([82,158,488,596,740,848]),X=new Uint16Array([200,146,290,236,164,110]),ue=new Uint16Array([130,230,306,560,668,704,812,920,956]),Qe=new Uint16Array([164,110,92,254,200,182,128,74,56]);this.#l.forEach((P,B)=>{B<6?(t.setTransform(.03,0,0,-.03,O[B],X[B]),t.fillStyle=[U,Oe,I][P],t.fill(C.sharpSign),t.resetTransform()):(t.setTransform(.03,0,0,-.03,ue[B-6],Qe[B-6]),t.fillStyle=[U,Oe,I][P],t.fill(C.flatSign),t.resetTransform())})}},df=hf;export{qa as MuDisplay,af as Ns5rDisplay,df as PsrDisplay,cf as QyDisplay,nf as Sc8850Display,ef as ScDisplay};
