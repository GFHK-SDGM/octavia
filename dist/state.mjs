var z=function(e,a){let o=Math.min(e.length,a.length),h=e.slice(0,o),y=a.slice(0,o),g=0,f=0;for(;f<o&&g==0;)g=Math.sign(h[f]-y[f]),f++;return g},x=function(e=""){this.name=e,this.pool=[],this.point=function(a,o=!1){if(this.pool.length>0){let h=this.pool.length,y=1<<Math.floor(Math.log2(h)),g=y,f=64;for(;y>=1&&f>=0;){if(f<=0)throw new Error("TTL reached.");if(g==h)g-=y;else{let s=z(a,this.pool[g]);switch(s){case 0:{f=0;break}case 1:{g+y<=h&&(g+=y);break}case-1:{g!=0&&(g-=y);break}default:console.warn(`Unexpected result ${s}.`)}}y=y>>1,f--}let t=!0;if(g>=this.pool.length)t=!1;else{let s=this;this.pool[g].forEach(function(c,i,r){t&&c!=a[i]&&(t=!1)}),!t&&z(a,this.pool[g])>0&&g++}return t||o?g:-1}else return o?0:-1},this.add=function(a,o){return a.data=o,this.pool.splice(this.point(a,!0),0,a),this},this.default=function(a){console.warn(`No match in "${this.name||"(unknown)"}" for "${a}". Default action not defined.`)},this.get=function(a){let o=this.point(a);if(o>-1)return this.pool[o].data;this.default(a)},this.run=function(a,...o){let h=this.point(a);h>-1?a.subarray?this.pool[h].data(a.subarray(this.pool[h].length),...o):this.pool[h].data(a.slice(this.pool[h].length),...o):this.default(a,...o)}};var q=class{#t={};addEventListener(e,a){this.#t[e]||(this.#t[e]=[]),this.#t[e].unshift(a)}removeEventListener(e,a){if(this.#t[e]){let o=this.#t[e].indexOf(a);o>-1&&this.#t[e].splice(o,1),this.#t[e].length<1&&delete this.#t[e]}}dispatchEvent(e,a){let o=new Event(e),h=this;o.data=a,this.#t[e]?.length>0&&this.#t[e].forEach(function(y){try{y?.call(h,o)}catch(g){console.error(g)}}),this[`on${e}`]&&this[`on${e}`](o)}};var he=["MSB","PRG","LSB"],G=function(e){let a=Math.floor(e/10),o=e%10;return`${a.toString(16)}${o}`},B=class{#t;strictMode=!1;get(e=0,a=0,o=0,h){let y=[e,a,o],g,f=Array.from(arguments);switch(h){case"xg":{switch(e){case 0:{o==126?f[2]=125:o==127&&(f[2]=0);break}case 16:{o==126&&(f[2]=0);break}case 32:{f[2]+=4;break}case 33:case 35:case 36:{f[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:f[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{o==126&&(f[2]=0);break}case 48:case 64:case 126:case 127:{o==126&&(f[2]=0);break}}break}case"gs":{e==0&&o<5?f[2]=0:e>125&&o<5&&o!=2&&(f[2]=e,f[0]=0);break}case"g2":case"sd":{(e>>1==40||e>95&&e<100)&&(f[2]|=16);break}case"sg":{e==8&&o==0&&(f[2]=5);break}case"s90es":{o<8?f[2]+=17:o<32?f[2]+=13:f[2]=(f[2]>>3)+19;break}case"motif":{o<8?f[2]+=28:o<32?f[2]+=13:f[2]=(f[2]>>3)+19;break}}let t=" ",s="M",c=0,i=0;switch(f[0]){case 0:{f[2]==127?s="MT-a":f[2]==126?s="MT-b":f[2]==7?s="GM-k":f[2]==5?s="SG-a":f[2]==4?s="SP-l":f[2]==0||h=="gs"&&f[2]<5?s="GM-a":(s="y",c=3);break}case 8:{h=="sg"?s="GM-s":s="r:";break}case 48:{s=`yM${(f[2]>>3).toString().padStart(2,"0")}`,c=1;break}case 56:{s="GM-b";break}case 61:case 120:{s="rDrm";break}case 62:{s="kDrm";break}case 63:{if(f[2]<17){let l=f[2];s=l<10?"kP:":"kC:",s+=l%10}else f[2]<34?s=["Pre1","Pre2","Pre3","Pre4","Usr1","Usr2","DrmP","DrmU","Plg1","Plg2","Plg3","Pre1","Pre2","Pre3","Pre4","Pre5","Pre6"][f[2]-17]:s="Ds";break}case 64:{s="ySFX";break}case 67:{s="DX:S";break}case 80:case 81:case 82:case 83:{s=`Prg${"UABC"[f[0]-80]}`;break}case 88:case 89:case 90:case 91:{s=`Cmb${"UABC"[f[0]-88]}`;break}case 95:{s=`${["DR","PC"][f[2]]}-d`;break}case 96:{s=f[2]==106?"AP-a":f[2]>>4==1?"SDg":"PF",f[2]>63?i=63:f[2]>>4==1&&(i=16),c=3;break}case 97:{s=f[2]>>4==1?"SDa":"VL:",c=3,f[2]>>4==1?i=16:i=112;break}case 98:{s=f[2]>>4==1?"SDb":"SG-a",c=3,i=16;break}case 99:{s=f[2]>>4==1?"SDc":"DX",f[2]>63?i=63:f[2]>>4==1&&(i=16),c=3;break}case 100:{s="AN",f[2]>63?i=63:f[2]>>4==1&&(i=16),c=3;break}case 104:case 105:case 106:case 107:{s="SDd",i=104;break}case 121:{s=`GM-${f[2]?"":"a"}`,c=3;break}case 122:{s="lDrm";break}case 126:{s="yDrS";break}case 127:{f[2]==127?s="rDrm":s="yDrm";break}default:f[0]<48?s="r:":s="M"}s.length<4&&(s+=`${[e,o,f[0],f[2]][c]-i}`.padStart(4-s.length,"0")),h=="xg"&&(e==0?f[2]<100?s=s.replace("y0","y:"):f[2]==125&&(s="y126"):e==16&&(g=`Voice${(f[2]*128+f[1]+1).toString().padStart(3,"0")}`,t=" "));let r=[f[0],f[1],f[2]];for(;!(g?.length>=0);)g=this.#t[f[1]||0][(f[0]<<7)+f[2]],g||(this.strictMode?(g="",t="?"):this.#t[f[1]||0][f[0]<<7]?f[0]==0?(f[2]=0,t="^"):f[2]<1?(f[0]=0,t="*"):(f[2]--,t="^"):e==48?(f[0]=0,f[2]=0,t="!"):e==62?(f[1]--,t=" ",f[1]<1&&!g?.length&&(f[0]=0,t="!")):e<63?f[0]==0?(f[2]=0,t="^"):f[2]<1?(f[0]=0,t="*"):f[2]--:e==80?(g=`PrgU:${a.toString().padStart(3,"0")}`,t="!"):e==88?(g=`CmbU:${a.toString().padStart(3,"0")}`,t="!"):e==121?(g=`GM2Vox0${o}`,t="#"):e==122?(f[1]==32?f[1]==0:f[1]%=7,g=this.#t[f[1]||0][(f[0]<<7)+f[2]],g?t=" ":(g="",t="*")):f[1]==0?(g=`${e.toString().padStart(3,"0")} ${a.toString().padStart(3,"0")} ${o.toString().padStart(3,"0")}`,t="!"):f[0]==0?(f[2]=0,t="^"):f[2]>0?f[2]--:f[1]>0?(f[1]=0,t="!"):(f[0]=0,t="?"));let n=[f[0],f[1],f[2]];(h=="gs"||h=="ns5r")&&t=="^"&&(t=" "),e==127&&t=="^"&&(t=" "),t!=" "&&self.debugMode&&(g="");let d="??";switch(f[0]){case 0:{f[2]==0?d="GM":f[2]==5||f[2]==7?d="KG":f[2]<126?d="XG":f[2]==127&&(d="MT");break}case 48:{d="MU";break}case 56:{d="AG";break}case 61:case 80:case 83:case 88:case 89:case 91:{d="AI";break}case 62:case 82:case 90:{d="XD";break}case 63:{f[2]<17?d="KR":f[2]<34?d="ES":d="DS";break}case 64:case 126:{d="XG";break}case 67:case 99:{d=f[2]>>4==1?"SD":"DX";break}case 81:{d="RW";break}case 95:{d=["DR","PC"][f[2]];break}case 96:{d=f[2]==106?"AP":f[2]>>4==1?"SD":"PF";break}case 97:{d=f[2]>>4==1?"SD":"VL";break}case 98:{d=f[2]>>4==1?"SD":"SG";break}case 100:{d="AN";break}case 104:case 105:case 106:case 107:{d="SD";break}case 120:{d="GS";break}case 121:{d=f[2]?"G2":"GM";break}case 122:{d="KG";break}case 127:{d=f[2]==127?"MT":a==0?"GM":"XG";break}default:f[0]<48&&(f[0]==16&&h=="xg"?d="XG":d="GS")}return{name:g||`${G(e||0)} ${G(a||0)} ${G(o||0)}`,iid:r,eid:n,sid:y,ending:t,sect:s,standard:d}}async load(e,a,o){let h=this,y=[],g=0,f=0;e.split(`
`).forEach(function(t,s){let c=t.split("	"),i=[];s==0?c.forEach(function(r,n){y[he.indexOf(r)]=n}):c.forEach(async function(r,n){n>2?(h.#t[i[y[1]]]=h.#t[i[y[1]]]||[],(!h.#t[i[y[1]]][(i[y[0]]<<7)+i[y[2]]]?.length||a)&&(h.#t[i[y[1]]][(i[y[0]]<<7)+i[y[2]]]=c[3],g++),f++):i.push(parseInt(c[n]))})}),a||console.debug(`Map "${o||"(internal)"}": ${f} total, ${g} loaded.`)}clearRange(e){let a=e.prg!=null?e.prg.constructor==Array?e.prg:[e.prg,e.prg]:[0,127],o=e.msb!=null?e.msb.constructor==Array?e.msb:[e.msb,e.msb]:[0,127],h=e.lsb!=null?e.lsb.constructor==Array?e.lsb:[e.lsb,e.lsb]:[0,127];for(let y=o[0];y<=o[1];y++){let g=y<<7;for(let f=h[0];f<=h[1];f++){let t=g+f;for(let s=a[0];s<=a[1];s++)delete this.#t[s][t]}}}init(){this.#t=[];for(let e=0;e<128;e++)this.#t.push([""])}async loadFiles(...e){this.init();let a=this;e.forEach(async function(o,h){try{await fetch(`./data/bank/${o}.tsv`).then(function(y){return y.text()}).then(y=>{a.load(y,!1,o)})}catch{console.error(`Failed loading "${o}.tsv".`)}})}constructor(...e){this.loadFiles(...e)}};var Q=class{#t={};context;set(e,a){this.#t[e]=a}has(e){return!!this.#t[e]}async read(e,a){if(!this.has(e))throw new Error(`No decoder registered for "${e}"`);return await this.#t[e].call(this.context||this,a)}};var ue=function(e,a){let o=!0;return a.forEach((h,y)=>{o=o&&e[y]==h}),o},Y=function(e){let a=0;return e.forEach(o=>{a*=256,a+=o}),a},O=new TextDecoder,N=new Q;N.set("s7e",async function(e){let a=new Uint8Array(await e.slice(0,65536).arrayBuffer()),o="MSB	LSB	PRG	NME",h=[0,0,0,0],y=32,g=0,f=0,t=!0,s=[],c=0;for(;t;){let i=a.subarray(g);([()=>{O.decode(i.subarray(0,4))=="YSFC"?(g+=80,f=1):g++},()=>{if(ue(i.subarray(0,4),h))s.forEach((r,n,d)=>{let l=Y(a.subarray(r.start+4,r.start+8));r.length=l}),f=2;else{let r=O.decode(i.subarray(0,4)),n=Y(i.subarray(4,8));s.push({type:r,start:n}),g+=8}},()=>{let r=s[c],n=a.subarray(r.start,r.start+r.length),d=32;switch(r.type){case"ENVC":{let l=y;for(;l<n.length;){let p=n.subarray(l,l+d),$=O.decode(p.subarray(0,10)).trimEnd();$.slice(0,5)=="Init "&&($=""),$&&(o+=`
063	${(p[17]+13).toString().padStart(3,"0")}	${p[19].toString().padStart(3,"0")}	${$}`),l+=d}break}case"EDVC":{let l=y;for(;l<n.length;){let p=n.subarray(l,l+d),$=O.decode(p.subarray(0,10)).trimEnd();$.slice(0,5)=="Init "&&($=""),$&&(o+=`
063	024	${p[19].toString().padStart(3,"0")}	${$}`),l+=d}break}case"EPVC":{let l=32,p=y;for(;p<n.length;){let $=n.subarray(p,p+l),E=O.decode($.subarray(0,10)).trimEnd();E=="----------"&&(E=""),E&&(o+=`
063	${($[17]+1).toString().padStart(3,"0")}	${$[19].toString().padStart(3,"0")}	${E}`),p+=l}break}}c++,c>=s.length&&(f=3,t=!1)}][f]||(()=>{t=!1}))()}return o});var U=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]),A=["melodic","drums","drum set 1","drum set 2","drum set 3","drum set 4","drum set 5","drum set 6","drum set 7","drum set 8"],pe=[17.1,18.6,20.2,21.8,23.3,24.9,26.5,28,29.6,31.2,32.8,34.3,35.9,37.5,39,40.6,42.2,43.7,45.3,46.9,48.4,50],D=[20,22,25,28,32,36,40,45,50,56,63,70,80,90,100,110,125,140,160,180,200,225,250,280,315,355,400,450,500,560,630,700,800,900,1e3,1100,1200,1400,1600,1800,2e3,2200,2500,2800,3200,3600,4e3,4500,5e3,5600,6300,7e3,8e3,9e3,1e4,11e3,12e3,14e3,16e3,18e3,2e4],W=[0,.04,.08,.13,.17,.21,.25,.29,.34,.38,.42,.46,.51,.55,.59,.63,.67,.72,.76,.8,.84,.88,.93,.97,1.01,1.05,1.09,1.14,1.18,1.22,1.26,1.3,1.35,1.39,1.43,1.47,1.51,1.56,1.6,1.64,1.68,1.72,1.77,1.81,1.85,1.89,1.94,1.98,2.02,2.06,2.1,2.15,2.19,2.23,2.27,2.31,2.36,2.4,2.44,2.48,2.52,2.57,2.61,2.65,2.69,2.78,2.86,2.94,3.03,3.11,3.2,3.28,3.37,3.45,3.53,3.62,3.7,3.87,4.04,4.21,4,37,4.54,4.71,4.88,5.05,5.22,5.38,5.55,5.72,6.06,6.39,6.73,7.07,7.4,7.74,8.08,8.41,8.75,9.08,9.42,9.76,10.1,10.8,11.4,12.1,12.8,13.5,14.1,14.8,15.5,16.2,16.8,17.5,18.2,19.5,20.9,22.2,23.6,24.9,26.2,27.6,28.9,30.3,31.6,33,34.3,37,39.7],J=function(e){let a=.1,o=-.3;return e>66?(a=5,o=315):e>56?(a=1,o=47):e>46&&(a=.5,o=18.5),a*e-o},Z=function(e){return e>105?pe[e-106]:e>100?e*1.1-100:e/10},j=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),_={};`hi*,
ka,か
ki,き
ku,く
ke,け
ko,こ
ky,き!
kw,くl
tsu,つ
ts,つl
sa,さ
si,すぃ
su,す
se,せ
so,そ
shi,し
sh,し!
ta,た
ti,てぃ
tu,とぅ
te,て
to,と
tchy,ち!
tchi,ち
na,な
ni,に
nu,ぬ
ne,ね
no,の
ny,に!
nn,ん
ha,は
hi,ひ
hu,ほぅ
he,へ
ho,ほ
hy,ひ!
fa,ふぁ
fi,ふぃ
fu,ふ
fe,ふぇ
fo,ふぉ
ma,ま
mi,み
mu,む
me,め
mo,も
my,み!
mm,
ra,ら
ri,り
ru,る
re,れ
ro,ろ
ry,り!
wa,わ
wi,うぃ
we,うぇ
wo,を
nga,ガ
ngi,ギ
ngu,グ
nge,ゲ
ngo,ゴ
ngy,ギ!
ng,
ga,が
gi,ぎ
gu,ぐ
ge,げ
go,ご
gy,ぎ!
gw,ぐl
za,ざ
zi,ずぃ
zu,ず
ze,ぜ
zo,ぞ
ja,じゃ
ji,じ
ju,じゅ
je,じぇ
jo,じょ
jy,じ!
da,だ
di,でぃ
du,どぅ
de,で
do,ど
dy,で!
ba,ば
bi,び
bu,ぶ
be,べ
bo,ぼ
by,び!
va,ゔぁ
vi,ゔぃ
vu,ゔ
ve,ゔぇ
vo,ゔぉ
pa,ぱ
pi,ぴ
pu,ぷ
pe,ペ
po,ぽ
py,ぴ!
!ya,ゃ
!yu,ゅ
!ye,ぇ
!yo,ょ
ya,や
yu,ゆ
ye,いぇ
yo,よ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
la,ぁ
li,ぃ
lu,ぅ
le,ぇ
lo,ぉ
a,あ
i,い
u,う
e,え
o,お
*,っ
~,
^,
_,`.split(`
`).forEach(e=>{let a=e.split(",");_[a[0]]=a[1]});var ee=function(e){let a=e;e[0]=="*"&&(a=a.slice(1)),["aa","ii","uu","ee","oo"].forEach(h=>{for(;a.indexOf(h)>-1;)a=a.replace(h,h[0])});for(let h in _)a=a.replaceAll(h,_[h]);a.indexOf("ん")==0&&a.length>1&&(a=a.slice(1));let o=a.indexOf("!");return o>-1&&a.length>1&&(a=a.slice(o+1)),a},te=function(e){return e?e<96?`cc${e}`:["aftertouch","velocity","pitch bend"][e-96]:"off"};var I=["room 1","room 2","room 3","hall 1","hall 2","plate","delay","panning delay"],ae=["chorus 1","chorus 2","chorus 3","chorus 4","feedback","flanger","short delay","short delay feedback"],se=["delay 1","delay 2","delay 3","delay 4","pan delay 1","pan delay 2","pan delay 3","pan delay 4","delay to reverb","pan repeat"];var be={0:"thru",256:"stereo EQ",257:"spectrum",258:"enhancer",259:"humanizer",272:"overdrive",273:"distortion",288:"phaser",289:"auto wah",290:"rotary",291:"stereo flanger",292:"step flanger",293:"tremelo",294:"auto pan",304:"compressor",305:"limiter",320:"hexa chorus",321:"tremelo chorus",322:"stereo chorus",323:"space D",324:"3D chorus",336:"stereo delay",337:"modulated delay",338:"3-tap delay",339:"4-tap delay",340:"tremelo control delay",341:"reverb",342:"gate reverb",343:"3D delay",352:"2-pitch shifter",353:"feedback pitch shifter",368:"3D auto",369:"3D manual",370:"Lo-Fi 1",371:"Lo-Fi 2",512:"overdrive - chorus",513:"overdrive - flanger",514:"overdrive - delay",515:"distortion - chorus",516:"distortion - flanger",517:"distortion - delay",518:"enhancer - chorus",519:"enhancer - flanger",520:"enhancer - delay",521:"chorus - delay",522:"flanger - delay",523:"chorus - flanger",524:"rotary multi",1024:"guitar multi 1",1025:"guitar multi 2",1026:"guitar multi 3",1027:"clean guitar multi 1",1028:"clean guitar multi 2",1029:"bass multi",1030:"rhodes multi",1280:"keyboard multi",4352:"chorus / delay",4353:"flanger / delay",4354:"chorus / flanger",4355:"overdrive / distortion",4356:"overdrive / rotary",4357:"overdrive / phaser",4358:"overdrive / auto wah",4359:"phaser / rotary",4360:"phaser / auto wah"},ye={66307:["drive"],66309:["vowel",e=>"aiueo"[e]],94723:["pre-filter"],94724:["Lo-Fi type"],94725:["post-filter"],94979:["Lo-Fi type"],94980:["fill type",e=>["off","LPF","HPF"][e]],94984:["noise type",e=>["white","pink"][e]],94987:["disc type",e=>["LP","SP","EP","RND"]],94990:["hum type",e=>`${e+5}0Hz`],94993:["M/S",e=>["mono","stereo"][e]]},X=function(e){return be[(e[0]-32<<8)+e[1]]||`0x${e[0].toString(16).padStart(2,"0")}${e[1].toString(16).padStart(2,"0")}`},re=function(e,a,o){let h=(e[0]-32<<16)+(e[1]<<8)+a,y=ye[h]||{},g=y[0];if(g?.length)return g+=`: ${(y[1]||function(){})(o)||o}`,g},V=[68,48,95,78,41,3,110,122,0];var S=function(e=64){return Math.round(2e3*Math.log10(e/64))/100};var K=function(e){let a=0;return e.forEach(o=>{a+=o,a=a&127}),~a+1&127},M=function(e,a){let o=0,h=0;for(let y=0;y<e.length;y++){let g=y%8-1,f=(h>>g&1)<<7,t=e[y];t+=f,y%8!=0?(a(t,o,e),o++):h=e[y]}},P=function(e){let a=Math.floor(e*14.2);return a<128?a:0};var T=["?","gm","gs","xg","g2","mt32","ns5r","x5d","05rw","sd","k11","sg","krs","s90es","motif"],ie=[[0,0,0,0,121,0,0,82,81,97,0,0,63,63,63],[0,0,4,0,0,127,0,0,0,0,0,0,0,0,0]],R=[120,127,120,127,120,127,61,62,62,105,122,122,120,127,127],$e=[0,3,81,84,88],ce={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},F={0:0,1:1,2:3,5:4},ne=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],oe=[36,37,48,49,52,53],L=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65],le={26:127,29:0,30:0,31:0,52:12,53:54},H=[0,1,2,4,5,6,7,8,10,11,32,38,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,84,91,92,93,94,95,98,99,100,101,128,12,13,16,17,18,19],ge=[12,13,16,17,18,19],Ee=[33,99,100,32,102,8,9,10],de=[0,16,25,40,32,64,26,48],m={};T.forEach((e,a)=>{m[e]=a});var u={length:H.length};H.forEach((e,a)=>{u[e]=a});var C={length:L.length};L.forEach((e,a)=>{C[e]=a});var k=function(){return!!self.Bun||self.debugMode||!1},me=function(e){let a=[],o=0;return e?.forEach(function(h,y){h==247?a.push(e.subarray(o,y)):h==240&&(o=y+1)}),a.length||a.push(e.subarray(0)),k()&&console.debug(a),a};var b={ch:128,cc:H.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,ace:8,drm:8,dpn:L.length,dnc:128,efx:7},Ke=class extends q{NOTE_IDLE=0;NOTE_ATTACK=1;NOTE_DECAY=2;NOTE_SUSTAIN=3;NOTE_HELD=4;NOTE_RELEASE=5;NOTE_SOSTENUTO_ATTACK=8;NOTE_SOSTENUTO_DECAY=9;NOTE_SOSTENUTO_SUSTAIN=10;NOTE_SOSTENUTO_HELD=11;CH_MELODIC=0;CH_DRUMS=1;CH_DRUM1=2;CH_DRUM2=3;CH_DRUM3=4;CH_DRUM4=5;CH_DRUM5=6;CH_DRUM6=7;CH_DRUM7=8;CH_DRUM8=9;#t=0;#u=0;#S=0;#M=new Array(11);get#b(){return this.#M[this.#u]}set#b(e){this.#M[this.#u]=e}#T=new Uint8Array(b.ch);#d=new Uint8Array(b.ch);#s=new Uint8Array(b.ch);#e=new Uint8Array(b.ch*b.cc);#R=new Uint8Array(b.ace);#r=new Uint8Array(b.ch);#n=new Uint8Array(b.ch*b.nn);#g=new Uint8Array(b.ch);#o=new Uint16Array(b.pl);#f=new Uint8Array(b.pl);#U=new Int16Array(b.ch);#C=new Uint8Array(b.ch);#B=0;#a=new Uint8Array(b.ch*b.rpn);#q=new Int8Array(b.ch*oe.length);#p=new Uint8Array(b.drm*b.dpn*b.dnc);#x=new Uint8Array(b.ch);#A=new Uint8Array(128);#v=new Uint8Array(b.cmt*8);#Q=new Uint8Array(1024);#P=new Uint8Array(b.cmt*64);#y=new Uint8Array(b.efx*3);#Y=new Uint8Array(b.ch);#H=0;#E=0;#i=100;#_=0;#W=500;#J=0;#N="";#L=0;#j=0;#Z=0;#w=!0;#c=!1;#ee;#se=new Uint8Array(2);#$=[];#D=new Uint8Array(b.ch);#G=new Uint8Array(b.tr);baseBank=new B("gm","gm2","xg","gs","ns5r","sd","gmega","plg-150vl","plg-150pf","plg-150dx","plg-150an","plg-150dr","plg-100sg","kross","s90es");userBank=new B("gm");initOnReset=!1;aiEfxName="";chRedir(e,a,o){if(this.#G[a])return(this.#G[a]-1)*16+e;if([2,3].indexOf(this.#E)>-1){if(o==1)return e;let h=0,y=!0;for(;y;)this.#D[e+h]==0?(this.#D[e+h]=a,console.debug(`Assign track ${a} to channel ${e+h+1}.`),y=!1):this.#D[e+h]==a?y=!1:(h+=16,h>=128&&(h=0,y=!1));return e+h}else return e}forceVoiceRefresh(){for(let e=0;e<b.ch;e++)this.#T[e]&&this.dispatchEvent("voice",{part:e})}#h=[];#I;#l={nOff:(e,a)=>{let o=e*128+a,h=this.#o.lastIndexOf(o);h>-1&&(this.#e[b.cc*e+u[64]]>63?(this.#f[h]=this.NOTE_HELD,this.dispatchEvent("note",{part:e,note:a,velo:this.#n[o],state:this.NOTE_HELD})):this.#e[b.cc*e+u[66]]>63&&this.#f[h]==this.NOTE_SOSTENUTO_SUSTAIN?(this.#f[h]=this.NOTE_SOSTENUTO_HELD,this.dispatchEvent("note",{part:e,note:a,velo:this.#n[o],state:this.NOTE_SOSTENUTO_HELD})):(this.#o[h]=0,this.#n[o]=0,this.#f[h]=this.NOTE_IDLE,this.dispatchEvent("note",{part:e,note:a,velo:0,state:this.NOTE_IDLE})))},nOn:(e,a,o)=>{let h=e*128+a,y=0;for(this.#g[e]&&this.#l.ano(e);this.#f[y]>0&&this.#o[y]!=h;)y++;y<b.pl?(this.#o[y]=h,this.#n[h]=o,this.#f[y]=this.NOTE_SUSTAIN,this.#C[e]<o&&(this.#C[e]=o),this.dispatchEvent("note",{part:e,note:a,velo:o,state:this.NOTE_SUSTAIN})):console.error("Polyphony exceeded.")},nAt:(e,a,o)=>{},cAt:(e,a)=>{},hoOf:e=>{this.#f.forEach((a,o)=>{if(a==this.NOTE_HELD){let h=this.#o[o],y=h>>7;e==y&&(this.#f[o]=this.NOTE_IDLE,this.#o[o]=0,this.#n[h]=0,this.dispatchEvent("note",{part:e,note:h&127,velo:0,state:this.NOTE_IDLE}))}})},soOn:e=>{this.#f.forEach((a,o)=>{let h;switch(a){case this.NOTE_ATTACK:{h=this.NOTE_SOSTENUTO_ATTACK;break}case this.NOTE_DECAY:{h=this.NOTE_SOSTENUTO_DECAY;break}case this.NOTE_SUSTAIN:{h=this.NOTE_SOSTENUTO_SUSTAIN;break}}if(h){this.#f[o]=h;let y=this.#o[o];this.dispatchEvent("note",{part:e,note:y&127,velo:this.#n[y],state:h})}})},soOf:e=>{this.#f.forEach((a,o)=>{if(a==this.NOTE_SOSTENUTO_HELD){let h=this.#o[o],y=h>>7;e==y&&(this.#f[o]=this.NOTE_IDLE,this.#o[o]=0,this.#n[h]=0,this.dispatchEvent("note",{part:e,note:h&127,velo:0,state:this.NOTE_IDLE}))}})},ano:e=>{this.#o.forEach((a,o,h)=>{let y=a>>7,g=a&127;a==0&&this.#n[0]==0||y==e&&this.#l.nOff(y,g)})}};#te={8:function(e){let a=e.channel,o=e.data[0];this.#l.nOff(a,o)},9:function(e){let a=e.channel;this.setChActive(a,1);let o=e.data[0],h=e.data[1];h>0?this.#l.nOn(a,o,h):this.#l.nOff(a,o)},10:function(e){let a=e.channel,o=a*128+e.data[0];this.#o.indexOf(o)>-1&&(this.#n[o]=data[1],this.dispatchEvent("note",{part:a,note:e.data[0],velo:e.data[1],state:this.NOTE_SUSTAIN}))},11:function(e){let a=e.channel;[0,32].indexOf(e.data[0])>-1&&(()=>{switch(this.#t){case m.s90es:case m.motif:{if(e.data[0]==0){[0,63].indexOf(e.data[1])>-1&&this.setChActive(a,1);break}e.data[1]&&this.setChActive(a,1);break}default:{this.setChActive(a,1);break}}})();let o=a*b.cc;switch(e.data[0]){case 96:return;case 97:return;case 120:return;case 121:{this.#l.ano(a),this.#U[a]=0;let h=a*b.cc;this.#e[h+u[1]]=0,this.#e[h+u[5]]=0,this.#e[h+u[64]]=0,this.#e[h+u[65]]=0,this.#e[h+u[66]]=0,this.#e[h+u[67]]=0,this.#e[h+u[11]]=127,this.#e[h+u[101]]=127,this.#e[h+u[100]]=127,this.#e[h+u[99]]=127,this.#e[h+u[98]]=127;return}case 123:{this.#l.ano(a);return}case 124:{this.#l.ano(a);return}case 125:{this.#l.ano(a);return}case 126:{this.#g[a]=1,this.#l.ano(a);return}case 127:{this.#g[a]=0,this.#l.ano(a);return}}if(u[e.data[0]]==null)console.warn(`cc${e.data[0]} is not accepted.`);else{switch(ge.indexOf(e.data[0])>-1&&this.allocateAce(e.data[0]),e.data[0]){case 0:{switch(k()&&console.debug(`${T[this.#t]}, CH${a+1}: ${e.data[1]}`),this.#t==0?e.data[1]<48?(this.#s[a]>0&&(e.data[1]=this.#e[o],e.data[1]=120,console.debug(`Forced channel ${a+1} to stay drums.`)),e.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${e.data[1]}`),this.switchMode("gs"))):e.data[1]==62?this.switchMode("x5d"):e.data[1]==63?this.switchMode("krs"):(e.data[1]==64||e.data[1]==127)&&this.switchMode("xg"):this.#t==m.gs?e.data[1]<56&&this.#s[a]>0&&(e.data[1]=this.#e[o],e.data[1]=120,console.debug(`Forced channel ${a+1} to stay drums.`)):this.#t==m.gm?e.data[1]<48?this.#s[a]>0&&(e.data[1]=120,this.switchMode("gs",!0),console.debug(`Forced channel ${a+1} to stay drums.`)):(e.data[1]==64||e.data[1]==127)&&this.switchMode("xg",!0):this.#t==m.x5d&&e.data[1]>0&&e.data[1]<8&&this.switchMode("05rw",!0),this.#t){case m.xg:{[126,127].indexOf(e.data[1])>-1?this.#s[a]==0&&(this.setChType(a,this.CH_DRUM2),console.debug(`CH${a+1} set to drums by MSB.`)):this.#s[a]>0&&(this.setChType(a,this.CH_MELODIC),console.debug(`CH${a+1} set to melodic by MSB.`));break}case m["05rw"]:case m.x5d:case m.ns5r:{[61,62,126,127].indexOf(e.data[1])>-1?this.#s[a]==0&&(this.setChType(a,this.CH_DRUM2),console.debug(`CH${a+1} set to drums by MSB.`)):this.#s[a]>0&&(this.setChType(a,this.CH_MELODIC),console.debug(`CH${a+1} set to melodic by MSB.`));break}case m.sd:{[104,105,106,107].indexOf(e.data[1])>-1?this.#s[a]==0&&(this.setChType(a,this.CH_DRUM2),console.debug(`CH${a+1} set to drums by MSB.`)):this.#s[a]>0&&(this.setChType(a,this.CH_MELODIC),console.debug(`CH${a+1} set to melodic by MSB.`));break}case m.g2:{e.data[1]==120?this.#s[a]==0&&(this.setChType(a,this.CH_DRUMS),console.debug(`CH${a+1} set to drums by MSB.`)):this.#s[a]>0&&(this.setChType(a,this.CH_MELODIC),console.debug(`CH${a+1} set to melodic by MSB.`));break}}this.dispatchEvent("voice",{part:a});break}case 6:{if(this.#B){[m.xg,m.gs,m.ns5r].indexOf(this.#t)<0&&console.warn(`NRPN commits are not available under "${T[this.#t]}" mode, even when they are supported in Octavia.`);let h=this.#e[o+u[99]],y=this.#e[o+u[98]];if(h==1){let g=Ee.indexOf(y);if(g>-1)this.#e[o+u[71+g]]=e.data[1],k()&&console.debug(`Redirected NRPN 1 ${y} to cc${71+g}.`),this.dispatchEvent("cc",{part:a,cc:71+g,data:e.data[1]});else{let f=oe.indexOf(y);f>-1?this.#q[a*10+f]=e.data[1]-64:console.warn(`NRPN 0x01${y.toString(16).padStart(2,"0")} is not supported.`),k()&&console.debug(`CH${a+1} voice NRPN ${y} commit`)}}else{if(L.indexOf(h)<0){let f=`NRPN 0x${h.toString(16).padStart(2,"0")}${y.toString(16).padStart(2,"0")} `;h==127?console.warn(`${f}is not necessary. Consider removing it.`):console.warn(`${f}is not supported.`)}else{let f=this.#s[a]-2;f<0?console.warn(`CH${a+1} cannot accept drum NRPN as type ${A[this.#s[a]]}.`):this.#p[(f*b.dpn+C[h])*b.dnc+y]=e.data[1]}k()&&console.debug(`CH${a+1} (${A[this.#s[a]]}) drum NRPN ${h} commit`)}}else{let h=F[this.#e[o+u[100]]];this.#e[o+u[101]]==0&&h!=null&&(k()&&console.debug(`CH${a+1} RPN 0 ${this.#e[o+u[100]]} commit: ${e.data[1]}`),e.data[1]=Math.min(Math.max(e.data[1],ne[h][0]),ne[h][1]),this.#a[a*b.rpn+h]=e.data[1])}break}case 32:{switch(k()&&console.debug(`${T[this.#t]}, CH${a+1} LSB: ${e.data[1]}`),this.#t){case m.s90es:case m.motif:{this.setChType(a,[32,40].indexOf(e.data[1])>-1?this.CH_DRUMS:this.CH_MELODIC,this.#t,!0);break}}this.dispatchEvent("voice",{part:a});break}case 38:{this.#B||this.#e[o+101]==0&&F[this.#e[o+100]]!=null&&(this.#a[a*b.rpn+F[this.#e[o+100]]+1]=e.data[1]);break}case 64:{e.data[1]<64&&this.#l.hoOf(a);break}case 66:{e.data[1]>>6?this.#l.soOn(a):this.#l.soOf(a);break}case 98:case 99:{this.#B=1;break}case 100:case 101:{this.#B=0;break}}this.#e[o+u[e.data[0]]]=e.data[1],this.dispatchEvent("cc",{part:a,cc:e.data[0],data:e.data[1]})}},12:function(e){let a=e.channel;switch(this.#t){case m.s90es:case m.motif:{e.data&&this.setChActive(a,1);break}default:this.setChActive(a,1)}this.#r[a]=e.data,this.#x[a]=0,k()&&console.debug(`T:${e.track} C:${a} P:${e.data}`),this.dispatchEvent("voice",{part:a})},13:function(e){let a=this,o=e.channel;this.#o.forEach(function(h){let y=h>>7;o==y&&(a.#n[h]=e.data,a.dispatchEvent("note",{part:o,note:h&127,velo:e.data,state:a.NOTE_SUSTAIN}))})},14:function(e){let a=e.channel;this.#U[a]=e.data[1]*128+e.data[0]-8192,this.dispatchEvent("pitch",{part:a,pitch:this.getPitchShift(a)})},15:function(e){me(e.data).forEach(a=>{let o=a[0],h=a[1];(this.#ae[o]||function(){console.debug(`Unknown manufacturer ${o}.`)})(h,a.subarray(2),e.track)})},248:function(e){},250:function(e){},251:function(e){},252:function(e){},254:function(e){},255:function(e){(this.#h[e.meta]||function(o,h,y){}).call(this,e.data,e.track,e.meta),e.meta!=32&&(this.#_=0);let a=$e.indexOf(e.meta)>-1;if(k()&&console.debug(e),a)return e.reply="meta",e}};#ae={64:(e,a,o)=>{this.#K.run(a,o,e)},65:(e,a,o)=>{if(a[0]<16)if(a[1]==72){let h=a[a.length-1],y=K(a.subarray(3,a.length-1));h==y?this.#k.run(a.subarray(0,a.length-1),o,e):console.warn(`Bad SD checksum ${h}. Should be ${y}.`)}else this.#k.run(a,o,e);else{let h=a[a.length-1],y=K(a.subarray(2,a.length-1));h==y?this.#k.run(a.subarray(0,a.length-1),o,e):console.warn(`Bad GS checksum ${h}. Should be ${y}.`)}},66:(e,a,o)=>{this.#O.run(a,o,e)},67:(e,a,o)=>{this.#m.run(a,o,e)},68:(e,a,o)=>{this.#z.run(a,o,e)},71:(e,a,o)=>{this.#F.run(a,o,e)},126:(e,a,o)=>{this.#X.run(a,o,e)},127:(e,a,o)=>{this.switchMode("gm"),this.#V.run(a,o,e)}};#X;#V;#m;#k;#O;#K;#F;#z;buildRchTree(){let e=[];this.#d.forEach((a,o)=>{e[a]?.constructor||(e[a]=[]),e[a].push(o)}),this.#ee=e}getActive(){return this.#T}getCc(e){let a=e*b.cc,o=this.#e.subarray(a,a+b.cc);return o[u[0]]=o[u[0]]||this.#H,o[u[32]]=o[u[32]]||this.#E,o}getCcCh(e,a){if(H.indexOf(a)<0)throw new Error("CC number not accepted");return this.#e[b.cc*e+u[a]]}getCcAll(){let e=this.#e.slice();for(let a=0;a<b.ch;a++){let o=a*b.cc;e[o+u[0]]=e[o+u[0]]||this.#H,e[o+u[32]]=e[o+u[32]]||this.#E}return e}getChSource(){return this.#d}getChType(){return this.#s}setChType(e,a,o=this.#t,h=!1){a&=15,this.#s[e]=a,a>0&&!h&&(this.#e[e*b.cc+u[0]]=R[o])}setChActive(e,a=0){this.#T[e]!=a&&this.dispatchEvent("channeltoggle",{part:e,active:a}),this.#T[e]=a}getPitch(){return this.#U}getProgram(){return this.#r}getTexts(){return this.#$.slice()}getVel(e){let a=new Map,o=this;return o.#o.forEach(function(h,y){let g=Math.floor(h/128),f=h%128;e==g&&o.#n[h]>0&&a.set(f,{v:o.#n[h],s:o.#f[y]})}),a}getBitmap(){return{bitmap:this.#b,expire:this.#S}}getLetter(){return{text:this.#N,set:this.#j,expire:this.#L}}getMode(){return T[this.#t]}getMaster(){return{volume:this.#i}}getRawStrength(){let e=this;return this.#o.forEach(function(a){let o=Math.floor(a/128);e.#n[a]>e.#C[o]&&(e.#C[o]=e.#n[a])}),this.#C}getStrength(){let e=[],a=this;return this.getRawStrength().forEach(function(o,h){e[h]=Math.floor(o*a.#e[h*b.cc+u[7]]*a.#e[h*b.cc+u[11]]*a.#i/803288)}),e}getRpn(){return this.#a}getNrpn(){return this.#q}getVoice(e,a,o,h){let y=e||this.#H,g=a,f=o||this.#E;T[this.#t]=="ns5r"&&y>0&&y<56&&(f=3);let t=this.userBank.get(y,g,f,h);if(T[this.#t]=="mt32"&&t.name.indexOf("MT-m:")==0){let s=parseInt(t.name.slice(5)),c=s*b.cmt,i="";this.#P.subarray(c,c+10).forEach(r=>{r>31&&(i+=String.fromCharCode(r))}),this.userBank.load(`MSB	LSB	PRG
0	127	${g}	${i}`,!0),t.name=i,t.ending=" "}return(t.ending!=" "||!t.name.length)&&(t=this.baseBank.get(y,g,f,h)),t}getChVoice(e){let a=this.getVoice(this.#e[e*b.cc+u[0]],this.#r[e],this.#e[e*b.cc+u[32]],T[this.#t]);if(this.#x[e])switch(this.#t){case m.mt32:a.ending="~",a.name="",this.#v.subarray(14*(e-1),14*(e-1)+10).forEach(o=>{o>31&&(a.name+=String.fromCharCode(o))})}return a}getPitchShift(e){let a=e*b.rpn;return this.#U[e]/8192*this.#a[a]+(this.#a[a+3]-64)+((this.#a[a+1]<<7)+this.#a[a+2]-8192)/8192}getEffectType(e=0){let a=3*e+1;return this.#y.subarray(a,a+2)}setEffectTypeRaw(e=0,a,o){let h=3*e;this.#y[h]=1,this.#y[h+1+ +a]=o}setEffectType(e=0,a,o){this.setEffectTypeRaw(e,!1,a),this.setEffectTypeRaw(e,!0,o)}getEffectSink(){return this.#Y}setLetterDisplay(e,a,o=0,h=3200){let y=this,g;y.#N=" ".repeat(o),e.forEach(f=>{y.#N+=String.fromCharCode(f>31?f:32),f<32&&(g=g||new Set,g.add(f))}),y.#j=Date.now(),y.#L=Date.now()+h,g&&(g=Array.from(g),g.forEach((f,t,s)=>{s[t]=f.toString(16).padStart(2,"0")}),console.warn(`${a}${a?" ":""}invalid code point${g.length>1?"s":""}: 0x${g.join(", 0x")}`))}allocateAce(e){if(!e||e>95){console.warn(`cc${e} cannot be allocated as an active custom effect.`);return}let a=!0,o=0;for(;a&&o<b.ace;)this.#R[o]==e?a=!1:this.#R[o]||(a=!1,this.#R[o]=e,console.info(`Allocated cc${e} to ACE slot ${o}.`)),o++;o>=b.ace&&console.warn("ACE slots are full.")}getAce(){return this.#R}getChAce(e,a){if(a<0||a>=b.ace)throw new RangeError("No such ACE slot");let o=this.#R[a];if(o){if(H.indexOf(o)>=0)return this.#e[e*b.cc+u[o]];throw new Error(`Invalid ACE source: ${o}`)}else return 0}initDrums(){let e=this;e.#p.fill(64);for(let a=0;a<b.drm;a++){let o=a*b.dpn;for(let h in le){let y=le[h],g=(o+C[h])*b.dnc;e.#p.subarray(g,g+b.dnc).fill(y)}}}init(e=0){let a=this;a.#H=0,a.#E=0,a.#_=0,a.#T.fill(0),a.#e.fill(0),a.#R.fill(0),a.#r.fill(0),a.#n.fill(0),a.#o.fill(0),a.#C.fill(0),a.#U.fill(0),a.#q.fill(0),a.#i=100,a.#$=[],a.#W=500,a.#J=0,a.#S=0,a.#u=0,a.#b.fill(0),a.#c=!1,a.#Z=0,a.#w=!0,a.initDrums(),a.#d.forEach(function(o,h,y){y[h]=h}),a.buildRchTree(),e==0&&(a.dispatchEvent("mode","?"),a.#t=0,a.#D.fill(0),a.#G.fill(0),a.#L=0,a.#N=""),a.#e[b.cc*9]=R[0],a.#e[b.cc*25]=R[0],a.#e[b.cc*41]=R[0],a.#e[b.cc*57]=R[0],a.#s.fill(a.CH_MELODIC),a.#s[9]=a.CH_DRUM1,a.#s[25]=a.CH_DRUM3,a.#s[41]=a.CH_DRUMS,a.#s[57]=a.CH_DRUMS,a.#s[73]=a.CH_DRUM5,a.#s[89]=a.CH_DRUM7,a.#s[105]=a.CH_DRUMS,a.#s[121]=a.CH_DRUMS,a.#Q.fill(0),a.#P.fill(0),a.#A.fill(0),a.#v.fill(0),a.#x.fill(0),a.#y.fill(0),a.#Y.fill(0),a.aiEfxName="",a.userBank.clearRange({msb:0,lsb:127,prg:[0,127]});for(let o=0;o<b.ch;o++){let h=o*b.cc;a.#e[h+u[7]]=100,a.#e[h+u[11]]=127,a.#e[h+u[10]]=64,a.#e[h+u[71]]=64,a.#e[h+u[72]]=64,a.#e[h+u[73]]=64,a.#e[h+u[74]]=64,a.#e[h+u[75]]=64,a.#e[h+u[76]]=64,a.#e[h+u[77]]=64,a.#e[h+u[78]]=64,a.#e[h+u[91]]=40,a.#e[h+u[101]]=127,a.#e[h+u[100]]=127,a.#e[h+u[99]]=127,a.#e[h+u[98]]=127;let y=o*b.rpn;a.#a[y]=2,a.#a[y+1]=64,a.#a[y+2]=0,a.#a[y+3]=64,a.#a[y+4]=0,a.#a[y+5]=0}a.dispatchEvent("mastervolume",a.#i),a.dispatchEvent("efxreverb",a.getEffectType(0)),a.dispatchEvent("efxchorus",a.getEffectType(1)),a.dispatchEvent("efxdelay",a.getEffectType(2)),a.dispatchEvent("efxinsert0",a.getEffectType(3)),a.dispatchEvent("efxinsert1",a.getEffectType(4)),a.dispatchEvent("efxinsert2",a.getEffectType(5)),a.dispatchEvent("efxinsert3",a.getEffectType(6)),a.dispatchEvent("reset"),a.switchMode("?")}switchMode(e,a=!1){let o=this,h=T.indexOf(e);if(h>-1){if(o.#t==0||a){let y=o.#t;o.initOnReset&&a&&(this.init(1),y=m["?"]),o.#t=h,o.#u=0,o.#H=ie[0][h],o.#E=ie[1][h];for(let f=0;f<b.ch;f++)o.#s[f]>0&&o.#e[f*b.cc+u[0]]==R[y]&&(o.#e[f*b.cc]=R[h]);switch(h){case m.mt32:{V.forEach((f,t)=>{let s=t+1;o.#T[s]||(o.#r[s]=f,o.#e[s*b.cc+u[91]]=127)});for(let f=1;f<10;f++)o.dispatchEvent("voice",{part:f});break}}let g;switch(h){case m["?"]:case m.xg:{g=[1,0,65,0,5,0,0,0];break}case m.gm:case m.gs:case m.g2:case m.sd:{g=[40,4,40,18,40,32,32,0];break}case m["05rw"]:case m.x5d:case m.ns5r:{g=[44,1,44,19,44,0,44,0];break}case m.k11:case m.sg:{g=[24,0,0,0,0,0,0,0];break}case m.mt32:{g=[40,4,0,0,0,0,0,0];break}default:g=[0,0,0,0,0,0,0,0]}for(let f=0;f<4;f++)o.#y[3*f]||(o.#y[3*f+1]=g[2*f],o.#y[3*f+2]=g[2*f+1],o.dispatchEvent(`efx${["reverb","chorus","delay","insert"][f]}`,o.getEffectType(f)));o.dispatchEvent("mode",e),o.forceVoiceRefresh()}}else throw new Error(`Unknown mode ${e}`)}newStrength(){this.#C.fill(0)}runJson(e){if(e.type>14)return e.type==15&&e.data.constructor!=Uint8Array&&(e.data=Uint8Array.from(e.data)),this.#te[e.type].call(this,e);{let a=this.chRedir(e.part,e.track),o=!1;this.#ee[a]?.forEach(h=>{e.channel=h,o=!0,this.#te[e.type].call(this,e)}),o||console.warn(`${ce[e.type]?ce[e.type]:e.type}${[11,12].includes(e.type)?(e.data[0]!=null?e.data[0]:e.data).toString():""} event sent to CH${a+1} without any recipient.`)}this.#$.length>100&&this.#$.splice(100,this.#$.length-99)}runRaw(e){}async loadBank(e,a){let o=this;switch(e=e.toLowerCase(),e){case"s7e":{o.userBank.clearRange({msb:63,lsb:[21,22]}),o.userBank.clearRange({msb:63,lsb:[24,27]});break}default:throw new Error(`Unknown bank format ${e}`)}switch(e){case"s7e":{N.context=this,o.userBank.load(await N.read(e,a));break}}o.forceVoiceRefresh()}constructor(){super();let e=this;this.#b=new Uint8Array(256),this.#M[10]=new Uint8Array(512),this.#I=new x,this.userBank.strictMode=!0,this.userBank.load(`MSB	PRG	LSB	NME
062	000	000	
122	000	000	
122	001	000	
122	002	000	
122	003	000	
122	004	000	
122	005	000	
122	006	000	`),this.addEventListener("metacommit",function(t){let{data:s}=t;e.#$[0]?.type==s.type&&e.#$[0]?.amend?(e.#$[0].amend=s.amend,e.#$[0].data+=s.data):e.#$.unshift(s)}),this.#h[1]=function(t){switch(t=t.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),t.slice(0,2)){case"@I":{this.#c=!0,this.dispatchEvent("metacommit",{type:"Kar.Info",data:t.slice(2)?.trimLeft()});break}case"@K":{this.#c=!0,this.dispatchEvent("metacommit",{type:"Kar.Mode",data:t.slice(2)?.trimLeft()}),console.debug(`Karaoke mode active: ${t.slice(2)}`);break}case"@L":{this.#c=!0,this.dispatchEvent("metacommit",{type:"Kar.Lang",data:t.slice(2)?.trimLeft()});break}case"@T":{this.#c=!0,this.dispatchEvent("metacommit",{type:"KarTitle",data:t.slice(2)?.trimLeft()});break}case"@V":{this.#c=!0,this.dispatchEvent("metacommit",{type:"Kar.Ver.",data:t.slice(2)?.trimLeft()});break}case"XF":{let s=t.slice(2).split(":");switch(s[0]){case"hd":{s.slice(1).forEach((c,i)=>{c.length&&this.dispatchEvent("metacommit",{type:["XfSngDte","XfSngRgn","XfSngCat","XfSongBt","XfSngIns","XfSngVoc","XfSngCmp","XfSngLrc","XfSngArr","XfSngPer","XfSngPrg","XfSngTag"][i],data:c})});break}case"ln":{s.slice(1).forEach((c,i)=>{c.length&&this.dispatchEvent("metacommit",{type:["XfKarLng","XfKarNme","XfKarCmp","XfKarLrc","XfKarArr","XfKarPer","XfKarPrg"][i],data:c})});break}default:this.dispatchEvent("metacommit",{type:"XfUnData",data:t})}break}default:this.#c?t[0]=="\\"?(this.dispatchEvent("metacommit",{type:"KarLyric",data:"",amend:!1}),this.dispatchEvent("metacommit",{type:"KarLyric",data:t.slice(1),amend:!0})):t[0]=="/"?(this.dispatchEvent("metacommit",{type:"KarLyric",data:"",mask:!0,amend:!1}),this.dispatchEvent("metacommit",{type:"KarLyric",data:t.slice(1),mask:!0,amend:!0})):this.dispatchEvent("metacommit",{type:"KarLyric",data:t,amend:!0}):t.split(`
`).forEach((s,c)=>{this.dispatchEvent("metacommit",{type:"Cmn.Text",data:s,mask:c!=0})})}},this.#h[2]=function(t){this.dispatchEvent("metacommit",{type:"Copyrite",data:t})},this.#h[3]=function(t,s){s<1&&this.#_<1&&this.dispatchEvent("metacommit",{type:"TrkTitle",data:t})},this.#h[4]=function(t,s){this.dispatchEvent("metacommit",{type:"Instrmnt",data:t})},this.#h[5]=function(t){t.trim()==""?this.dispatchEvent("metacommit",{type:"C.Lyrics",data:"",amend:!1}):this.dispatchEvent("metacommit",{type:"C.Lyrics",data:t,amend:!0})},this.#h[6]=function(t){this.dispatchEvent("metacommit",{type:"C.Marker",data:t})},this.#h[7]=function(t){this.dispatchEvent("metacommit",{type:"CuePoint",data:t})},this.#h[32]=function(t){this.#_=t[0]+1},this.#h[33]=function(t,s){e.#G[s]=t+1},this.#h[81]=function(t,s){e.#W=t/1e3},this.#h[127]=function(t,s){e.#I.run(t,s)},this.#I.default=function(t){console.warn(`Unrecognized sequencer-specific byte sequence: ${t}`)},this.#I.add([67,0,1],function(t,s){e.#G[s]=t[0]+1}),this.#X=new x("universal non-realtime"),this.#V=new x("universal realtime"),this.#m=new x("Yamaha"),this.#k=new x("Roland"),this.#O=new x("Korg"),this.#K=new x("Kawai"),this.#F=new x("Akai"),this.#z=new x("Casio");let a=function(t){console.info(`Unrecognized SysEx in "${this.name}" set.
%o`,t)};this.#X.default=a,this.#V.default=a,this.#m.default=a,this.#k.default=a,this.#O.default=a,this.#K.default=a,this.#F.default=a,this.#z.default=a,this.#X.add([9],t=>{e.switchMode(["gm","?","g2"][t[0]-1],!0),e.#c=e.#c||!1,console.info(`MIDI reset: ${["GM","Init","GM2"][t[0]-1]}`),t[0]==2&&e.init()}),this.#V.add([4,1],t=>{e.#i=((t[1]<<7)+t[0])/16383*100,e.dispatchEvent("mastervolume",e.#i)}).add([4,3],t=>((t[1]<<7)+t[0]-8192)/8192).add([4,4],t=>t[1]-64),this.#m.add([76,0,0],t=>{switch(t[0]){case 125:{e.initDrums(),console.info(`XG drum setup reset: ${t}`);break}case 126:{e.switchMode("xg",!0),e.#c=!1,console.info("MIDI reset: XG");break}default:{let s=[0,0,0,0],c=(i,r)=>{s[r]=i};if(t.subarray(1).forEach((i,r)=>{let n=r+t[0];([c,c,c,c,d=>{this.#i=d*129/16383*100,e.dispatchEvent("mastervolume",e.#i)},d=>{},d=>{}][n]||(()=>{}))(i,r)}),t[0]<4){let i=0;s.forEach(r=>{i=i<<4,i+=r}),i-=1024}}}}).add([76,2,1],t=>{let s="XG ";t[0]<32?(s+="reverb ",t.subarray(1).forEach((c,i)=>{([r=>{e.setEffectTypeRaw(0,!1,r),console.info(`${s}main type: ${U[r]}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},r=>{e.setEffectTypeRaw(0,!0,r),console.debug(`${s}sub type: ${r+1}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},r=>{console.debug(`${s}time: ${J(r)}s`)},r=>{console.debug(`${s}diffusion: ${r}`)},r=>{console.debug(`${s}initial delay: ${r}`)},r=>{console.debug(`${s}HPF cutoff: ${D[r]}Hz`)},r=>{console.debug(`${s}LPF cutoff: ${D[r]}Hz`)},r=>{console.debug(`${s}width: ${r}`)},r=>{console.debug(`${s}height: ${r}`)},r=>{console.debug(`${s}depth: ${r}`)},r=>{console.debug(`${s}wall type: ${r}`)},r=>{console.debug(`${s}dry/wet: ${r}`)},r=>{console.debug(`${s}send: ${S(r)}dB`)},r=>{console.debug(`${s}pan: ${r-64}`)},!1,!1,r=>{console.debug(`${s}delay: ${r}`)},r=>{console.debug(`${s}density: ${r}`)},r=>{console.debug(`${s}balance: ${r}`)},r=>{},r=>{console.debug(`${s}feedback: ${r}`)},r=>{}][t[0]+i]||function(){console.warn(`Unknown XG reverb address: ${t[0]}.`)})(c)})):t[0]<64?(s+="chorus ",t.subarray(1).forEach((c,i)=>{([r=>{e.setEffectTypeRaw(1,!1,r),console.info(`${s}main type: ${U[r]}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},r=>{e.setEffectTypeRaw(1,!0,r),console.debug(`${s}sub type: ${r+1}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},r=>{console.debug(`${s}LFO: ${W[r]}Hz`)},r=>{},r=>{console.debug(`${s}feedback: ${r}`)},r=>{console.debug(`${s}delay offset: ${Z(r)}ms`)},r=>{},r=>{console.debug(`${s}low: ${D[r]}Hz`)},r=>{console.debug(`${s}low: ${r-64}dB`)},r=>{console.debug(`${s}high: ${D[r]}Hz`)},r=>{console.debug(`${s}high: ${r-64}dB`)},r=>{console.debug(`${s}dry/wet: ${r}`)},r=>{console.debug(`${s}send: ${S(r)}dB`)},r=>{console.debug(`${s}pan: ${r-64}`)},r=>{console.debug(`${s}to reverb: ${S(r)}dB`)},!1,r=>{},r=>{},r=>{},r=>{console.debug(`${s}LFO phase diff: ${(r-64)*3}deg`)},r=>{console.debug(`${s}input mode: ${r?"stereo":"mono"}`)},r=>{}][t[0]-32+i]||function(){console.warn(`Unknown XG chorus address: ${t[0]}.`)})(c)})):t[0]<86?(s+="variation ",t.subarray(1).forEach((c,i)=>{([r=>{e.setEffectTypeRaw(2,!1,r),console.info(`${s}main type: ${U[r]}`),e.dispatchEvent("efxdelay",e.getEffectType(2))},r=>{e.setEffectTypeRaw(2,!0,r),console.debug(`${s}sub type: ${r+1}`),e.dispatchEvent("efxdelay",e.getEffectType(2))}][t[0]-64+i]||function(){})(c)})):t[0]<97?(s+="variation ",t.subarray(1).forEach((c,i)=>{[r=>{console.debug(`${s}send: ${S(r)}dB`)},r=>{console.debug(`${s}pan: ${r-64}`)},r=>{console.debug(`${s}to reverb: ${S(r)}dB`)},r=>{console.debug(`${s}to chorus: ${S(r)}dB`)},r=>{console.debug(`${s}connection: ${r?"system":"insertion"}`)},r=>{console.debug(`${s}channel: CH${r+1}`)},r=>{console.debug(`${s}mod wheel: ${r-64}`)},r=>{console.debug(`${s}bend wheel: ${r-64}`)},r=>{console.debug(`${s}channel after touch: ${r-64}`)},r=>{console.debug(`${s}AC1: ${r-64}`)},r=>{console.debug(`${s}AC2: ${r-64}`)}][t[0]-86+i](c)})):t[0]>111&&t[0]<118?s+="variation ":console.warn(`Unknown XG variation address: ${t[0]}`)}).add([76,2,64],t=>{t.subarray(1).forEach((s,c)=>{let i=c+t[0];if(i==0)console.debug(`XG EQ preset: ${["flat","jazz","pop","rock","classic"][s]}`);else{let r=i-1>>2,n=i-1&3,d=`XG EQ ${r} ${["gain","freq","Q","shape"][n]}: `;[()=>{console.debug(`${d}${s-64}dB`)},()=>{console.debug(`${d}${s} (raw)`)},()=>{console.debug(`${d}${s/10}`)},()=>{console.debug(`${d}${["shelf","peak"][+!!s]}`)}][n]()}})}).add([76,3],t=>{let s=t[0],c=t[1],i=`XG Insertion ${t[0]+1} `;t.subarray(2).forEach((r,n)=>{([d=>{e.setEffectTypeRaw(3+s,!1,d),console.info(`${i}main type: ${U[d]}`),e.dispatchEvent(`efxinsert${s}`,e.getEffectType(3+s))},d=>{e.setEffectTypeRaw(3+s,!0,d),console.debug(`${i}sub type: ${d+1}`),e.dispatchEvent(`efxinsert${s}`,e.getEffectType(3+s))}][c+n]||function(){})(r)})}).add([76,6,0],t=>{let s=t[0];s<64?e.setLetterDisplay(t.subarray(1),"XG letter display",s):e.#L=Date.now()}).add([76,7,0],t=>{let s=t[0];e.#u=0,e.#S=Date.now()+3200,e.#b.fill(0);let c=t.subarray(1);for(let i=0;i<s;i++)c.unshift(0);c.forEach(function(i,r){let n=Math.floor(r/16),d=r%16,l=(d*3+n)*7,p=7,$=0;for(l-=d*5,n==2&&(p=2);$<p;)e.#b[l+$]=i>>6-$&1,$++})}).add([76,8],(t,s)=>{let c=e.chRedir(t[0],s,!0),i=t[1],r=b.cc*c,n=`XG CH${c+1} `,d=`Unknown XG part address ${i}.`;t.subarray(2).forEach((l,p)=>{i<1?console.debug(d):i<41?([()=>{e.#e[r+u[0]]=l,e.dispatchEvent("voice",{part:c})},()=>{e.#e[r+u[32]]=l,e.dispatchEvent("voice",{part:c})},()=>{e.#r[c]=l,e.dispatchEvent("voice",{part:c})},()=>{let $=e.chRedir(l,s,!0);e.#d[c]=$,c!=$&&(e.buildRchTree(),console.info(`${n}receives from CH${$+1}`))},()=>{e.#g[c]=+!l},()=>{},()=>{e.setChType(c,l,m.xg),console.debug(`${n}type: ${A[l]||l}`)},()=>{e.#a[b.rpn*c+3]=l},!1,!1,()=>{e.#e[r+u[7]]=l},!1,!1,()=>{e.#e[r+u[10]]=l||128},!1,!1,()=>{e.#e[r+u[128]]=l},()=>{e.#e[r+u[93]]=l},()=>{e.#e[r+u[91]]=l},()=>{e.#e[r+u[94]]=l},()=>{e.#e[r+u[76]]=l},()=>{e.#e[r+u[77]]=l},()=>{e.#e[r+u[78]]=l},()=>{e.#e[r+u[74]]=l},()=>{e.#e[r+u[71]]=l},()=>{e.#e[r+u[73]]=l},()=>{e.#e[r+u[75]]=l},()=>{e.#e[r+u[72]]=l}][i+p-1]||(()=>{}))():i<48?console.debug(d):i<111?i>102&&i<105&&(e.#e[r+u[[5,65][i&1]]]=l):i<114?console.debug(d):i<116?console.debug(`${n}EQ ${["bass","treble"][i&1]} gain: ${l-64}dB`):i<118?console.debug(d):i<120?console.debug(`${n}EQ ${["bass","treble"][i&1]} freq: ${l}`):console.debug(d)})}).add([76,9],(t,s)=>{let c=e.chRedir(t[0],s,!0),i=t[1],r=`PLG-150VL CH${c+1} `;t.subarray(2).forEach((n,d)=>{let l=d+i;switch(l){case 1:{console.info(`${r}breath mode: ${["system","breath","velocity","touch EG"][n]}`);break}case 0:case 27:case 28:break;default:if(l<27){let p=["pressure","embouchure","tonguing","scream","breath noise","growl","throat formant","harmonic enhancer","damping","absorption","amplification","brightness"][l-3>>1];l&1?l<23?(console.debug(`${r}${p} control source: ${te(n)}`),n&&n<96&&e.allocateAce(n)):console.debug(`${r}${p} scale break point: ${n}`):console.debug(`${r}${p} depth: ${n-64}`)}}})}).add([76,10],t=>{}).add([76,16],t=>{}).add([76,17,0,0],t=>{}).add([76,112],t=>{console.debug(`XG enable PLG-1${["50VL","00SG","50DX"][t[0]]} for CH${t[2]+1}.`)}).add([73,0,0],(t,s)=>{let c=t[0],i="MU1000 System: ";t.subarray(1).forEach((r,n)=>{let d=c+n;d==8?console.debug(`${i}LCD contrast set to ${r}.`):d==18?(e.#E=r?126:0,console.debug(`${i}bank defaults to ${r?"MU100 Native":"MU Basic"}.`)):d>=64&&d<69&&[()=>{e.dispatchEvent("channelactive",r)},()=>{r<8?(e.dispatchEvent("channelmin",r<<4),console.debug(`Octavia System: Minimum CH${(r<<4)+1}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{r<8?(e.dispatchEvent("channelmax",(r<<4)+15),console.debug(`Octavia System: Maximum CH${(r<<4)+16}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges")},()=>{e.#w=!!r,console.info(`Octavia System: RS receiving ${["dis","en"][r]}abled.`)}][d-64]()})}).add([73,10,0],(t,s)=>{let c=t[0],i=`MU1000 RS${e.#w?"":" (ignored)"}: `;if(c<16)switch(c){case 2:{let r=e.chRedir(0,s,!0);e.#w&&(e.dispatchEvent("channelmin",r),e.dispatchEvent("channelmax",r+63)),console.info(`${i}Show CH1~64`);break}case 3:{let r=e.chRedir(t[1]<<5,s,!0);e.#w&&e.dispatchEvent("channelmin",r),e.#w&&e.dispatchEvent("channelmax",r+31),console.info(`${i}Show CH${r+1}~CH${r+32}`);break}default:console.debug(`${i}unknown switch ${c} invoked.`)}else if(c<32){if(e.#w){let r=e.chRedir(c-16+(e.#Z<<4),s,!0);e.dispatchEvent("channelactive",r)}}else if(c<36){let r=e.chRedir(c-32<<4,s,!0);e.#w&&(e.dispatchEvent("channelmin",r),e.dispatchEvent("channelmax",r+15),e.#Z=c-32),console.info(`${i}Show CH${r+1}~CH${r+16}`)}}).add([93,3],(t,s)=>{let c=e.chRedir(t[0],s,!0),i=`PLG-100SG CH${c+1} `,r=Date.now();if(t[1]==0){let n="",d=0;t.subarray(2).forEach((l,p)=>{p%2==0?n+=j[l]||l.toString().padStart("0"):d+=l*13}),r>=e.#J&&this.dispatchEvent("metacommit",{type:"SGLyrics",data:"",amend:!1}),this.dispatchEvent("metacommit",{type:"SGLyrics",data:`${ee(n)}`,amend:!0}),e.#J=r+Math.ceil(d/2)+e.#W,k()&&console.debug(`${i}vocals: ${n}`)}else console.warn(`Unknown PLG-100SG data: ${t}`)});let o=function(t,s,c,i){},h=function(t,s){let c=t*b.dpn,i=s[0],r=s[1];s.subarray(2).forEach((n,d)=>{let l=d+r,p=-1;l<16?([()=>{p=24},()=>{p=25},()=>{p=26},()=>{},()=>{p=28},()=>{p=29},()=>{p=30},()=>{p=31},()=>{},()=>{},()=>{},()=>{p=20},()=>{p=21},()=>{p=22},()=>{p=23},()=>{}][l]||(()=>{console.debug(`Unknown XG-style drum param ${l} on set ${t+1}.`)}))():l<32||(l<40?([()=>{p=48},()=>{p=49},!1,!1,()=>{p=52},()=>{p=53}][l-32]||(()=>{console.debug(`Unknown XG-style drum param ${l} on set ${t+1}.`)}))():l<80||([()=>{p=36}][l-80]||(()=>{console.debug(`Unknown XG-style drum param ${l} on set ${t+1}.`)}))()),p>=0?(k()&&console.debug(c,p,i,n),e.#p[(c+C[p])*b.dnc+i]=n):k()&&console.debug(`XG-style drum param ${l} has no writes.`)})},y=function(t,s,c){let i=t*b.dpn,r=(s<<7)+c[0];c.subarray(1).forEach((n,d)=>{let l=d+r,p=l&127,$=l>>7,E=-1;$>1&&([()=>{E=26},()=>{},()=>{E=28},()=>{E=29},()=>{E=30},()=>{},()=>{},()=>{E=31}][$-2]||(()=>{console.debug(`Unknown GS-style drum param ${$} on set ${t+1}.`)}))(),E>-1?(k()&&console.debug(i,E,p,n),e.#p[(i+C[E])*b.dnc+p]=n):k()&&console.debug(`GS-style drum param ${$} has no writes.`)})};this.#m.add([76,48],(t,s,c)=>{h(0,t)}).add([76,49],(t,s,c)=>{h(1,t)}).add([76,50],(t,s,c)=>{h(2,t)}).add([76,51],(t,s,c)=>{h(3,t)}).add([76,52],(t,s,c)=>{h(4,t)}).add([76,53],(t,s,c)=>{h(5,t)}).add([76,54],(t,s,c)=>{h(6,t)}).add([76,55],(t,s,c)=>{h(7,t)}),this.#m.add([89,0],(t,s,c)=>{if(e.eprom){let i=t[0],r=(t[1]<<14)+(t[2]<<7)+t[3]+(e.eprom.offset||0);k()&&console.debug(`MU1000 EPROM trail to 0x${r.toString(16).padStart(6,"0")}, ${i} bytes.`);let n=e.eprom.data;t.subarray(4).forEach((d,l)=>{let p=l>>3,$=l&7;if($==7)for(let E=0;E<7;E++)n[r+7*p+E]+=(d>>6-E&1)<<7;else n[r+7*p+$]=d})}}).add([89,1],(t,s,c)=>{let i=(t[0]<<21)+(t[1]<<14)+(t[2]<<7)+t[3];k()&&console.debug(`MU1000 EPROM jump to 0x${i.toString(16).padStart(6,"0")}.`),e.eprom&&(e.eprom.offset=i)}).add([89,2],(t,s,c)=>{if(e.eprom){let i=(t[0]<<21)+(t[1]<<14)+(t[2]<<7)+t[3]+(e.eprom.offset||0);k()&&console.debug(`MU1000 EPROM write to 0x${i.toString(16).padStart(6,"0")}.`);let r=e.eprom.data;t.subarray(4).forEach((n,d)=>{let l=d>>3,p=d&7;if(p==7)for(let $=0;$<7;$++)r[i+7*l+$]+=(n>>6-$&1)<<7;else r[i+7*l+p]=n})}}).add([89,3],(t,s,c)=>{}),this.#m.add([39,48],(t,s,c)=>{}).add([43,0,0],(t,s,c)=>{let i=[0,0,0,0],r=(n,d)=>{i[d]=n};if(t.subarray(1).forEach((n,d)=>{let l=d+t[0];[r,r,r,r,()=>{this.#i=n*129/16383*100,e.dispatchEvent("mastervolume",e.#i)},()=>n-64,()=>n||128,()=>n,()=>n,()=>{console.debug(`TG300 variation on cc${n}.`)}][l](n,l)}),t[0]<4){let n=0;i.forEach(d=>{n=n<<4,n+=d}),n-=1024}}).add([43,1,0],(t,s,c)=>{}).add([43,2],(t,s,c)=>{let i=e.chRedir(t[0],s,!0),r=t[1],n=b.cc*i,d=`TG300 CH${i+1} `;t.subarray(2).forEach((l,p)=>{p<5?([()=>{},()=>{e.#e[n+u[0]]=l,e.dispatchEvent("voice",{part:i})},()=>{e.#e[n+u[32]]=l,e.dispatchEvent("voice",{part:i})},()=>{e.#r[i]=l,e.dispatchEvent("voice",{part:i})},()=>{let $=e.chRedir(l,s,!0);e.#d[i]=$,i!=$&&(e.buildRchTree(),console.info(`${d}receives from CH${$+1}`))}][p+r]||(()=>{}))(l,p+r):p<21||(p<47?([()=>{e.#g[i]=+!l},()=>{},()=>{},()=>{e.#a[b.rpn*i+3]=l},()=>{},()=>{e.#e[n+u[7]]=l},!1,!1,()=>{e.#e[n+u[10]]=l||128},!1,!1,()=>{console.debug(`${d} AC1 at cc${l}`)},()=>{console.debug(`${d} AC2 at cc${l}`)},()=>{e.#e[n+u[128]]=l},()=>{e.#e[n+u[93]]=l},()=>{e.#e[n+u[91]]=l},()=>{e.#e[n+u[94]]=l},()=>{e.#e[n+u[76]]=l},()=>{e.#e[n+u[77]]=l},()=>{e.#e[n+u[74]]=l},()=>{e.#e[n+u[71]]=l},()=>{e.#e[n+u[73]]=l},()=>{e.#e[n+u[75]]=l},()=>{e.#e[n+u[72]]=l},()=>{e.#e[n+u[78]]=l}][p+r-21]||(()=>{}))(l,p+r):p<95||([()=>{e.#e[n+u[65]]=l},()=>{e.#e[n+u[5]]=l}][p+r-95]||(()=>{}))(l,p+r))})}).add([43,7,0],(t,s,c)=>{let i=t[0];e.setLetterDisplay(t.subarray(1),"TG300 letter display",i)}).add([43,7,1],(t,s,c)=>{e.#u=0,e.#S=Date.now()+3200,e.#b.fill(0),t.forEach(function(i,r){let n=Math.floor(r/16),d=r%16,l=(d*3+n)*7,p=7,$=0;for(l-=d*5,n==2&&(p=2);$<p;)e.#b[l+$]=i>>6-$&1,$++})}),this.#k.add([66,18,0,0,127],(t,s,c)=>{e.switchMode("gs",!0),e.#e[b.cc*9]=120,e.#e[b.cc*25]=120,e.#e[b.cc*41]=120,e.#e[b.cc*57]=120,e.#E=3,e.#c=!1,e.#D.fill(0),console.info(`GS system to ${["single","dual"][t[0]]} mode.`)}).add([66,18,64,0],(t,s,c)=>{switch(t[0]){case 127:{e.switchMode("gs",!0),e.#e[b.cc*9]=120,e.#e[b.cc*25]=120,e.#e[b.cc*41]=120,e.#e[b.cc*57]=120,e.#c=!1,e.#D.fill(0),console.info("MIDI reset: GS");break}default:{let i=[0,0,0,0],r=(n,d)=>{i[d]=n};if(t.subarray(1).forEach((n,d)=>{let l=d+t[0];[r,r,r,r,p=>{this.#i=p*129/16383*100,e.dispatchEvent("mastervolume",e.#i)},p=>{},p=>{}][l](n,d)}),t[0]<4){let n=0;i.forEach(d=>{n=n<<4,n+=d}),n-=1024}}}}).add([66,18,64,1],t=>{let s=t[0];if(s<16){let c="".padStart(s," ");t.subarray(1).forEach((i,r)=>{c+=String.fromCharCode(Math.max(32,i))}),c=c.padEnd(16," "),console.debug(`GS patch name: ${c}`)}else s<48||(s<65?t.subarray(1).forEach((c,i)=>{let r=`GS ${s+i>55?"chorus":"reverb"} `;([()=>{console.info(`${r}type: ${I[c]}`),e.setEffectType(0,40,c),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{},()=>{},()=>{},()=>{},()=>{},!1,()=>{console.debug(`${r}predelay: ${c}ms`)},()=>{console.info(`${r}type: ${ae[c]}`),e.setEffectType(1,40,16+c),e.dispatchEvent("efxchorus",e.getEffectType(1))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${r}to reverb: ${S(c)}`)},()=>{console.debug(`${r}to delay: ${S(c)}`)}][s+i-48]||(()=>{}))()}):s<80?console.debug(`Unknown GS patch address: ${s}`):s<91?t.subarray(1).forEach((c,i)=>{let r="GS delay ";([()=>{console.info(`${r}type: ${se[c]}`),e.setEffectType(2,40,32+c),e.dispatchEvent("efxdelay",e.getEffectType(2))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${r}to reverb: ${S(c)}`)}][s+i-80]||(()=>{}))()}):console.debug(`Unknown GS patch address: ${s}`))}).add([66,18,64,2],t=>{let s="GS EQ ";t.subarray(1).forEach((c,i)=>{([()=>{console.debug(`${s}low freq: ${[200,400][c]}Hz`)},()=>{console.debug(`${s}low gain: ${c-64}dB`)},()=>{console.debug(`${s}high freq: ${[3e3,6e3][c]}Hz`)},()=>{console.debug(`${s}high gain: ${c-64}dB`)}][t[0]+i]||function(){console.warn(`Unknown GS EQ address: ${t[0]+i}`)})()})}).add([66,18,64,3],t=>{let s="GS EFX ",c=function(i,r){let n=re(e.#y.subarray(10,12),r,i);n&&console.debug(`${s}${X(e.#y.subarray(10,12))} ${n}`)};t.subarray(1).forEach((i,r)=>{([()=>{e.setEffectTypeRaw(3,!1,32+i),e.dispatchEvent("efxinsert0",e.getEffectType(3))},()=>{e.setEffectTypeRaw(3,!0,i),console.info(`${s}type: ${X(e.#y.subarray(10,12))}`),e.dispatchEvent("efxinsert0",e.getEffectType(3))},!1,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,()=>{console.debug(`${s}to reverb: ${S(i)}dB`)},()=>{console.debug(`${s}to chorus: ${S(i)}dB`)},()=>{console.debug(`${s}to delay: ${S(i)}dB`)},!1,()=>{console.debug(`${s}1 source: ${i}`),i&&i<96&&e.allocateAce(i)},()=>{console.debug(`${s}1 depth: ${i-64}`)},()=>{console.debug(`${s}2 source: ${i}`),i&&i<96&&e.allocateAce(i)},()=>{console.debug(`${s}2 depth: ${i-64}`)},()=>{console.debug(`${s}to EQ: ${i?"ON":"OFF"}`)}][t[0]+r]||function(n,d){console.warn(`Unknown GS EFX address: ${d}`)})(i,t[0]+r)})}).add([66,18,65],t=>{y((t[0]>>4)+1<<1,t[0]&15,t.subarray(1))}).add([69,18,16],t=>{switch(t[0]){case 0:{let s=t[1];e.setLetterDisplay(t.subarray(2),"GS display text",s);break}case 32:{e.#S=Date.now()+3200,t[1]==0&&(e.#u=Math.max(Math.min(t[2]-1,9),0),k()&&console.debug(`GS switch display page ${t[2]-1}.`));break}default:if(t[0]<6){e.#u>9&&(e.#u=0);let s=t[0]-1<<1|t[1]>>6;e.#u==s&&(e.#S=Date.now()+3200),e.#M[s]?.length||(e.#M[s]=new Uint8Array(256));let c=e.#M[s];k()&&console.debug(`GS frame draw page ${s}.`);let i=t[1]&63;c.fill(0),t.subarray(2).forEach(function(n,d){let l=d+i,p=Math.floor(l/16),$=l%16,E=($*4+p)*5,v=5,w=0;for(E-=$*4,p==3&&(v=1);w<v;)c[E+w]=n>>4-w&1,w++})}else console.warn(`Unknown GS display section: ${t[0]}`)}});let g=function(t,s,c){let i=t[0],r=b.cc*s,n=b.rpn*s,d=`GS CH${s+1} `;i<3?(t.subarray(1).forEach((l,p)=>{[()=>{e.#e[r+u[0]]=l},()=>{e.#r[s]=l},()=>{let $=e.chRedir(l,c,!0);e.#d[s]=$,s!=$&&(e.buildRchTree(),console.info(`${d}receives from CH${$+1}`))}][i+p]()}),e.dispatchEvent("voice",{part:s})):i<19||(i<44?t.subarray(1).forEach((l,p)=>{([()=>{e.#g[s]=+!l},!1,()=>{e.setChType(s,l<<1,m.gs),console.debug(`${d}type: ${l?"drum ":"melodic"}${l||""}`)},()=>{e.#a[n+3]=l},!1,()=>{e.#e[r+u[7]]=l},!1,!1,()=>{e.#e[r+u[10]]=l||128},!1,!1,()=>{console.debug(`${d}CC 1: cc${l}`)},()=>{console.debug(`${d}CC 2: cc${l}`)},()=>{e.#e[r+u[93]]=l},()=>{e.#e[r+u[91]]=l},!1,!1,()=>{e.#a[n+1]=l},()=>{e.#a[n+2]=l},()=>{e.#e[r+u[94]]=l}][i+p-19]||(()=>{}))()}):i<76||console.debug(`Unknown GS part address: ${i}`))},f=function(t,s){let c=t[0],i=`GS CH${s+1} `;c<2?t.subarray(1).forEach((r,n)=>{[()=>{e.#e[b.cc*s+u[32]]=r},()=>{}][c+n]()}):c<32?console.warn(`Unknown GS misc address: ${c}`):c<35?t.subarray(1).forEach((r,n)=>{[()=>{console.debug(`${i}EQ: o${["ff","n"][r]}`)},()=>{},()=>{console.debug(`${i}EFX: o${["ff","n"][r]}`),e.#Y[s]=r,e.dispatchEvent("partefxtoggle",{part:s,active:r})}][c+n-32]()}):console.warn(`Unknown GS misc address: ${c}`)};this.#k.add([66,18,64,16],(t,s)=>{g(t,e.chRedir(9,s,!0),s)}).add([66,18,64,17],(t,s)=>{g(t,e.chRedir(0,s,!0),s)}).add([66,18,64,18],(t,s)=>{g(t,e.chRedir(1,s,!0),s)}).add([66,18,64,19],(t,s)=>{g(t,e.chRedir(2,s,!0),s)}).add([66,18,64,20],(t,s)=>{g(t,e.chRedir(3,s,!0),s)}).add([66,18,64,21],(t,s)=>{g(t,e.chRedir(4,s,!0),s)}).add([66,18,64,22],(t,s)=>{g(t,e.chRedir(5,s,!0),s)}).add([66,18,64,23],(t,s)=>{g(t,e.chRedir(6,s,!0),s)}).add([66,18,64,24],(t,s)=>{g(t,e.chRedir(7,s,!0),s)}).add([66,18,64,25],(t,s)=>{g(t,e.chRedir(8,s,!0),s)}).add([66,18,64,26],(t,s)=>{g(t,e.chRedir(10,s,!0),s)}).add([66,18,64,27],(t,s)=>{g(t,e.chRedir(11,s,!0),s)}).add([66,18,64,28],(t,s)=>{g(t,e.chRedir(12,s,!0),s)}).add([66,18,64,29],(t,s)=>{g(t,e.chRedir(13,s,!0),s)}).add([66,18,64,30],(t,s)=>{g(t,e.chRedir(14,s,!0),s)}).add([66,18,64,31],(t,s)=>{g(t,e.chRedir(15,s,!0),s)}).add([66,18,64,64],(t,s)=>{f(t,e.chRedir(9,s,!0))}).add([66,18,64,65],(t,s)=>{f(t,e.chRedir(0,s,!0))}).add([66,18,64,66],(t,s)=>{f(t,e.chRedir(1,s,!0))}).add([66,18,64,67],(t,s)=>{f(t,e.chRedir(2,s,!0))}).add([66,18,64,68],(t,s)=>{f(t,e.chRedir(3,s,!0))}).add([66,18,64,69],(t,s)=>{f(t,e.chRedir(4,s,!0))}).add([66,18,64,70],(t,s)=>{f(t,e.chRedir(5,s,!0))}).add([66,18,64,71],(t,s)=>{f(t,e.chRedir(6,s,!0))}).add([66,18,64,72],(t,s)=>{f(t,e.chRedir(7,s,!0))}).add([66,18,64,73],(t,s)=>{f(t,e.chRedir(8,s,!0))}).add([66,18,64,74],(t,s)=>{f(t,e.chRedir(10,s,!0))}).add([66,18,64,75],(t,s)=>{f(t,e.chRedir(11,s,!0))}).add([66,18,64,76],(t,s)=>{f(t,e.chRedir(12,s,!0))}).add([66,18,64,77],(t,s)=>{f(t,e.chRedir(13,s,!0))}).add([66,18,64,78],(t,s)=>{f(t,e.chRedir(14,s,!0))}).add([66,18,64,79],(t,s)=>{f(t,e.chRedir(15,s,!0))}),this.#O.add([54,65],(t,s)=>{e.switchMode("x5d");let c=(t[1]<<7)+t[0],i=(t[3]<<7)+t[2],r=e.chRedir(c&15,s,!0),n=b.cc*r;[()=>{i<1||(i<101?(e.setChType(r,e.CH_MELODIC,m.x5d),e.#r[r]=i-1,e.#e[n+u[0]]=82):i<229?(e.setChType(r,e.CH_MELODIC,m.x5d),e.#r[r]=i-101,e.#e[n+u[0]]=56):(e.setChType(r,e.CH_DRUMS,m.x5d),e.#r[r]=de[i-229]||0,e.#e[n+u[0]]=62)),e.dispatchEvent("voice",{part:r})},()=>{e.#e[n+u[7]]=i},()=>{i<31&&(e.#e[n+u[10]]=Math.round((i-15)*4.2+64))},()=>{e.#e[n+u[93]]=P(i)},()=>{e.#e[n+u[91]]=P(i)},()=>{e.#a[r*b.rpn+3]=i>8191?i-16320:64+i},()=>{e.#a[r*b.rpn+1]=i>8191?i-16320:64+i},()=>{i>0&&(e.#a[r*b.rpn]=i)},()=>{}][c>>4]()}).add([54,76,0],(t,s)=>{e.switchMode("x5d",!0);let c="",i=82,r=0,n=0,d="MSB	PRG	LSB	NME";M(t,function(l,p){if(p<16400){let $=p%164;switch(!0){case $<10:{l>31&&(c+=String.fromCharCode(l));break}case $==11:{d+=`
${i}	${r}	${n}	${c.trim().replace("Init Voice","")}`,r++,c="";break}}r>99&&(i=90,r=0)}}),e.userBank.clearRange({msb:82,prg:[0,99],lsb:0}),e.userBank.load(d),k()&&console.debug(d),e.forceVoiceRefresh()}).add([54,77,0],(t,s)=>{e.switchMode("x5d",!0);let c="",i=90,r=0,n=0,d="MSB	PRG	LSB	NME";M(t,function(l,p){if(p<13600){let $=p%136;switch(!0){case $<10:{l>31&&(c+=String.fromCharCode(l));break}case $==11:{d+=`
${i}	${r}	${n}	${c.trim().replace("Init Combi","")}`,r++,c="";break}}}}),e.userBank.clearRange({msb:90,prg:[0,99],lsb:0}),e.userBank.load(d),k()&&console.debug(d),e.forceVoiceRefresh()}).add([54,78],(t,s)=>{e.switchMode("x5d",!0),console.debug(`X5D mode switch requested: ${["combi","combi edit","prog","prog edit","multi","global"][t[0]]} mode.`)}).add([54,85],(t,s)=>{e.switchMode("x5d",!0),M(t,(c,i)=>{i>0&&i<3&&(e.setEffectType(i-1,44,c),e.dispatchEvent(`efx${["reverb","chorus"][i-1]}`,e.getEffectType(i-1)))})}).add([54,104],(t,s)=>{e.switchMode("x5d",!0),M(t,function(c,i,r,n){if(i<192){let d=e.chRedir(Math.floor(i/12),s,!0),l=d*b.cc;switch(i%12){case 0:{c<128?(e.setChType(d,e.CH_MELODIC,m.x5d),e.#e[l+u[0]]=82,e.#r[d]=c):(e.setChType(d,e.CH_DRUMS,m.x5d),e.#e[l+u[0]]=62,e.#r[d]=de[c-128]),c>0&&e.setChActive(d,1),e.dispatchEvent("voice",{part:d});break}case 1:{e.#e[l+u[7]]=c;break}case 2:{e.#a[d*b.rpn+3]=c>127?c-192:64+c;break}case 3:{e.#a[d*b.rpn+1]=c>127?c-192:64+c;break}case 4:{c<31&&(e.#e[l+u[10]]=Math.round((c-15)*4.2+64));break}case 5:{let p=c>>4,$=c&15;e.#e[l+u[91]]=P($),e.#e[l+u[93]]=P(p);break}case 10:break;case 11:{let p=e.chRedir(c&15,s,!0),$=c>>4;e.#d[d]=c,(p!=d||$)&&(console.info(`X5D Part CH${d+1} receives from CH${p+1}.`),e.buildRchTree())}}}else{let d=e.chRedir(i-192,s,!0)}})}),this.#k.add([22,18,127],t=>{e.switchMode("mt32",!0),e.#c=!1,e.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),console.info("MIDI reset: MT-32")}).add([22,18,0],(t,s,c)=>{e.switchMode("mt32");let i=e.chRedir(c,s,!0),r=t[1];t.subarray(2).forEach((n,d)=>{let l=d+r;e.#A[l+(i-1)*16]=n,([!1,()=>{let p=e.#A[i-1<<4];if(p<3){if(e.#x[i]=1,p==2)for(let $=0;$<name.length;$++)e.#v[(i-1)*b.cmt+$]=e.#P[n*b.cmt+$];else{let $=e.baseBank.get(0,n+(p<<6),127,"mt32").name;for(let E=0;E<$.length;E++)e.#v[(i-1)*b.cmt+E]=$.charCodeAt(E)}e.dispatchEvent("voice",{part:i})}},()=>{e.#a[i*b.rpn+3]=n+40},()=>{e.#a[i*b.rpn+1]=n+14},()=>{e.#a[i*b.rpn]=n},!1,()=>{e.#e[b.cc*i+u[91]]=n?127:0},!1,()=>{e.#e[b.cc*i+u[7]]=n},()=>{e.#e[b.cc*i+u[10]]=Math.ceil(n*9.05)}][l]||(()=>{}))()})}).add([22,18,1],(t,s,c)=>{e.switchMode("mt32");let i=c&7;console.debug(`MT-32 slot #${c+1} Drum: ${t}`);let r=t[0]<<7|t[1];t.subarray(2).forEach((n,d)=>{let l=d+r,p=(l>>2)+24,$=l&3,E=i*b.dpn;if(k()&&console.debug(`MT-32 temp drum note ${p} param ${$}: ${n}`),p<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${p}`);return}[()=>{},()=>{e.#p[(E+C[26])*b.dnc+p]=Math.round(n*1.27)},()=>{e.#p[(E+C[26])*b.dnc+p]=n*9+1&127},()=>{e.#p[(E+C[26])*b.dnc+p]=n?127:0}][$]()})}).add([22,18,2],(t,s,c)=>{e.switchMode("mt32");let i=e.chRedir(c,s,!0),r=t[1]+(t[0]<<7);r<10&&(e.#x[i]=1),t.subarray(2).forEach((n,d)=>{let l=d+r;l<14&&(e.#v[(i-1)*b.cmt+l]=n)}),e.dispatchEvent("voice",{part:i})}).add([22,18,3],(t,s,c)=>{e.switchMode("mt32");let i=c&7;if(t[0]){let r=(t[0]-1<<7)+t[1]-16;t.subarray(2).forEach((n,d)=>{let l=d+r,p=(l>>2)+24,$=l&3,E=i*b.dpn;if(k()&&console.debug(`MT-32 dev drum note ${p} param ${$}: ${n}`),p<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${p}`);return}[()=>{},()=>{e.#p[(E+C[26])*b.dnc+p]=Math.round(n*1.27)},()=>{e.#p[(E+C[26])*b.dnc+p]=n*9+1&127},()=>{e.#p[(E+C[26])*b.dnc+p]=n?127:0}][$]()})}else{let r=t[1];t.subarray(2).forEach((n,d)=>{let l=d+r;e.#A[l]=n;let p=e.chRedir(1+(l>>4),s,!0),$=l&15;([!1,()=>{let E=e.#A[p-1<<4];if(E<3)if(e.#x[p]=1,E==2)for(let v=0;v<name.length;v++)e.#v[(p-1)*b.cmt+v]=e.#P[n*b.cmt+v];else{let v=e.baseBank.get(0,n+(E<<6),127,"mt32").name;for(let w=0;w<v.length;w++)e.#v[(p-1)*b.cmt+w]=v.charCodeAt(w)}e.dispatchEvent("voice",{part:p})},()=>{e.#a[p*b.rpn+3]=n+40},()=>{e.#a[p*b.rpn+1]=n+14},()=>{e.#a[p*b.rpn]=n},!1,()=>{e.#e[b.cc*p+u[91]]=n?127:0},!1,()=>{e.#e[b.cc*p+u[7]]=n},()=>{e.#e[b.cc*p+u[10]]=Math.ceil(n*9.05)}][$]||(()=>{}))()})}}).add([22,18,4],(t,s,c)=>{e.switchMode("mt32");let i=t[1]+(t[0]<<7),r=[];t.subarray(2).forEach((n,d)=>{let l=d+i,p=e.chRedir(Math.floor(l/246+1),s,!0),$=l%246;$<14&&(e.#v[(p-1)*b.cmt+$]=n),$<10&&(e.#x[p]=1),r.indexOf(p)<0&&r.push(p)}),r.forEach(n=>{e.dispatchEvent("voice",{part:n})})}).add([22,18,5],(t,s,c)=>{e.switchMode("mt32");let i=(t[0]<<7)+t[1];t.subarray(2).forEach((r,n)=>{let d=i+n,l=Math.floor(d/8),p=d&7,$=l*8;e.#Q[d]=r,([!1,()=>{let E=e.#Q[$];if(E<3){let v="";if(E==2){let w=b.cmt*l;v=`MT-m:${r.toString().padStart(3,"0")}`}else v=e.baseBank.get(0,r+(E<<6),127,"mt32").name;e.userBank.clearRange({msb:0,lsb:127,prg:l}),e.userBank.load(`MSB	LSB	PRG	NME
000	127	${l}	${v}`,!0)}}][p]||(()=>{}))()}),e.forceVoiceRefresh()}).add([22,18,8],(t,s,c)=>{e.switchMode("mt32");let i=((t[0]&1)<<7)+t[1];t.subarray(2).forEach((r,n)=>{let d=i+n;d<b.cmt&&(e.#P[(t[0]>>1)*b.cmt+d]=r)}),e.forceVoiceRefresh()}).add([22,18,16],(t,s,c)=>{e.switchMode("mt32");let i=t[1],r=!1,n=function(d,l){e.#d[l-12]=d,r=!0};t.subarray(2).forEach((d,l)=>{let p=l+i;([!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,n,n,n,n,n,n,n,n,n,()=>{e.#i=d,e.dispatchEvent("mastervolume",e.#i)}][p]||(()=>{}))(d,l)}),r&&e.buildRchTree()}).add([22,18,32],t=>{e.switchMode("mt32");let s=t[1],c=" ".repeat(s);t.subarray(2).forEach(i=>{i>31?c+=String.fromCharCode(i):c+=" "}),e.#N=c.padStart(20," "),e.#L=Date.now()+3200}).add([22,18,82],(t,s)=>{let c=e.chRedir(0,s,!0);for(let i=0;i<16;i++)e.#l.ano(c+i),i&&i<10&&(e.#r[c+i]=V[i-1]);console.info("MT-32 alt reset complete.")}),this.#O.add([66,0],(t,s)=>{e.switchMode("ns5r",!0),e.#c=!1,console.debug(`NS5R mode switch requested: ${["global","multi","prog edit","comb edit","drum edit","effect edit"][t[0]]} mode.`)}).add([66,1],(t,s)=>{e.switchMode(["ns5r","05rw"][t[0]],!0),e.#c=!1}).add([66,18,0,0],(t,s)=>{let c=t[0];switch(c){case 124:case 126:case 127:{e.switchMode("ns5r",!0),e.#c=!1;break}case 125:{e.initDrums(),console.info(`NS5R drum setup reset: ${t}`);break}default:if(c<10){let i=[0,0,0,0],r=(n,d)=>{i[d]=n};if(t.subarray(1).forEach((n,d)=>{[r,r,r,r,()=>{e.#i=n*129/16383*100,e.dispatchEvent("mastervolume",e.#i)},()=>n-64,()=>n-64,()=>{},()=>{},()=>{}][c+d]()}),t[0]<4){let n=0;i.forEach(d=>{n=n<<4,n+=d}),n-=1024}}}}).add([66,18,0,1],(t,s)=>{}).add([66,18,0,2],(t,s)=>{}).add([66,18,1],(t,s)=>{let c=e.chRedir(t[0],s,!0),i=c*b.cc,r=t[1],n=`NS5R CH${c+1} `;t.subarray(2).forEach((d,l)=>{let p=r+l;p<3?([()=>{e.#e[i+u[0]]=d||121},()=>{e.#e[i+u[32]]=d},()=>{e.#r[c]=d}][p](),e.dispatchEvent("voice",{part:c})):p<8||(p<14?[()=>{let $=e.chRedir(d,s,!0);e.#d[c]=$,c!=$&&(e.buildRchTree(),console.info(`${n}receives from CH${$+1}`))},()=>{e.#g[c]=+!d},()=>{e.setChType(c,d,m.ns5r),console.debug(`${n}type: ${A[d]}`)},()=>{e.#a[b.rpn*c+3]=d},()=>{},()=>{}][p-8]():p<16||(p<33?[()=>{e.#e[i+u[7]]=d},()=>{e.#e[i+u[11]]=d},()=>{},()=>{},()=>{e.#e[i+u[10]]=d||128},()=>{},()=>{},()=>{e.#e[i+u[93]]=d},()=>{e.#e[i+u[91]]=d},()=>{e.#e[i+u[76]]=d},()=>{e.#e[i+u[77]]=d},()=>{e.#e[i+u[78]]=d},()=>{e.#e[i+u[74]]=d},()=>{e.#e[i+u[71]]=d},()=>{e.#e[i+u[73]]=d},()=>{e.#e[i+u[75]]=d},()=>{e.#e[i+u[72]]=d}][p-16]():p<112||p<114&&[()=>{e.#e[i+u[5]]=d},()=>{e.#e[i+u[65]]=d}][p-112]()))})}).add([66,18,8,0],(t,s)=>{let c=t[0];if(c<32)e.setLetterDisplay(t.subarray(1,33),"NS5R letter display");else{let i=c-32;e.#S=Date.now()+3200,e.#u=10,e.#b.fill(0);let r=t.subarray(1),n=4;r.forEach(function(d,l){let p=l+i,$=p>>4,E=p&15;if(p<80){let v=$<n?d:d>>3,w=0,fe=$<n?6:3;for(;v>0;)e.#b[E*32+$*7+(fe-w)]=v&1,v=v>>1,w++}})}}).add([66,18,48],(t,s,c)=>{h(0,t)}).add([66,18,49],(t,s,c)=>{h(1,t)}).add([66,18,50],(t,s,c)=>{h(2,t)}).add([66,18,51],(t,s,c)=>{h(3,t)}).add([66,18,52],(t,s,c)=>{h(4,t)}).add([66,18,53],(t,s,c)=>{h(5,t)}).add([66,18,54],(t,s,c)=>{h(6,t)}).add([66,18,55],(t,s,c)=>{h(7,t)}).add([66,52],(t,s)=>{e.switchMode("ns5r",!0),e.#c=!1;let c="";M(t,(i,r)=>{r<8?(i>31&&(c+=String.fromCharCode(i)),r==7&&(e.aiEfxName=c)):r<10&&(e.setEffectType(r-8,44,i),e.dispatchEvent(`efx${["reverb","chorus"][r-8]}`,e.getEffectType(r-8)))})}).add([66,53],(t,s)=>{e.switchMode("ns5r",!0),e.#c=!1,M(t,function(c,i){switch(!0){case i<2944:{let r=e.chRedir(Math.floor(i/92),s,!0),n=r*b.cc;switch(i%92){case 0:{e.#e[n+u[0]]=c||121,e.dispatchEvent("voice",{part:r});break}case 1:{e.#e[n+u[32]]=c,e.dispatchEvent("voice",{part:r});break}case 2:{e.#r[r]=c,c>0&&e.setChActive(r,1),e.dispatchEvent("voice",{part:r});break}case 3:{let d=e.chRedir(c,s,!0);e.#d[r]=d,r!=d&&(console.info(`NS5R CH${r+1} receives from CH${d+1}.`),e.buildRchTree())}case 7:break;case 8:{e.#a[r*b.rpn+3]=c<40||c>88?c+(c>63?-192:64):c;break}case 9:case 10:{e.#e[n+u[7]]=c;break}case 11:{e.#e[n+u[11]]=c;break}case 14:{e.#e[n+u[10]]=c||128;break}case 19:{e.#e[n+u[93]]=c;break}case 20:{e.#e[n+u[91]]=c;break}case 84:{e.#e[n+u[65]]=c;break}case 85:{e.#e[n+u[5]]=c;break}}break}case i<3096:break;case i<3134:break;case i<8566:break}})}).add([66,54],(t,s)=>{e.switchMode("ns5r",!0);let c="",i=80,r=0,n=0,d="MSB	PRG	LSB	NME";M(t,function(l,p){let $=p%158;switch(!0){case $<10:{l>31&&(c+=String.fromCharCode(l));break}case $==11:{i=l&127;break}case $==12:{n=l&127;break}case $==13:{d+=`
${i}	${r}	${n}	${c.trim().replace("Init Voice","")}`,r++,c="";break}}}),e.userBank.clearRange({msb:80,lsb:0}),e.userBank.load(d),k()&&console.debug(d),e.forceVoiceRefresh()}).add([66,55],(t,s)=>{e.switchMode("ns5r",!0);let c="",i=88,r=0,n=0,d="MSB	PRG	LSB	NME";M(t,function(l,p){let $=p%126;switch(!0){case $<10:{l>31&&(c+=String.fromCharCode(l));break}case $==11:break;case $==12:break;case $==13:{d+=`
${i}	${r}	${n}	${c.trim().replace("Init Combi","")}`,r++,c="";break}}}),e.userBank.clearRange({msb:88,lsb:0}),e.userBank.load(d),k()&&console.debug(d),e.forceVoiceRefresh()}).add([66,125],t=>{e.dispatchEvent("backlight",["green","orange","red",!1,"yellow","blue","purple"][t[0]]||"white")}).add([66,127],t=>{let s=new Uint8Array(5760);M(t,(c,i,r)=>{if(i<720)for(let n=0;n<8;n++)s[i*8+n]=c>>7-n&1}),e.dispatchEvent("screen",{type:"ns5r",data:s})}).add([76],(t,s,c)=>{e.#O.run([66,...t],s,c)}),this.#K.add([16,0,8,0],(t,s,c)=>{let i=(t[2]<<4)+t[3],r="K11 ";([()=>{e.switchMode("k11",!0),e.#c=!1,e.#E=i?4:0,console.info("MIDI reset: GMega/K11")},()=>{e.setEffectType(0,24,i),console.debug(`${r}reverb type: ${i}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{console.debug(`${r}reverb time: ${i}`)},()=>{console.debug(`${r}reverb time: ${i}`)},()=>{console.debug(`${r}reverb predelay: ${i}`)},()=>{console.debug(`${r}reverb predelay: ${i}`)},()=>{console.debug(`${r}depth high: ${i}`)},()=>{console.debug(`${r}depth high: ${i}`)},()=>{console.debug(`${r}depth low: ${i}`)},()=>{console.debug(`${r}depth low: ${i}`)}][t[0]]||(()=>{}))()}).add([16,0,8,1],(t,s,c)=>{let i=e.chRedir(t[1],s,!0),r=b.cc*i,n=b.rpn*i,d=(t[3]<<4)+t[4],l=`K11 CH${i+1} `;([()=>{d<128?(e.setChType(i,e.CH_MELODIC,m.k11),e.#e[r+u[0]]=0,e.#r[i]=d):(e.setChType(i,e.CH_DRUMS,m.k11),e.#r[i]=d-128),e.dispatchEvent("voice",{part:i})},()=>{let p=e.chRedir(d,s,!0);e.#d[i]=p,i!=p&&(e.buildRchTree(),console.info(`${l}receives from CH${p+1}`))},()=>{e.#e[r+u[7]]=d},()=>{uupThis.setChActive(i,d)},()=>{e.#e[r+u[10]]=d},()=>{e.#a[n+3]=d+40},()=>{e.#a[n+1]=d>>1,e.#a[n+2]=d&1},()=>{e.#e[r+u[91]]=d?127:0},()=>{},()=>{e.#e[r+u[74]]=d},()=>{e.#e[r+u[73]]=d},()=>{e.#e[r+u[72]]=d}][t[0]]||(()=>{}))()}).add([16,0,9,0],(t,s,c)=>{let i=(t[2]<<4)+t[3],r="GMLX ";([()=>{console.debug(`${r}reverb type: ${i}`)},()=>{console.debug(`${r}reverb time: ${i}`)},()=>{console.debug(`${r}reverb predelay: ${i}`)},()=>{console.debug(`${r}depth high: ${i}`)},()=>{console.debug(`${r}depth low: ${i}`)}][t[0]]||(()=>{}))()}).add([16,0,9,3],(t,s,c)=>{let i=(t[2]<<4)+t[3],r=e.chRedir(t[1],s,!0),n=r*b.cc;[()=>{i<128?(e.setChType(r,e.CH_MELODIC,m.k11),e.#e[n+u[0]]=0,e.#e[n+u[32]]=0,e.#r[r]=i):i<160?(e.setChType(r,e.CH_MELODIC,m.k11),e.#e[n+u[0]]=0,e.#e[n+u[32]]=7,e.#r[r]=i-100):(e.setChType(r,e.CH_DRUMS,m.k11),e.#e[n+u[0]]=122,e.#e[n+u[32]]=0,e.#r[r]=i-160),e.dispatchEvent("voice",{part:r})},()=>{let d=e.chRedir(i,s,!0);e.#d[r]=d,r!=d&&(e.buildRchTree(),console.info(`GMLX CH${r+1} receives from CH${d+1}`))}][t[0]]()}).add([16,0,9,4],(t,s,c)=>{let i=(t[2]<<4)+t[3],r=e.chRedir(t[1],s,!0),n=r*b.cc,d=r*b.rpn,l=`GMLX CH${r+1} `;[()=>{e.setChActive(r,i)},()=>{e.#e[n+u[7]]=i},()=>{e.#e[n+u[10]]=i},()=>{e.#e[n+u[91]]=i?127:0},()=>{e.#a[d+3]=i+40},()=>{e.#a[d+1]=i},()=>{e.#a[d]=i},()=>{}][t[0]]()}),this.#F.add([66,93,64],(t,s,c)=>{let i=t[2];switch(t[0]){case 0:{switch(t[1]){case 4:{e.#i=i*129/16383*100,e.dispatchEvent("mastervolume",e.#i);break}case 5:{i-64;break}case 6:{console.debug(`SG global reverb: ${i?"on":"off"}`);break}case 127:{e.switchMode("sg",!0);break}}break}case 1:{switch(t[1]){case 48:{console.debug(`SG reverb type: ${I[i]}`);break}}break}default:if(t[0]>>4==1){let r=e.chRedir(t[0]&15,s,!0);if(t[1]==2){let n=e.chRedir(i,s,!0);e.#d[r]=n,r!=n&&(e.buildRchTree(),console.info(`SG CH${r+1} receives from CH${n+1}`))}else t[1]==19&&(e.#e[b.cc*r+u[7]]=i)}else console.warn(`Unknown AKAI SG SysEx: ${t}`)}}),this.#z.add([9],(t,s,c)=>{console.debug(`GZ set effect: ${["stage reverb","hall reverb","room reverb","chorus","tremelo","phaser","rotary speaker","enhancer","flanger","EQ"][t[0]]||"off"}`)}),this.#m.add([127,0],(t,s,c)=>{e.switchMode("motif");let i=new Uint8Array([127,1,...t]);e.#m.run(i,s,c)}).add([127,1,0,0],(t,s,c)=>{e.switchMode("s90es");let i="S90/Motif ES system ",r=t[0];t.subarray(1).forEach((n,d)=>{([()=>{e.#i=n*12900/16383,e.dispatchEvent("mastervolume",e.#i)}][r+d]||(()=>{console.info(`Unrecognized ${i}ID: ${r+d}`)}))()})}).add([127,1,0,0,14],(t,s,c)=>{e.switchMode("s90es");let i="S90/Motif ES bulk header ",r=[];r[95]=(n,d,l)=>{console.debug(`${i}multi edit buffer: ${n[1]}`)},(r[t[0]]||(()=>{console.info(`Unrecognized ${i}ID: ${t[0]}.`)}))(t.subarray(1))}).add([127,1,0,0,15],(t,s,c)=>{e.switchMode("s90es");let i="S90/Motif ES bulk footer ",r=[];r[95]=(n,d,l)=>{console.debug(`${i}multi edit buffer: ${n[1]}`)},(r[t[0]]||(()=>{console.info(`Unrecognized ${i}ID: ${t[0]}.`)}))(t.subarray(1))}).add([127,1,0,58,55],(t,s,c)=>{e.switchMode("s90es");let i=e.chRedir(t[0],s,!0),r=b.cc*i,n=t[1],d=`S90/Motif ES bulk CH${i<16?i+1:"U"+(i-95)} `;console.debug(d,t),!(t[0]>15)&&t.subarray(2).forEach((l,p)=>{([()=>{e.#e[r+u[0]]=l,e.dispatchEvent("voice",{part:i})},()=>{l&&e.setChActive(i,1),e.#e[r+u[32]]=l,e.setChType(i,[32,40].indexOf(l)>-1?e.CH_DRUMS:e.CH_MELODIC,e.#t,!0),e.dispatchEvent("voice",{part:i})},()=>{l&&e.setChActive(i,1),e.#r[i]=l,e.dispatchEvent("voice",{part:i})},()=>{let $=e.chRedir(l,s,!0);e.#d[i]=$,i!=$&&(e.buildRchTree(),console.info(`${d}receives from CH${$+1}`))},()=>{e.#g[i]=l?0:1},!1,!1,!1,!1,!1,!1,!1,!1,()=>{e.#e[r+u[7]]=l},()=>{e.#e[r+u[10]]=l},!1,!1,!1,()=>{e.#e[r+u[91]]=l},()=>{e.#e[r+u[93]]=l},()=>{e.#e[r+u[94]]=l},()=>{e.#e[r+u[128]]=l},()=>{},()=>{e.#e[r+u[74]]=l},()=>{e.#e[r+u[71]]=l},!1,()=>{e.#e[r+u[65]]=l},()=>{e.#e[r+u[5]]=l},()=>{}][n+p]||(()=>{}))()})}).add([127,1,54,16],(t,s,c)=>{e.switchMode("s90es");let i=t[0];t.subarray(1).forEach((r,n)=>{let l=`S90/Motif ES EQ${(n>>2)+1} `;([()=>{let p=r-64},()=>{let p=D[r]},()=>{let p=r/10},()=>{let p=r}][i+n&3]||(()=>{}))()})}),this.#k.add([0,72,18,0,0,0,0],(t,s,c)=>{e.switchMode("sd",!0),console.info("MIDI reset: SD")}).add([0,72,18,16,0],(t,s,c)=>{let i=t[0]>>5,r=t[0]&31;switch(i){case 0:{console.debug(`Unknown SD-90 global effects message:
%o`,t);break}case 1:{let n=e.chRedir(r,s,!0),d=t[1],l=n*b.cc;t.subarray(2).forEach((p,$)=>{let E=d+$;E<37?([()=>{},()=>{},0,()=>{},()=>{switch(e.#e[l+u[0]]=p,p){case 104:case 105:case 106:case 107:case 120:{e.#s[n]||e.setChType(n,e.CH_DRUMS);break}default:e.#s[n]&&e.setChType(n,e.CH_MELODIC)}e.dispatchEvent("voice",{part:n})},()=>{e.#e[l+u[32]]=p,e.dispatchEvent("voice",{part:n})},()=>{e.#r[n]=p,e.dispatchEvent("voice",{part:n})},()=>{e.#e[l+u[7]]=p},()=>{e.#e[l+u[10]]=p},()=>{},()=>{},()=>{p<2&&(e.#g[n]=p)},()=>{p<2&&(e.#e[l+u[68]]=p?127:0)},()=>{},()=>{p<2&&(e.#e[l+u[65]]=p?127:0)},()=>{e.#e[l+u[5]]=p&15<<4|e.#e[l+u[5]]&15},()=>{e.#e[l+u[5]]=p&15|(e.#e[l+u[5]]&240)>>4},()=>{e.#e[l+u[74]]=p},()=>{e.#e[l+u[71]]=p},()=>{e.#e[l+u[73]]=p},()=>{e.#e[l+u[72]]=p},0,0,0,0,0,0,0,()=>{e.#e[l+u[128]]=p},()=>{e.#e[l+u[93]]=p},()=>{e.#e[l+u[91]]=p},0,0,()=>{e.#e[l+u[75]]=p},()=>{e.#e[l+u[76]]=p},()=>{e.#e[l+u[77]]=p},()=>{e.#e[l+u[78]]=p}][E]||(()=>{}))():E<63||(E<64?e.#s[n]?e.#e[l+u[0]]=104|p:e.#e[l+u[0]]=96|p:console.debug(`Unknown SD-90 global CH${n+1} param setup message:
%o`,t))});break}case 2:{let n=e.chRedir(r,s,!0),d=t[1];console.debug(`Unknown SD-90 global CH${n+1} MIDI setup message:
%o`,t.subarray(2));break}default:console.warn(`Unknown SD-90 global part setup message:
%o`,t)}})}};export{Ke as OctaviaDevice,b as allocated,u as ccToPos,C as dnToPos};
