var Le=Object.create;var de=Object.defineProperty;var Ue=Object.getOwnPropertyDescriptor;var Ne=Object.getOwnPropertyNames;var He=Object.getPrototypeOf,Be=Object.prototype.hasOwnProperty;var _e=(e,a)=>()=>(a||e((a={exports:{}}).exports,a),a.exports);var Ge=(e,a,l,h)=>{if(a&&typeof a=="object"||typeof a=="function")for(let u of Ne(a))!Be.call(e,u)&&u!==l&&de(e,u,{get:()=>a[u],enumerable:!(h=Ue(a,u))||h.enumerable});return e};var Xe=(e,a,l)=>(l=e!=null?Le(He(e)):{},Ge(a||!e||!e.__esModule?de(l,"default",{value:e,enumerable:!0}):l,e));var Te=_e((vt,ce)=>{(function(){"use strict";let e={fatal:!0},a=[new TextDecoder("iso-8859-15",e),new TextDecoder("utf-8",e),new TextDecoder("sjis",e),new TextDecoder("euc-jp",e),new TextDecoder("ascii")],l={debug:!1,parse:function(h,u){if(h instanceof Uint8Array)return l.Uint8(h);if(typeof h=="string")return l.Base64(h);if(h instanceof HTMLElement&&h.type==="file")return l.addListener(h,u);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(h,u){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(h===void 0||!(h instanceof HTMLElement)||h.tagName!=="INPUT"||h.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;u=u||function(){},h.addEventListener("change",function(b){if(!b.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let m=new FileReader;m.readAsArrayBuffer(b.target.files[0]),m.onload=function(C){u(l.Uint8(new Uint8Array(C.target.result)))}})},Base64:function(h){let u=function(C){var $="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(C=C.replace(/^.*?base64,/,""),C=String(C).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(C))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");C+="==".slice(2-(3&C.length));let v,t="",c,s,r=0;for(;r<C.length;)v=$.indexOf(C.charAt(r++))<<18|$.indexOf(C.charAt(r++))<<12|(c=$.indexOf(C.charAt(r++)))<<6|(s=$.indexOf(C.charAt(r++))),t+=c===64?String.fromCharCode(v>>16&255):s===64?String.fromCharCode(v>>16&255,v>>8&255):String.fromCharCode(v>>16&255,v>>8&255,255&v);return t}(h=String(h));var b=u.length;let m=new Uint8Array(new ArrayBuffer(b));for(let C=0;C<b;C++)m[C]=u.charCodeAt(C);return l.Uint8(m)},Uint8:function(m){let u={data:null,pointer:0,movePointer:function(c){return this.pointer+=c,this.pointer},readInt:function(c){if((c=Math.min(c,this.data.byteLength-this.pointer))<1)return-1;let s=0;if(1<c)for(let r=1;r<=c-1;r++)s+=this.data.getUint8(this.pointer)*Math.pow(256,c-r),this.pointer++;return s+=this.data.getUint8(this.pointer),this.pointer++,s},readStr:function(c){let s=new Uint8Array(c),r=!1,i;s.forEach((o,n)=>{s[n]=this.readInt(1)});for(let o=0;o<a.length;o++)if(!r)try{if(i=a[o].decode(s),o===0)for(let n=0;n<i.length;n++){let f=i.charCodeAt(n);if(f>191||f>127&&f<160)throw new RangeError(`Invalid code point: ${f}`)}r=!0,console.debug(`String byte sequence in ${a[o].encoding}`)}catch(n){console.debug(`SMF string ${n}`)}return i||"String byte sequence read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let c=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)c=this.readInt(1);else{let r=[];for(;128<=this.data.getUint8(this.pointer);)r.push(this.readInt(1)-128);var s=this.readInt(1);for(let i=1;i<=r.length;i++)c+=r[r.length-i]*Math.pow(128,i);c+=s}return c}};if(u.data=new DataView(m.buffer,m.byteOffset,m.byteLength),u.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;u.readInt(4);let b={};b.formatType=u.readInt(2),b.tracks=u.readInt(2),b.track=[];var m=u.readInt(1),C=u.readInt(1);128<=m?(b.timeDivision=[],b.timeDivision[0]=m-128,b.timeDivision[1]=C):b.timeDivision=256*m+C;for(let c=1;c<=b.tracks;c++){b.track[c-1]={event:[]};var $,v=u.readInt(4);if(v===-1)break;if(v!==1297379947)return!1;u.readInt(4);let s=0,r=!1,i,o;for(;!r&&(s++,b.track[c-1].event[s-1]={},b.track[c-1].event[s-1].deltaTime=u.readIntVLV(),(i=u.readInt(1))!==-1);)if(128<=i?o=i:(i=o,u.movePointer(-1)),i===255){b.track[c-1].event[s-1].type=255,b.track[c-1].event[s-1].metaType=u.readInt(1);var t=u.readIntVLV();switch(b.track[c-1].event[s-1].metaType){case 47:case-1:r=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:b.track[c-1].event[s-1].data=u.readStr(t);break;case 33:case 89:case 81:b.track[c-1].event[s-1].data=u.readInt(t);break;case 84:b.track[c-1].event[s-1].data=[],b.track[c-1].event[s-1].data[0]=u.readInt(1),b.track[c-1].event[s-1].data[1]=u.readInt(1),b.track[c-1].event[s-1].data[2]=u.readInt(1),b.track[c-1].event[s-1].data[3]=u.readInt(1),b.track[c-1].event[s-1].data[4]=u.readInt(1);break;case 88:b.track[c-1].event[s-1].data=[],b.track[c-1].event[s-1].data[0]=u.readInt(1),b.track[c-1].event[s-1].data[1]=u.readInt(1),b.track[c-1].event[s-1].data[2]=u.readInt(1),b.track[c-1].event[s-1].data[3]=u.readInt(1);break;default:this.customInterpreter!==null&&(b.track[c-1].event[s-1].data=this.customInterpreter(b.track[c-1].event[s-1].metaType,u,t)),this.customInterpreter!==null&&b.track[c-1].event[s-1].data!==!1||(u.readInt(t),b.track[c-1].event[s-1].data=u.readInt(t),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((i=i.toString(16).split(""))[1]||i.unshift("0"),b.track[c-1].event[s-1].type=parseInt(i[0],16),b.track[c-1].event[s-1].channel=parseInt(i[1],16),b.track[c-1].event[s-1].type){case 15:this.customInterpreter!==null&&(b.track[c-1].event[s-1].data=this.customInterpreter(b.track[c-1].event[s-1].type,u,!1)),this.customInterpreter!==null&&b.track[c-1].event[s-1].data!==!1||($=u.readIntVLV(),b.track[c-1].event[s-1].data=u.readInt($),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:b.track[c-1].event[s-1].data=[],b.track[c-1].event[s-1].data[0]=u.readInt(1),b.track[c-1].event[s-1].data[1]=u.readInt(1);break;case 12:case 13:b.track[c-1].event[s-1].data=u.readInt(1);break;case-1:r=!0;break;default:if(this.customInterpreter!==null&&(b.track[c-1].event[s-1].data=this.customInterpreter(b.track[c-1].event[s-1].metaType,u,!1)),this.customInterpreter===null||b.track[c-1].event[s-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return b},customInterpreter:null};if(typeof ce<"u")ce.exports=l;else{let h=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;h.MidiParser=l}})()});var fe=function(e,a){let l=Math.min(e.length,a.length),h=e.slice(0,l),u=a.slice(0,l),b=0,m=0;for(;m<l&&b==0;)b=Math.sign(h[m]-u[m]),m++;return b},I=function(e=""){this.name=e,this.pool=[],this.point=function(a,l=!1){if(this.pool.length>0){let h=this.pool.length,u=1<<Math.floor(Math.log2(h)),b=u,m=64;for(;u>=1&&m>=0;){if(m<=0)throw new Error("TTL reached.");if(b==h)b-=u;else{let $=fe(a,this.pool[b]);switch($){case 0:{m=0;break}case 1:{b+u<=h&&(b+=u);break}case-1:{b!=0&&(b-=u);break}default:console.warn(`Unexpected result ${$}.`)}}u=u>>1,m--}let C=!0;if(b>=this.pool.length)C=!1;else{let $=this;this.pool[b].forEach(function(v,t,c){C&&v!=a[t]&&(C=!1)}),!C&&fe(a,this.pool[b])>0&&b++}return C||l?b:-1}else return l?0:-1},this.add=function(a,l){return a.data=l,this.pool.splice(this.point(a,!0),0,a),this},this.default=function(a){console.warn(`No match in "${this.name||"(unknown)"}" for "${a}". Default action not defined.`)},this.get=function(a){let l=this.point(a);if(l>-1)return this.pool[l].data;this.default(a)},this.run=function(a,...l){let h=this.point(a);h>-1?a.subarray?this.pool[h].data(a.subarray(this.pool[h].length),...l):this.pool[h].data(a.slice(this.pool[h].length),...l):this.default(a,...l)}};var he=class{#t={};addEventListener(e,a){this.#t[e]||(this.#t[e]=[]),this.#t[e].unshift(a)}removeEventListener(e,a){if(this.#t[e]){let l=this.#t[e].indexOf(a);l>-1&&this.#t[e].splice(l,1),this.#t[e].length<1&&delete this.#t[e]}}dispatchEvent(e,a){let l=new Event(e),h=this;l.data=a,this.#t[e]?.length>0&&this.#t[e].forEach(function(u){try{u?.call(h,l)}catch(b){console.error(b)}}),this[`on${e}`]&&this[`on${e}`](l)}};var Ke=["MSB","PRG","LSB","NME","ELC","DRM","LVL","VXP"],Fe={krs:"KR",s90es:"ES",motif:"ES"},Ve={krs:"Kr",s90es:"SE",motif:"ME"},te=function(e){let a=Math.floor(e/10),l=e%10;return`${a.toString(16)}${l}`},ae=class{#t;get bankInfo(){return this.#t}strictMode=!1;get(e=0,a=0,l=0,h,u=0){let b=[e,a,l],m,C=1,$=0,v,t,c,s=Array.from(arguments);switch(h){case"xg":{switch(e){case 0:{l===126?s[2]=125:l===127&&(s[2]=0);break}case 16:{l===126&&(s[2]=0);break}case 32:{l>125&&(s[2]=0),s[2]+=4;break}case 33:{(l>125||l===3)&&(s[2]=0),s[2]+=5;break}case 34:case 35:case 36:{l>125&&(s[2]=0),s[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:s[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{l===126&&(s[2]=0);break}case 48:case 64:case 126:case 127:{l===126&&(e===127&&a===0||(s[2]=0));break}case 121:{switch(l){case 126:{s[2]=0;break}case 16:{s[2]=15;break}default:s[2]=s[2]&15}break}}break}case"gs":case"sc":{e===0&&l<5?s[0]=49:e<128&&e>125&&l<5&&l!==2&&(s[2]=e,s[0]=49);break}case"mt32":{e===0&&(s[0]=49);break}case"sd":{switch(e){case 121:{s[0]=96;break}case 120:{s[0]=104;break}}s[0]>>1===40?s[2]|=16:s[0]>95&&s[0]<100&&(s[2]|=16,a>>4===7&&(s[0]=96));break}case"pa":{switch(e){case 120:{l==64?s[2]=2:s[2]=1;break}case 121:{switch(l){case 127:{s[2]=79;break}default:s[2]=(s[2]&63)+32}break}}break}case"g2":{e>>1===40?s[2]|=16:e>95&&e<100&&(s[2]|=16,a>>4===7&&(s[0]=96));break}case"sg":{e===8&&l===0&&(s[2]=5);break}case"05rw":case"x5d":{e&&e<56&&(s[0]=56);break}case"s90es":case"motif":case"an1x":case"cs1x":case"cs6x":{if(e===0)break;switch(e){case 63:{switch(h){case"s90es":{l<8?s[2]+=17:l<32?s[2]+=13:s[2]=(s[2]>>3)+19;break}case"motif":{l<8?s[2]+=28:l<32?s[2]+=13:s[2]=(s[2]>>3)+19;break}case"cs1x":{switch(l>>1){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:{s[2]+=34;break}case 32:{s[2]=34+((l&1)<<2);break}case 33:{s[2]=47+((l&1)<<2);break}case 61:{s[2]=34+((l&1)<<2);break}case 62:{s[2]=47+((l&1)<<2);break}}break}}break}case 32:{l>125&&(s[2]=0),s[2]+=4;break}case 33:{(l>125||l===3)&&(s[2]=0),s[2]+=5;break}case 34:case 35:case 36:{l>125&&(s[2]=0),s[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:s[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{l===126&&(s[2]=0);break}}break}}let r=" ",i="M",o="",n=0,f=0;switch(s[0]){case 0:{switch(s[2]){case 127:{i="GM-a";break}case 126:{i="GM-n";break}case 7:{i="GM-k",o="GLX";break}case 5:{i="SG-a",o="000";break}case 4:{h==="gs"||h==="sc"?(i="GM-a",o="000"):(i="SP-l",o="C/M");break}case 3:case 2:case 1:{(h==="gs"||h==="sc")&&(i="GM-a",o="000");break}case 0:{i="GM-a";break}default:i="y",n=3}break}case 8:{h==="sg"?i="GM-s":i="r:";break}case 32:case 33:case 34:case 35:case 36:{h==="xg"&&(i=`${["AP","VL","PF","DX","AN"][e&7]}-${"abcdefgh"[l]}`,n=3);break}case 48:{o=`M${(s[2]>>3).toString().padStart(2,"0")}`,i=`y${o}`,n=1;break}case 49:{s[2]>>1===63?(i=`MT-${"ba"[s[2]&1]}`,o=`C${"-/"[s[2]&1]}M`):(i="GM-a",o="000");break}case 56:{i="GM-b";break}case 57:i=["yDOC","QY10","QY20"][s[2]-112]||"yMxv",o=["DOC","QY1","QY2"][s[2]-112]||"057";case 61:case 128:{i="rDrm";break}case 120:{i="gDrm";break}case 62:{i="kDrm";break}case 63:{if(s[2]<17){let w=s[2];i=w<10?"kP:":"kC:",i+=w%10}else if(s[2]<34)i=["Pre1","Pre2","Pre3","Pre4","Usr1","Usr2","DrmP","DrmU","Plg1","Plg2","Plg3","Pre1","Pre2","Pre3","Pre4","Pre5","Pre6"][s[2]-17];else if(s[2]<55){let w=s[2]-34;switch(w>12&&w--,l>>1){case 32:case 33:{i=`Pr${l-63}U`;break}case 61:case 62:{i=`Pr${l-121}U`;break}default:i=s[2]===46?"PrDr":`Pr${(w>>2)+1}${String.fromCharCode(65+(w&3))}`}}else i="Ds";n=1;break}case 64:{i="ySFX",o="SFX";break}case 67:{i="DX:S";break}case 80:case 81:case 82:case 83:{i=`Prg${"UABC"[s[0]-80]}`;break}case 88:case 89:case 90:case 91:{i=`Cmb${"UABC"[s[0]-88]}`;break}case 95:{i=`${["DR","PC"][s[2]]}-d`;break}case 96:{i=s[2]===106?"AP-a":s[2]>>4===1?"SDg":"PF",s[2]>63?f=63:s[2]>>4===1&&(f=16),n=3;break}case 97:{i=s[2]>>4===1?"SDa":"VL:",n=3,s[2]>>4===1?f=16:f=112;break}case 98:{i=s[2]>>4===1?"SDb":"SG-a",n=3,f=16;break}case 99:{i=s[2]>>4===1?"SDc":"DX",s[2]>63?f=63:s[2]>>4===1&&(f=16),n=3;break}case 100:{i="AN",s[2]>63?f=63:s[2]>>4===1&&(f=16),n=3;break}case 104:case 105:case 106:case 107:{i="SDd",f=104;break}case 121:{i=`GM${s[2]?"":"-a"}`,n=1;break}case 122:{i="lDrm";break}case 126:{i="yDrS";break}case 127:{s[2]===127?i="rDrm":i="yDrm";break}default:s[0]<48?i="r:":i="M"}i.length<4&&(i+=`${[e,l,s[0],s[2]][n]-f}`.padStart(4-i.length,"0")),o.length<3&&(o+=`${[e,l,e,l][n]}`.padStart(3-o.length,"0")),h==="xg"&&(e===0?s[2]<100?i=i.replace("y0","y:"):s[2]===125&&(i="y126"):e===16?(m=`Voice${((s[2]<<7)+s[1]+1).toString().padStart(3,"0")}`,r=" "):e===35&&l>>1===2&&(m=`DXCH_${(((s[2]&1)<<7)+a+1).toString().padStart(3,"0")}`,r=" "));let d=[s[0],s[1],s[2]];for(;!(m?.length>=0);)if(m=this.#t[s[1]||0][(s[0]<<8)+s[2]]?.name,m){let w=this.#t[s[1]||0][(s[0]<<8)+s[2]];C=w?.poly||C,$=w?.type||$,v=w?.drum,t=w?.level,c=w?.voice}else if(this.strictMode)m="",r="?";else if(s[0]===0&&s[1]===0&&s[2]===0)m="Unloaded";else if(this.#t[s[1]||0][s[0]<<8])s[0]===0?(s[2]=0,r="^"):s[2]<1?(s[0]=0,r="*"):(s[2]--,r="^");else if(e===48)s[0]=0,s[2]=0,r="!";else if(e===62)s[1]--,r=" ",s[1]<1&&!m?.length&&(s[0]=0,r="!");else if(e<63)s[0]===0?(s[2]=0,r="^"):s[2]<1?(s[0]=0,r="*"):s[2]--;else if(e===80)m=`PrgU:${a.toString().padStart(3,"0")}`,r="!";else if(e===88)m=`CmbU:${a.toString().padStart(3,"0")}`,r="!";else if(e===121)m=`GM2Vox0${l}`,r="#";else if(e===122)if(s[1]===32?s[1]:s[1]%=7,m=this.#t[s[1]||0][(s[0]<<8)+s[2]]?.name,m){r=" ";let w=this.#t[s[1]||0][(s[0]<<8)+s[2]];C=w?.poly||C,$=w?.type||$,v=w?.drum,t=w?.level}else m="",r="*";else s[1]===0?(m=`${e.toString().padStart(3,"0")} ${a.toString().padStart(3,"0")} ${l.toString().padStart(3,"0")}`,r="!"):s[0]===0?(s[2]=0,r="^"):s[2]>0?s[2]--:s[1]>0?(s[1]=0,r="!"):(s[0]=0,r="?");let g=[s[0],s[1],s[2]];switch(r){case"^":{switch(h){case"gs":case"sc":case"ns5r":{r=" ";break}case"xg":{l===126&&(r=" ");break}}e===127&&(r=" ");break}case"*":break;case"!":break;case"?":break}let y="??";switch(s[0]){case 0:{s[2]===0?y="GM":s[2]===5||s[2]===7?y="KG":s[2]<126&&(y="XG");break}case 32:case 33:case 35:case 36:{s[2]>4?y=["AP","VL","PF","DX","AN"][s[0]-32]:y="GS";break}case 48:{y="MU";break}case 49:{s[2]>>1===63?y="MT":s[2]<5&&(y="GM");break}case 56:{y="AG";break}case 61:case 80:case 83:case 88:case 89:case 91:{y="AI";break}case 62:case 82:case 90:{y="XD";break}case 63:{s[2]<17?y="KR":s[2]<34?y="ES":s[2]<55?y="CS":y="DS";break}case 64:case 126:{y="XG";break}case 67:case 99:{y=s[2]>>4===1?"SD":"DX";break}case 81:{y="RW";break}case 95:{y=["DR","PC"][s[2]];break}case 96:{y=s[2]===106?"AP":s[2]>>4===1?"SD":"PF";break}case 97:{y=s[2]>>4===1?"SD":"VL";break}case 98:{y=s[2]>>4===1?"SD":"SG";break}case 100:{y="AN";break}case 104:case 105:case 106:case 107:{y="SD";break}case 120:{y=a===0?"GM":["G2","PA","PA"][s[2]]??"G2";break}case 128:{y=a===0?"GM":"GS";break}case 121:{y=s[2]?["G2","XG","PA","PA","PA"][s[2]>>4]:"GM";break}case 122:{y="KG";break}case 127:{y=s[2]===127?"MT":a===0?"GM":"XG";break}default:s[0]<48&&(s[0]===16&&h==="xg"?y="XG":y="GS")}if(r!==" ")switch(h){case"krs":case"s90es":case"motif":{m="",y=Fe[h],r="?";break}case"g2":{m="GM2 Ext?",r="?";break}case"pa":{r==="^"&&(m="Unknown",r="?");break}default:self.debugMode&&(m="",r="?")}return{name:m||`${Ve[h]||h.toUpperCase()}${te(e||0)}${te(a||0)}${te(l||0)}`,poly:C,type:$,drum:v,level:t,voice:c,iid:d,eid:g,sid:b,ending:r,sect:i,bank:o,standard:y,mode:h}}async load(e,a,l="(internal)",h){let u=this,b=[],m=0,C=0,$=0;e.split(`
`).forEach(function(v,t){let c=v.split("	"),s=[];if(t===0){if(c.forEach(function(r,i){b[Ke.indexOf(r)]=i}),b.length<4){console.debug("Debugger launched.");debugger}}else{let r=0,i=0,o=0,n,f=1,d=0,g,y,w;c.forEach(function(R,ee){switch(ee){case b[0]:{r=parseInt(R);break}case b[1]:{i=parseInt(R);break}case b[2]:{o=parseInt(R);break}case b[3]:{n=R;break}case b[4]:{R=parseInt(R),R<16?f=R+1:(d=(R&15)+1,f=d);break}case b[5]:{y=R;break}case b[6]:{typeof R=="string"&&(g=parseInt(R));break}case b[7]:{w=R;break}}}),u.#t[i]=u.#t[i]||[];let x=u.#t[i],P={msb:r,prg:i,lsb:o,name:n,poly:f,type:d,drum:y,level:g,voice:w,priority:h},O=!1;h<x[r<<8|o]?.priority&&(O=!0,$++),(!x[r<<8|o]||O||a)&&(x[r<<8|o]=P,m++),C++}}),a||console.debug(`Map: From "${l}", ${C} total, ${m} loaded (${m-$} + ${$}).`)}clearRange(e){let a=e.prg!==void 0?e.prg.constructor===Array?e.prg:[e.prg,e.prg]:[0,127],l=e.msb!==void 0?e.msb.constructor===Array?e.msb:[e.msb,e.msb]:[0,127],h=e.lsb!==void 0?e.lsb.constructor===Array?e.lsb:[e.lsb,e.lsb]:[0,127];for(let u=l[0];u<=l[1];u++){let b=u<<8;for(let m=h[0];m<=h[1];m++){let C=b+m;for(let $=a[0];$<=a[1];$++)delete this.#t[$][C]}}}init(){this.#t=[];for(let e=0;e<128;e++)this.#t.push([""])}async loadFiles(...e){this.init();let a=this;e.forEach(async function(l,h){try{a.load(await(await fetch(`./data/bank/${l}.tsv`)).text(),!1,l,h)}catch{console.error(`Failed loading "${l}.tsv".`)}})}constructor(...e){this.loadFiles(...e)}};var ue=class{#t={};context;set(e,a){this.#t[e]=a}has(e){return!!this.#t[e]}async read(e,a){if(!this.has(e))throw new Error(`No decoder registered for "${e}"`);return await this.#t[e].call(this.context||this,a)}};var Ye=function(e,a){let l=!0;return a.forEach((h,u)=>{l=l&&e[u]===h}),l},K=function(e){let a=0;return e.forEach(l=>{a*=256,a+=l}),a},N=new TextDecoder,F=new ue;F.set("s7e",async function(e){let a=new Uint8Array(await e.slice(0,65536).arrayBuffer()),l="MSB	LSB	PRG	NME",h=[0,0,0,0],u=32,b=0,m=0,C=!0,$=[],v=0;for(;C;){let t=a.subarray(b);([()=>{N.decode(t.subarray(0,4))==="YSFC"?(b+=80,m=1):b++},()=>{if(Ye(t.subarray(0,4),h))$.forEach((c,s,r)=>{let i=K(a.subarray(c.start+4,c.start+8));c.length=i}),m=2;else{let c=N.decode(t.subarray(0,4)),s=K(t.subarray(4,8));$.push({type:c,start:s}),b+=8}},()=>{let c=$[v],s=a.subarray(c.start,c.start+c.length),r=32;switch(c.type){case"ENVC":{let i=u;for(;i<s.length;){let o=s.subarray(i,i+r),n=N.decode(o.subarray(0,10)).trimEnd();n.slice(0,5)==="Init "&&(n=""),n&&(l+=`
063	${(o[17]+13).toString().padStart(3,"0")}	${o[19].toString().padStart(3,"0")}	${n}`),i+=r}break}case"EDVC":{let i=u;for(;i<s.length;){let o=s.subarray(i,i+r),n=N.decode(o.subarray(0,10)).trimEnd();n.slice(0,5)==="Init "&&(n=""),n&&(l+=`
063	024	${o[19].toString().padStart(3,"0")}	${n}`),i+=r}break}case"EPVC":{let i=32,o=u;for(;o<s.length;){let n=s.subarray(o,o+i),f=N.decode(n.subarray(0,10)).trimEnd();f==="----------"&&(f=""),f&&(l+=`
063	${(n[17]+1).toString().padStart(3,"0")}	${n[19].toString().padStart(3,"0")}	${f}`),o+=i}break}}v++,v>=$.length&&(m=3,C=!1)}][m]||(()=>{C=!1}))()}return l});F.set("pcg",async function(e){let a=new Uint8Array(await e.arrayBuffer()),l="MSB	LSB	PRG	NME",h=100,u=0,b=0,m=!0,C=[],$=0;for(;m;){let v=a.subarray(h);([()=>{m=N.decode(v.subarray(0,4))==="INI2",b=v[15],h+=16,u=1},()=>{let t=N.decode(v.subarray(0,4)),c=v[5],s=v[7],r=v[11],i=K(v.subarray(12,16)),o=K(v.subarray(16,20)),n=K(v.subarray(36,40)),f=N.decode(v.subarray(44,44+r));C.push({type:t,tipMsb:c,tipLsb:s,nameLen:r,length:i,start:o,entryLen:n,name:f}),h+=64,b--,b<1&&(u=2)},()=>{let t=C[$],c=a.subarray(t.start,t.start+t.length);switch(t.type){case"PRG1":break;case"PBK1":{let s=63,r=(t.tipMsb?6:0)+t.tipLsb;for(let i=0;i<128;i++){let o=i*t.entryLen,n=c.subarray(o,o+t.entryLen),f=N.decode(n.subarray(0,24)).trimEnd().replace("InitProg","");f.length&&r>5&&(l+=`
${s.toString().padStart(3,"0")}	${r.toString().padStart(3,"0")}	${i.toString().padStart(3,"0")}	${f}`)}break}case"CBK1":{let s=63,r=(t.tipMsb?3:0)+t.tipLsb+10;for(let i=0;i<128;i++){let o=i*t.entryLen,n=c.subarray(o,o+t.entryLen),f=N.decode(n.subarray(0,24)).trimEnd().replace("InitCombi","");f.length&&r>12&&(l+=`
${s.toString().padStart(3,"0")}	${r.toString().padStart(3,"0")}	${i.toString().padStart(3,"0")}	${f}`)}break}}$++,$>=C.length&&(u=3,m=!1)}][u]||(()=>{m=!1}))()}return l});var V=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]),Y=["melodic","drums","drum set 1","drum set 2","drum set 3","drum set 4","drum set 5","drum set 6","drum set 7","drum set 8"],ze=[17.1,18.6,20.2,21.8,23.3,24.9,26.5,28,29.6,31.2,32.8,34.3,35.9,37.5,39,40.6,42.2,43.7,45.3,46.9,48.4,50],_=[20,22,25,28,32,36,40,45,50,56,63,70,80,90,100,110,125,140,160,180,200,225,250,280,315,355,400,450,500,560,630,700,800,900,1e3,1100,1200,1400,1600,1800,2e3,2200,2500,2800,3200,3600,4e3,4500,5e3,5600,6300,7e3,8e3,9e3,1e4,11e3,12e3,14e3,16e3,18e3,2e4],pe=[0,.04,.08,.13,.17,.21,.25,.29,.34,.38,.42,.46,.51,.55,.59,.63,.67,.72,.76,.8,.84,.88,.93,.97,1.01,1.05,1.09,1.14,1.18,1.22,1.26,1.3,1.35,1.39,1.43,1.47,1.51,1.56,1.6,1.64,1.68,1.72,1.77,1.81,1.85,1.89,1.94,1.98,2.02,2.06,2.1,2.15,2.19,2.23,2.27,2.31,2.36,2.4,2.44,2.48,2.52,2.57,2.61,2.65,2.69,2.78,2.86,2.94,3.03,3.11,3.2,3.28,3.37,3.45,3.53,3.62,3.7,3.87,4.04,4.21,4,37,4.54,4.71,4.88,5.05,5.22,5.38,5.55,5.72,6.06,6.39,6.73,7.07,7.4,7.74,8.08,8.41,8.75,9.08,9.42,9.76,10.1,10.8,11.4,12.1,12.8,13.5,14.1,14.8,15.5,16.2,16.8,17.5,18.2,19.5,20.9,22.2,23.6,24.9,26.2,27.6,28.9,30.3,31.6,33,34.3,37,39.7],be=function(e){let a=.1,l=-.3;return e>66?(a=5,l=315):e>56?(a=1,l=47):e>46&&(a=.5,l=18.5),a*e-l},ye=function(e){return e>105?ze[e-106]:e>100?e*1.1-100:e/10},ge=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),re={};`hi*,
ka,か
ki,き
ku,く
ke,け
ko,こ
ky,き!
kw,くl
tsu,つ
ts,つl
sa,さ
si,すぃ
su,す
se,せ
so,そ
shi,し
sh,し!
ta,た
ti,てぃ
tu,とぅ
te,て
to,と
tchy,ち!
tchi,ち
na,な
ni,に
nu,ぬ
ne,ね
no,の
ny,に!
nn,ん
ha,は
hi,ひ
hu,ほぅ
he,へ
ho,ほ
hy,ひ!
fa,ふぁ
fi,ふぃ
fu,ふ
fe,ふぇ
fo,ふぉ
ma,ま
mi,み
mu,む
me,め
mo,も
my,み!
mm,ㇺ
ra,ら
ri,り
ru,る
re,れ
ro,ろ
ry,り!
wa,わ
wi,ゐ
we,ゑ
wo,を
nga,か゚
ngi,き゚
ngu,く゚
nge,け゚
ngo,こ゚
ngy,き゚!
ng,ン
ga,が
gi,ぎ
gu,ぐ
ge,げ
go,ご
gy,ぎ!
gw,ぐl
za,ざ
zi,ずぃ
zu,ず
ze,ぜ
zo,ぞ
ja,じゃ
ji,じ
ju,じゅ
je,じぇ
jo,じょ
jy,じ!
da,だ
di,でぃ
du,どぅ
de,で
do,ど
dy,で!
ba,ば
bi,び
bu,ぶ
be,べ
bo,ぼ
by,び!
va,ゔぁ
vi,ゔぃ
vu,ゔ
ve,ゔぇ
vo,ゔぉ
pa,ぱ
pi,ぴ
pu,ぷ
pe,ペ
po,ぽ
py,ぴ!
!ya,ゃ
!yu,ゅ
!ye,ぇ
!yo,ょ
ya,や
yu,ゆ
ye,𛀁
yo,よ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
la,ぁ
li,ぃ
lu,ぅ
le,ぇ
lo,ぉ
a,あ
i,い
u,う
e,え
o,お
*,っ
~,
^,
_,`.split(`
`).forEach(e=>{let a=e.split(",");re[a[0]]=a[1]});var Ce=function(e){let a=e;e[0]=="*"&&(a=a.slice(1)),["aa","ii","uu","ee","oo"].forEach(h=>{for(;a.indexOf(h)>-1;)a=a.replace(h,h[0])});for(let h in re)a=a.replaceAll(h,re[h]);a.indexOf("ん")==0&&a.length>1&&(a=a.slice(1));let l=a.indexOf("!");return l>-1&&a.length>1&&(a=a.slice(l+1)),a},Ee=function(e){return e?e<96?`cc${e}`:["aftertouch","velocity","pitch bend"][e-96]:"off"},ke={u8:["utf-8","Unicode"],l1:["l9","Pan-Latin"],jp:["sjis","Japanese"],kr:["iso-2022-kr","Korean"],hz:["gb18030","Simplified Chinese"],b5:["big5","Traditional Chinese"],cy:["koi8-ru","Cyrillic"],vn:["tcvn-5773-1993","Vietnamese"]},me={m:"Male",f:"Female",c:"Chorus",s:"Solo",p:"Plural",w:"Words",x:"Non-vocal"};var se=["room 1","room 2","room 3","hall 1","hall 2","plate","delay","panning delay"],$e=["chorus 1","chorus 2","chorus 3","chorus 4","feedback","flanger","short delay","short delay feedback"],we=["delay 1","delay 2","delay 3","delay 4","pan delay 1","pan delay 2","pan delay 3","pan delay 4","delay to reverb","pan repeat"];var We={0:"thru",256:"stereo EQ",257:"spectrum",258:"enhancer",259:"humanizer",272:"overdrive",273:"distortion",288:"phaser",289:"auto wah",290:"rotary",291:"stereo flanger",292:"step flanger",293:"tremelo",294:"auto pan",304:"compressor",305:"limiter",320:"hexa chorus",321:"tremelo chorus",322:"stereo chorus",323:"space D",324:"3D chorus",336:"stereo delay",337:"modulated delay",338:"3-tap delay",339:"4-tap delay",340:"tremelo control delay",341:"reverb",342:"gate reverb",343:"3D delay",352:"2-pitch shifter",353:"feedback pitch shifter",368:"3D auto",369:"3D manual",370:"Lo-Fi 1",371:"Lo-Fi 2",512:"overdrive - chorus",513:"overdrive - flanger",514:"overdrive - delay",515:"distortion - chorus",516:"distortion - flanger",517:"distortion - delay",518:"enhancer - chorus",519:"enhancer - flanger",520:"enhancer - delay",521:"chorus - delay",522:"flanger - delay",523:"chorus - flanger",524:"rotary multi",1024:"guitar multi 1",1025:"guitar multi 2",1026:"guitar multi 3",1027:"clean guitar multi 1",1028:"clean guitar multi 2",1029:"bass multi",1030:"rhodes multi",1280:"keyboard multi",4352:"chorus / delay",4353:"flanger / delay",4354:"chorus / flanger",4355:"overdrive / distortion",4356:"overdrive / rotary",4357:"overdrive / phaser",4358:"overdrive / auto wah",4359:"phaser / rotary",4360:"phaser / auto wah"},qe={66307:["drive"],66309:["vowel",e=>"aiueo"[e]],94723:["pre-filter"],94724:["Lo-Fi type"],94725:["post-filter"],94979:["Lo-Fi type"],94980:["fill type",e=>["off","LPF","HPF"][e]],94984:["noise type",e=>["white","pink"][e]],94987:["disc type",e=>["LP","SP","EP","RND"]],94990:["hum type",e=>`${e+5}0Hz`],94993:["M/S",e=>["mono","stereo"][e]]},ie=function(e){return We[(e[0]-32<<8)+e[1]]||`0x${e[0].toString(16).padStart(2,"0")}${e[1].toString(16).padStart(2,"0")}`},ve=function(e,a,l){let h=(e[0]-32<<16)+(e[1]<<8)+a,u=qe[h]||{},b=u[0];if(b?.length)return b+=`: ${(u[1]||function(){})(l)||l}`,b},ne=[68,48,95,78,41,3,110,122,0];var A=function(e=64){return Math.round(2e3*Math.log10(e/64))/100};var H=function(e){let a=0;return e.forEach(l=>{a+=l,a=a&127}),~a+1&127},D=function(e,a){let l=0,h=0;for(let u=0;u<e.length;u++){let b=(u&7)-1,m=(h>>b&1)<<7,C=e[u];C+=m,u&7?(a(C,l,e),l++):h=e[u]}};var Qe=function(e,a){let l=0;for(let h=0;h<e.length;h++)if(h&1){l=l<<4|e[h]&15;let u=h>>1;a(l,u,e)}else l=e[h]&15},Se=function(e){let a=e.length>>1,l=new Uint8Array(a);return Qe(e,(h,u)=>{l[u]=h}),l},z=function(e){let a=Math.floor(e*14.2);return a<128?a:0},S=function(){return self.Bun?!0:self.debugMode??!1},xe=function(e){let a=(e.length+1)*3>>2,l=new Uint8Array(a),h=e.length+3>>2;for(let u=0;u<h;u++){let b=u<<2,m=u*3,C=0;for(let $=0;$<4;$++)C<<=6,C|=e.charCodeAt(b+$)-32&63;l[m]=C>>16,l[m+1]=C>>8&255,l[m+2]=C&255}return l};var $t="♭𝄫,𝄫,♭,,♯,𝄪,𝄪♯".split(",");var Bt=Xe(Te(),1),M=["?","gm","gs","sc","xg","g2","mt32","doc","qy10","qy20","ns5r","x5d","05rw","k11","sg","sd","pa","krs","s90es","motif","cs6x","trin","an1x","cs1x"],je={gm2:"g2","mt-32":"mt32","c/m":"mt32",ag10:"05rw","ag-10":"05rw","05r/w":"05rw",x5:"05rw",x5dr:"x5d",gmega:"k11","kross 2":"krs","motif es":"motif","s90 es":"s90es",trinity:"trin","tr-rack":"trin"},Ze=["melodic","drum","menu"],W={"?":[0,0,120,0,0],gm:[0,0,120,0,0],gs:[0,0,128,0,0],sc:[0,0,128,0,0],xg:[0,0,127,0,0],g2:[0,0,120,0,0],mt32:[0,127,127,0,127],doc:[57,112,127,57,112],qy10:[57,113,127,57,113],qy20:[57,114,127,57,114],ns5r:[0,0,61,0,0],x5d:[82,0,62,56,0],"05rw":[81,0,62,56,0],k11:[0,0,122,0,0],sg:[0,0,122,0,0],sd:[97,0,105,0,0],pa:[0,0,120,121,0],krs:[121,0,120,0,0],s90es:[0,0,127,0,0],motif:[0,0,127,0,0],cs6x:[0,0,127,0,0],trin:[0,0,61,0,0],an1x:[36,3,127,0,0],cs1x:[0,0,127,63,0],cs2x:[0,0,127,63,0]},Je=[9,25,41,57,73,89,105,121],et=[0,3,81,84,88],Me={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},j={0:0,1:1,2:3,5:4},Pe={0:0,1:1,2:2,5:3},Re=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],le=[36,37,48,49,52,53],J=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65],Ae={26:127,29:0,30:0,31:0,52:12,53:54},B=[0,1,2,4,5,6,7,8,10,11,12,13,14,15,16,17,18,19,20,21,22,26,28,32,38,40,41,42,43,44,45,46,47,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,80,81,82,83,84,91,92,93,94,95,98,99,100,101,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],tt=[2,4,12,13,14,15,16,17,18,19,20,21,40,41,42,43,44,45,46,47,80,81,83,136,130,131,132,133,134,135,137,138,139,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],at=[33,102,99,32,100,8,9,10],Oe=[0,16,25,40,32,64,24,48],Ie="reverb,chorus,delay,insert0,insert1,insert2,insert3,insert4".split(","),L=[["VL",32,8,1],["SG",8,1,1],["DX",16,1,16],["AN",16,2,5],["PF",2,1,64],["DR",2,1,32],["PC",2,1,32],["AP",2,1,64]],E={};M.forEach((e,a)=>{E[e]=a});var k=[];B.forEach((e,a)=>{k[e]=a});var U={length:J.length};J.forEach((e,a)=>{U[e]=a});var rt={};Ze.forEach((e,a)=>{rt[e]=a});var st=function(e){let a=[],l=0;return e?.forEach(function(h,u){h===247?a.push(e.subarray(l,u)):h===240&&(l=u+1)}),a.length||a.push(e.subarray(0)),S()&&console.debug(a),a};var oe=8,p={port:oe,ch:oe<<4,chShift:Math.ceil(Math.log2(oe))+4,cc:B.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,rpnt:4,nrpn:le.length,ace:8,drm:8,dpn:J.length,dnc:128,ext:3,efx:8,cvn:12,redir:32,vxPrim:3,invalidCh:255};p.chcc=p.cc*p.ch;var q={bank0:255},it=new TextDecoder("l9"),T=new Uint16Array(p.ch),G=new Uint16Array(p.ch),nt=new Uint16Array(p.ch),Z=new Uint16Array(p.ch),ct=new Uint16Array(p.ch),X=new Uint16Array(p.ch),De=new Array(p.drm);for(let e=0;e<p.ch;e++)T[e]=e*p.cc,G[e]=e*p.rpn,nt[e]=e*p.nrpn,Z[e]=e*p.ace,ct[e]=e*p.ext,X[e]=e*p.cvn;for(let e=0;e<p.drm;e++){De[e]=new Uint16Array(p.dpn);let a=e*p.dpn*p.dnc;for(let l=0;l<p.dpn;l++)De[e][l]=a+l*p.dnc}var Gt=class extends he{NOTE_IDLE=0;NOTE_ATTACK=1;NOTE_DECAY=2;NOTE_SUSTAIN=3;NOTE_HELD=4;NOTE_RELEASE=5;NOTE_SOSTENUTO_ATTACK=8;NOTE_SOSTENUTO_DECAY=9;NOTE_SOSTENUTO_SUSTAIN=10;NOTE_SOSTENUTO_HELD=11;NOTE_MUTED_RECOVERABLE=16;CH_MELODIC=0;CH_DRUMS=1;CH_DRUM1=2;CH_DRUM2=3;CH_DRUM3=4;CH_DRUM4=5;CH_DRUM5=6;CH_DRUM6=7;CH_DRUM7=8;CH_DRUM8=9;DUMP_ALL=0;DUMP_ONCE=1;DUMP_MODE=2;EXT_NONE=0;EXT_VL=1;EXT_DX=3;VLBC_SYSTEM=0;VLBC_BRTHEXPR=1;VLBC_VELOINIT=2;VLBC_VELOALL=3;CH_INACTIVE=0;CH_ACTIVE=1;CH_DISABLED=2;KARAOKE_NONE=0;KARAOKE_TEXT=1;KARAOKE_XF=2;#t=0;#E=0;#P=0;#R=new Array(11);get#N(){return this.#R[this.#E]}set#N(e){this.#R[this.#E]=e}#v=new Uint8Array(p.ch);#c=new Uint8Array(p.ch);#a=new Uint8Array(p.ch);#e=new Uint8Array(p.chcc<<1);#C=new Uint8Array(p.ch*p.ace);#i=new Uint8Array(p.ch*p.vxPrim);#b=new Uint8Array(p.ch*p.nn);#k=new Uint8Array(p.ch);#u=new Uint16Array(p.pl);#o=new Uint8Array(p.pl);#H=new Int16Array(p.ch);#D=new Uint8Array(p.ch);#V=new Uint8Array(p.ch);#m=new Uint8Array(p.ch*p.ext);#r=new Uint8Array(p.ch*p.rpn);#n=new Uint8Array(p.ch*p.rpnt);#se=new Int8Array(p.ch*le.length);#w=new Uint8Array(p.drm*p.dpn*p.dnc);#A=new Uint8Array(p.drm*2);#S=new Uint8Array(p.efx*3);#Y=new Uint8Array(p.ch);#z=new Uint8Array(p.ch*p.redir);#f=new Uint8Array(p.port);#ie=new Uint8Array(p.port);#W=new Uint8Array(p.ch);#T=new Uint8Array(p.ch);#q=new Uint8Array(p.ch*p.cvn);#ne=new Uint8Array(p.ch);#_=new Uint8Array(128);#O=new Uint8Array(p.cmt*8);#ce=new Uint8Array(1024);#G=new Uint8Array(p.cmt*64);#p={};modelEx={xg:{varSys:!1,insPart:new Uint8Array(5)},yPlg:[],sc:{showBar:!0,invBar:!1,invDisp:!1,peakHold:1},cs1x:{perfCh:0},kross:{chToggle:!1},sg:{convLastSyll:0,runLineLen:0,maxLineLen:32,splitMask:!1}};#s;get detect(){return structuredClone(this.#s)}#L;#fe;#d=100;#Q=0;#oe=500;#ge=0;#Ce=0;#Ee=32;#ke=!1;#X="";#K=0;#he=0;#le=0;#U=!0;#l=0;#be=1;#ue;#h=!1;#de=0;#j=new Array(p.ch);#x=[];#B=new Uint8Array(p.ch);#F=new Uint8Array(p.tr);baseBank=new ae("gm2","ns5r","xg","gs","sd","gmega","plg-vl","plg-pf","plg-dx","plg-an","plg-dr","plg-sg","kross","s90es","cs2x","pa");userBank=new ae("gm2");initOnReset=!1;aiEfxName="";polyIndexShrink=!0;polyIndexLatest=0;polyIndexLast=0;chRedir(e,a,l){let h=this;if(h.#F[a])return(h.#F[a]-1)*16+e;if(h.#t===E.sc||h.#t===E.sd){if(l===1)return e;let u=0,b=!0;for(;b;)h.#B[e+u]===0?(h.#B[e+u]=a,console.debug(`Assign track ${a} to channel ${e+u+1}.`),b=!1):this.#B[e+u]===a?b=!1:(u+=16,u>=128&&(u=0,b=!1));return e+u}else return e}getTrackPort(e){return this.chRedir(0,e,!0)>>4}forceVoiceRefresh(){for(let e=0;e<p.ch;e++)this.#v[e]&&this.dispatchEvent("voice",{part:e})}#$=[];#Z;#y={nOff:(e,a)=>{let l=e*128+a,h=this.#u.lastIndexOf(l);if(h>-1)if(this.getChCc(e,64)>>6)this.#o[h]=this.NOTE_HELD,this.dispatchEvent("note",{part:e,note:a,velo:this.#b[l],state:this.NOTE_HELD});else if(this.getChCc(e,66)>>6&&this.#o[h]===this.NOTE_SOSTENUTO_SUSTAIN)this.#o[h]=this.NOTE_SOSTENUTO_HELD,this.dispatchEvent("note",{part:e,note:a,velo:this.#b[l],state:this.NOTE_SOSTENUTO_HELD});else{this.#u[h]=0,this.#b[l]=0,this.#o[h]=this.NOTE_IDLE;let u=this.getExt(e)[1];(u===this.VLBC_VELOINIT||u===this.VLBC_VELOALL)&&this.setChCc(e,129,0),this.dispatchEvent("note",{part:e,note:a,velo:0,state:this.NOTE_IDLE})}if(this.#k[e]){for(let u=this.polyIndexLast;u>=0;u--)if(this.#u[u]>>7===e&&this.#o[u]!==0){this.#o[u]===this.NOTE_MUTED_RECOVERABLE&&(this.#o[u]=this.NOTE_SUSTAIN);break}}if(this.polyIndexShrink&&this.polyIndexLast>0){let b=!1,m=this.polyIndexLast-8,C=this.polyIndexLast;for(;C>m&&this.#o[C]===0;C--)b=!0;b&&(this.polyIndexLast=C,this.#o[C+1]!==0&&console.error("Polyphonic slot shrinking edge case."))}},nOn:(e,a,l)=>{let h=e*128+a,u=0;if(this.#k[e])for(let b=0;b<=this.polyIndexLast;b++)this.#u[b]>>7===e&&this.#o[b]!==0&&(this.#o[b]=this.NOTE_MUTED_RECOVERABLE);for(;this.#o[u]>0&&this.#u[u]!==h;)u++;if(u<p.pl){this.#u[u]=h,this.#b[h]=l,this.#o[u]=this.NOTE_SUSTAIN,this.#D[e]<l&&(this.#D[e]=l);let b=this.getExt(e)[1];(b===this.VLBC_VELOINIT||b===this.VLBC_VELOALL)&&this.setChCc(e,129,l),this.dispatchEvent("note",{part:e,note:a,velo:l,state:this.NOTE_SUSTAIN}),this.polyIndexLatest=u+1,u>this.polyIndexLast&&(this.polyIndexLast=u)}else console.error("Polyphony exceeded.")},nAt:(e,a,l)=>{},cAt:(e,a)=>{},hoOf:e=>{this.#o.forEach((a,l)=>{if(a===this.NOTE_HELD){let h=this.#u[l],u=h>>7;e===u&&(this.#o[l]=this.NOTE_IDLE,this.#u[l]=0,this.#b[h]=0,this.dispatchEvent("note",{part:e,note:h&127,velo:0,state:this.NOTE_IDLE}))}})},soOn:e=>{this.#o.forEach((a,l)=>{let h;switch(a){case this.NOTE_ATTACK:{h=this.NOTE_SOSTENUTO_ATTACK;break}case this.NOTE_DECAY:{h=this.NOTE_SOSTENUTO_DECAY;break}case this.NOTE_SUSTAIN:{h=this.NOTE_SOSTENUTO_SUSTAIN;break}}if(h){this.#o[l]=h;let u=this.#u[l];this.dispatchEvent("note",{part:e,note:u&127,velo:this.#b[u],state:h})}})},soOf:e=>{this.#o.forEach((a,l)=>{if(a===this.NOTE_SOSTENUTO_HELD){let h=this.#u[l],u=h>>7;e===u&&(this.#o[l]=this.NOTE_IDLE,this.#u[l]=0,this.#b[h]=0,this.dispatchEvent("note",{part:e,note:h&127,velo:0,state:this.NOTE_IDLE}))}})},ano:e=>{this.#u.forEach(a=>{let l=a>>7,h=a&127;a===0&&this.#b[0]===0||l===e&&this.#y.nOff(l,h)})}};#pe={8:function(e){let a=e.channel,l=e.data[0];this.#y.nOff(a,l)},9:function(e){let a=e.channel,l=this;if(l.getChModeId(a)===E.xg&&l.#a[a]>1){let b=l.getChDrumFirstWrite(a);b[0]&&b[1]!==p.invalidCh&&!l.#v[a]&&(l.copyChSetup(b[1],a),l.pushChPrimitives(a),console.debug(`Part CH${a+1} copied from CH${b[1]+1}.`))}l.setChActive(a,1);let h=e.data[0],u=e.data[1];u>0?l.#y.nOn(a,h,u):l.#y.nOff(a,h)},10:function(e){let a=e.channel,l=a*128+e.data[0];this.#u.indexOf(l)>-1&&(this.#b[l]=data[1],this.getExt(a)[1]===this.VLBC_VELOALL&&this.setChCc(a,129,data[1]),this.dispatchEvent("note",{part:a,note:e.data[0],velo:e.data[1],state:this.NOTE_SUSTAIN}))},11:function(e){let a=e.channel,l=this,h=l.#j[a],u=h[e.data[0]];u&&(e.data[0]=u),[0,32].indexOf(e.data[0])>-1&&(()=>{switch(this.#t){case E.s90es:case E.motif:{if(e.data[0]===0){[0,63].indexOf(e.data[1])>-1&&l.setChActive(a,1);break}e.data[1]&&l.setChActive(a,1);break}default:break}})();let b=a*p.ext,m=l.getChModeId(a);switch(e.data[0]){case 96:return;case 97:return;case 120:return;case 121:{this.#y.ano(a),this.#H[a]=0,l.resetChCc(a,1,0),l.resetChCc(a,5,0),l.resetChCc(a,64,0),l.resetChCc(a,65,0),l.resetChCc(a,66,0),l.resetChCc(a,67,0),l.resetChCc(a,11,127),l.resetChCc(a,101,127),l.resetChCc(a,100,127),l.resetChCc(a,99,127),l.resetChCc(a,98,127);return}case 123:{this.#y.ano(a);return}case 124:{this.#y.ano(a);return}case 125:{this.#y.ano(a);return}case 126:{this.#k[a]=1,this.#y.ano(a);return}case 127:{this.#k[a]=0,this.#y.ano(a);return}}if(k[e.data[0]]===void 0)console.warn(`cc${e.data[0]} is not accepted.`);else{switch(tt.indexOf(e.data[0])>-1&&this.allocateAce(a,e.data[0]),e.data[0]){case 0:{switch(S()&&console.debug(`${M[this.#t]}, CH${a+1}: ${e.data[1]}`),this.#t===0?e.data[1]<48?(this.#a[a]>0&&(e.data[1]=this.getChPrimitive(a,1,!1),e.data[1]=W.gs[2],console.debug(`Forced channel ${a+1} to stay drums.`)),e.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${e.data[1]}`),this.switchMode("gs"))):e.data[1]===56?this.switchMode(this.#s.x5===82?"x5d":"05rw"):e.data[1]===62?this.switchMode(this.#s.x5===82?"x5d":"05rw"):e.data[1]===63?this.switchMode(M[this.#s.ds]):e.data[1]===64||e.data[1]===127?this.switchMode("xg"):(e.data[1]===120||e.data[1]===121)&&this.switchMode("g2"):this.#t===E.gs||this.#t===E.sc?e.data[1]<56&&this.#a[a]>0&&(e.data[1]=this.getChPrimitive(a,1,!1),e.data[1]=W.gs[2],console.debug(`Forced channel ${a+1} to stay drums.`)):this.#t===E.gm&&(e.data[1]<48?this.#a[a]>0&&(e.data[1]=W.gs[2],this.switchMode("gs",!0),console.debug(`Forced channel ${a+1} to stay drums.`)):(e.data[1]===64||e.data[1]===127)&&this.switchMode("xg",!0)),this.#t){case E.xg:{[79,95,126,127].indexOf(e.data[1])>-1?this.#a[a]===0&&(this.setChType(a,this.CH_DRUM2),console.debug(`CH${a+1} set to drums by MSB.`)):this.#a[a]>0&&(this.setChType(a,this.CH_MELODIC),console.debug(`CH${a+1} set to melodic by MSB.`)),[33,81,97].indexOf(e.data[1])>-1?this.#m[b]=this.EXT_VL:[35,67,83,99].indexOf(e.data[1])>-1?this.#m[b]=this.EXT_DX:this.#m[b]=this.EXT_NONE;break}case E["05rw"]:case E.x5d:case E.ns5r:{[61,62,126,127].indexOf(e.data[1])>-1?this.#a[a]===this.CH_MELODIC&&(this.setChType(a,this.CH_DRUM2),console.debug(`CH${a+1} set to drums by MSB.`)):[80,81,82,83].indexOf(e.data[1])>-1||this.#a[a]!==this.CH_MELODIC&&(this.setChType(a,this.CH_MELODIC),console.debug(`CH${a+1} set to melodic by MSB.`));break}case E.sd:{[104,105,106,107,120].indexOf(e.data[1])>-1?this.#a[a]===0&&(this.setChType(a,this.CH_DRUM2),console.debug(`CH${a+1} set to drums by MSB.`)):this.#a[a]>0&&(this.setChType(a,this.CH_MELODIC),console.debug(`CH${a+1} set to melodic by MSB.`));break}case E.g2:{e.data[1]===120?this.#a[a]===0&&(this.setChType(a,this.CH_DRUMS),console.debug(`CH${a+1} set to drums by MSB.`)):this.#a[a]>0&&(this.setChType(a,this.CH_MELODIC),console.debug(`CH${a+1} set to melodic by MSB.`));break}}break}case 2:{this.getExt(a)[1]===this.VLBC_BRTHEXPR&&this.setChCc(a,129,e.data[1]);break}case 6:{if(this.#V[a]){[E.xg,E.gs,E.sc,E.ns5r].indexOf(this.#t)<0&&console.warn(`NRPN commits are not available under "${M[this.#t]}" mode, even when they are supported in Octavia.`);let C=this.getChCc(a,99),$=this.getChCc(a,98);if(C===1){let v=at.indexOf($);if(v>-1)this.setChCc(a,71+v,e.data[1]),S()&&console.debug(`Redirected NRPN 1 ${$} to cc${71+v}.`),this.dispatchEvent("cc",{part:a,cc:71+v,data:e.data[1]});else{let t=le.indexOf($);t>-1?this.#se[a*10+t]=e.data[1]-64:console.warn(`NRPN 0x01${$.toString(16).padStart(2,"0")} is not supported.`),S()&&console.debug(`CH${a+1} voice NRPN ${$} commit`)}}else{if(J.indexOf(C)<0){let t=`NRPN 0x${C.toString(16).padStart(2,"0")}${$.toString(16).padStart(2,"0")} `;console.warn(C===127?`${t}is not necessary. Consider removing it.`:`${t}is not supported.`)}else{let t=this.#a[a]-2;t<0?console.warn(`CH${a+1} cannot accept drum NRPN as type ${Y[this.#a[a]]}.`):this.#w[(t*p.dpn+U[C])*p.dnc+$]=e.data[1]}S()&&console.debug(`CH${a+1} (${Y[this.#a[a]]}) drum NRPN ${C} commit`)}}else{let C=j[this.getChCc(a,100)],$=Pe[this.getChCc(a,100)];if(this.getChCc(a,101)===0&&C!==void 0)switch(S()&&console.debug(`CH${a+1} RPN 0 ${this.getChCc(a,100)} commit: ${e.data[1]}`),e.data[1]=Math.min(Math.max(e.data[1],Re[C][0]),Re[C][1]),this.#r[a*p.rpn+C]=e.data[1],this.#n[a*p.rpnt+$]=1,m){case E.xg:case E.gs:case E.sc:case E.mt32:case E.s90es:case E.motif:case E.cs1x:case E.cs6x:{switch(this.getChCc(a,100)){case 1:case 2:{this.dispatchEvent("pitch",{part:a,pitch:this.getPitchShift(a)});break}}break}default:this.dispatchEvent("pitch",{part:a,pitch:this.getPitchShift(a)})}}break}case 32:{switch(S()&&console.debug(`${M[this.#t]}, CH${a+1} LSB: ${e.data[1]}`),this.#t){case E.s90es:case E.motif:{this.setChType(a,[32,40].indexOf(e.data[1])>-1?this.CH_DRUMS:this.CH_MELODIC,this.#t,!0);break}}this.getExt(a)[0],this.EXT_DX;break}case 38:{if(!this.#V[a]){let C=j[this.getChCc(a,100)],$=Pe[this.getChCc(a,100)];this.getChCc(a,101)===0&&C!==void 0&&(this.#r[a*p.rpn+C+1]=e.data[1],this.#n[a*p.rpnt+$]=1)}break}case 64:{e.data[1]<64&&this.#y.hoOf(a);break}case 66:{e.data[1]>>6?this.#y.soOn(a):this.#y.soOf(a);break}case 98:case 99:{this.#V[a]=1;break}case 100:case 101:{this.#V[a]=0;break}}this.setChCc(a,e.data[0],e.data[1]),this.dispatchEvent("cc",{part:a,cc:e.data[0],data:e.data[1]})}l.getChModeId(a)===E.xg&&l.#a[a]&&l.setDrumFirstWrite(a)},12:function(e){let a=e.channel,l=this;switch(l.#t){case E.s90es:case E.motif:{e.data&&l.setChActive(a,1);break}default:l.setChActive(a,1)}let h=T[a];switch(l.getExt(a)[0]){case l.EXT_VL:break}l.#i[a]=e.data,l.#T[a]=0,l.pushChPrimitives(a),S()&&console.debug(`T:${e.track} C:${a} P:${e.data}`),l.getChModeId(a)===E.xg&&l.#a[a]&&l.setDrumFirstWrite(a)},13:function(e){let a=this,l=e.channel;this.#u.forEach(function(h){let u=h>>7;l===u&&(a.#b[h]=e.data,a.dispatchEvent("note",{part:l,note:h&127,velo:e.data,state:a.NOTE_SUSTAIN}))})},14:function(e){let a=e.channel;this.#H[a]=e.data[1]*128+e.data[0]-8192,this.dispatchEvent("pitch",{part:a,pitch:this.getPitchShift(a)})},15:function(e){st(e.data).forEach(a=>{let l=a[0],h=a[1];this.#de=a.length,(this.#ye[l]||function(){console.debug(`Unknown manufacturer ${l}.`)})(h,a.subarray(2),e.track)})},248:function(e){},250:function(e){},251:function(e){},252:function(e){},254:function(e){},255:function(e){(this.#$[e.meta]||function(l,h,u){}).call(this,e.data,e.track,e.meta),e.meta!==32&&(this.#Q=0);let a=et.indexOf(e.meta)>-1;if(S()&&console.debug(e),a)return e.reply="meta",e}};#ye={64:(e,a,l)=>{this.#te.run(a,l,e)},65:(e,a,l)=>{if(a[0]<16)if(a[1]===72){let h=a[a.length-1],u=H(a.subarray(3,a.length-1));h===u?this.#M.run(a.subarray(0,a.length-1),l,e):console.warn(`Bad SD checksum ${h} - should be ${u}.`)}else this.#M.run(a,l,e);else{let h=a[a.length-1],u=H(a.subarray(2,a.length-1));h===u?this.#M.run(a.subarray(0,a.length-1),l,e):console.warn(`Bad GS checksum ${h} - should be ${u}.`)}},66:(e,a,l)=>{this.#I.run(a,l,e)},67:(e,a,l)=>{switch(e>>4){case 0:{let h=0;for(;a[h]===127&&h<4;)h++;let u=a[1+h]<<7|a[2+h];if(u+7+h!==a.length){console.warn(`Yamaha bulk dump length mismatch! Expected ${a.length-7-h}, received ${u}.`),console.debug(a);break}let b=H(a.subarray(1+h,a.length-1)),m=a[a.length-1];if(a[a.length-1]>>7)console.warn(`Yamaha bulk dump checksum invalid! Expected ${b}, received ${m}:
`),console.debug(a);else if(b!==m)console.warn(`Yamaha bulk dump checksum mismatch! Expected ${b}, received ${m}:
`),console.debug(a);else{let C=a.slice(2,a.length-1);for(let $=0;$<=h;$++)C[$]=a[$];this.#g.run(C,l,e&15)}break}case 1:{this.#g.run(a,l,e&15);break}case 2:{console.warn("Octavia doesn't yet support Yamaha bulk dump requests.");break}case 3:{console.warn("Octavia doesn't yet support Yamaha parameter requests.");break}case 7:{switch(e&15){case 14:{let h=new Uint8Array(a.length+1);h[0]=126,h.set(a,1),this.#g.run(h,l,0);break}default:console.warn(`Unknown Yamaha special SysEx type: ${e}.`)}break}default:console.warn(`Unknown Yamaha SysEx type: ${e>>4}.`)}},68:(e,a,l)=>{this.#re.run(a,l,e)},71:(e,a,l)=>{this.#ae.run(a,l,e)},126:(e,a,l)=>{this.#J.run(a,l,e)},127:(e,a,l)=>{this.switchMode("gm"),this.#ee.run(a,l,e)}};#J;#ee;#g;#M;#I;#te;#ae;#re;buildRchTree(){let e=[];this.#c.forEach((a,l)=>{a<p.ch&&(e[a]?.constructor||(e[a]=[]),e[a].push(l))}),this.#ue=e}buildRccMap(){let e=this;for(let a=0;a<p.ch;a++)e.#j[a]={};e.#z.forEach((a,l)=>{a&&(e.#j[Math.floor(l/p.redir)][a]=l%p.redir|128)}),S()&&console.debug(e.#j)}invokeSysExIndicator(){this.dispatchEvent("mupromptex",this.#de)}getActive(){return this.#v}getChActive(e){return this.#v[e]}getCc(e){if(typeof e!="number"||e<0||e>=p.ch)throw new RangeError(`Invalid part number: CH${e+1}`);let a=this,l=T[e];return a.#e.subarray(l,l+p.cc)}getChCc(e,a){let l=this;if(B.indexOf(a)<0)throw new Error("CC number not accepted");return l.#e[T[e]+k[a]]}getChCcWritten(e,a){let l=this;if(B.indexOf(a)<0)throw new Error("CC number not accepted");return l.#e[p.chcc+T[e]+k[a]]}setChCc(e=0,a,l){let h=this;if(B.indexOf(a)<0)throw new Error("CC number not accepted");if(l?.constructor!==Number)throw new TypeError("Expected numbers for value");let u=l&255,b=T[e]+k[a];h.#e[b]=u,h.#e[b+p.chcc]=1,h.dispatchEvent("cc",{part:e,cc:a,data:u})}getCcAll(){return this.#e.slice()}resetCc(e){let a=this,l=T[e]+p.chcc;a.#e.fill(0,l,l+p.cc)}resetChCc(e,a,l){let h=this;l?.constructor&&h.setChCc(e,a,l),h.#e[T[e]+k[a]+p.chcc]=0}resetCcAll(){this.#e.fill(0,p.chcc,p.chcc<<1)}isChCcWritten(e,a){if(B.indexOf(a)<0)throw new Error("CC number not accepted");return upThis.#e[T[e]+k[a]+p.chcc]}getChSource(){return this.#c}getChType(e=0){return this.#a[e]}getChTypes(){return this.#a}setChType(e,a,l=0,h=!1){a&=15;let u=this;l=l||u.getChModeId(e),u.#a[e]=a,a>0&&!h&&(u.setChCc(e,0,u.#p[l][2]),u.pushChPrimitives(e))}setChActive(e,a=0){this.#v[e]!==a&&this.dispatchEvent("channeltoggle",{part:e,active:a}),this.#v[e]=a}getExt(e){let a=p.ext*e,l=this.#m.subarray(a,a+p.ext),h=new Uint8Array(l.length);return h.set(l),h[1]=h[1]||this.#be,h}getPitch(){return this.#H}getProgram(){return this.#i}getTexts(){return this.#x.slice()}getVel(e){let a=new Map,l=this;return l.#u.forEach(function(h,u){let b=h>>7,m=h&127;e===b&&l.#b[h]>0&&a.set(m,{v:l.#b[h],s:l.#o[u]})}),a}getBitmap(){return{bitmap:this.#N,expire:this.#P}}getLetter(){return{text:this.#X,set:this.#he,expire:this.#K}}getMode(){return M[this.#t]}getMaster(){return{volume:this.#d}}getRpn(){return this.#r}getNrpn(){return this.#se}getSubDb(){return self?.structuredClone(this.#p)}getDetect(){return self?.structuredClone(this.#s)}getVoice(e,a,l,h="?"){let u=this;E[h]?.constructor||(h="?");let b=E[h],m=e||u.#p[b][0],C=a,$=l||u.#p[b][1];m===q.bank0&&(m=0),$===q.bank0&&($=0),h==="ns5r"&&m>0&&m<56&&($=3);let v=u.userBank.get(m,C,$,h);if(h==="mt32"&&v.name.indexOf("MT-m:")===0){let t=parseInt(v.name.slice(5)),c=t*p.cmt,s="";u.#G.subarray(c,c+10).forEach(i=>{i>31&&(s+=String.fromCharCode(i))});let r=`MSB	LSB	PRG	NME
49	127	${C}	${s}`;u.userBank.load(r,!0),v.name=s,v.ending=" "}return(v.ending!==" "||!v.name.length)&&(v=u.baseBank.get(m,C,$,h)),v}getChPrimitive(e,a,l){if(a>=p.vxPrim||a?.constructor!==Number)throw new RangeError(`Invalid voice primitive component "${a}"`);if(typeof e!="number"||e<0||e>=p.ch)throw new RangeError(`Invalid part number: CH${e+1}`);let h=this,u=h.#i[a<<p.chShift|e];switch(a){case 1:case 2:{h.getChCcWritten(e,[255,0,32][a])||(u=u||h.#p[h.getChModeId(e)][a+2]),l&&(u=u||h.#p[h.getChModeId(e)][a-1]),u===q.bank0&&(u=0);break}}return u}getChPrimitives(e,a){let l=this,h=new Uint8Array(3);return h[1]=l.#i[e],h[0]=l.getChPrimitive(e,1,a),h[2]=l.getChPrimitive(e,2,a),h}pushChPrimitives(e){let a=this;a.#i[1<<p.chShift|e]=a.getChCc(e,0),a.#i[2<<p.chShift|e]=a.getChCc(e,32),a.dispatchEvent("voice",{part:e})}getChCvnBuffer(e,a=p.cvn){if(a>p.cvn||a<1)throw new RangeError("Invalid custom voice name buffer length");let l=X[e];return this.#q.subarray(l,l+a)}getChCvnRegister(e,a){if(a>=p.cvn||a<0)throw new RangeError("Invalid custom voice name register");return this.#q[X[e]+a]}setChCvnRegister(e,a,l=32){if(a>=p.cvn||a<0)throw new RangeError("Invalid custom voice name register");this.#ne[e]=1,this.#q[X[e]+a]=Math.max(32,l&255)}resetChCvn(e){this.#q.fill(32,X[e],X[e]+p.cvn),this.#ne[e]=0}getChCvnString(e,a){let l=it.decode(this.getChCvnBuffer(e));return a||(l=l.trimEnd()),l}getChCvnIsWritten(e){return this.#ne[e]}getChVoice(e){let a=this,l=a.getVoice(...a.getChPrimitives(e),a.getChMode(e));if(a.#T[e]){let h="";switch(a.#t){case E.mt32:{a.#O.subarray(p.cmt*(e-1),p.cmt*(e-1)+10).forEach(u=>{h+=String.fromCharCode(Math.max(u,32))}),h=h.trimEnd();break}default:h=a.getChCvnString(e)}h.length&&(l.ending="~",l.name=h)}return l}getRawPitch(){return this.#H}getPitchShift(e){let a=this,l=e*p.rpn,h=a.#r[l];return a.#n[e*p.rpnt]?h>>7&&(h-=256):a.#t===E.mt32&&(h=12),a.#H[e]/8192*h+(a.#r[l+3]-64)+((a.#r[l+1]<<7)+a.#r[l+2]-8192)/8192}getEffectType(e=0){let a=3*e+1;return this.#S.subarray(a,a+2)}getPolyState(e=0){return this.#o[e]}setEffectTypeRaw(e=0,a,l){let h=3*e;this.#S[h]=1,this.#S[h+1+ +a]=l}setEffectType(e=0,a,l){this.setEffectTypeRaw(e,!1,a),this.setEffectTypeRaw(e,!0,l)}pushEffectType(e=0,a=!1){if(e<0||e>=p.efx)throw new RangeError(`Invalid EFX slot ${e}`);let l=this.getEffectType(e);a||l[0]===0&&l[1]>>4===15&&(a=!0),this.dispatchEvent(`efx${Ie[e]}`,{id:l,hidden:a})}getEffectSink(){return this.#Y}getChEffectSink(e){return this.#Y[e]}setChEffectSink(e,a=0){let l=this;if(a<0||a>=p.efx)throw new RangeError(`Invalid EFX slot ${a}`);if(e<0||e>=p.ch)throw new RangeError(`Invalid CH${e+1}`);this.#Y[e]=a,this.dispatchEvent("partefxtoggle",{part:e,active:a})}setXgChEffectSink(e,a=0){let l=this,h=l.modelEx.xg,u=a-2;if(a<0||u>=h.insPart.length)throw new RangeError(`Invalid XG insertion slot ${u}`);let b=h.insPart[u];h.insPart[u]=e,b!==p.invalidCh&&l.setChEffectSink(b,0),e===p.invalidCh?b!==p.invalidCh&&l.setChEffectSink(b,0):l.setChEffectSink(e,a)}setLetterDisplay(e,a,l=0,h=3200){let u=this,b;u.#X=" ".repeat(l),e.forEach(m=>{u.#X+=String.fromCharCode(m>31?m:32),m<32&&(b=b||new Set,b.add(m))}),u.#he=Date.now(),u.#K=Date.now()+h,u.dispatchEvent("letter"),b&&(b=Array.from(b),b.forEach((m,C,$)=>{$[C]=m.toString(16).padStart(2,"0")}),console.warn(`${a}${a?" ":""}invalid code point${b.length>1?"s":""}: 0x${b.join(", 0x")}`))}setDetectionTargets(e="?",a=0){let l=this,h=-1;switch(e.replaceAll(", ",",").split(",").forEach(u=>{u=u.toLowerCase();let b=M.indexOf(je[u]||u);S()&&console.debug(`Mapped mode "${u}" to ID "${b}".`),b>-1&&(h=b)}),S()&&console.debug(`Set detection target to ID "${h}".`),h>0&&(l.#s.x5=82,l.#s.ds=E.krs,l.#s.gm=E.gm,l.#s.g2=E.g2),h){case E["05rw"]:{l.#s.x5=81;break}case E.s90es:{l.#s.ds=E.s90es,l.#s.smotif=E.s90es;break}case E.motif:{l.#s.ds=E.motif,l.#s.smotif=E.motif;break}case E.sd:{l.#s.g2=E.sd;break}case E.pa:{l.#s.g2=E.pa;break}}}setGsTargets(e=!1,a=4){if(!a)a=e?3:4;else{if(a>4||a<0)throw new Error(`Invalid GS level ${a}`);if(e&&a>>1!==1)throw new Error(`Invalid SC level ${a}`)}let l=this;l.#s[e?"sc":"gs"]=a,l.#p[E[e?"sc":"gs"]][1]=a,l.forceVoiceRefresh()}getConfigs(){return this.#fe}setDumpLimit(e){if(e>2||e<0)throw new RangeError("Invalid dump limit.");this.#L.dumpLimit=e}allocateAce(e=0,a){let l=this;if(!a||a<128&&a>95){console.warn(`cc${a} cannot be allocated as an active custom effect.`);return}let h=!0,u=0,b=p.ace*e;for(;h&&u<p.ace;)l.#C[u+b]===a?h=!1:l.#C[u+b]||(h=!1,l.#C[u+b]=a,console.debug(`Allocated cc${a} to ACE slot ${u} in CH${e+1}.`)),u++;u>=p.ace&&console.warn(`ACE slots are full in CH${e+1}.`)}allocateAceAll(e){let a=this;if(!e||e<128&&e>95){console.warn(`cc${e} cannot be allocated as an active custom effect.`);return}for(let l=0;l<p.ch;l++){let h=!0,u=0,b=p.ace*l;for(;h&&u<p.ace;)a.#C[u+b]===e?h=!1:a.#C[u+b]||(h=!1,a.#C[u+b]=e),u++;u>=p.ace&&console.warn(`ACE slots are full in CH${l+1}.`)}}resetAce(){this.#C.fill(0),console.info("All ACE slots have been reset.")}resetChAceAll(e=0){this.#C.subarray(Z[e],Z[e]+p.ace).fill(0)}resetChAce(e=0,a){let l=!0,h=Z[e],u=h+p.ace;for(;l&&h<u;)this.#C[h]===a&&(this.#C[h]=0,l=!1),h++;l&&S()&&console.debug(`No ACE slot was allocated to cc${a} in CH${e+1}.`)}getAce(){return this.#C}getChAce(e=0,a=0){if(a<0||a>=p.ace)throw new RangeError("No such ACE slot");let l=this.#C[p.ace*e+a];if(l){if(B.indexOf(l)>=0)return this.getChCc(e,l);throw new Error(`Invalid ACE source in CH${e+1}: ${l}`)}else return 0}initDrums(){let e=this;e.#w.fill(64);for(let a=0;a<p.drm;a++){let l=a*p.dpn;for(let h in Ae){let u=Ae[h],b=(l+U[h])*p.dnc;e.#w.subarray(b,b+p.dnc).fill(u)}}}init(e=0){let a=this;a.#Q=0,a.#p[E.xg][1]=0,a.dispatchEvent("banklevel",{mode:"xg",data:0}),a.#v.fill(0),a.#e.fill(0),a.#C.fill(0),a.#i.fill(0),a.#b.fill(0),a.#u.fill(0),a.#o.fill(0),a.#k.fill(0),a.#D.fill(0),a.#H.fill(0),a.#se.fill(0),a.#n.fill(0),a.#m.fill(0),a.#f.fill(0),a.#ie.fill(0),a.#W.fill(0),a.#z.fill(0),a.#d=100,a.#x=[],a.#oe=500,a.modelEx.sg.convLastSyll=0,a.modelEx.sg.runLineLen=0,a.modelEx.sg.splitMask=!1,a.#P=0,a.#E=0;for(let l=0;l<a.#R.length;l++)a.#N.fill(0);a.#l=a.KARAOKE_NONE,a.#le=0,a.#U=!0,a.#h=!1,a.#de=0,a.initDrums(),a.polyIndexLatest=0,a.polyIndexLast=0,a.#c.forEach(function(l,h,u){u[h]=h}),e===0&&(a.dispatchEvent("mode","?"),a.#t=0,a.#B.fill(0),a.#F.fill(0),a.#K=0,a.#X=""),Je.forEach(l=>{a.setChCc(l,0,a.#p[a.getChModeId(l)][2])}),a.#a.fill(a.CH_MELODIC),a.#a[9]=a.CH_DRUM1,a.#a[25]=a.CH_DRUM3,a.#a[41]=a.CH_DRUMS,a.#a[57]=a.CH_DRUMS,a.#a[73]=a.CH_DRUM5,a.#a[89]=a.CH_DRUM7,a.#a[105]=a.CH_DRUMS,a.#a[121]=a.CH_DRUMS;for(let l=0;l<p.drm;l++)a.#A[l<<1]=0,a.#A[l<<1|1]=p.invalidCh;a.#ce.fill(0),a.#G.fill(0),a.#_.fill(0),a.#O.fill(0),a.#T.fill(0),a.#S.fill(0),a.#Y.fill(0),a.aiEfxName="",a.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),a.modelEx.xg.varSys=!1,a.modelEx.xg.insPart.fill(p.invalidCh);for(let l=0;l<L.length;l++){let h=a.modelEx.yPlg[l];h.fill(0,0,L[l][2]),h.fill(p.invalidCh,L[l][2])}a.modelEx.sc.showBar=!0,a.modelEx.sc.invBar=!1,a.modelEx.sc.invDisp=!1,a.modelEx.sc.peakHold=1,a.modelEx.cs1x.perfCh=0;for(let l=0;l<p.ch;l++){a.resetChCvn(l);let h=T[l];a.#e[h+k[7]]=100,a.#e[h+k[11]]=127,a.#e[h+k[2]]=127,a.#e[h+k[10]]=64,a.#e.subarray(h+k[71],h+k[71]+8).fill(64),a.#e[h+k[128]]=127,a.#e.subarray(h+k[130],h+k[157]+1).fill(64),a.#e[h+k[91]]=40,a.#e[h+k[101]]=127,a.#e[h+k[100]]=127,a.#e[h+k[99]]=127,a.#e[h+k[98]]=127;let u=l*p.rpn;a.#r[u]=2,a.#r[u+1]=64,a.#r[u+2]=0,a.#r[u+3]=64,a.#r[u+4]=0,a.#r[u+5]=0;let b=l*p.ext;a.#m[b+1]=a.VLBC_BRTHEXPR;let m=l*p.redir;a.#z[m+8]=13}a.buildRchTree(),a.buildRccMap(),a.dispatchEvent("mastervolume",a.#d);for(let l=0;l<Ie.length;l++)a.pushEffectType(l);a.dispatchEvent("reset"),a.switchMode("?")}setChMode(e,a){let l=this;if(typeof e!="number"||e<0||e>=p.ch)throw new RangeError(`Invalid part number: CH${e+1}`);if(e<0||a>=M.length)throw new RangeError(`Invalid mode ID ${a}`);l.#W[e]=a,l.dispatchEvent("chmode",{part:e,id:a,mode:M[a]}),l.pushChPrimitives(e)}getChMode(e,a){return M[this.getChModeId(e,a)]}getChModeId(e,a){return a?this.#W[e]||this.#f[e>>4]:this.#W[e]||this.#f[e>>4]||this.#t}getPortMode(e,a){return M[this.getPortModeId(e,a)]}getPortModeId(e,a){return a?this.#f[e]:this.#f[e]||this.#t}setPortMode(e,a,l){let h=this;if(e<0||e>=p.ch>>4)throw new RangeError(`Invalid port ${e+1}`);if(a<1)throw new RangeError("Range must be a positive integer");if(e+a>=p.ch>>4)throw new RangeError("Range must be in bound");if(e<0||l>=M.length)throw new RangeError(`Invalid mode ID ${l}`);h.#ie[e]=l;for(let u=e;u<e+a;u++){let b=h.#ie[u];if(a>1&&b!==0&&b!==l)break;h.#f[u]=l;for(let m=u<<4;m<u+1<<4;m++)h.dispatchEvent("chmode",{part:m,id:l,mode:M[l]}),h.pushChPrimitives(m)}}copyChSetup(e,a,l){if(e===a){console.warn(`Failed attempt at overwriting CH${e+1} with its own data.`);return}let h=this;if(l&&h.#v[a]){console.warn(`Failed attempt at copying setup data from CH${e+1} to CH${a+1}.`);return}let u=T[e],b=T[a];h.#i[a]=h.#i[e],h.#e.set(h.#e.subarray(u,u+p.cc),b),h.pushChPrimitives(a)}setDrumFirstWrite(e,a){let l=this,h=l.#a[e];if(h<2)return;let u=h-2;if(l.#A[u<<1])if(a)l.#A[u<<1]=0,S()&&console.debug(`First write part for drum set ${u+1} has been reset.`);else return;else a?console.warn(`First write part for drum set ${u+1} is already blank.`):(l.#A[u<<1]=1,l.#A[u<<1|1]=e,console.debug(`First write part for drum set ${u+1} is set to CH${e+1}.`))}getChDrumFirstWrite(e){let a=this,l=a.#a[e];if(l<2)return;let h=l-2;return a.#A.subarray(h<<1,h+1<<1)}getDrumFirstWrite(e){if(e>=0&&e<p.drm)return this.#A.subarray(e<<1,e+1<<1)}switchMode(e,a=!1,l=!1){let h=this,u=E[e];if(u>-1){if(h.#t===0||a){switch(h.initOnReset&&a&&h.init(1),h.#E=0,u){case E.gm:{u=h.#s.gm;break}case E.g2:{u=h.#s.g2;break}}switch(h.#t=u,u){case E.gs:case E.sc:{h.#p[E[e]][1]=h.#s[e];break}}for(let C=0;C<p.ch;C++){let $=h.getChModeId(C,!0);h.#a[C]>0&&$===E["?"]&&(h.setChCc(C,0,h.#p[u][2]),S()&&console.debug(`CH${C+1} (${h.#a[C]}) (${h.getChMode(C)}), ${M[$]} (${h.#p[$][2]}) -> ${M[u]} (${h.#p[u][2]})`),h.pushChPrimitives(C))}switch(u){case E.mt32:{ne.forEach((C,$)=>{let v=$+1;h.#v[v]||(h.#i[v]=C,h.setChCc(v,91,127),h.pushChPrimitives(v))});for(let C=1;C<10;C++)h.pushChPrimitives(C);break}}let b,m;switch(u){case E["?"]:case E.g2:{b=[52,4,52,18,0,255,0,255,0,255,0,255,0,255,0,255];break}case E.xg:case E.cs1x:{b=[1,0,65,0,5,0,64,0,64,0,64,0,64,0,0,255],m=[64,0];break}case E.gm:case E.gs:case E.sc:{b=[40,4,40,18,40,32,32,0,0,255,0,255,0,255,0,255],m=[32,0];break}case E.sd:{b=[58,0,60,0,61,0,61,0],m=[61,0];break}case E["05rw"]:case E.x5d:case E.ns5r:{b=[44,1,44,19,0,255,0,255,0,255,0,255,0,255,0,255];break}case E.k11:case E.sg:{b=[24,0,0,255,0,255,0,255,0,255,0,255,0,255,0,255];break}case E.mt32:{b=[40,4,0,255,0,255,0,255,0,255,0,255,0,255,0,255];break}case E.doc:{b=[24,16,0,255,0,255,0,255,0,255,0,255,0,255,0,255];break}case E.motif:case E.s90es:case E.cs6x:{b=[129,0,133,0,130,0,128,0,128,0,0,255,0,255,0,255],m=[128,0];break}case E.pa:{b=[28,52,28,16,28,0,28,0,0,255,0,255,0,255,0,255],m=[28,0];break}case E.krs:{b=[45,0,45,0,0,255,45,0,45,0,45,0,45,0,45,0],m=[45,0];break}default:b=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}for(let C=0;C<p.efx;C++)if(!h.#S[3*C]&&typeof b[C<<1]=="number"){h.#S[3*C+1]=b[C<<1],h.#S[3*C+2]=b[C<<1|1];let $=!1;m?.length>0&&b[C<<1]===m[0]&&b[C<<1|1]===m[1]&&($=!0),h.pushEffectType(C,$)}l&&h.setDetectionTargets(e),h.dispatchEvent("mode",M[u]),h.forceVoiceRefresh()}}else throw new Error(`Unknown mode ${e}`)}getRawStrength(){let e=this;return this.#u.forEach(function(a){let l=a>>7;e.#b[a]>e.#D[l]&&(e.#D[l]=e.#b[a])}),this.#D}getStrength(){let e=[],a=this;return this.getRawStrength().forEach(function(l,h){e[h]=Math.floor(l*a.getChCc(h,7)*a.getChCc(h,11)*a.#d/803288)}),e}newStrength(){this.#D.fill(0)}runJson(e){if(e.type>14)return e.type===15&&e.data.constructor!==Uint8Array&&(e.data=Uint8Array.from(e.data)),this.#pe[e.type].call(this,e);{let a=this.chRedir(e.part,e.track),l=!1;this.#ue[a]?.forEach(h=>{e.channel=h,l=!0,this.#pe[e.type].call(this,e)}),l||console.warn(`${Me[e.type]?Me[e.type]:e.type}${[11,12].includes(e.type)?(e.data[0]!==void 0?e.data[0]:e.data).toString():""} event sent to CH${a+1} without any recipient.`)}this.#x.length>100&&this.#x.splice(100,this.#x.length-99)}runRaw(e){}async loadBank(e,a){let l=this;switch(e=e.toLowerCase(),e){case"s7e":{l.userBank.clearRange({msb:63,lsb:[21,22]}),l.userBank.clearRange({msb:63,lsb:[24,27]});break}case"pcg":{l.userBank.clearRange({msb:63,lsb:[6,9]}),l.userBank.clearRange({msb:63,lsb:[13,16]});break}default:throw new Error(`Unknown bank format ${e}`)}switch(e){case"s7e":case"pcg":{F.context=this,await l.userBank.load(await F.read(e,a),!1);break}}l.forceVoiceRefresh()}constructor(){super();let e=this;for(let t=0;t<10;t++)e.#R[t]=new Uint8Array(256);e.#R[10]=new Uint8Array(512),e.#Z=new I,e.#s={x5:82,ds:E.krs,smotif:E.s90es,gs:4,sc:3,gm:E.gm,g2:E.g2},e.#L={dumpLimit:e.DUMP_MODE},e.#fe=new Proxy(e.#L,{set:()=>{}});for(let t in W){let c=E[t];c===void 0?console.debug(`SubDB build error: "${t}" does not exist`):e.#p[c]=new Uint8Array(W[t])}for(let t of L)e.modelEx.yPlg.push(new Uint8Array(t[1]));e.userBank.strictMode=!0,e.userBank.load(`MSB	PRG	LSB	NME
062	000	000	
122	000	000	
122	001	000	
122	002	000	
122	003	000	
122	004	000	
122	005	000	
122	006	000	`),e.addEventListener("metacommit",function(t){let{data:c}=t;e.#x[0]?.type===c.type&&e.#x[0]?.amend?(e.#x[0].amend=c.amend,e.#x[0].data+=c.data):e.#x.unshift(c)}),e.#$[1]=function(t){switch(t=t.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),t.substring(0,2)){case"@I":{e.#l=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"Kar.Info",data:t.substring(2)?.trimStart()});break}case"@K":{e.#l=e.KARAOKE_TEXT;let c=t.substring(2);c!=="MIDI KARAOKE FILE"&&e.dispatchEvent("metacommit",{type:"Kar.Mode",data:c?.trimStart()}),console.debug(`Karaoke mode active: ${c}`);break}case"@L":{e.#l=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"Kar.Lang",data:t.substring(2)?.trimStart()});break}case"@T":{e.#l=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"KarTitle",data:t.substring(2)?.trimStart()});break}case"@V":{e.#l=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"Kar.Ver.",data:t.substring(2)?.trimStart()});break}case"Mi":{if(t.substring(2,16)==="dStamp-1.00: 0"){let c=t.length;for(let r=t.length;r>0;r--)if((t.charCodeAt(r-1)>>5)+1>>1===1){c=r;break}let s=t.substring(16,c);e.dispatchEvent("metacommit",{type:"MidStamp",data:xe(s)})}else t.split(`
`).forEach((c,s)=>{e.dispatchEvent("metacommit",{type:"Cmn.Text",data:c,mask:s!==0})});break}case"XF":{let c=t.slice(2).split(":");switch(c[0]){case"hd":{c.slice(1).forEach((s,r)=>{s.length&&e.dispatchEvent("metacommit",{type:["XfSngDte","XfSngRgn","XfSngCat","XfSongBt","XfSngIns","XfSngVoc","XfSngCmp","XfSngLrc","XfSngArr","XfSngPer","XfSngPrg","XfSngTag"][r],data:s})});break}case"ln":{c.slice(1).forEach((s,r)=>{s.length&&e.dispatchEvent("metacommit",{type:["XfKarLng","XfKarNme","XfKarCmp","XfKarLrc","XfKarArr","XfKarPer","XfKarPrg"][r],data:s})});break}default:e.dispatchEvent("metacommit",{type:"XfUnData",data:t})}break}default:switch(e.#l){case e.KARAOKE_TEXT:{switch(t[0]){case"\\":{e.dispatchEvent("metacommit",{type:"KarLyric",data:"",amend:!1}),e.dispatchEvent("metacommit",{type:"KarLyric",data:t.substring(1),amend:!0});break}case"/":{e.dispatchEvent("metacommit",{type:"KarLyric",data:"",mask:!0,amend:!1}),e.dispatchEvent("metacommit",{type:"KarLyric",data:t.substring(1),mask:!0,amend:!0});break}default:e.dispatchEvent("metacommit",{type:"KarLyric",data:t,amend:!0})}break}default:t.split(`
`).forEach((c,s)=>{e.dispatchEvent("metacommit",{type:"Cmn.Text",data:c,mask:s!==0})})}}},e.#$[2]=function(t){e.dispatchEvent("metacommit",{type:"Copyrite",data:t})},e.#$[3]=function(t,c){c<1&&e.#Q<1&&e.dispatchEvent("metacommit",{type:"TrkTitle",data:t})},e.#$[4]=function(t,c){e.dispatchEvent("metacommit",{type:"Instrmnt",data:t})},e.#$[5]=function(t){switch(e.#l){case e.KARAOKE_XF:{let c="";for(let s of t)switch(s){case"^":case"%":{c+=" ";break}case">":{c+="	";break}case"<":{e.dispatchEvent("metacommit",{type:"KarLyric",data:c,mask:e.#h,amend:!1}),c="",e.#h=!1;break}case"/":{e.dispatchEvent("metacommit",{type:"KarLyric",data:c,mask:!1,amend:!1}),c="",e.#h=!0;break}default:c+=s}c.length>0&&(e.dispatchEvent("metacommit",{type:"KarLyric",data:c,mask:e.#h,amend:!0}),e.#h=!1);break}default:{let c=0,s=!0,r=t.length-1;for(;s&&c<8;)switch(t.charCodeAt(c)){case 32:{c++;break}default:s=!1}switch(c>0&&(e.dispatchEvent("metacommit",{type:"C.Lyrics",data:t.substring(0,c),amend:!0,mask:e.#h,untimed:!0}),e.#h=!1),t.charCodeAt(r)){case 10:{e.dispatchEvent("metacommit",{type:"C.Lyrics",data:t.substring(c,r),amend:!1,mask:e.#h}),e.#h=!1;break}case 11:case 13:{e.dispatchEvent("metacommit",{type:"C.Lyrics",data:t.substring(c,r),amend:!1,mask:e.#h}),e.#h=!0;break}case 32:{e.dispatchEvent("metacommit",{type:"C.Lyrics",data:t.substring(c,r),amend:!0,mask:e.#h}),e.dispatchEvent("metacommit",{type:"C.Lyrics",data:" ",amend:!0,mask:!1,untimed:!0}),e.#h=!1;break}default:t.trim()===""?console.info("Blank line? Shouldn't happen."):e.dispatchEvent("metacommit",{type:"C.Lyrics",data:t,amend:!0,mask:e.#h}),e.#h=!1}break}}},e.#$[6]=function(t){e.dispatchEvent("metacommit",{type:"C.Marker",data:t})},e.#$[7]=function(t){switch(t[0]){case"$":{if(t.substring(1,5)==="Lyrc"){e.#l=e.KARAOKE_XF;let c=t.substring(6).split(":"),s=c[0].replaceAll(" ","").split(",");s.forEach((i,o,n)=>{n[o]=parseInt(i)-1});let r=ke[c[2].substring(0,2).toLowerCase()];e.dispatchEvent("metacommit",{type:"XfMeloCh",data:`CH${c[0].replaceAll(" ","").split(",").join(", CH")}`,parsed:s}),e.dispatchEvent("metacommit",{type:"XfLyrOff",data:c[1],parsed:parseInt(c[1])}),e.dispatchEvent("metacommit",{type:"XfLyrEnc",data:r[1],parsed:r[0]}),e.#h=!1}else e.dispatchEvent("metacommit",{type:"CuePoint",data:t});break}case"#":{e.dispatchEvent("metacommit",{type:"XfScneNo",data:t.substring(1)});break}case"&":{t.length===2?(e.dispatchEvent("metacommit",{type:"XfSngPrt",data:me[t[1]]||`Unknown "${t[1]}"`}),e.#h=!1):e.dispatchEvent("metacommit",{type:"CuePoint",data:t});break}default:e.dispatchEvent("metacommit",{type:"CuePoint",data:t})}},e.#$[32]=function(t){e.#Q=t[0]+1},e.#$[33]=function(t,c){S()&&console.debug(`Track ${c} requests getting assigned to port ${t}.`),e.#F[c]=t+1},e.#$[81]=function(t,c){e.#oe=t/1e3},e.#$[127]=function(t,c){e.#Z.run(t,c)},e.#Z.default=function(t){let c=[];for(let s=0;s<8&&s<t.length;s++)c.push(t[s].toString(16).padStart(2,"0").toUpperCase());console.warn(`Unrecognized implementation-specific byte sequence: ${c.join(" ")}${t.length>8?" ...":""}
%o`,t)},e.#Z.add([67,0,1],(t,c)=>{S()&&console.debug(`XGworks port assign requests assigning track ${c} to port ${t[0]}.`),e.#F[c]=t[0]+1}).add([67,123,1],(t,c)=>{let s=[];for(let r=0;r<t.length;r+=2){let i=t[r]>>4,o=t[r]&15;if(i<7&&o&&o<8){let n=new Uint8Array(5);n[0]=o-1,n[1]=i-3<<2,n[2]=t[r|1],s.push(n)}}e.dispatchEvent("metacommit",{type:"ChordCtl",src:"yxf",data:s}),console.debug("Yamaha XF chord data: %o",s)}).add([67,123,2],(t,c)=>{let s=new Uint8Array(2);s[0]=t[0]&15,s[1]=t[0]>>4,e.dispatchEvent("metacommit",{type:"RhrslMrk",src:"yxf",data:s}),console.debug(`Yamaha XF rehearsal mark: ${["Intro","Ending","Fill-in"][s[0]]??String.fromCharCode(62+s[0])}${"'".repeat(s[1])} %o`,s)}).add([67,123,96],(t,c)=>{let s=[0,0];t.subarray(1,3).forEach(r=>{s[0]=s[0]<<7,s[0]|=r&127}),t.subarray(3,5).forEach(r=>{s[1]=s[1]<<7,s[1]|=r&127}),e.dispatchEvent("metacommit",{type:"YStyleId",data:s}),console.debug(`Yamaha style ID: model ${s[0].toString(16)}, style ${s[1]+1}`)}),e.#J=new I("universal non-realtime"),e.#ee=new I("universal realtime"),e.#g=new I("Yamaha"),e.#M=new I("Roland"),e.#I=new I("Korg"),e.#te=new I("Kawai"),e.#ae=new I("Akai"),e.#re=new I("Casio");let a=new I("DX7+ Dump"),l=function(t){let c=[];for(let s=0;s<8&&s<t.length;s++)c.push(t[s].toString(16).padStart(2,"0").toUpperCase());console.info(`Unrecognized SysEx in "${this.name}" set: ${c.join(" ")}${t.length>8?" ...":""}
%o`,t)};e.#J.default=l,e.#ee.default=l,e.#g.default=l,e.#M.default=l,e.#I.default=l,e.#te.default=l,e.#ae.default=l,e.#re.default=l,a.default=l,e.#J.add([9],(t,c,s)=>{e.switchMode(["gm","?","g2"][t[0]-1],!0),e.setPortMode(e.getTrackPort(c),1,[E.gm,E["?"],e.#s.g2][t[0]-1]),e.#l=e.#l||e.KARAOKE_NONE,console.info(`MIDI reset: ${["GM","Init","GM2"][t[0]-1]}`),t[0]===2&&e.init()}),e.#ee.add([4,1],(t,c,s)=>{e.invokeSysExIndicator(),e.#d=((t[1]<<7)+t[0])/16383*100,e.dispatchEvent("mastervolume",e.#d)}).add([4,3],(t,c,s)=>((t[1]<<7)+t[0]-8192)/8192).add([4,4],(t,c,s)=>t[1]-64).add([4,5],(t,c,s)=>{e.invokeSysExIndicator();let r=t[0],i=t[1],o=t[2],n=3,f=n+(r<<1),d=f+i;if(r!==1){console.error(`Unsupported GM2 global parameter set: slotpath length too long (${r})!
`,t);return}let g=0,y=0,w=0;switch(t.subarray(n,f).forEach(x=>{g=g<<7,g|=x}),t.subarray(f,d).forEach((x,P)=>{y|=x<<P*7}),t.subarray(d).forEach((x,P)=>{w|=x<<P*7}),S()&&console.debug(`GM2 global parameter: (${t.subarray(3,f)}; p: ${y}, v: ${w})`),g){case 129:{y===0&&(e.setEffectType(0,52,w),e.pushEffectType(0));break}case 130:{y===0&&(e.setEffectType(1,52,w|16),e.pushEffectType(1));break}default:S()&&console.debug("GM2 global paramater slot path unknown.")}}),this.#g.add([76,0,0],(t,c,s)=>{switch(t[0]){case 125:{e.initDrums(),console.info(`XG drum setup reset on drum kit ${t[1]}.`);break}case 126:{e.switchMode("xg",!0),e.setPortMode(e.getTrackPort(c),4,E.xg),e.#l=e.#l||e.KARAOKE_NONE,console.info("MIDI reset: XG");break}default:{e.invokeSysExIndicator();let r=[0,0,0,0],i=(o,n)=>{r[n]=o};if(t.subarray(1).forEach((o,n)=>{let f=n+t[0];([i,i,i,i,d=>{this.#d=d*129/16383*100,e.dispatchEvent("mastervolume",e.#d)},d=>{},d=>{}][f]||(()=>{}))(o,n)}),t[0]<4){let o=0;r.forEach(n=>{o=o<<4,o+=n}),o-=1024,console.debug(`Master tune: ${o}`)}}}}).add([76,2,1],(t,c,s)=>{e.invokeSysExIndicator();let r="XG ";t[0]<32?(r+="reverb ",t.subarray(1).forEach((i,o)=>{([n=>{e.setEffectTypeRaw(0,!1,n),console.info(`${r}main type: ${V[n]}`),e.pushEffectType(0)},n=>{e.setEffectTypeRaw(0,!0,n),console.debug(`${r}sub type: ${n+1}`),e.pushEffectType(0)},n=>{console.debug(`${r}time: ${be(n)}s`)},n=>{console.debug(`${r}diffusion: ${n}`)},n=>{console.debug(`${r}initial delay: ${n}`)},n=>{console.debug(`${r}HPF cutoff: ${_[n]}Hz`)},n=>{console.debug(`${r}LPF cutoff: ${_[n]}Hz`)},n=>{console.debug(`${r}width: ${n}`)},n=>{console.debug(`${r}height: ${n}`)},n=>{console.debug(`${r}depth: ${n}`)},n=>{console.debug(`${r}wall type: ${n}`)},n=>{console.debug(`${r}dry/wet: ${n}`)},n=>{console.debug(`${r}send: ${A(n)}dB`)},n=>{console.debug(`${r}pan: ${n-64}`)},!1,!1,n=>{console.debug(`${r}delay: ${n}`)},n=>{console.debug(`${r}density: ${n}`)},n=>{console.debug(`${r}balance: ${n}`)},n=>{},n=>{console.debug(`${r}feedback: ${n}`)},n=>{}][t[0]+o]||function(){console.warn(`Unknown XG reverb address: ${t[0]}.`)})(i)})):t[0]<64?(r+="chorus ",t.subarray(1).forEach((i,o)=>{([n=>{e.setEffectTypeRaw(1,!1,n),console.info(`${r}main type: ${V[n]}`),e.pushEffectType(1)},n=>{e.setEffectTypeRaw(1,!0,n),console.debug(`${r}sub type: ${n+1}`),e.pushEffectType(1)},n=>{console.debug(`${r}LFO: ${pe[n]}Hz`)},n=>{},n=>{console.debug(`${r}feedback: ${n}`)},n=>{console.debug(`${r}delay offset: ${ye(n)}ms`)},n=>{},n=>{console.debug(`${r}low: ${_[n]}Hz`)},n=>{console.debug(`${r}low: ${n-64}dB`)},n=>{console.debug(`${r}high: ${_[n]}Hz`)},n=>{console.debug(`${r}high: ${n-64}dB`)},n=>{console.debug(`${r}dry/wet: ${n}`)},n=>{console.debug(`${r}send: ${A(n)}dB`)},n=>{console.debug(`${r}pan: ${n-64}`)},n=>{console.debug(`${r}to reverb: ${A(n)}dB`)},!1,n=>{},n=>{},n=>{},n=>{console.debug(`${r}LFO phase diff: ${(n-64)*3}deg`)},n=>{console.debug(`${r}input mode: ${n?"stereo":"mono"}`)},n=>{}][t[0]-32+o]||function(){console.warn(`Unknown XG chorus address: ${t[0]}.`)})(i)})):t[0]<86?(r+="variation ",t.subarray(1).forEach((i,o)=>{([n=>{e.setEffectTypeRaw(2,!1,n),console.info(`${r}main type: ${V[n]}`),e.pushEffectType(2)},n=>{e.setEffectTypeRaw(2,!0,n),console.debug(`${r}sub type: ${n+1}`),e.pushEffectType(2)}][t[0]-64+o]||function(){})(i)})):t[0]<97?(r+="variation ",t.subarray(1).forEach((i,o)=>{[n=>{console.debug(`${r}send: ${A(n)}dB`)},n=>{console.debug(`${r}pan: ${n-64}`)},n=>{console.debug(`${r}to reverb: ${A(n)}dB`)},n=>{console.debug(`${r}to chorus: ${A(n)}dB`)},n=>{e.modelEx.xg.varSys=!!n,console.debug(`${r}connection: ${n?"system":"insertion"}`)},n=>{if(e.modelEx.xg.varSys){console.warn(`${r}effect is applied system-wide. Setting its effective channel to CH${n+1} will not have any effect.`);return}if(n<64){let f=e.chRedir(n,c,!0);e.setXgChEffectSink(f,2),console.debug(`${r}channel: CH${n+1} (CH${f+1})`)}else e.setXgChEffectSink(p.invalidCh,2),console.info(`${r}channel: CH${n+1} (unsupported)`)},n=>{console.debug(`${r}mod wheel: ${n-64}`)},n=>{console.debug(`${r}bend wheel: ${n-64}`)},n=>{console.debug(`${r}channel after touch: ${n-64}`)},n=>{console.debug(`${r}AC1: ${n-64}`)},n=>{console.debug(`${r}AC2: ${n-64}`)}][t[0]-86+o](i)})):t[0]>111&&t[0]<118?r+="variation ":console.warn(`Unknown XG variation address: ${t[0]}`)}).add([76,2,64],(t,c,s)=>{t.subarray(1).forEach((r,i)=>{let o=i+t[0];if(o===0)console.debug(`XG EQ preset: ${["flat","jazz","pop","rock","classic"][r]}`);else{let n=o-1>>2,f=o-1&3,d=`XG EQ ${n} ${["gain","freq","Q","shape"][f]}: `;[()=>{console.debug(`${d}${r-64}dB`)},()=>{console.debug(`${d}${r} (raw)`)},()=>{console.debug(`${d}${r/10}`)},()=>{console.debug(`${d}${["shelf","peak"][+!!r]}`)}][f]()}})}).add([76,3],(t,c,s)=>{e.invokeSysExIndicator();let r=t[0],i=t[1],o=`XG Insertion ${t[0]+1} `;t.subarray(2).forEach((n,f)=>{([()=>{e.setEffectTypeRaw(3+r,!1,n),console.info(`${o}main type: ${V[n]}`),e.pushEffectType(3+r)},()=>{e.setEffectTypeRaw(3+r,!0,n),console.debug(`${o}sub type: ${n+1}`),e.pushEffectType(3+r)},!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,()=>{if(n<64){let d=e.chRedir(n,c,!0);e.setXgChEffectSink(d,3+r),console.debug(`${o}channel: CH${n+1} (CH${d+1})`)}else e.setXgChEffectSink(p.invalidCh,3+r),console.info(`${o}channel: CH${n+1} (unsupported)`)}][i+f]||function(){})(n)})}).add([76,6,0],(t,c,s)=>{let r=t[0];r<64?e.setLetterDisplay(t.subarray(1),"XG letter display",r):e.#K=Date.now()}).add([76,7,0],(t,c,s)=>{let r=t[0];e.#E=0,e.#P=Date.now()+3200,t.subarray(1).forEach(function(o,n){let f=n+r,d=f>>4,g=f&15,y=(g*3+d)*7,w=7,x=0;for(y-=g*5,d===2&&(w=2);x<w;)e.#N[y+x]=o>>6-x&1,x++})}).add([76,8],(t,c)=>{e.invokeSysExIndicator();let s=e.chRedir(t[0],c,!0),r=t[1],i=T[s],o=`XG CH${s+1} `,n=`Unknown XG part address ${r}.`,f=!0;t.subarray(2).forEach((d,g)=>{f=!0,r<1?console.debug(n):r<41?([()=>{e.setChCc(s,0,d),e.pushChPrimitives(s)},()=>{e.setChCc(s,32,d),e.pushChPrimitives(s)},()=>{e.#i[s]=d,e.pushChPrimitives(s)},()=>{f=!1;let y=e.chRedir(d,c,!0),w=e.#c[s];e.#c[s]=y,(s!==y||y!==w)&&(e.buildRchTree(),console.info(`${o}receives from CH${y+1}`)),e.#v[s]||(e.copyChSetup(y,s,!0),console.debug(`${o}copied from CH${y+1}.`),e.setChActive(s,1),e.pushChPrimitives(s))},()=>{e.#k[s]=+!d},()=>{},()=>{f=!1,e.setChType(s,d,E.xg),console.debug(`${o}type: ${Y[d]||d}`),e.pushChPrimitives(s)},()=>{e.#r[p.rpn*s+3]=d,e.#n[p.rpnt*s+2]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},!1,!1,()=>{e.setChCc(s,7,d)},!1,!1,()=>{e.setChCc(s,10,d||128)},!1,!1,()=>{e.setChCc(s,128,d),e.allocateAce(s,128)},()=>{e.setChCc(s,93,d)},()=>{e.setChCc(s,91,d)},()=>{e.setChCc(s,94,d)},()=>{e.setChCc(s,76,d)},()=>{e.setChCc(s,77,d)},()=>{e.setChCc(s,78,d)},()=>{e.setChCc(s,74,d)},()=>{e.setChCc(s,71,d)},()=>{e.setChCc(s,73,d)},()=>{e.setChCc(s,75,d)},()=>{e.setChCc(s,72,d)}][r+g-1]||(()=>{}))():r<48?console.debug(n):r<111?r>102&&r<105&&e.setChCc(s,[5,65][r&1],d):r<114?console.debug(n):r<116?console.debug(`${o}EQ ${["bass","treble"][r&1]} gain: ${d-64}dB`):r<118?console.debug(n):r<120?console.debug(`${o}EQ ${["bass","treble"][r&1]} freq: ${d}`):console.debug(n)}),f&&e.#a[s]>1&&e.setDrumFirstWrite(s)}).add([76,9],(t,c)=>{let s=e.chRedir(t[0],c,!0),r=t[1],i=T[s],o=`PLG-VL CH${s+1} `;t.subarray(2).forEach((n,f)=>{let d=f+r;switch(d){case 1:{console.info(`${o}breath mode: ${["system","breath","velocity","touch EG"][n]}`);break}case 0:case 27:case 28:break;default:if(d<27){let g=d-3>>1,y=["pressure","embouchure","tonguing","scream","breath noise","growl","throat formant","harmonic enhancer","damping","absorption","amplification","brightness"][g];d&1?d<23?(console.debug(`${o}${y} control source: ${Ee(n)}`),n&&n<96&&e.allocateAce(s,130+g),e.#z[p.redir*s+g+2]=n,e.buildRccMap()):console.debug(`${o}${y} scale break point: ${n}`):(console.debug(`${o}${y} depth: ${n-64}`),e.setChCc(s,130+g,n))}}})}).add([76,10],(t,c,s)=>{}).add([76,16],(t,c,s)=>{}).add([76,17,0,0],(t,c,s)=>{}).add([76,112],(t,c,s)=>{if(t[0]>=L.length){console.error(`Supplied invalid plugin board ID: ${t[0]}`);return}if(t[1]>=L[t[0]][1]){console.error(`Supplied invalid slot ID for board type "${L[t[0]][0]}" (${t[0]}): ${t[1]} (#${t[1]+1}))`);return}switch(t[1]>=L[t[0]][2]?console.warn(`While enabled in Octavia, slot #${t[1]+1} for board type "${L[t[0]][0]}" (${t[0]}) may not function outside software recreation.`):t[2]>63?console.debug(`XG disable PLG-${L[t[0]][0]} (${t[0]}) slot #${t[1]+1} as it's set to CH${t[2]+1}.`):console.debug(`XG enable PLG-${L[t[0]][0]} (${t[0]}) slot #${t[1]+1} for CH${t[2]+1}.`),e.modelEx.yPlg[t[0]][t[1]]=t[2]<64?e.chRedir(t[2],c,!0):p.invalidCh,t[0]){case 0:{e.#m[p.ext*t[2]]=e.EXT_VL;break}case 2:{e.#m[p.ext*t[2]]=e.EXT_DX;break}default:e.#m[p.ext*t[2]]=e.EXT_NONE}}).add([73,0,0],(t,c)=>{let s=t[0],r="MU1000 System - ";t.subarray(1).forEach((i,o)=>{let n=s+o;n===8?console.debug(`${r}LCD contrast: ${i}.`):n===18?(e.#p[E.xg][1]=i?126:0,console.debug(`${r}default bank: ${i?"MU100 Native":"MU Basic"}.`),e.dispatchEvent("banklevel",{mode:"xg",data:+!!i}),e.forceVoiceRefresh()):n>=64&&n<69&&[()=>{e.dispatchEvent("channelactive",i)},()=>{i<8?(e.dispatchEvent("channelmin",i<<4),console.debug(`Octavia System: Minimum CH${(i<<4)+1}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{i<8?(e.dispatchEvent("channelmax",(i<<4)+15),console.debug(`Octavia System: Maximum CH${(i<<4)+16}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges")},()=>{e.#U=!!i,console.info(`Octavia System: RS receiving ${["dis","en"][i]}abled.`)}][n-64]()})}).add([73,10,0],(t,c)=>{let s=t[0],r=`MU1000 RS${e.#U?"":" (ignored)"}: `;if(s<16)switch(s){case 2:{let i=e.chRedir(0,c,!0);e.#U&&(e.dispatchEvent("portrange",4),e.dispatchEvent("portstart",i)),console.info(`${r}Show CH${i+1}~CH${i+64}`);break}case 3:{let i=e.chRedir(t[1]<<5,c,!0);e.#U&&(e.dispatchEvent("portrange",2),e.dispatchEvent("portstart",i)),console.info(`${r}Show CH${i+1}~CH${i+32}`);break}default:console.debug(`${r}unknown switch ${s} invoked.`)}else if(s<32){if(e.#U){let i=e.chRedir(s-16+(e.#le<<4),c,!0);e.dispatchEvent("channelactive",i)}}else if(s<36){let i=e.chRedir(s-32<<4,c,!0);e.#U&&(e.dispatchEvent("portrange",1),e.dispatchEvent("portstart",i>>4),e.#le=s-32),console.info(`${r}Show CH${i+1}~CH${i+16}`)}}).add([73,11,0],(t,c)=>{let s="MU1000 System - channel ",r="Octavia System - channel ",i=t[0];t.subarray(1).forEach((o,n)=>{let f=i+n;([()=>{e.setChActive(o,1),e.dispatchEvent("channelactive",o),S()&&console.debug(`${s}current part: CH${o+1}`)},()=>{o<5?(e.dispatchEvent("portrange",1<<o),console.debug(`${s}port range: ${1<<o} port(s)`)):(e.dispatchEvent("portrange",0),console.debug(`${s}port range: reset`))},()=>{o<16?(e.dispatchEvent("portstart",o),console.debug(`${r}start port: ${"ABCDEFGHIJKLMNOP"[o]}`)):(e.dispatchEvent("portstart",255),console.debug(`${r}start port: reset`))}][f]||(()=>{console.debug(`${s}unknown address: ${f}`)}))()})}).add([93,3],(t,c)=>{let s=e.chRedir(t[0],c,!0),r=`PLG-SG CH${s+1} `,i=Date.now(),o=e.modelEx.sg;if(t[1]===0){let n="",f=0;t.subarray(2).forEach((d,g)=>{g%2===0?n+=ge[d]||d.toString().padStart("0"):f+=d*13}),(i>=o.convLastSyll||o.runLineLen>=o.maxLineLen)&&(e.dispatchEvent("metacommit",{type:"SGLyrics",data:"",amend:!1}),o.splitMask=i<o.convLastSyll,o.runLineLen=0),e.dispatchEvent("metacommit",{type:"SGLyrics",data:`${Ce(n)}`,amend:!0,mask:o.splitMask}),o.runLineLen++,o.splitMask=!1,o.convLastSyll=i+Math.ceil(f/2)+e.#oe,S()&&console.debug(`${r}vocals: ${n}`)}else console.warn(`Unknown PLG-SG data: ${t}`)}).add([98,96],(t,c,s,r)=>{let i=e.chRedir(t[0],c,!0),o=T[i],n=t[1];t.subarray(2).forEach((f,d)=>{let g=n+d;if(!(g<10)){if(g===10)e.resetAce();else if(g<27){let y=g+131;e.setChCc(i,y,f),!r?.noAce&&f>0&&f!==64&&e.allocateAce(i,y),e.dispatchEvent("cc",{part:i,cc:y,data:f})}}})}).add([1,20],(t,c,s)=>{s===115?(e.switchMode("doc",!0),e.setPortMode(e.getTrackPort(c),1,E.doc),console.info("MIDI reset: DOC")):console.debug(`Unknown Yamaha SysEx: 67, ${s}, ${t.join(", ")}`)}).add([1,17,15,89],(t,c,s)=>{s===115?(e.setEffectType(0,24,t[0]|16),e.pushEffectType(0)):console.debug(`Unknown Yamaha SysEx: 67, ${s}, ${t.join(", ")}`)}).add([1,24],(t,c,s)=>{if(s===115){for(let r=0;r<16;r++){let i=e.chRedir(r,c,!0);e.setChCc(i,91,127)}console.info("DOC Global Reverb: on")}else console.debug(`Unknown Yamaha SysEx: 67, ${s}, ${t.join(", ")}`)}).add([126,0],(t,c,s)=>{switch(t[1]){case 0:{e.dispatchEvent("metacommit",{type:"YMCSSect",data:"Disabled",raw:"Intro "}),console.debug("Yamaha Section Control is off.");break}case 127:{e.dispatchEvent("metacommit",{type:"YMCSSect",data:["Intro","Main A","Main B","Fill-in AB","Fill-in BA","Ending","Blank"][t[0]-8]??`invalid section ${t[0]}`,raw:["Intro ","Main A","Main B","FillAB","FillBA","Ending","Blank "][t[0]-8]??`ID: ${t[0]}`}),console.debug(`Yamaha Section Control switches to "${["intro","main A","main B","fill-in AB","fill-in BA","ending","blank"][t[0]-8]??`Invalid section ${t[0]}`}".`);break}default:console.debug(`Unknown YMCS section control: ${t[1]}`)}}).add([126,2],(t,c,s)=>{let r=[];for(let i=0;i<t.length;i+=2){let o=t[i]>>4,n=t[i]&15;if(o<7&&n&&n<8){let f=new Uint8Array(5);f[0]=n-1,f[1]=o-3<<2,f[2]=t[i|1],r.push(f)}}e.dispatchEvent("metacommit",{type:"ChordCtl",src:"ymcs",data:r}),console.debug("YMCS chord data: %o",r)});let h=function(t,c,s,r){},u=function(t,c){e.invokeSysExIndicator();let s=t*p.dpn,r=c[0],i=c[1];c.subarray(2).forEach((o,n)=>{let f=n+i,d=-1;f<16?([()=>{d=24},()=>{d=25},()=>{d=26},()=>{},()=>{d=28},()=>{d=29},()=>{d=30},()=>{d=31},()=>{},()=>{},()=>{},()=>{d=20},()=>{d=21},()=>{d=22},()=>{d=23},()=>{}][f]||(()=>{console.debug(`Unknown XG-style drum param ${f} on set ${t+1}.`)}))():f<32||(f<40?([()=>{d=48},()=>{d=49},!1,!1,()=>{d=52},()=>{d=53}][f-32]||(()=>{console.debug(`Unknown XG-style drum param ${f} on set ${t+1}.`)}))():f<80||([()=>{d=36}][f-80]||(()=>{console.debug(`Unknown XG-style drum param ${f} on set ${t+1}.`)}))()),d>=0?(S()&&console.debug(s,d,r,o),e.#w[(s+U[d])*p.dnc+r]=o):S()&&console.debug(`XG-style drum param ${f} has no writes.`)})},b=function(t,c,s){e.invokeSysExIndicator();let r=t*p.dpn,i=(c<<7)+s[0];s.subarray(1).forEach((o,n)=>{let f=n+i,d=f&127,g=f>>7,y=-1;g>1&&([()=>{y=26},()=>{},()=>{y=28},()=>{y=29},()=>{y=30},()=>{},()=>{},()=>{y=31}][g-2]||(()=>{console.debug(`Unknown GS-style drum param ${g} on set ${t+1}.`)}))(),y>-1?(S()&&console.debug(r,y,d,o),e.#w[(r+U[y])*p.dnc+d]=o):S()&&console.debug(`GS-style drum param ${g} has no writes.`)})};this.#g.add([76,48],(t,c,s)=>{u(0,t)}).add([76,49],(t,c,s)=>{u(1,t)}).add([76,50],(t,c,s)=>{u(2,t)}).add([76,51],(t,c,s)=>{u(3,t)}).add([76,52],(t,c,s)=>{u(4,t)}).add([76,53],(t,c,s)=>{u(5,t)}).add([76,54],(t,c,s)=>{u(6,t)}).add([76,55],(t,c,s)=>{u(7,t)}),this.#g.add([89,0],(t,c,s)=>{if(e.eprom){let r=t[0],i=(t[1]<<14)+(t[2]<<7)+t[3]+(e.eprom.offset||0);S()&&console.debug(`MU1000 EPROM trail to 0x${i.toString(16).padStart(6,"0")}, ${r} bytes.`);let o=e.eprom.data;t.subarray(4).forEach((n,f)=>{let d=f>>3,g=f&7;if(g===7)for(let y=0;y<7;y++)o[i+7*d+y]+=(n>>6-y&1)<<7;else o[i+7*d+g]=n})}}).add([89,1],(t,c,s)=>{let r=(t[0]<<21)+(t[1]<<14)+(t[2]<<7)+t[3];S()&&console.debug(`MU1000 EPROM jump to 0x${r.toString(16).padStart(6,"0")}.`),e.eprom&&(e.eprom.offset=r)}).add([89,2],(t,c,s)=>{if(e.eprom){let r=(t[0]<<21)+(t[1]<<14)+(t[2]<<7)+t[3]+(e.eprom.offset||0);S()&&console.debug(`MU1000 EPROM write to 0x${r.toString(16).padStart(6,"0")}.`);let i=e.eprom.data;t.subarray(4).forEach((o,n)=>{let f=n>>3,d=n&7;if(d===7)for(let g=0;g<7;g++)i[r+7*f+g]+=(o>>6-g&1)<<7;else i[r+7*f+d]=o})}}).add([89,3],(t,c,s)=>{}),this.#g.add([39,48],(t,c,s)=>{}).add([43,0,0],(t,c,s)=>{e.invokeSysExIndicator();let r=[0,0,0,0],i=(o,n)=>{r[n]=o};if(t.subarray(1).forEach((o,n)=>{let f=n+t[0];[i,i,i,i,()=>{this.#d=o*129/16383*100,e.dispatchEvent("mastervolume",e.#d)},()=>o-64,()=>o||128,()=>o,()=>o,()=>{console.debug(`TG300 variation on cc${o}.`)}][f](o,f)}),t[0]<4){let o=0;r.forEach(n=>{o=o<<4,o+=n}),o-=1024,console.debug(`Master tune: ${o}`)}}).add([43,1,0],(t,c,s)=>{e.invokeSysExIndicator()}).add([43,2],(t,c,s)=>{e.invokeSysExIndicator();let r=e.chRedir(t[0],c,!0),i=t[1],o=T[r],n=`TG300 CH${r+1} `;t.subarray(2).forEach((f,d)=>{d<5?([()=>{},()=>{e.setChCc(r,0,f),e.pushChPrimitives(r)},()=>{e.setChCc(r,32,f),e.pushChPrimitives(r)},()=>{e.#i[r]=f,e.pushChPrimitives(r)},()=>{let g=e.chRedir(f,c,!0),y=e.#c[r];e.#c[r]=g,(r!==g||g!==y)&&(e.buildRchTree(),console.info(`${n}receives from CH${g+1}`))}][d+i]||(()=>{}))(f,d+i):d<21||(d<47?([()=>{e.#k[r]=+!f},()=>{},()=>{},()=>{e.#r[p.rpn*r+3]=f,e.#n[p.rpnt*r+2]=1,e.dispatchEvent("pitch",{part:r,pitch:e.getPitchShift(r)})},()=>{},()=>{e.setChCc(r,7,f)},!1,!1,()=>{e.setChCc(r,10,f||128)},!1,!1,()=>{console.debug(`${n} AC1 at cc${f}`)},()=>{console.debug(`${n} AC2 at cc${f}`)},()=>{e.#e[o+k[128]]=f,e.allocateAce(r,128)},()=>{e.#e[o+k[93]]=f},()=>{e.#e[o+k[91]]=f},()=>{e.#e[o+k[94]]=f},()=>{e.#e[o+k[76]]=f},()=>{e.#e[o+k[77]]=f},()=>{e.#e[o+k[74]]=f},()=>{e.#e[o+k[71]]=f},()=>{e.#e[o+k[73]]=f},()=>{e.#e[o+k[75]]=f},()=>{e.#e[o+k[72]]=f},()=>{e.#e[o+k[78]]=f}][d+i-21]||(()=>{}))(f,d+i):d<95||([()=>{e.#e[o+k[65]]=f},()=>{e.#e[o+k[5]]=f}][d+i-95]||(()=>{}))(f,d+i))})}).add([43,7,0],(t,c,s)=>{let r=t[0];e.setLetterDisplay(t.subarray(1),"TG300 letter display",r)}).add([43,7,1],(t,c,s)=>{e.#E=0,e.#P=Date.now()+3200,t.forEach(function(r,i){let o=i>>4,n=i&15,f=(n*3+o)*7,d=7,g=0;for(f-=n*5,o===2&&(d=2);g<d;)e.#N[f+g]=r>>6-g&1,g++})}),this.#M.add([66,18,0,0,127],(t,c,s)=>{e.switchMode("sc",!0),e.setPortMode(e.getTrackPort(c),2,E.sc),e.#l=e.KARAOKE_NONE,e.#B.fill(0),console.info(`GS system to ${["single","dual"][t[0]]} mode.`)}).add([66,18,64,0],(t,c,s)=>{switch(t[0]){case 127:{e.switchMode("gs",!0),e.setPortMode(e.getTrackPort(c),4,E.gs),e.#l=e.KARAOKE_NONE,e.#B.fill(0),console.info("MIDI reset: GS");break}default:{e.invokeSysExIndicator();let r=[0,0,0,0],i=(o,n)=>{r[n]=o};if(t.subarray(1).forEach((o,n)=>{let f=n+t[0];[i,i,i,i,d=>{this.#d=d*129/16383*100,e.dispatchEvent("mastervolume",e.#d)},d=>{},d=>{}][f](o,n)}),t[0]<4){let o=0;r.forEach(n=>{o=o<<4,o+=n}),o-=1024,console.debug(`Master tune: ${o}`)}}}}).add([66,18,64,1],(t,c,s)=>{e.invokeSysExIndicator();let r=t[0];if(r<16){let i="".padStart(r," ");t.subarray(1).forEach((o,n)=>{i+=String.fromCharCode(Math.max(32,o))}),i=i.padEnd(16," "),console.debug(`GS patch name: ${i}`)}else r<48||(r<65?t.subarray(1).forEach((i,o)=>{let n=`GS ${r+o>55?"chorus":"reverb"} `;([()=>{console.info(`${n}type: ${se[i]}`),e.setEffectType(0,40,i),e.pushEffectType(0)},()=>{},()=>{},()=>{},()=>{},()=>{},!1,()=>{console.debug(`${n}predelay: ${i}ms`)},()=>{console.info(`${n}type: ${$e[i]}`),e.setEffectType(1,40,16+i),e.pushEffectType(1)},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${n}to reverb: ${A(i)}`)},()=>{console.debug(`${n}to delay: ${A(i)}`)}][r+o-48]||(()=>{}))()}):r<80?console.debug(`Unknown GS patch address: ${r}`):r<91?t.subarray(1).forEach((i,o)=>{let n="GS delay ";([()=>{console.info(`${n}type: ${we[i]}`),e.setEffectType(2,40,32+i),e.pushEffectType(2)},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${n}to reverb: ${A(i)}`)}][r+o-80]||(()=>{}))()}):console.debug(`Unknown GS patch address: ${r}`))}).add([66,18,64,2],(t,c,s)=>{let r="GS EQ ";t.subarray(1).forEach((i,o)=>{([()=>{console.debug(`${r}low freq: ${[200,400][i]}Hz`)},()=>{console.debug(`${r}low gain: ${i-64}dB`)},()=>{console.debug(`${r}high freq: ${[3e3,6e3][i]}Hz`)},()=>{console.debug(`${r}high gain: ${i-64}dB`)}][t[0]+o]||function(){console.warn(`Unknown GS EQ address: ${t[0]+o}`)})()})}).add([66,18,64,3],(t,c,s)=>{e.invokeSysExIndicator();let r="GS EFX ",i=function(o,n){let f=ve(e.#S.subarray(10,12),n,o);f&&console.debug(`${r}${ie(e.#S.subarray(10,12))} ${f}`)};t.subarray(1).forEach((o,n)=>{([()=>{e.setEffectTypeRaw(3,!1,32+o),e.pushEffectType(3)},()=>{e.setEffectTypeRaw(3,!0,o),console.info(`${r}type: ${ie(e.#S.subarray(10,12))}`),e.pushEffectType(3)},!1,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,()=>{console.debug(`${r}to reverb: ${A(o)}dB`)},()=>{console.debug(`${r}to chorus: ${A(o)}dB`)},()=>{console.debug(`${r}to delay: ${A(o)}dB`)},!1,()=>{console.debug(`${r}1 source: ${o}`),o&&o<96&&e.allocateAceAll(o)},()=>{console.debug(`${r}1 depth: ${o-64}`)},()=>{console.debug(`${r}2 source: ${o}`),o&&o<96&&e.allocateAceAll(o)},()=>{console.debug(`${r}2 depth: ${o-64}`)},()=>{console.debug(`${r}to EQ: ${o?"ON":"OFF"}`)}][t[0]+n]||function(f,d){console.warn(`Unknown GS EFX address: ${d}`)})(o,t[0]+n)})}).add([66,18,65],(t,c,s)=>{b((t[0]>>4)+1<<1,t[0]&15,t.subarray(1))}).add([66,18,72],(t,c,s)=>{let r=(t[0]&127)<<7|t[1]&127;console.debug(r,Se(t.subarray(2)))}).add([69,18,16],(t,c,s)=>{switch(t[0]){case 0:{let r=t[1];e.setLetterDisplay(t.subarray(2),"GS display text",r);break}case 8:{let r=t[1],i=e.modelEx.sc;t.subarray(2).forEach((o,n)=>{([()=>{i.showBar=!(o&1),i.invBar=o>>1&1,i.invDisp=o>>2&1},()=>{i.peakHold=o<4?o:1}][n+r]||(()=>{console.debug("Unsupported GS display type SysEx.")}))()});break}case 32:{e.#P=Date.now()+3200,t[1]===0&&(t[2]?(e.#E=Math.max(Math.min(t[2]-1,9),0),S()&&console.debug(`GS switch display page ${t[2]-1}.`)):(e.#E=0,e.#P=Date.now(),S()&&console.debug("GS disable display page.")));break}default:if(t[0]<6){e.#E>9&&(e.#E=0);let r=t[0]-1<<1|t[1]>>6;e.#E===r&&(e.#P=Date.now()+3200),e.#R[r]?.length||(e.#R[r]=new Uint8Array(256));let i=e.#R[r];S()&&console.debug(`GS frame draw page ${r}.`);let o=t[1]&63;t.subarray(2).forEach(function(f,d){let g=d+o,y=g>>4,w=g&15,x=(w*4+y)*5,P=5,O=0;for(x-=w*4,y===3&&(P=1);O<P;)i[x+O]=f>>4-O&1,O++})}else console.warn(`Unknown GS display section: ${t[0]}`)}}).add([69,18,32],(t,c,s)=>{let r=t[0],i=t[1],o=t.subarray(2);if(r>>4){console.warn(`SC-8850 partial screen dump out of bounds: invalid bundle.
`,t);return}let n=i+o.length,f=i*6-(i*2428>>16<<1),d=n*6-(n*2428>>16<<1);if(f>640){console.warn(`SC-8850 partial screen dump out of bounds: invalid buffer range.
`,t);return}d>640&&(console.info(`SC-8850 partial screen dump out of bounds: invalid buffer end, automatically restricted.
`,t),d=640);let g=new Uint8Array(d-f);o.forEach((x,P)=>{let O=P+i,R=(O*2428&65535)*27>>16===26,ee=O*6-(O*2428>>16<<1),Q=R?2:0;for(;Q<6;)g[ee+(5-Q)]=x>>Q&1,Q++});let y=r*108+i,w=y*6-(y*2428>>16<<1);e.dispatchEvent("screen",{type:"sc8850",offset:w,data:g}),S()&&console.debug(`SC-8850 screen dump: bundle ${r+1}, range ${f}~${d}`)});let m=function(t,c,s){e.invokeSysExIndicator();let r=t[0],i=T[c],o=G[c],n=`GS CH${c+1} `;r<3?(t.subarray(1).forEach((f,d)=>{[()=>{e.#e[i+k[0]]=f,e.pushChPrimitives(c)},()=>{e.#i[c]=f},()=>{let g=0;f<16?g=e.chRedir(f,s,!0):g=p.ch;let y=e.#c[c];e.#c[c]=g,(c!==g||g!==y)&&(e.buildRchTree(),console.info(`${n}receives from CH${g+1}`))}][r+d]()}),e.pushChPrimitives(c)):r<19||(r<44?t.subarray(1).forEach((f,d)=>{([()=>{e.#k[c]=+!f},!1,()=>{e.setChType(c,f<<1,E.gs),console.debug(`${n}type: ${f?"drum ":"melodic"}${f||""}`)},()=>{e.#r[o+3]=f,e.#n[p.rpnt*c+2]=1,e.dispatchEvent("pitch",{part:c,pitch:e.getPitchShift(c)})},!1,()=>{e.#e[i+k[7]]=f},!1,!1,()=>{e.#e[i+k[10]]=f||128},!1,!1,()=>{console.debug(`${n}CC 1: cc${f}`)},()=>{console.debug(`${n}CC 2: cc${f}`)},()=>{e.#e[i+k[93]]=f},()=>{e.#e[i+k[91]]=f},!1,!1,()=>{e.#r[o+1]=f,e.#n[p.rpnt*c+1]=1,e.dispatchEvent("pitch",{part:c,pitch:e.getPitchShift(c)})},()=>{e.#r[o+2]=f,e.#n[p.rpnt*c+1]=1,e.dispatchEvent("pitch",{part:c,pitch:e.getPitchShift(c)})},()=>{e.#e[i+k[94]]=f}][r+d-19]||(()=>{}))()}):r<76||console.debug(`Unknown GS part address: ${r}`))},C=function(t,c){let s=t[0],r=`GS CH${c+1} `;s<2?t.subarray(1).forEach((i,o)=>{[()=>{e.setChCc(c,32,i)},()=>{}][s+o]()}):s<32?console.warn(`Unknown GS misc address: ${s}`):s<35?t.subarray(1).forEach((i,o)=>{[()=>{console.debug(`${r}EQ: o${["ff","n"][i]}`)},()=>{},()=>{console.debug(`${r}EFX: o${["ff","n"][i]}`),e.setChEffectSink(c,i?3:0)}][s+o-32]()}):console.warn(`Unknown GS misc address: ${s}`)};this.#M.add([66,18,64,16],(t,c)=>{m(t,e.chRedir(9,c,!0),c)}).add([66,18,64,17],(t,c)=>{m(t,e.chRedir(0,c,!0),c)}).add([66,18,64,18],(t,c)=>{m(t,e.chRedir(1,c,!0),c)}).add([66,18,64,19],(t,c)=>{m(t,e.chRedir(2,c,!0),c)}).add([66,18,64,20],(t,c)=>{m(t,e.chRedir(3,c,!0),c)}).add([66,18,64,21],(t,c)=>{m(t,e.chRedir(4,c,!0),c)}).add([66,18,64,22],(t,c)=>{m(t,e.chRedir(5,c,!0),c)}).add([66,18,64,23],(t,c)=>{m(t,e.chRedir(6,c,!0),c)}).add([66,18,64,24],(t,c)=>{m(t,e.chRedir(7,c,!0),c)}).add([66,18,64,25],(t,c)=>{m(t,e.chRedir(8,c,!0),c)}).add([66,18,64,26],(t,c)=>{m(t,e.chRedir(10,c,!0),c)}).add([66,18,64,27],(t,c)=>{m(t,e.chRedir(11,c,!0),c)}).add([66,18,64,28],(t,c)=>{m(t,e.chRedir(12,c,!0),c)}).add([66,18,64,29],(t,c)=>{m(t,e.chRedir(13,c,!0),c)}).add([66,18,64,30],(t,c)=>{m(t,e.chRedir(14,c,!0),c)}).add([66,18,64,31],(t,c)=>{m(t,e.chRedir(15,c,!0),c)}).add([66,18,64,64],(t,c)=>{C(t,e.chRedir(9,c,!0))}).add([66,18,64,65],(t,c)=>{C(t,e.chRedir(0,c,!0))}).add([66,18,64,66],(t,c)=>{C(t,e.chRedir(1,c,!0))}).add([66,18,64,67],(t,c)=>{C(t,e.chRedir(2,c,!0))}).add([66,18,64,68],(t,c)=>{C(t,e.chRedir(3,c,!0))}).add([66,18,64,69],(t,c)=>{C(t,e.chRedir(4,c,!0))}).add([66,18,64,70],(t,c)=>{C(t,e.chRedir(5,c,!0))}).add([66,18,64,71],(t,c)=>{C(t,e.chRedir(6,c,!0))}).add([66,18,64,72],(t,c)=>{C(t,e.chRedir(7,c,!0))}).add([66,18,64,73],(t,c)=>{C(t,e.chRedir(8,c,!0))}).add([66,18,64,74],(t,c)=>{C(t,e.chRedir(10,c,!0))}).add([66,18,64,75],(t,c)=>{C(t,e.chRedir(11,c,!0))}).add([66,18,64,76],(t,c)=>{C(t,e.chRedir(12,c,!0))}).add([66,18,64,77],(t,c)=>{C(t,e.chRedir(13,c,!0))}).add([66,18,64,78],(t,c)=>{C(t,e.chRedir(14,c,!0))}).add([66,18,64,79],(t,c)=>{C(t,e.chRedir(15,c,!0))}),this.#I.add([54,65],(t,c)=>{let s=e.#s.x5===81?"05rw":"x5d";e.switchMode(s,!0),e.setPortMode(e.getTrackPort(c),1,E[s]);let r=t[t.length-1],i=t.subarray(0,t.length-1),o=H(i);o!==r&&(console.info(`X5D multi parameters checksum mismatch! Expected ${o}, got ${r}.`),console.debug(t));let n=(t[1]<<7)+t[0],f=(t[3]<<7)+t[2],d=e.chRedir(n&15,c,!0),g=T[d];[()=>{f<1||(f<101?(e.setChType(d,e.CH_MELODIC,E.x5d),e.#i[d]=f-1,e.#e[g+k[0]]=e.#s.x5):f<229?(e.setChType(d,e.CH_MELODIC,E.x5d),e.#i[d]=f-101,e.#e[g+k[0]]=56):(e.setChType(d,e.CH_DRUMS,E.x5d),e.#i[d]=Oe[f-229]||0,e.#e[g+k[0]]=62)),e.pushChPrimitives(d)},()=>{e.#e[g+k[7]]=f},()=>{f<31&&(e.#e[g+k[10]]=Math.round((f-15)*4.2+64))},()=>{e.#e[g+k[93]]=z(f)},()=>{e.#e[g+k[91]]=z(f)},()=>{e.#r[d*p.rpn+3]=f>8191?f-16320:64+f,e.#n[p.rpnt*d+2]=1,e.dispatchEvent("pitch",{part:d,pitch:e.getPitchShift(d)})},()=>{e.#r[d*p.rpn+1]=f>8191?f-16320:64+f,e.#n[p.rpnt*d+1]=1,e.dispatchEvent("pitch",{part:d,pitch:e.getPitchShift(d)})},()=>{f>0&&(e.#r[d*p.rpn]=f,e.#n[p.rpnt*d]=1,e.dispatchEvent("pitch",{part:d,pitch:e.getPitchShift(d)}))},()=>{}][n>>4]()}).add([54,76,0],(t,c)=>{e.invokeSysExIndicator();let s=e.#s.x5===81?"05rw":"x5d";e.switchMode(s),e.setPortMode(e.getTrackPort(c),1,E[s]);let r="",i=e.#s.x5,o=0,n=0,f="MSB	PRG	LSB	NME";D(t,function(d,g){if(g<16400){let y=g%164;switch(!0){case y<10:{d>31&&(r+=String.fromCharCode(d));break}case y===10:break;case y===11:{f+=`
${i}	${o}	${n}	${r.trim().replace("Init Voice","")}`,o++,r="";break}}o>99&&(i=90,o=0)}}),e.userBank.clearRange({msb:e.#s.x5,prg:[0,99],lsb:0}),e.userBank.load(f),S()&&console.debug(f),e.forceVoiceRefresh()}).add([54,77,0],(t,c)=>{e.invokeSysExIndicator();let s=e.#s.x5===81?"05rw":"x5d";e.switchMode(s),e.setPortMode(e.getTrackPort(c),1,E[s]);let r="",i=90,o=0,n=0,f="MSB	PRG	LSB	NME";D(t,function(d,g){if(g<13600){let y=g%136;switch(!0){case y<10:{d>31&&(r+=String.fromCharCode(d));break}case y===11:{f+=`
${i}	${o}	${n}	${r.trim().replace("Init Combi","")}`,o++,r="";break}}}}),e.userBank.clearRange({msb:90,prg:[0,99],lsb:0}),e.userBank.load(f),S()&&console.debug(f),e.forceVoiceRefresh()}).add([54,78],(t,c)=>{let s=e.#s.x5===81?"05rw":"x5d";e.switchMode(s),e.setPortMode(e.getTrackPort(c),1,E[s]),console.debug(`X5D mode switch requested: ${["combi","combi edit","prog","prog edit","multi","global"][t[0]]} mode.`)}).add([54,85],(t,c)=>{e.invokeSysExIndicator();let s=e.#s.x5===81?"05rw":"x5d";e.switchMode(s),e.setPortMode(e.getTrackPort(c),1,E[s]),D(t,(r,i)=>{i>0&&i<3&&(e.setEffectType(i-1,44,r),e.pushEffectType(i-1))})}).add([54,104],(t,c)=>{e.invokeSysExIndicator();let s=e.#s.x5===81?"05rw":"x5d";e.switchMode(s,!0);let r=e.getTrackPort(c);if(e.#f[r]&&e.#f[r]!==E[s])if(e.#L.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${c}. Port ${String.fromCharCode(65+r)} mode "${M[e.#f[r]]}" mismatch, should be "${s}".`);return}else console.info(`Track ${c} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+r)}.`);e.setPortMode(r,1,E[s]),D(t,function(i,o,n,f){if(o<192){let d=e.chRedir(Math.floor(o/12),c,!0),g=T[d];switch(o%12){case 0:{i<128?(e.setChType(d,e.CH_MELODIC,E.x5d),e.#e[g+k[0]]=e.#s.x5,e.#i[d]=i):(e.setChType(d,e.CH_DRUMS,E.x5d),e.#e[g+k[0]]=62,e.#i[d]=Oe[i-128]),i>0&&e.setChActive(d,1),e.pushChPrimitives(d);break}case 1:{e.#e[g+k[7]]=i;break}case 2:{e.#r[d*p.rpn+3]=i>127?i-192:64+i,e.#n[p.rpnt*d+2]=1,e.dispatchEvent("pitch",{part:d,pitch:e.getPitchShift(d)});break}case 3:{e.#r[d*p.rpn+1]=i>127?i-192:64+i,e.#n[p.rpnt*d+1]=1,e.dispatchEvent("pitch",{part:d,pitch:e.getPitchShift(d)});break}case 4:{i<31&&(e.#e[g+k[10]]=Math.round((i-15)*4.2+64));break}case 5:{let y=i>>4,w=i&15;e.#e[g+k[91]]=z(w),e.#e[g+k[93]]=z(y);break}case 10:{e.#a[d]||(e.#e[g+k[0]]=i>>6?56:e.#s.x5,e.pushChPrimitives(d));break}case 11:{let y=e.chRedir(i&15,c,!0),w=i>>4;e.#c[d]=i,(y!==d||w)&&console.info(`X5D Part CH${d+1} receives from CH${y+1}.`)}}}else{let d=e.chRedir(o-192,c,!0)}}),e.buildRchTree()}),this.#M.add([22,18,127],(t,c,s)=>{e.switchMode("mt32",!0),e.setPortMode(e.getTrackPort(c),1,E.mt32),e.#l=e.KARAOKE_NONE,e.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),console.info("MIDI reset: MT-32")}).add([22,18,0],(t,c,s)=>{e.switchMode("mt32");let r=e.chRedir(s,c,!0),i=t[1];t.subarray(2).forEach((o,n)=>{let f=n+i;e.#_[f+(r-1)*16]=o,([!1,()=>{let d=e.#_[r-1<<4];if(d<3){if(e.#T[r]=1,d===2)for(let g=0;g<name.length;g++)e.#O[(r-1)*p.cmt+g]=e.#G[o*p.cmt+g];else{let g=e.baseBank.get(0,o+(d<<6),127,"mt32").name;for(let y=0;y<g.length;y++)e.#O[(r-1)*p.cmt+y]=g.charCodeAt(y)}e.pushChPrimitives(r)}},()=>{e.#r[r*p.rpn+3]=o+40,e.#n[p.rpnt*r+2]=1},()=>{e.#r[r*p.rpn+1]=o+14,e.#n[p.rpnt*r+1]=1},()=>{e.#r[r*p.rpn]=o,e.#n[p.rpnt*r]=1},!1,()=>{e.setChCc(r,91,o?127:0)},!1,()=>{e.setChCc(r,7,o)},()=>{e.setChCc(r,10,Math.ceil(o*9.05))}][f]||(()=>{}))()})}).add([22,18,1],(t,c,s)=>{e.switchMode("mt32");let r=s&7;console.debug(`MT-32 slot #${s+1} Drum: ${t}`);let i=t[0]<<7|t[1];t.subarray(2).forEach((o,n)=>{let f=n+i,d=(f>>2)+24,g=f&3,y=r*p.dpn;if(S()&&console.debug(`MT-32 temp drum note ${d} param ${g}: ${o}`),d<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${d}`);return}[()=>{},()=>{e.#w[(y+U[26])*p.dnc+d]=Math.round(o*1.27)},()=>{e.#w[(y+U[26])*p.dnc+d]=o*9+1&127},()=>{e.#w[(y+U[26])*p.dnc+d]=o?127:0}][g]()})}).add([22,18,2],(t,c,s)=>{e.switchMode("mt32");let r=e.chRedir(s,c,!0),i=t[1]+(t[0]<<7);i<10&&(e.#T[r]=1),t.subarray(2).forEach((o,n)=>{let f=n+i;f<14&&(e.#O[(r-1)*p.cmt+f]=o)}),e.pushChPrimitives(r)}).add([22,18,3],(t,c,s)=>{e.switchMode("mt32");let r=s&7;if(t[0]){let i=(t[0]-1<<7)+t[1]-16;t.subarray(2).forEach((o,n)=>{let f=n+i,d=(f>>2)+24,g=f&3,y=r*p.dpn;if(S()&&console.debug(`MT-32 dev drum note ${d} param ${g}: ${o}`),d<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${d}`);return}[()=>{},()=>{e.#w[(y+U[26])*p.dnc+d]=Math.round(o*1.27)},()=>{e.#w[(y+U[26])*p.dnc+d]=o*9+1&127},()=>{e.#w[(y+U[26])*p.dnc+d]=o?127:0}][g]()})}else{let i=t[1];t.subarray(2).forEach((o,n)=>{let f=n+i;e.#_[f]=o;let d=e.chRedir(1+(f>>4),c,!0),g=f&15;([!1,()=>{let y=e.#_[d-1<<4];if(y<3)if(e.#T[d]=1,y===2)for(let w=0;w<name.length;w++)e.#O[(d-1)*p.cmt+w]=e.#G[o*p.cmt+w];else{let w=e.baseBank.get(0,o+(y<<6),127,"mt32").name;for(let x=0;x<w.length;x++)e.#O[(d-1)*p.cmt+x]=w.charCodeAt(x)}e.pushChPrimitives(d)},()=>{e.#r[d*p.rpn+3]=o+40,e.#n[p.rpnt*d+2]=1},()=>{e.#r[d*p.rpn+1]=o+14,e.#n[p.rpnt*d+1]=1},()=>{e.#r[d*p.rpn]=o,e.#n[p.rpnt*d]=1},!1,()=>{e.setChCc(d,91,o?127:0)},!1,()=>{e.setChCc(d,7,o)},()=>{e.setChCc(d,10,Math.ceil(o*9.05))}][g]||(()=>{}))()})}}).add([22,18,4],(t,c,s)=>{e.switchMode("mt32");let r=t[1]+(t[0]<<7),i=[];t.subarray(2).forEach((o,n)=>{let f=n+r,d=e.chRedir(Math.floor(f/246+1),c,!0),g=f%246;g<14&&(e.#O[(d-1)*p.cmt+g]=o),g<10&&(e.#T[d]=1),i.indexOf(d)<0&&i.push(d)}),i.forEach(o=>{e.pushChPrimitives(o)})}).add([22,18,5],(t,c,s)=>{e.switchMode("mt32");let r=(t[0]<<7)+t[1];t.subarray(2).forEach((i,o)=>{let n=r+o,f=Math.floor(n/8),d=n&7,g=f*8;e.#ce[n]=i,([!1,()=>{let y=e.#ce[g];if(y<3){let w="";if(y===2){let P=p.cmt*f;w=`MT-m:${i.toString().padStart(3,"0")}`}else w=e.baseBank.get(0,i+(y<<6),127,"mt32").name;e.userBank.clearRange({msb:0,lsb:127,prg:f});let x=`MSB	LSB	PRG	NME
49	127	${f}	${w}`;e.userBank.load(x,!0)}}][d]||(()=>{}))()}),e.forceVoiceRefresh()}).add([22,18,8],(t,c,s)=>{e.switchMode("mt32");let r=((t[0]&1)<<7)+t[1],i=t[0]>>1,o=!1;if(t.subarray(2).forEach((n,f)=>{let d=r+f;d<p.cmt&&(e.#G[i*p.cmt+d]=n,o=!0)}),o){e.userBank.clearRange({msb:0,lsb:127,prg:i});let n=`MSB	LSB	PRG	NME
49	127	${i}	MT-m:${i}`;e.userBank.load(n,!0)}e.forceVoiceRefresh()}).add([22,18,16],(t,c,s)=>{e.switchMode("mt32");let r=t[1],i=!1,o=function(n,f){e.#c[f-12]=n,i=!0};t.subarray(2).forEach((n,f)=>{let d=f+r;([!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,o,o,o,o,o,o,o,o,o,()=>{e.#d=n,e.dispatchEvent("mastervolume",e.#d)}][d]||(()=>{}))(n,f)}),i&&e.buildRchTree()}).add([22,18,32],(t,c,s)=>{e.switchMode("mt32");let r=t[1],i=" ".repeat(r);t.subarray(2).forEach(o=>{o>31?i+=String.fromCharCode(o):i+=" "}),e.#X=i.padStart(20," "),e.#K=Date.now()+3200}).add([22,18,82],(t,c)=>{let s=e.chRedir(0,c,!0);for(let r=0;r<16;r++)e.#y.ano(s+r),r&&r<10&&(e.#i[s+r]=ne[r-1]);console.info("MT-32 alt reset complete.")}),this.#I.add([66,0],(t,c)=>{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(c),2,E.ns5r),e.#l=e.KARAOKE_NONE,console.debug(`NS5R mode switch requested: ${["global","multi","prog edit","comb edit","drum edit","effect edit"][t[0]]} mode.`)}).add([66,1],(t,c)=>{let s=["ns5r","05rw"][t[0]];e.switchMode(s,!0),e.setPortMode(e.getTrackPort(c),2,E[s]),e.#l=e.KARAOKE_NONE}).add([66,18,0,0],(t,c)=>{let s=t[0];switch(s){case 124:case 126:case 127:{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(c),2,E.ns5r),e.#l=e.KARAOKE_NONE;break}case 125:{e.initDrums(),console.info(`NS5R drum setup reset on drum kit ${t[1]}.`);break}default:if(s<10){let r=[0,0,0,0],i=(o,n)=>{r[n]=o};if(t.subarray(1).forEach((o,n)=>{[i,i,i,i,()=>{e.#d=o*129/16383*100,e.dispatchEvent("mastervolume",e.#d)},()=>o-64,()=>o-64,()=>{},()=>{},()=>{}][s+n]()}),t[0]<4){let o=0;r.forEach(n=>{o=o<<4,o+=n}),o-=1024,console.debug(`Master tune: ${o}`)}}}}).add([66,18,0,1],(t,c)=>{}).add([66,18,0,2],(t,c)=>{}).add([66,18,1],(t,c)=>{e.invokeSysExIndicator();let s=e.chRedir(t[0],c,!0),r=T[s],i=t[1],o=`NS5R CH${s+1} `;t.subarray(2).forEach((n,f)=>{let d=i+f;d<3?([()=>{e.#e[r+k[0]]=n||q.bank0,e.pushChPrimitives(s)},()=>{e.#e[r+k[32]]=n,e.pushChPrimitives(s)},()=>{e.#i[s]=n}][d](),e.pushChPrimitives(s)):d<8||(d<14?[()=>{let g=e.chRedir(n,c,!0),y=e.#c[s];e.#c[s]=g,(s!==g||g!==y)&&(e.buildRchTree(),console.info(`${o}receives from CH${g+1}`))},()=>{e.#k[s]=+!n},()=>{e.setChType(s,n,E.ns5r),console.debug(`${o}type: ${Y[n]}`)},()=>{e.#r[p.rpn*s+3]=n,e.#n[p.rpnt*s+2]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},()=>{},()=>{}][d-8]():d<16||(d<33?[()=>{e.#e[r+k[7]]=n},()=>{e.#e[r+k[11]]=n},()=>{},()=>{},()=>{e.#e[r+k[10]]=n||128},()=>{},()=>{},()=>{e.#e[r+k[93]]=n},()=>{e.#e[r+k[91]]=n},()=>{e.#e[r+k[76]]=n},()=>{e.#e[r+k[77]]=n},()=>{e.#e[r+k[78]]=n},()=>{e.#e[r+k[74]]=n},()=>{e.#e[r+k[71]]=n},()=>{e.#e[r+k[73]]=n},()=>{e.#e[r+k[75]]=n},()=>{e.#e[r+k[72]]=n}][d-16]():d<112||d<114&&[()=>{e.#e[r+k[5]]=n},()=>{e.#e[r+k[65]]=n}][d-112]()))})}).add([66,18,8,0],(t,c)=>{let s=t[0];if(s<32)e.setLetterDisplay(t.subarray(1,33),"NS5R letter display");else{let r=s-32;e.#P=Date.now()+3200,e.#E=10;let i=t.subarray(1),o=4;i.forEach(function(n,f){let d=f+r,g=d>>4,y=d&15;if(d<80){let w=g<o?n:n>>3,x=0,P=g<o?6:3;for(;w>0;)e.#N[y*32+g*7+(P-x)]=w&1,w=w>>1,x++}})}}).add([66,18,48],(t,c,s)=>{u(0,t)}).add([66,18,49],(t,c,s)=>{u(1,t)}).add([66,18,50],(t,c,s)=>{u(2,t)}).add([66,18,51],(t,c,s)=>{u(3,t)}).add([66,18,52],(t,c,s)=>{u(4,t)}).add([66,18,53],(t,c,s)=>{u(5,t)}).add([66,18,54],(t,c,s)=>{u(6,t)}).add([66,18,55],(t,c,s)=>{u(7,t)}).add([66,52],(t,c)=>{e.switchMode("ns5r"),e.#l=e.KARAOKE_NONE;let s="";D(t,(r,i)=>{i<8?(r>31&&(s+=String.fromCharCode(r)),i===7&&(e.aiEfxName=s)):i<10&&(e.setEffectType(i-8,44,r),e.pushEffectType(i-8))})}).add([66,53],(t,c)=>{e.invokeSysExIndicator(),e.switchMode("ns5r"),e.#l=e.KARAOKE_NONE;let s="",r=t[t.length-1],i=t.subarray(0,t.length-1),o=H(i);o!==r&&(console.info(`NS5R current multi dump checksum mismatch! Expected ${o}, got ${r}.`),console.debug(t));let n=e.getTrackPort(c);if(e.#f[n]&&e.#f[n]!==E.ns5r)if(e.#L.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${c}. Port ${String.fromCharCode(65+n)} mode "${M[e.#f[n]]}" mismatch, should be "ns5r".`);return}else console.info(`Track ${c} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+n)}.`);e.setPortMode(n,2,E.ns5r),D(i,function(f,d){switch(!0){case d<2944:{let g=e.chRedir(Math.floor(d/92),c,!0),y=T[g];switch(d%92){case 0:{e.#e[y+k[0]]=f,e.pushChPrimitives(g),e.pushChPrimitives(g);break}case 1:{e.#e[y+k[32]]=f,!f&&!e.#e[y+k[0]]&&(e.#e[y+k[0]]=q.bank0),e.pushChPrimitives(g);break}case 2:{e.#i[g]=f,f>0&&e.setChActive(g,1);break}case 3:{let w=e.chRedir(f,c,!0);e.#c[g]=w,g!==w&&console.info(`NS5R CH${g+1} receives from CH${w+1}.`);break}case 7:{e.#a[g]=f,e.pushChPrimitives(g);break}case 8:{e.#r[g*p.rpn+3]=f<40||f>88?f+(f>63?-192:64):f,e.#n[p.rpnt*g+2]=1,e.dispatchEvent("pitch",{part:g,pitch:e.getPitchShift(g)});break}case 9:case 10:{e.#e[y+k[7]]=f;break}case 11:{e.#e[y+k[11]]=f;break}case 14:{e.#e[y+k[10]]=f||128;break}case 19:{e.#e[y+k[93]]=f;break}case 20:{e.#e[y+k[91]]=f;break}case 84:{e.#e[y+k[65]]=f;break}case 85:{e.#e[y+k[5]]=f;break}}break}case d<3096:break;case d<3134:{let g=d-3096;g<8?(f>31&&(s+=String.fromCharCode(f)),g===7&&(e.aiEfxName=s)):g<10&&(e.setEffectType(g-8,44,f),e.pushEffectType(g-8));break}case d<8566:break}}),e.buildRchTree()}).add([66,54],(t,c)=>{e.invokeSysExIndicator(),e.switchMode("ns5r");let s="",r=80,i=0,o=0,n="MSB	PRG	LSB	NME";D(t,function(f,d){let g=d%158;switch(!0){case g<10:{f>31&&(s+=String.fromCharCode(f));break}case g===10:break;case g===11:{r=f&127;break}case g===12:{o=f&127;break}case g===13:{n+=`
${r}	${i}	${o}	${s.trim().replace("Init Voice","")}`,i++,s="";break}}}),e.userBank.clearRange({msb:80,lsb:0}),e.userBank.load(n),S()&&console.debug(n),e.forceVoiceRefresh()}).add([66,55],(t,c)=>{e.invokeSysExIndicator(),e.switchMode("ns5r");let s="",r=88,i=0,o=0,n="MSB	PRG	LSB	NME";D(t,function(f,d){let g=d%126;switch(!0){case g<10:{f>31&&(s+=String.fromCharCode(f));break}case g===11:break;case g===12:break;case g===13:{n+=`
${r}	${i}	${o}	${s.trim().replace("Init Combi","")}`,i++,s="";break}}}),e.userBank.clearRange({msb:88,lsb:0}),e.userBank.load(n),S()&&console.debug(n),e.forceVoiceRefresh()}).add([66,125],(t,c,s)=>{e.dispatchEvent("backlight",["green","orange","red",!1,"yellow","blue","purple"][t[0]]||"white")}).add([66,127],(t,c,s)=>{let r=t[t.length-1],i=t.subarray(0,t.length-1),o=H(i);o!==r&&(console.info(`NS5R screen dump checksum mismatch! Expected ${o}, got ${r}.`),console.debug(t));let n=new Uint8Array(5760);D(t,(f,d,g)=>{if(d<720)for(let y=0;y<8;y++)n[d*8+y]=f>>7-y&1}),e.dispatchEvent("screen",{type:"ns5r",data:n})}).add([76],(t,c,s)=>{e.#I.run([66,...t],c,s)}),e.#te.add([16,0,8,0],(t,c,s)=>{let r=(t[2]<<4)+t[3],i="K11 ";([()=>{e.switchMode("k11",!0),e.setPortMode(e.getTrackPort(c),2,E.k11),e.#l=e.KARAOKE_NONE,e.#p[E.k11][1]=r?4:0,console.info("MIDI reset: GMega/K11")},()=>{e.setEffectType(0,24,r),console.debug(`${i}reverb type: ${r}`),e.pushEffectType(0)},()=>{console.debug(`${i}reverb time: ${r}`)},()=>{console.debug(`${i}reverb time: ${r}`)},()=>{console.debug(`${i}reverb predelay: ${r}`)},()=>{console.debug(`${i}reverb predelay: ${r}`)},()=>{console.debug(`${i}depth high: ${r}`)},()=>{console.debug(`${i}depth high: ${r}`)},()=>{console.debug(`${i}depth low: ${r}`)},()=>{console.debug(`${i}depth low: ${r}`)}][t[0]]||(()=>{}))()}).add([16,0,8,1],(t,c,s)=>{e.invokeSysExIndicator();let r=e.chRedir(t[1],c,!0),i=T[r],o=G[r],n=(t[3]<<4)+t[4],f=`GMega CH${r+1} `;([()=>{n<128?(e.setChType(r,e.CH_MELODIC,E.k11),e.#e[i+k[0]]=0,e.#i[r]=n):(e.setChType(r,e.CH_DRUMS,E.k11),e.#i[r]=n-128),e.pushChPrimitives(r)},()=>{let d=e.chRedir(n,c,!0),g=e.#c[r];e.#c[r]=d,(r!==d||d!==g)&&(e.buildRchTree(),console.info(`${f}receives from CH${d+1}`))},()=>{e.#e[i+k[7]]=n},()=>{uupThis.setChActive(r,n)},()=>{e.#e[i+k[10]]=n},()=>{e.#r[o+3]=n+40,e.#n[p.rpnt*r+2]=1,e.dispatchEvent("pitch",{part:r,pitch:e.getPitchShift(r)})},()=>{e.#r[o+1]=n>>1,e.#r[o+2]=n&1,e.#n[p.rpnt*r+1]=1,e.dispatchEvent("pitch",{part:r,pitch:e.getPitchShift(r)})},()=>{e.#e[i+k[91]]=n?127:0},()=>{},()=>{e.#e[i+k[74]]=n},()=>{e.#e[i+k[73]]=n},()=>{e.#e[i+k[72]]=n}][t[0]]||(()=>{}))()}).add([16,0,9,0],(t,c,s)=>{e.invokeSysExIndicator();let r=(t[2]<<4)+t[3],i="GMLX ";([()=>{console.debug(`${i}reverb type: ${r}`)},()=>{console.debug(`${i}reverb time: ${r}`)},()=>{console.debug(`${i}reverb predelay: ${r}`)},()=>{console.debug(`${i}depth high: ${r}`)},()=>{console.debug(`${i}depth low: ${r}`)}][t[0]]||(()=>{}))()}).add([16,0,9,3],(t,c,s)=>{e.invokeSysExIndicator();let r=(t[2]<<4)+t[3],i=e.chRedir(t[1],c,!0),o=T[i],n=`GMLX CH${i+1} `;[()=>{r<128?(e.setChType(i,e.CH_MELODIC,E.k11),e.#e[o+k[0]]=0,e.#e[o+k[32]]=0,e.#i[i]=r):r<160?(e.setChType(i,e.CH_MELODIC,E.k11),e.#e[o+k[0]]=0,e.#e[o+k[32]]=7,e.#i[i]=r-100):(e.setChType(i,e.CH_DRUMS,E.k11),e.#e[o+k[0]]=122,e.#e[o+k[32]]=0,e.#i[i]=r-160),e.pushChPrimitives(i)},()=>{let f=e.chRedir(r,c,!0),d=e.#c[i];e.#c[i]=f,(i!==f||f!==d)&&(e.buildRchTree(),console.info(`${n}receives from CH${f+1}`))}][t[0]]()}).add([16,0,9,4],(t,c,s)=>{e.invokeSysExIndicator();let r=(t[2]<<4)+t[3],i=e.chRedir(t[1],c,!0),o=T[i],n=G[i];[()=>{e.setChActive(i,r)},()=>{e.#e[o+k[7]]=r},()=>{e.#e[o+k[10]]=r},()=>{e.#e[o+k[91]]=r?127:0},()=>{e.#r[n+3]=r+40,e.#n[p.rpnt*i+2]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{e.#r[n+1]=r,e.#n[p.rpnt*i+1]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{e.#r[n]=r,e.#n[p.rpnt*i]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{}][t[0]]()}),this.#ae.add([66,93,64],(t,c,s)=>{let r=t[2];switch(t[0]){case 0:{switch(t[1]){case 4:{e.invokeSysExIndicator(),e.#d=r*129/16383*100,e.dispatchEvent("mastervolume",e.#d);break}case 5:{e.invokeSysExIndicator(),r-64;break}case 6:{e.invokeSysExIndicator(),console.debug(`SG global reverb: ${r?"on":"off"}`);break}case 127:{e.switchMode("sg",!0),e.setPortMode(e.getTrackPort(c),1,E.sg);break}}break}case 1:{switch(t[1]){case 48:{e.invokeSysExIndicator(),console.debug(`SG reverb type: ${se[r]}`);break}}break}default:if(t[0]>>4===1){e.invokeSysExIndicator();let i=e.chRedir(t[0]&15,c,!0);if(t[1]===2){let o=e.chRedir(r,c,!0),n=e.#c[i];e.#c[i]=o,(i!==o||o!==n)&&(e.buildRchTree(),console.info(`SG CH${i+1} receives from CH${o+1}`))}else t[1]===19&&e.setChCc(i,7,r)}else console.warn(`Unknown AKAI SG SysEx: ${t}`)}}),this.#re.add([9],(t,c,s)=>{e.invokeSysExIndicator(),console.debug(`GZ set effect: ${["stage reverb","hall reverb","room reverb","chorus","tremolo","phaser","rotary speaker","enhancer","flanger","EQ"][t[0]]||"off"}`)}),this.#g.add([127,0],(t,c,s)=>{e.switchMode("motif");let r=new Uint8Array([127,1,...t]);e.#g.run(r,c,s)}).add([127,1,0,0],(t,c,s)=>{e.switchMode("s90es");let r="S90/Motif ES system ",i=t[0];t.subarray(1).forEach((o,n)=>{([()=>{e.#d=o*12900/16383,e.dispatchEvent("mastervolume",e.#d)}][i+n]||(()=>{console.info(`Unrecognized ${r}ID: ${i+n}`)}))()})}).add([127,1,14],(t,c,s)=>{e.switchMode("s90es");let r="S90/Motif ES bulk header ",i=[];i[95]=(o,n,f)=>{console.debug(`${r}multi edit buffer: ${o[1]}`)},(i[t[0]]||(()=>{console.info(`Unrecognized ${r}ID: ${t[0]}.`)}))(t.subarray(1))}).add([127,1,15],(t,c,s)=>{e.switchMode("s90es");let r="S90/Motif ES bulk footer ",i=[];i[95]=(o,n,f)=>{console.debug(`${r}multi edit buffer: ${o[1]}`)},(i[t[0]]||(()=>{console.info(`Unrecognized ${r}ID: ${t[0]}.`)}))(t.subarray(1))}).add([127,1,54,1],(t,c,s)=>{e.switchMode("s90es");let r="S90/Motif ES reverb ",i=t[0];t.subarray(1).forEach((o,n)=>{([()=>{e.setEffectTypeRaw(0,!1,o&15|128)},()=>{e.setEffectTypeRaw(0,!0,o)}][i+n]||(()=>{}))()}),e.pushEffectType(0)}).add([127,1,54,2],(t,c,s)=>{e.switchMode("s90es");let r="S90/Motif ES chorus ",i=t[0];t.subarray(1).forEach((o,n)=>{([()=>{e.setEffectTypeRaw(1,!1,o&15|128)},()=>{e.setEffectTypeRaw(1,!0,o)}][i+n]||(()=>{}))()}),e.pushEffectType(1)}).add([127,1,54,3],(t,c,s)=>{e.switchMode("s90es");let r="S90/Motif ES insert 1 ",i=t[0];t.subarray(1).forEach((o,n)=>{([()=>{e.setEffectTypeRaw(3,!1,o&15|128)},()=>{e.setEffectTypeRaw(3,!0,o)}][i+n]||(()=>{}))()}),e.pushEffectType(3)}).add([127,1,54,4],(t,c,s)=>{e.switchMode("s90es");let r="S90/Motif ES insert 2 ",i=t[0];t.subarray(1).forEach((o,n)=>{([()=>{e.setEffectTypeRaw(4,!1,o&15|128)},()=>{e.setEffectTypeRaw(4,!0,o)}][i+n]||(()=>{}))()}),e.pushEffectType(4)}).add([127,1,54,16],(t,c,s)=>{e.switchMode("s90es");let r=t[0];t.subarray(1).forEach((i,o)=>{let f=`S90/Motif ES EQ${(o>>2)+1} `;([()=>{let d=i-64},()=>{let d=_[i]},()=>{let d=i/10},()=>{let d=i}][r+o&3]||(()=>{}))()})}).add([127,1,54,17],(t,c,s)=>{e.switchMode("s90es");let r="S90/Motif ES variation ",i=t[0];t.subarray(1).forEach((o,n)=>{([()=>{e.setEffectTypeRaw(2,!1,o&15|128)},()=>{e.setEffectTypeRaw(2,!0,o)}][i+n]||(()=>{}))()}),e.pushEffectType(2)}).add([127,1,55],(t,c,s)=>{e.invokeSysExIndicator(),e.switchMode("s90es");let r=e.getTrackPort(c);if(e.#f[r]&&e.#f[r]!==e.#s.smotif)if(e.#L.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${c}. Port ${String.fromCharCode(65+r)} mode "${M[e.#f[r]]}" mismatch, should be "${M[e.#s.smotif]}".`);return}else console.info(`Track ${c} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+r)}.`);let i=e.chRedir(t[0],c,!0),o=T[i],n=t[1];t[0]>15&&(i=t[0]+32);let f=`Track ${c} S90/Motif ES bulk CH${i<128?i+1:"U"+(i-127)} `;console.debug(f,t),!(t[0]>15)&&t.subarray(2).forEach((d,g)=>{([()=>{e.setChCc(i,0,d),e.pushChPrimitives(i)},()=>{d&&e.setChActive(i,1),e.setChCc(i,32,d),e.getChPrimitive(i,1)===63&&e.setChType(i,[32,40].indexOf(d)>-1?e.CH_DRUMS:e.CH_MELODIC,e.#t,!0),e.pushChPrimitives(i)},()=>{d&&e.setChActive(i,1),e.#i[i]=d,e.pushChPrimitives(i)},()=>{let y=e.chRedir(d,c,!0),w=e.#c[i];e.#c[i]=y,(i!==y||y!==w)&&(e.buildRchTree(),console.info(`${f}receives from CH${y+1}`))},()=>{e.#k[i]=d?0:1},!1,!1,!1,!1,!1,!1,!1,!1,()=>{d!==100&&e.setChActive(i,1),e.#e[o+k[7]]=d},()=>{d!==64&&e.setChActive(i,1),e.#e[o+k[10]]=d},!1,!1,!1,()=>{e.#e[o+k[91]]=d},()=>{d&&e.setChActive(i,1),e.#e[o+k[93]]=d},()=>{d&&e.setChActive(i,1),e.#e[o+k[94]]=d},()=>{e.setChCc(i,128,d),d!==127&&(e.setChActive(i,1),e.allocateAce(i,128))},()=>{},()=>{d!==64&&e.setChActive(i,1),e.#e[o+k[74]]=d},()=>{d!==64&&e.setChActive(i,1),e.#e[o+k[71]]=d},!1,()=>{e.#e[o+k[65]]=d},()=>{e.#e[o+k[5]]=d},()=>{}][n+g]||(()=>{}))()})}),e.#g.add([100,14],(t,c,s)=>{e.switchMode("cs6x"),e.setPortMode(e.getTrackPort(c),1,E.cs6x);let r=["normal voice","plugin voice PLG","drums",,"performance",,"phrase clip"][t[0]>>4]??"invalid";t[0]&!0?r+=" edit buffer":t[0]>>4==1?r+=`${(t[0]&1)+1}`:r+=` ${["INT","EXT"][t[0]&1]}`,console.debug(`CS6x bulk dump for ${r} started.`)}).add([100,15],(t,c,s)=>{e.switchMode("cs6x");let r=["normal voice","plugin voice PLG","drums",,"performance",,"phrase clip"][t[0]>>4]??"invalid";t[0]&!0?r+=" edit buffer":t[0]>>4==1?r+=`${(t[0]&1)+1}`:r+=` ${["INT","EXT"][t[0]&1]}`,console.debug(`CS6x bulk dump for ${r} ended.`)}).add([100,76,112],(t,c,s)=>{e.switchMode("cs6x");let r=0,i=t[0];t.subarray(1).forEach((o,n)=>{let f=n+i;f<10?(e.setChCvnRegister(r,n,o&127),e.#T[r]=1):f<12||f<13&&console.debug(`Plugin voice type: ${o}`)}),e.pushChPrimitives(r)}).add([100,76,0],(t,c,s)=>{e.switchMode("cs6x"),e.setPortMode(e.getTrackPort(c),1,E.cs6x);let r=0,i=t[0];t.subarray(1).forEach((o,n)=>{let f=n+i;([()=>{e.setChCc(r,7,o),o!==100&&e.setChActive(r,1)},,,()=>{e.#k[r]=o==0,e.setChCc(r,64,0),e.#y.ano(r),e.resetChAceAll(r)},,()=>{},,,()=>{e.setChCc(r,65,o?127:0)},()=>{e.setChCc(r,5,o)},,()=>{e.setChCc(r,91,o),o!==40&&e.setChActive(r,1)},()=>{e.setChCc(r,93,o),o&&e.setChActive(r,1)}][f]||(()=>{}))()})}).add([100,76,1],(t,c,s)=>{e.switchMode("cs6x");let r=0,i=t[0],o=!1;t.subarray(1).forEach((n,f)=>{let d=f+i;([()=>{e.setEffectTypeRaw(0,!1,n&15|128),o=!0},()=>{e.setEffectTypeRaw(0,!0,n),o=!0}][d]||(()=>{}))()}),o&&e.pushEffectType(0)}).add([100,76,2],(t,c,s)=>{e.switchMode("cs6x");let r=0,i=t[0],o=!1;t.subarray(1).forEach((n,f)=>{let d=f+i;([()=>{e.setEffectTypeRaw(1,!1,n&15|128),o=!0},()=>{e.setEffectTypeRaw(1,!0,n),o=!0}][d]||(()=>{}))()}),o&&e.pushEffectType(1)}).add([100,76,3],(t,c,s)=>{e.switchMode("cs6x");let r=0,i=t[0],o=!1;t.subarray(1).forEach((n,f)=>{let d=f+i;([()=>{e.setEffectTypeRaw(2,!1,n&15|128),o=!0},()=>{e.setEffectTypeRaw(2,!0,n),o=!0}][d]||(()=>{}))()}),o&&e.pushEffectType(2)}).add([100,76,5],(t,c,s)=>{e.switchMode("cs6x")}).add([100,76,16],(t,c,s)=>{e.switchMode("cs6x");let r=0,i=t[0],o=!1;if(t.subarray(1).forEach((n,f)=>{let d=f+i;([()=>{e.setChCc(r,0,n),o=!0},()=>{e.setChCc(r,32,n),o=!0,n&&e.setChActive(r,1)},()=>{e.#i[r]=n,o=!0,n&&e.setChActive(r,1)},()=>{e.#n[G[r]+j[2]]=1,e.#r[G[r]+j[2]]=n,n&&e.setChActive(r,1)}][d]||(()=>{}))()}),o){switch(e.pushChPrimitives(r),e.getChVoice(r).standard){case"DX":{e.#m[r]=e.EXT_DX;break}case"VL":{e.#m[r]=e.EXT_VL;break}}e.dispatchEvent("metacommit",{type:"OSysMeta",msg:"part.rename",data:{part:r}})}}).add([100,76,32],(t,c,s)=>{e.switchMode("cs6x");let r=0,i=t[0],o=e.#m[r];switch(o){case e.EXT_DX:{t.length>2&&console.debug(t),t.subarray(1).forEach((n,f)=>{let d=f+i;if(d<6){let g=d+142;e.setChCc(r,g,n),n!==64&&e.allocateAce(r,g)}else if(d<12){let g=d+144;e.setChCc(r,g,n),n!==64&&e.allocateAce(r,g)}else([()=>{},()=>{},()=>{},()=>{}][d]||(()=>{}))()});break}case e.EXT_VL:{console.info(`Support for Modular System Plug-in writes is not yet present for plugin type ${o}.`);break}default:console.warn(`Unsupported plug-in type: ${o}`)}}),this.#M.add([0,72,18,0,0,0,0],(t,c,s)=>{e.switchMode("sd",!0),e.setPortMode(e.getTrackPort(c),2,E.sd),console.info("MIDI reset: SD")}).add([0,72,18,16,0],(t,c,s)=>{e.invokeSysExIndicator();let r=t[0]>>5,i=t[0]&31;switch(r){case 0:{let o=t[0]>>1,n=t[1];switch(o){case 1:{t.subarray(2).forEach((f,d,g)=>{let y=d+n;switch(y){case 0:{f&&(e.setEffectType(1,60,f-1),e.pushEffectType(1),console.debug(`SD MFX Cho: ${y} - ${f}`));break}}});break}case 2:{t.subarray(2).forEach((f,d)=>{let g=d+n;switch(g){case 0:{f&&(e.setEffectType(0,55+f,0),e.pushEffectType(0),console.debug(`SD MFX Rev: ${g} - ${f}`));break}}});break}case 3:case 4:case 5:{let f=o-1;t.subarray(2).forEach((d,g)=>{let y=g+n;switch(console.debug(`SD MFX ${f-2}: ${y} - ${d}`),y){case 0:{e.setEffectTypeRaw(f,62,d),e.pushEffectType(f);break}}}),console.debug(`SD MFX message:
%o`,t);break}default:console.debug(`Unknown SD-90 global effects message:
%o`,t)}break}case 1:{let o=e.chRedir(i,c,!0),n=t[1],f=T[o];t.subarray(2).forEach((d,g)=>{let y=n+g;y<37?([()=>{},()=>{},0,()=>{},()=>{switch(d){case 104:case 105:case 106:case 107:case 120:case 128:{e.#a[o]||e.setChType(o,e.CH_DRUMS);break}default:e.#a[o]&&e.setChType(o,e.CH_MELODIC)}e.setChCc(o,0,d),e.pushChPrimitives(o)},()=>{e.#e[f+k[32]]=d,e.pushChPrimitives(o)},()=>{e.#i[o]=d},()=>{e.#e[f+k[7]]=d},()=>{e.#e[f+k[10]]=d},()=>{},()=>{},()=>{d<2&&(e.#k[o]=d)},()=>{d<2&&(e.#e[f+k[68]]=d?127:0)},()=>{},()=>{d<2&&(e.#e[f+k[65]]=d?127:0)},()=>{e.#e[f+k[5]]=d&15<<4|e.#e[f+k[5]]&15},()=>{e.#e[f+k[5]]=d&15|(e.#e[f+k[5]]&240)>>4},()=>{e.#e[f+k[74]]=d},()=>{e.#e[f+k[71]]=d},()=>{e.#e[f+k[73]]=d},()=>{e.#e[f+k[72]]=d},0,0,0,0,0,0,0,()=>{e.#e[f+k[128]]=d,e.allocateAce(128)},()=>{e.#e[f+k[93]]=d},()=>{e.#e[f+k[91]]=d},0,0,()=>{e.#e[f+k[75]]=d},()=>{e.#e[f+k[76]]=d},()=>{e.#e[f+k[77]]=d},()=>{e.#e[f+k[78]]=d}][y]||(()=>{}))():y<63||(y<64?(e.#a[o]?(e.#e[f+k[0]]=104|d,e.pushChPrimitives(o)):(e.#e[f+k[0]]=96|d,e.pushChPrimitives(o)),e.pushChPrimitives(o)):console.debug(`Unknown SD-90 global CH${o+1} param setup message:
%o`,t))});break}case 2:{let o=e.chRedir(i,c,!0),n=t[1];console.debug(`Unknown SD-90 global CH${o+1} MIDI setup message:
%o`,t.subarray(2));break}default:console.warn(`Unknown SD-90 global part setup message:
%o`,t)}}),e.#I.add([0,1,73,78],(t,c,s)=>{e.switchMode("krs"),e.setPortMode(e.getTrackPort(c),1,E.krs),console.debug("Might be KORG KROSS 2 mode reset... Not sure.")}).add([0,1,73,117,2,37],(t,c,s)=>{e.switchMode("krs");let r=e.getTrackPort(c);if(e.#f[r]&&e.#f[r]!==E.krs)if(e.#L.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled. Port ${String.fromCharCode(65+r)} mode "${M[e.#f[r]]}" mismatch, should be "krs".`);return}else console.info(`Track ${c} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+r)}.`);e.setPortMode(e.getTrackPort(c),1,E.krs);let i="KROSS 2 BMT1 ",o="";D(t,(n,f)=>{if(f<24)o+=String.fromCharCode(Math.max(32,n));else if(!(f<88)){if(f<468){let d=f-88,g=d*863>>16,y=d-g*76;([()=>{e.setEffectType(g+3,45,n),e.pushEffectType(g+3)},!1,()=>{console.debug(`${i}IFX${g+1} sends to ${n<=5&&n>0?`IFX${n}`:"direct out"}.`)}][y]||(()=>{}))()}else if(f<604){let d=f-468,g=d*964>>16,y=d-g*68;([()=>{e.setEffectType(1-g,45,n),e.dispatchEvent(["efxreverb","efxchorus"][1-g],{id:e.getEffectType(1-g)})},!1][y]||(()=>{}))()}else if(!(f<1276)){let d=f-1276,g=d*1490>>16,y=e.chRedir(g,c,!0),w=d-g*44;w<22?([()=>{n&&e.setChActive(y,1),e.#i[y]=n,e.pushChPrimitives(y)},()=>{n&&e.setChActive(y,1),n<10?(e.setChCc(y,0,63),e.setChCc(y,32,n)):n<20?(e.setChCc(y,0,121),e.setChCc(y,32,n-10)):n<24&&(e.setChCc(y,0,[120,0,56,62][n-20]),e.setChCc(y,32,0)),e.pushChPrimitives(y)},()=>{let x=e.chRedir(n&15,c,!0);e.#c[y]=x,x!==y&&console.info(`${i}CH${y+1} receives from CH${x+1}`);let P=n>>5&1;e.modelEx.kross.chToggle&&(e.setChActive(y,P),P||console.debug(`KORG KROSS 2 CH${y+1} is disabled.`))},!1,!1,()=>{e.setChCc(y,7,n)},!1,()=>{},()=>{},!1,!1,!1,!1,!1,()=>{e.setChCc(y,10,n||128)}][w]||(()=>{}))():w<36?([()=>{let x=n&7;n&8&&(x=1),x>1&&console.debug(`${i}CH${y+1} sends to ${x>1?`IFX${x-1}`:"direct out"} (${n.toString(16)}).`),e.setChEffectSink(y,n>1&&n<7?n+1:0)}][w-22]||(()=>{}))():([()=>{e.setChCc(y,74,(n+128&255)-64)},()=>{e.setChCc(y,71,(n+128&255)-64)},!1,!1,()=>{e.setChCc(y,73,(n+128&255)-64)},()=>{e.setChCc(y,75,(n+128&255)-64)},!1,()=>{e.setChCc(y,72,(n+128&255)-64)}][w-36]||(()=>{}))()}}}),o=o.trimEnd(),e.dispatchEvent("metacommit",{type:"EORTitle",data:o})});let $=function(t,c,s){let r=e.chRedir(t,c,!0);e.setChMode(r,E.an1x),e.pushChPrimitives(r),console.debug(`Yamaha AN1x slot ${s+1} receives from CH${r+1}(${t+1}).`),e.modelEx.yPlg[3][s]=r};e.#g.add([92,0,0],(t,c,s)=>{let r=t[0];t.subarray(1).forEach((i,o)=>{let n=o+r;n<2||([!1,!1,!1,!1,!1,!1,()=>{$(i,c,0)},()=>{$(i,c,1)}][n-2]||(()=>{}))()})}),e.#g.add([75,80,0],(t,c,s)=>{let r=t[0];t.subarray(1).forEach((i,o)=>{let n=o+r;([()=>{e.modelEx.cs1x.perfCh=i,e.pushChPrimitives(i),console.debug(`Yamaha CS1x performance on CH${i+1}.`)},!1,!1,!1,()=>{},!1,()=>{switch(i){case 1:{e.switchMode("xg",!0),e.setPortMode(e.getTrackPort(c),1,E.xg),console.debug("Yamaha CS1x set to XG mode.");break}case 3:{e.switchMode("cs1x",!0),e.setPortMode(e.getTrackPort(c),1,E.cs1x),console.debug("Yamaha CS1x set to performance mode.");break}default:console.warn(`Unknown Yamaha CS1x mode: ${i}`)}},()=>{}][n]||(()=>{}))()})}).add([75,96,0],(t,c,s)=>{let r=t[0],i=!1,o=e.modelEx.cs1x.perfCh;t.subarray(1).forEach((n,f)=>{let d=f+r;d<8?(i=!0,e.#T[o]=1,e.setChCvnRegister(o,d,n)):d<48?([!1,()=>{e.setChCc(o,7,n)}][d]||(()=>{}))():d<80?([()=>{e.setEffectTypeRaw(0,!1,n)},()=>{e.setEffectTypeRaw(0,!0,n),e.pushEffectType(0)},()=>{e.setEffectTypeRaw(1,!1,n)},()=>{e.setEffectTypeRaw(1,!0,n),e.pushEffectType(1)},()=>{e.setEffectTypeRaw(2,!1,n)},()=>{e.setEffectTypeRaw(2,!0,n),e.pushEffectType(2)}][d-48]||(()=>{}))():S()&&console.debug(`Unknown CS1x effect register: ${d}.`)}),i&&(e.setChActive(o,1),e.pushChPrimitives(o))});let v=(t,c,s)=>{let r=0;s.forEach((i,o)=>{([()=>{r=(i&1)<<7|r&127,e.setEffectTypeRaw(t,!1,28),e.setEffectTypeRaw(t,!0,r)},()=>{r=r&128|i&127,e.setEffectTypeRaw(t,!1,28),e.setEffectTypeRaw(t,!0,r),e.pushEffectType(t)}][o+c]||(()=>{}))()})};e.#I.add([96,0,1],(t,c,s)=>{let r=t[0];switch(t[1]){case 0:{v(0,t[2],t.subarray(3)),console.debug(`Partially parsed KORG PA EFX SysEX:
`,t);break}case 1:{v(1,t[2],t.subarray(3)),console.debug(`Partially parsed KORG PA EFX SysEX:
`,t);break}case 2:{v(2,t[2],t.subarray(3)),console.debug(`Partially parsed KORG PA EFX SysEX:
`,t);break}case 3:{v(3,t[2],t.subarray(3)),console.debug(`Partially parsed KORG PA EFX SysEX:
`,t);break}default:console.debug(`Unparsed KORG PA SysEX:
`,t)}})}};export{Gt as OctaviaDevice,p as allocated,k as ccToPos,U as dnToPos,Ie as effectSlots,S as getDebugState,q as overrides};
