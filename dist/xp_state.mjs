var __defProp=Object.defineProperty;var __defNormalProp=(obj,key,value)=>key in obj?__defProp(obj,key,{enumerable:!0,configurable:!0,writable:!0,value}):obj[key]=value;var __publicField=(obj,key,value)=>(__defNormalProp(obj,typeof key!="symbol"?key+"":key,value),value),__accessCheck=(obj,member,msg)=>{if(!member.has(obj))throw TypeError("Cannot "+msg)};var __privateGet=(obj,member,getter)=>(__accessCheck(obj,member,"read from private field"),getter?getter.call(obj):member.get(obj)),__privateAdd=(obj,member,value)=>{if(member.has(obj))throw TypeError("Cannot add the same private member more than once");member instanceof WeakSet?member.add(obj):member.set(obj,value)},__privateSet=(obj,member,value,setter)=>(__accessCheck(obj,member,"write to private field"),setter?setter.call(obj,value):member.set(obj,value),value);(function(){var d=function(s,a,t){var n,i;if(self.MessageEvent)switch(s){case"message":{i=new MessageEvent(s,{data:a,ports:t==null?void 0:t.ports}),Object.defineProperty(i,"source",{value:t==null?void 0:t.source});break}default:i=new Event(s)}else i=document.createEvent("Event"),i.initEvent(s,!1,!1),t&&s=="message"&&(i.data=a,t.source&&Object.defineProperty(i,"source",{value:t.source}),(n=t.ports)!=null&&n.length&&Object.defineProperty(i,"ports",{value:t.ports}));return i};self.BroadcastChannel?console.info("[Snowy] Snowy is disabled."):(console.info("[Snowy] Snowy is enabled. Path: ".concat(self.SNOWY_PATH||"/snowy.js")),h=[],c={},E=function(s){var b,a=this;if((this==null?void 0:this.constructor)!=E)throw new TypeError("Illegal constructor");h.push(this),(b=c[s])!=null&&b.constructor||(c[s]=[]),c[s].push(this);var t=Math.floor(Math.random()*281474976710656),i=[],n=0,u=[],g=!0,w=!1;Object.defineProperty(this,"id",{get:function(){return t}}),Object.defineProperty(this,"name",{value:s}),this.close=function(){var o,e=h.indexOf(a);e>-1?(f.postMessage({t:"d",c:s,i:t}),h.splice(e,1),(o=c[s])!=null&&o.constructor&&(e=c[s].indexOf(a),e>-1&&c[s].splice(e,1)),c[s].length||delete c[s],console.debug("[Snowy] BroadcastChannel closed."),w=!0):console.debug("[Snowy] BroadcastChannel already closed.")},this.postMessage=function(e){if(f){if(w)throw new Error("Channel already closed");f.postMessage({t:"m",c:s,i:t,m:n,d:e}),n++,n>4294967295&&(n=0)}else u.push(e),console.debug("[Snowy] Message is cached.")},this.flush=function(){if(f){if(g){for(f.postMessage({t:"r",c:s,i:t}),console.debug("[Snowy] ".concat(u.length," message(s) in cache."));u.length;){var e=u.shift();a.postMessage(e)}g=!1,console.debug("[Snowy] All cached messages are flushed away.")}}else throw new Error("Tried to flush when the ports are not ready")},this.receiveMessage=function(e){e.c==s?e.i!=t&&a.dispatchEvent(d("message",e.d,{source:a})):console.debug("[Snowy] Channel ID mismatch. Instance ".concat(t," receives from ").concat(s,", not ").concat(e.c,"."))};var r={};this.dispatchEvent=function(e){var v,y;if(Object.defineProperty(e,"target",{value:a}),Object.defineProperty(e,"currentTarget",{value:a}),(v=r[e.type])!=null&&v.length)for(var o=r[e.type],l=0;l<o.length;l++)((y=o[l])==null?void 0:y.constructor)==Function&&o[l].call(a,e);a["on".concat(e.type)]&&a["on".concat(e.type)].constructor==Function&&a["on".concat(e.type)].call(a,e)},this.addEventListener=function(e,o){var v;(v=r[e])!=null&&v.constructor||(r[e]=[]);var l=r[e].indexOf(o);l==-1&&r[e].push(o)},this.removeEventListener=function(e,o){var v,y;if((v=r[e])!=null&&v.length){var l=r[e].indexOf(o);l>-1&&r[e].splice(l,1)}!((y=r[e])!=null&&y.length)&&r[e].constructor&&delete r[e]}},self.BroadcastChannel=E,M=function(){if(f){f.addEventListener("message",function(a){var t=a.data,i=!1;switch(t.t){case"k":{i=!1,f.postMessage({t:"k"});break}case"m":{var n=c[t.c];if(n!=null&&n.length)for(var u=0;u<n.length;u++)n[u].receiveMessage(t);break}case"c":{for(var g=[],w=0;w<h.length;w++){var r=h[w].name;g.indexOf(r)<0&&g.push(r)}f.postMessage({t:"k",c:g});break}default:i=!0}i&&console.info("ReceiveBroadcast",t)});for(var s=0;s<h.length;s++)h[s].flush()}else throw new Error("Message port isn't yet ready");console.info("[Snowy] Snowy is active.")},O=function(){if(!f){var s=new SharedWorker(self.SNOWY_PATH||"/snowy.js");s.port.start();var a=function(t){t.data.t=="swc"&&(s.port.removeEventListener("message",a),f=s.port,f.postMessage({t:"k"}),M())};s.port.addEventListener("message",a)}},O());var f,h,c,E,M,O})();{let fileReadAs=function(blob,target){let reader=new FileReader;return new Promise((success,failure)=>{switch(reader.addEventListener("abort",()=>{failure(new Error("Blob read aborted"))}),reader.addEventListener("error",ev=>{failure(reader.error||ev.data||new Error("Blob read error"))}),reader.addEventListener("load",()=>{success(reader.result)}),target.toLowerCase()){case"arraybuffer":case"buffer":{reader.readAsArrayBuffer(blob);break}case"string":case"text":{reader.readAsText(blob);break}default:failure(new Error(`Unknown target ${target}`))}})};Blob.prototype.arrayBuffer=Blob.prototype.arrayBuffer||function(){return fileReadAs(this,"buffer")},Blob.prototype.text=Blob.prototype.text||function(){return fileReadAs(this,"text")}}String.prototype.replaceAll=String.prototype.replaceAll||function(source,target){let antiLoop=0,maxSafe=16,indexFinder=this,indexes=[];for(;antiLoop<maxSafe&&indexFinder.lastIndexOf(source)>-1;){let index=indexFinder.lastIndexOf(source);indexes.unshift(indexFinder.slice(index+source.length)),indexFinder=indexFinder.slice(0,index),index==0&&indexes.unshift(""),antiLoop++}return indexFinder.length&&indexes.unshift(indexFinder),indexes.join(target)||""},String.prototype.padStart=String.prototype.padStart||function(length,filler){if(filler){let result=this;for(;result.length<length;)result=`${filler}${result}`;return result}},String.prototype.padEnd=String.prototype.padEnd||function(length,filler){if(filler){let result=this;for(;result.length<length;)result+=filler;return result}};var compArr=function(a,b){let minL=Math.min(a.length,b.length),c=a.slice(0,minL),d=b.slice(0,minL),result=0,pointer=0;for(;pointer<minL&&result==0;)result=Math.sign(c[pointer]-d[pointer]),pointer++;return result},BinaryMatch=function(name2=""){this.name=name2,this.pool=[],this.point=function(prefix,insert=!1){if(this.pool.length>0){let bound=this.pool.length,bs=1<<Math.floor(Math.log2(bound)),pp=bs,ttl=64;for(;bs>=1&&ttl>=0;){if(ttl<=0)throw new Error("TTL reached.");if(pp==bound)pp-=bs;else{let result=compArr(prefix,this.pool[pp]);switch(result){case 0:{ttl=0;break}case 1:{pp+bs<=bound&&(pp+=bs);break}case-1:{pp!=0&&(pp-=bs);break}default:console.warn(`Unexpected result ${result}.`)}}bs=bs>>1,ttl--}let match=!0;if(pp>=this.pool.length)match=!1;else{let upThis=this;this.pool[pp].forEach(function(e,i,a){match&&e!=prefix[i]&&(match=!1)}),!match&&compArr(prefix,this.pool[pp])>0&&pp++}return match||insert?pp:-1}else return insert?0:-1},this.add=function(prefix,data2){return prefix.data=data2,this.pool.splice(this.point(prefix,!0),0,prefix),this},this.default=function(info){console.warn(`No match in "${this.name||"(unknown)"}" for "${info}". Default action not defined.`)},this.get=function(prefix){let idx=this.point(prefix);if(idx>-1)return this.pool[idx].data;this.default(prefix)},this.run=function(prefix,...additional){let idx=this.point(prefix);idx>-1?prefix.subarray?this.pool[idx].data(prefix.subarray(this.pool[idx].length),...additional):this.pool[idx].data(prefix.slice(this.pool[idx].length),...additional):this.default(prefix,...additional)}};var _eventListeners,_a,CustomEventSource=(_a=class{constructor(){__privateAdd(this,_eventListeners,{})}addEventListener(type,callback){__privateGet(this,_eventListeners)[type]||(__privateGet(this,_eventListeners)[type]=[]),__privateGet(this,_eventListeners)[type].unshift(callback)}removeEventListener(type,callback){if(__privateGet(this,_eventListeners)[type]){let index=__privateGet(this,_eventListeners)[type].indexOf(callback);index>-1&&__privateGet(this,_eventListeners)[type].splice(index,1),__privateGet(this,_eventListeners)[type].length<1&&delete __privateGet(this,_eventListeners)[type]}}dispatchEvent(type,data2){var _a5;let eventObj=new Event(type),upThis=this;eventObj.data=data2,((_a5=__privateGet(this,_eventListeners)[type])==null?void 0:_a5.length)>0&&__privateGet(this,_eventListeners)[type].forEach(function(e){try{e==null||e.call(upThis,eventObj)}catch(err){console.error(err)}}),this[`on${type}`]&&this[`on${type}`](eventObj)}},_eventListeners=new WeakMap,_a);var sgCrit=["MSB","PRG","LSB","NME","ELC","DRM"],halfHex=function(n){let segA=Math.floor(n/10),segB=n%10;return`${segA.toString(16)}${segB}`},_bankInfo,_a2,VoiceBank=(_a2=class{constructor(...args){__privateAdd(this,_bankInfo,void 0);__publicField(this,"strictMode",!1);this.loadFiles(...args)}get(msb=0,prg=0,lsb=0,mode){var _a5,_b;let sid=[msb,prg,lsb],bankName,bankPoly=1,bankType=0,bankDrum,args=Array.from(arguments);switch(mode){case"xg":{switch(msb){case 0:{lsb==126?args[2]=125:lsb==127&&(args[2]=0);break}case 16:{lsb==126&&(args[2]=0);break}case 32:{lsb>125&&(args[2]=0),args[2]+=4;break}case 33:case 34:case 35:case 36:{lsb>125&&(args[2]=0),args[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:args[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{lsb==126&&(args[2]=0);break}case 48:case 64:case 126:case 127:{lsb==126&&(args[2]=0);break}}break}case"gs":{msb==0&&lsb<5?args[2]=0:msb>125&&lsb<5&&lsb!=2&&(args[2]=msb,args[0]=0);break}case"g2":case"sd":{msb>>1==40?args[2]|=16:msb>95&&msb<100&&(args[2]|=16,prg>>3==15&&(args[0]=96));break}case"sg":{msb==8&&lsb==0&&(args[2]=5);break}case"s90es":{lsb<8?args[2]+=17:lsb<32?args[2]+=13:args[2]=(args[2]>>3)+19;break}case"motif":{lsb<8?args[2]+=28:lsb<32?args[2]+=13:args[2]=(args[2]>>3)+19;break}}let ending=" ",sect="M",useLsb=0,baseShift=0;switch(args[0]){case 0:{args[2]==127?sect="MT-a":args[2]==126?sect="MT-b":args[2]==7?sect="GM-k":args[2]==5?sect="SG-a":args[2]==4?sect="SP-l":args[2]==0||mode=="gs"&&args[2]<5?sect="GM-a":(sect="y",useLsb=3);break}case 8:{mode=="sg"?sect="GM-s":sect="r:";break}case 32:case 33:case 34:case 35:case 36:{mode=="xg"&&(sect=`${["AP","VL","PF","DX","AN"][msb&7]}-${"abcdefgh"[lsb]}`);break}case 48:{sect=`yM${(args[2]>>3).toString().padStart(2,"0")}`,useLsb=1;break}case 56:{sect="GM-b";break}case 61:case 120:{sect="rDrm";break}case 62:{sect="kDrm";break}case 63:{if(args[2]<17){let kLsb=args[2];sect=kLsb<10?"kP:":"kC:",sect+=kLsb%10}else args[2]<34?sect=["Pre1","Pre2","Pre3","Pre4","Usr1","Usr2","DrmP","DrmU","Plg1","Plg2","Plg3","Pre1","Pre2","Pre3","Pre4","Pre5","Pre6"][args[2]-17]:sect="Ds";break}case 64:{sect="ySFX";break}case 67:{sect="DX:S";break}case 80:case 81:case 82:case 83:{sect=`Prg${"UABC"[args[0]-80]}`;break}case 88:case 89:case 90:case 91:{sect=`Cmb${"UABC"[args[0]-88]}`;break}case 95:{sect=`${["DR","PC"][args[2]]}-d`;break}case 96:{sect=args[2]==106?"AP-a":args[2]>>4==1?"SDg":"PF",args[2]>63?baseShift=63:args[2]>>4==1&&(baseShift=16),useLsb=3;break}case 97:{sect=args[2]>>4==1?"SDa":"VL:",useLsb=3,args[2]>>4==1?baseShift=16:baseShift=112;break}case 98:{sect=args[2]>>4==1?"SDb":"SG-a",useLsb=3,baseShift=16;break}case 99:{sect=args[2]>>4==1?"SDc":"DX",args[2]>63?baseShift=63:args[2]>>4==1&&(baseShift=16),useLsb=3;break}case 100:{sect="AN",args[2]>63?baseShift=63:args[2]>>4==1&&(baseShift=16),useLsb=3;break}case 104:case 105:case 106:case 107:{sect="SDd",baseShift=104;break}case 121:{sect=`GM-${args[2]?"":"a"}`,useLsb=3;break}case 122:{sect="lDrm";break}case 126:{sect="yDrS";break}case 127:{args[2]==127?sect="rDrm":sect="yDrm";break}default:args[0]<48?sect="r:":sect="M"}sect.length<4&&(sect+=`${[msb,lsb,args[0],args[2]][useLsb]-baseShift}`.padStart(4-sect.length,"0")),mode=="xg"&&(msb==0?args[2]<100?sect=sect.replace("y0","y:"):args[2]==125&&(sect="y126"):msb==16&&(bankName=`Voice${(args[2]*128+args[1]+1).toString().padStart(3,"0")}`,ending=" "));let iid=[args[0],args[1],args[2]];for(;!((bankName==null?void 0:bankName.length)>=0);)if(bankName=(_a5=__privateGet(this,_bankInfo)[args[1]||0][(args[0]<<7)+args[2]])==null?void 0:_a5.name,bankName){let bankObject=__privateGet(this,_bankInfo)[args[1]||0][(args[0]<<7)+args[2]];bankPoly=(bankObject==null?void 0:bankObject.poly)||bankPoly,bankType=(bankObject==null?void 0:bankObject.type)||bankType,bankDrum=bankObject==null?void 0:bankObject.drum}else if(this.strictMode)bankName="",ending="?";else if(args[0]==0&&args[1]==0&&args[2]==0)bankName="Unloaded";else if(__privateGet(this,_bankInfo)[args[1]||0][args[0]<<7])args[0]==0?(args[2]=0,ending="^"):args[2]<1?(args[0]=0,ending="*"):(args[2]--,ending="^");else if(msb==48)args[0]=0,args[2]=0,ending="!";else if(msb==62)args[1]--,ending=" ",args[1]<1&&!(bankName!=null&&bankName.length)&&(args[0]=0,ending="!");else if(msb<63)args[0]==0?(args[2]=0,ending="^"):args[2]<1?(args[0]=0,ending="*"):args[2]--;else if(msb==80)bankName=`PrgU:${prg.toString().padStart(3,"0")}`,ending="!";else if(msb==88)bankName=`CmbU:${prg.toString().padStart(3,"0")}`,ending="!";else if(msb==121)bankName=`GM2Vox0${lsb}`,ending="#";else if(msb==122){if(args[1]==32?args[1]==0:args[1]%=7,bankName=(_b=__privateGet(this,_bankInfo)[args[1]||0][(args[0]<<7)+args[2]])==null?void 0:_b.name,bankName){ending=" ";let bankObject=__privateGet(this,_bankInfo)[args[1]||0][(args[0]<<7)+args[2]];bankPoly=(bankObject==null?void 0:bankObject.poly)||bankPoly,bankType=(bankObject==null?void 0:bankObject.type)||bankType,bankDrum=bankObject==null?void 0:bankObject.drum}else bankName="",ending="*";}else args[1]==0?(bankName=`${msb.toString().padStart(3,"0")} ${prg.toString().padStart(3,"0")} ${lsb.toString().padStart(3,"0")}`,ending="!"):args[0]==0?(args[2]=0,ending="^"):args[2]>0?args[2]--:args[1]>0?(args[1]=0,ending="!"):(args[0]=0,ending="?");let eid=[args[0],args[1],args[2]];(mode=="gs"||mode=="ns5r")&&ending=="^"&&(ending=" "),msb==127&&ending=="^"&&(ending=" "),ending!=" "&&self.debugMode&&(bankName="");let standard="??";switch(args[0]){case 0:{args[2]==0?standard="GM":args[2]==5||args[2]==7?standard="KG":args[2]<126?standard="XG":args[2]==127&&(standard="MT");break}case 32:case 33:case 35:case 36:{args[2]>4?standard=["AP","VL","PF","DX","AN"][args[0]-32]:standard="GS";break}case 48:{standard="MU";break}case 56:{standard="AG";break}case 61:case 80:case 83:case 88:case 89:case 91:{standard="AI";break}case 62:case 82:case 90:{standard="XD";break}case 63:{args[2]<17?standard="KR":args[2]<34?standard="ES":standard="DS";break}case 64:case 126:{standard="XG";break}case 67:case 99:{standard=args[2]>>4==1?"SD":"DX";break}case 81:{standard="RW";break}case 95:{standard=["DR","PC"][args[2]];break}case 96:{standard=args[2]==106?"AP":args[2]>>4==1?"SD":"PF";break}case 97:{standard=args[2]>>4==1?"SD":"VL";break}case 98:{standard=args[2]>>4==1?"SD":"SG";break}case 100:{standard="AN";break}case 104:case 105:case 106:case 107:{standard="SD";break}case 120:{standard="GS";break}case 121:{standard=args[2]?"G2":"GM";break}case 122:{standard="KG";break}case 127:{standard=args[2]==127?"MT":prg==0?"GM":"XG";break}default:args[0]<48&&(args[0]==16&&mode=="xg"?standard="XG":standard="GS")}return{name:bankName||`${halfHex(msb||0)} ${halfHex(prg||0)} ${halfHex(lsb||0)}`,poly:bankPoly,type:bankType,drum:bankDrum,iid,eid,sid,ending,sect,standard}}async load(text,allowOverwrite,name2="(internal)"){let upThis=this,sig=[],loadCount=0,allCount=0;text.split(`
`).forEach(function(e,i){let assign=e.split("\t"),to=[];if(i==0){if(assign.forEach(function(e0,i0){sig[sgCrit.indexOf(e0)]=i0}),sig.length<4){console.debug("Debugger launched.");debugger}}else{let msb=0,prg=0,lsb=0,name3,poly=1,type=0,drum;assign.forEach(async function(e1,i1){switch(i1){case sig[0]:{msb=parseInt(e1);break}case sig[1]:{prg=parseInt(e1);break}case sig[2]:{lsb=parseInt(e1);break}case sig[3]:{name3=e1;break}case sig[4]:{e1=parseInt(e1),e1<16?poly=e1+1:type=(e1&15)+1;break}case sig[5]:{drum=e1;break}}}),__privateGet(upThis,_bankInfo)[prg]=__privateGet(upThis,_bankInfo)[prg]||[];let writeArray=__privateGet(upThis,_bankInfo)[prg];if(!writeArray[msb<<7|lsb]||allowOverwrite){let voiceObject={msb,prg,lsb,name:name3,poly,type,drum};writeArray[msb<<7|lsb]=voiceObject,loadCount++}allCount++}}),allowOverwrite||console.debug(`Map "${name2}": ${allCount} total, ${loadCount} loaded.`)}clearRange(options){let prg=options.prg!=null?options.prg.constructor==Array?options.prg:[options.prg,options.prg]:[0,127],msb=options.msb!=null?options.msb.constructor==Array?options.msb:[options.msb,options.msb]:[0,127],lsb=options.lsb!=null?options.lsb.constructor==Array?options.lsb:[options.lsb,options.lsb]:[0,127];for(let cMsb=msb[0];cMsb<=msb[1];cMsb++){let precalMsb=cMsb<<7;for(let cLsb=lsb[0];cLsb<=lsb[1];cLsb++){let precalBnk=precalMsb+cLsb;for(let cPrg=prg[0];cPrg<=prg[1];cPrg++)delete __privateGet(this,_bankInfo)[cPrg][precalBnk]}}}init(){__privateSet(this,_bankInfo,[]);for(let prg=0;prg<128;prg++)__privateGet(this,_bankInfo).push([""])}async loadFiles(...type){this.init();let upThis=this;type.forEach(async function(e){try{await fetch(`./data/bank/${e}.tsv`).then(function(response){return response.text()}).then(text=>{upThis.load(text,!1,e)})}catch(err){console.error(`Failed loading "${e}.tsv".`)}})}},_bankInfo=new WeakMap,_a2);var _collection,_a3,BlobDecoder=(_a3=class{constructor(){__privateAdd(this,_collection,{});__publicField(this,"context")}set(format,decoder){__privateGet(this,_collection)[format]=decoder}has(format){return!!__privateGet(this,_collection)[format]}async read(format,blob){if(!this.has(format))throw new Error(`No decoder registered for "${format}"`);return await __privateGet(this,_collection)[format].call(this.context||this,blob)}},_collection=new WeakMap,_a3);var same=function(origin,arr){let same2=!0;return arr.forEach((e,i)=>{same2=same2&&origin[i]==e}),same2},readInt=function(arr){let sum=0;return arr.forEach(e=>{sum*=256,sum+=e}),sum},utf8Dec=new TextDecoder,bankDecoder=new BlobDecoder;bankDecoder.set("s7e",async function(blob){let s7eBlob=new Uint8Array(await blob.slice(0,65536).arrayBuffer()),voiceMap="MSB\tLSB\tPRG\tNME",nullHead=[0,0,0,0],globalOffset=32,ptr=0,mode=0,resume=!0,sections=[],sectPtr=0;for(;resume;){let rwin=s7eBlob.subarray(ptr);([()=>{utf8Dec.decode(rwin.subarray(0,4))=="YSFC"?(ptr+=80,mode=1):ptr++},()=>{if(same(rwin.subarray(0,4),nullHead))sections.forEach((e,i,a)=>{let length=readInt(s7eBlob.subarray(e.start+4,e.start+8));e.length=length}),mode=2;else{let type=utf8Dec.decode(rwin.subarray(0,4)),start=readInt(rwin.subarray(4,8));sections.push({type,start}),ptr+=8}},()=>{let section=sections[sectPtr],sectWin=s7eBlob.subarray(section.start,section.start+section.length),entryLen=32;switch(section.type){case"ENVC":{let entryStart=globalOffset;for(;entryStart<sectWin.length;){let entryWin=sectWin.subarray(entryStart,entryStart+entryLen),voiceName=utf8Dec.decode(entryWin.subarray(0,10)).trimEnd();voiceName.slice(0,5)=="Init "&&(voiceName=""),voiceName&&(voiceMap+=`
063	${(entryWin[17]+13).toString().padStart(3,"0")}	${entryWin[19].toString().padStart(3,"0")}	${voiceName}`),entryStart+=entryLen}break}case"EDVC":{let entryStart=globalOffset;for(;entryStart<sectWin.length;){let entryWin=sectWin.subarray(entryStart,entryStart+entryLen),voiceName=utf8Dec.decode(entryWin.subarray(0,10)).trimEnd();voiceName.slice(0,5)=="Init "&&(voiceName=""),voiceName&&(voiceMap+=`
063	024	${entryWin[19].toString().padStart(3,"0")}	${voiceName}`),entryStart+=entryLen}break}case"EPVC":{let entryLen2=32,entryStart=globalOffset;for(;entryStart<sectWin.length;){let entryWin=sectWin.subarray(entryStart,entryStart+entryLen2),voiceName=utf8Dec.decode(entryWin.subarray(0,10)).trimEnd();voiceName=="----------"&&(voiceName=""),voiceName&&(voiceMap+=`
063	${(entryWin[17]+1).toString().padStart(3,"0")}	${entryWin[19].toString().padStart(3,"0")}	${voiceName}`),entryStart+=entryLen2}break}}sectPtr++,sectPtr>=sections.length&&(mode=3,resume=!1)}][mode]||(()=>{resume=!1}))()}return voiceMap});var xgEffType=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]),xgPartMode=["melodic","drums","drum set 1","drum set 2","drum set 3","drum set 4","drum set 5","drum set 6","drum set 7","drum set 8"],xgDelOffset=[17.1,18.6,20.2,21.8,23.3,24.9,26.5,28,29.6,31.2,32.8,34.3,35.9,37.5,39,40.6,42.2,43.7,45.3,46.9,48.4,50],xgNormFreq=[20,22,25,28,32,36,40,45,50,56,63,70,80,90,100,110,125,140,160,180,200,225,250,280,315,355,400,450,500,560,630,700,800,900,1e3,1100,1200,1400,1600,1800,2e3,2200,2500,2800,3200,3600,4e3,4500,5e3,5600,6300,7e3,8e3,9e3,1e4,11e3,12e3,14e3,16e3,18e3,2e4],xgLfoFreq=[0,.04,.08,.13,.17,.21,.25,.29,.34,.38,.42,.46,.51,.55,.59,.63,.67,.72,.76,.8,.84,.88,.93,.97,1.01,1.05,1.09,1.14,1.18,1.22,1.26,1.3,1.35,1.39,1.43,1.47,1.51,1.56,1.6,1.64,1.68,1.72,1.77,1.81,1.85,1.89,1.94,1.98,2.02,2.06,2.1,2.15,2.19,2.23,2.27,2.31,2.36,2.4,2.44,2.48,2.52,2.57,2.61,2.65,2.69,2.78,2.86,2.94,3.03,3.11,3.2,3.28,3.37,3.45,3.53,3.62,3.7,3.87,4.04,4.21,4,37,4.54,4.71,4.88,5.05,5.22,5.38,5.55,5.72,6.06,6.39,6.73,7.07,7.4,7.74,8.08,8.41,8.75,9.08,9.42,9.76,10.1,10.8,11.4,12.1,12.8,13.5,14.1,14.8,15.5,16.2,16.8,17.5,18.2,19.5,20.9,22.2,23.6,24.9,26.2,27.6,28.9,30.3,31.6,33,34.3,37,39.7],getXgRevTime=function(data2){let a=.1,b=-.3;return data2>66?(a=5,b=315):data2>56?(a=1,b=47):data2>46&&(a=.5,b=18.5),a*data2-b},getXgDelayOffset=function(data2){return data2>105?xgDelOffset[data2-106]:data2>100?data2*1.1-100:data2/10},xgSgVocals=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),xgSgMap={};`hi*,
ka,か
ki,き
ku,く
ke,け
ko,こ
ky,き!
kw,くl
tsu,つ
ts,つl
sa,さ
si,すぃ
su,す
se,せ
so,そ
shi,し
sh,し!
ta,た
ti,てぃ
tu,とぅ
te,て
to,と
tchy,ち!
tchi,ち
na,な
ni,に
nu,ぬ
ne,ね
no,の
ny,に!
nn,ん
ha,は
hi,ひ
hu,ほぅ
he,へ
ho,ほ
hy,ひ!
fa,ふぁ
fi,ふぃ
fu,ふ
fe,ふぇ
fo,ふぉ
ma,ま
mi,み
mu,む
me,め
mo,も
my,み!
mm,
ra,ら
ri,り
ru,る
re,れ
ro,ろ
ry,り!
wa,わ
wi,うぃ
we,うぇ
wo,を
nga,ガ
ngi,ギ
ngu,グ
nge,ゲ
ngo,ゴ
ngy,ギ!
ng,
ga,が
gi,ぎ
gu,ぐ
ge,げ
go,ご
gy,ぎ!
gw,ぐl
za,ざ
zi,ずぃ
zu,ず
ze,ぜ
zo,ぞ
ja,じゃ
ji,じ
ju,じゅ
je,じぇ
jo,じょ
jy,じ!
da,だ
di,でぃ
du,どぅ
de,で
do,ど
dy,で!
ba,ば
bi,び
bu,ぶ
be,べ
bo,ぼ
by,び!
va,ゔぁ
vi,ゔぃ
vu,ゔ
ve,ゔぇ
vo,ゔぉ
pa,ぱ
pi,ぴ
pu,ぷ
pe,ペ
po,ぽ
py,ぴ!
!ya,ゃ
!yu,ゅ
!ye,ぇ
!yo,ょ
ya,や
yu,ゆ
ye,いぇ
yo,よ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
la,ぁ
li,ぃ
lu,ぅ
le,ぇ
lo,ぉ
a,あ
i,い
u,う
e,え
o,お
*,っ
~,
^,
_,`.split(`
`).forEach(e=>{let param=e.split(",");xgSgMap[param[0]]=param[1]});var getSgKana=function(seq){let target=seq;seq[0]=="*"&&(target=target.slice(1)),["aa","ii","uu","ee","oo"].forEach(e=>{for(;target.indexOf(e)>-1;)target=target.replace(e,e[0])});for(let mark in xgSgMap)target=target.replaceAll(mark,xgSgMap[mark]);target.indexOf("\u3093")==0&&target.length>1&&(target=target.slice(1));let youOn=target.indexOf("!");return youOn>-1&&target.length>1&&(target=target.slice(youOn+1)),target},getVlCtrlSrc=function(ctrlNo){return ctrlNo?ctrlNo<96?`cc${ctrlNo}`:["aftertouch","velocity","pitch bend"][ctrlNo-96]:"off"};var gsRevType=["room 1","room 2","room 3","hall 1","hall 2","plate","delay","panning delay"],gsChoType=["chorus 1","chorus 2","chorus 3","chorus 4","feedback","flanger","short delay","short delay feedback"],gsDelType=["delay 1","delay 2","delay 3","delay 4","pan delay 1","pan delay 2","pan delay 3","pan delay 4","delay to reverb","pan repeat"];var gsEfx={0:"thru",256:"stereo EQ",257:"spectrum",258:"enhancer",259:"humanizer",272:"overdrive",273:"distortion",288:"phaser",289:"auto wah",290:"rotary",291:"stereo flanger",292:"step flanger",293:"tremelo",294:"auto pan",304:"compressor",305:"limiter",320:"hexa chorus",321:"tremelo chorus",322:"stereo chorus",323:"space D",324:"3D chorus",336:"stereo delay",337:"modulated delay",338:"3-tap delay",339:"4-tap delay",340:"tremelo control delay",341:"reverb",342:"gate reverb",343:"3D delay",352:"2-pitch shifter",353:"feedback pitch shifter",368:"3D auto",369:"3D manual",370:"Lo-Fi 1",371:"Lo-Fi 2",512:"overdrive - chorus",513:"overdrive - flanger",514:"overdrive - delay",515:"distortion - chorus",516:"distortion - flanger",517:"distortion - delay",518:"enhancer - chorus",519:"enhancer - flanger",520:"enhancer - delay",521:"chorus - delay",522:"flanger - delay",523:"chorus - flanger",524:"rotary multi",1024:"guitar multi 1",1025:"guitar multi 2",1026:"guitar multi 3",1027:"clean guitar multi 1",1028:"clean guitar multi 2",1029:"bass multi",1030:"rhodes multi",1280:"keyboard multi",4352:"chorus / delay",4353:"flanger / delay",4354:"chorus / flanger",4355:"overdrive / distortion",4356:"overdrive / rotary",4357:"overdrive / phaser",4358:"overdrive / auto wah",4359:"phaser / rotary",4360:"phaser / auto wah"},gsEfxDesc={66307:["drive"],66309:["vowel",e=>"aiueo"[e]],94723:["pre-filter"],94724:["Lo-Fi type"],94725:["post-filter"],94979:["Lo-Fi type"],94980:["fill type",e=>["off","LPF","HPF"][e]],94984:["noise type",e=>["white","pink"][e]],94987:["disc type",e=>["LP","SP","EP","RND"]],94990:["hum type",e=>`${e+5}0Hz`],94993:["M/S",e=>["mono","stereo"][e]]},getGsEfx=function(arr){return gsEfx[(arr[0]-32<<8)+arr[1]]||`0x${arr[0].toString(16).padStart(2,"0")}${arr[1].toString(16).padStart(2,"0")}`},getGsEfxDesc=function(arr,param,value){let id=(arr[0]-32<<16)+(arr[1]<<8)+param,target=gsEfxDesc[id]||{},desc=target[0];if(desc!=null&&desc.length)return desc+=`: ${(target[1]||function(){})(value)||value}`,desc},mt32DefProg=[68,48,95,78,41,3,110,122,0];var toDecibel=function(data2=64){return Math.round(2e3*Math.log10(data2/64))/100};var gsChecksum=function(sequence){let checksum=0;return sequence.forEach(e=>{checksum+=e,checksum=checksum&127}),~checksum+1&127},korgFilter=function(korgArr,iterator){let realData=0,dataMask=0;for(let pointer=0;pointer<korgArr.length;pointer++){let shifts=pointer%8-1,unmasked=(dataMask>>shifts&1)<<7,e=korgArr[pointer];e+=unmasked,pointer%8!=0?(iterator(e,realData,korgArr),realData++):dataMask=korgArr[pointer]}};var x5dSendLevel=function(sendParam){let res=Math.floor(sendParam*14.2);return res<128?res:0};var modeIdx=["?","gm","gs","xg","g2","mt32","ns5r","x5d","05rw","sd","k11","sg","krs","s90es","motif"],modeAdapt={gm2:"g2","mt-32":"mt32","c/m":"mt32",ag10:"05rw","ag-10":"05rw","05r/w":"05rw",x5:"05rw",x5dr:"x5d",gmega:"k11","kross 2":"krs","motif es":"motif","s90 es":"s90es"},voiceIdx=["melodic","drum","menu"],substList=[[0,0,0,0,121,0,0,82,81,97,0,0,63,63,63],[0,0,4,0,0,127,0,0,0,0,0,0,0,0,0]],drumMsb=[120,127,120,127,120,127,61,62,62,105,122,122,120,127,127],passedMeta=[0,3,81,84,88],eventTypes={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},useRpnMap={0:0,1:1,2:3,5:4},rpnOptions={0:0,1:1,2:2,5:3},rpnCap=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],useNormNrpn=[36,37,48,49,52,53],useDrumNrpn=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65],defDrumNrpn={26:127,29:0,30:0,31:0,52:12,53:54},ccAccepted=[0,1,2,4,5,6,7,8,10,11,32,38,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,84,91,92,93,94,95,98,99,100,101,128,12,13,16,17,18,19,14,15,20,21,26,28,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],aceCandidates=[2,12,13,14,15,16,17,18,19,20,21,136,130,131,132,133,134,135,137,138,139],nrpnCcMap=[33,99,100,32,102,8,9,10],korgDrums=[0,16,25,40,32,64,26,48],modeMap={};modeIdx.forEach((e,i)=>{modeMap[e]=i});var ccToPos2={length:ccAccepted.length};ccAccepted.forEach((e,i)=>{ccToPos2[e]=i});var dnToPos={length:useDrumNrpn.length};useDrumNrpn.forEach((e,i)=>{dnToPos[e]=i});var voiceType={};voiceIdx.forEach((e,i)=>{voiceType[e]=i});var getDebugState=function(){return!!self.Bun||self.debugMode||!1},sysExSplitter=function(seq){let seqArr=[],seqStart=0;return seq==null||seq.forEach(function(e,i){e==247?seqArr.push(seq.subarray(seqStart,i)):e==240&&(seqStart=i+1)}),seqArr.length||seqArr.push(seq.subarray(0)),getDebugState()&&console.debug(seqArr),seqArr};var allocated={ch:128,cc:ccAccepted.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,rpnt:4,ace:8,drm:8,dpn:useDrumNrpn.length,dnc:128,ext:2,efx:7,redir:32},overrides={bank0:128},_mode,_bitmapPage,_bitmapExpire,_bitmapStore,_bitmap,bitmap_get,bitmap_set,_chActive,_chReceive,_chType,_cc,_ace,_prg,_velo,_mono,_poly,_polyState,_pitch,_rawStrength,_dataCommit,_ext,_rpn,_rpnt,_nrpn,_drum,_efxBase,_efxTo,_ccCapturer,_bnCustom,_cmTPatch,_cmTTimbre,_cmPatch,_cmTimbre,_subMsb,_subLsb,_detect,_masterVol,_metaChannel,_noteLength,_convertLastSyllable,_letterDisp,_letterExpire,_letterSet,_selectPort,_receiveRS,_modeKaraoke,_vlSysBreathMode,_receiveTree,_ccRedirMap,_gsEfxSto,_metaTexts,_trkRedir,_trkAsReq,_metaRun,_metaSeq,_ua,_runChEvent,_seMan,_seUnr,_seUr,_seXg,_seGs,_seAi,_seKg,_seSg,_seCs,_a4,OctaviaDevice=(_a4=class extends CustomEventSource{constructor(){super();__privateAdd(this,_bitmap);__publicField(this,"NOTE_IDLE",0);__publicField(this,"NOTE_ATTACK",1);__publicField(this,"NOTE_DECAY",2);__publicField(this,"NOTE_SUSTAIN",3);__publicField(this,"NOTE_HELD",4);__publicField(this,"NOTE_RELEASE",5);__publicField(this,"NOTE_SOSTENUTO_ATTACK",8);__publicField(this,"NOTE_SOSTENUTO_DECAY",9);__publicField(this,"NOTE_SOSTENUTO_SUSTAIN",10);__publicField(this,"NOTE_SOSTENUTO_HELD",11);__publicField(this,"CH_MELODIC",0);__publicField(this,"CH_DRUMS",1);__publicField(this,"CH_DRUM1",2);__publicField(this,"CH_DRUM2",3);__publicField(this,"CH_DRUM3",4);__publicField(this,"CH_DRUM4",5);__publicField(this,"CH_DRUM5",6);__publicField(this,"CH_DRUM6",7);__publicField(this,"CH_DRUM7",8);__publicField(this,"CH_DRUM8",9);__publicField(this,"EXT_NONE",0);__publicField(this,"EXT_VL",1);__publicField(this,"VLBC_BRTHEXPR",1);__publicField(this,"VLBC_VELOINIT",2);__publicField(this,"VLBC_VELOALL",3);__privateAdd(this,_mode,0);__privateAdd(this,_bitmapPage,0);__privateAdd(this,_bitmapExpire,0);__privateAdd(this,_bitmapStore,new Array(11));__privateAdd(this,_chActive,new Uint8Array(allocated.ch));__privateAdd(this,_chReceive,new Uint8Array(allocated.ch));__privateAdd(this,_chType,new Uint8Array(allocated.ch));__privateAdd(this,_cc,new Uint8Array(allocated.ch*allocated.cc));__privateAdd(this,_ace,new Uint8Array(allocated.ace));__privateAdd(this,_prg,new Uint8Array(allocated.ch));__privateAdd(this,_velo,new Uint8Array(allocated.ch*allocated.nn));__privateAdd(this,_mono,new Uint8Array(allocated.ch));__privateAdd(this,_poly,new Uint16Array(allocated.pl));__privateAdd(this,_polyState,new Uint8Array(allocated.pl));__privateAdd(this,_pitch,new Int16Array(allocated.ch));__privateAdd(this,_rawStrength,new Uint8Array(allocated.ch));__privateAdd(this,_dataCommit,0);__privateAdd(this,_ext,new Uint8Array(allocated.ch*allocated.ext));__privateAdd(this,_rpn,new Uint8Array(allocated.ch*allocated.rpn));__privateAdd(this,_rpnt,new Uint8Array(allocated.ch*allocated.rpnt));__privateAdd(this,_nrpn,new Int8Array(allocated.ch*useNormNrpn.length));__privateAdd(this,_drum,new Uint8Array(allocated.drm*allocated.dpn*allocated.dnc));__privateAdd(this,_efxBase,new Uint8Array(allocated.efx*3));__privateAdd(this,_efxTo,new Uint8Array(allocated.ch));__privateAdd(this,_ccCapturer,new Uint8Array(allocated.ch*allocated.redir));__privateAdd(this,_bnCustom,new Uint8Array(allocated.ch));__privateAdd(this,_cmTPatch,new Uint8Array(128));__privateAdd(this,_cmTTimbre,new Uint8Array(allocated.cmt*8));__privateAdd(this,_cmPatch,new Uint8Array(1024));__privateAdd(this,_cmTimbre,new Uint8Array(allocated.cmt*64));__privateAdd(this,_subMsb,0);__privateAdd(this,_subLsb,0);__privateAdd(this,_detect,void 0);__privateAdd(this,_masterVol,100);__privateAdd(this,_metaChannel,0);__privateAdd(this,_noteLength,500);__privateAdd(this,_convertLastSyllable,0);__privateAdd(this,_letterDisp,"");__privateAdd(this,_letterExpire,0);__privateAdd(this,_letterSet,0);__privateAdd(this,_selectPort,0);__privateAdd(this,_receiveRS,!0);__privateAdd(this,_modeKaraoke,!1);__privateAdd(this,_vlSysBreathMode,1);__privateAdd(this,_receiveTree,void 0);__privateAdd(this,_ccRedirMap,new Array(allocated.ch));__privateAdd(this,_gsEfxSto,new Uint8Array(2));__privateAdd(this,_metaTexts,[]);__privateAdd(this,_trkRedir,new Uint8Array(allocated.ch));__privateAdd(this,_trkAsReq,new Uint8Array(allocated.tr));__publicField(this,"baseBank",new VoiceBank("gm","gm2","xg","gs","ns5r","sd","gmega","plg-150vl","plg-150pf","plg-150dx","plg-150an","plg-150dr","plg-100sg","krs","s90es"));__publicField(this,"userBank",new VoiceBank("gm"));__publicField(this,"initOnReset",!1);__publicField(this,"aiEfxName","");__privateAdd(this,_metaRun,[]);__privateAdd(this,_metaSeq,void 0);__privateAdd(this,_ua,{nOff:(part,note)=>{let rawNote=part*128+note,polyIdx=__privateGet(this,_poly).lastIndexOf(rawNote);if(polyIdx>-1)if(__privateGet(this,_cc)[allocated.cc*part+ccToPos2[64]]>63)__privateGet(this,_polyState)[polyIdx]=this.NOTE_HELD,this.dispatchEvent("note",{part,note,velo:__privateGet(this,_velo)[rawNote],state:this.NOTE_HELD});else if(__privateGet(this,_cc)[allocated.cc*part+ccToPos2[66]]>63&&__privateGet(this,_polyState)[polyIdx]==this.NOTE_SOSTENUTO_SUSTAIN)__privateGet(this,_polyState)[polyIdx]=this.NOTE_SOSTENUTO_HELD,this.dispatchEvent("note",{part,note,velo:__privateGet(this,_velo)[rawNote],state:this.NOTE_SOSTENUTO_HELD});else{__privateGet(this,_poly)[polyIdx]=0,__privateGet(this,_velo)[rawNote]=0,__privateGet(this,_polyState)[polyIdx]=this.NOTE_IDLE;let breathMode=this.getExt(part)[1];(breathMode==this.VLBC_VELOINIT||breathMode==this.VLBC_VELOALL)&&(__privateGet(this,_cc)[allocated.cc*part+ccToPos2[129]]=0),this.dispatchEvent("note",{part,note,velo:0,state:this.NOTE_IDLE})}},nOn:(part,note,velo)=>{let rawNote=part*128+note,place=0;for(__privateGet(this,_mono)[part]&&__privateGet(this,_ua).ano(part);__privateGet(this,_polyState)[place]>0&&__privateGet(this,_poly)[place]!=rawNote;)place++;if(place<allocated.pl){__privateGet(this,_poly)[place]=rawNote,__privateGet(this,_velo)[rawNote]=velo,__privateGet(this,_polyState)[place]=this.NOTE_SUSTAIN,__privateGet(this,_rawStrength)[part]<velo&&(__privateGet(this,_rawStrength)[part]=velo);let breathMode=this.getExt(part)[1];(breathMode==this.VLBC_VELOINIT||breathMode==this.VLBC_VELOALL)&&(__privateGet(this,_cc)[allocated.cc*part+ccToPos2[129]]=velo),this.dispatchEvent("note",{part,note,velo,state:this.NOTE_SUSTAIN})}else console.error("Polyphony exceeded.")},nAt:(part,note,velo)=>{},cAt:(part,velo)=>{},hoOf:part=>{__privateGet(this,_polyState).forEach((e,i)=>{if(e==this.NOTE_HELD){let rawNote=__privateGet(this,_poly)[i],channel=rawNote>>7;part==channel&&(__privateGet(this,_polyState)[i]=this.NOTE_IDLE,__privateGet(this,_poly)[i]=0,__privateGet(this,_velo)[rawNote]=0,this.dispatchEvent("note",{part,note:rawNote&127,velo:0,state:this.NOTE_IDLE}))}})},soOn:part=>{__privateGet(this,_polyState).forEach((e,i)=>{let emitEvent;switch(e){case this.NOTE_ATTACK:{emitEvent=this.NOTE_SOSTENUTO_ATTACK;break}case this.NOTE_DECAY:{emitEvent=this.NOTE_SOSTENUTO_DECAY;break}case this.NOTE_SUSTAIN:{emitEvent=this.NOTE_SOSTENUTO_SUSTAIN;break}}if(emitEvent){__privateGet(this,_polyState)[i]=emitEvent;let rawNote=__privateGet(this,_poly)[i];this.dispatchEvent("note",{part,note:rawNote&127,velo:__privateGet(this,_velo)[rawNote],state:emitEvent})}})},soOf:part=>{__privateGet(this,_polyState).forEach((e,i)=>{if(e==this.NOTE_SOSTENUTO_HELD){let rawNote=__privateGet(this,_poly)[i],channel=rawNote>>7;part==channel&&(__privateGet(this,_polyState)[i]=this.NOTE_IDLE,__privateGet(this,_poly)[i]=0,__privateGet(this,_velo)[rawNote]=0,this.dispatchEvent("note",{part,note:rawNote&127,velo:0,state:this.NOTE_IDLE}))}})},ano:part=>{__privateGet(this,_poly).forEach((e,i,a)=>{let ch=e>>7,no=e&127;e==0&&__privateGet(this,_velo)[0]==0||ch==part&&__privateGet(this,_ua).nOff(ch,no)})}});__privateAdd(this,_runChEvent,{8:function(det){let part=det.channel,rawNote=det.data[0];__privateGet(this,_ua).nOff(part,rawNote)},9:function(det){let part=det.channel;this.setChActive(part,1);let rawNote=det.data[0],velocity=det.data[1];velocity>0?__privateGet(this,_ua).nOn(part,rawNote,velocity):__privateGet(this,_ua).nOff(part,rawNote)},10:function(det){let part=det.channel,rawNote=part*128+det.data[0];__privateGet(this,_poly).indexOf(rawNote)>-1&&(__privateGet(this,_velo)[rawNote]=data[1],this.getExt(part)[1]==this.VLBC_VELOALL&&(__privateGet(this,_cc)[allocated.cc*part+ccToPos2[129]]=data[1]),this.dispatchEvent("note",{part,note:det.data[0],velo:det.data[1],state:this.NOTE_SUSTAIN}))},11:function(det){let part=det.channel,redirMap=__privateGet(this,_ccRedirMap)[part],redirTarget=redirMap[det.data[0]];redirTarget&&(det.data[0]=redirTarget),[0,32].indexOf(det.data[0])>-1&&(()=>{switch(__privateGet(this,_mode)){case modeMap.s90es:case modeMap.motif:{if(det.data[0]==0){[0,63].indexOf(det.data[1])>-1&&this.setChActive(part,1);break}det.data[1]&&this.setChActive(part,1);break}default:{this.setChActive(part,1);break}}})();let chOff=part*allocated.cc,extOff=part*allocated.ext;switch(det.data[0]){case 96:return;case 97:return;case 120:return;case 121:{__privateGet(this,_ua).ano(part),__privateGet(this,_pitch)[part]=0,__privateGet(this,_cc)[chOff+ccToPos2[1]]=0,__privateGet(this,_cc)[chOff+ccToPos2[5]]=0,__privateGet(this,_cc)[chOff+ccToPos2[64]]=0,__privateGet(this,_cc)[chOff+ccToPos2[65]]=0,__privateGet(this,_cc)[chOff+ccToPos2[66]]=0,__privateGet(this,_cc)[chOff+ccToPos2[67]]=0,__privateGet(this,_cc)[chOff+ccToPos2[11]]=127,__privateGet(this,_cc)[chOff+ccToPos2[101]]=127,__privateGet(this,_cc)[chOff+ccToPos2[100]]=127,__privateGet(this,_cc)[chOff+ccToPos2[99]]=127,__privateGet(this,_cc)[chOff+ccToPos2[98]]=127;return}case 123:{__privateGet(this,_ua).ano(part);return}case 124:{__privateGet(this,_ua).ano(part);return}case 125:{__privateGet(this,_ua).ano(part);return}case 126:{__privateGet(this,_mono)[part]=1,__privateGet(this,_ua).ano(part);return}case 127:{__privateGet(this,_mono)[part]=0,__privateGet(this,_ua).ano(part);return}}if(ccToPos2[det.data[0]]==null)console.warn(`cc${det.data[0]} is not accepted.`);else{switch(aceCandidates.indexOf(det.data[0])>-1&&this.allocateAce(det.data[0]),det.data[0]){case 0:{switch(getDebugState()&&console.debug(`${modeIdx[__privateGet(this,_mode)]}, CH${part+1}: ${det.data[1]}`),__privateGet(this,_mode)==0?det.data[1]<48?(__privateGet(this,_chType)[part]>0&&(det.data[1]=__privateGet(this,_cc)[chOff],det.data[1]=120,console.debug(`Forced channel ${part+1} to stay drums.`)),det.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${det.data[1]}`),this.switchMode("gs"))):det.data[1]==62?this.switchMode(__privateGet(this,_detect).x5==82?"x5d":"05rw"):det.data[1]==63?this.switchMode(this.modeIdx[__privateGet(this,_detect).ds]):(det.data[1]==64||det.data[1]==127)&&this.switchMode("xg"):__privateGet(this,_mode)==modeMap.gs?det.data[1]<56&&__privateGet(this,_chType)[part]>0&&(det.data[1]=__privateGet(this,_cc)[chOff],det.data[1]=120,console.debug(`Forced channel ${part+1} to stay drums.`)):__privateGet(this,_mode)==modeMap.gm&&(det.data[1]<48?__privateGet(this,_chType)[part]>0&&(det.data[1]=120,this.switchMode("gs",!0),console.debug(`Forced channel ${part+1} to stay drums.`)):(det.data[1]==64||det.data[1]==127)&&this.switchMode("xg",!0)),__privateGet(this,_mode)){case modeMap.xg:{[79,95,126,127].indexOf(det.data[1])>-1?__privateGet(this,_chType)[part]==0&&(this.setChType(part,this.CH_DRUM2),console.debug(`CH${part+1} set to drums by MSB.`)):__privateGet(this,_chType)[part]>0&&(this.setChType(part,this.CH_MELODIC),console.debug(`CH${part+1} set to melodic by MSB.`)),[33,81,97].indexOf(det.data[1])>-1?__privateGet(this,_ext)[extOff]=this.EXT_VL:__privateGet(this,_ext)[extOff]=this.EXT_NONE;break}case modeMap["05rw"]:case modeMap.x5d:case modeMap.ns5r:{[61,62,126,127].indexOf(det.data[1])>-1?__privateGet(this,_chType)[part]==this.CH_MELODIC&&(this.setChType(part,this.CH_DRUM2),console.debug(`CH${part+1} set to drums by MSB.`)):[80,81,82,83].indexOf(det.data[1])>-1||__privateGet(this,_chType)[part]!=this.CH_MELODIC&&(this.setChType(part,this.CH_MELODIC),console.debug(`CH${part+1} set to melodic by MSB.`));break}case modeMap.sd:{[104,105,106,107].indexOf(det.data[1])>-1?__privateGet(this,_chType)[part]==0&&(this.setChType(part,this.CH_DRUM2),console.debug(`CH${part+1} set to drums by MSB.`)):__privateGet(this,_chType)[part]>0&&(this.setChType(part,this.CH_MELODIC),console.debug(`CH${part+1} set to melodic by MSB.`));break}case modeMap.g2:{det.data[1]==120?__privateGet(this,_chType)[part]==0&&(this.setChType(part,this.CH_DRUMS),console.debug(`CH${part+1} set to drums by MSB.`)):__privateGet(this,_chType)[part]>0&&(this.setChType(part,this.CH_MELODIC),console.debug(`CH${part+1} set to melodic by MSB.`));break}}this.dispatchEvent("voice",{part});break}case 2:{this.getExt(part)[1]==this.VLBC_BRTHEXPR&&(__privateGet(this,_cc)[chOff+ccToPos2[129]]=det.data[1]);break}case 6:{if(__privateGet(this,_dataCommit)){[modeMap.xg,modeMap.gs,modeMap.ns5r].indexOf(__privateGet(this,_mode))<0&&console.warn(`NRPN commits are not available under "${modeIdx[__privateGet(this,_mode)]}" mode, even when they are supported in Octavia.`);let msb=__privateGet(this,_cc)[chOff+ccToPos2[99]],lsb=__privateGet(this,_cc)[chOff+ccToPos2[98]];if(msb==1){let toCc=nrpnCcMap.indexOf(lsb);if(toCc>-1)__privateGet(this,_cc)[chOff+ccToPos2[71+toCc]]=det.data[1],getDebugState()&&console.debug(`Redirected NRPN 1 ${lsb} to cc${71+toCc}.`),this.dispatchEvent("cc",{part,cc:71+toCc,data:det.data[1]});else{let nrpnIdx=useNormNrpn.indexOf(lsb);nrpnIdx>-1?__privateGet(this,_nrpn)[part*10+nrpnIdx]=det.data[1]-64:console.warn(`NRPN 0x01${lsb.toString(16).padStart(2,"0")} is not supported.`),getDebugState()&&console.debug(`CH${part+1} voice NRPN ${lsb} commit`)}}else{if(useDrumNrpn.indexOf(msb)<0){let dPref=`NRPN 0x${msb.toString(16).padStart(2,"0")}${lsb.toString(16).padStart(2,"0")} `;msb==127?console.warn(`${dPref}is not necessary. Consider removing it.`):console.warn(`${dPref}is not supported.`)}else{let targetSlot=__privateGet(this,_chType)[part]-2;targetSlot<0?console.warn(`CH${part+1} cannot accept drum NRPN as type ${xgPartMode[__privateGet(this,_chType)[part]]}.`):__privateGet(this,_drum)[(targetSlot*allocated.dpn+dnToPos[msb])*allocated.dnc+lsb]=det.data[1]}getDebugState()&&console.debug(`CH${part+1} (${xgPartMode[__privateGet(this,_chType)[part]]}) drum NRPN ${msb} commit`)}}else{let rpnIndex=useRpnMap[__privateGet(this,_cc)[chOff+ccToPos2[100]]],rpnIndex2=rpnOptions[__privateGet(this,_cc)[chOff+ccToPos2[100]]];__privateGet(this,_cc)[chOff+ccToPos2[101]]==0&&rpnIndex!=null&&(getDebugState()&&console.debug(`CH${part+1} RPN 0 ${__privateGet(this,_cc)[chOff+ccToPos2[100]]} commit: ${det.data[1]}`),det.data[1]=Math.min(Math.max(det.data[1],rpnCap[rpnIndex][0]),rpnCap[rpnIndex][1]),__privateGet(this,_rpn)[part*allocated.rpn+rpnIndex]=det.data[1],__privateGet(this,_rpnt)[part*allocated.rpnt+rpnIndex2]=1)}break}case 32:{switch(getDebugState()&&console.debug(`${modeIdx[__privateGet(this,_mode)]}, CH${part+1} LSB: ${det.data[1]}`),__privateGet(this,_mode)){case modeMap.s90es:case modeMap.motif:{this.setChType(part,[32,40].indexOf(det.data[1])>-1?this.CH_DRUMS:this.CH_MELODIC,__privateGet(this,_mode),!0);break}}this.dispatchEvent("voice",{part});break}case 38:{if(!__privateGet(this,_dataCommit)){let rpnIndex=useRpnMap[__privateGet(this,_cc)[chOff+100]],rpnIndex2=rpnOptions[__privateGet(this,_cc)[chOff+100]];__privateGet(this,_cc)[chOff+101]==0&&rpnIndex!=null&&(__privateGet(this,_rpn)[part*allocated.rpn+rpnIndex+1]=det.data[1],__privateGet(this,_rpnt)[part*allocated.rpnt+rpnIndex2]=1)}break}case 64:{det.data[1]<64&&__privateGet(this,_ua).hoOf(part);break}case 66:{det.data[1]>>6?__privateGet(this,_ua).soOn(part):__privateGet(this,_ua).soOf(part);break}case 98:case 99:{__privateSet(this,_dataCommit,1);break}case 100:case 101:{__privateSet(this,_dataCommit,0);break}}__privateGet(this,_cc)[chOff+ccToPos2[det.data[0]]]=det.data[1],this.dispatchEvent("cc",{part,cc:det.data[0],data:det.data[1]})}},12:function(det){let part=det.channel;switch(__privateGet(this,_mode)){case modeMap.s90es:case modeMap.motif:{det.data&&this.setChActive(part,1);break}default:this.setChActive(part,1)}__privateGet(this,_prg)[part]=det.data,__privateGet(this,_bnCustom)[part]=0,getDebugState()&&console.debug(`T:${det.track} C:${part} P:${det.data}`),this.dispatchEvent("voice",{part})},13:function(det){let upThis=this,part=det.channel;__privateGet(this,_poly).forEach(function(e){let realCh=e>>7;part==realCh&&(__privateGet(upThis,_velo)[e]=det.data,upThis.dispatchEvent("note",{part,note:e&127,velo:det.data,state:upThis.NOTE_SUSTAIN}))})},14:function(det){let part=det.channel;__privateGet(this,_pitch)[part]=det.data[1]*128+det.data[0]-8192,this.dispatchEvent("pitch",{part,pitch:this.getPitchShift(part)})},15:function(det){sysExSplitter(det.data).forEach(seq=>{let manId=seq[0],deviceId=seq[1];(__privateGet(this,_seMan)[manId]||function(){console.debug(`Unknown manufacturer ${manId}.`)})(deviceId,seq.subarray(2),det.track)})},248:function(det){},250:function(det){},251:function(det){},252:function(det){},254:function(det){},255:function(det){(__privateGet(this,_metaRun)[det.meta]||function(data2,track,meta){}).call(this,det.data,det.track,det.meta),det.meta!=32&&__privateSet(this,_metaChannel,0);let useReply=passedMeta.indexOf(det.meta)>-1;if(getDebugState()&&console.debug(det),useReply)return det.reply="meta",det}});__privateAdd(this,_seMan,{64:(id,msg,track)=>{__privateGet(this,_seKg).run(msg,track,id)},65:(id,msg,track)=>{if(msg[0]<16){if(msg[1]==72){let sentCs=msg[msg.length-1],calcCs=gsChecksum(msg.subarray(3,msg.length-1));sentCs==calcCs?__privateGet(this,_seGs).run(msg.subarray(0,msg.length-1),track,id):console.warn(`Bad SD checksum ${sentCs}. Should be ${calcCs}.`)}else __privateGet(this,_seGs).run(msg,track,id);}else{let sentCs=msg[msg.length-1],calcCs=gsChecksum(msg.subarray(2,msg.length-1));sentCs==calcCs?__privateGet(this,_seGs).run(msg.subarray(0,msg.length-1),track,id):console.warn(`Bad GS checksum ${sentCs}. Should be ${calcCs}.`)}},66:(id,msg,track)=>{__privateGet(this,_seAi).run(msg,track,id)},67:(id,msg,track)=>{__privateGet(this,_seXg).run(msg,track,id)},68:(id,msg,track)=>{__privateGet(this,_seCs).run(msg,track,id)},71:(id,msg,track)=>{__privateGet(this,_seSg).run(msg,track,id)},126:(id,msg,track)=>{__privateGet(this,_seUnr).run(msg,track,id)},127:(id,msg,track)=>{this.switchMode("gm"),__privateGet(this,_seUr).run(msg,track,id)}});__privateAdd(this,_seUnr,void 0);__privateAdd(this,_seUr,void 0);__privateAdd(this,_seXg,void 0);__privateAdd(this,_seGs,void 0);__privateAdd(this,_seAi,void 0);__privateAdd(this,_seKg,void 0);__privateAdd(this,_seSg,void 0);__privateAdd(this,_seCs,void 0);let upThis=this;__privateSet(upThis,_bitmap,new Uint8Array(256),bitmap_set),__privateGet(upThis,_bitmapStore)[10]=new Uint8Array(512),__privateSet(upThis,_metaSeq,new BinaryMatch),__privateSet(upThis,_detect,{x5:82,ds:modeMap.krs}),upThis.userBank.strictMode=!0,upThis.userBank.load(`MSB	PRG	LSB	NME
062	000	000	
122	000	000	
122	001	000	
122	002	000	
122	003	000	
122	004	000	
122	005	000	
122	006	000	`),upThis.addEventListener("metacommit",function(ev){var _a5,_b;let{data:data2}=ev;((_a5=__privateGet(upThis,_metaTexts)[0])==null?void 0:_a5.type)==data2.type&&(_b=__privateGet(upThis,_metaTexts)[0])!=null&&_b.amend?(__privateGet(upThis,_metaTexts)[0].amend=data2.amend,__privateGet(upThis,_metaTexts)[0].data+=data2.data):__privateGet(upThis,_metaTexts).unshift(data2)}),__privateGet(upThis,_metaRun)[1]=function(data2){var _a5,_b,_c,_d,_e;switch(data2=data2.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),data2.slice(0,2)){case"@I":{__privateSet(this,_modeKaraoke,!0),this.dispatchEvent("metacommit",{type:"Kar.Info",data:(_a5=data2.slice(2))==null?void 0:_a5.trimLeft()});break}case"@K":{__privateSet(this,_modeKaraoke,!0),this.dispatchEvent("metacommit",{type:"Kar.Mode",data:(_b=data2.slice(2))==null?void 0:_b.trimLeft()}),console.debug(`Karaoke mode active: ${data2.slice(2)}`);break}case"@L":{__privateSet(this,_modeKaraoke,!0),this.dispatchEvent("metacommit",{type:"Kar.Lang",data:(_c=data2.slice(2))==null?void 0:_c.trimLeft()});break}case"@T":{__privateSet(this,_modeKaraoke,!0),this.dispatchEvent("metacommit",{type:"KarTitle",data:(_d=data2.slice(2))==null?void 0:_d.trimLeft()});break}case"@V":{__privateSet(this,_modeKaraoke,!0),this.dispatchEvent("metacommit",{type:"Kar.Ver.",data:(_e=data2.slice(2))==null?void 0:_e.trimLeft()});break}case"XF":{let dataArr=data2.slice(2).split(":");switch(dataArr[0]){case"hd":{dataArr.slice(1).forEach((e,i)=>{e.length&&this.dispatchEvent("metacommit",{type:["XfSngDte","XfSngRgn","XfSngCat","XfSongBt","XfSngIns","XfSngVoc","XfSngCmp","XfSngLrc","XfSngArr","XfSngPer","XfSngPrg","XfSngTag"][i],data:e})});break}case"ln":{dataArr.slice(1).forEach((e,i)=>{e.length&&this.dispatchEvent("metacommit",{type:["XfKarLng","XfKarNme","XfKarCmp","XfKarLrc","XfKarArr","XfKarPer","XfKarPrg"][i],data:e})});break}default:this.dispatchEvent("metacommit",{type:"XfUnData",data:data2})}break}default:__privateGet(this,_modeKaraoke)?data2[0]=="\\"?(this.dispatchEvent("metacommit",{type:"KarLyric",data:"",amend:!1}),this.dispatchEvent("metacommit",{type:"KarLyric",data:data2.slice(1),amend:!0})):data2[0]=="/"?(this.dispatchEvent("metacommit",{type:"KarLyric",data:"",mask:!0,amend:!1}),this.dispatchEvent("metacommit",{type:"KarLyric",data:data2.slice(1),mask:!0,amend:!0})):this.dispatchEvent("metacommit",{type:"KarLyric",data:data2,amend:!0}):data2.split(`
`).forEach((e,i)=>{this.dispatchEvent("metacommit",{type:"Cmn.Text",data:e,mask:i!=0})})}},__privateGet(upThis,_metaRun)[2]=function(data2){this.dispatchEvent("metacommit",{type:"Copyrite",data:data2})},__privateGet(upThis,_metaRun)[3]=function(data2,track){track<1&&__privateGet(this,_metaChannel)<1&&this.dispatchEvent("metacommit",{type:"TrkTitle",data:data2})},__privateGet(upThis,_metaRun)[4]=function(data2,track){this.dispatchEvent("metacommit",{type:"Instrmnt",data:data2})},__privateGet(upThis,_metaRun)[5]=function(data2){data2.trim()==""?this.dispatchEvent("metacommit",{type:"C.Lyrics",data:"",amend:!1}):this.dispatchEvent("metacommit",{type:"C.Lyrics",data:data2,amend:!0})},__privateGet(upThis,_metaRun)[6]=function(data2){this.dispatchEvent("metacommit",{type:"C.Marker",data:data2})},__privateGet(upThis,_metaRun)[7]=function(data2){this.dispatchEvent("metacommit",{type:"CuePoint",data:data2})},__privateGet(upThis,_metaRun)[32]=function(data2){__privateSet(this,_metaChannel,data2[0]+1)},__privateGet(upThis,_metaRun)[33]=function(data2,track){__privateGet(upThis,_trkAsReq)[track]=data2+1},__privateGet(upThis,_metaRun)[81]=function(data2,track){__privateSet(upThis,_noteLength,data2/1e3)},__privateGet(upThis,_metaRun)[127]=function(data2,track){__privateGet(upThis,_metaSeq).run(data2,track)},__privateGet(upThis,_metaSeq).default=function(seq){console.warn(`Unrecognized sequencer-specific byte sequence: ${seq}`)},__privateGet(upThis,_metaSeq).add([67,0,1],function(msg,track){__privateGet(upThis,_trkAsReq)[track]=msg[0]+1}),__privateSet(upThis,_seUnr,new BinaryMatch("universal non-realtime")),__privateSet(upThis,_seUr,new BinaryMatch("universal realtime")),__privateSet(upThis,_seXg,new BinaryMatch("Yamaha")),__privateSet(upThis,_seGs,new BinaryMatch("Roland")),__privateSet(upThis,_seAi,new BinaryMatch("Korg")),__privateSet(upThis,_seKg,new BinaryMatch("Kawai")),__privateSet(upThis,_seSg,new BinaryMatch("Akai")),__privateSet(upThis,_seCs,new BinaryMatch("Casio"));let dxDump=new BinaryMatch("DX7+ Dump"),syxDefaultErr=function(msg){console.info(`Unrecognized SysEx in "${this.name}" set.
%o`,msg)};__privateGet(upThis,_seUnr).default=syxDefaultErr,__privateGet(upThis,_seUr).default=syxDefaultErr,__privateGet(upThis,_seXg).default=syxDefaultErr,__privateGet(upThis,_seGs).default=syxDefaultErr,__privateGet(upThis,_seAi).default=syxDefaultErr,__privateGet(upThis,_seKg).default=syxDefaultErr,__privateGet(upThis,_seSg).default=syxDefaultErr,__privateGet(upThis,_seCs).default=syxDefaultErr,dxDump.default=syxDefaultErr,__privateGet(upThis,_seUnr).add([9],msg=>{upThis.switchMode(["gm","?","g2"][msg[0]-1],!0),__privateSet(upThis,_modeKaraoke,__privateGet(upThis,_modeKaraoke)||!1),console.info(`MIDI reset: ${["GM","Init","GM2"][msg[0]-1]}`),msg[0]==2&&upThis.init()}),__privateGet(upThis,_seUr).add([4,1],msg=>{__privateSet(upThis,_masterVol,((msg[1]<<7)+msg[0])/16383*100),upThis.dispatchEvent("mastervolume",__privateGet(upThis,_masterVol))}).add([4,3],msg=>((msg[1]<<7)+msg[0]-8192)/8192).add([4,4],msg=>msg[1]-64).add([4,5],msg=>{let slotLen=msg[0],paramLen=msg[1],valueLen=msg[2],slotStart=3,paramStart=slotStart+(slotLen<<1),valueStart=paramStart+paramLen;if(slotLen!=1){console.error(`Unsupported GM2 global parameter set: slotpath length too long (${slotLen})!
`,msg);return}let slot=0,param=0,value=0;switch(msg.subarray(slotStart,paramStart).forEach(e=>{slot=slot<<7,slot|=e}),msg.subarray(paramStart,valueStart).forEach((e,i)=>{param|=e<<i*7}),msg.subarray(valueStart).forEach((e,i)=>{value|=e<<i*7}),getDebugState()&&console.debug(`GM2 global parameter: (${msg.subarray(3,paramStart)}; p: ${param}, v: ${value})`),slot){case 129:{param==0&&(upThis.setEffectType(0,52,value),upThis.dispatchEvent("efxreverb",upThis.getEffectType(0)));break}case 130:{param==0&&(upThis.setEffectType(1,52,value|16),upThis.dispatchEvent("efxchorus",upThis.getEffectType(1)));break}default:getDebugState()&&console.debug("GM2 global paramater slot path unknown.")}}),__privateGet(this,_seXg).add([76,0,0],msg=>{switch(msg[0]){case 125:{upThis.initDrums(),console.info(`XG drum setup reset: ${msg}`);break}case 126:{upThis.switchMode("xg",!0),__privateSet(upThis,_modeKaraoke,!1),console.info("MIDI reset: XG");break}default:{let mTune=[0,0,0,0],writeTune=(e,i)=>{mTune[i]=e};if(msg.subarray(1).forEach((e,i)=>{let addr=i+msg[0];([writeTune,writeTune,writeTune,writeTune,e2=>{__privateSet(this,_masterVol,e2*129/16383*100),upThis.dispatchEvent("mastervolume",__privateGet(upThis,_masterVol))},e2=>{},e2=>{}][addr]||(()=>{}))(e,i)}),msg[0]<4){let rTune=0;mTune.forEach(e=>{rTune=rTune<<4,rTune+=e}),rTune-=1024}}}}).add([76,2,1],msg=>{let dPref="XG ";msg[0]<32?(dPref+="reverb ",msg.subarray(1).forEach((e,i)=>{([e2=>{upThis.setEffectTypeRaw(0,!1,e2),console.info(`${dPref}main type: ${xgEffType[e2]}`),upThis.dispatchEvent("efxreverb",upThis.getEffectType(0))},e2=>{upThis.setEffectTypeRaw(0,!0,e2),console.debug(`${dPref}sub type: ${e2+1}`),upThis.dispatchEvent("efxreverb",upThis.getEffectType(0))},e2=>{console.debug(`${dPref}time: ${getXgRevTime(e2)}s`)},e2=>{console.debug(`${dPref}diffusion: ${e2}`)},e2=>{console.debug(`${dPref}initial delay: ${e2}`)},e2=>{console.debug(`${dPref}HPF cutoff: ${xgNormFreq[e2]}Hz`)},e2=>{console.debug(`${dPref}LPF cutoff: ${xgNormFreq[e2]}Hz`)},e2=>{console.debug(`${dPref}width: ${e2}`)},e2=>{console.debug(`${dPref}height: ${e2}`)},e2=>{console.debug(`${dPref}depth: ${e2}`)},e2=>{console.debug(`${dPref}wall type: ${e2}`)},e2=>{console.debug(`${dPref}dry/wet: ${e2}`)},e2=>{console.debug(`${dPref}send: ${toDecibel(e2)}dB`)},e2=>{console.debug(`${dPref}pan: ${e2-64}`)},!1,!1,e2=>{console.debug(`${dPref}delay: ${e2}`)},e2=>{console.debug(`${dPref}density: ${e2}`)},e2=>{console.debug(`${dPref}balance: ${e2}`)},e2=>{},e2=>{console.debug(`${dPref}feedback: ${e2}`)},e2=>{}][msg[0]+i]||function(){console.warn(`Unknown XG reverb address: ${msg[0]}.`)})(e)})):msg[0]<64?(dPref+="chorus ",msg.subarray(1).forEach((e,i)=>{([e2=>{upThis.setEffectTypeRaw(1,!1,e2),console.info(`${dPref}main type: ${xgEffType[e2]}`),upThis.dispatchEvent("efxchorus",upThis.getEffectType(1))},e2=>{upThis.setEffectTypeRaw(1,!0,e2),console.debug(`${dPref}sub type: ${e2+1}`),upThis.dispatchEvent("efxchorus",upThis.getEffectType(1))},e2=>{console.debug(`${dPref}LFO: ${xgLfoFreq[e2]}Hz`)},e2=>{},e2=>{console.debug(`${dPref}feedback: ${e2}`)},e2=>{console.debug(`${dPref}delay offset: ${getXgDelayOffset(e2)}ms`)},e2=>{},e2=>{console.debug(`${dPref}low: ${xgNormFreq[e2]}Hz`)},e2=>{console.debug(`${dPref}low: ${e2-64}dB`)},e2=>{console.debug(`${dPref}high: ${xgNormFreq[e2]}Hz`)},e2=>{console.debug(`${dPref}high: ${e2-64}dB`)},e2=>{console.debug(`${dPref}dry/wet: ${e2}`)},e2=>{console.debug(`${dPref}send: ${toDecibel(e2)}dB`)},e2=>{console.debug(`${dPref}pan: ${e2-64}`)},e2=>{console.debug(`${dPref}to reverb: ${toDecibel(e2)}dB`)},!1,e2=>{},e2=>{},e2=>{},e2=>{console.debug(`${dPref}LFO phase diff: ${(e2-64)*3}deg`)},e2=>{console.debug(`${dPref}input mode: ${e2?"stereo":"mono"}`)},e2=>{}][msg[0]-32+i]||function(){console.warn(`Unknown XG chorus address: ${msg[0]}.`)})(e)})):msg[0]<86?(dPref+="variation ",msg.subarray(1).forEach((e,i)=>{([e2=>{upThis.setEffectTypeRaw(2,!1,e2),console.info(`${dPref}main type: ${xgEffType[e2]}`),upThis.dispatchEvent("efxdelay",upThis.getEffectType(2))},e2=>{upThis.setEffectTypeRaw(2,!0,e2),console.debug(`${dPref}sub type: ${e2+1}`),upThis.dispatchEvent("efxdelay",upThis.getEffectType(2))}][msg[0]-64+i]||function(){})(e)})):msg[0]<97?(dPref+="variation ",msg.subarray(1).forEach((e,i)=>{[e2=>{console.debug(`${dPref}send: ${toDecibel(e2)}dB`)},e2=>{console.debug(`${dPref}pan: ${e2-64}`)},e2=>{console.debug(`${dPref}to reverb: ${toDecibel(e2)}dB`)},e2=>{console.debug(`${dPref}to chorus: ${toDecibel(e2)}dB`)},e2=>{console.debug(`${dPref}connection: ${e2?"system":"insertion"}`)},e2=>{console.debug(`${dPref}channel: CH${e2+1}`)},e2=>{console.debug(`${dPref}mod wheel: ${e2-64}`)},e2=>{console.debug(`${dPref}bend wheel: ${e2-64}`)},e2=>{console.debug(`${dPref}channel after touch: ${e2-64}`)},e2=>{console.debug(`${dPref}AC1: ${e2-64}`)},e2=>{console.debug(`${dPref}AC2: ${e2-64}`)}][msg[0]-86+i](e)})):msg[0]>111&&msg[0]<118?dPref+="variation ":console.warn(`Unknown XG variation address: ${msg[0]}`)}).add([76,2,64],msg=>{msg.subarray(1).forEach((e,i)=>{let c=i+msg[0];if(c==0)console.debug(`XG EQ preset: ${["flat","jazz","pop","rock","classic"][e]}`);else{let band=c-1>>2,prop=c-1&3,dPref=`XG EQ ${band} ${["gain","freq","Q","shape"][prop]}: `;[()=>{console.debug(`${dPref}${e-64}dB`)},()=>{console.debug(`${dPref}${e} (raw)`)},()=>{console.debug(`${dPref}${e/10}`)},()=>{console.debug(`${dPref}${["shelf","peak"][+!!e]}`)}][prop]()}})}).add([76,3],msg=>{let varSlot=msg[0],offset=msg[1],dPref=`XG Insertion ${msg[0]+1} `;msg.subarray(2).forEach((e,i)=>{([e2=>{upThis.setEffectTypeRaw(3+varSlot,!1,e2),console.info(`${dPref}main type: ${xgEffType[e2]}`),upThis.dispatchEvent(`efxinsert${varSlot}`,upThis.getEffectType(3+varSlot))},e2=>{upThis.setEffectTypeRaw(3+varSlot,!0,e2),console.debug(`${dPref}sub type: ${e2+1}`),upThis.dispatchEvent(`efxinsert${varSlot}`,upThis.getEffectType(3+varSlot))}][offset+i]||function(){})(e)})}).add([76,6,0],msg=>{let offset=msg[0];offset<64?upThis.setLetterDisplay(msg.subarray(1),"XG letter display",offset):__privateSet(upThis,_letterExpire,Date.now())}).add([76,7,0],msg=>{let offset=msg[0];__privateSet(upThis,_bitmapPage,0),__privateSet(upThis,_bitmapExpire,Date.now()+3200),__privateGet(upThis,_bitmap,bitmap_get).fill(0);let workArr=msg.subarray(1);for(let index=0;index<offset;index++)workArr.unshift(0);workArr.forEach(function(e,i){let ln=Math.floor(i/16),co=i%16,pt=(co*3+ln)*7,threshold=7,bi=0;for(pt-=co*5,ln==2&&(threshold=2);bi<threshold;)__privateGet(upThis,_bitmap,bitmap_get)[pt+bi]=e>>6-bi&1,bi++})}).add([76,8],(msg,track)=>{let part=upThis.chRedir(msg[0],track,!0),id=msg[1],chOff=allocated.cc*part,dPref=`XG CH${part+1} `,errMsg=`Unknown XG part address ${id}.`;msg.subarray(2).forEach((e,i)=>{id<1?console.debug(errMsg):id<41?([()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=e,upThis.dispatchEvent("voice",{part})},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[32]]=e,upThis.dispatchEvent("voice",{part})},()=>{__privateGet(upThis,_prg)[part]=e,upThis.dispatchEvent("voice",{part})},()=>{let ch=upThis.chRedir(e,track,!0);__privateGet(upThis,_chReceive)[part]=ch,part!=ch&&(upThis.buildRchTree(),console.info(`${dPref}receives from CH${ch+1}`))},()=>{__privateGet(upThis,_mono)[part]=+!e},()=>{},()=>{upThis.setChType(part,e,modeMap.xg),console.debug(`${dPref}type: ${xgPartMode[e]||e}`)},()=>{__privateGet(upThis,_rpn)[allocated.rpn*part+3]=e,__privateGet(upThis,_rpnt)[allocated.rpnt*part+2]=1},!1,!1,()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[7]]=e},!1,!1,()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[10]]=e||128},!1,!1,()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[128]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[93]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[91]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[94]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[76]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[77]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[78]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[74]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[71]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[73]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[75]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[72]]=e}][id+i-1]||(()=>{}))():id<48?console.debug(errMsg):id<111?id>102&&id<105&&(__privateGet(upThis,_cc)[chOff+ccToPos2[[5,65][id&1]]]=e):id<114?console.debug(errMsg):id<116?console.debug(`${dPref}EQ ${["bass","treble"][id&1]} gain: ${e-64}dB`):id<118?console.debug(errMsg):id<120?console.debug(`${dPref}EQ ${["bass","treble"][id&1]} freq: ${e}`):console.debug(errMsg)})}).add([76,9],(msg,track)=>{let part=upThis.chRedir(msg[0],track,!0),id=msg[1],chOff=allocated.cc*part,dPref=`PLG-VL CH${part+1} `;msg.subarray(2).forEach((e,i)=>{let ri=i+id;switch(ri){case 1:{console.info(`${dPref}breath mode: ${["system","breath","velocity","touch EG"][e]}`);break}case 0:case 27:case 28:break;default:if(ri<27){let pId=ri-3>>1,pType=["pressure","embouchure","tonguing","scream","breath noise","growl","throat formant","harmonic enhancer","damping","absorption","amplification","brightness"][pId];ri&1?ri<23?(console.debug(`${dPref}${pType} control source: ${getVlCtrlSrc(e)}`),e&&e<96&&upThis.allocateAce(130+pId),__privateGet(upThis,_ccCapturer)[allocated.redir*part+pId+2]=e,upThis.buildRccMap()):console.debug(`${dPref}${pType} scale break point: ${e}`):(console.debug(`${dPref}${pType} depth: ${e-64}`),__privateGet(upThis,_cc)[chOff+ccToPos2[130+pId]]=e)}}})}).add([76,10],msg=>{}).add([76,16],msg=>{}).add([76,17,0,0],msg=>{}).add([76,112],msg=>{switch(console.debug(`XG enable PLG-${["VL","SG","DX","AN","PF","DR","PC","AP"][msg[0]]} for CH${msg[2]+1}.`),msg[0]){case 0:{__privateGet(upThis,_ext)[allocated.ext*msg[2]]=upThis.EXT_VL;break}default:__privateGet(upThis,_ext)[allocated.ext*msg[2]]=upThis.EXT_NONE}}).add([73,0,0],(msg,track)=>{let offset=msg[0],dPref="MU1000 System: ";msg.subarray(1).forEach((e,i)=>{let ri=offset+i;ri==8?console.debug(`${dPref}LCD contrast set to ${e}.`):ri==18?(__privateSet(upThis,_subLsb,e?126:0),console.debug(`${dPref}bank defaults to ${e?"MU100 Native":"MU Basic"}.`)):ri>=64&&ri<69&&[()=>{upThis.dispatchEvent("channelactive",e)},()=>{e<8?(upThis.dispatchEvent("channelmin",e<<4),console.debug(`Octavia System: Minimum CH${(e<<4)+1}`)):(upThis.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{e<8?(upThis.dispatchEvent("channelmax",(e<<4)+15),console.debug(`Octavia System: Maximum CH${(e<<4)+16}`)):(upThis.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{upThis.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges")},()=>{__privateSet(upThis,_receiveRS,!!e),console.info(`Octavia System: RS receiving ${["dis","en"][e]}abled.`)}][ri-64]()})}).add([73,10,0],(msg,track)=>{let cmd=msg[0],dPref=`MU1000 RS${__privateGet(upThis,_receiveRS)?"":" (ignored)"}: `;if(cmd<16)switch(cmd){case 2:{let e=upThis.chRedir(0,track,!0);__privateGet(upThis,_receiveRS)&&(upThis.dispatchEvent("channelmin",e),upThis.dispatchEvent("channelmax",e+63)),console.info(`${dPref}Show CH1~64`);break}case 3:{let e=upThis.chRedir(msg[1]<<5,track,!0);__privateGet(upThis,_receiveRS)&&upThis.dispatchEvent("channelmin",e),__privateGet(upThis,_receiveRS)&&upThis.dispatchEvent("channelmax",e+31),console.info(`${dPref}Show CH${e+1}~CH${e+32}`);break}default:console.debug(`${dPref}unknown switch ${cmd} invoked.`)}else if(cmd<32){if(__privateGet(upThis,_receiveRS)){let e=upThis.chRedir(cmd-16+(__privateGet(upThis,_selectPort)<<4),track,!0);upThis.dispatchEvent("channelactive",e)}}else if(cmd<36){let e=upThis.chRedir(cmd-32<<4,track,!0);__privateGet(upThis,_receiveRS)&&(upThis.dispatchEvent("channelmin",e),upThis.dispatchEvent("channelmax",e+15),__privateSet(upThis,_selectPort,cmd-32)),console.info(`${dPref}Show CH${e+1}~CH${e+16}`)}}).add([93,3],(msg,track)=>{let part=upThis.chRedir(msg[0],track,!0),dPref=`PLG-100SG CH${part+1} `,timeNow=Date.now();if(msg[1]==0){let vocal="",length=0;msg.subarray(2).forEach((e,i)=>{i%2==0?vocal+=xgSgVocals[e]||e.toString().padStart("0"):length+=e*13}),timeNow>=__privateGet(upThis,_convertLastSyllable)&&this.dispatchEvent("metacommit",{type:"SGLyrics",data:"",amend:!1}),this.dispatchEvent("metacommit",{type:"SGLyrics",data:`${getSgKana(vocal)}`,amend:!0}),__privateSet(upThis,_convertLastSyllable,timeNow+Math.ceil(length/2)+__privateGet(upThis,_noteLength)),getDebugState()&&console.debug(`${dPref}vocals: ${vocal}`)}else console.warn(`Unknown PLG-100SG data: ${msg}`)}).add([100,0],(msg,track,id)=>{let dumpString=msg.subarray(0,msg.length-1),expectedChecksum=gsChecksum(dumpString),receivedChecksum=msg[msg.length-1];if(expectedChecksum!=receivedChecksum){console.warn(`Yamaha DX7 dump SysEx checksum mismatch! Expected ${expectedChecksum}, but got ${receivedChecksum}:
`,msg);return}else dxDump.run(dumpString)}),dxDump.add([0,14,31],msg=>{__privateGet(upThis,_cc)[allocated.cc*msg[0]+ccToPos2[64]]=0,__privateGet(upThis,_ua).ano(msg[0]),upThis.switchMode("xg"),console.debug(`Yamaha DX7+ reset CH${msg[0]+1}.`)}).add([56,76,112],async msg=>{let part=msg[0],voiceNameBuf="";msg.subarray(1).forEach((e,i)=>{i<10&&(voiceNameBuf+=String.fromCharCode(Math.max(e,32)))}),__privateGet(upThis,_prg)[part]=part&127,__privateGet(upThis,_cc)[allocated.cc*part+ccToPos2[0]]=35,__privateGet(upThis,_cc)[allocated.cc*part+ccToPos2[32]]=part>>7|2,upThis.dispatchEvent("voice",{part}),voiceNameBuf.length>0&&(voiceNameBuf=voiceNameBuf.trimRight(),console.debug(`DX7+ CH${part+1} dumped voice name: "${voiceNameBuf}"`))});let sysExDrumWrite=function(drumId,note,key,value){},sysExDrumsY=function(drumId,msg){let drumOff=drumId*allocated.dpn,note=msg[0],offset=msg[1];msg.subarray(2).forEach((e,i)=>{let ri=i+offset,commitSlot=-1;ri<16?([()=>{commitSlot=24},()=>{commitSlot=25},()=>{commitSlot=26},()=>{},()=>{commitSlot=28},()=>{commitSlot=29},()=>{commitSlot=30},()=>{commitSlot=31},()=>{},()=>{},()=>{},()=>{commitSlot=20},()=>{commitSlot=21},()=>{commitSlot=22},()=>{commitSlot=23},()=>{}][ri]||(()=>{console.debug(`Unknown XG-style drum param ${ri} on set ${drumId+1}.`)}))():ri<32||(ri<40?([()=>{commitSlot=48},()=>{commitSlot=49},!1,!1,()=>{commitSlot=52},()=>{commitSlot=53}][ri-32]||(()=>{console.debug(`Unknown XG-style drum param ${ri} on set ${drumId+1}.`)}))():ri<80||([()=>{commitSlot=36}][ri-80]||(()=>{console.debug(`Unknown XG-style drum param ${ri} on set ${drumId+1}.`)}))()),commitSlot>=0?(getDebugState()&&console.debug(drumOff,commitSlot,note,e),__privateGet(upThis,_drum)[(drumOff+dnToPos[commitSlot])*allocated.dnc+note]=e):getDebugState()&&console.debug(`XG-style drum param ${ri} has no writes.`)})},sysExDrumsR=function(drumId,param,msg){let drumOff=drumId*allocated.dpn,offset=(param<<7)+msg[0];msg.subarray(1).forEach((e,i)=>{let ri=i+offset,note=ri&127,key=ri>>7,commitSlot=-1;key>1&&([()=>{commitSlot=26},()=>{},()=>{commitSlot=28},()=>{commitSlot=29},()=>{commitSlot=30},()=>{},()=>{},()=>{commitSlot=31}][key-2]||(()=>{console.debug(`Unknown GS-style drum param ${key} on set ${drumId+1}.`)}))(),commitSlot>-1?(getDebugState()&&console.debug(drumOff,commitSlot,note,e),__privateGet(upThis,_drum)[(drumOff+dnToPos[commitSlot])*allocated.dnc+note]=e):getDebugState()&&console.debug(`GS-style drum param ${key} has no writes.`)})};__privateGet(this,_seXg).add([76,48],(msg,track,id)=>{sysExDrumsY(0,msg)}).add([76,49],(msg,track,id)=>{sysExDrumsY(1,msg)}).add([76,50],(msg,track,id)=>{sysExDrumsY(2,msg)}).add([76,51],(msg,track,id)=>{sysExDrumsY(3,msg)}).add([76,52],(msg,track,id)=>{sysExDrumsY(4,msg)}).add([76,53],(msg,track,id)=>{sysExDrumsY(5,msg)}).add([76,54],(msg,track,id)=>{sysExDrumsY(6,msg)}).add([76,55],(msg,track,id)=>{sysExDrumsY(7,msg)}),__privateGet(this,_seXg).add([89,0],(msg,track,id)=>{if(upThis.eprom){let length=msg[0],addr=(msg[1]<<14)+(msg[2]<<7)+msg[3]+(upThis.eprom.offset||0);getDebugState()&&console.debug(`MU1000 EPROM trail to 0x${addr.toString(16).padStart(6,"0")}, ${length} bytes.`);let target=upThis.eprom.data;msg.subarray(4).forEach((e,i)=>{let secId=i>>3,secIdx=i&7;if(secIdx==7)for(let bi=0;bi<7;bi++)target[addr+7*secId+bi]+=(e>>6-bi&1)<<7;else target[addr+7*secId+secIdx]=e})}}).add([89,1],(msg,track,id)=>{let addr=(msg[0]<<21)+(msg[1]<<14)+(msg[2]<<7)+msg[3];getDebugState()&&console.debug(`MU1000 EPROM jump to 0x${addr.toString(16).padStart(6,"0")}.`),upThis.eprom&&(upThis.eprom.offset=addr)}).add([89,2],(msg,track,id)=>{if(upThis.eprom){let addr=(msg[0]<<21)+(msg[1]<<14)+(msg[2]<<7)+msg[3]+(upThis.eprom.offset||0);getDebugState()&&console.debug(`MU1000 EPROM write to 0x${addr.toString(16).padStart(6,"0")}.`);let target=upThis.eprom.data;msg.subarray(4).forEach((e,i)=>{let secId=i>>3,secIdx=i&7;if(secIdx==7)for(let bi=0;bi<7;bi++)target[addr+7*secId+bi]+=(e>>6-bi&1)<<7;else target[addr+7*secId+secIdx]=e})}}).add([89,3],(msg,track,id)=>{}),__privateGet(this,_seXg).add([39,48],(msg,track,id)=>{}).add([43,0,0],(msg,track,id)=>{let mTune=[0,0,0,0],writeTune=(e,i)=>{mTune[i]=e};if(msg.subarray(1).forEach((e,i)=>{let addr=i+msg[0];[writeTune,writeTune,writeTune,writeTune,()=>{__privateSet(this,_masterVol,e*129/16383*100),upThis.dispatchEvent("mastervolume",__privateGet(upThis,_masterVol))},()=>e-64,()=>e||128,()=>e,()=>e,()=>{console.debug(`TG300 variation on cc${e}.`)}][addr](e,addr)}),msg[0]<4){let rTune=0;mTune.forEach(e=>{rTune=rTune<<4,rTune+=e}),rTune-=1024}}).add([43,1,0],(msg,track,id)=>{}).add([43,2],(msg,track,id)=>{let part=upThis.chRedir(msg[0],track,!0),offset=msg[1],chOff=allocated.cc*part,dPref=`TG300 CH${part+1} `;msg.subarray(2).forEach((e,i)=>{i<5?([()=>{},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=e,upThis.dispatchEvent("voice",{part})},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[32]]=e,upThis.dispatchEvent("voice",{part})},()=>{__privateGet(upThis,_prg)[part]=e,upThis.dispatchEvent("voice",{part})},()=>{let ch=upThis.chRedir(e,track,!0);__privateGet(upThis,_chReceive)[part]=ch,part!=ch&&(upThis.buildRchTree(),console.info(`${dPref}receives from CH${ch+1}`))}][i+offset]||(()=>{}))(e,i+offset):i<21||(i<47?([()=>{__privateGet(upThis,_mono)[part]=+!e},()=>{},()=>{},()=>{__privateGet(upThis,_rpn)[allocated.rpn*part+3]=e,__privateGet(upThis,_rpnt)[allocated.rpnt*part+2]=1},()=>{},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[7]]=e},!1,!1,()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[10]]=e||128},!1,!1,()=>{console.debug(`${dPref} AC1 at cc${e}`)},()=>{console.debug(`${dPref} AC2 at cc${e}`)},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[128]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[93]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[91]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[94]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[76]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[77]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[74]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[71]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[73]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[75]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[72]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[78]]=e}][i+offset-21]||(()=>{}))(e,i+offset):i<95||([()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[65]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[5]]=e}][i+offset-95]||(()=>{}))(e,i+offset))})}).add([43,7,0],(msg,track,id)=>{let offset=msg[0];upThis.setLetterDisplay(msg.subarray(1),"TG300 letter display",offset)}).add([43,7,1],(msg,track,id)=>{__privateSet(upThis,_bitmapPage,0),__privateSet(upThis,_bitmapExpire,Date.now()+3200),__privateGet(upThis,_bitmap,bitmap_get).fill(0),msg.forEach(function(e,i){let ln=Math.floor(i/16),co=i%16,pt=(co*3+ln)*7,threshold=7,bi=0;for(pt-=co*5,ln==2&&(threshold=2);bi<threshold;)__privateGet(upThis,_bitmap,bitmap_get)[pt+bi]=e>>6-bi&1,bi++})}),__privateGet(this,_seGs).add([66,18,0,0,127],(msg,track,id)=>{upThis.switchMode("gs",!0),__privateGet(upThis,_cc)[allocated.cc*9]=120,__privateGet(upThis,_cc)[allocated.cc*25]=120,__privateGet(upThis,_cc)[allocated.cc*41]=120,__privateGet(upThis,_cc)[allocated.cc*57]=120,__privateSet(upThis,_subLsb,3),__privateSet(upThis,_modeKaraoke,!1),__privateGet(upThis,_trkRedir).fill(0),console.info(`GS system to ${["single","dual"][msg[0]]} mode.`)}).add([66,18,64,0],(msg,track,id)=>{switch(msg[0]){case 127:{upThis.switchMode("gs",!0),__privateGet(upThis,_cc)[allocated.cc*9]=120,__privateGet(upThis,_cc)[allocated.cc*25]=120,__privateGet(upThis,_cc)[allocated.cc*41]=120,__privateGet(upThis,_cc)[allocated.cc*57]=120,__privateSet(upThis,_modeKaraoke,!1),__privateGet(upThis,_trkRedir).fill(0),console.info("MIDI reset: GS");break}default:{let mTune=[0,0,0,0],writeTune=(e,i)=>{mTune[i]=e};if(msg.subarray(1).forEach((e,i)=>{let addr=i+msg[0];[writeTune,writeTune,writeTune,writeTune,e2=>{__privateSet(this,_masterVol,e2*129/16383*100),upThis.dispatchEvent("mastervolume",__privateGet(upThis,_masterVol))},e2=>{},e2=>{}][addr](e,i)}),msg[0]<4){let rTune=0;mTune.forEach(e=>{rTune=rTune<<4,rTune+=e}),rTune-=1024}}}}).add([66,18,64,1],msg=>{let offset=msg[0];if(offset<16){let string="".padStart(offset," ");msg.subarray(1).forEach((e,i)=>{string+=String.fromCharCode(Math.max(32,e))}),string=string.padEnd(16," "),console.debug(`GS patch name: ${string}`)}else offset<48||(offset<65?msg.subarray(1).forEach((e,i)=>{let dPref=`GS ${offset+i>55?"chorus":"reverb"} `;([()=>{console.info(`${dPref}type: ${gsRevType[e]}`),upThis.setEffectType(0,40,e),upThis.dispatchEvent("efxreverb",upThis.getEffectType(0))},()=>{},()=>{},()=>{},()=>{},()=>{},!1,()=>{console.debug(`${dPref}predelay: ${e}ms`)},()=>{console.info(`${dPref}type: ${gsChoType[e]}`),upThis.setEffectType(1,40,16+e),upThis.dispatchEvent("efxchorus",upThis.getEffectType(1))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${dPref}to reverb: ${toDecibel(e)}`)},()=>{console.debug(`${dPref}to delay: ${toDecibel(e)}`)}][offset+i-48]||(()=>{}))()}):offset<80?console.debug(`Unknown GS patch address: ${offset}`):offset<91?msg.subarray(1).forEach((e,i)=>{let dPref="GS delay ";([()=>{console.info(`${dPref}type: ${gsDelType[e]}`),upThis.setEffectType(2,40,32+e),upThis.dispatchEvent("efxdelay",upThis.getEffectType(2))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${dPref}to reverb: ${toDecibel(e)}`)}][offset+i-80]||(()=>{}))()}):console.debug(`Unknown GS patch address: ${offset}`))}).add([66,18,64,2],msg=>{let dPref="GS EQ ";msg.subarray(1).forEach((e,i)=>{([()=>{console.debug(`${dPref}low freq: ${[200,400][e]}Hz`)},()=>{console.debug(`${dPref}low gain: ${e-64}dB`)},()=>{console.debug(`${dPref}high freq: ${[3e3,6e3][e]}Hz`)},()=>{console.debug(`${dPref}high gain: ${e-64}dB`)}][msg[0]+i]||function(){console.warn(`Unknown GS EQ address: ${msg[0]+i}`)})()})}).add([66,18,64,3],msg=>{let dPref="GS EFX ",prefDesc=function(e,i){let desc=getGsEfxDesc(__privateGet(upThis,_efxBase).subarray(10,12),i,e);desc&&console.debug(`${dPref}${getGsEfx(__privateGet(upThis,_efxBase).subarray(10,12))} ${desc}`)};msg.subarray(1).forEach((e,i)=>{([()=>{upThis.setEffectTypeRaw(3,!1,32+e),upThis.dispatchEvent("efxinsert0",upThis.getEffectType(3))},()=>{upThis.setEffectTypeRaw(3,!0,e),console.info(`${dPref}type: ${getGsEfx(__privateGet(upThis,_efxBase).subarray(10,12))}`),upThis.dispatchEvent("efxinsert0",upThis.getEffectType(3))},!1,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,()=>{console.debug(`${dPref}to reverb: ${toDecibel(e)}dB`)},()=>{console.debug(`${dPref}to chorus: ${toDecibel(e)}dB`)},()=>{console.debug(`${dPref}to delay: ${toDecibel(e)}dB`)},!1,()=>{console.debug(`${dPref}1 source: ${e}`),e&&e<96&&upThis.allocateAce(e)},()=>{console.debug(`${dPref}1 depth: ${e-64}`)},()=>{console.debug(`${dPref}2 source: ${e}`),e&&e<96&&upThis.allocateAce(e)},()=>{console.debug(`${dPref}2 depth: ${e-64}`)},()=>{console.debug(`${dPref}to EQ: ${e?"ON":"OFF"}`)}][msg[0]+i]||function(e2,i2){console.warn(`Unknown GS EFX address: ${i2}`)})(e,msg[0]+i)})}).add([66,18,65],msg=>{sysExDrumsR((msg[0]>>4)+1<<1,msg[0]&15,msg.subarray(1))}).add([69,18,16],msg=>{var _a5;switch(msg[0]){case 0:{let offset=msg[1];upThis.setLetterDisplay(msg.subarray(2),"GS display text",offset);break}case 32:{__privateSet(upThis,_bitmapExpire,Date.now()+3200),msg[1]==0&&(__privateSet(upThis,_bitmapPage,Math.max(Math.min(msg[2]-1,9),0)),getDebugState()&&console.debug(`GS switch display page ${msg[2]-1}.`));break}default:if(msg[0]<6){__privateGet(upThis,_bitmapPage)>9&&__privateSet(upThis,_bitmapPage,0);let realPage=msg[0]-1<<1|msg[1]>>6;__privateGet(upThis,_bitmapPage)==realPage&&__privateSet(upThis,_bitmapExpire,Date.now()+3200),(_a5=__privateGet(upThis,_bitmapStore)[realPage])!=null&&_a5.length||(__privateGet(upThis,_bitmapStore)[realPage]=new Uint8Array(256));let target=__privateGet(upThis,_bitmapStore)[realPage];getDebugState()&&console.debug(`GS frame draw page ${realPage}.`);let offset=msg[1]&63;target.fill(0),msg.subarray(2).forEach(function(e,ii){let i=ii+offset,ln=Math.floor(i/16),co=i%16,pt=(co*4+ln)*5,threshold=5,bi=0;for(pt-=co*4,ln==3&&(threshold=1);bi<threshold;)target[pt+bi]=e>>4-bi&1,bi++})}else console.warn(`Unknown GS display section: ${msg[0]}`)}});let gsPartSec=function(msg,part,track){let offset=msg[0],chOff=allocated.cc*part,rpnOff=allocated.rpn*part,dPref=`GS CH${part+1} `;offset<3?(msg.subarray(1).forEach((e,i)=>{[()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=e},()=>{__privateGet(upThis,_prg)[part]=e},()=>{let ch=0;e<16?ch=upThis.chRedir(e,track,!0):ch=allocated.ch,__privateGet(upThis,_chReceive)[part]=ch,part!=ch&&(upThis.buildRchTree(),console.info(`${dPref}receives from CH${ch+1}`))}][offset+i]()}),upThis.dispatchEvent("voice",{part})):offset<19||(offset<44?msg.subarray(1).forEach((e,i)=>{([()=>{__privateGet(upThis,_mono)[part]=+!e},!1,()=>{upThis.setChType(part,e<<1,modeMap.gs),console.debug(`${dPref}type: ${e?"drum ":"melodic"}${e||""}`)},()=>{__privateGet(upThis,_rpn)[rpnOff+3]=e,__privateGet(upThis,_rpnt)[allocated.rpnt*part+2]=1},!1,()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[7]]=e},!1,!1,()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[10]]=e||128},!1,!1,()=>{console.debug(`${dPref}CC 1: cc${e}`)},()=>{console.debug(`${dPref}CC 2: cc${e}`)},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[93]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[91]]=e},!1,!1,()=>{__privateGet(upThis,_rpn)[rpnOff+1]=e,__privateGet(upThis,_rpnt)[allocated.rpnt*part+1]=1},()=>{__privateGet(upThis,_rpn)[rpnOff+2]=e,__privateGet(upThis,_rpnt)[allocated.rpnt*part+1]=1},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[94]]=e}][offset+i-19]||(()=>{}))()}):offset<76||console.debug(`Unknown GS part address: ${offset}`))},gsMiscSec=function(msg,part){let offset=msg[0],dPref=`GS CH${part+1} `;offset<2?msg.subarray(1).forEach((e,i)=>{[()=>{__privateGet(upThis,_cc)[allocated.cc*part+ccToPos2[32]]=e},()=>{}][offset+i]()}):offset<32?console.warn(`Unknown GS misc address: ${offset}`):offset<35?msg.subarray(1).forEach((e,i)=>{[()=>{console.debug(`${dPref}EQ: o${["ff","n"][e]}`)},()=>{},()=>{console.debug(`${dPref}EFX: o${["ff","n"][e]}`),__privateGet(upThis,_efxTo)[part]=e,upThis.dispatchEvent("partefxtoggle",{part,active:e})}][offset+i-32]()}):console.warn(`Unknown GS misc address: ${offset}`)};__privateGet(this,_seGs).add([66,18,64,16],(msg,track)=>{gsPartSec(msg,upThis.chRedir(9,track,!0),track)}).add([66,18,64,17],(msg,track)=>{gsPartSec(msg,upThis.chRedir(0,track,!0),track)}).add([66,18,64,18],(msg,track)=>{gsPartSec(msg,upThis.chRedir(1,track,!0),track)}).add([66,18,64,19],(msg,track)=>{gsPartSec(msg,upThis.chRedir(2,track,!0),track)}).add([66,18,64,20],(msg,track)=>{gsPartSec(msg,upThis.chRedir(3,track,!0),track)}).add([66,18,64,21],(msg,track)=>{gsPartSec(msg,upThis.chRedir(4,track,!0),track)}).add([66,18,64,22],(msg,track)=>{gsPartSec(msg,upThis.chRedir(5,track,!0),track)}).add([66,18,64,23],(msg,track)=>{gsPartSec(msg,upThis.chRedir(6,track,!0),track)}).add([66,18,64,24],(msg,track)=>{gsPartSec(msg,upThis.chRedir(7,track,!0),track)}).add([66,18,64,25],(msg,track)=>{gsPartSec(msg,upThis.chRedir(8,track,!0),track)}).add([66,18,64,26],(msg,track)=>{gsPartSec(msg,upThis.chRedir(10,track,!0),track)}).add([66,18,64,27],(msg,track)=>{gsPartSec(msg,upThis.chRedir(11,track,!0),track)}).add([66,18,64,28],(msg,track)=>{gsPartSec(msg,upThis.chRedir(12,track,!0),track)}).add([66,18,64,29],(msg,track)=>{gsPartSec(msg,upThis.chRedir(13,track,!0),track)}).add([66,18,64,30],(msg,track)=>{gsPartSec(msg,upThis.chRedir(14,track,!0),track)}).add([66,18,64,31],(msg,track)=>{gsPartSec(msg,upThis.chRedir(15,track,!0),track)}).add([66,18,64,64],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(9,track,!0))}).add([66,18,64,65],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(0,track,!0))}).add([66,18,64,66],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(1,track,!0))}).add([66,18,64,67],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(2,track,!0))}).add([66,18,64,68],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(3,track,!0))}).add([66,18,64,69],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(4,track,!0))}).add([66,18,64,70],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(5,track,!0))}).add([66,18,64,71],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(6,track,!0))}).add([66,18,64,72],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(7,track,!0))}).add([66,18,64,73],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(8,track,!0))}).add([66,18,64,74],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(10,track,!0))}).add([66,18,64,75],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(11,track,!0))}).add([66,18,64,76],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(12,track,!0))}).add([66,18,64,77],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(13,track,!0))}).add([66,18,64,78],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(14,track,!0))}).add([66,18,64,79],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(15,track,!0))}),__privateGet(this,_seAi).add([54,65],(msg,track)=>{upThis.switchMode("x5d");let checksum=msg[msg.length-1],msgData=msg.subarray(0,msg.length-1),expected=gsChecksum(msgData);expected!=checksum&&(console.info(`X5D multi parameters checksum mismatch! Expected ${expected}, got ${checksum}.`),console.debug(msg));let key=(msg[1]<<7)+msg[0],e=(msg[3]<<7)+msg[2],part=upThis.chRedir(key&15,track,!0),chOff=allocated.cc*part;[()=>{e<1||(e<101?(upThis.setChType(part,upThis.CH_MELODIC,modeMap.x5d),__privateGet(upThis,_prg)[part]=e-1,__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=__privateGet(upThis,_detect).x5):e<229?(upThis.setChType(part,upThis.CH_MELODIC,modeMap.x5d),__privateGet(upThis,_prg)[part]=e-101,__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=56):(upThis.setChType(part,upThis.CH_DRUMS,modeMap.x5d),__privateGet(upThis,_prg)[part]=korgDrums[e-229]||0,__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=62)),upThis.dispatchEvent("voice",{part})},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[7]]=e},()=>{e<31&&(__privateGet(upThis,_cc)[chOff+ccToPos2[10]]=Math.round((e-15)*4.2+64))},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[93]]=x5dSendLevel(e)},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[91]]=x5dSendLevel(e)},()=>{__privateGet(upThis,_rpn)[part*allocated.rpn+3]=e>8191?e-16320:64+e,__privateGet(upThis,_rpnt)[allocated.rpnt*part+2]=1},()=>{__privateGet(upThis,_rpn)[part*allocated.rpn+1]=e>8191?e-16320:64+e,__privateGet(upThis,_rpnt)[allocated.rpnt*part+1]=1},()=>{e>0&&(__privateGet(upThis,_rpn)[part*allocated.rpn]=e,__privateGet(upThis,_rpnt)[allocated.rpnt*part]=1)},()=>{}][key>>4]()}).add([54,76,0],(msg,track)=>{upThis.switchMode(__privateGet(upThis,_detect).x5=="81"?"05rw":"x5d",!0);let name2="",msb=__privateGet(upThis,_detect).x5,prg=0,lsb=0,voiceMap="MSB\tPRG\tLSB\tNME";korgFilter(msg,function(e,i){if(i<16400){let p=i%164;switch(!0){case p<10:{e>31&&(name2+=String.fromCharCode(e));break}case p==10:break;case p==11:{voiceMap+=`
${msb}	${prg}	${lsb}	${name2.trim().replace("Init Voice","")}`,prg++,name2="";break}}prg>99&&(msb=90,prg=0)}}),upThis.userBank.clearRange({msb:__privateGet(upThis,_detect).x5,prg:[0,99],lsb:0}),upThis.userBank.load(voiceMap),getDebugState()&&console.debug(voiceMap),upThis.forceVoiceRefresh()}).add([54,77,0],(msg,track)=>{upThis.switchMode(__privateGet(upThis,_detect).x5=="81"?"05rw":"x5d",!0);let name2="",msb=90,prg=0,lsb=0,voiceMap="MSB\tPRG\tLSB\tNME";korgFilter(msg,function(e,i){if(i<13600){let p=i%136;switch(!0){case p<10:{e>31&&(name2+=String.fromCharCode(e));break}case p==11:{voiceMap+=`
${msb}	${prg}	${lsb}	${name2.trim().replace("Init Combi","")}`,prg++,name2="";break}}}}),upThis.userBank.clearRange({msb:90,prg:[0,99],lsb:0}),upThis.userBank.load(voiceMap),getDebugState()&&console.debug(voiceMap),upThis.forceVoiceRefresh()}).add([54,78],(msg,track)=>{upThis.switchMode(__privateGet(upThis,_detect).x5=="81"?"05rw":"x5d",!0),console.debug(`X5D mode switch requested: ${["combi","combi edit","prog","prog edit","multi","global"][msg[0]]} mode.`)}).add([54,85],(msg,track)=>{upThis.switchMode(__privateGet(upThis,_detect).x5=="81"?"05rw":"x5d",!0),korgFilter(msg,(e,i)=>{i>0&&i<3&&(upThis.setEffectType(i-1,44,e),upThis.dispatchEvent(`efx${["reverb","chorus"][i-1]}`,upThis.getEffectType(i-1)))})}).add([54,104],(msg,track)=>{upThis.switchMode(__privateGet(upThis,_detect).x5=="81"?"05rw":"x5d",!0),korgFilter(msg,function(e,i,a,ri){if(i<192){let part=upThis.chRedir(Math.floor(i/12),track,!0),chOff=part*allocated.cc;switch(i%12){case 0:{e<128?(upThis.setChType(part,upThis.CH_MELODIC,modeMap.x5d),__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=__privateGet(upThis,_detect).x5,__privateGet(upThis,_prg)[part]=e):(upThis.setChType(part,upThis.CH_DRUMS,modeMap.x5d),__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=62,__privateGet(upThis,_prg)[part]=korgDrums[e-128]),e>0&&upThis.setChActive(part,1),upThis.dispatchEvent("voice",{part});break}case 1:{__privateGet(upThis,_cc)[chOff+ccToPos2[7]]=e;break}case 2:{__privateGet(upThis,_rpn)[part*allocated.rpn+3]=e>127?e-192:64+e,__privateGet(upThis,_rpnt)[allocated.rpnt*part+2]=1;break}case 3:{__privateGet(upThis,_rpn)[part*allocated.rpn+1]=e>127?e-192:64+e,__privateGet(upThis,_rpnt)[allocated.rpnt*part+1]=1;break}case 4:{e<31&&(__privateGet(upThis,_cc)[chOff+ccToPos2[10]]=Math.round((e-15)*4.2+64));break}case 5:{let choSend=e>>4,revSend=e&15;__privateGet(upThis,_cc)[chOff+ccToPos2[91]]=x5dSendLevel(revSend),__privateGet(upThis,_cc)[chOff+ccToPos2[93]]=x5dSendLevel(choSend);break}case 10:break;case 11:{let midiCh=upThis.chRedir(e&15,track,!0),trkSw=e>>4;__privateGet(upThis,_chReceive)[part]=e,(midiCh!=part||trkSw)&&(console.info(`X5D Part CH${part+1} receives from CH${midiCh+1}.`),upThis.buildRchTree())}}}else{let part=upThis.chRedir(i-192,track,!0)}})}),__privateGet(this,_seGs).add([22,18,127],msg=>{upThis.switchMode("mt32",!0),__privateSet(upThis,_modeKaraoke,!1),upThis.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),console.info("MIDI reset: MT-32")}).add([22,18,0],(msg,track,id)=>{upThis.switchMode("mt32");let part=upThis.chRedir(id,track,!0),offset=msg[1];msg.subarray(2).forEach((e,i)=>{let ri=i+offset;__privateGet(upThis,_cmTPatch)[ri+(part-1)*16]=e,([!1,()=>{let timbreGroup=__privateGet(upThis,_cmTPatch)[part-1<<4];if(timbreGroup<3){if(__privateGet(upThis,_bnCustom)[part]=1,timbreGroup==2)for(let c=0;c<name.length;c++)__privateGet(upThis,_cmTTimbre)[(part-1)*allocated.cmt+c]=__privateGet(upThis,_cmTimbre)[e*allocated.cmt+c];else{let name2=upThis.baseBank.get(0,e+(timbreGroup<<6),127,"mt32").name;for(let c=0;c<name2.length;c++)__privateGet(upThis,_cmTTimbre)[(part-1)*allocated.cmt+c]=name2.charCodeAt(c)}upThis.dispatchEvent("voice",{part})}},()=>{__privateGet(upThis,_rpn)[part*allocated.rpn+3]=e+40,__privateGet(upThis,_rpnt)[allocated.rpnt*part+2]=1},()=>{__privateGet(upThis,_rpn)[part*allocated.rpn+1]=e+14,__privateGet(upThis,_rpnt)[allocated.rpnt*part+1]=1},()=>{__privateGet(upThis,_rpn)[part*allocated.rpn]=e,__privateGet(upThis,_rpnt)[allocated.rpnt*part]=1},!1,()=>{__privateGet(upThis,_cc)[allocated.cc*part+ccToPos2[91]]=e?127:0},!1,()=>{__privateGet(upThis,_cc)[allocated.cc*part+ccToPos2[7]]=e},()=>{__privateGet(upThis,_cc)[allocated.cc*part+ccToPos2[10]]=Math.ceil(e*9.05)}][ri]||(()=>{}))()})}).add([22,18,1],(msg,track,id)=>{upThis.switchMode("mt32");let slot=id&7;console.debug(`MT-32 slot #${id+1} Drum: ${msg}`);let offset=msg[0]<<7|msg[1];msg.subarray(2).forEach((e,i)=>{let ri=i+offset,note=(ri>>2)+24,param=ri&3,drumOff=slot*allocated.dpn;if(getDebugState()&&console.debug(`MT-32 temp drum note ${note} param ${param}: ${e}`),note<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${note}`);return}[()=>{},()=>{__privateGet(upThis,_drum)[(drumOff+dnToPos[26])*allocated.dnc+note]=Math.round(e*1.27)},()=>{__privateGet(upThis,_drum)[(drumOff+dnToPos[26])*allocated.dnc+note]=e*9+1&127},()=>{__privateGet(upThis,_drum)[(drumOff+dnToPos[26])*allocated.dnc+note]=e?127:0}][param]()})}).add([22,18,2],(msg,track,id)=>{upThis.switchMode("mt32");let part=upThis.chRedir(id,track,!0),offset=msg[1]+(msg[0]<<7);offset<10&&(__privateGet(upThis,_bnCustom)[part]=1),msg.subarray(2).forEach((e,i)=>{let ri=i+offset;ri<14&&(__privateGet(upThis,_cmTTimbre)[(part-1)*allocated.cmt+ri]=e)}),upThis.dispatchEvent("voice",{part})}).add([22,18,3],(msg,track,id)=>{upThis.switchMode("mt32");let slot=id&7;if(msg[0]){let offset=(msg[0]-1<<7)+msg[1]-16;msg.subarray(2).forEach((e,i)=>{let ri=i+offset,note=(ri>>2)+24,param=ri&3,drumOff=slot*allocated.dpn;if(getDebugState()&&console.debug(`MT-32 dev drum note ${note} param ${param}: ${e}`),note<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${note}`);return}[()=>{},()=>{__privateGet(upThis,_drum)[(drumOff+dnToPos[26])*allocated.dnc+note]=Math.round(e*1.27)},()=>{__privateGet(upThis,_drum)[(drumOff+dnToPos[26])*allocated.dnc+note]=e*9+1&127},()=>{__privateGet(upThis,_drum)[(drumOff+dnToPos[26])*allocated.dnc+note]=e?127:0}][param]()})}else{let offset=msg[1];msg.subarray(2).forEach((e,i)=>{let ri=i+offset;__privateGet(upThis,_cmTPatch)[ri]=e;let part=upThis.chRedir(1+(ri>>4),track,!0),ptr=ri&15;([!1,()=>{let timbreGroup=__privateGet(upThis,_cmTPatch)[part-1<<4];if(timbreGroup<3)if(__privateGet(upThis,_bnCustom)[part]=1,timbreGroup==2)for(let c=0;c<name.length;c++)__privateGet(upThis,_cmTTimbre)[(part-1)*allocated.cmt+c]=__privateGet(upThis,_cmTimbre)[e*allocated.cmt+c];else{let name2=upThis.baseBank.get(0,e+(timbreGroup<<6),127,"mt32").name;for(let c=0;c<name2.length;c++)__privateGet(upThis,_cmTTimbre)[(part-1)*allocated.cmt+c]=name2.charCodeAt(c)}upThis.dispatchEvent("voice",{part})},()=>{__privateGet(upThis,_rpn)[part*allocated.rpn+3]=e+40,__privateGet(upThis,_rpnt)[allocated.rpnt*part+2]=1},()=>{__privateGet(upThis,_rpn)[part*allocated.rpn+1]=e+14,__privateGet(upThis,_rpnt)[allocated.rpnt*part+1]=1},()=>{__privateGet(upThis,_rpn)[part*allocated.rpn]=e,__privateGet(upThis,_rpnt)[allocated.rpnt*part]=1},!1,()=>{__privateGet(upThis,_cc)[allocated.cc*part+ccToPos2[91]]=e?127:0},!1,()=>{__privateGet(upThis,_cc)[allocated.cc*part+ccToPos2[7]]=e},()=>{__privateGet(upThis,_cc)[allocated.cc*part+ccToPos2[10]]=Math.ceil(e*9.05)}][ptr]||(()=>{}))()})}}).add([22,18,4],(msg,track,id)=>{upThis.switchMode("mt32");let offsetTotal=msg[1]+(msg[0]<<7),parts=[];msg.subarray(2).forEach((e,i)=>{let ri=i+offsetTotal,part=upThis.chRedir(Math.floor(ri/246+1),track,!0),offset=ri%246;offset<14&&(__privateGet(upThis,_cmTTimbre)[(part-1)*allocated.cmt+offset]=e),offset<10&&(__privateGet(upThis,_bnCustom)[part]=1),parts.indexOf(part)<0&&parts.push(part)}),parts.forEach(part=>{upThis.dispatchEvent("voice",{part})})}).add([22,18,5],(msg,track,id)=>{upThis.switchMode("mt32");let offset=(msg[0]<<7)+msg[1];msg.subarray(2).forEach((e,i)=>{let realIndex=offset+i,patch=Math.floor(realIndex/8),slot=realIndex&7,patchOff=patch*8;__privateGet(upThis,_cmPatch)[realIndex]=e,([!1,()=>{let timbreGroup=__privateGet(upThis,_cmPatch)[patchOff];if(timbreGroup<3){let name2="";if(timbreGroup==2){let timbreOff=allocated.cmt*patch;name2=`MT-m:${e.toString().padStart(3,"0")}`}else name2=upThis.baseBank.get(0,e+(timbreGroup<<6),127,"mt32").name;upThis.userBank.clearRange({msb:0,lsb:127,prg:patch});let loadTsv=`MSB	LSB	PRG	NME
000	127	${patch}	${name2}`;upThis.userBank.load(loadTsv,!0)}}][slot]||(()=>{}))()}),upThis.forceVoiceRefresh()}).add([22,18,8],(msg,track,id)=>{upThis.switchMode("mt32");let offset=((msg[0]&1)<<7)+msg[1];msg.subarray(2).forEach((e,i)=>{let ri=offset+i;ri<allocated.cmt&&(__privateGet(upThis,_cmTimbre)[(msg[0]>>1)*allocated.cmt+ri]=e)}),upThis.forceVoiceRefresh()}).add([22,18,16],(msg,track,id)=>{upThis.switchMode("mt32");let offset=msg[1],updateRch=!1,setMidiRch=function(e,i){__privateGet(upThis,_chReceive)[i-12]=e,updateRch=!0};msg.subarray(2).forEach((e,i)=>{let ri=i+offset;([!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,setMidiRch,setMidiRch,setMidiRch,setMidiRch,setMidiRch,setMidiRch,setMidiRch,setMidiRch,setMidiRch,()=>{__privateSet(upThis,_masterVol,e),upThis.dispatchEvent("mastervolume",__privateGet(upThis,_masterVol))}][ri]||(()=>{}))(e,i)}),updateRch&&upThis.buildRchTree()}).add([22,18,32],msg=>{upThis.switchMode("mt32");let offset=msg[1],text=" ".repeat(offset);msg.subarray(2).forEach(e=>{e>31?text+=String.fromCharCode(e):text+=" "}),__privateSet(upThis,_letterDisp,text.padStart(20," ")),__privateSet(upThis,_letterExpire,Date.now()+3200)}).add([22,18,82],(msg,track)=>{let partBase=upThis.chRedir(0,track,!0);for(let part=0;part<16;part++)__privateGet(upThis,_ua).ano(partBase+part),part&&part<10&&(__privateGet(upThis,_prg)[partBase+part]=mt32DefProg[part-1]);console.info("MT-32 alt reset complete.")}),__privateGet(this,_seAi).add([66,0],(msg,track)=>{upThis.switchMode("ns5r",!0),__privateSet(upThis,_modeKaraoke,!1),console.debug(`NS5R mode switch requested: ${["global","multi","prog edit","comb edit","drum edit","effect edit"][msg[0]]} mode.`)}).add([66,1],(msg,track)=>{upThis.switchMode(["ns5r","05rw"][msg[0]],!0),__privateSet(upThis,_modeKaraoke,!1)}).add([66,18,0,0],(msg,track)=>{let offset=msg[0];switch(offset){case 124:case 126:case 127:{upThis.switchMode("ns5r",!0),__privateSet(upThis,_modeKaraoke,!1);break}case 125:{upThis.initDrums(),console.info(`NS5R drum setup reset: ${msg}`);break}default:if(offset<10){let mTune=[0,0,0,0],writeTune=(e,i)=>{mTune[i]=e};if(msg.subarray(1).forEach((e,i)=>{[writeTune,writeTune,writeTune,writeTune,()=>{__privateSet(upThis,_masterVol,e*129/16383*100),upThis.dispatchEvent("mastervolume",__privateGet(upThis,_masterVol))},()=>e-64,()=>e-64,()=>{},()=>{},()=>{}][offset+i]()}),msg[0]<4){let rTune=0;mTune.forEach(e=>{rTune=rTune<<4,rTune+=e}),rTune-=1024}}}}).add([66,18,0,1],(msg,track)=>{}).add([66,18,0,2],(msg,track)=>{}).add([66,18,1],(msg,track)=>{let part=upThis.chRedir(msg[0],track,!0),chOff=part*allocated.cc,offset=msg[1],dPref=`NS5R CH${part+1} `;msg.subarray(2).forEach((e,i)=>{let c=offset+i;c<3?([()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=e||overrides.bank0},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[32]]=e},()=>{__privateGet(upThis,_prg)[part]=e}][c](),upThis.dispatchEvent("voice",{part})):c<8||(c<14?[()=>{let ch=upThis.chRedir(e,track,!0);__privateGet(upThis,_chReceive)[part]=ch,part!=ch&&(upThis.buildRchTree(),console.info(`${dPref}receives from CH${ch+1}`))},()=>{__privateGet(upThis,_mono)[part]=+!e},()=>{upThis.setChType(part,e,modeMap.ns5r),console.debug(`${dPref}type: ${xgPartMode[e]}`)},()=>{__privateGet(upThis,_rpn)[allocated.rpn*part+3]=e,__privateGet(upThis,_rpnt)[allocated.rpnt*part+2]=1},()=>{},()=>{}][c-8]():c<16||(c<33?[()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[7]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[11]]=e},()=>{},()=>{},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[10]]=e||128},()=>{},()=>{},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[93]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[91]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[76]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[77]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[78]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[74]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[71]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[73]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[75]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[72]]=e}][c-16]():c<112||c<114&&[()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[5]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[65]]=e}][c-112]()))})}).add([66,18,8,0],(msg,track)=>{let offset=msg[0];if(offset<32)upThis.setLetterDisplay(msg.subarray(1,33),"NS5R letter display");else{let bitOffset=offset-32;__privateSet(upThis,_bitmapExpire,Date.now()+3200),__privateSet(upThis,_bitmapPage,10),__privateGet(upThis,_bitmap,bitmap_get).fill(0);let workArr=msg.subarray(1),lastCol=4;workArr.forEach(function(e,i){let ri=i+bitOffset,tx=ri>>4,ty=ri&15;if(ri<80){let dummy=tx<lastCol?e:e>>3,shifted=0,perspective=tx<lastCol?6:3;for(;dummy>0;)__privateGet(upThis,_bitmap,bitmap_get)[ty*32+tx*7+(perspective-shifted)]=dummy&1,dummy=dummy>>1,shifted++}})}}).add([66,18,48],(msg,track,id)=>{sysExDrumsY(0,msg)}).add([66,18,49],(msg,track,id)=>{sysExDrumsY(1,msg)}).add([66,18,50],(msg,track,id)=>{sysExDrumsY(2,msg)}).add([66,18,51],(msg,track,id)=>{sysExDrumsY(3,msg)}).add([66,18,52],(msg,track,id)=>{sysExDrumsY(4,msg)}).add([66,18,53],(msg,track,id)=>{sysExDrumsY(5,msg)}).add([66,18,54],(msg,track,id)=>{sysExDrumsY(6,msg)}).add([66,18,55],(msg,track,id)=>{sysExDrumsY(7,msg)}).add([66,52],(msg,track)=>{upThis.switchMode("ns5r",!0),__privateSet(upThis,_modeKaraoke,!1);let efxName="";korgFilter(msg,(e,i)=>{i<8?(e>31&&(efxName+=String.fromCharCode(e)),i==7&&(upThis.aiEfxName=efxName)):i<10&&(upThis.setEffectType(i-8,44,e),upThis.dispatchEvent(`efx${["reverb","chorus"][i-8]}`,upThis.getEffectType(i-8)))})}).add([66,53],(msg,track)=>{upThis.switchMode("ns5r",!0),__privateSet(upThis,_modeKaraoke,!1);let efxName="",checksum=msg[msg.length-1],msgData=msg.subarray(0,msg.length-1),expected=gsChecksum(msgData);expected!=checksum&&(console.info(`NS5R current multi dump checksum mismatch! Expected ${expected}, got ${checksum}.`),console.debug(msg)),korgFilter(msgData,function(e,i){switch(!0){case i<2944:{let part=upThis.chRedir(Math.floor(i/92),track,!0),chOff=part*allocated.cc;switch(i%92){case 0:{__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=e,upThis.dispatchEvent("voice",{part});break}case 1:{__privateGet(upThis,_cc)[chOff+ccToPos2[32]]=e,!e&&!__privateGet(upThis,_cc)[chOff+ccToPos2[0]]&&(__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=overrides.bank0),upThis.dispatchEvent("voice",{part});break}case 2:{__privateGet(upThis,_prg)[part]=e,e>0&&upThis.setChActive(part,1),upThis.dispatchEvent("voice",{part});break}case 3:{let ch=upThis.chRedir(e,track,!0);__privateGet(upThis,_chReceive)[part]=ch,part!=ch&&(console.info(`NS5R CH${part+1} receives from CH${ch+1}.`),upThis.buildRchTree());break}case 7:{__privateGet(upThis,_chType)[part]=e,upThis.dispatchEvent("voice",{part});break}case 8:{__privateGet(upThis,_rpn)[part*allocated.rpn+3]=e<40||e>88?e+(e>63?-192:64):e,__privateGet(upThis,_rpnt)[allocated.rpnt*part+2]=1;break}case 9:case 10:{__privateGet(upThis,_cc)[chOff+ccToPos2[7]]=e;break}case 11:{__privateGet(upThis,_cc)[chOff+ccToPos2[11]]=e;break}case 14:{__privateGet(upThis,_cc)[chOff+ccToPos2[10]]=e||128;break}case 19:{__privateGet(upThis,_cc)[chOff+ccToPos2[93]]=e;break}case 20:{__privateGet(upThis,_cc)[chOff+ccToPos2[91]]=e;break}case 84:{__privateGet(upThis,_cc)[chOff+ccToPos2[65]]=e;break}case 85:{__privateGet(upThis,_cc)[chOff+ccToPos2[5]]=e;break}}break}case i<3096:break;case i<3134:{let ri=i-3096;ri<8?(e>31&&(efxName+=String.fromCharCode(e)),ri==7&&(upThis.aiEfxName=efxName)):ri<10&&(upThis.setEffectType(ri-8,44,e),upThis.dispatchEvent(`efx${["reverb","chorus"][ri-8]}`,upThis.getEffectType(ri-8)));break}case i<8566:break}})}).add([66,54],(msg,track)=>{upThis.switchMode("ns5r",!0);let name2="",msb=80,prg=0,lsb=0,voiceMap="MSB\tPRG\tLSB\tNME";korgFilter(msg,function(e,i){let p=i%158;switch(!0){case p<10:{e>31&&(name2+=String.fromCharCode(e));break}case p==10:break;case p==11:{msb=e&127;break}case p==12:{lsb=e&127;break}case p==13:{voiceMap+=`
${msb}	${prg}	${lsb}	${name2.trim().replace("Init Voice","")}`,prg++,name2="";break}}}),upThis.userBank.clearRange({msb:80,lsb:0}),upThis.userBank.load(voiceMap),getDebugState()&&console.debug(voiceMap),upThis.forceVoiceRefresh()}).add([66,55],(msg,track)=>{upThis.switchMode("ns5r",!0);let name2="",msb=88,prg=0,lsb=0,voiceMap="MSB\tPRG\tLSB\tNME";korgFilter(msg,function(e,i){let p=i%126;switch(!0){case p<10:{e>31&&(name2+=String.fromCharCode(e));break}case p==11:break;case p==12:break;case p==13:{voiceMap+=`
${msb}	${prg}	${lsb}	${name2.trim().replace("Init Combi","")}`,prg++,name2="";break}}}),upThis.userBank.clearRange({msb:88,lsb:0}),upThis.userBank.load(voiceMap),getDebugState()&&console.debug(voiceMap),upThis.forceVoiceRefresh()}).add([66,125],msg=>{upThis.dispatchEvent("backlight",["green","orange","red",!1,"yellow","blue","purple"][msg[0]]||"white")}).add([66,127],msg=>{let checksum=msg[msg.length-1],msgData=msg.subarray(0,msg.length-1),expected=gsChecksum(msgData);expected!=checksum&&(console.info(`NS5R screen dump checksum mismatch! Expected ${expected}, got ${checksum}.`),console.debug(msg));let screenBuffer=new Uint8Array(5760);korgFilter(msg,(e,i,a)=>{if(i<720)for(let bi=0;bi<8;bi++)screenBuffer[i*8+bi]=e>>7-bi&1}),upThis.dispatchEvent("screen",{type:"ns5r",data:screenBuffer})}).add([76],(msg,track,id)=>{__privateGet(upThis,_seAi).run([66,...msg],track,id)}),__privateGet(this,_seKg).add([16,0,8,0],(msg,track,id)=>{let e=(msg[2]<<4)+msg[3],dPref="K11 ";([()=>{upThis.switchMode("k11",!0),__privateSet(upThis,_modeKaraoke,!1),__privateSet(upThis,_subLsb,e?4:0),console.info("MIDI reset: GMega/K11")},()=>{upThis.setEffectType(0,24,e),console.debug(`${dPref}reverb type: ${e}`),upThis.dispatchEvent("efxreverb",upThis.getEffectType(0))},()=>{console.debug(`${dPref}reverb time: ${e}`)},()=>{console.debug(`${dPref}reverb time: ${e}`)},()=>{console.debug(`${dPref}reverb predelay: ${e}`)},()=>{console.debug(`${dPref}reverb predelay: ${e}`)},()=>{console.debug(`${dPref}depth high: ${e}`)},()=>{console.debug(`${dPref}depth high: ${e}`)},()=>{console.debug(`${dPref}depth low: ${e}`)},()=>{console.debug(`${dPref}depth low: ${e}`)}][msg[0]]||(()=>{}))()}).add([16,0,8,1],(msg,track,id)=>{let part=upThis.chRedir(msg[1],track,!0),chOff=allocated.cc*part,rpnOff=allocated.rpn*part,e=(msg[3]<<4)+msg[4],dPref=`K11 CH${part+1} `;([()=>{e<128?(upThis.setChType(part,upThis.CH_MELODIC,modeMap.k11),__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=0,__privateGet(upThis,_prg)[part]=e):(upThis.setChType(part,upThis.CH_DRUMS,modeMap.k11),__privateGet(upThis,_prg)[part]=e-128),upThis.dispatchEvent("voice",{part})},()=>{let ch=upThis.chRedir(e,track,!0);__privateGet(upThis,_chReceive)[part]=ch,part!=ch&&(upThis.buildRchTree(),console.info(`${dPref}receives from CH${ch+1}`))},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[7]]=e},()=>{uupThis.setChActive(part,e)},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[10]]=e},()=>{__privateGet(upThis,_rpn)[rpnOff+3]=e+40,__privateGet(upThis,_rpnt)[allocated.rpnt*part+2]=1},()=>{__privateGet(upThis,_rpn)[rpnOff+1]=e>>1,__privateGet(upThis,_rpn)[rpnOff+2]=e&1,__privateGet(upThis,_rpnt)[allocated.rpnt*part+1]=1},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[91]]=e?127:0},()=>{},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[74]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[73]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[72]]=e}][msg[0]]||(()=>{}))()}).add([16,0,9,0],(msg,track,id)=>{let e=(msg[2]<<4)+msg[3],dPref="GMLX ";([()=>{console.debug(`${dPref}reverb type: ${e}`)},()=>{console.debug(`${dPref}reverb time: ${e}`)},()=>{console.debug(`${dPref}reverb predelay: ${e}`)},()=>{console.debug(`${dPref}depth high: ${e}`)},()=>{console.debug(`${dPref}depth low: ${e}`)}][msg[0]]||(()=>{}))()}).add([16,0,9,3],(msg,track,id)=>{let e=(msg[2]<<4)+msg[3],part=upThis.chRedir(msg[1],track,!0),chOff=part*allocated.cc;[()=>{e<128?(upThis.setChType(part,upThis.CH_MELODIC,modeMap.k11),__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=0,__privateGet(upThis,_cc)[chOff+ccToPos2[32]]=0,__privateGet(upThis,_prg)[part]=e):e<160?(upThis.setChType(part,upThis.CH_MELODIC,modeMap.k11),__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=0,__privateGet(upThis,_cc)[chOff+ccToPos2[32]]=7,__privateGet(upThis,_prg)[part]=e-100):(upThis.setChType(part,upThis.CH_DRUMS,modeMap.k11),__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=122,__privateGet(upThis,_cc)[chOff+ccToPos2[32]]=0,__privateGet(upThis,_prg)[part]=e-160),upThis.dispatchEvent("voice",{part})},()=>{let ch=upThis.chRedir(e,track,!0);__privateGet(upThis,_chReceive)[part]=ch,part!=ch&&(upThis.buildRchTree(),console.info(`GMLX CH${part+1} receives from CH${ch+1}`))}][msg[0]]()}).add([16,0,9,4],(msg,track,id)=>{let e=(msg[2]<<4)+msg[3],part=upThis.chRedir(msg[1],track,!0),chOff=part*allocated.cc,rpnOff=part*allocated.rpn,dPref=`GMLX CH${part+1} `;[()=>{upThis.setChActive(part,e)},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[7]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[10]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[91]]=e?127:0},()=>{__privateGet(upThis,_rpn)[rpnOff+3]=e+40,__privateGet(upThis,_rpnt)[allocated.rpnt*part+2]=1},()=>{__privateGet(upThis,_rpn)[rpnOff+1]=e,__privateGet(upThis,_rpnt)[allocated.rpnt*part+1]=1},()=>{__privateGet(upThis,_rpn)[rpnOff]=e,__privateGet(upThis,_rpnt)[allocated.rpnt*part]=1},()=>{}][msg[0]]()}),__privateGet(this,_seSg).add([66,93,64],(msg,track,id)=>{let e=msg[2];switch(msg[0]){case 0:{switch(msg[1]){case 4:{__privateSet(upThis,_masterVol,e*129/16383*100),upThis.dispatchEvent("mastervolume",__privateGet(upThis,_masterVol));break}case 5:{e-64;break}case 6:{console.debug(`SG global reverb: ${e?"on":"off"}`);break}case 127:{upThis.switchMode("sg",!0);break}}break}case 1:{switch(msg[1]){case 48:{console.debug(`SG reverb type: ${gsRevType[e]}`);break}}break}default:if(msg[0]>>4==1){let part=upThis.chRedir(msg[0]&15,track,!0);if(msg[1]==2){let ch=upThis.chRedir(e,track,!0);__privateGet(upThis,_chReceive)[part]=ch,part!=ch&&(upThis.buildRchTree(),console.info(`SG CH${part+1} receives from CH${ch+1}`))}else msg[1]==19&&(__privateGet(upThis,_cc)[allocated.cc*part+ccToPos2[7]]=e)}else console.warn(`Unknown AKAI SG SysEx: ${msg}`)}}),__privateGet(this,_seCs).add([9],(msg,track,id)=>{console.debug(`GZ set effect: ${["stage reverb","hall reverb","room reverb","chorus","tremelo","phaser","rotary speaker","enhancer","flanger","EQ"][msg[0]]||"off"}`)}),__privateGet(this,_seXg).add([127,0],(msg,track,id)=>{upThis.switchMode("motif");let newMsg=new Uint8Array([127,1,...msg]);__privateGet(upThis,_seXg).run(newMsg,track,id)}).add([127,1,0,0],(msg,track,id)=>{upThis.switchMode("s90es");let dPref="S90/Motif ES system ",offset=msg[0];msg.subarray(1).forEach((e,i)=>{([()=>{__privateSet(upThis,_masterVol,e*12900/16383),upThis.dispatchEvent("mastervolume",__privateGet(upThis,_masterVol))}][offset+i]||(()=>{console.info(`Unrecognized ${dPref}ID: ${offset+i}`)}))()})}).add([127,1,0,0,14],(msg,track,id)=>{upThis.switchMode("s90es");let dPref="S90/Motif ES bulk header ",addrSet=[];addrSet[95]=(msg2,track2,id2)=>{console.debug(`${dPref}multi edit buffer: ${msg2[1]}`)},(addrSet[msg[0]]||(()=>{console.info(`Unrecognized ${dPref}ID: ${msg[0]}.`)}))(msg.subarray(1))}).add([127,1,0,0,15],(msg,track,id)=>{upThis.switchMode("s90es");let dPref="S90/Motif ES bulk footer ",addrSet=[];addrSet[95]=(msg2,track2,id2)=>{console.debug(`${dPref}multi edit buffer: ${msg2[1]}`)},(addrSet[msg[0]]||(()=>{console.info(`Unrecognized ${dPref}ID: ${msg[0]}.`)}))(msg.subarray(1))}).add([127,1,0,58,55],(msg,track,id)=>{upThis.switchMode("s90es");let part=upThis.chRedir(msg[0],track,!0),chOff=allocated.cc*part,offset=msg[1],dPref=`S90/Motif ES bulk CH${part<16?part+1:"U"+(part-95)} `;console.debug(dPref,msg),!(msg[0]>15)&&msg.subarray(2).forEach((e,i)=>{([()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=e,upThis.dispatchEvent("voice",{part})},()=>{e&&upThis.setChActive(part,1),__privateGet(upThis,_cc)[chOff+ccToPos2[32]]=e,upThis.setChType(part,[32,40].indexOf(e)>-1?upThis.CH_DRUMS:upThis.CH_MELODIC,__privateGet(upThis,_mode),!0),upThis.dispatchEvent("voice",{part})},()=>{e&&upThis.setChActive(part,1),__privateGet(upThis,_prg)[part]=e,upThis.dispatchEvent("voice",{part})},()=>{let ch=upThis.chRedir(e,track,!0);__privateGet(upThis,_chReceive)[part]=ch,part!=ch&&(upThis.buildRchTree(),console.info(`${dPref}receives from CH${ch+1}`))},()=>{__privateGet(upThis,_mono)[part]=e?0:1},!1,!1,!1,!1,!1,!1,!1,!1,()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[7]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[10]]=e},!1,!1,!1,()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[91]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[93]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[94]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[128]]=e},()=>{},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[74]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[71]]=e},!1,()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[65]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[5]]=e},()=>{}][offset+i]||(()=>{}))()})}).add([127,1,54,16],(msg,track,id)=>{upThis.switchMode("s90es");let offset=msg[0];msg.subarray(1).forEach((e,i)=>{let dPref=`S90/Motif ES EQ${(i>>2)+1} `;([()=>{let eqGain=e-64},()=>{let eqFreq=xgNormFreq[e]},()=>{let eqQFac=e/10},()=>{let eqType=e}][offset+i&3]||(()=>{}))()})}),__privateGet(this,_seGs).add([0,72,18,0,0,0,0],(msg,track,id)=>{upThis.switchMode("sd",!0),console.info("MIDI reset: SD")}).add([0,72,18,16,0],(msg,track,id)=>{let type=msg[0]>>5,channel=msg[0]&31;switch(type){case 0:{let slot=msg[0]>>1,offset=msg[1];switch(slot){case 1:{msg.subarray(2).forEach((e,i,a)=>{let ri=i+offset;switch(ri){case 0:{e&&(upThis.setEffectType(1,60,e-1),upThis.dispatchEvent("efxchorus",upThis.getEffectType(1)),console.debug(`SD MFX Cho: ${ri} - ${e}`));break}}});break}case 2:{msg.subarray(2).forEach((e,i)=>{let ri=i+offset;switch(ri){case 0:{e&&(upThis.setEffectType(0,55+e,0),upThis.dispatchEvent("efxreverb",upThis.getEffectType(0)),console.debug(`SD MFX Rev: ${ri} - ${e}`));break}}});break}case 3:case 4:case 5:{let efxSink=slot-1;msg.subarray(2).forEach((e,i)=>{let ri=i+offset;switch(console.debug(`SD MFX ${efxSink-2}: ${ri} - ${e}`),ri){case 0:{upThis.setEffectTypeRaw(efxSink,62,e),upThis.dispatchEvent(`efx${efxSink>2?"delay":"insert"+(efxSink-4)}`,upThis.getEffectType(efxSink));break}}}),console.debug(`SD MFX message:
%o`,msg);break}default:console.debug(`Unknown SD-90 global effects message:
%o`,msg)}break}case 1:{let part=upThis.chRedir(channel,track,!0),offset=msg[1],chOff=part*allocated.cc;msg.subarray(2).forEach((e,i)=>{let pointer=offset+i;pointer<37?([()=>{},()=>{},0,()=>{},()=>{switch(__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=e,e){case 104:case 105:case 106:case 107:case 120:{__privateGet(upThis,_chType)[part]||upThis.setChType(part,upThis.CH_DRUMS);break}default:__privateGet(upThis,_chType)[part]&&upThis.setChType(part,upThis.CH_MELODIC)}upThis.dispatchEvent("voice",{part})},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[32]]=e,upThis.dispatchEvent("voice",{part})},()=>{__privateGet(upThis,_prg)[part]=e,upThis.dispatchEvent("voice",{part})},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[7]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[10]]=e},()=>{},()=>{},()=>{e<2&&(__privateGet(upThis,_mono)[part]=e)},()=>{e<2&&(__privateGet(upThis,_cc)[chOff+ccToPos2[68]]=e?127:0)},()=>{},()=>{e<2&&(__privateGet(upThis,_cc)[chOff+ccToPos2[65]]=e?127:0)},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[5]]=e&15<<4|__privateGet(upThis,_cc)[chOff+ccToPos2[5]]&15},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[5]]=e&15|(__privateGet(upThis,_cc)[chOff+ccToPos2[5]]&240)>>4},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[74]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[71]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[73]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[72]]=e},0,0,0,0,0,0,0,()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[128]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[93]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[91]]=e},0,0,()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[75]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[76]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[77]]=e},()=>{__privateGet(upThis,_cc)[chOff+ccToPos2[78]]=e}][pointer]||(()=>{}))():pointer<63||(pointer<64?(__privateGet(upThis,_chType)[part]?__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=104|e:__privateGet(upThis,_cc)[chOff+ccToPos2[0]]=96|e,upThis.dispatchEvent("voice",{part})):console.debug(`Unknown SD-90 global CH${part+1} param setup message:
%o`,msg))});break}case 2:{let part=upThis.chRedir(channel,track,!0),offset=msg[1];console.debug(`Unknown SD-90 global CH${part+1} MIDI setup message:
%o`,msg.subarray(2));break}default:console.warn(`Unknown SD-90 global part setup message:
%o`,msg)}})}chRedir(part,track,noConquer){if(__privateGet(this,_trkAsReq)[track])return(__privateGet(this,_trkAsReq)[track]-1)*16+part;if([2,3].indexOf(__privateGet(this,_subLsb))>-1){if(noConquer==1)return part;let shift=0,unmet=!0;for(;unmet;)__privateGet(this,_trkRedir)[part+shift]==0?(__privateGet(this,_trkRedir)[part+shift]=track,console.debug(`Assign track ${track} to channel ${part+shift+1}.`),unmet=!1):__privateGet(this,_trkRedir)[part+shift]==track?unmet=!1:(shift+=16,shift>=128&&(shift=0,unmet=!1));return part+shift}else return part}forceVoiceRefresh(){for(let part=0;part<allocated.ch;part++)__privateGet(this,_chActive)[part]&&this.dispatchEvent("voice",{part})}buildRchTree(){let tree=[];__privateGet(this,_chReceive).forEach((e,i)=>{var _a5;e<allocated.ch&&((_a5=tree[e])!=null&&_a5.constructor||(tree[e]=[]),tree[e].push(i))}),__privateSet(this,_receiveTree,tree)}buildRccMap(){let upThis=this;for(let ch=0;ch<allocated.ch;ch++)__privateGet(upThis,_ccRedirMap)[ch]={};__privateGet(upThis,_ccCapturer).forEach((e,i)=>{e&&(__privateGet(upThis,_ccRedirMap)[Math.floor(i/allocated.redir)][e]=i%allocated.redir|128)}),getDebugState()&&console.debug(__privateGet(upThis,_ccRedirMap))}getActive(){return __privateGet(this,_chActive)}getCc(channel){let start=channel*allocated.cc,arr=__privateGet(this,_cc).subarray(start,start+allocated.cc);return arr[ccToPos2[0]]=arr[ccToPos2[0]]||__privateGet(this,_subMsb),arr[ccToPos2[32]]=arr[ccToPos2[32]]||__privateGet(this,_subLsb),arr[ccToPos2[0]]==overrides.bank0&&(arr[ccToPos2[0]]=0),arr}getCcCh(channel,cc){if(ccAccepted.indexOf(cc)<0)throw new Error("CC number not accepted");return __privateGet(this,_cc)[allocated.cc*channel+ccToPos2[cc]]}getCcAll(){let arr=__privateGet(this,_cc).slice();for(let c=0;c<allocated.ch;c++){let chOff=c*allocated.cc;arr[chOff+ccToPos2[0]]=arr[chOff+ccToPos2[0]]||__privateGet(this,_subMsb),arr[chOff+ccToPos2[32]]=arr[chOff+ccToPos2[32]]||__privateGet(this,_subLsb),arr[ccToPos2[0]]==overrides.bank0&&(arr[ccToPos2[0]]=0)}return arr}getChSource(){return __privateGet(this,_chReceive)}getChType(){return __privateGet(this,_chType)}setChType(part,type,mode=__privateGet(this,_mode),disableMsbSet=!1){type&=15,__privateGet(this,_chType)[part]=type,type>0&&!disableMsbSet&&(__privateGet(this,_cc)[part*allocated.cc+ccToPos2[0]]=drumMsb[mode])}setChActive(part,active=0){__privateGet(this,_chActive)[part]!=active&&this.dispatchEvent("channeltoggle",{part,active}),__privateGet(this,_chActive)[part]=active}getExt(part){let start=allocated.ext*part,view=__privateGet(this,_ext).subarray(start,start+allocated.ext),copy=new Uint8Array(view.length);return copy.set(view),copy[1]=copy[1]||__privateGet(this,_vlSysBreathMode),copy}getPitch(){return __privateGet(this,_pitch)}getProgram(){return __privateGet(this,_prg)}getTexts(){return __privateGet(this,_metaTexts).slice()}getVel(channel){let notes=new Map,upThis=this;return __privateGet(upThis,_poly).forEach(function(e,i){let realCh=Math.floor(e/128),realNote=e%128;channel==realCh&&__privateGet(upThis,_velo)[e]>0&&notes.set(realNote,{v:__privateGet(upThis,_velo)[e],s:__privateGet(upThis,_polyState)[i]})}),notes}getBitmap(){return{bitmap:__privateGet(this,_bitmap,bitmap_get),expire:__privateGet(this,_bitmapExpire)}}getLetter(){return{text:__privateGet(this,_letterDisp),set:__privateGet(this,_letterSet),expire:__privateGet(this,_letterExpire)}}getMode(){return modeIdx[__privateGet(this,_mode)]}getMaster(){return{volume:__privateGet(this,_masterVol)}}getRawStrength(){let upThis=this;return __privateGet(this,_poly).forEach(function(e){let channel=Math.floor(e/128);__privateGet(upThis,_velo)[e]>__privateGet(upThis,_rawStrength)[channel]&&(__privateGet(upThis,_rawStrength)[channel]=__privateGet(upThis,_velo)[e])}),__privateGet(this,_rawStrength)}getStrength(){let str=[],upThis=this;return this.getRawStrength().forEach(function(e,i){str[i]=Math.floor(e*__privateGet(upThis,_cc)[i*allocated.cc+ccToPos2[7]]*__privateGet(upThis,_cc)[i*allocated.cc+ccToPos2[11]]*__privateGet(upThis,_masterVol)/803288)}),str}getRpn(){return __privateGet(this,_rpn)}getNrpn(){return __privateGet(this,_nrpn)}getVoice(msbO,prgO,lsbO,mode){let msb=msbO||__privateGet(this,_subMsb),prg=prgO,lsb=lsbO||__privateGet(this,_subLsb);msb==overrides.bank0&&(msb=0),modeIdx[__privateGet(this,_mode)]=="ns5r"&&msb>0&&msb<56&&(lsb=3);let bank=this.userBank.get(msb,prg,lsb,mode);if(modeIdx[__privateGet(this,_mode)]=="mt32"&&bank.name.indexOf("MT-m:")==0){let patch=parseInt(bank.name.slice(5)),timbreOff=patch*allocated.cmt,userBank="";__privateGet(this,_cmTimbre).subarray(timbreOff,timbreOff+10).forEach(e=>{e>31&&(userBank+=String.fromCharCode(e))});let loadTsv=`MSB	LSB	PRG	NME
0	127	${prg}	${userBank}`;this.userBank.load(loadTsv,!0),bank.name=userBank,bank.ending=" "}return(bank.ending!=" "||!bank.name.length)&&(bank=this.baseBank.get(msb,prg,lsb,mode)),bank}getChVoice(part){let voice=this.getVoice(__privateGet(this,_cc)[part*allocated.cc+ccToPos2[0]],__privateGet(this,_prg)[part],__privateGet(this,_cc)[part*allocated.cc+ccToPos2[32]],modeIdx[__privateGet(this,_mode)]);if(__privateGet(this,_bnCustom)[part])switch(__privateGet(this,_mode)){case modeMap.mt32:voice.ending="~",voice.name="",__privateGet(this,_cmTTimbre).subarray(14*(part-1),14*(part-1)+10).forEach(e=>{voice.name+=String.fromCharCode(Math.max(e,32))}),voice.name=voice.name.trimRight()}return voice}getRawPitch(){return __privateGet(this,_pitch)}getPitchShift(part){let upThis=this,rpnOff=part*allocated.rpn,pitchBendRange=__privateGet(upThis,_rpn)[rpnOff];return __privateGet(upThis,_rpnt)[part*allocated.rpnt]||__privateGet(upThis,_mode)==modeMap.mt32&&(pitchBendRange=12),__privateGet(upThis,_pitch)[part]/8192*pitchBendRange+(__privateGet(upThis,_rpn)[rpnOff+3]-64)+((__privateGet(upThis,_rpn)[rpnOff+1]<<7)+__privateGet(upThis,_rpn)[rpnOff+2]-8192)/8192}getEffectType(slot=0){let index=3*slot+1;return __privateGet(this,_efxBase).subarray(index,index+2)}setEffectTypeRaw(slot=0,isLsb,value){let efxbOff=3*slot;__privateGet(this,_efxBase)[efxbOff]=1,__privateGet(this,_efxBase)[efxbOff+1+ +isLsb]=value}setEffectType(slot=0,msb,lsb){this.setEffectTypeRaw(slot,!1,msb),this.setEffectTypeRaw(slot,!0,lsb)}getEffectSink(){return __privateGet(this,_efxTo)}setLetterDisplay(data2,source,offset=0,delay=3200){let upThis=this,invalidCp;__privateSet(upThis,_letterDisp," ".repeat(offset)),data2.forEach(e=>{__privateSet(upThis,_letterDisp,__privateGet(upThis,_letterDisp)+String.fromCharCode(e>31?e:32)),e<32&&(invalidCp=invalidCp||new Set,invalidCp.add(e))}),__privateSet(upThis,_letterSet,Date.now()),__privateSet(upThis,_letterExpire,Date.now()+delay),invalidCp&&(invalidCp=Array.from(invalidCp),invalidCp.forEach((e,i,a)=>{a[i]=e.toString(16).padStart(2,"0")}),console.warn(`${source}${source?" ":""}invalid code point${invalidCp.length>1?"s":""}: 0x${invalidCp.join(", 0x")}`))}setDetectionTargets(mode="?",port=0){let upThis=this,validId=-1;switch(mode.replaceAll(", ",",").split(",").forEach(e=>{e=e.toLowerCase();let modeId=modeIdx.indexOf(modeAdapt[e]||e);getDebugState()&&console.debug(`Mapped mode "${e}" to ID "${modeId}".`),modeId>-1&&(validId=modeId)}),getDebugState()&&console.debug(`Set detection target to ID "${validId}".`),validId>0&&(__privateGet(upThis,_detect).x5=82,__privateGet(upThis,_detect).ds=modeMap.krs),validId){case modeMap["05rw"]:{__privateGet(upThis,_detect).x5=81;break}case modeMap.s90es:__privateGet(upThis,_detect).ds=modeMap.s90es;case modeMap.motif:__privateGet(upThis,_detect).ds=modeMap.motif}}allocateAce(cc){if(!cc||cc<128&&cc>95){console.warn(`cc${cc} cannot be allocated as an active custom effect.`);return}let continueScan=!0,pointer=0;for(;continueScan&&pointer<allocated.ace;)__privateGet(this,_ace)[pointer]==cc?continueScan=!1:__privateGet(this,_ace)[pointer]||(continueScan=!1,__privateGet(this,_ace)[pointer]=cc,console.info(`Allocated cc${cc} to ACE slot ${pointer}.`)),pointer++;pointer>=allocated.ace&&console.warn("ACE slots are full.")}getAce(){return __privateGet(this,_ace)}getChAce(part,aceSlot){if(aceSlot<0||aceSlot>=allocated.ace)throw new RangeError("No such ACE slot");let cc=__privateGet(this,_ace)[aceSlot];if(cc){if(ccAccepted.indexOf(cc)>=0)return __privateGet(this,_cc)[part*allocated.cc+ccToPos2[cc]];throw new Error(`Invalid ACE source: ${cc}`)}else return 0}initDrums(){let upThis=this;__privateGet(upThis,_drum).fill(64);for(let targetSlot=0;targetSlot<allocated.drm;targetSlot++){let drumOff=targetSlot*allocated.dpn;for(let key in defDrumNrpn){let value=defDrumNrpn[key],boundary=(drumOff+dnToPos[key])*allocated.dnc;__privateGet(upThis,_drum).subarray(boundary,boundary+allocated.dnc).fill(value)}}}init(type=0){let upThis=this;__privateSet(upThis,_subMsb,0),__privateSet(upThis,_subLsb,0),__privateSet(upThis,_metaChannel,0),__privateGet(upThis,_chActive).fill(0),__privateGet(upThis,_cc).fill(0),__privateGet(upThis,_ace).fill(0),__privateGet(upThis,_prg).fill(0),__privateGet(upThis,_velo).fill(0),__privateGet(upThis,_poly).fill(0),__privateGet(upThis,_mono).fill(0),__privateGet(upThis,_rawStrength).fill(0),__privateGet(upThis,_pitch).fill(0),__privateGet(upThis,_nrpn).fill(0),__privateGet(upThis,_rpnt).fill(0),__privateGet(upThis,_ext).fill(0),__privateGet(upThis,_ccCapturer).fill(0),__privateSet(upThis,_masterVol,100),__privateSet(upThis,_metaTexts,[]),__privateSet(upThis,_noteLength,500),__privateSet(upThis,_convertLastSyllable,0),__privateSet(upThis,_bitmapExpire,0),__privateSet(upThis,_bitmapPage,0),__privateGet(upThis,_bitmap,bitmap_get).fill(0),__privateSet(upThis,_modeKaraoke,!1),__privateSet(upThis,_selectPort,0),__privateSet(upThis,_receiveRS,!0),upThis.initDrums(),__privateGet(upThis,_chReceive).forEach(function(e,i,a){a[i]=i}),type==0&&(upThis.dispatchEvent("mode","?"),__privateSet(upThis,_mode,0),__privateGet(upThis,_trkRedir).fill(0),__privateGet(upThis,_trkAsReq).fill(0),__privateSet(upThis,_letterExpire,0),__privateSet(upThis,_letterDisp,"")),__privateGet(upThis,_cc)[allocated.cc*9]=drumMsb[0],__privateGet(upThis,_cc)[allocated.cc*25]=drumMsb[0],__privateGet(upThis,_cc)[allocated.cc*41]=drumMsb[0],__privateGet(upThis,_cc)[allocated.cc*57]=drumMsb[0],__privateGet(upThis,_chType).fill(upThis.CH_MELODIC),__privateGet(upThis,_chType)[9]=upThis.CH_DRUM1,__privateGet(upThis,_chType)[25]=upThis.CH_DRUM3,__privateGet(upThis,_chType)[41]=upThis.CH_DRUMS,__privateGet(upThis,_chType)[57]=upThis.CH_DRUMS,__privateGet(upThis,_chType)[73]=upThis.CH_DRUM5,__privateGet(upThis,_chType)[89]=upThis.CH_DRUM7,__privateGet(upThis,_chType)[105]=upThis.CH_DRUMS,__privateGet(upThis,_chType)[121]=upThis.CH_DRUMS,__privateGet(upThis,_cmPatch).fill(0),__privateGet(upThis,_cmTimbre).fill(0),__privateGet(upThis,_cmTPatch).fill(0),__privateGet(upThis,_cmTTimbre).fill(0),__privateGet(upThis,_bnCustom).fill(0),__privateGet(upThis,_efxBase).fill(0),__privateGet(upThis,_efxTo).fill(0),upThis.aiEfxName="",upThis.userBank.clearRange({msb:0,lsb:127,prg:[0,127]});for(let ch=0;ch<allocated.ch;ch++){let chOff=ch*allocated.cc;__privateGet(upThis,_cc)[chOff+ccToPos2[7]]=100,__privateGet(upThis,_cc)[chOff+ccToPos2[11]]=127,__privateGet(upThis,_cc)[chOff+ccToPos2[2]]=127,__privateGet(upThis,_cc)[chOff+ccToPos2[10]]=64,__privateGet(upThis,_cc).subarray(chOff+ccToPos2[71],chOff+ccToPos2[71]+8).fill(64),__privateGet(upThis,_cc).subarray(chOff+ccToPos2[130],chOff+ccToPos2[130]+28).fill(64),__privateGet(upThis,_cc)[chOff+ccToPos2[91]]=40,__privateGet(upThis,_cc)[chOff+ccToPos2[101]]=127,__privateGet(upThis,_cc)[chOff+ccToPos2[100]]=127,__privateGet(upThis,_cc)[chOff+ccToPos2[99]]=127,__privateGet(upThis,_cc)[chOff+ccToPos2[98]]=127;let rpnOff=ch*allocated.rpn;__privateGet(upThis,_rpn)[rpnOff]=2,__privateGet(upThis,_rpn)[rpnOff+1]=64,__privateGet(upThis,_rpn)[rpnOff+2]=0,__privateGet(upThis,_rpn)[rpnOff+3]=64,__privateGet(upThis,_rpn)[rpnOff+4]=0,__privateGet(upThis,_rpn)[rpnOff+5]=0;let extOff=ch*allocated.ext;__privateGet(upThis,_ext)[extOff+1]=upThis.VLBC_BRTHEXPR;let redirOff=ch*allocated.redir;__privateGet(upThis,_ccCapturer)[redirOff+8]=13}upThis.buildRchTree(),upThis.buildRccMap(),upThis.dispatchEvent("mastervolume",__privateGet(upThis,_masterVol)),upThis.dispatchEvent("efxreverb",upThis.getEffectType(0)),upThis.dispatchEvent("efxchorus",upThis.getEffectType(1)),upThis.dispatchEvent("efxdelay",upThis.getEffectType(2)),upThis.dispatchEvent("efxinsert0",upThis.getEffectType(3)),upThis.dispatchEvent("efxinsert1",upThis.getEffectType(4)),upThis.dispatchEvent("efxinsert2",upThis.getEffectType(5)),upThis.dispatchEvent("efxinsert3",upThis.getEffectType(6)),upThis.dispatchEvent("reset"),upThis.switchMode("?")}switchMode(mode,forced=!1,setTarget=!1){var _a5;let upThis=this,idx=modeIdx.indexOf(mode);if(idx>-1){if(__privateGet(upThis,_mode)==0||forced){let oldMode=__privateGet(upThis,_mode);upThis.initOnReset&&forced&&(this.init(1),oldMode=modeMap["?"]),__privateSet(upThis,_mode,idx),__privateSet(upThis,_bitmapPage,0),__privateSet(upThis,_subMsb,substList[0][idx]),__privateSet(upThis,_subLsb,substList[1][idx]);for(let ch=0;ch<allocated.ch;ch++)__privateGet(upThis,_chType)[ch]>0&&__privateGet(upThis,_cc)[ch*allocated.cc+ccToPos2[0]]==drumMsb[oldMode]&&(__privateGet(upThis,_cc)[ch*allocated.cc]=drumMsb[idx]);switch(idx){case modeMap.mt32:{mt32DefProg.forEach((e,i)=>{let ch=i+1;__privateGet(upThis,_chActive)[ch]||(__privateGet(upThis,_prg)[ch]=e,__privateGet(upThis,_cc)[ch*allocated.cc+ccToPos2[91]]=127)});for(let part=1;part<10;part++)upThis.dispatchEvent("voice",{part});break}}let efxDefault;switch(idx){case modeMap["?"]:case modeMap.g2:{efxDefault=[52,4,52,18,0,0,0,0];break}case modeMap.xg:{efxDefault=[1,0,65,0,5,0,0,0];break}case modeMap.gm:case modeMap.gs:{efxDefault=[40,4,40,18,40,32,32,0];break}case modeMap.sd:{efxDefault=[58,0,60,0,61,0,61,0];break}case modeMap["05rw"]:case modeMap.x5d:case modeMap.ns5r:{efxDefault=[44,1,44,19,44,0,44,0];break}case modeMap.k11:case modeMap.sg:{efxDefault=[24,0,0,0,0,0,0,0];break}case modeMap.mt32:{efxDefault=[40,4,0,0,0,0,0,0];break}default:efxDefault=[0,0,0,0,0,0,0,0]}for(let i=0;i<allocated.efx;i++)!__privateGet(upThis,_efxBase)[3*i]&&(_a5=efxDefault[i<<1])!=null&&_a5.constructor&&(__privateGet(upThis,_efxBase)[3*i+1]=efxDefault[2*i],__privateGet(upThis,_efxBase)[3*i+2]=efxDefault[2*i+1],upThis.dispatchEvent(`efx${["reverb","chorus","delay","insert0"][i]}`,upThis.getEffectType(i)));setTarget&&upThis.setDetectionTargets(mode),upThis.dispatchEvent("mode",mode),upThis.forceVoiceRefresh()}}else throw new Error(`Unknown mode ${mode}`)}newStrength(){__privateGet(this,_rawStrength).fill(0)}runJson(json){var _a5;if(json.type>14)return json.type==15&&json.data.constructor!=Uint8Array&&(json.data=Uint8Array.from(json.data)),__privateGet(this,_runChEvent)[json.type].call(this,json);{let rcvPart=this.chRedir(json.part,json.track),executed=!1;(_a5=__privateGet(this,_receiveTree)[rcvPart])==null||_a5.forEach(e=>{json.channel=e,executed=!0,__privateGet(this,_runChEvent)[json.type].call(this,json)}),executed||console.warn(`${eventTypes[json.type]?eventTypes[json.type]:json.type}${[11,12].includes(json.type)?(json.data[0]!=null?json.data[0]:json.data).toString():""} event sent to CH${rcvPart+1} without any recipient.`)}__privateGet(this,_metaTexts).length>100&&__privateGet(this,_metaTexts).splice(100,__privateGet(this,_metaTexts).length-99)}runRaw(midiArr){}async loadBank(format,blob){let upThis=this;switch(format=format.toLowerCase(),format){case"s7e":{upThis.userBank.clearRange({msb:63,lsb:[21,22]}),upThis.userBank.clearRange({msb:63,lsb:[24,27]});break}default:throw new Error(`Unknown bank format ${format}`)}switch(format){case"s7e":{bankDecoder.context=this,upThis.userBank.load(await bankDecoder.read(format,blob));break}}upThis.forceVoiceRefresh()}},_mode=new WeakMap,_bitmapPage=new WeakMap,_bitmapExpire=new WeakMap,_bitmapStore=new WeakMap,_bitmap=new WeakSet,bitmap_get=function(){return __privateGet(this,_bitmapStore)[__privateGet(this,_bitmapPage)]},bitmap_set=function(value){__privateGet(this,_bitmapStore)[__privateGet(this,_bitmapPage)]=value},_chActive=new WeakMap,_chReceive=new WeakMap,_chType=new WeakMap,_cc=new WeakMap,_ace=new WeakMap,_prg=new WeakMap,_velo=new WeakMap,_mono=new WeakMap,_poly=new WeakMap,_polyState=new WeakMap,_pitch=new WeakMap,_rawStrength=new WeakMap,_dataCommit=new WeakMap,_ext=new WeakMap,_rpn=new WeakMap,_rpnt=new WeakMap,_nrpn=new WeakMap,_drum=new WeakMap,_efxBase=new WeakMap,_efxTo=new WeakMap,_ccCapturer=new WeakMap,_bnCustom=new WeakMap,_cmTPatch=new WeakMap,_cmTTimbre=new WeakMap,_cmPatch=new WeakMap,_cmTimbre=new WeakMap,_subMsb=new WeakMap,_subLsb=new WeakMap,_detect=new WeakMap,_masterVol=new WeakMap,_metaChannel=new WeakMap,_noteLength=new WeakMap,_convertLastSyllable=new WeakMap,_letterDisp=new WeakMap,_letterExpire=new WeakMap,_letterSet=new WeakMap,_selectPort=new WeakMap,_receiveRS=new WeakMap,_modeKaraoke=new WeakMap,_vlSysBreathMode=new WeakMap,_receiveTree=new WeakMap,_ccRedirMap=new WeakMap,_gsEfxSto=new WeakMap,_metaTexts=new WeakMap,_trkRedir=new WeakMap,_trkAsReq=new WeakMap,_metaRun=new WeakMap,_metaSeq=new WeakMap,_ua=new WeakMap,_runChEvent=new WeakMap,_seMan=new WeakMap,_seUnr=new WeakMap,_seUr=new WeakMap,_seXg=new WeakMap,_seGs=new WeakMap,_seAi=new WeakMap,_seKg=new WeakMap,_seSg=new WeakMap,_seCs=new WeakMap,_a4);export{OctaviaDevice,allocated,ccToPos2 as ccToPos,dnToPos};