var Ta=Object.create;var Ot=Object.defineProperty;var Ma=Object.getOwnPropertyDescriptor;var Pa=Object.getOwnPropertyNames;var Ra=Object.getPrototypeOf,Da=Object.prototype.hasOwnProperty;var Aa=(g,e,r)=>e in g?Ot(g,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):g[e]=r;var Ft=(g,e)=>()=>(g&&(e=g(g=0)),e);var Oa=(g,e)=>()=>(e||g((e={exports:{}}).exports,e),e.exports);var Ia=(g,e,r,h)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Pa(e))!Da.call(g,n)&&n!==r&&Ot(g,n,{get:()=>e[n],enumerable:!(h=Ma(e,n))||h.enumerable});return g};var La=(g,e,r)=>(r=g!=null?Ta(Ra(g)):{},Ia(e||!g||!g.__esModule?Ot(r,"default",{value:g,enumerable:!0}):r,g));var P=(g,e,r)=>(Aa(g,typeof e!="symbol"?e+"":e,r),r),Kt=(g,e,r)=>{if(!e.has(g))throw TypeError("Cannot "+r)};var t=(g,e,r)=>(Kt(g,e,"read from private field"),r?r.call(g):e.get(g)),T=(g,e,r)=>{if(e.has(g))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(g):e.set(g,r)},S=(g,e,r,h)=>(Kt(g,e,"write to private field"),h?h.call(g,r):e.set(g,r),r);var zt=Ft(()=>{"use strict";L();(function(){var g=function(v,x,a){var c,l;if(self.MessageEvent)switch(v){case"message":{l=new MessageEvent(v,{data:x,ports:a==null?void 0:a.ports}),Object.defineProperty(l,"source",{value:a==null?void 0:a.source});break}default:l=new Event(v)}else l=document.createEvent("Event"),l.initEvent(v,!1,!1),a&&v=="message"&&(l.data=x,a.source&&Object.defineProperty(l,"source",{value:a.source}),(c=a.ports)!=null&&c.length&&Object.defineProperty(l,"ports",{value:a.ports}));return l};self.BroadcastChannel?console.info("[Snowy] Snowy is disabled."):(console.info("[Snowy] Snowy is enabled. Path: ".concat(self.SNOWY_PATH||"/snowy.js")),r=[],h={},n=function(v){var x,a=this;if((this==null?void 0:this.constructor)!=n)throw new TypeError("Illegal constructor");r.push(this),(x=h[v])!=null&&x.constructor||(h[v]=[]),h[v].push(this);var c=Math.floor(Math.random()*281474976710656),l=[],s=0,i=[],o=!0,d=!1;Object.defineProperty(this,"id",{get:function(){return c}}),Object.defineProperty(this,"name",{value:v}),this.close=function(){var f,$=r.indexOf(a);$>-1?(e.postMessage({t:"d",c:v,i:c}),r.splice($,1),(f=h[v])!=null&&f.constructor&&($=h[v].indexOf(a),$>-1&&h[v].splice($,1)),h[v].length||delete h[v],console.debug("[Snowy] BroadcastChannel closed."),d=!0):console.debug("[Snowy] BroadcastChannel already closed.")},this.postMessage=function(f){if(e){if(d)throw new Error("Channel already closed");e.postMessage({t:"m",c:v,i:c,m:s,d:f}),s++,s>4294967295&&(s=0)}else i.push(f),console.debug("[Snowy] Message is cached.")},this.flush=function(){if(e){if(o){for(e.postMessage({t:"r",c:v,i:c}),console.debug("[Snowy] ".concat(i.length," message(s) in cache."));i.length;){var f=i.shift();a.postMessage(f)}o=!1,console.debug("[Snowy] All cached messages are flushed away.")}}else throw new Error("Tried to flush when the ports are not ready")},this.receiveMessage=function(f){f.c==v?f.i!=c&&a.dispatchEvent(g("message",f.d,{source:a})):console.debug("[Snowy] Channel ID mismatch. Instance ".concat(c," receives from ").concat(v,", not ").concat(f.c,"."))};var u={};this.dispatchEvent=function(f){var $,w;if(Object.defineProperty(f,"target",{value:a}),Object.defineProperty(f,"currentTarget",{value:a}),($=u[f.type])!=null&&$.length)for(var C=u[f.type],M=0;M<C.length;M++)((w=C[M])==null?void 0:w.constructor)==Function&&C[M].call(a,f);a["on".concat(f.type)]&&a["on".concat(f.type)].constructor==Function&&a["on".concat(f.type)].call(a,f)},this.addEventListener=function(f,$){var w;(w=u[f])!=null&&w.constructor||(u[f]=[]);var C=u[f].indexOf($);C==-1&&u[f].push($)},this.removeEventListener=function(f,$){var w,C;if((w=u[f])!=null&&w.length){var M=u[f].indexOf($);M>-1&&u[f].splice(M,1)}!((C=u[f])!=null&&C.length)&&u[f].constructor&&delete u[f]}},self.BroadcastChannel=n,p=function(){if(e){e.addEventListener("message",function(x){var a=x.data,c=!1;switch(a.t){case"k":{c=!1,e.postMessage({t:"k"});break}case"m":{var l=h[a.c];if(l!=null&&l.length)for(var s=0;s<l.length;s++)l[s].receiveMessage(a);break}case"c":{for(var i=[],o=0;o<r.length;o++){var d=r[o].name;i.indexOf(d)<0&&i.push(d)}e.postMessage({t:"k",c:i});break}default:c=!0}c&&console.info("ReceiveBroadcast",a)});for(var v=0;v<r.length;v++)r[v].flush()}else throw new Error("Message port isn't yet ready");console.info("[Snowy] Snowy is active.")},y=function(){if(!e){var v=new SharedWorker(self.SNOWY_PATH||"/snowy.js");v.port.start();var x=function(a){a.data.t=="swc"&&(v.port.removeEventListener("message",x),e=v.port,e.postMessage({t:"k"}),p())};v.port.addEventListener("message",x)}},y());var e,r,h,n,p,y})()});var L=Ft(()=>{"use strict";zt();{let g=function(e,r){let h=new FileReader;return new Promise((n,p)=>{switch(h.addEventListener("abort",()=>{p(new Error("Blob read aborted"))}),h.addEventListener("error",y=>{p(h.error||y.data||new Error("Blob read error"))}),h.addEventListener("load",()=>{n(h.result)}),r.toLowerCase()){case"arraybuffer":case"buffer":{h.readAsArrayBuffer(e);break}case"string":case"text":{h.readAsText(e);break}default:p(new Error(`Unknown target ${r}`))}})};Blob.prototype.arrayBuffer=Blob.prototype.arrayBuffer||function(){return g(this,"buffer")},Blob.prototype.text=Blob.prototype.text||function(){return g(this,"text")}}String.prototype.replaceAll=String.prototype.replaceAll||function(g,e){let r=0,h=16,n=this,p=[];for(;r<h&&n.lastIndexOf(g)>-1;){let y=n.lastIndexOf(g);p.unshift(n.slice(y+g.length)),n=n.slice(0,y),y==0&&p.unshift(""),r++}return n.length&&p.unshift(n),p.join(e)||""},String.prototype.padStart=String.prototype.padStart||function(g,e){if(e){let r=this;for(;r.length<g;)r=`${e}${r}`;return r}},String.prototype.padEnd=String.prototype.padEnd||function(g,e){if(e){let r=this;for(;r.length<g;)r+=e;return r}}});var va=Oa((Hr,_t)=>{L();(function(){"use strict";let g={fatal:!0},e=[new TextDecoder("iso-8859-15",g),new TextDecoder("sjis",g),new TextDecoder("euc-jp",g),new TextDecoder("utf-8",g),new TextDecoder("utf-16",g),new TextDecoder("ascii")],r={debug:!1,parse:function(h,n){if(h instanceof Uint8Array)return r.Uint8(h);if(typeof h=="string")return r.Base64(h);if(h instanceof HTMLElement&&h.type==="file")return r.addListener(h,n);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(h,n){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(h===void 0||!(h instanceof HTMLElement)||h.tagName!=="INPUT"||h.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;n=n||function(){},h.addEventListener("change",function(p){if(!p.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let y=new FileReader;y.readAsArrayBuffer(p.target.files[0]),y.onload=function(v){n(r.Uint8(new Uint8Array(v.target.result)))}})},Base64:function(h){let n=function(v){var x="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(v=v.replace(/^.*?base64,/,""),v=String(v).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(v))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");v+="==".slice(2-(3&v.length));let a,c="",l,s,i=0;for(;i<v.length;)a=x.indexOf(v.charAt(i++))<<18|x.indexOf(v.charAt(i++))<<12|(l=x.indexOf(v.charAt(i++)))<<6|(s=x.indexOf(v.charAt(i++))),c+=l===64?String.fromCharCode(a>>16&255):s===64?String.fromCharCode(a>>16&255,a>>8&255):String.fromCharCode(a>>16&255,a>>8&255,255&a);return c}(h=String(h));var p=n.length;let y=new Uint8Array(new ArrayBuffer(p));for(let v=0;v<p;v++)y[v]=n.charCodeAt(v);return r.Uint8(y)},Uint8:function(y){let n={data:null,pointer:0,movePointer:function(l){return this.pointer+=l,this.pointer},readInt:function(l){if((l=Math.min(l,this.data.byteLength-this.pointer))<1)return-1;let s=0;if(1<l)for(let i=1;i<=l-1;i++)s+=this.data.getUint8(this.pointer)*Math.pow(256,l-i),this.pointer++;return s+=this.data.getUint8(this.pointer),this.pointer++,s},readStr:function(l){let s=new Uint8Array(l),i=!1,o;s.forEach((d,u)=>{s[u]=this.readInt(1)});for(let d=0;d<e.length;d++)if(!i)try{if(o=e[d].decode(s),d==0)for(let u=0;u<o.length;u++){let f=o.charCodeAt(u);if(f>191||f>127&&f<160)throw new RangeError(`Invalid code point: ${f}`)}i=!0,console.debug(`String byte sequence in ${e[d].encoding}`)}catch(u){console.debug(`SMF string ${u}`)}return o||"String byte sequence read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let l=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)l=this.readInt(1);else{let i=[];for(;128<=this.data.getUint8(this.pointer);)i.push(this.readInt(1)-128);var s=this.readInt(1);for(let o=1;o<=i.length;o++)l+=i[i.length-o]*Math.pow(128,o);l+=s}return l}};if(n.data=new DataView(y.buffer,y.byteOffset,y.byteLength),n.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;n.readInt(4);let p={};p.formatType=n.readInt(2),p.tracks=n.readInt(2),p.track=[];var y=n.readInt(1),v=n.readInt(1);128<=y?(p.timeDivision=[],p.timeDivision[0]=y-128,p.timeDivision[1]=v):p.timeDivision=256*y+v;for(let l=1;l<=p.tracks;l++){p.track[l-1]={event:[]};var x,a=n.readInt(4);if(a===-1)break;if(a!==1297379947)return!1;n.readInt(4);let s=0,i=!1,o,d;for(;!i&&(s++,p.track[l-1].event[s-1]={},p.track[l-1].event[s-1].deltaTime=n.readIntVLV(),(o=n.readInt(1))!==-1);)if(128<=o?d=o:(o=d,n.movePointer(-1)),o===255){p.track[l-1].event[s-1].type=255,p.track[l-1].event[s-1].metaType=n.readInt(1);var c=n.readIntVLV();switch(p.track[l-1].event[s-1].metaType){case 47:case-1:i=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:p.track[l-1].event[s-1].data=n.readStr(c);break;case 33:case 89:case 81:p.track[l-1].event[s-1].data=n.readInt(c);break;case 84:p.track[l-1].event[s-1].data=[],p.track[l-1].event[s-1].data[0]=n.readInt(1),p.track[l-1].event[s-1].data[1]=n.readInt(1),p.track[l-1].event[s-1].data[2]=n.readInt(1),p.track[l-1].event[s-1].data[3]=n.readInt(1),p.track[l-1].event[s-1].data[4]=n.readInt(1);break;case 88:p.track[l-1].event[s-1].data=[],p.track[l-1].event[s-1].data[0]=n.readInt(1),p.track[l-1].event[s-1].data[1]=n.readInt(1),p.track[l-1].event[s-1].data[2]=n.readInt(1),p.track[l-1].event[s-1].data[3]=n.readInt(1);break;default:this.customInterpreter!==null&&(p.track[l-1].event[s-1].data=this.customInterpreter(p.track[l-1].event[s-1].metaType,n,c)),this.customInterpreter!==null&&p.track[l-1].event[s-1].data!==!1||(n.readInt(c),p.track[l-1].event[s-1].data=n.readInt(c),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((o=o.toString(16).split(""))[1]||o.unshift("0"),p.track[l-1].event[s-1].type=parseInt(o[0],16),p.track[l-1].event[s-1].channel=parseInt(o[1],16),p.track[l-1].event[s-1].type){case 15:this.customInterpreter!==null&&(p.track[l-1].event[s-1].data=this.customInterpreter(p.track[l-1].event[s-1].type,n,!1)),this.customInterpreter!==null&&p.track[l-1].event[s-1].data!==!1||(x=n.readIntVLV(),p.track[l-1].event[s-1].data=n.readInt(x),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:p.track[l-1].event[s-1].data=[],p.track[l-1].event[s-1].data[0]=n.readInt(1),p.track[l-1].event[s-1].data[1]=n.readInt(1);break;case 12:case 13:p.track[l-1].event[s-1].data=n.readInt(1);break;case-1:i=!0;break;default:if(this.customInterpreter!==null&&(p.track[l-1].event[s-1].data=this.customInterpreter(p.track[l-1].event[s-1].metaType,n,!1)),this.customInterpreter===null||p.track[l-1].event[s-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return p},customInterpreter:null};if(typeof _t<"u")_t.exports=r;else{let h=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;h.MidiParser=r}})()});L();L();var ae,qt,Mt=(qt=class{constructor(){T(this,ae,{})}addEventListener(g,e){t(this,ae)[g]||(t(this,ae)[g]=[]),t(this,ae)[g].unshift(e)}removeEventListener(g,e){if(t(this,ae)[g]){let r=t(this,ae)[g].indexOf(e);r>-1&&t(this,ae)[g].splice(r,1),t(this,ae)[g].length<1&&delete t(this,ae)[g]}}dispatchEvent(g,e){var n;let r=new Event(g),h=this;r.data=e,((n=t(this,ae)[g])==null?void 0:n.length)>0&&t(this,ae)[g].forEach(function(p){try{p==null||p.call(h,r)}catch(y){console.error(y)}}),this[`on${g}`]&&this[`on${g}`](r)}},ae=new WeakMap,qt);L();L();var Wt=function(g,e){let r=Math.min(g.length,e.length),h=g.slice(0,r),n=e.slice(0,r),p=0,y=0;for(;y<r&&p==0;)p=Math.sign(h[y]-n[y]),y++;return p},pe=function(g=""){this.name=g,this.pool=[],this.point=function(e,r=!1){if(this.pool.length>0){let h=this.pool.length,n=1<<Math.floor(Math.log2(h)),p=n,y=64;for(;n>=1&&y>=0;){if(y<=0)throw new Error("TTL reached.");if(p==h)p-=n;else{let x=Wt(e,this.pool[p]);switch(x){case 0:{y=0;break}case 1:{p+n<=h&&(p+=n);break}case-1:{p!=0&&(p-=n);break}default:console.warn(`Unexpected result ${x}.`)}}n=n>>1,y--}let v=!0;if(p>=this.pool.length)v=!1;else{let x=this;this.pool[p].forEach(function(a,c,l){v&&a!=e[c]&&(v=!1)}),!v&&Wt(e,this.pool[p])>0&&p++}return v||r?p:-1}else return r?0:-1},this.add=function(e,r){return e.data=r,this.pool.splice(this.point(e,!0),0,e),this},this.default=function(e){console.warn(`No match in "${this.name||"(unknown)"}" for "${e}". Default action not defined.`)},this.get=function(e){let r=this.point(e);if(r>-1)return this.pool[r].data;this.default(e)},this.run=function(e,...r){let h=this.point(e);h>-1?e.subarray?this.pool[h].data(e.subarray(this.pool[h].length),...r):this.pool[h].data(e.slice(this.pool[h].length),...r):this.default(e,...r)}};L();var Ua=["MSB","PRG","LSB","NME","ELC","DRM"],It=function(g){let e=Math.floor(g/10),r=g%10;return`${e.toString(16)}${r}`},ee,Qt,Lt=(Qt=class{constructor(...g){T(this,ee,void 0);P(this,"strictMode",!1);this.loadFiles(...g)}get(g=0,e=0,r=0,h){var $,w;let n=[g,e,r],p,y=1,v=0,x,a=Array.from(arguments);switch(h){case"xg":{switch(g){case 0:{r==126?a[2]=125:r==127&&(a[2]=0);break}case 16:{r==126&&(a[2]=0);break}case 32:{r>125&&(a[2]=0),a[2]+=4;break}case 33:case 34:case 35:case 36:{r>125&&(a[2]=0),a[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:a[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{r==126&&(a[2]=0);break}case 48:case 64:case 126:case 127:{r==126&&(a[2]=0);break}}break}case"gs":case"sc":{g==0&&r<5?a[2]=0:g>125&&r<5&&r!=2&&(a[2]=g,a[0]=0);break}case"g2":case"sd":{g>>1==40?a[2]|=16:g>95&&g<100&&(a[2]|=16,e>>4==7&&(a[0]=96));break}case"sg":{g==8&&r==0&&(a[2]=5);break}case"s90es":{r<8?a[2]+=17:r<32?a[2]+=13:a[2]=(a[2]>>3)+19;break}case"motif":{r<8?a[2]+=28:r<32?a[2]+=13:a[2]=(a[2]>>3)+19;break}}let c=" ",l="M",s="",i=0,o=0;switch(a[0]){case 0:{switch(a[2]){case 127:{h=="xg"?l="GM-a":(l="MT-a",s="C/M");break}case 126:{h=="xg"?l="GM-n":(l="MT-b",s="C/M");break}case 7:{l="GM-k",s="GLX";break}case 5:{l="SG-a",s="000";break}case 4:{h=="gs"||h=="sc"?(l="GM-a",s="000"):(l="SP-l",s="C/M");break}case 3:case 2:case 1:{(h=="gs"||h=="sc")&&(l="GM-a",s="000");break}case 0:{l="GM-a";break}default:l="y",i=3}break}case 8:{h=="sg"?l="GM-s":l="r:";break}case 32:case 33:case 34:case 35:case 36:{h=="xg"&&(l=`${["AP","VL","PF","DX","AN"][g&7]}-${"abcdefgh"[r]}`,i=3);break}case 48:{s=`M${(a[2]>>3).toString().padStart(2,"0")}`,l=`y${s}`,i=1;break}case 56:{l="GM-b";break}case 57:l=["yDOC","QY10","QY20"][a[2]-112]||"yMxv",s=["DOC","QY1","QY2"][a[2]-112]||"057";case 61:case 120:{l="rDrm";break}case 62:{l="kDrm";break}case 63:{if(a[2]<17){let C=a[2];l=C<10?"kP:":"kC:",l+=C%10}else a[2]<34?l=["Pre1","Pre2","Pre3","Pre4","Usr1","Usr2","DrmP","DrmU","Plg1","Plg2","Plg3","Pre1","Pre2","Pre3","Pre4","Pre5","Pre6"][a[2]-17]:l="Ds";i=1;break}case 64:{l="ySFX",s="SFX";break}case 67:{l="DX:S";break}case 80:case 81:case 82:case 83:{l=`Prg${"UABC"[a[0]-80]}`;break}case 88:case 89:case 90:case 91:{l=`Cmb${"UABC"[a[0]-88]}`;break}case 95:{l=`${["DR","PC"][a[2]]}-d`;break}case 96:{l=a[2]==106?"AP-a":a[2]>>4==1?"SDg":"PF",a[2]>63?o=63:a[2]>>4==1&&(o=16),i=3;break}case 97:{l=a[2]>>4==1?"SDa":"VL:",i=3,a[2]>>4==1?o=16:o=112;break}case 98:{l=a[2]>>4==1?"SDb":"SG-a",i=3,o=16;break}case 99:{l=a[2]>>4==1?"SDc":"DX",a[2]>63?o=63:a[2]>>4==1&&(o=16),i=3;break}case 100:{l="AN",a[2]>63?o=63:a[2]>>4==1&&(o=16),i=3;break}case 104:case 105:case 106:case 107:{l="SDd",o=104;break}case 121:{l=`GM-${a[2]?"":"a"}`,i=3;break}case 122:{l="lDrm";break}case 126:{l="yDrS";break}case 127:{a[2]==127?l="rDrm":l="yDrm";break}default:a[0]<48?l="r:":l="M"}l.length<4&&(l+=`${[g,r,a[0],a[2]][i]-o}`.padStart(4-l.length,"0")),s.length<3&&(s+=`${[g,r,g,r][i]}`.padStart(3-s.length,"0")),h=="xg"&&(g==0?a[2]<100?l=l.replace("y0","y:"):a[2]==125&&(l="y126"):g==16?(p=`Voice${((a[2]<<7)+a[1]+1).toString().padStart(3,"0")}`,c=" "):g==35&&r>>1==2&&(p=`DXCH_${(((a[2]&1)<<7)+e+1).toString().padStart(3,"0")}`,c=" "));let d=[a[0],a[1],a[2]];for(;!((p==null?void 0:p.length)>=0);)if(p=($=t(this,ee)[a[1]||0][(a[0]<<7)+a[2]])==null?void 0:$.name,p){let C=t(this,ee)[a[1]||0][(a[0]<<7)+a[2]];y=(C==null?void 0:C.poly)||y,v=(C==null?void 0:C.type)||v,x=C==null?void 0:C.drum}else if(this.strictMode)p="",c="?";else if(a[0]==0&&a[1]==0&&a[2]==0)p="Unloaded";else if(t(this,ee)[a[1]||0][a[0]<<7])a[0]==0?(a[2]=0,c="^"):a[2]<1?(a[0]=0,c="*"):(a[2]--,c="^");else if(g==48)a[0]=0,a[2]=0,c="!";else if(g==62)a[1]--,c=" ",a[1]<1&&!(p!=null&&p.length)&&(a[0]=0,c="!");else if(g<63)a[0]==0?(a[2]=0,c="^"):a[2]<1?(a[0]=0,c="*"):a[2]--;else if(g==80)p=`PrgU:${e.toString().padStart(3,"0")}`,c="!";else if(g==88)p=`CmbU:${e.toString().padStart(3,"0")}`,c="!";else if(g==121)p=`GM2Vox0${r}`,c="#";else if(g==122){if(a[1]==32?a[1]==0:a[1]%=7,p=(w=t(this,ee)[a[1]||0][(a[0]<<7)+a[2]])==null?void 0:w.name,p){c=" ";let C=t(this,ee)[a[1]||0][(a[0]<<7)+a[2]];y=(C==null?void 0:C.poly)||y,v=(C==null?void 0:C.type)||v,x=C==null?void 0:C.drum}else p="",c="*";}else a[1]==0?(p=`${g.toString().padStart(3,"0")} ${e.toString().padStart(3,"0")} ${r.toString().padStart(3,"0")}`,c="!"):a[0]==0?(a[2]=0,c="^"):a[2]>0?a[2]--:a[1]>0?(a[1]=0,c="!"):(a[0]=0,c="?");let u=[a[0],a[1],a[2]];switch(c){case"^":{switch(h){case"gs":case"sc":case"ns5r":{c=" ";break}}g==127&&c=="^"&&(c=" ");break}}let f="??";switch(a[0]){case 0:{a[2]==0?f="GM":a[2]==5||a[2]==7?f="KG":a[2]<126?f="XG":a[2]==127&&(f="MT");break}case 32:case 33:case 35:case 36:{a[2]>4?f=["AP","VL","PF","DX","AN"][a[0]-32]:f="GS";break}case 48:{f="MU";break}case 56:{f="AG";break}case 61:case 80:case 83:case 88:case 89:case 91:{f="AI";break}case 62:case 82:case 90:{f="XD";break}case 63:{a[2]<17?f="KR":a[2]<34?f="ES":f="DS";break}case 64:case 126:{f="XG";break}case 67:case 99:{f=a[2]>>4==1?"SD":"DX";break}case 81:{f="RW";break}case 95:{f=["DR","PC"][a[2]];break}case 96:{f=a[2]==106?"AP":a[2]>>4==1?"SD":"PF";break}case 97:{f=a[2]>>4==1?"SD":"VL";break}case 98:{f=a[2]>>4==1?"SD":"SG";break}case 100:{f="AN";break}case 104:case 105:case 106:case 107:{f="SD";break}case 120:{f="GS";break}case 121:{f=a[2]?"G2":"GM";break}case 122:{f="KG";break}case 127:{f=a[2]==127?"MT":e==0?"GM":"XG";break}default:a[0]<48&&(a[0]==16&&h=="xg"?f="XG":f="GS")}return c!=" "&&(h=="krs"||self.debugMode)&&(p="",f="KR"),{name:p||`${It(g||0)} ${It(e||0)} ${It(r||0)}`,poly:y,type:v,drum:x,iid:d,eid:u,sid:n,ending:c,sect:l,bank:s,standard:f,mode:h}}async load(g,e,r="(internal)"){let h=this,n=[],p=0,y=0;g.split(`
`).forEach(function(v,x){let a=v.split("\t"),c=[];if(x==0){if(a.forEach(function(l,s){n[Ua.indexOf(l)]=s}),n.length<4){console.debug("Debugger launched.");debugger}}else{let l=0,s=0,i=0,o,d=1,u=0,f;a.forEach(async function(w,C){switch(C){case n[0]:{l=parseInt(w);break}case n[1]:{s=parseInt(w);break}case n[2]:{i=parseInt(w);break}case n[3]:{o=w;break}case n[4]:{w=parseInt(w),w<16?d=w+1:u=(w&15)+1;break}case n[5]:{f=w;break}}}),t(h,ee)[s]=t(h,ee)[s]||[];let $=t(h,ee)[s];if(!$[l<<7|i]||e){let w={msb:l,prg:s,lsb:i,name:o,poly:d,type:u,drum:f};$[l<<7|i]=w,p++}y++}}),e||console.debug(`Map "${r}": ${y} total, ${p} loaded.`)}clearRange(g){let e=g.prg!=null?g.prg.constructor==Array?g.prg:[g.prg,g.prg]:[0,127],r=g.msb!=null?g.msb.constructor==Array?g.msb:[g.msb,g.msb]:[0,127],h=g.lsb!=null?g.lsb.constructor==Array?g.lsb:[g.lsb,g.lsb]:[0,127];for(let n=r[0];n<=r[1];n++){let p=n<<7;for(let y=h[0];y<=h[1];y++){let v=p+y;for(let x=e[0];x<=e[1];x++)delete t(this,ee)[x][v]}}}init(){S(this,ee,[]);for(let g=0;g<128;g++)t(this,ee).push([""])}async loadFiles(...g){this.init();let e=this;g.forEach(async function(r){try{await fetch(`./data/bank/${r}.tsv`).then(function(h){return h.text()}).then(h=>{e.load(h,!1,r)})}catch(h){console.error(`Failed loading "${r}.tsv".`)}})}},ee=new WeakMap,Qt);L();L();var it,Yt,Zt=(Yt=class{constructor(){T(this,it,{});P(this,"context")}set(g,e){t(this,it)[g]=e}has(g){return!!t(this,it)[g]}async read(g,e){if(!this.has(g))throw new Error(`No decoder registered for "${g}"`);return await t(this,it)[g].call(this.context||this,e)}},it=new WeakMap,Yt);var Ba=function(g,e){let r=!0;return e.forEach((h,n)=>{r=r&&g[n]==h}),r},gt=function(g){let e=0;return g.forEach(r=>{e*=256,e+=r}),e},ve=new TextDecoder,bt=new Zt;bt.set("s7e",async function(g){let e=new Uint8Array(await g.slice(0,65536).arrayBuffer()),r="MSB\tLSB\tPRG\tNME",h=[0,0,0,0],n=32,p=0,y=0,v=!0,x=[],a=0;for(;v;){let c=e.subarray(p);([()=>{ve.decode(c.subarray(0,4))=="YSFC"?(p+=80,y=1):p++},()=>{if(Ba(c.subarray(0,4),h))x.forEach((l,s,i)=>{let o=gt(e.subarray(l.start+4,l.start+8));l.length=o}),y=2;else{let l=ve.decode(c.subarray(0,4)),s=gt(c.subarray(4,8));x.push({type:l,start:s}),p+=8}},()=>{let l=x[a],s=e.subarray(l.start,l.start+l.length),i=32;switch(l.type){case"ENVC":{let o=n;for(;o<s.length;){let d=s.subarray(o,o+i),u=ve.decode(d.subarray(0,10)).trimEnd();u.slice(0,5)=="Init "&&(u=""),u&&(r+=`
063	${(d[17]+13).toString().padStart(3,"0")}	${d[19].toString().padStart(3,"0")}	${u}`),o+=i}break}case"EDVC":{let o=n;for(;o<s.length;){let d=s.subarray(o,o+i),u=ve.decode(d.subarray(0,10)).trimEnd();u.slice(0,5)=="Init "&&(u=""),u&&(r+=`
063	024	${d[19].toString().padStart(3,"0")}	${u}`),o+=i}break}case"EPVC":{let o=32,d=n;for(;d<s.length;){let u=s.subarray(d,d+o),f=ve.decode(u.subarray(0,10)).trimEnd();f=="----------"&&(f=""),f&&(r+=`
063	${(u[17]+1).toString().padStart(3,"0")}	${u[19].toString().padStart(3,"0")}	${f}`),d+=o}break}}a++,a>=x.length&&(y=3,v=!1)}][y]||(()=>{v=!1}))()}return r});bt.set("pcg",async function(g){let e=new Uint8Array(await g.arrayBuffer()),r="MSB\tLSB\tPRG\tNME",h=100,n=0,p=0,y=!0,v=[],x=0;for(;y;){let a=e.subarray(h);([()=>{y=ve.decode(a.subarray(0,4))=="INI2",p=a[15],h+=16,n=1},()=>{let c=ve.decode(a.subarray(0,4)),l=a[5],s=a[7],i=a[11],o=gt(a.subarray(12,16)),d=gt(a.subarray(16,20)),u=gt(a.subarray(36,40)),f=ve.decode(a.subarray(44,44+i));v.push({type:c,tipMsb:l,tipLsb:s,nameLen:i,length:o,start:d,entryLen:u,name:f}),h+=64,p--,p<1&&(n=2)},()=>{let c=v[x],l=e.subarray(c.start,c.start+c.length);switch(c.type){case"PRG1":break;case"PBK1":{let s=63,i=(c.tipMsb?6:0)+c.tipLsb;for(let o=0;o<128;o++){let d=o*c.entryLen,u=l.subarray(d,d+c.entryLen),f=ve.decode(u.subarray(0,24)).trimEnd().replace("InitProg","");f.length&&i>5&&(r+=`
${s.toString().padStart(3,"0")}	${i.toString().padStart(3,"0")}	${o.toString().padStart(3,"0")}	${f}`)}break}case"CBK1":{let s=63,i=(c.tipMsb?3:0)+c.tipLsb+10;for(let o=0;o<128;o++){let d=o*c.entryLen,u=l.subarray(d,d+c.entryLen),f=ve.decode(u.subarray(0,24)).trimEnd().replace("InitCombi","");f.length&&i>12&&(r+=`
${s.toString().padStart(3,"0")}	${i.toString().padStart(3,"0")}	${o.toString().padStart(3,"0")}	${f}`)}break}}x++,x>=v.length&&(n=3,y=!1)}][n]||(()=>{y=!1}))()}return r});L();var mt=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]),Et=["melodic","drums","drum set 1","drum set 2","drum set 3","drum set 4","drum set 5","drum set 6","drum set 7","drum set 8"],Na=[17.1,18.6,20.2,21.8,23.3,24.9,26.5,28,29.6,31.2,32.8,34.3,35.9,37.5,39,40.6,42.2,43.7,45.3,46.9,48.4,50],nt=[20,22,25,28,32,36,40,45,50,56,63,70,80,90,100,110,125,140,160,180,200,225,250,280,315,355,400,450,500,560,630,700,800,900,1e3,1100,1200,1400,1600,1800,2e3,2200,2500,2800,3200,3600,4e3,4500,5e3,5600,6300,7e3,8e3,9e3,1e4,11e3,12e3,14e3,16e3,18e3,2e4],Jt=[0,.04,.08,.13,.17,.21,.25,.29,.34,.38,.42,.46,.51,.55,.59,.63,.67,.72,.76,.8,.84,.88,.93,.97,1.01,1.05,1.09,1.14,1.18,1.22,1.26,1.3,1.35,1.39,1.43,1.47,1.51,1.56,1.6,1.64,1.68,1.72,1.77,1.81,1.85,1.89,1.94,1.98,2.02,2.06,2.1,2.15,2.19,2.23,2.27,2.31,2.36,2.4,2.44,2.48,2.52,2.57,2.61,2.65,2.69,2.78,2.86,2.94,3.03,3.11,3.2,3.28,3.37,3.45,3.53,3.62,3.7,3.87,4.04,4.21,4,37,4.54,4.71,4.88,5.05,5.22,5.38,5.55,5.72,6.06,6.39,6.73,7.07,7.4,7.74,8.08,8.41,8.75,9.08,9.42,9.76,10.1,10.8,11.4,12.1,12.8,13.5,14.1,14.8,15.5,16.2,16.8,17.5,18.2,19.5,20.9,22.2,23.6,24.9,26.2,27.6,28.9,30.3,31.6,33,34.3,37,39.7],jt=function(g){let e=.1,r=-.3;return g>66?(e=5,r=315):g>56?(e=1,r=47):g>46&&(e=.5,r=18.5),e*g-r},ea=function(g){return g>105?Na[g-106]:g>100?g*1.1-100:g/10},ta=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),Ut={};`hi*,
ka,か
ki,き
ku,く
ke,け
ko,こ
ky,き!
kw,くl
tsu,つ
ts,つl
sa,さ
si,すぃ
su,す
se,せ
so,そ
shi,し
sh,し!
ta,た
ti,てぃ
tu,とぅ
te,て
to,と
tchy,ち!
tchi,ち
na,な
ni,に
nu,ぬ
ne,ね
no,の
ny,に!
nn,ん
ha,は
hi,ひ
hu,ほぅ
he,へ
ho,ほ
hy,ひ!
fa,ふぁ
fi,ふぃ
fu,ふ
fe,ふぇ
fo,ふぉ
ma,ま
mi,み
mu,む
me,め
mo,も
my,み!
mm,
ra,ら
ri,り
ru,る
re,れ
ro,ろ
ry,り!
wa,わ
wi,うぃ
we,うぇ
wo,を
nga,ガ
ngi,ギ
ngu,グ
nge,ゲ
ngo,ゴ
ngy,ギ!
ng,
ga,が
gi,ぎ
gu,ぐ
ge,げ
go,ご
gy,ぎ!
gw,ぐl
za,ざ
zi,ずぃ
zu,ず
ze,ぜ
zo,ぞ
ja,じゃ
ji,じ
ju,じゅ
je,じぇ
jo,じょ
jy,じ!
da,だ
di,でぃ
du,どぅ
de,で
do,ど
dy,で!
ba,ば
bi,び
bu,ぶ
be,べ
bo,ぼ
by,び!
va,ゔぁ
vi,ゔぃ
vu,ゔ
ve,ゔぇ
vo,ゔぉ
pa,ぱ
pi,ぴ
pu,ぷ
pe,ペ
po,ぽ
py,ぴ!
!ya,ゃ
!yu,ゅ
!ye,ぇ
!yo,ょ
ya,や
yu,ゆ
ye,いぇ
yo,よ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
la,ぁ
li,ぃ
lu,ぅ
le,ぇ
lo,ぉ
a,あ
i,い
u,う
e,え
o,お
*,っ
~,
^,
_,`.split(`
`).forEach(g=>{let e=g.split(",");Ut[e[0]]=e[1]});var aa=function(g){let e=g;g[0]=="*"&&(e=e.slice(1)),["aa","ii","uu","ee","oo"].forEach(h=>{for(;e.indexOf(h)>-1;)e=e.replace(h,h[0])});for(let h in Ut)e=e.replaceAll(h,Ut[h]);e.indexOf("\u3093")==0&&e.length>1&&(e=e.slice(1));let r=e.indexOf("!");return r>-1&&e.length>1&&(e=e.slice(r+1)),e},ra=function(g){return g?g<96?`cc${g}`:["aftertouch","velocity","pitch bend"][g-96]:"off"};L();var Bt=["room 1","room 2","room 3","hall 1","hall 2","plate","delay","panning delay"],sa=["chorus 1","chorus 2","chorus 3","chorus 4","feedback","flanger","short delay","short delay feedback"],ia=["delay 1","delay 2","delay 3","delay 4","pan delay 1","pan delay 2","pan delay 3","pan delay 4","delay to reverb","pan repeat"];var Ha={0:"thru",256:"stereo EQ",257:"spectrum",258:"enhancer",259:"humanizer",272:"overdrive",273:"distortion",288:"phaser",289:"auto wah",290:"rotary",291:"stereo flanger",292:"step flanger",293:"tremelo",294:"auto pan",304:"compressor",305:"limiter",320:"hexa chorus",321:"tremelo chorus",322:"stereo chorus",323:"space D",324:"3D chorus",336:"stereo delay",337:"modulated delay",338:"3-tap delay",339:"4-tap delay",340:"tremelo control delay",341:"reverb",342:"gate reverb",343:"3D delay",352:"2-pitch shifter",353:"feedback pitch shifter",368:"3D auto",369:"3D manual",370:"Lo-Fi 1",371:"Lo-Fi 2",512:"overdrive - chorus",513:"overdrive - flanger",514:"overdrive - delay",515:"distortion - chorus",516:"distortion - flanger",517:"distortion - delay",518:"enhancer - chorus",519:"enhancer - flanger",520:"enhancer - delay",521:"chorus - delay",522:"flanger - delay",523:"chorus - flanger",524:"rotary multi",1024:"guitar multi 1",1025:"guitar multi 2",1026:"guitar multi 3",1027:"clean guitar multi 1",1028:"clean guitar multi 2",1029:"bass multi",1030:"rhodes multi",1280:"keyboard multi",4352:"chorus / delay",4353:"flanger / delay",4354:"chorus / flanger",4355:"overdrive / distortion",4356:"overdrive / rotary",4357:"overdrive / phaser",4358:"overdrive / auto wah",4359:"phaser / rotary",4360:"phaser / auto wah"},_a={66307:["drive"],66309:["vowel",g=>"aiueo"[g]],94723:["pre-filter"],94724:["Lo-Fi type"],94725:["post-filter"],94979:["Lo-Fi type"],94980:["fill type",g=>["off","LPF","HPF"][g]],94984:["noise type",g=>["white","pink"][g]],94987:["disc type",g=>["LP","SP","EP","RND"]],94990:["hum type",g=>`${g+5}0Hz`],94993:["M/S",g=>["mono","stereo"][g]]},Nt=function(g){return Ha[(g[0]-32<<8)+g[1]]||`0x${g[0].toString(16).padStart(2,"0")}${g[1].toString(16).padStart(2,"0")}`},na=function(g,e,r){let h=(g[0]-32<<16)+(g[1]<<8)+e,n=_a[h]||{},p=n[0];if(p!=null&&p.length)return p+=`: ${(n[1]||function(){})(r)||r}`,p},Ht=[68,48,95,78,41,3,110,122,0];L();var re=function(g=64){return Math.round(2e3*Math.log10(g/64))/100},ca=function(g,e,r){let h=[],n=r==!1?e.readIntVLV():r;g==0||g==127;for(let p=0;p<n;p++){let y=e.readInt(1);if(h.push(y),y!=247){if(y!=240){if(y>127)return console.debug(`Early termination: ${h}`),h.pop(),e.backOne(),e.backOne(),new Uint8Array(h)}}}return new Uint8Array(h)},Ae=function(g){let e=0;return g.forEach(r=>{e+=r,e=e&127}),~e+1&127},ge=function(g,e){let r=0,h=0;for(let n=0;n<g.length;n++){let p=n%8-1,y=(h>>p&1)<<7,v=g[n];v+=y,n%8!=0?(e(v,r,g),r++):h=g[n]}};var yt=function(g){let e=Math.floor(g*14.2);return e<128?e:0},A=function(){return!!self.Bun||self.debugMode||!1};var Q=["?","gm","gs","sc","xg","g2","mt32","doc","qy10","qy20","ns5r","x5d","05rw","k11","sg","sd","krs","s90es","motif","trin"],Ga={gm2:"g2","mt-32":"mt32","c/m":"mt32",ag10:"05rw","ag-10":"05rw","05r/w":"05rw",x5:"05rw",x5dr:"x5d",gmega:"k11","kross 2":"krs","motif es":"motif","s90 es":"s90es",trinity:"trin","tr-rack":"trin"},Xa=["melodic","drum","menu"],oa={"?":[0,0,120],gm:[0,0,127],gs:[0,0,120],sc:[0,0,120],xg:[0,0,127],g2:[0,0,120],mt32:[0,127,127],doc:[57,112,127],qy10:[57,113,127],qy20:[57,114,127],ns5r:[0,0,61],x5d:[82,0,62],"05rw":[81,0,62],k11:[0,0,122],sg:[0,0,122],sd:[97,0,105],krs:[121,0,120],s90es:[0,0,127],motif:[0,0,127],trin:[0,0,127]},la=[9,25,41,57,73,89,105,121],Va=[0,3,81,84,88],da={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},fa={0:0,1:1,2:3,5:4},ha={0:0,1:1,2:2,5:3},ua=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],pa=[36,37,48,49,52,53],Dt=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65],ga={26:127,29:0,30:0,31:0,52:12,53:54},vt=[0,1,2,4,5,6,7,8,10,11,32,38,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,84,91,92,93,94,95,98,99,100,101,128,12,13,16,17,18,19,14,15,20,21,26,28,80,81,83,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],Fa=[2,12,13,14,15,16,17,18,19,20,21,80,81,83,136,130,131,132,133,134,135,137,138,139,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],Ka=[33,99,100,32,102,8,9,10],ba=[0,16,25,40,32,64,26,48],k={};Q.forEach((g,e)=>{k[g]=e});var m={length:vt.length};vt.forEach((g,e)=>{m[g]=e});var fe={length:Dt.length};Dt.forEach((g,e)=>{fe[g]=e});var za={};Xa.forEach((g,e)=>{za[g]=e});var qa=function(g){let e=[],r=0;return g==null||g.forEach(function(h,n){h==247?e.push(g.subarray(r,n)):h==240&&(r=n+1)}),e.length||e.push(g.subarray(0)),A()&&console.debug(e),e};var ma=8,E={port:ma,ch:ma<<4,cc:vt.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,rpnt:4,ace:8,drm:8,dpn:Dt.length,dnc:128,ext:3,efx:7,cvn:12,redir:32,invalidCh:255},de={bank0:128},B,Y,be,Ce,le,Se,ya,he,K,D,b,Z,O,z,se,q,W,Te,$e,Xe,ie,R,I,ct,te,me,ne,ot,Ve,V,Oe,Ee,$t,Ie,ye,lt,Le,_,U,we,wt,H,Fe,dt,ft,Ue,Be,kt,ht,ke,G,Pt,xt,Ke,ce,Me,Ne,J,ze,F,St,Rt,qe,We,oe,ue,xe,Qe,Ye,Ze,Ea,Ir=(Ea=class extends Mt{constructor(){super();T(this,le);P(this,"NOTE_IDLE",0);P(this,"NOTE_ATTACK",1);P(this,"NOTE_DECAY",2);P(this,"NOTE_SUSTAIN",3);P(this,"NOTE_HELD",4);P(this,"NOTE_RELEASE",5);P(this,"NOTE_SOSTENUTO_ATTACK",8);P(this,"NOTE_SOSTENUTO_DECAY",9);P(this,"NOTE_SOSTENUTO_SUSTAIN",10);P(this,"NOTE_SOSTENUTO_HELD",11);P(this,"CH_MELODIC",0);P(this,"CH_DRUMS",1);P(this,"CH_DRUM1",2);P(this,"CH_DRUM2",3);P(this,"CH_DRUM3",4);P(this,"CH_DRUM4",5);P(this,"CH_DRUM5",6);P(this,"CH_DRUM6",7);P(this,"CH_DRUM7",8);P(this,"CH_DRUM8",9);P(this,"DUMP_ALL",0);P(this,"DUMP_ONCE",1);P(this,"DUMP_MODE",2);P(this,"EXT_NONE",0);P(this,"EXT_VL",1);P(this,"EXT_DX",3);P(this,"VLBC_BRTHEXPR",1);P(this,"VLBC_VELOINIT",2);P(this,"VLBC_VELOALL",3);P(this,"CH_INACTIVE",0);P(this,"CH_ACTIVE",1);P(this,"CH_DISABLED",2);T(this,B,0);T(this,Y,0);T(this,be,0);T(this,Ce,new Array(11));T(this,he,new Uint8Array(E.ch));T(this,K,new Uint8Array(E.ch));T(this,D,new Uint8Array(E.ch));T(this,b,new Uint8Array(E.ch*E.cc));T(this,Z,new Uint8Array(E.ch*E.ace));T(this,O,new Uint8Array(E.ch));T(this,z,new Uint8Array(E.ch*E.nn));T(this,se,new Uint8Array(E.ch));T(this,q,new Uint16Array(E.pl));T(this,W,new Uint8Array(E.pl));T(this,Te,new Int16Array(E.ch));T(this,$e,new Uint8Array(E.ch));T(this,Xe,new Uint8Array(E.ch));T(this,ie,new Uint8Array(E.ch*E.ext));T(this,R,new Uint8Array(E.ch*E.rpn));T(this,I,new Uint8Array(E.ch*E.rpnt));T(this,ct,new Int8Array(E.ch*pa.length));T(this,te,new Uint8Array(E.drm*E.dpn*E.dnc));T(this,me,new Uint8Array(E.drm*2));T(this,ne,new Uint8Array(E.efx*3));T(this,ot,new Uint8Array(E.ch));T(this,Ve,new Uint8Array(E.ch*E.redir));T(this,V,new Uint8Array(E.port));T(this,Oe,new Uint8Array(E.ch));T(this,Ee,new Uint8Array(E.ch));T(this,$t,new Uint8Array(E.ch*E.cvn));T(this,Ie,new Uint8Array(128));T(this,ye,new Uint8Array(E.cmt*8));T(this,lt,new Uint8Array(1024));T(this,Le,new Uint8Array(E.cmt*64));T(this,_,{});T(this,U,void 0);T(this,we,void 0);T(this,wt,void 0);T(this,H,100);T(this,Fe,0);T(this,dt,500);T(this,ft,0);T(this,Ue,"");T(this,Be,0);T(this,kt,0);T(this,ht,0);T(this,ke,!0);T(this,G,!1);T(this,Pt,1);T(this,xt,void 0);T(this,Ke,new Array(E.ch));T(this,ce,[]);T(this,Me,new Uint8Array(E.ch));T(this,Ne,new Uint8Array(E.tr));P(this,"baseBank",new Lt("gm","gm2","xg","gs","ns5r","sd","gmega","plg-vl","plg-pf","plg-dx","plg-an","plg-dr","plg-sg","kross","s90es"));P(this,"userBank",new Lt("gm"));P(this,"initOnReset",!1);P(this,"aiEfxName","");T(this,J,[]);T(this,ze,void 0);T(this,F,{nOff:(e,r)=>{let h=e*128+r,n=t(this,q).lastIndexOf(h);if(n>-1)if(t(this,b)[E.cc*e+m[64]]>63)t(this,W)[n]=this.NOTE_HELD,this.dispatchEvent("note",{part:e,note:r,velo:t(this,z)[h],state:this.NOTE_HELD});else if(t(this,b)[E.cc*e+m[66]]>63&&t(this,W)[n]==this.NOTE_SOSTENUTO_SUSTAIN)t(this,W)[n]=this.NOTE_SOSTENUTO_HELD,this.dispatchEvent("note",{part:e,note:r,velo:t(this,z)[h],state:this.NOTE_SOSTENUTO_HELD});else{t(this,q)[n]=0,t(this,z)[h]=0,t(this,W)[n]=this.NOTE_IDLE;let p=this.getExt(e)[1];(p==this.VLBC_VELOINIT||p==this.VLBC_VELOALL)&&(t(this,b)[E.cc*e+m[129]]=0),this.dispatchEvent("note",{part:e,note:r,velo:0,state:this.NOTE_IDLE})}},nOn:(e,r,h)=>{let n=e*128+r,p=0;for(t(this,se)[e]&&t(this,F).ano(e);t(this,W)[p]>0&&t(this,q)[p]!=n;)p++;if(p<E.pl){t(this,q)[p]=n,t(this,z)[n]=h,t(this,W)[p]=this.NOTE_SUSTAIN,t(this,$e)[e]<h&&(t(this,$e)[e]=h);let y=this.getExt(e)[1];(y==this.VLBC_VELOINIT||y==this.VLBC_VELOALL)&&(t(this,b)[E.cc*e+m[129]]=h),this.dispatchEvent("note",{part:e,note:r,velo:h,state:this.NOTE_SUSTAIN})}else console.error("Polyphony exceeded.")},nAt:(e,r,h)=>{},cAt:(e,r)=>{},hoOf:e=>{t(this,W).forEach((r,h)=>{if(r==this.NOTE_HELD){let n=t(this,q)[h],p=n>>7;e==p&&(t(this,W)[h]=this.NOTE_IDLE,t(this,q)[h]=0,t(this,z)[n]=0,this.dispatchEvent("note",{part:e,note:n&127,velo:0,state:this.NOTE_IDLE}))}})},soOn:e=>{t(this,W).forEach((r,h)=>{let n;switch(r){case this.NOTE_ATTACK:{n=this.NOTE_SOSTENUTO_ATTACK;break}case this.NOTE_DECAY:{n=this.NOTE_SOSTENUTO_DECAY;break}case this.NOTE_SUSTAIN:{n=this.NOTE_SOSTENUTO_SUSTAIN;break}}if(n){t(this,W)[h]=n;let p=t(this,q)[h];this.dispatchEvent("note",{part:e,note:p&127,velo:t(this,z)[p],state:n})}})},soOf:e=>{t(this,W).forEach((r,h)=>{if(r==this.NOTE_SOSTENUTO_HELD){let n=t(this,q)[h],p=n>>7;e==p&&(t(this,W)[h]=this.NOTE_IDLE,t(this,q)[h]=0,t(this,z)[n]=0,this.dispatchEvent("note",{part:e,note:n&127,velo:0,state:this.NOTE_IDLE}))}})},ano:e=>{t(this,q).forEach((r,h,n)=>{let p=r>>7,y=r&127;r==0&&t(this,z)[0]==0||p==e&&t(this,F).nOff(p,y)})}});T(this,St,{8:function(e){let r=e.channel,h=e.data[0];t(this,F).nOff(r,h)},9:function(e){let r=e.channel,h=this;if(h.getChModeId(r)==k.xg&&t(h,D)[r]>1){let y=h.getChDrumFirstWrite(r);y[0]&&y[1]!=E.invalidCh&&!t(h,he)[r]&&(h.copyChSetup(y[1],r),h.dispatchEvent("voice",{part:r}),console.debug(`Part CH${r+1} copied from CH${y[1]}.`))}h.setChActive(r,1);let n=e.data[0],p=e.data[1];p>0?t(h,F).nOn(r,n,p):t(h,F).nOff(r,n)},10:function(e){let r=e.channel,h=r*128+e.data[0];t(this,q).indexOf(h)>-1&&(t(this,z)[h]=data[1],this.getExt(r)[1]==this.VLBC_VELOALL&&(t(this,b)[E.cc*r+m[129]]=data[1]),this.dispatchEvent("note",{part:r,note:e.data[0],velo:e.data[1],state:this.NOTE_SUSTAIN}))},11:function(e){let r=e.channel,h=this,n=t(this,Ke)[r],p=n[e.data[0]];p&&(e.data[0]=p),[0,32].indexOf(e.data[0])>-1&&(()=>{switch(t(this,B)){case k.s90es:case k.motif:{if(e.data[0]==0){[0,63].indexOf(e.data[1])>-1&&this.setChActive(r,1);break}e.data[1]&&this.setChActive(r,1);break}default:{this.setChActive(r,1);break}}})();let y=r*E.cc,v=r*E.ext,x=this.getChModeId(r);switch(e.data[0]){case 96:return;case 97:return;case 120:return;case 121:{t(this,F).ano(r),t(this,Te)[r]=0,t(this,b)[y+m[1]]=0,t(this,b)[y+m[5]]=0,t(this,b)[y+m[64]]=0,t(this,b)[y+m[65]]=0,t(this,b)[y+m[66]]=0,t(this,b)[y+m[67]]=0,t(this,b)[y+m[11]]=127,t(this,b)[y+m[101]]=127,t(this,b)[y+m[100]]=127,t(this,b)[y+m[99]]=127,t(this,b)[y+m[98]]=127;return}case 123:{t(this,F).ano(r);return}case 124:{t(this,F).ano(r);return}case 125:{t(this,F).ano(r);return}case 126:{t(this,se)[r]=1,t(this,F).ano(r);return}case 127:{t(this,se)[r]=0,t(this,F).ano(r);return}}if(m[e.data[0]]==null)console.warn(`cc${e.data[0]} is not accepted.`);else{switch(Fa.indexOf(e.data[0])>-1&&this.allocateAce(r,e.data[0]),e.data[0]){case 0:{switch(A()&&console.debug(`${Q[t(this,B)]}, CH${r+1}: ${e.data[1]}`),t(this,B)==0?e.data[1]<48?(t(this,D)[r]>0&&(e.data[1]=t(this,b)[y],e.data[1]=120,console.debug(`Forced channel ${r+1} to stay drums.`)),e.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${e.data[1]}`),this.switchMode("gs"))):e.data[1]==56?this.switchMode(t(this,U).x5==82?"x5d":"05rw"):e.data[1]==62?this.switchMode(t(this,U).x5==82?"x5d":"05rw"):e.data[1]==63?this.switchMode(Q[t(this,U).ds]):(e.data[1]==64||e.data[1]==127)&&this.switchMode("xg"):t(this,B)==k.gs||t(this,B)==k.sc?e.data[1]<56&&t(this,D)[r]>0&&(e.data[1]=t(this,b)[y],e.data[1]=120,console.debug(`Forced channel ${r+1} to stay drums.`)):t(this,B)==k.gm&&(e.data[1]<48?t(this,D)[r]>0&&(e.data[1]=120,this.switchMode("gs",!0),console.debug(`Forced channel ${r+1} to stay drums.`)):(e.data[1]==64||e.data[1]==127)&&this.switchMode("xg",!0)),t(this,B)){case k.xg:{[79,95,126,127].indexOf(e.data[1])>-1?t(this,D)[r]==0&&(this.setChType(r,this.CH_DRUM2),console.debug(`CH${r+1} set to drums by MSB.`)):t(this,D)[r]>0&&(this.setChType(r,this.CH_MELODIC),console.debug(`CH${r+1} set to melodic by MSB.`)),[33,81,97].indexOf(e.data[1])>-1?t(this,ie)[v]=this.EXT_VL:[35,67,83,99].indexOf(e.data[1])>-1?t(this,ie)[v]=this.EXT_DX:t(this,ie)[v]=this.EXT_NONE;break}case k["05rw"]:case k.x5d:case k.ns5r:{[61,62,126,127].indexOf(e.data[1])>-1?t(this,D)[r]==this.CH_MELODIC&&(this.setChType(r,this.CH_DRUM2),console.debug(`CH${r+1} set to drums by MSB.`)):[80,81,82,83].indexOf(e.data[1])>-1||t(this,D)[r]!=this.CH_MELODIC&&(this.setChType(r,this.CH_MELODIC),console.debug(`CH${r+1} set to melodic by MSB.`));break}case k.sd:{[104,105,106,107].indexOf(e.data[1])>-1?t(this,D)[r]==0&&(this.setChType(r,this.CH_DRUM2),console.debug(`CH${r+1} set to drums by MSB.`)):t(this,D)[r]>0&&(this.setChType(r,this.CH_MELODIC),console.debug(`CH${r+1} set to melodic by MSB.`));break}case k.g2:{e.data[1]==120?t(this,D)[r]==0&&(this.setChType(r,this.CH_DRUMS),console.debug(`CH${r+1} set to drums by MSB.`)):t(this,D)[r]>0&&(this.setChType(r,this.CH_MELODIC),console.debug(`CH${r+1} set to melodic by MSB.`));break}}this.dispatchEvent("voice",{part:r});break}case 2:{this.getExt(r)[1]==this.VLBC_BRTHEXPR&&(t(this,b)[y+m[129]]=e.data[1]);break}case 6:{if(t(this,Xe)[r]){[k.xg,k.gs,k.sc,k.ns5r].indexOf(t(this,B))<0&&console.warn(`NRPN commits are not available under "${Q[t(this,B)]}" mode, even when they are supported in Octavia.`);let a=t(this,b)[y+m[99]],c=t(this,b)[y+m[98]];if(a==1){let l=Ka.indexOf(c);if(l>-1)t(this,b)[y+m[71+l]]=e.data[1],A()&&console.debug(`Redirected NRPN 1 ${c} to cc${71+l}.`),this.dispatchEvent("cc",{part:r,cc:71+l,data:e.data[1]});else{let s=pa.indexOf(c);s>-1?t(this,ct)[r*10+s]=e.data[1]-64:console.warn(`NRPN 0x01${c.toString(16).padStart(2,"0")} is not supported.`),A()&&console.debug(`CH${r+1} voice NRPN ${c} commit`)}}else{if(Dt.indexOf(a)<0){let s=`NRPN 0x${a.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")} `;a==127?console.warn(`${s}is not necessary. Consider removing it.`):console.warn(`${s}is not supported.`)}else{let s=t(this,D)[r]-2;s<0?console.warn(`CH${r+1} cannot accept drum NRPN as type ${Et[t(this,D)[r]]}.`):t(this,te)[(s*E.dpn+fe[a])*E.dnc+c]=e.data[1]}A()&&console.debug(`CH${r+1} (${Et[t(this,D)[r]]}) drum NRPN ${a} commit`)}}else{let a=fa[t(this,b)[y+m[100]]],c=ha[t(this,b)[y+m[100]]];if(t(this,b)[y+m[101]]==0&&a!=null)switch(A()&&console.debug(`CH${r+1} RPN 0 ${t(this,b)[y+m[100]]} commit: ${e.data[1]}`),e.data[1]=Math.min(Math.max(e.data[1],ua[a][0]),ua[a][1]),t(this,R)[r*E.rpn+a]=e.data[1],t(this,I)[r*E.rpnt+c]=1,x){case k.xg:case k.gs:case k.sc:case k.mt32:case k.s90es:case k.motif:{switch(t(this,b)[y+m[100]]){case 1:case 2:{this.dispatchEvent("pitch",{part:r,pitch:this.getPitchShift(r)});break}}break}default:this.dispatchEvent("pitch",{part:r,pitch:this.getPitchShift(r)})}}break}case 32:{switch(A()&&console.debug(`${Q[t(this,B)]}, CH${r+1} LSB: ${e.data[1]}`),t(this,B)){case k.s90es:case k.motif:{this.setChType(r,[32,40].indexOf(e.data[1])>-1?this.CH_DRUMS:this.CH_MELODIC,t(this,B),!0);break}}this.getExt(r)[0]==this.EXT_DX,this.dispatchEvent("voice",{part:r});break}case 38:{if(!t(this,Xe)[r]){let a=fa[t(this,b)[y+100]],c=ha[t(this,b)[y+100]];t(this,b)[y+101]==0&&a!=null&&(t(this,R)[r*E.rpn+a+1]=e.data[1],t(this,I)[r*E.rpnt+c]=1)}break}case 64:{e.data[1]<64&&t(this,F).hoOf(r);break}case 66:{e.data[1]>>6?t(this,F).soOn(r):t(this,F).soOf(r);break}case 98:case 99:{t(this,Xe)[r]=1;break}case 100:case 101:{t(this,Xe)[r]=0;break}}t(this,b)[y+m[e.data[0]]]=e.data[1],this.dispatchEvent("cc",{part:r,cc:e.data[0],data:e.data[1]})}h.getChModeId(r)==k.xg&&t(h,D)[r]&&h.setDrumFirstWrite(r)},12:function(e){let r=e.channel,h=this;switch(t(h,B)){case k.s90es:case k.motif:{e.data&&h.setChActive(r,1);break}default:h.setChActive(r,1)}if(h.getExt(r)[0]==h.EXT_DX){let n=E.cc*r}t(h,O)[r]=e.data,t(h,Ee)[r]=0,A()&&console.debug(`T:${e.track} C:${r} P:${e.data}`),h.dispatchEvent("voice",{part:r}),h.getChModeId(r)==k.xg&&t(h,D)[r]&&h.setDrumFirstWrite(r)},13:function(e){let r=this,h=e.channel;t(this,q).forEach(function(n){let p=n>>7;h==p&&(t(r,z)[n]=e.data,r.dispatchEvent("note",{part:h,note:n&127,velo:e.data,state:r.NOTE_SUSTAIN}))})},14:function(e){let r=e.channel;t(this,Te)[r]=e.data[1]*128+e.data[0]-8192,this.dispatchEvent("pitch",{part:r,pitch:this.getPitchShift(r)})},15:function(e){qa(e.data).forEach(r=>{let h=r[0],n=r[1];(t(this,Rt)[h]||function(){console.debug(`Unknown manufacturer ${h}.`)})(n,r.subarray(2),e.track)})},248:function(e){},250:function(e){},251:function(e){},252:function(e){},254:function(e){},255:function(e){(t(this,J)[e.meta]||function(h,n,p){}).call(this,e.data,e.track,e.meta),e.meta!=32&&S(this,Fe,0);let r=Va.indexOf(e.meta)>-1;if(A()&&console.debug(e),r)return e.reply="meta",e}});T(this,Rt,{64:(e,r,h)=>{t(this,Qe).run(r,h,e)},65:(e,r,h)=>{if(r[0]<16){if(r[1]==72){let n=r[r.length-1],p=Ae(r.subarray(3,r.length-1));n==p?t(this,ue).run(r.subarray(0,r.length-1),h,e):console.warn(`Bad SD checksum ${n} - should be ${p}.`)}else t(this,ue).run(r,h,e);}else{let n=r[r.length-1],p=Ae(r.subarray(2,r.length-1));n==p?t(this,ue).run(r.subarray(0,r.length-1),h,e):console.warn(`Bad GS checksum ${n} - should be ${p}.`)}},66:(e,r,h)=>{t(this,xe).run(r,h,e)},67:(e,r,h)=>{t(this,oe).run(r,h,e)},68:(e,r,h)=>{t(this,Ze).run(r,h,e)},71:(e,r,h)=>{t(this,Ye).run(r,h,e)},126:(e,r,h)=>{t(this,qe).run(r,h,e)},127:(e,r,h)=>{this.switchMode("gm"),t(this,We).run(r,h,e)}});T(this,qe,void 0);T(this,We,void 0);T(this,oe,void 0);T(this,ue,void 0);T(this,xe,void 0);T(this,Qe,void 0);T(this,Ye,void 0);T(this,Ze,void 0);let e=this;S(e,le,new Uint8Array(256),ya),t(e,Ce)[10]=new Uint8Array(512),S(e,ze,new pe),S(e,U,{x5:82,ds:k.krs,smotif:k.s90es,gs:4,sc:3}),S(e,we,{dumpLimit:e.DUMP_MODE}),S(e,wt,new Proxy(t(e,we),{set:()=>{}}));for(let a in oa){let c=k[a];c==null?console.debug(`SubDB build error: "${a}" does not exist`):t(e,_)[c]=new Uint8Array(oa[a])}e.userBank.strictMode=!0,e.userBank.load(`MSB	PRG	LSB	NME
062	000	000	
122	000	000	
122	001	000	
122	002	000	
122	003	000	
122	004	000	
122	005	000	
122	006	000	`),e.addEventListener("metacommit",function(a){var l,s;let{data:c}=a;((l=t(e,ce)[0])==null?void 0:l.type)==c.type&&(s=t(e,ce)[0])!=null&&s.amend?(t(e,ce)[0].amend=c.amend,t(e,ce)[0].data+=c.data):t(e,ce).unshift(c)}),t(e,J)[1]=function(a){var c,l,s,i,o;switch(a=a.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),a.slice(0,2)){case"@I":{S(this,G,!0),this.dispatchEvent("metacommit",{type:"Kar.Info",data:(c=a.slice(2))==null?void 0:c.trimLeft()});break}case"@K":{S(this,G,!0),this.dispatchEvent("metacommit",{type:"Kar.Mode",data:(l=a.slice(2))==null?void 0:l.trimLeft()}),console.debug(`Karaoke mode active: ${a.slice(2)}`);break}case"@L":{S(this,G,!0),this.dispatchEvent("metacommit",{type:"Kar.Lang",data:(s=a.slice(2))==null?void 0:s.trimLeft()});break}case"@T":{S(this,G,!0),this.dispatchEvent("metacommit",{type:"KarTitle",data:(i=a.slice(2))==null?void 0:i.trimLeft()});break}case"@V":{S(this,G,!0),this.dispatchEvent("metacommit",{type:"Kar.Ver.",data:(o=a.slice(2))==null?void 0:o.trimLeft()});break}case"XF":{let d=a.slice(2).split(":");switch(d[0]){case"hd":{d.slice(1).forEach((u,f)=>{u.length&&this.dispatchEvent("metacommit",{type:["XfSngDte","XfSngRgn","XfSngCat","XfSongBt","XfSngIns","XfSngVoc","XfSngCmp","XfSngLrc","XfSngArr","XfSngPer","XfSngPrg","XfSngTag"][f],data:u})});break}case"ln":{d.slice(1).forEach((u,f)=>{u.length&&this.dispatchEvent("metacommit",{type:["XfKarLng","XfKarNme","XfKarCmp","XfKarLrc","XfKarArr","XfKarPer","XfKarPrg"][f],data:u})});break}default:this.dispatchEvent("metacommit",{type:"XfUnData",data:a})}break}default:t(this,G)?a[0]=="\\"?(this.dispatchEvent("metacommit",{type:"KarLyric",data:"",amend:!1}),this.dispatchEvent("metacommit",{type:"KarLyric",data:a.slice(1),amend:!0})):a[0]=="/"?(this.dispatchEvent("metacommit",{type:"KarLyric",data:"",mask:!0,amend:!1}),this.dispatchEvent("metacommit",{type:"KarLyric",data:a.slice(1),mask:!0,amend:!0})):this.dispatchEvent("metacommit",{type:"KarLyric",data:a,amend:!0}):a.split(`
`).forEach((d,u)=>{this.dispatchEvent("metacommit",{type:"Cmn.Text",data:d,mask:u!=0})})}},t(e,J)[2]=function(a){this.dispatchEvent("metacommit",{type:"Copyrite",data:a})},t(e,J)[3]=function(a,c){c<1&&t(this,Fe)<1&&this.dispatchEvent("metacommit",{type:"TrkTitle",data:a})},t(e,J)[4]=function(a,c){this.dispatchEvent("metacommit",{type:"Instrmnt",data:a})},t(e,J)[5]=function(a){a.trim()==""?this.dispatchEvent("metacommit",{type:"C.Lyrics",data:"",amend:!1}):this.dispatchEvent("metacommit",{type:"C.Lyrics",data:a,amend:!0})},t(e,J)[6]=function(a){this.dispatchEvent("metacommit",{type:"C.Marker",data:a})},t(e,J)[7]=function(a){this.dispatchEvent("metacommit",{type:"CuePoint",data:a})},t(e,J)[32]=function(a){S(this,Fe,a[0]+1)},t(e,J)[33]=function(a,c){A()&&console.debug(`Track ${c} requests to get assigned to output ${a}.`),t(e,Ne)[c]=a+1},t(e,J)[81]=function(a,c){S(e,dt,a/1e3)},t(e,J)[127]=function(a,c){t(e,ze).run(a,c)},t(e,ze).default=function(a){console.warn(`Unrecognized sequencer-specific byte sequence: ${a}`)},t(e,ze).add([67,0,1],function(a,c){A()&&console.debug(`XGworks requests assigning track ${c} to output ${a[0]}.`),t(e,Ne)[c]=a[0]+1}),S(e,qe,new pe("universal non-realtime")),S(e,We,new pe("universal realtime")),S(e,oe,new pe("Yamaha")),S(e,ue,new pe("Roland")),S(e,xe,new pe("Korg")),S(e,Qe,new pe("Kawai")),S(e,Ye,new pe("Akai")),S(e,Ze,new pe("Casio"));let r=new pe("DX7+ Dump"),h=function(a){console.info(`Unrecognized SysEx in "${this.name}" set.
%o`,a)};t(e,qe).default=h,t(e,We).default=h,t(e,oe).default=h,t(e,ue).default=h,t(e,xe).default=h,t(e,Qe).default=h,t(e,Ye).default=h,t(e,Ze).default=h,r.default=h,t(e,qe).add([9],(a,c,l)=>{e.switchMode(["gm","?","g2"][a[0]-1],!0),e.setPortMode(e.getTrackPort(c),1,k[["gm","?","g2"][a[0]-1]]),S(e,G,t(e,G)||!1),console.info(`MIDI reset: ${["GM","Init","GM2"][a[0]-1]}`),a[0]==2&&e.init()}),t(e,We).add([4,1],(a,c,l)=>{e.dispatchEvent("mupromptex"),S(e,H,((a[1]<<7)+a[0])/16383*100),e.dispatchEvent("mastervolume",t(e,H))}).add([4,3],(a,c,l)=>((a[1]<<7)+a[0]-8192)/8192).add([4,4],(a,c,l)=>a[1]-64).add([4,5],(a,c,l)=>{e.dispatchEvent("mupromptex");let s=a[0],i=a[1],o=a[2],d=3,u=d+(s<<1),f=u+i;if(s!=1){console.error(`Unsupported GM2 global parameter set: slotpath length too long (${s})!
`,a);return}let $=0,w=0,C=0;switch(a.subarray(d,u).forEach(M=>{$=$<<7,$|=M}),a.subarray(u,f).forEach((M,X)=>{w|=M<<X*7}),a.subarray(f).forEach((M,X)=>{C|=M<<X*7}),A()&&console.debug(`GM2 global parameter: (${a.subarray(3,u)}; p: ${w}, v: ${C})`),$){case 129:{w==0&&(e.setEffectType(0,52,C),e.dispatchEvent("efxreverb",e.getEffectType(0)));break}case 130:{w==0&&(e.setEffectType(1,52,C|16),e.dispatchEvent("efxchorus",e.getEffectType(1)));break}default:A()&&console.debug("GM2 global paramater slot path unknown.")}}),t(this,oe).add([76,0,0],(a,c,l)=>{switch(a[0]){case 125:{e.initDrums(),console.info(`XG drum setup reset: ${a}`);break}case 126:{e.switchMode("xg",!0),e.setPortMode(e.getTrackPort(c),4,k.xg),S(e,G,!1),console.info("MIDI reset: XG");break}default:{e.dispatchEvent("mupromptex");let s=[0,0,0,0],i=(o,d)=>{s[d]=o};if(a.subarray(1).forEach((o,d)=>{let u=d+a[0];([i,i,i,i,f=>{S(this,H,f*129/16383*100),e.dispatchEvent("mastervolume",t(e,H))},f=>{},f=>{}][u]||(()=>{}))(o,d)}),a[0]<4){let o=0;s.forEach(d=>{o=o<<4,o+=d}),o-=1024}}}}).add([76,2,1],(a,c,l)=>{e.dispatchEvent("mupromptex");let s="XG ";a[0]<32?(s+="reverb ",a.subarray(1).forEach((i,o)=>{([d=>{e.setEffectTypeRaw(0,!1,d),console.info(`${s}main type: ${mt[d]}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},d=>{e.setEffectTypeRaw(0,!0,d),console.debug(`${s}sub type: ${d+1}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},d=>{console.debug(`${s}time: ${jt(d)}s`)},d=>{console.debug(`${s}diffusion: ${d}`)},d=>{console.debug(`${s}initial delay: ${d}`)},d=>{console.debug(`${s}HPF cutoff: ${nt[d]}Hz`)},d=>{console.debug(`${s}LPF cutoff: ${nt[d]}Hz`)},d=>{console.debug(`${s}width: ${d}`)},d=>{console.debug(`${s}height: ${d}`)},d=>{console.debug(`${s}depth: ${d}`)},d=>{console.debug(`${s}wall type: ${d}`)},d=>{console.debug(`${s}dry/wet: ${d}`)},d=>{console.debug(`${s}send: ${re(d)}dB`)},d=>{console.debug(`${s}pan: ${d-64}`)},!1,!1,d=>{console.debug(`${s}delay: ${d}`)},d=>{console.debug(`${s}density: ${d}`)},d=>{console.debug(`${s}balance: ${d}`)},d=>{},d=>{console.debug(`${s}feedback: ${d}`)},d=>{}][a[0]+o]||function(){console.warn(`Unknown XG reverb address: ${a[0]}.`)})(i)})):a[0]<64?(s+="chorus ",a.subarray(1).forEach((i,o)=>{([d=>{e.setEffectTypeRaw(1,!1,d),console.info(`${s}main type: ${mt[d]}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},d=>{e.setEffectTypeRaw(1,!0,d),console.debug(`${s}sub type: ${d+1}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},d=>{console.debug(`${s}LFO: ${Jt[d]}Hz`)},d=>{},d=>{console.debug(`${s}feedback: ${d}`)},d=>{console.debug(`${s}delay offset: ${ea(d)}ms`)},d=>{},d=>{console.debug(`${s}low: ${nt[d]}Hz`)},d=>{console.debug(`${s}low: ${d-64}dB`)},d=>{console.debug(`${s}high: ${nt[d]}Hz`)},d=>{console.debug(`${s}high: ${d-64}dB`)},d=>{console.debug(`${s}dry/wet: ${d}`)},d=>{console.debug(`${s}send: ${re(d)}dB`)},d=>{console.debug(`${s}pan: ${d-64}`)},d=>{console.debug(`${s}to reverb: ${re(d)}dB`)},!1,d=>{},d=>{},d=>{},d=>{console.debug(`${s}LFO phase diff: ${(d-64)*3}deg`)},d=>{console.debug(`${s}input mode: ${d?"stereo":"mono"}`)},d=>{}][a[0]-32+o]||function(){console.warn(`Unknown XG chorus address: ${a[0]}.`)})(i)})):a[0]<86?(s+="variation ",a.subarray(1).forEach((i,o)=>{([d=>{e.setEffectTypeRaw(2,!1,d),console.info(`${s}main type: ${mt[d]}`),e.dispatchEvent("efxdelay",e.getEffectType(2))},d=>{e.setEffectTypeRaw(2,!0,d),console.debug(`${s}sub type: ${d+1}`),e.dispatchEvent("efxdelay",e.getEffectType(2))}][a[0]-64+o]||function(){})(i)})):a[0]<97?(s+="variation ",a.subarray(1).forEach((i,o)=>{[d=>{console.debug(`${s}send: ${re(d)}dB`)},d=>{console.debug(`${s}pan: ${d-64}`)},d=>{console.debug(`${s}to reverb: ${re(d)}dB`)},d=>{console.debug(`${s}to chorus: ${re(d)}dB`)},d=>{console.debug(`${s}connection: ${d?"system":"insertion"}`)},d=>{console.debug(`${s}channel: CH${d+1}`)},d=>{console.debug(`${s}mod wheel: ${d-64}`)},d=>{console.debug(`${s}bend wheel: ${d-64}`)},d=>{console.debug(`${s}channel after touch: ${d-64}`)},d=>{console.debug(`${s}AC1: ${d-64}`)},d=>{console.debug(`${s}AC2: ${d-64}`)}][a[0]-86+o](i)})):a[0]>111&&a[0]<118?s+="variation ":console.warn(`Unknown XG variation address: ${a[0]}`)}).add([76,2,64],(a,c,l)=>{a.subarray(1).forEach((s,i)=>{let o=i+a[0];if(o==0)console.debug(`XG EQ preset: ${["flat","jazz","pop","rock","classic"][s]}`);else{let d=o-1>>2,u=o-1&3,f=`XG EQ ${d} ${["gain","freq","Q","shape"][u]}: `;[()=>{console.debug(`${f}${s-64}dB`)},()=>{console.debug(`${f}${s} (raw)`)},()=>{console.debug(`${f}${s/10}`)},()=>{console.debug(`${f}${["shelf","peak"][+!!s]}`)}][u]()}})}).add([76,3],(a,c,l)=>{e.dispatchEvent("mupromptex");let s=a[0],i=a[1],o=`XG Insertion ${a[0]+1} `;a.subarray(2).forEach((d,u)=>{([f=>{e.setEffectTypeRaw(3+s,!1,f),console.info(`${o}main type: ${mt[f]}`),e.dispatchEvent(`efxinsert${s}`,e.getEffectType(3+s))},f=>{e.setEffectTypeRaw(3+s,!0,f),console.debug(`${o}sub type: ${f+1}`),e.dispatchEvent(`efxinsert${s}`,e.getEffectType(3+s))}][i+u]||function(){})(d)})}).add([76,6,0],(a,c,l)=>{let s=a[0];s<64?e.setLetterDisplay(a.subarray(1),"XG letter display",s):S(e,Be,Date.now())}).add([76,7,0],(a,c,l)=>{let s=a[0];S(e,Y,0),S(e,be,Date.now()+3200),t(e,le,Se).fill(0);let i=a.subarray(1);for(let o=0;o<s;o++)i.unshift(0);i.forEach(function(o,d){let u=Math.floor(d/16),f=d%16,$=(f*3+u)*7,w=7,C=0;for($-=f*5,u==2&&(w=2);C<w;)t(e,le,Se)[$+C]=o>>6-C&1,C++})}).add([76,8],(a,c)=>{e.dispatchEvent("mupromptex");let l=e.chRedir(a[0],c,!0),s=a[1],i=E.cc*l,o=`XG CH${l+1} `,d=`Unknown XG part address ${s}.`,u=!0;a.subarray(2).forEach((f,$)=>{u=!0,s<1?console.debug(d):s<41?([()=>{t(e,b)[i+m[0]]=f,e.dispatchEvent("voice",{part:l})},()=>{t(e,b)[i+m[32]]=f,e.dispatchEvent("voice",{part:l})},()=>{t(e,O)[l]=f,e.dispatchEvent("voice",{part:l})},()=>{u=!1;let w=e.chRedir(f,c,!0);t(e,K)[l]=w,l!=w&&(e.buildRchTree(),console.info(`${o}receives from CH${w+1}`)),t(e,he)[l]||(e.copyChSetup(w,l,!0),console.debug(`${o}copied from CH${w+1}.`),e.setChActive(l,1),e.dispatchEvent("voice",{part:l}))},()=>{t(e,se)[l]=+!f},()=>{},()=>{u=!1,e.setChType(l,f,k.xg),console.debug(`${o}type: ${Et[f]||f}`),e.dispatchEvent("voice",{part:l})},()=>{t(e,R)[E.rpn*l+3]=f,t(e,I)[E.rpnt*l+2]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)})},!1,!1,()=>{t(e,b)[i+m[7]]=f},!1,!1,()=>{t(e,b)[i+m[10]]=f||128},!1,!1,()=>{t(e,b)[i+m[128]]=f,e.allocateAce(l,128)},()=>{t(e,b)[i+m[93]]=f},()=>{t(e,b)[i+m[91]]=f},()=>{t(e,b)[i+m[94]]=f},()=>{t(e,b)[i+m[76]]=f},()=>{t(e,b)[i+m[77]]=f},()=>{t(e,b)[i+m[78]]=f},()=>{t(e,b)[i+m[74]]=f},()=>{t(e,b)[i+m[71]]=f},()=>{t(e,b)[i+m[73]]=f},()=>{t(e,b)[i+m[75]]=f},()=>{t(e,b)[i+m[72]]=f}][s+$-1]||(()=>{}))():s<48?console.debug(d):s<111?s>102&&s<105&&(t(e,b)[i+m[[5,65][s&1]]]=f):s<114?console.debug(d):s<116?console.debug(`${o}EQ ${["bass","treble"][s&1]} gain: ${f-64}dB`):s<118?console.debug(d):s<120?console.debug(`${o}EQ ${["bass","treble"][s&1]} freq: ${f}`):console.debug(d)}),u&&t(e,D)[l]>1&&e.setDrumFirstWrite(l)}).add([76,9],(a,c)=>{let l=e.chRedir(a[0],c,!0),s=a[1],i=E.cc*l,o=`PLG-VL CH${l+1} `;a.subarray(2).forEach((d,u)=>{let f=u+s;switch(f){case 1:{console.info(`${o}breath mode: ${["system","breath","velocity","touch EG"][d]}`);break}case 0:case 27:case 28:break;default:if(f<27){let $=f-3>>1,w=["pressure","embouchure","tonguing","scream","breath noise","growl","throat formant","harmonic enhancer","damping","absorption","amplification","brightness"][$];f&1?f<23?(console.debug(`${o}${w} control source: ${ra(d)}`),d&&d<96&&e.allocateAce(l,130+$),t(e,Ve)[E.redir*l+$+2]=d,e.buildRccMap()):console.debug(`${o}${w} scale break point: ${d}`):(console.debug(`${o}${w} depth: ${d-64}`),t(e,b)[i+m[130+$]]=d)}}})}).add([76,10],(a,c,l)=>{}).add([76,16],(a,c,l)=>{}).add([76,17,0,0],(a,c,l)=>{}).add([76,112],(a,c,l)=>{switch(console.debug(`XG enable PLG-${["VL","SG","DX","AN","PF","DR","PC","AP"][a[0]]} for CH${a[2]+1}.`),a[0]){case 0:{t(e,ie)[E.ext*a[2]]=e.EXT_VL;break}case 2:{t(e,ie)[E.ext*a[2]]=e.EXT_DX;break}default:t(e,ie)[E.ext*a[2]]=e.EXT_NONE}}).add([73,0,0],(a,c)=>{let l=a[0],s="MU1000 System - ";a.subarray(1).forEach((i,o)=>{let d=l+o;d==8?console.debug(`${s}LCD contrast: ${i}.`):d==18?(t(e,_)[k.xg][1]=i?126:0,console.debug(`${s}default bank: ${i?"MU100 Native":"MU Basic"}.`),e.dispatchEvent("banklevel",{mode:"xg",data:+!!i}),e.forceVoiceRefresh()):d>=64&&d<69&&[()=>{e.dispatchEvent("channelactive",i)},()=>{i<8?(e.dispatchEvent("channelmin",i<<4),console.debug(`Octavia System: Minimum CH${(i<<4)+1}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{i<8?(e.dispatchEvent("channelmax",(i<<4)+15),console.debug(`Octavia System: Maximum CH${(i<<4)+16}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges")},()=>{S(e,ke,!!i),console.info(`Octavia System: RS receiving ${["dis","en"][i]}abled.`)}][d-64]()})}).add([73,10,0],(a,c)=>{let l=a[0],s=`MU1000 RS${t(e,ke)?"":" (ignored)"}: `;if(l<16)switch(l){case 2:{let i=e.chRedir(0,c,!0);t(e,ke)&&(e.dispatchEvent("portrange",4),e.dispatchEvent("portstart",i)),console.info(`${s}Show CH${i+1}~CH${i+64}`);break}case 3:{let i=e.chRedir(a[1]<<5,c,!0);t(e,ke)&&(e.dispatchEvent("portrange",2),e.dispatchEvent("portstart",i)),console.info(`${s}Show CH${i+1}~CH${i+32}`);break}default:console.debug(`${s}unknown switch ${l} invoked.`)}else if(l<32){if(t(e,ke)){let i=e.chRedir(l-16+(t(e,ht)<<4),c,!0);e.dispatchEvent("channelactive",i)}}else if(l<36){let i=e.chRedir(l-32<<4,c,!0);t(e,ke)&&(e.dispatchEvent("portrange",1),e.dispatchEvent("portstart",i>>4),S(e,ht,l-32)),console.info(`${s}Show CH${i+1}~CH${i+16}`)}}).add([73,11,0],(a,c)=>{let l="MU1000 System - channel ",s="Octavia System - channel ",i=a[0];a.subarray(1).forEach((o,d)=>{let u=i+d;([()=>{e.setChActive(o,1),e.dispatchEvent("channelactive",o),A()&&console.debug(`${l}current part: CH${o+1}`)},()=>{o<5?(e.dispatchEvent("portrange",1<<o),console.debug(`${l}port range: ${1<<o} port(s)`)):(e.dispatchEvent("portrange",0),console.debug(`${l}port range: reset`))},()=>{o<16?(e.dispatchEvent("portstart",o),console.debug(`${s}start port: ${"ABCDEFGHIJKLMNOP"[o]}`)):(e.dispatchEvent("portstart",255),console.debug(`${s}start port: reset`))}][u]||(()=>{console.debug(`${l}unknown address: ${u}`)}))()})}).add([93,3],(a,c)=>{let l=e.chRedir(a[0],c,!0),s=`PLG-SG CH${l+1} `,i=Date.now();if(a[1]==0){let o="",d=0;a.subarray(2).forEach((u,f)=>{f%2==0?o+=ta[u]||u.toString().padStart("0"):d+=u*13}),i>=t(e,ft)&&this.dispatchEvent("metacommit",{type:"SGLyrics",data:"",amend:!1}),this.dispatchEvent("metacommit",{type:"SGLyrics",data:`${aa(o)}`,amend:!0}),S(e,ft,i+Math.ceil(d/2)+t(e,dt)),A()&&console.debug(`${s}vocals: ${o}`)}else console.warn(`Unknown PLG-SG data: ${a}`)}).add([98,0],(a,c,l)=>{e.dispatchEvent("mupromptex");let s=a[0],i=a.length-5,o=a.length-1;if(s!=i){console.info(`PLG-DX native dump size mismatch! Gave ${s} instead of ${a.length-5}.`);return}let d=Ae(a.subarray(4,o));if(d!=a[o]){console.info(`Bad PLG-DX checksum ${a[o]} - should be ${d}.`);return}a[0]=98,t(e,oe).run(a.subarray(0,o),c,l,{noAce:!0})}).add([98,96],(a,c,l,s)=>{let i=e.chRedir(a[0],c,!0),o=E.cc*i,d=a[1];a.subarray(2).forEach((u,f)=>{let $=d+f;if(!($<10)){if($==10)e.resetAce();else if($<27){let w=$+131;s!=null&&s.noAce||e.allocateAce(i,w),t(e,b)[o+m[w]]=u,e.dispatchEvent("cc",{part:i,cc:w,data:u})}}})}).add([100,0],(a,c,l)=>{let s=a.subarray(0,a.length-1);if(a[0]+5!=a.length){console.warn(`Yamaha DX7+ dump SysEx size mismatch! Expected ${a.length}, but got ${a[0]}:
`,a);return}let i=Ae(s),o=a[a.length-1];if(i!=o){console.warn(`Yamaha DX7+ dump SysEx checksum mismatch! Expected ${i}, but got ${o}:
`,a);return}r.run(s.subarray(1))}).add([100,76],(a,c,l)=>{let s=a[0]>>4,i=a[0]&15,o=a[1];switch(s){case 2:{let d=e.chRedir(i,c,!0),u=E.cc*d;a.subarray(2).forEach((f,$)=>{let w=$+o;if(!(w<7)){if(w<23){let C=w+135;e.allocateAce(d,C),t(e,b)[u+m[C]]=f,e.dispatchEvent("cc",{part:d,cc:C,data:f})}}});break}default:console.info("Unknown DX7+ multipart: %o",a)}}).add([1,20],(a,c,l)=>{l==115?(e.switchMode("doc",!0),e.setPortMode(e.getTrackPort(c),1,k.doc),console.info("MIDI reset: DOC")):console.debug(`Unknown Yamaha SysEx: 67, ${l}, ${a.join(", ")}`)}).add([1,17,15,89],(a,c,l)=>{l==115?(e.setEffectType(0,24,a[0]|16),e.dispatchEvent("efxreverb",e.getEffectType(0))):console.debug(`Unknown Yamaha SysEx: 67, ${l}, ${a.join(", ")}`)}).add([1,24],(a,c,l)=>{if(l==115){for(let s=0;s<16;s++){let i=e.chRedir(s,c,!0);t(e,b)[i*E.cc+m[91]]=127}console.info("DOC Global Reverb: on")}else console.debug(`Unknown Yamaha SysEx: 67, ${l}, ${a.join(", ")}`)}),r.add([14,31],(a,c,l)=>{t(e,b)[E.cc*a[0]+m[64]]=0,t(e,F).ano(a[0]),e.switchMode("xg"),e.setPortMode(e.getTrackPort(c),1,k.xg),e.resetAce(),console.debug(`Yamaha DX7+ reset CH${a[0]+1}.`)}).add([76,112],async a=>{let c=a[0],l=E.cc*c,s=E.ext*c,i=E.cvn*c;t(e,ie)[s]=e.EXT_DX,t(e,Ee)[c]=1;let o=t(e,$t).subarray(i,i+E.cvn);o.fill(32),a.subarray(1).forEach((d,u)=>{if(u<10)o[u]=Math.max(d,32);else if(!(u<40)){if(u<56){let f=u+102;t(e,b)[l+m[f]]=d,e.dispatchEvent("cc",{part:c,cc:f,data:d})}}}),t(e,O)[c]=c&127,t(e,b)[E.cc*c+m[0]]=35,t(e,b)[E.cc*c+m[32]]=c>>7|4,e.dispatchEvent("voice",{part:c}),console.debug(`DX7+ CH${c+1} dump: %o`,a)});let n=function(a,c,l,s){},p=function(a,c){e.dispatchEvent("mupromptex");let l=a*E.dpn,s=c[0],i=c[1];c.subarray(2).forEach((o,d)=>{let u=d+i,f=-1;u<16?([()=>{f=24},()=>{f=25},()=>{f=26},()=>{},()=>{f=28},()=>{f=29},()=>{f=30},()=>{f=31},()=>{},()=>{},()=>{},()=>{f=20},()=>{f=21},()=>{f=22},()=>{f=23},()=>{}][u]||(()=>{console.debug(`Unknown XG-style drum param ${u} on set ${a+1}.`)}))():u<32||(u<40?([()=>{f=48},()=>{f=49},!1,!1,()=>{f=52},()=>{f=53}][u-32]||(()=>{console.debug(`Unknown XG-style drum param ${u} on set ${a+1}.`)}))():u<80||([()=>{f=36}][u-80]||(()=>{console.debug(`Unknown XG-style drum param ${u} on set ${a+1}.`)}))()),f>=0?(A()&&console.debug(l,f,s,o),t(e,te)[(l+fe[f])*E.dnc+s]=o):A()&&console.debug(`XG-style drum param ${u} has no writes.`)})},y=function(a,c,l){e.dispatchEvent("mupromptex");let s=a*E.dpn,i=(c<<7)+l[0];l.subarray(1).forEach((o,d)=>{let u=d+i,f=u&127,$=u>>7,w=-1;$>1&&([()=>{w=26},()=>{},()=>{w=28},()=>{w=29},()=>{w=30},()=>{},()=>{},()=>{w=31}][$-2]||(()=>{console.debug(`Unknown GS-style drum param ${$} on set ${a+1}.`)}))(),w>-1?(A()&&console.debug(s,w,f,o),t(e,te)[(s+fe[w])*E.dnc+f]=o):A()&&console.debug(`GS-style drum param ${$} has no writes.`)})};t(this,oe).add([76,48],(a,c,l)=>{p(0,a)}).add([76,49],(a,c,l)=>{p(1,a)}).add([76,50],(a,c,l)=>{p(2,a)}).add([76,51],(a,c,l)=>{p(3,a)}).add([76,52],(a,c,l)=>{p(4,a)}).add([76,53],(a,c,l)=>{p(5,a)}).add([76,54],(a,c,l)=>{p(6,a)}).add([76,55],(a,c,l)=>{p(7,a)}),t(this,oe).add([89,0],(a,c,l)=>{if(e.eprom){let s=a[0],i=(a[1]<<14)+(a[2]<<7)+a[3]+(e.eprom.offset||0);A()&&console.debug(`MU1000 EPROM trail to 0x${i.toString(16).padStart(6,"0")}, ${s} bytes.`);let o=e.eprom.data;a.subarray(4).forEach((d,u)=>{let f=u>>3,$=u&7;if($==7)for(let w=0;w<7;w++)o[i+7*f+w]+=(d>>6-w&1)<<7;else o[i+7*f+$]=d})}}).add([89,1],(a,c,l)=>{let s=(a[0]<<21)+(a[1]<<14)+(a[2]<<7)+a[3];A()&&console.debug(`MU1000 EPROM jump to 0x${s.toString(16).padStart(6,"0")}.`),e.eprom&&(e.eprom.offset=s)}).add([89,2],(a,c,l)=>{if(e.eprom){let s=(a[0]<<21)+(a[1]<<14)+(a[2]<<7)+a[3]+(e.eprom.offset||0);A()&&console.debug(`MU1000 EPROM write to 0x${s.toString(16).padStart(6,"0")}.`);let i=e.eprom.data;a.subarray(4).forEach((o,d)=>{let u=d>>3,f=d&7;if(f==7)for(let $=0;$<7;$++)i[s+7*u+$]+=(o>>6-$&1)<<7;else i[s+7*u+f]=o})}}).add([89,3],(a,c,l)=>{}),t(this,oe).add([39,48],(a,c,l)=>{}).add([43,0,0],(a,c,l)=>{e.dispatchEvent("mupromptex");let s=[0,0,0,0],i=(o,d)=>{s[d]=o};if(a.subarray(1).forEach((o,d)=>{let u=d+a[0];[i,i,i,i,()=>{S(this,H,o*129/16383*100),e.dispatchEvent("mastervolume",t(e,H))},()=>o-64,()=>o||128,()=>o,()=>o,()=>{console.debug(`TG300 variation on cc${o}.`)}][u](o,u)}),a[0]<4){let o=0;s.forEach(d=>{o=o<<4,o+=d}),o-=1024}}).add([43,1,0],(a,c,l)=>{e.dispatchEvent("mupromptex")}).add([43,2],(a,c,l)=>{e.dispatchEvent("mupromptex");let s=e.chRedir(a[0],c,!0),i=a[1],o=E.cc*s,d=`TG300 CH${s+1} `;a.subarray(2).forEach((u,f)=>{f<5?([()=>{},()=>{t(e,b)[o+m[0]]=u,e.dispatchEvent("voice",{part:s})},()=>{t(e,b)[o+m[32]]=u,e.dispatchEvent("voice",{part:s})},()=>{t(e,O)[s]=u,e.dispatchEvent("voice",{part:s})},()=>{let $=e.chRedir(u,c,!0);t(e,K)[s]=$,s!=$&&(e.buildRchTree(),console.info(`${d}receives from CH${$+1}`))}][f+i]||(()=>{}))(u,f+i):f<21||(f<47?([()=>{t(e,se)[s]=+!u},()=>{},()=>{},()=>{t(e,R)[E.rpn*s+3]=u,t(e,I)[E.rpnt*s+2]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},()=>{},()=>{t(e,b)[o+m[7]]=u},!1,!1,()=>{t(e,b)[o+m[10]]=u||128},!1,!1,()=>{console.debug(`${d} AC1 at cc${u}`)},()=>{console.debug(`${d} AC2 at cc${u}`)},()=>{t(e,b)[o+m[128]]=u,e.allocateAce(s,128)},()=>{t(e,b)[o+m[93]]=u},()=>{t(e,b)[o+m[91]]=u},()=>{t(e,b)[o+m[94]]=u},()=>{t(e,b)[o+m[76]]=u},()=>{t(e,b)[o+m[77]]=u},()=>{t(e,b)[o+m[74]]=u},()=>{t(e,b)[o+m[71]]=u},()=>{t(e,b)[o+m[73]]=u},()=>{t(e,b)[o+m[75]]=u},()=>{t(e,b)[o+m[72]]=u},()=>{t(e,b)[o+m[78]]=u}][f+i-21]||(()=>{}))(u,f+i):f<95||([()=>{t(e,b)[o+m[65]]=u},()=>{t(e,b)[o+m[5]]=u}][f+i-95]||(()=>{}))(u,f+i))})}).add([43,7,0],(a,c,l)=>{let s=a[0];e.setLetterDisplay(a.subarray(1),"TG300 letter display",s)}).add([43,7,1],(a,c,l)=>{S(e,Y,0),S(e,be,Date.now()+3200),t(e,le,Se).fill(0),a.forEach(function(s,i){let o=Math.floor(i/16),d=i%16,u=(d*3+o)*7,f=7,$=0;for(u-=d*5,o==2&&(f=2);$<f;)t(e,le,Se)[u+$]=s>>6-$&1,$++})}),t(this,ue).add([66,18,0,0,127],(a,c,l)=>{e.switchMode("sc",!0),e.setPortMode(e.getTrackPort(c),2,k.sc),t(e,b)[E.cc*9]=120,t(e,b)[E.cc*25]=120,t(e,b)[E.cc*41]=120,t(e,b)[E.cc*57]=120,t(e,_)[k.sc][1]=t(e,U).sc,S(e,G,!1),t(e,Me).fill(0),console.info(`GS system to ${["single","dual"][a[0]]} mode.`)}).add([66,18,64,0],(a,c,l)=>{switch(a[0]){case 127:{e.switchMode("gs",!0),e.setPortMode(e.getTrackPort(c),2,k.gs),t(e,_)[k.gs][1]=t(e,U).gs,t(e,b)[E.cc*9]=120,t(e,b)[E.cc*25]=120,t(e,b)[E.cc*41]=120,t(e,b)[E.cc*57]=120,S(e,G,!1),t(e,Me).fill(0),console.info("MIDI reset: GS");break}default:{e.dispatchEvent("mupromptex");let s=[0,0,0,0],i=(o,d)=>{s[d]=o};if(a.subarray(1).forEach((o,d)=>{let u=d+a[0];[i,i,i,i,f=>{S(this,H,f*129/16383*100),e.dispatchEvent("mastervolume",t(e,H))},f=>{},f=>{}][u](o,d)}),a[0]<4){let o=0;s.forEach(d=>{o=o<<4,o+=d}),o-=1024}}}}).add([66,18,64,1],(a,c,l)=>{e.dispatchEvent("mupromptex");let s=a[0];if(s<16){let i="".padStart(s," ");a.subarray(1).forEach((o,d)=>{i+=String.fromCharCode(Math.max(32,o))}),i=i.padEnd(16," "),console.debug(`GS patch name: ${i}`)}else s<48||(s<65?a.subarray(1).forEach((i,o)=>{let d=`GS ${s+o>55?"chorus":"reverb"} `;([()=>{console.info(`${d}type: ${Bt[i]}`),e.setEffectType(0,40,i),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{},()=>{},()=>{},()=>{},()=>{},!1,()=>{console.debug(`${d}predelay: ${i}ms`)},()=>{console.info(`${d}type: ${sa[i]}`),e.setEffectType(1,40,16+i),e.dispatchEvent("efxchorus",e.getEffectType(1))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${d}to reverb: ${re(i)}`)},()=>{console.debug(`${d}to delay: ${re(i)}`)}][s+o-48]||(()=>{}))()}):s<80?console.debug(`Unknown GS patch address: ${s}`):s<91?a.subarray(1).forEach((i,o)=>{let d="GS delay ";([()=>{console.info(`${d}type: ${ia[i]}`),e.setEffectType(2,40,32+i),e.dispatchEvent("efxdelay",e.getEffectType(2))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${d}to reverb: ${re(i)}`)}][s+o-80]||(()=>{}))()}):console.debug(`Unknown GS patch address: ${s}`))}).add([66,18,64,2],(a,c,l)=>{let s="GS EQ ";a.subarray(1).forEach((i,o)=>{([()=>{console.debug(`${s}low freq: ${[200,400][i]}Hz`)},()=>{console.debug(`${s}low gain: ${i-64}dB`)},()=>{console.debug(`${s}high freq: ${[3e3,6e3][i]}Hz`)},()=>{console.debug(`${s}high gain: ${i-64}dB`)}][a[0]+o]||function(){console.warn(`Unknown GS EQ address: ${a[0]+o}`)})()})}).add([66,18,64,3],(a,c,l)=>{e.dispatchEvent("mupromptex");let s="GS EFX ",i=function(o,d){let u=na(t(e,ne).subarray(10,12),d,o);u&&console.debug(`${s}${Nt(t(e,ne).subarray(10,12))} ${u}`)};a.subarray(1).forEach((o,d)=>{([()=>{e.setEffectTypeRaw(3,!1,32+o),e.dispatchEvent("efxinsert0",e.getEffectType(3))},()=>{e.setEffectTypeRaw(3,!0,o),console.info(`${s}type: ${Nt(t(e,ne).subarray(10,12))}`),e.dispatchEvent("efxinsert0",e.getEffectType(3))},!1,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,()=>{console.debug(`${s}to reverb: ${re(o)}dB`)},()=>{console.debug(`${s}to chorus: ${re(o)}dB`)},()=>{console.debug(`${s}to delay: ${re(o)}dB`)},!1,()=>{console.debug(`${s}1 source: ${o}`),o&&o<96&&e.allocateAceAll(o)},()=>{console.debug(`${s}1 depth: ${o-64}`)},()=>{console.debug(`${s}2 source: ${o}`),o&&o<96&&e.allocateAceAll(o)},()=>{console.debug(`${s}2 depth: ${o-64}`)},()=>{console.debug(`${s}to EQ: ${o?"ON":"OFF"}`)}][a[0]+d]||function(u,f){console.warn(`Unknown GS EFX address: ${f}`)})(o,a[0]+d)})}).add([66,18,65],(a,c,l)=>{y((a[0]>>4)+1<<1,a[0]&15,a.subarray(1))}).add([69,18,16],(a,c,l)=>{var s;switch(a[0]){case 0:{let i=a[1];e.setLetterDisplay(a.subarray(2),"GS display text",i);break}case 32:{S(e,be,Date.now()+3200),a[1]==0&&(a[2]?(S(e,Y,Math.max(Math.min(a[2]-1,9),0)),A()&&console.debug(`GS switch display page ${a[2]-1}.`)):(S(e,Y,0),S(e,be,Date.now()),A()&&console.debug("GS disable display page.")));break}default:if(a[0]<6){t(e,Y)>9&&S(e,Y,0);let i=a[0]-1<<1|a[1]>>6;t(e,Y)==i&&S(e,be,Date.now()+3200),(s=t(e,Ce)[i])!=null&&s.length||(t(e,Ce)[i]=new Uint8Array(256));let o=t(e,Ce)[i];A()&&console.debug(`GS frame draw page ${i}.`);let d=a[1]&63;o.fill(0),a.subarray(2).forEach(function(f,$){let w=$+d,C=Math.floor(w/16),M=w%16,X=(M*4+C)*5,De=5,Ge=0;for(X-=M*4,C==3&&(De=1);Ge<De;)o[X+Ge]=f>>4-Ge&1,Ge++})}else console.warn(`Unknown GS display section: ${a[0]}`)}});let v=function(a,c,l){e.dispatchEvent("mupromptex");let s=a[0],i=E.cc*c,o=E.rpn*c,d=`GS CH${c+1} `;s<3?(a.subarray(1).forEach((u,f)=>{[()=>{t(e,b)[i+m[0]]=u},()=>{t(e,O)[c]=u},()=>{let $=0;u<16?$=e.chRedir(u,l,!0):$=E.ch,t(e,K)[c]=$,c!=$&&(e.buildRchTree(),console.info(`${d}receives from CH${$+1}`))}][s+f]()}),e.dispatchEvent("voice",{part:c})):s<19||(s<44?a.subarray(1).forEach((u,f)=>{([()=>{t(e,se)[c]=+!u},!1,()=>{e.setChType(c,u<<1,k.gs),console.debug(`${d}type: ${u?"drum ":"melodic"}${u||""}`)},()=>{t(e,R)[o+3]=u,t(e,I)[E.rpnt*c+2]=1,e.dispatchEvent("pitch",{part:c,pitch:e.getPitchShift(c)})},!1,()=>{t(e,b)[i+m[7]]=u},!1,!1,()=>{t(e,b)[i+m[10]]=u||128},!1,!1,()=>{console.debug(`${d}CC 1: cc${u}`)},()=>{console.debug(`${d}CC 2: cc${u}`)},()=>{t(e,b)[i+m[93]]=u},()=>{t(e,b)[i+m[91]]=u},!1,!1,()=>{t(e,R)[o+1]=u,t(e,I)[E.rpnt*c+1]=1,e.dispatchEvent("pitch",{part:c,pitch:e.getPitchShift(c)})},()=>{t(e,R)[o+2]=u,t(e,I)[E.rpnt*c+1]=1,e.dispatchEvent("pitch",{part:c,pitch:e.getPitchShift(c)})},()=>{t(e,b)[i+m[94]]=u}][s+f-19]||(()=>{}))()}):s<76||console.debug(`Unknown GS part address: ${s}`))},x=function(a,c){let l=a[0],s=`GS CH${c+1} `;l<2?a.subarray(1).forEach((i,o)=>{[()=>{t(e,b)[E.cc*c+m[32]]=i},()=>{}][l+o]()}):l<32?console.warn(`Unknown GS misc address: ${l}`):l<35?a.subarray(1).forEach((i,o)=>{[()=>{console.debug(`${s}EQ: o${["ff","n"][i]}`)},()=>{},()=>{console.debug(`${s}EFX: o${["ff","n"][i]}`),t(e,ot)[c]=i,e.dispatchEvent("partefxtoggle",{part:c,active:i})}][l+o-32]()}):console.warn(`Unknown GS misc address: ${l}`)};t(this,ue).add([66,18,64,16],(a,c)=>{v(a,e.chRedir(9,c,!0),c)}).add([66,18,64,17],(a,c)=>{v(a,e.chRedir(0,c,!0),c)}).add([66,18,64,18],(a,c)=>{v(a,e.chRedir(1,c,!0),c)}).add([66,18,64,19],(a,c)=>{v(a,e.chRedir(2,c,!0),c)}).add([66,18,64,20],(a,c)=>{v(a,e.chRedir(3,c,!0),c)}).add([66,18,64,21],(a,c)=>{v(a,e.chRedir(4,c,!0),c)}).add([66,18,64,22],(a,c)=>{v(a,e.chRedir(5,c,!0),c)}).add([66,18,64,23],(a,c)=>{v(a,e.chRedir(6,c,!0),c)}).add([66,18,64,24],(a,c)=>{v(a,e.chRedir(7,c,!0),c)}).add([66,18,64,25],(a,c)=>{v(a,e.chRedir(8,c,!0),c)}).add([66,18,64,26],(a,c)=>{v(a,e.chRedir(10,c,!0),c)}).add([66,18,64,27],(a,c)=>{v(a,e.chRedir(11,c,!0),c)}).add([66,18,64,28],(a,c)=>{v(a,e.chRedir(12,c,!0),c)}).add([66,18,64,29],(a,c)=>{v(a,e.chRedir(13,c,!0),c)}).add([66,18,64,30],(a,c)=>{v(a,e.chRedir(14,c,!0),c)}).add([66,18,64,31],(a,c)=>{v(a,e.chRedir(15,c,!0),c)}).add([66,18,64,64],(a,c)=>{x(a,e.chRedir(9,c,!0))}).add([66,18,64,65],(a,c)=>{x(a,e.chRedir(0,c,!0))}).add([66,18,64,66],(a,c)=>{x(a,e.chRedir(1,c,!0))}).add([66,18,64,67],(a,c)=>{x(a,e.chRedir(2,c,!0))}).add([66,18,64,68],(a,c)=>{x(a,e.chRedir(3,c,!0))}).add([66,18,64,69],(a,c)=>{x(a,e.chRedir(4,c,!0))}).add([66,18,64,70],(a,c)=>{x(a,e.chRedir(5,c,!0))}).add([66,18,64,71],(a,c)=>{x(a,e.chRedir(6,c,!0))}).add([66,18,64,72],(a,c)=>{x(a,e.chRedir(7,c,!0))}).add([66,18,64,73],(a,c)=>{x(a,e.chRedir(8,c,!0))}).add([66,18,64,74],(a,c)=>{x(a,e.chRedir(10,c,!0))}).add([66,18,64,75],(a,c)=>{x(a,e.chRedir(11,c,!0))}).add([66,18,64,76],(a,c)=>{x(a,e.chRedir(12,c,!0))}).add([66,18,64,77],(a,c)=>{x(a,e.chRedir(13,c,!0))}).add([66,18,64,78],(a,c)=>{x(a,e.chRedir(14,c,!0))}).add([66,18,64,79],(a,c)=>{x(a,e.chRedir(15,c,!0))}),t(this,xe).add([54,65],(a,c)=>{let l=t(e,U).x5=="81"?"05rw":"x5d";e.switchMode(l,!0),e.setPortMode(e.getTrackPort(c),1,k[l]);let s=a[a.length-1],i=a.subarray(0,a.length-1),o=Ae(i);o!=s&&(console.info(`X5D multi parameters checksum mismatch! Expected ${o}, got ${s}.`),console.debug(a));let d=(a[1]<<7)+a[0],u=(a[3]<<7)+a[2],f=e.chRedir(d&15,c,!0),$=E.cc*f;[()=>{u<1||(u<101?(e.setChType(f,e.CH_MELODIC,k.x5d),t(e,O)[f]=u-1,t(e,b)[$+m[0]]=t(e,U).x5):u<229?(e.setChType(f,e.CH_MELODIC,k.x5d),t(e,O)[f]=u-101,t(e,b)[$+m[0]]=56):(e.setChType(f,e.CH_DRUMS,k.x5d),t(e,O)[f]=ba[u-229]||0,t(e,b)[$+m[0]]=62)),e.dispatchEvent("voice",{part:f})},()=>{t(e,b)[$+m[7]]=u},()=>{u<31&&(t(e,b)[$+m[10]]=Math.round((u-15)*4.2+64))},()=>{t(e,b)[$+m[93]]=yt(u)},()=>{t(e,b)[$+m[91]]=yt(u)},()=>{t(e,R)[f*E.rpn+3]=u>8191?u-16320:64+u,t(e,I)[E.rpnt*f+2]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)})},()=>{t(e,R)[f*E.rpn+1]=u>8191?u-16320:64+u,t(e,I)[E.rpnt*f+1]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)})},()=>{u>0&&(t(e,R)[f*E.rpn]=u,t(e,I)[E.rpnt*f]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)}))},()=>{}][d>>4]()}).add([54,76,0],(a,c)=>{e.dispatchEvent("mupromptex");let l=t(e,U).x5=="81"?"05rw":"x5d";e.switchMode(l),e.setPortMode(e.getTrackPort(c),1,k[l]);let s="",i=t(e,U).x5,o=0,d=0,u="MSB\tPRG\tLSB\tNME";ge(a,function(f,$){if($<16400){let w=$%164;switch(!0){case w<10:{f>31&&(s+=String.fromCharCode(f));break}case w==10:break;case w==11:{u+=`
${i}	${o}	${d}	${s.trim().replace("Init Voice","")}`,o++,s="";break}}o>99&&(i=90,o=0)}}),e.userBank.clearRange({msb:t(e,U).x5,prg:[0,99],lsb:0}),e.userBank.load(u),A()&&console.debug(u),e.forceVoiceRefresh()}).add([54,77,0],(a,c)=>{e.dispatchEvent("mupromptex");let l=t(e,U).x5=="81"?"05rw":"x5d";e.switchMode(l),e.setPortMode(e.getTrackPort(c),1,k[l]);let s="",i=90,o=0,d=0,u="MSB\tPRG\tLSB\tNME";ge(a,function(f,$){if($<13600){let w=$%136;switch(!0){case w<10:{f>31&&(s+=String.fromCharCode(f));break}case w==11:{u+=`
${i}	${o}	${d}	${s.trim().replace("Init Combi","")}`,o++,s="";break}}}}),e.userBank.clearRange({msb:90,prg:[0,99],lsb:0}),e.userBank.load(u),A()&&console.debug(u),e.forceVoiceRefresh()}).add([54,78],(a,c)=>{let l=t(e,U).x5=="81"?"05rw":"x5d";e.switchMode(l),e.setPortMode(e.getTrackPort(c),1,k[l]),console.debug(`X5D mode switch requested: ${["combi","combi edit","prog","prog edit","multi","global"][a[0]]} mode.`)}).add([54,85],(a,c)=>{e.dispatchEvent("mupromptex");let l=t(e,U).x5=="81"?"05rw":"x5d";e.switchMode(l),e.setPortMode(e.getTrackPort(c),1,k[l]),ge(a,(s,i)=>{i>0&&i<3&&(e.setEffectType(i-1,44,s),e.dispatchEvent(`efx${["reverb","chorus"][i-1]}`,e.getEffectType(i-1)))})}).add([54,104],(a,c)=>{e.dispatchEvent("mupromptex");let l=t(e,U).x5=="81"?"05rw":"x5d";e.switchMode(l,!0);let s=e.getTrackPort(c);if(t(e,V)[s]&&t(e,V)[s]!=k[l])if(t(e,we).dumpLimit==e.DUMP_MODE){console.warn(`Dump cancelled for track ${c}. Port ${String.fromCharCode(65+s)} mode "${Q[t(e,V)[s]]}" mismatch, should be "${l}".`);return}else console.info(`Track ${c} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+s)}.`);e.setPortMode(s,1,k[l]),ge(a,function(i,o,d,u){if(o<192){let f=e.chRedir(Math.floor(o/12),c,!0),$=f*E.cc;switch(o%12){case 0:{i<128?(e.setChType(f,e.CH_MELODIC,k.x5d),t(e,b)[$+m[0]]=t(e,U).x5,t(e,O)[f]=i):(e.setChType(f,e.CH_DRUMS,k.x5d),t(e,b)[$+m[0]]=62,t(e,O)[f]=ba[i-128]),i>0&&e.setChActive(f,1),e.dispatchEvent("voice",{part:f});break}case 1:{t(e,b)[$+m[7]]=i;break}case 2:{t(e,R)[f*E.rpn+3]=i>127?i-192:64+i,t(e,I)[E.rpnt*f+2]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)});break}case 3:{t(e,R)[f*E.rpn+1]=i>127?i-192:64+i,t(e,I)[E.rpnt*f+1]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)});break}case 4:{i<31&&(t(e,b)[$+m[10]]=Math.round((i-15)*4.2+64));break}case 5:{let w=i>>4,C=i&15;t(e,b)[$+m[91]]=yt(C),t(e,b)[$+m[93]]=yt(w);break}case 10:break;case 11:{let w=e.chRedir(i&15,c,!0),C=i>>4;t(e,K)[f]=i,(w!=f||C)&&(console.info(`X5D Part CH${f+1} receives from CH${w+1}.`),e.buildRchTree())}}}else{let f=e.chRedir(o-192,c,!0)}})}),t(this,ue).add([22,18,127],(a,c,l)=>{e.switchMode("mt32",!0),e.setPortMode(e.getTrackPort(c),1,k.mt32),S(e,G,!1),e.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),console.info("MIDI reset: MT-32")}).add([22,18,0],(a,c,l)=>{e.switchMode("mt32");let s=e.chRedir(l,c,!0),i=a[1];a.subarray(2).forEach((o,d)=>{let u=d+i;t(e,Ie)[u+(s-1)*16]=o,([!1,()=>{let f=t(e,Ie)[s-1<<4];if(f<3){if(t(e,Ee)[s]=1,f==2)for(let $=0;$<name.length;$++)t(e,ye)[(s-1)*E.cmt+$]=t(e,Le)[o*E.cmt+$];else{let $=e.baseBank.get(0,o+(f<<6),127,"mt32").name;for(let w=0;w<$.length;w++)t(e,ye)[(s-1)*E.cmt+w]=$.charCodeAt(w)}e.dispatchEvent("voice",{part:s})}},()=>{t(e,R)[s*E.rpn+3]=o+40,t(e,I)[E.rpnt*s+2]=1},()=>{t(e,R)[s*E.rpn+1]=o+14,t(e,I)[E.rpnt*s+1]=1},()=>{t(e,R)[s*E.rpn]=o,t(e,I)[E.rpnt*s]=1},!1,()=>{t(e,b)[E.cc*s+m[91]]=o?127:0},!1,()=>{t(e,b)[E.cc*s+m[7]]=o},()=>{t(e,b)[E.cc*s+m[10]]=Math.ceil(o*9.05)}][u]||(()=>{}))()})}).add([22,18,1],(a,c,l)=>{e.switchMode("mt32");let s=l&7;console.debug(`MT-32 slot #${l+1} Drum: ${a}`);let i=a[0]<<7|a[1];a.subarray(2).forEach((o,d)=>{let u=d+i,f=(u>>2)+24,$=u&3,w=s*E.dpn;if(A()&&console.debug(`MT-32 temp drum note ${f} param ${$}: ${o}`),f<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${f}`);return}[()=>{},()=>{t(e,te)[(w+fe[26])*E.dnc+f]=Math.round(o*1.27)},()=>{t(e,te)[(w+fe[26])*E.dnc+f]=o*9+1&127},()=>{t(e,te)[(w+fe[26])*E.dnc+f]=o?127:0}][$]()})}).add([22,18,2],(a,c,l)=>{e.switchMode("mt32");let s=e.chRedir(l,c,!0),i=a[1]+(a[0]<<7);i<10&&(t(e,Ee)[s]=1),a.subarray(2).forEach((o,d)=>{let u=d+i;u<14&&(t(e,ye)[(s-1)*E.cmt+u]=o)}),e.dispatchEvent("voice",{part:s})}).add([22,18,3],(a,c,l)=>{e.switchMode("mt32");let s=l&7;if(a[0]){let i=(a[0]-1<<7)+a[1]-16;a.subarray(2).forEach((o,d)=>{let u=d+i,f=(u>>2)+24,$=u&3,w=s*E.dpn;if(A()&&console.debug(`MT-32 dev drum note ${f} param ${$}: ${o}`),f<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${f}`);return}[()=>{},()=>{t(e,te)[(w+fe[26])*E.dnc+f]=Math.round(o*1.27)},()=>{t(e,te)[(w+fe[26])*E.dnc+f]=o*9+1&127},()=>{t(e,te)[(w+fe[26])*E.dnc+f]=o?127:0}][$]()})}else{let i=a[1];a.subarray(2).forEach((o,d)=>{let u=d+i;t(e,Ie)[u]=o;let f=e.chRedir(1+(u>>4),c,!0),$=u&15;([!1,()=>{let w=t(e,Ie)[f-1<<4];if(w<3)if(t(e,Ee)[f]=1,w==2)for(let C=0;C<name.length;C++)t(e,ye)[(f-1)*E.cmt+C]=t(e,Le)[o*E.cmt+C];else{let C=e.baseBank.get(0,o+(w<<6),127,"mt32").name;for(let M=0;M<C.length;M++)t(e,ye)[(f-1)*E.cmt+M]=C.charCodeAt(M)}e.dispatchEvent("voice",{part:f})},()=>{t(e,R)[f*E.rpn+3]=o+40,t(e,I)[E.rpnt*f+2]=1},()=>{t(e,R)[f*E.rpn+1]=o+14,t(e,I)[E.rpnt*f+1]=1},()=>{t(e,R)[f*E.rpn]=o,t(e,I)[E.rpnt*f]=1},!1,()=>{t(e,b)[E.cc*f+m[91]]=o?127:0},!1,()=>{t(e,b)[E.cc*f+m[7]]=o},()=>{t(e,b)[E.cc*f+m[10]]=Math.ceil(o*9.05)}][$]||(()=>{}))()})}}).add([22,18,4],(a,c,l)=>{e.switchMode("mt32");let s=a[1]+(a[0]<<7),i=[];a.subarray(2).forEach((o,d)=>{let u=d+s,f=e.chRedir(Math.floor(u/246+1),c,!0),$=u%246;$<14&&(t(e,ye)[(f-1)*E.cmt+$]=o),$<10&&(t(e,Ee)[f]=1),i.indexOf(f)<0&&i.push(f)}),i.forEach(o=>{e.dispatchEvent("voice",{part:o})})}).add([22,18,5],(a,c,l)=>{e.switchMode("mt32");let s=(a[0]<<7)+a[1];a.subarray(2).forEach((i,o)=>{let d=s+o,u=Math.floor(d/8),f=d&7,$=u*8;t(e,lt)[d]=i,([!1,()=>{let w=t(e,lt)[$];if(w<3){let C="";if(w==2){let X=E.cmt*u;C=`MT-m:${i.toString().padStart(3,"0")}`}else C=e.baseBank.get(0,i+(w<<6),127,"mt32").name;e.userBank.clearRange({msb:0,lsb:127,prg:u});let M=`MSB	LSB	PRG	NME
000	127	${u}	${C}`;e.userBank.load(M,!0)}}][f]||(()=>{}))()}),e.forceVoiceRefresh()}).add([22,18,8],(a,c,l)=>{e.switchMode("mt32");let s=((a[0]&1)<<7)+a[1],i=a[0]>>1,o=!1;if(a.subarray(2).forEach((d,u)=>{let f=s+u;f<E.cmt&&(t(e,Le)[i*E.cmt+f]=d,o=!0)}),o){e.userBank.clearRange({msb:0,lsb:127,prg:i});let d=`MSB	LSB	PRG	NME
000	127	${i}	MT-m:${i}`;e.userBank.load(d,!0)}e.forceVoiceRefresh()}).add([22,18,16],(a,c,l)=>{e.switchMode("mt32");let s=a[1],i=!1,o=function(d,u){t(e,K)[u-12]=d,i=!0};a.subarray(2).forEach((d,u)=>{let f=u+s;([!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,o,o,o,o,o,o,o,o,o,()=>{S(e,H,d),e.dispatchEvent("mastervolume",t(e,H))}][f]||(()=>{}))(d,u)}),i&&e.buildRchTree()}).add([22,18,32],(a,c,l)=>{e.switchMode("mt32");let s=a[1],i=" ".repeat(s);a.subarray(2).forEach(o=>{o>31?i+=String.fromCharCode(o):i+=" "}),S(e,Ue,i.padStart(20," ")),S(e,Be,Date.now()+3200)}).add([22,18,82],(a,c)=>{let l=e.chRedir(0,c,!0);for(let s=0;s<16;s++)t(e,F).ano(l+s),s&&s<10&&(t(e,O)[l+s]=Ht[s-1]);console.info("MT-32 alt reset complete.")}),t(this,xe).add([66,0],(a,c)=>{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(c),2,k.ns5r),S(e,G,!1),console.debug(`NS5R mode switch requested: ${["global","multi","prog edit","comb edit","drum edit","effect edit"][a[0]]} mode.`)}).add([66,1],(a,c)=>{let l=["ns5r","05rw"][a[0]];e.switchMode(l,!0),e.setPortMode(e.getTrackPort(c),2,k[l]),S(e,G,!1)}).add([66,18,0,0],(a,c)=>{let l=a[0];switch(l){case 124:case 126:case 127:{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(c),2,k.ns5r),S(e,G,!1);break}case 125:{e.initDrums(),console.info(`NS5R drum setup reset: ${a}`);break}default:if(l<10){let s=[0,0,0,0],i=(o,d)=>{s[d]=o};if(a.subarray(1).forEach((o,d)=>{[i,i,i,i,()=>{S(e,H,o*129/16383*100),e.dispatchEvent("mastervolume",t(e,H))},()=>o-64,()=>o-64,()=>{},()=>{},()=>{}][l+d]()}),a[0]<4){let o=0;s.forEach(d=>{o=o<<4,o+=d}),o-=1024}}}}).add([66,18,0,1],(a,c)=>{}).add([66,18,0,2],(a,c)=>{}).add([66,18,1],(a,c)=>{e.dispatchEvent("mupromptex");let l=e.chRedir(a[0],c,!0),s=l*E.cc,i=a[1],o=`NS5R CH${l+1} `;a.subarray(2).forEach((d,u)=>{let f=i+u;f<3?([()=>{t(e,b)[s+m[0]]=d||de.bank0},()=>{t(e,b)[s+m[32]]=d},()=>{t(e,O)[l]=d}][f](),e.dispatchEvent("voice",{part:l})):f<8||(f<14?[()=>{let $=e.chRedir(d,c,!0);t(e,K)[l]=$,l!=$&&(e.buildRchTree(),console.info(`${o}receives from CH${$+1}`))},()=>{t(e,se)[l]=+!d},()=>{e.setChType(l,d,k.ns5r),console.debug(`${o}type: ${Et[d]}`)},()=>{t(e,R)[E.rpn*l+3]=d,t(e,I)[E.rpnt*l+2]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)})},()=>{},()=>{}][f-8]():f<16||(f<33?[()=>{t(e,b)[s+m[7]]=d},()=>{t(e,b)[s+m[11]]=d},()=>{},()=>{},()=>{t(e,b)[s+m[10]]=d||128},()=>{},()=>{},()=>{t(e,b)[s+m[93]]=d},()=>{t(e,b)[s+m[91]]=d},()=>{t(e,b)[s+m[76]]=d},()=>{t(e,b)[s+m[77]]=d},()=>{t(e,b)[s+m[78]]=d},()=>{t(e,b)[s+m[74]]=d},()=>{t(e,b)[s+m[71]]=d},()=>{t(e,b)[s+m[73]]=d},()=>{t(e,b)[s+m[75]]=d},()=>{t(e,b)[s+m[72]]=d}][f-16]():f<112||f<114&&[()=>{t(e,b)[s+m[5]]=d},()=>{t(e,b)[s+m[65]]=d}][f-112]()))})}).add([66,18,8,0],(a,c)=>{let l=a[0];if(l<32)e.setLetterDisplay(a.subarray(1,33),"NS5R letter display");else{let s=l-32;S(e,be,Date.now()+3200),S(e,Y,10),t(e,le,Se).fill(0);let i=a.subarray(1),o=4;i.forEach(function(d,u){let f=u+s,$=f>>4,w=f&15;if(f<80){let C=$<o?d:d>>3,M=0,X=$<o?6:3;for(;C>0;)t(e,le,Se)[w*32+$*7+(X-M)]=C&1,C=C>>1,M++}})}}).add([66,18,48],(a,c,l)=>{p(0,a)}).add([66,18,49],(a,c,l)=>{p(1,a)}).add([66,18,50],(a,c,l)=>{p(2,a)}).add([66,18,51],(a,c,l)=>{p(3,a)}).add([66,18,52],(a,c,l)=>{p(4,a)}).add([66,18,53],(a,c,l)=>{p(5,a)}).add([66,18,54],(a,c,l)=>{p(6,a)}).add([66,18,55],(a,c,l)=>{p(7,a)}).add([66,52],(a,c)=>{e.switchMode("ns5r"),S(e,G,!1);let l="";ge(a,(s,i)=>{i<8?(s>31&&(l+=String.fromCharCode(s)),i==7&&(e.aiEfxName=l)):i<10&&(e.setEffectType(i-8,44,s),e.dispatchEvent(`efx${["reverb","chorus"][i-8]}`,e.getEffectType(i-8)))})}).add([66,53],(a,c)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r"),S(e,G,!1);let l="",s=a[a.length-1],i=a.subarray(0,a.length-1),o=Ae(i);o!=s&&(console.info(`NS5R current multi dump checksum mismatch! Expected ${o}, got ${s}.`),console.debug(a));let d=e.getTrackPort(c);if(t(e,V)[d]&&t(e,V)[d]!=k.ns5r)if(t(e,we).dumpLimit==e.DUMP_MODE){console.warn(`Dump cancelled for track ${c}. Port ${String.fromCharCode(65+d)} mode "${Q[t(e,V)[d]]}" mismatch, should be "ns5r".`);return}else console.info(`Track ${c} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+d)}.`);e.setPortMode(d,2,k.ns5r),ge(i,function(u,f){switch(!0){case f<2944:{let $=e.chRedir(Math.floor(f/92),c,!0),w=$*E.cc;switch(f%92){case 0:{t(e,b)[w+m[0]]=u,e.dispatchEvent("voice",{part:$});break}case 1:{t(e,b)[w+m[32]]=u,!u&&!t(e,b)[w+m[0]]&&(t(e,b)[w+m[0]]=de.bank0),e.dispatchEvent("voice",{part:$});break}case 2:{t(e,O)[$]=u,u>0&&e.setChActive($,1),e.dispatchEvent("voice",{part:$});break}case 3:{let C=e.chRedir(u,c,!0);t(e,K)[$]=C,$!=C&&(console.info(`NS5R CH${$+1} receives from CH${C+1}.`),e.buildRchTree());break}case 7:{t(e,D)[$]=u,e.dispatchEvent("voice",{part:$});break}case 8:{t(e,R)[$*E.rpn+3]=u<40||u>88?u+(u>63?-192:64):u,t(e,I)[E.rpnt*$+2]=1,e.dispatchEvent("pitch",{part:$,pitch:e.getPitchShift($)});break}case 9:case 10:{t(e,b)[w+m[7]]=u;break}case 11:{t(e,b)[w+m[11]]=u;break}case 14:{t(e,b)[w+m[10]]=u||128;break}case 19:{t(e,b)[w+m[93]]=u;break}case 20:{t(e,b)[w+m[91]]=u;break}case 84:{t(e,b)[w+m[65]]=u;break}case 85:{t(e,b)[w+m[5]]=u;break}}break}case f<3096:break;case f<3134:{let $=f-3096;$<8?(u>31&&(l+=String.fromCharCode(u)),$==7&&(e.aiEfxName=l)):$<10&&(e.setEffectType($-8,44,u),e.dispatchEvent(`efx${["reverb","chorus"][$-8]}`,e.getEffectType($-8)));break}case f<8566:break}})}).add([66,54],(a,c)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r");let l="",s=80,i=0,o=0,d="MSB\tPRG\tLSB\tNME";ge(a,function(u,f){let $=f%158;switch(!0){case $<10:{u>31&&(l+=String.fromCharCode(u));break}case $==10:break;case $==11:{s=u&127;break}case $==12:{o=u&127;break}case $==13:{d+=`
${s}	${i}	${o}	${l.trim().replace("Init Voice","")}`,i++,l="";break}}}),e.userBank.clearRange({msb:80,lsb:0}),e.userBank.load(d),A()&&console.debug(d),e.forceVoiceRefresh()}).add([66,55],(a,c)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r");let l="",s=88,i=0,o=0,d="MSB\tPRG\tLSB\tNME";ge(a,function(u,f){let $=f%126;switch(!0){case $<10:{u>31&&(l+=String.fromCharCode(u));break}case $==11:break;case $==12:break;case $==13:{d+=`
${s}	${i}	${o}	${l.trim().replace("Init Combi","")}`,i++,l="";break}}}),e.userBank.clearRange({msb:88,lsb:0}),e.userBank.load(d),A()&&console.debug(d),e.forceVoiceRefresh()}).add([66,125],(a,c,l)=>{e.dispatchEvent("backlight",["green","orange","red",!1,"yellow","blue","purple"][a[0]]||"white")}).add([66,127],(a,c,l)=>{let s=a[a.length-1],i=a.subarray(0,a.length-1),o=Ae(i);o!=s&&(console.info(`NS5R screen dump checksum mismatch! Expected ${o}, got ${s}.`),console.debug(a));let d=new Uint8Array(5760);ge(a,(u,f,$)=>{if(f<720)for(let w=0;w<8;w++)d[f*8+w]=u>>7-w&1}),e.dispatchEvent("screen",{type:"ns5r",data:d})}).add([76],(a,c,l)=>{t(e,xe).run([66,...a],c,l)}),t(this,Qe).add([16,0,8,0],(a,c,l)=>{let s=(a[2]<<4)+a[3],i="K11 ";([()=>{e.switchMode("k11",!0),e.setPortMode(e.getTrackPort(c),2,k.k11),S(e,G,!1),t(e,_)[k.k11][1]=s?4:0,console.info("MIDI reset: GMega/K11")},()=>{e.setEffectType(0,24,s),console.debug(`${i}reverb type: ${s}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{console.debug(`${i}reverb time: ${s}`)},()=>{console.debug(`${i}reverb time: ${s}`)},()=>{console.debug(`${i}reverb predelay: ${s}`)},()=>{console.debug(`${i}reverb predelay: ${s}`)},()=>{console.debug(`${i}depth high: ${s}`)},()=>{console.debug(`${i}depth high: ${s}`)},()=>{console.debug(`${i}depth low: ${s}`)},()=>{console.debug(`${i}depth low: ${s}`)}][a[0]]||(()=>{}))()}).add([16,0,8,1],(a,c,l)=>{e.dispatchEvent("mupromptex");let s=e.chRedir(a[1],c,!0),i=E.cc*s,o=E.rpn*s,d=(a[3]<<4)+a[4],u=`K11 CH${s+1} `;([()=>{d<128?(e.setChType(s,e.CH_MELODIC,k.k11),t(e,b)[i+m[0]]=0,t(e,O)[s]=d):(e.setChType(s,e.CH_DRUMS,k.k11),t(e,O)[s]=d-128),e.dispatchEvent("voice",{part:s})},()=>{let f=e.chRedir(d,c,!0);t(e,K)[s]=f,s!=f&&(e.buildRchTree(),console.info(`${u}receives from CH${f+1}`))},()=>{t(e,b)[i+m[7]]=d},()=>{uupThis.setChActive(s,d)},()=>{t(e,b)[i+m[10]]=d},()=>{t(e,R)[o+3]=d+40,t(e,I)[E.rpnt*s+2]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},()=>{t(e,R)[o+1]=d>>1,t(e,R)[o+2]=d&1,t(e,I)[E.rpnt*s+1]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},()=>{t(e,b)[i+m[91]]=d?127:0},()=>{},()=>{t(e,b)[i+m[74]]=d},()=>{t(e,b)[i+m[73]]=d},()=>{t(e,b)[i+m[72]]=d}][a[0]]||(()=>{}))()}).add([16,0,9,0],(a,c,l)=>{e.dispatchEvent("mupromptex");let s=(a[2]<<4)+a[3],i="GMLX ";([()=>{console.debug(`${i}reverb type: ${s}`)},()=>{console.debug(`${i}reverb time: ${s}`)},()=>{console.debug(`${i}reverb predelay: ${s}`)},()=>{console.debug(`${i}depth high: ${s}`)},()=>{console.debug(`${i}depth low: ${s}`)}][a[0]]||(()=>{}))()}).add([16,0,9,3],(a,c,l)=>{e.dispatchEvent("mupromptex");let s=(a[2]<<4)+a[3],i=e.chRedir(a[1],c,!0),o=i*E.cc;[()=>{s<128?(e.setChType(i,e.CH_MELODIC,k.k11),t(e,b)[o+m[0]]=0,t(e,b)[o+m[32]]=0,t(e,O)[i]=s):s<160?(e.setChType(i,e.CH_MELODIC,k.k11),t(e,b)[o+m[0]]=0,t(e,b)[o+m[32]]=7,t(e,O)[i]=s-100):(e.setChType(i,e.CH_DRUMS,k.k11),t(e,b)[o+m[0]]=122,t(e,b)[o+m[32]]=0,t(e,O)[i]=s-160),e.dispatchEvent("voice",{part:i})},()=>{let d=e.chRedir(s,c,!0);t(e,K)[i]=d,i!=d&&(e.buildRchTree(),console.info(`GMLX CH${i+1} receives from CH${d+1}`))}][a[0]]()}).add([16,0,9,4],(a,c,l)=>{e.dispatchEvent("mupromptex");let s=(a[2]<<4)+a[3],i=e.chRedir(a[1],c,!0),o=i*E.cc,d=i*E.rpn,u=`GMLX CH${i+1} `;[()=>{e.setChActive(i,s)},()=>{t(e,b)[o+m[7]]=s},()=>{t(e,b)[o+m[10]]=s},()=>{t(e,b)[o+m[91]]=s?127:0},()=>{t(e,R)[d+3]=s+40,t(e,I)[E.rpnt*i+2]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{t(e,R)[d+1]=s,t(e,I)[E.rpnt*i+1]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{t(e,R)[d]=s,t(e,I)[E.rpnt*i]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{}][a[0]]()}),t(this,Ye).add([66,93,64],(a,c,l)=>{let s=a[2];switch(a[0]){case 0:{switch(a[1]){case 4:{e.dispatchEvent("mupromptex"),S(e,H,s*129/16383*100),e.dispatchEvent("mastervolume",t(e,H));break}case 5:{e.dispatchEvent("mupromptex"),s-64;break}case 6:{e.dispatchEvent("mupromptex"),console.debug(`SG global reverb: ${s?"on":"off"}`);break}case 127:{e.switchMode("sg",!0),e.setPortMode(e.getTrackPort(c),1,k.sg);break}}break}case 1:{switch(a[1]){case 48:{e.dispatchEvent("mupromptex"),console.debug(`SG reverb type: ${Bt[s]}`);break}}break}default:if(a[0]>>4==1){e.dispatchEvent("mupromptex");let i=e.chRedir(a[0]&15,c,!0);if(a[1]==2){let o=e.chRedir(s,c,!0);t(e,K)[i]=o,i!=o&&(e.buildRchTree(),console.info(`SG CH${i+1} receives from CH${o+1}`))}else a[1]==19&&(t(e,b)[E.cc*i+m[7]]=s)}else console.warn(`Unknown AKAI SG SysEx: ${a}`)}}),t(this,Ze).add([9],(a,c,l)=>{e.dispatchEvent("mupromptex"),console.debug(`GZ set effect: ${["stage reverb","hall reverb","room reverb","chorus","tremolo","phaser","rotary speaker","enhancer","flanger","EQ"][a[0]]||"off"}`)}),t(this,oe).add([127,0],(a,c,l)=>{e.switchMode("motif");let s=new Uint8Array([127,1,...a]);t(e,oe).run(s,c,l)}).add([127,1,0,0],(a,c,l)=>{e.switchMode("s90es");let s="S90/Motif ES system ",i=a[0];a.subarray(1).forEach((o,d)=>{([()=>{S(e,H,o*12900/16383),e.dispatchEvent("mastervolume",t(e,H))}][i+d]||(()=>{console.info(`Unrecognized ${s}ID: ${i+d}`)}))()})}).add([127,1,0,36,54,1],(a,c,l)=>{e.switchMode("s90es");let s="S90/Motif ES reverb ",i=a[0];a.subarray(1).forEach((o,d)=>{([()=>{e.setEffectTypeRaw(0,!1,o&15|112)},()=>{e.setEffectTypeRaw(0,!0,o)}][i+d]||(()=>{}))()}),e.dispatchEvent("efxreverb",e.getEffectType(0))}).add([127,1,0,37,54,2],(a,c,l)=>{e.switchMode("s90es");let s="S90/Motif ES chorus ",i=a[0];a.subarray(1).forEach((o,d)=>{([()=>{e.setEffectTypeRaw(1,!1,o&15|112)},()=>{e.setEffectTypeRaw(1,!0,o)}][i+d]||(()=>{}))()}),e.dispatchEvent("efxchorus",e.getEffectType(1))}).add([127,1,0,34,54,3],(a,c,l)=>{e.switchMode("s90es");let s="S90/Motif ES insert 1 ",i=a[0];a.subarray(1).forEach((o,d)=>{([()=>{e.setEffectTypeRaw(3,!1,o&15|112)},()=>{e.setEffectTypeRaw(3,!0,o)}][i+d]||(()=>{}))()}),e.dispatchEvent("efxinsert0",e.getEffectType(3))}).add([127,1,0,34,54,4],(a,c,l)=>{e.switchMode("s90es");let s="S90/Motif ES insert 2 ",i=a[0];a.subarray(1).forEach((o,d)=>{([()=>{e.setEffectTypeRaw(4,!1,o&15|112)},()=>{e.setEffectTypeRaw(4,!0,o)}][i+d]||(()=>{}))()}),e.dispatchEvent("efxinsert1",e.getEffectType(4))}).add([127,1,0,35,54,17],(a,c,l)=>{e.switchMode("s90es");let s="S90/Motif ES variation ",i=a[0];a.subarray(1).forEach((o,d)=>{([()=>{e.setEffectTypeRaw(2,!1,o&15|112)},()=>{e.setEffectTypeRaw(2,!0,o)}][i+d]||(()=>{}))()}),e.dispatchEvent("efxdelay",e.getEffectType(2))}).add([127,1,0,58,55],(a,c,l)=>{e.dispatchEvent("mupromptex"),e.switchMode("s90es");let s=e.getTrackPort(c);if(t(e,V)[s]&&t(e,V)[s]!=t(e,U).smotif)if(t(e,we).dumpLimit==e.DUMP_MODE){console.warn(`Dump cancelled for track ${c}. Port ${String.fromCharCode(65+s)} mode "${Q[t(e,V)[s]]}" mismatch, should be "${Q[t(e,U).smotif]}".`);return}else console.info(`Track ${c} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+s)}.`);let i=e.chRedir(a[0],c,!0),o=E.cc*i,d=a[1];a[0]>15&&(i=a[0]+32);let u=`Track ${c} S90/Motif ES bulk CH${i<128?i+1:"U"+(i-127)} `;console.debug(u,a),!(a[0]>15)&&a.subarray(2).forEach((f,$)=>{([()=>{t(e,b)[o+m[0]]=f,e.dispatchEvent("voice",{part:i})},()=>{f&&e.setChActive(i,1),t(e,b)[o+m[32]]=f,e.setChType(i,[32,40].indexOf(f)>-1?e.CH_DRUMS:e.CH_MELODIC,t(e,B),!0),e.dispatchEvent("voice",{part:i})},()=>{f&&e.setChActive(i,1),t(e,O)[i]=f,e.dispatchEvent("voice",{part:i})},()=>{let w=e.chRedir(f,c,!0);t(e,K)[i]=w,i!=w&&(e.buildRchTree(),console.info(`${u}receives from CH${w+1}`))},()=>{t(e,se)[i]=f?0:1},!1,!1,!1,!1,!1,!1,!1,!1,()=>{f!=100&&e.setChActive(i,1),t(e,b)[o+m[7]]=f},()=>{f!=64&&e.setChActive(i,1),t(e,b)[o+m[10]]=f},!1,!1,!1,()=>{t(e,b)[o+m[91]]=f},()=>{f&&e.setChActive(i,1),t(e,b)[o+m[93]]=f},()=>{f&&e.setChActive(i,1),t(e,b)[o+m[94]]=f},()=>{f!=127&&e.setChActive(i,1),t(e,b)[o+m[128]]=f,e.allocateAce(i,128)},()=>{},()=>{f!=64&&e.setChActive(i,1),t(e,b)[o+m[74]]=f},()=>{f!=64&&e.setChActive(i,1),t(e,b)[o+m[71]]=f},!1,()=>{t(e,b)[o+m[65]]=f},()=>{t(e,b)[o+m[5]]=f},()=>{}][d+$]||(()=>{}))()})}).add([127,1,54,16],(a,c,l)=>{e.switchMode("s90es");let s=a[0];a.subarray(1).forEach((i,o)=>{let u=`S90/Motif ES EQ${(o>>2)+1} `;([()=>{let f=i-64},()=>{let f=nt[i]},()=>{let f=i/10},()=>{let f=i}][s+o&3]||(()=>{}))()})}),t(this,ue).add([0,72,18,0,0,0,0],(a,c,l)=>{e.switchMode("sd",!0),e.setPortMode(e.getTrackPort(c),2,k.sd),console.info("MIDI reset: SD")}).add([0,72,18,16,0],(a,c,l)=>{e.dispatchEvent("mupromptex");let s=a[0]>>5,i=a[0]&31;switch(s){case 0:{let o=a[0]>>1,d=a[1];switch(o){case 1:{a.subarray(2).forEach((u,f,$)=>{let w=f+d;switch(w){case 0:{u&&(e.setEffectType(1,60,u-1),e.dispatchEvent("efxchorus",e.getEffectType(1)),console.debug(`SD MFX Cho: ${w} - ${u}`));break}}});break}case 2:{a.subarray(2).forEach((u,f)=>{let $=f+d;switch($){case 0:{u&&(e.setEffectType(0,55+u,0),e.dispatchEvent("efxreverb",e.getEffectType(0)),console.debug(`SD MFX Rev: ${$} - ${u}`));break}}});break}case 3:case 4:case 5:{let u=o-1;a.subarray(2).forEach((f,$)=>{let w=$+d;switch(console.debug(`SD MFX ${u-2}: ${w} - ${f}`),w){case 0:{e.setEffectTypeRaw(u,62,f),e.dispatchEvent(`efx${u>2?"delay":"insert"+(u-4)}`,e.getEffectType(u));break}}}),console.debug(`SD MFX message:
%o`,a);break}default:console.debug(`Unknown SD-90 global effects message:
%o`,a)}break}case 1:{let o=e.chRedir(i,c,!0),d=a[1],u=o*E.cc;a.subarray(2).forEach((f,$)=>{let w=d+$;w<37?([()=>{},()=>{},0,()=>{},()=>{switch(t(e,b)[u+m[0]]=f,f){case 104:case 105:case 106:case 107:case 120:{t(e,D)[o]||e.setChType(o,e.CH_DRUMS);break}default:t(e,D)[o]&&e.setChType(o,e.CH_MELODIC)}e.dispatchEvent("voice",{part:o})},()=>{t(e,b)[u+m[32]]=f,e.dispatchEvent("voice",{part:o})},()=>{t(e,O)[o]=f,e.dispatchEvent("voice",{part:o})},()=>{t(e,b)[u+m[7]]=f},()=>{t(e,b)[u+m[10]]=f},()=>{},()=>{},()=>{f<2&&(t(e,se)[o]=f)},()=>{f<2&&(t(e,b)[u+m[68]]=f?127:0)},()=>{},()=>{f<2&&(t(e,b)[u+m[65]]=f?127:0)},()=>{t(e,b)[u+m[5]]=f&15<<4|t(e,b)[u+m[5]]&15},()=>{t(e,b)[u+m[5]]=f&15|(t(e,b)[u+m[5]]&240)>>4},()=>{t(e,b)[u+m[74]]=f},()=>{t(e,b)[u+m[71]]=f},()=>{t(e,b)[u+m[73]]=f},()=>{t(e,b)[u+m[72]]=f},0,0,0,0,0,0,0,()=>{t(e,b)[u+m[128]]=f,e.allocateAce(128)},()=>{t(e,b)[u+m[93]]=f},()=>{t(e,b)[u+m[91]]=f},0,0,()=>{t(e,b)[u+m[75]]=f},()=>{t(e,b)[u+m[76]]=f},()=>{t(e,b)[u+m[77]]=f},()=>{t(e,b)[u+m[78]]=f}][w]||(()=>{}))():w<63||(w<64?(t(e,D)[o]?t(e,b)[u+m[0]]=104|f:t(e,b)[u+m[0]]=96|f,e.dispatchEvent("voice",{part:o})):console.debug(`Unknown SD-90 global CH${o+1} param setup message:
%o`,a))});break}case 2:{let o=e.chRedir(i,c,!0),d=a[1];console.debug(`Unknown SD-90 global CH${o+1} MIDI setup message:
%o`,a.subarray(2));break}default:console.warn(`Unknown SD-90 global part setup message:
%o`,a)}}),t(e,xe).add([0,1,73,78],(a,c,l)=>{e.switchMode("krs"),e.setPortMode(e.getTrackPort(c),1,k.krs),console.debug("Might be KORG KROSS 2 mode reset... Not sure.")}).add([0,1,73,117,2,37],(a,c,l)=>{e.switchMode("krs");let s=e.getTrackPort(c);if(t(e,V)[s]&&t(e,V)[s]!=k.krs)if(t(e,we).dumpLimit==e.DUMP_MODE){console.warn(`Dump cancelled. Port ${String.fromCharCode(65+s)} mode "${Q[t(e,V)[s]]}" mismatch, should be "krs".`);return}else console.info(`Track ${c} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+s)}.`);e.setPortMode(e.getTrackPort(c),1,k.krs);let i="KROSS 2 BMT1 ",o="";ge(a,(d,u)=>{if(u<24)o+=String.fromCharCode(Math.max(32,d));else if(!(u<1276)){let f=u-1276,$=e.chRedir(Math.floor(f/44),c,!0),w=f%44,C=E.cc*$;w<15?([()=>{d&&e.setChActive($,1),t(e,O)[$]=d,e.dispatchEvent("voice",{part:$})},()=>{d&&e.setChActive($,1),d<10?(t(e,b)[C+m[0]]=63,t(e,b)[C+m[32]]=d):d<20?(t(e,b)[C+m[0]]=121,t(e,b)[C+m[32]]=d-10):d<24&&(t(e,b)[C+m[0]]=[120,0,56,62][d-20],t(e,b)[C+m[32]]=0),e.dispatchEvent("voice",{part:$})},()=>{let M=e.chRedir(d&15,c,!0);t(e,K)[$]=M,console.info(`${i}CH${$+1} receives from CH${M+1}`)},!1,!1,()=>{t(e,b)[C+m[7]]=d},!1,()=>{},()=>{},!1,!1,!1,!1,!1,()=>{t(e,b)[C+m[10]]=d||128}][w]||(()=>{}))():w<36||([()=>{t(e,b)[C+m[74]]=(d+128&255)-64},()=>{t(e,b)[C+m[71]]=(d+128&255)-64},!1,!1,()=>{t(e,b)[C+m[73]]=(d+128&255)-64},()=>{t(e,b)[C+m[75]]=(d+128&255)-64},!1,()=>{t(e,b)[C+m[72]]=(d+128&255)-64}][w]||(()=>{}))()}}),o=o.trimRight(),e.dispatchEvent("metacommit",{type:"EORTitle",data:o})})}chRedir(e,r,h){let n=this;if(t(n,Ne)[r])return(t(n,Ne)[r]-1)*16+e;if(t(n,B)==k.sc){if(h==1)return e;let p=0,y=!0;for(;y;)t(n,Me)[e+p]==0?(t(n,Me)[e+p]=r,console.debug(`Assign track ${r} to channel ${e+p+1}.`),y=!1):t(this,Me)[e+p]==r?y=!1:(p+=16,p>=128&&(p=0,y=!1));return e+p}else return e}getTrackPort(e){return this.chRedir(0,e,!0)>>4}forceVoiceRefresh(){for(let e=0;e<E.ch;e++)t(this,he)[e]&&this.dispatchEvent("voice",{part:e})}buildRchTree(){let e=[];t(this,K).forEach((r,h)=>{var n;r<E.ch&&((n=e[r])!=null&&n.constructor||(e[r]=[]),e[r].push(h))}),S(this,xt,e)}buildRccMap(){let e=this;for(let r=0;r<E.ch;r++)t(e,Ke)[r]={};t(e,Ve).forEach((r,h)=>{r&&(t(e,Ke)[Math.floor(h/E.redir)][r]=h%E.redir|128)}),A()&&console.debug(t(e,Ke))}getActive(){return t(this,he)}getCc(e){let r=this,h=e*E.cc,n=t(r,b).subarray(h,h+E.cc);return n[m[0]]=n[m[0]]||t(r,_)[r.getChModeId(e)][0],n[m[32]]=n[m[32]]||t(r,_)[r.getChModeId(e)][1],n[m[0]]==de.bank0&&(n[m[0]]=0),n}getCcCh(e,r){let h=this;if(vt.indexOf(r)<0)throw new Error("CC number not accepted");let n=t(h,b)[E.cc*e+m[r]];switch(r){case 0:{n=n||t(h,_)[h.getChModeId(e)][0],n==de.bank0&&(n=0);break}case 32:{n=n||t(h,_)[h.getChModeId(e)][1];break}}return n}getCcAll(){let e=this,r=t(e,b).slice();for(let h=0;h<E.ch;h++){let n=h*E.cc;r[n+m[0]]=r[n+m[0]]||t(e,_)[e.getChModeId(h)][0],r[n+m[32]]=r[n+m[32]]||t(e,_)[e.getChModeId(h)][1],r[m[0]]==de.bank0&&(r[m[0]]=0)}return r}getChSource(){return t(this,K)}getChType(){return t(this,D)}setChType(e,r,h=0,n=!1){r&=15;let p=this;h=h||p.getChModeId(e),t(p,D)[e]=r,r>0&&!n&&(t(p,b)[e*E.cc+m[0]]=t(p,_)[h][2])}setChActive(e,r=0){t(this,he)[e]!=r&&this.dispatchEvent("channeltoggle",{part:e,active:r}),t(this,he)[e]=r}getExt(e){let r=E.ext*e,h=t(this,ie).subarray(r,r+E.ext),n=new Uint8Array(h.length);return n.set(h),n[1]=n[1]||t(this,Pt),n}getPitch(){return t(this,Te)}getProgram(){return t(this,O)}getTexts(){return t(this,ce).slice()}getVel(e){let r=new Map,h=this;return t(h,q).forEach(function(n,p){let y=Math.floor(n/128),v=n%128;e==y&&t(h,z)[n]>0&&r.set(v,{v:t(h,z)[n],s:t(h,W)[p]})}),r}getBitmap(){return{bitmap:t(this,le,Se),expire:t(this,be)}}getLetter(){return{text:t(this,Ue),set:t(this,kt),expire:t(this,Be)}}getMode(){return Q[t(this,B)]}getMaster(){return{volume:t(this,H)}}getRawStrength(){let e=this;return t(this,q).forEach(function(r){let h=Math.floor(r/128);t(e,z)[r]>t(e,$e)[h]&&(t(e,$e)[h]=t(e,z)[r])}),t(this,$e)}getStrength(){let e=[],r=this;return this.getRawStrength().forEach(function(h,n){e[n]=Math.floor(h*t(r,b)[n*E.cc+m[7]]*t(r,b)[n*E.cc+m[11]]*t(r,H)/803288)}),e}getRpn(){return t(this,R)}getNrpn(){return t(this,ct)}getSubDb(){return self==null?void 0:self.structuredClone(t(this,_))}getVoice(e,r,h,n="?"){var l;let p=this;(l=k[n])!=null&&l.constructor||(n="?");let y=k[n],v=e||t(p,_)[y][0],x=r,a=h||t(p,_)[y][1];v==de.bank0&&(v=0),a==de.bank0&&(a=0),n=="ns5r"&&v>0&&v<56&&(a=3);let c=p.userBank.get(v,x,a,n);if(n=="mt32"&&c.name.indexOf("MT-m:")==0){let s=parseInt(c.name.slice(5)),i=s*E.cmt,o="";t(p,Le).subarray(i,i+10).forEach(u=>{u>31&&(o+=String.fromCharCode(u))});let d=`MSB	LSB	PRG	NME
0	127	${x}	${o}`;p.userBank.load(d,!0),c.name=o,c.ending=" "}return(c.ending!=" "||!c.name.length)&&(c=p.baseBank.get(v,x,a,n)),c}getChVoice(e){let r=this,h=r.getVoice(r.getCcCh(e,0),t(r,O)[e],r.getCcCh(e,32),r.getChMode(e));if(t(r,Ee)[e]){let n="";switch(t(r,B)){case k.mt32:{t(r,ye).subarray(E.cmt*(e-1),E.cmt*(e-1)+10).forEach(p=>{n+=String.fromCharCode(Math.max(p,32))}),n=n.trimRight();break}default:{let p=E.cvn*e;t(r,$t).subarray(p,p+E.cvn).forEach(y=>{n+=String.fromCharCode(Math.max(y,32))}),n=n.trimRight()}}n.length&&(h.ending="~",h.name=n)}return h}getRawPitch(){return t(this,Te)}getPitchShift(e){let r=this,h=e*E.rpn,n=t(r,R)[h];return t(r,I)[e*E.rpnt]||t(r,B)==k.mt32&&(n=12),t(r,Te)[e]/8192*n+(t(r,R)[h+3]-64)+((t(r,R)[h+1]<<7)+t(r,R)[h+2]-8192)/8192}getEffectType(e=0){let r=3*e+1;return t(this,ne).subarray(r,r+2)}setEffectTypeRaw(e=0,r,h){let n=3*e;t(this,ne)[n]=1,t(this,ne)[n+1+ +r]=h}setEffectType(e=0,r,h){this.setEffectTypeRaw(e,!1,r),this.setEffectTypeRaw(e,!0,h)}getEffectSink(){return t(this,ot)}setLetterDisplay(e,r,h=0,n=3200){let p=this,y;S(p,Ue," ".repeat(h)),e.forEach(v=>{S(p,Ue,t(p,Ue)+String.fromCharCode(v>31?v:32)),v<32&&(y=y||new Set,y.add(v))}),S(p,kt,Date.now()),S(p,Be,Date.now()+n),y&&(y=Array.from(y),y.forEach((v,x,a)=>{a[x]=v.toString(16).padStart(2,"0")}),console.warn(`${r}${r?" ":""}invalid code point${y.length>1?"s":""}: 0x${y.join(", 0x")}`))}setDetectionTargets(e="?",r=0){let h=this,n=-1;switch(e.replaceAll(", ",",").split(",").forEach(p=>{p=p.toLowerCase();let y=Q.indexOf(Ga[p]||p);A()&&console.debug(`Mapped mode "${p}" to ID "${y}".`),y>-1&&(n=y)}),A()&&console.debug(`Set detection target to ID "${n}".`),n>0&&(t(h,U).x5=82,t(h,U).ds=k.krs),n){case k["05rw"]:{t(h,U).x5=81;break}case k.s90es:t(h,U).ds=k.s90es,t(h,U).smotif=k.s90es;case k.motif:t(h,U).ds=k.motif,t(h,U).smotif=k.motif}}setGsTargets(e=!1,r=4){if(!r)r=e?3:4;else{if(r>4||r<0)throw new Error(`Invalid GS level ${r}`);if(e&&r>>1!=1)throw new Error(`Invalid SC level ${r}`)}let h=this;t(h,U)[e?"sc":"gs"]=r,t(h,_)[k[e?"sc":"gs"]][1]=r,h.forceVoiceRefresh()}getConfigs(){return t(this,wt)}setDumpLimit(e){if(e>2||e<0)throw new RangeError("Invalid dump limit.");t(this,we).dumpLimit=e}allocateAce(e=0,r){let h=this;if(!r||r<128&&r>95){console.warn(`cc${r} cannot be allocated as an active custom effect.`);return}let n=!0,p=0,y=E.ace*e;for(;n&&p<E.ace;)t(h,Z)[p+y]==r?n=!1:t(h,Z)[p+y]||(n=!1,t(h,Z)[p+y]=r,console.info(`Allocated cc${r} to ACE slot ${p} in CH${e+1}.`)),p++;p>=E.ace&&console.warn(`ACE slots are full in CH${e+1}.`)}allocateAceAll(e){let r=this;if(!e||e<128&&e>95){console.warn(`cc${e} cannot be allocated as an active custom effect.`);return}for(let h=0;h<E.ch;h++){let n=!0,p=0,y=E.ace*h;for(;n&&p<E.ace;)t(r,Z)[p+y]==e?n=!1:t(r,Z)[p+y]||(n=!1,t(r,Z)[p+y]=e),p++;p>=E.ace&&console.warn(`ACE slots are full in CH${h+1}.`)}}releaseAce(e=0,r){let h=!0,n=E.ace*e,p=n+E.ace;for(;h&&n<p;)t(this,Z)[n]==r&&(t(this,Z)[n]=0,h=!1),n++;h&&A()&&console.debug(`No ACE slot was allocated to cc${r} in CH${e+1}.`)}resetAce(){t(this,Z).fill(0),console.info("All ACE slots have been reset.")}getAce(){return t(this,Z)}getChAce(e=0,r=0){if(r<0||r>=E.ace)throw new RangeError("No such ACE slot");let h=t(this,Z)[E.ace*e+r];if(h){if(vt.indexOf(h)>=0)return t(this,b)[e*E.cc+m[h]];throw new Error(`Invalid ACE source in CH${e+1}: ${h}`)}else return 0}initDrums(){let e=this;t(e,te).fill(64);for(let r=0;r<E.drm;r++){let h=r*E.dpn;for(let n in ga){let p=ga[n],y=(h+fe[n])*E.dnc;t(e,te).subarray(y,y+E.dnc).fill(p)}}}init(e=0){let r=this;S(r,Fe,0),t(r,_)[k.xg][1]=0,r.dispatchEvent("banklevel",{mode:"xg",data:0}),t(r,he).fill(0),t(r,b).fill(0),t(r,Z).fill(0),t(r,O).fill(0),t(r,z).fill(0),t(r,q).fill(0),t(r,se).fill(0),t(r,$e).fill(0),t(r,Te).fill(0),t(r,ct).fill(0),t(r,I).fill(0),t(r,ie).fill(0),t(r,V).fill(0),t(r,Oe).fill(0),t(r,Ve).fill(0),S(r,H,100),S(r,ce,[]),S(r,dt,500),S(r,ft,0),S(r,be,0),S(r,Y,0),t(r,le,Se).fill(0),S(r,G,!1),S(r,ht,0),S(r,ke,!0),r.initDrums(),t(r,K).forEach(function(h,n,p){p[n]=n}),e==0&&(r.dispatchEvent("mode","?"),S(r,B,0),t(r,Me).fill(0),t(r,Ne).fill(0),S(r,Be,0),S(r,Ue,"")),la.forEach(h=>{t(r,b)[E.cc*h]=t(r,_)[r.getChModeId(h)][2]}),t(r,D).fill(r.CH_MELODIC),t(r,D)[9]=r.CH_DRUM1,t(r,D)[25]=r.CH_DRUM3,t(r,D)[41]=r.CH_DRUMS,t(r,D)[57]=r.CH_DRUMS,t(r,D)[73]=r.CH_DRUM5,t(r,D)[89]=r.CH_DRUM7,t(r,D)[105]=r.CH_DRUMS,t(r,D)[121]=r.CH_DRUMS;for(let h=0;h<E.drm;h++)t(r,me)[h<<1]=0,t(r,me)[h<<1|1]=E.invalidCh;t(r,lt).fill(0),t(r,Le).fill(0),t(r,Ie).fill(0),t(r,ye).fill(0),t(r,Ee).fill(0),t(r,ne).fill(0),t(r,ot).fill(0),r.aiEfxName="",r.userBank.clearRange({msb:0,lsb:127,prg:[0,127]});for(let h=0;h<E.ch;h++){let n=h*E.cc;t(r,b)[n+m[7]]=100,t(r,b)[n+m[11]]=127,t(r,b)[n+m[2]]=127,t(r,b)[n+m[10]]=64,t(r,b).subarray(n+m[71],n+m[71]+8).fill(64),t(r,b)[n+m[128]]=127,t(r,b).subarray(n+m[130],n+m[157]+1).fill(64),t(r,b)[n+m[91]]=40,t(r,b)[n+m[101]]=127,t(r,b)[n+m[100]]=127,t(r,b)[n+m[99]]=127,t(r,b)[n+m[98]]=127;let p=h*E.rpn;t(r,R)[p]=2,t(r,R)[p+1]=64,t(r,R)[p+2]=0,t(r,R)[p+3]=64,t(r,R)[p+4]=0,t(r,R)[p+5]=0;let y=h*E.ext;t(r,ie)[y+1]=r.VLBC_BRTHEXPR;let v=h*E.redir;t(r,Ve)[v+8]=13}r.buildRchTree(),r.buildRccMap(),r.dispatchEvent("mastervolume",t(r,H)),r.dispatchEvent("efxreverb",r.getEffectType(0)),r.dispatchEvent("efxchorus",r.getEffectType(1)),r.dispatchEvent("efxdelay",r.getEffectType(2)),r.dispatchEvent("efxinsert0",r.getEffectType(3)),r.dispatchEvent("efxinsert1",r.getEffectType(4)),r.dispatchEvent("efxinsert2",r.getEffectType(5)),r.dispatchEvent("efxinsert3",r.getEffectType(6)),r.dispatchEvent("reset"),r.switchMode("?")}setChMode(e,r){let h=this;if(e<0||e>=E.ch)throw new RangeError(`Invalid CH${e+1}`);if(port<0||r>=Q.length)throw new RangeError(`Invalid mode ID ${r}`);t(h,Oe)[e]=r,h.dispatchEvent("voice",{part:e})}getChMode(e,r){return Q[this.getChModeId(e,r)]}getChModeId(e,r){return r?t(this,Oe)[e]||t(this,V)[e>>4]:t(this,Oe)[e]||t(this,V)[e>>4]||t(this,B)}setPortMode(e,r,h){let n=this;if(e<0||e>=E.ch>>4)throw new RangeError(`Invalid port ${e+1}`);if(r<1)throw new RangeError("Range must be a positive integer");if(e+r>=E.ch>>4)throw new RangeError("Range must be in bound");if(e<0||h>=Q.length)throw new RangeError(`Invalid mode ID ${h}`);for(let p=e;p<e+r;p++){t(n,V)[p]=h;for(let y=p<<4;y<p+1<<4;y++)n.dispatchEvent("voice",{part:y})}}copyChSetup(e,r,h){if(e==r){console.warn(`Failed attempt at overwriting CH${e+1} with its own data.`);return}let n=this;if(h&&t(n,he)[r]){console.warn(`Failed attempt at copying setup data from CH${e+1} to CH${r+1}.`);return}let p=E.cc*e,y=E.cc*r;t(n,O)[r]=t(n,O)[e],t(n,b).set(t(n,b).subarray(p,p+E.cc),y)}setDrumFirstWrite(e,r){let h=this,n=t(h,D)[e];if(n<2)return;let p=n-2;if(t(h,me)[p<<1]){if(r)t(h,me)[p<<1]=0,A()&&console.debug(`First write part for drum set ${p+1} has been reset.`);else return;}else r?console.warn(`First write part for drum set ${p+1} is already blank.`):(t(h,me)[p<<1]=1,t(h,me)[p<<1|1]=e,console.debug(`First write part for drum set ${p+1} is set to CH${e+1}.`))}getChDrumFirstWrite(e){let r=this,h=t(r,D)[e];if(h<2)return;let n=h-2;return t(r,me).subarray(n<<1,n+1<<1)}getDrumFirstWrite(e){if(e>=0&&e<E.drm)return t(this,me).subarray(e<<1,e+1<<1)}switchMode(e,r=!1,h=!1){var y;let n=this,p=k[e];if(p>-1){if(t(n,B)==0||r){let v=t(n,B);n.initOnReset&&r&&(this.init(1),v=k["?"]),S(n,B,p),S(n,Y,0);for(let a=0;a<E.ch;a++)t(n,D)[a]>0&&t(n,Oe)[a]==0&&(t(n,b)[a*E.cc]=t(n,_)[p][2]);switch(p){case k.mt32:{Ht.forEach((a,c)=>{let l=c+1;t(n,he)[l]||(t(n,O)[l]=a,t(n,b)[l*E.cc+m[91]]=127)});for(let a=1;a<10;a++)n.dispatchEvent("voice",{part:a});break}}let x;switch(p){case k["?"]:case k.g2:{x=[52,4,52,18,0,0,0,0];break}case k.xg:{x=[1,0,65,0,5,0,0,0];break}case k.gm:case k.gs:case k.sc:{x=[40,4,40,18,40,32,32,0];break}case k.sd:{x=[58,0,60,0,61,0,61,0];break}case k["05rw"]:case k.x5d:case k.ns5r:{x=[44,1,44,19,44,0,44,0];break}case k.k11:case k.sg:{x=[24,0,0,0,0,0,0,0];break}case k.mt32:{x=[40,4,0,0,0,0,0,0];break}case k.doc:{x=[24,16,0,0,0,0,0,0];break}case k.motif:case k.s90es:{x=[113,0,117,0,114,0,0,0];break}default:x=[0,0,0,0,0,0,0,0]}for(let a=0;a<E.efx;a++)!t(n,ne)[3*a]&&(y=x[a<<1])!=null&&y.constructor&&(t(n,ne)[3*a+1]=x[2*a],t(n,ne)[3*a+2]=x[2*a+1],n.dispatchEvent(`efx${["reverb","chorus","delay","insert0"][a]}`,n.getEffectType(a)));h&&n.setDetectionTargets(e),n.dispatchEvent("mode",e),n.forceVoiceRefresh(),la.forEach(a=>{n.dispatchEvent("voice",{part:a})})}}else throw new Error(`Unknown mode ${e}`)}newStrength(){t(this,$e).fill(0)}runJson(e){var r;if(e.type>14)return e.type==15&&e.data.constructor!=Uint8Array&&(e.data=Uint8Array.from(e.data)),t(this,St)[e.type].call(this,e);{let h=this.chRedir(e.part,e.track),n=!1;(r=t(this,xt)[h])==null||r.forEach(p=>{e.channel=p,n=!0,t(this,St)[e.type].call(this,e)}),n||console.warn(`${da[e.type]?da[e.type]:e.type}${[11,12].includes(e.type)?(e.data[0]!=null?e.data[0]:e.data).toString():""} event sent to CH${h+1} without any recipient.`)}t(this,ce).length>100&&t(this,ce).splice(100,t(this,ce).length-99)}runRaw(e){}async loadBank(e,r){let h=this;switch(e=e.toLowerCase(),e){case"s7e":{h.userBank.clearRange({msb:63,lsb:[21,22]}),h.userBank.clearRange({msb:63,lsb:[24,27]});break}case"pcg":{h.userBank.clearRange({msb:63,lsb:[6,9]}),h.userBank.clearRange({msb:63,lsb:[13,16]});break}default:throw new Error(`Unknown bank format ${e}`)}switch(e){case"s7e":case"pcg":{bt.context=this,await h.userBank.load(await bt.read(e,r),!1);break}}h.forceVoiceRefresh()}},B=new WeakMap,Y=new WeakMap,be=new WeakMap,Ce=new WeakMap,le=new WeakSet,Se=function(){return t(this,Ce)[t(this,Y)]},ya=function(e){t(this,Ce)[t(this,Y)]=e},he=new WeakMap,K=new WeakMap,D=new WeakMap,b=new WeakMap,Z=new WeakMap,O=new WeakMap,z=new WeakMap,se=new WeakMap,q=new WeakMap,W=new WeakMap,Te=new WeakMap,$e=new WeakMap,Xe=new WeakMap,ie=new WeakMap,R=new WeakMap,I=new WeakMap,ct=new WeakMap,te=new WeakMap,me=new WeakMap,ne=new WeakMap,ot=new WeakMap,Ve=new WeakMap,V=new WeakMap,Oe=new WeakMap,Ee=new WeakMap,$t=new WeakMap,Ie=new WeakMap,ye=new WeakMap,lt=new WeakMap,Le=new WeakMap,_=new WeakMap,U=new WeakMap,we=new WeakMap,wt=new WeakMap,H=new WeakMap,Fe=new WeakMap,dt=new WeakMap,ft=new WeakMap,Ue=new WeakMap,Be=new WeakMap,kt=new WeakMap,ht=new WeakMap,ke=new WeakMap,G=new WeakMap,Pt=new WeakMap,xt=new WeakMap,Ke=new WeakMap,ce=new WeakMap,Me=new WeakMap,Ne=new WeakMap,J=new WeakMap,ze=new WeakMap,F=new WeakMap,St=new WeakMap,Rt=new WeakMap,qe=new WeakMap,We=new WeakMap,oe=new WeakMap,ue=new WeakMap,xe=new WeakMap,Qe=new WeakMap,Ye=new WeakMap,Ze=new WeakMap,Ea);var Vt=La(va(),1);L();L();var Ct,$a,ka=($a=class{constructor(g,e,r,h){T(this,Ct,!1);S(this,Ct,g),this.start=e,this.end=r,this.data=h}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return t(this,Ct)}},Ct=new WeakMap,$a),Gt=class extends ka{constructor(g,e,r){super(!0,g,e,r)}},xa=class extends ka{constructor(g,e){super(!1,g,g,e)}},Je,wa,Xt=(wa=class extends Array{constructor(){super(...arguments);T(this,Je,-1)}resetIndex(e){S(this,Je,-1)}fresh(){this.sort(function(e,r){return e.start==r.start?0:(+(e.start>r.start)<<1)-1}),this.forEach(function(e,r){e.index=r})}step(e,r=!1){let h=[];if(r)for(let n=0;n<this.length&&!(this[n].start>e);n++){if(this[n].end<e)continue;h.push(this[n])}else{let n=this.getRange(t(this,Je)==-1?0:e-1,e),p=this;n.forEach(function(y){y.index>t(p,Je)&&(h.push(y),S(p,Je,y.index))})}return h}getRange(e,r){var v;e>r&&([e,r]=[r,e]);let h=[],n=-1,p=Math.ceil(Math.sqrt(this.length)),y=!0;for(let x=0;x<this.length;x+=p)this[x+p]?n<0&&this[x+p].start>=e&&(n=x):n=n<0?x:n;for(;y;)((v=this[n])==null?void 0:v.end)<r?this[n].start>=e&&h.push(this[n]):y=!1,n++;return h}},Je=new WeakMap,wa);var Wa=0xffffffffffff,Sa=function(g){let e=new Xt,r=this,h=g.timeDivision,n=120,p=new Xt,y=0,v=0;p.push(new Gt(0,Wa,[120,0])),g.track.forEach(function(l){y=0,l.event.forEach(function(s){y+=s.deltaTime,s.type==255&&(s==null?void 0:s.metaType)==81&&(n=6e7/s.data,p[p.length-1]&&p.push(new Gt(y,0xffffffffffff,[n,0])))})}),p.fresh(),p.forEach(function(l,s,i){s>0&&(i[s-1].end=l.start)});let x=120;p.forEach(function(l,s,i){s>0&&(l.end==l.start?i.splice(i.indexOf(l),1):x==l.data[0]&&(i[s-1].end=l.end,i.splice(i.indexOf(l),1)),x=l.data[0])});let a=0,c=120;return p.forEach(function(l){let s=l.start,i=s/c/h*60+a;c=l.data[0],a=i-s/c/h*60,l.data[1]=a}),console.debug("All tempo changes: ",p),n=120,y=0,v=0,g.track.forEach(function(l,s){y=0,v=0;let i=s+1;l.event.forEach(function(o,d){y+=o.deltaTime;let u=p.step(y,!0)[0];u&&(n=u.data[0],v=u.data[1]);let f={type:o.type,data:o.data,track:i,part:0};o.type>14?f.meta=o.metaType:f.part=o.channel,e.push(new xa(y/n/h*60+v,f))})}),e.fresh(),self.midiEvents=e,console.debug(`Parsed a type ${g.formatType} MIDI sequence.`),e};Vt.default.customInterpreter=ca;var N=function(g,e,r){g.addEventListener(r,h=>{e.dispatchEvent(r,h.data)})},je,et,ut,Pe,tt,pt,at,Tt,He,_e,j,rt,Re,st,Ca,ts=(Ca=class extends Mt{constructor(e,r=.5,h=.5){super();P(this,"device");T(this,je,void 0);T(this,et,{});T(this,ut,[]);T(this,Pe,"");T(this,tt,[]);T(this,pt,[]);T(this,at,new Uint8ClampedArray(128));T(this,Tt,new Uint8ClampedArray(128));T(this,He,.5);T(this,_e,120);T(this,j,4);T(this,rt,4);T(this,Re,0);T(this,st,0);P(this,"smoothingAtk",0);P(this,"smoothingDcy",0);let n=this;n.smoothingAtk=r,n.smoothingDcy=h,n.device=e,n.addEventListener("meta",function(p){var y;(y=p==null?void 0:p.data)==null||y.forEach(function(v){(t(n,tt)[v.meta]||console.debug).call(n,v.meta,v.data)})}),N(n.device,n,"mode"),N(n.device,n,"mastervolume"),N(n.device,n,"channelactive"),N(n.device,n,"channelmin"),N(n.device,n,"channelmax"),N(n.device,n,"portrange"),N(n.device,n,"portstart"),N(n.device,n,"channelreset"),N(n.device,n,"channeltoggle"),N(n.device,n,"screen"),N(n.device,n,"metacommit"),N(n.device,n,"voice"),N(n.device,n,"pitch"),N(n.device,n,"note"),N(n.device,n,"reset"),N(n.device,n,"banklevel"),N(n.device,n,"efxreverb"),N(n.device,n,"efxchorus"),N(n.device,n,"efxdelay"),N(n.device,n,"efxinsert0"),N(n.device,n,"efxinsert1"),N(n.device,n,"efxinsert2"),N(n.device,n,"efxinsert3"),N(n.device,n,"partefxtoggle"),n.addEventListener("note",function({data:p}){t(n,pt).push(p)}),t(n,tt)[3]=function(p,y){var v;((v=t(n,Pe))==null?void 0:v.length)<1&&(S(n,Pe,y),n.dispatchEvent("title",t(n,Pe)))},t(n,tt)[81]=function(p,y){let v=n.noteProgress,x=t(n,He)||.5;S(n,_e,6e7/y),S(n,He,y/1e6),S(n,Re,t(n,Re)+(v*(x/t(n,He))-v)),n.dispatchEvent("tempo",t(n,_e))},t(n,tt)[88]=function(p,y){let v=n.noteProgress,x=n.noteOverall,a=n.noteBar,c=n.noteBeat,l=t(n,j),s=t(n,rt);S(n,j,y[0]),S(n,rt,1<<y[1]);let i=24*(32/y[3])/y[2];if(l!=t(n,j)){let o=a;S(n,Re,t(n,Re)-o*(t(n,j)-l)),c+1>=l&&(l<t(n,j)?S(n,Re,t(n,Re)-Math.ceil(t(n,j)-c-1)):S(n,Re,t(n,Re)+t(n,j)))}n.dispatchEvent("tsig",n.getTimeSig())}}reset(){var r;let e=this;e.dispatchEvent("reset"),(r=t(e,je))==null||r.resetIndex(),e.device.init(),S(e,Pe,""),S(e,He,.5),S(e,_e,120),S(e,j,4),S(e,rt,4),S(e,Re,0),S(e,st,0),e.dispatchEvent("tempo",t(e,_e)),e.dispatchEvent("title",t(e,Pe))}init(){this.reset(),S(this,je,void 0)}async loadFile(e){S(this,je,Sa(Vt.default.parse(new Uint8Array(await e.arrayBuffer()))))}async loadMap(e,r){let h=this,n=0,p=0,y=0,v,x;e.split(`
`).forEach((a,c)=>{if(!a)return;let l=a.split("\t");if(c){if(!y)return;let s="",i="";l.forEach((o,d)=>{switch(d){case v:{s=o;break}case x:{i=o;break}}}),!t(h,et)[s]||r?(t(h,et)[s]=i,n++):self.debugMode&&console.debug(`Voice "${i}" (${s}) seems to be in conflict with (${t(h,et)[s]}).`),p++}else l.forEach((s,i)=>{switch(s){case"ID":{v=i,y++;break}case"Name":{x=i,y++;break}default:console.debug(`Unknown map field: ${s}`)}})}),console.debug(`Voice names: ${p} total, ${n} loaded.`),h==null||h.device.forceVoiceRefresh()}async loadEfx(e,r){let h=this,n=0,p=0,y,v,x;e.split(`
`).forEach((a,c)=>{if(a)if(c){let l=0,s;a.split("\t").forEach((i,o)=>{switch(o){case y:{l|=parseInt(i,16)<<8;break}case v:{l|=parseInt(i,16);break}case x:{s=i;break}}}),!t(h,ut)[l]||r?(t(h,ut)[l]=s,n++):self.debugMode&&console.debug(`EFX ID 0x${l.toString(16).padStart(4,"0")} (${s}) seems to be in conflict.`),p++}else a.split("\t").forEach((l,s)=>{switch(l){case"MSB":{y=s;break}case"LSB":{v=s;break}case"Name":{x=s;break}default:console.debug(`Unknown EFX field: ${l}`)}})}),console.debug(`EFX: ${p} total, ${n} loaded.`),h.dispatchEvent("efxreverb",h.device.getEffectType(0)),h.dispatchEvent("efxchorus",h.device.getEffectType(1)),h.dispatchEvent("efxdelay",h.device.getEffectType(2)),h.dispatchEvent("efxinsert0",h.device.getEffectType(3)),h.dispatchEvent("efxinsert1",h.device.getEffectType(4)),h.dispatchEvent("efxinsert2",h.device.getEffectType(5)),h.dispatchEvent("efxinsert3",h.device.getEffectType(6))}switchMode(e,r=!1){this.device.switchMode(e,r)}getMode(){return this.device.getMode()}getVoice(){return this.device.getVoice(...arguments)}getChVoice(e){return this.device.getChVoice(e)}getMapped(e){return t(this,et)[e]||e}getEfx([e,r]){let h=e<<8|r;return t(this,ut)[h]||`0x${h.toString(16).padStart(4,"0")}`}getVoxBm(e){if(!e)throw new Error("Voice object must be valid");let r=this;if(!r.voxBm)throw new Error("Voice bitmap repository isn't yet initialized");let h=r.voxBm.getBm(e.name);if(!h)switch(e.mode){case"xg":{switch(e.sid[0]){case 0:case 80:case 81:case 83:case 84:case 96:case 97:case 99:case 100:{h=r.voxBm.getBm(r.getVoice(de.bank0,e.sid[1],de.bank0,e.mode).name);break}}break}case"g2":case"sd":{switch(e.sid[0]){case 96:case 97:case 98:case 99:{h=r.voxBm.getBm(r.getVoice(de.bank0,e.sid[1],de.bank0,e.mode).name);break}case 104:case 105:case 106:case 107:{h=r.voxBm.getBm(r.getVoice(120,e.sid[1],de.bank0,e.mode).name);break}}break}case"gs":case"sc":case"k11":case"sg":case"gm":{switch(e.sid[0]){case 120:break;case 122:case 127:{h=r.voxBm.getBm(r.getVoice(120,e.sid[1],0,e.mode).name);break}default:h=r.voxBm.getBm(r.getVoice(0,e.sid[1],0,e.mode).name)}break}default:switch(e.sid[0]){case 56:{h=r.voxBm.getBm(r.getVoice(0,e.sid[1],0,e.mode).name);break}}}return h||(h=r.voxBm.getBm(r.getVoice(e.sid[0],e.sid[1],0,e.mode).name)),h}getChBm(e,r){let h=this;return r=r||h.getChVoice(e),h.getVoxBm(r)}get noteProgress(){return t(this,st)/t(this,He)}get noteOverall(){return this.noteProgress-t(this,Re)}get noteBar(){return Math.floor(this.noteOverall/t(this,j))}get noteBeat(){let e=this.noteOverall%t(this,j);return e<0&&(e+=t(this,j)),e}getTimeSig(){return[t(this,j),t(this,rt)]}getTempo(){return t(this,_e)}sendCmd(e){this.device.runJson(e)}render(e){var w;e>t(this,st)&&S(this,st,e);let r=((w=t(this,je))==null?void 0:w.step(e))||[],h=0,n=new Set,p={},y=[],v=this,x=[];for(v.device.getStrength().forEach((C,M)=>{t(v,Tt)[M]=C}),v.device.newStrength(),r.forEach(function(C){let M=C.data,X=v.device.runJson(M);switch(X==null?void 0:X.reply){case"meta":{x.push(X);break}}X!=null&&X.reply&&delete X.reply});t(v,pt).length>0;){let C=t(v,pt).shift(),M=C.part<<7|C.note;C.state?(n.add(M),p[M]=C.velo):n.has(M)&&(y.push({part:C.part,note:C.note,velo:p[M],state:v.device.NOTE_SUSTAIN}),h++)}(x==null?void 0:x.length)>0&&v.dispatchEvent("meta",x);let a=v.device.getActive(),c=[],l=v.device.getPitch(),s=v.device.getCcAll(),i=v.device.getProgram(),o=v.device.getChType(),d=[],u=v.device.getStrength();u.forEach(function(C,M,X){X[M]=Math.max(t(v,Tt)[M],C);let De=X[M]-t(v,at)[M],Ge=m.length*M;if(De>=0){let At=4*.25**(s[Ge+m[73]]/64);t(v,at)[M]+=Math.ceil(De-De*v.smoothingAtk**At)}else{let At=4*.25**(s[Ge+m[72]]/64);t(v,at)[M]+=Math.floor(De-De*v.smoothingDcy**At)}});let f=0;return a.forEach(function(C,M){C&&(c[M]=v.device.getVel(M),d[M]=v.device.getExt(M),f+=c[M].size)}),{extraPoly:h,extraNotes:y,curPoly:f,chInUse:a,chKeyPr:c,chPitch:l,chProgr:i,chContr:s,chType:o,chExt:d,eventCount:r.length,title:t(v,Pe),bitmap:v.device.getBitmap(),letter:v.device.getLetter(),texts:v.device.getTexts(),master:v.device.getMaster(),mode:v.device.getMode(),strength:t(v,at).slice(),velo:u,rpn:v.device.getRpn(),tSig:v.getTimeSig(),tempo:v.getTempo(),noteBar:v.noteBar,noteBeat:v.noteBeat,ace:v.device.getAce(),rawVelo:v.device.getStrength(),rawStrength:v.device.getRawStrength(),rawPitch:v.device.getRawPitch(),efxSink:v.device.getEffectSink()}}},je=new WeakMap,et=new WeakMap,ut=new WeakMap,Pe=new WeakMap,tt=new WeakMap,pt=new WeakMap,at=new WeakMap,Tt=new WeakMap,He=new WeakMap,_e=new WeakMap,j=new WeakMap,rt=new WeakMap,Re=new WeakMap,st=new WeakMap,Ca);export{ts as RootDisplay,E as allocated,m as ccToPos,fe as dnToPos};