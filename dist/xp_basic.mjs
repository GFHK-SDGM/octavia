var ka=Object.create;var Mt=Object.defineProperty;var xa=Object.getOwnPropertyDescriptor;var Sa=Object.getOwnPropertyNames;var Ta=Object.getPrototypeOf,Ca=Object.prototype.hasOwnProperty;var Ma=(b,e,r)=>e in b?Mt(b,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):b[e]=r;var Gt=(b,e)=>()=>(b&&(e=b(b=0)),e);var Ra=(b,e)=>()=>(e||b((e={exports:{}}).exports,e),e.exports);var Da=(b,e,r,d)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Sa(e))!Ca.call(b,o)&&o!==r&&Mt(b,o,{get:()=>e[o],enumerable:!(d=xa(e,o))||d.enumerable});return b};var Oa=(b,e,r)=>(r=b!=null?ka(Ta(b)):{},Da(e||!b||!b.__esModule?Mt(r,"default",{value:b,enumerable:!0}):r,b));var D=(b,e,r)=>(Ma(b,typeof e!="symbol"?e+"":e,r),r),Xt=(b,e,r)=>{if(!e.has(b))throw TypeError("Cannot "+r)};var t=(b,e,r)=>(Xt(b,e,"read from private field"),r?r.call(b):e.get(b)),S=(b,e,r)=>{if(e.has(b))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(b):e.set(b,r)},x=(b,e,r,d)=>(Xt(b,e,"write to private field"),d?d.call(b,r):e.set(b,r),r);var Vt=Gt(()=>{"use strict";I();(function(){var b=function(v,k,a){var n,c;if(self.MessageEvent)switch(v){case"message":{c=new MessageEvent(v,{data:k,ports:a==null?void 0:a.ports}),Object.defineProperty(c,"source",{value:a==null?void 0:a.source});break}default:c=new Event(v)}else c=document.createEvent("Event"),c.initEvent(v,!1,!1),a&&v=="message"&&(c.data=k,a.source&&Object.defineProperty(c,"source",{value:a.source}),(n=a.ports)!=null&&n.length&&Object.defineProperty(c,"ports",{value:a.ports}));return c};self.BroadcastChannel?console.info("[Snowy] Snowy is disabled."):(console.info("[Snowy] Snowy is enabled. Path: ".concat(self.SNOWY_PATH||"/snowy.js")),r=[],d={},o=function(v){var k,a=this;if((this==null?void 0:this.constructor)!=o)throw new TypeError("Illegal constructor");r.push(this),(k=d[v])!=null&&k.constructor||(d[v]=[]),d[v].push(this);var n=Math.floor(Math.random()*281474976710656),c=[],i=0,s=[],f=!0,h=!1;Object.defineProperty(this,"id",{get:function(){return n}}),Object.defineProperty(this,"name",{value:v}),this.close=function(){var u,m=r.indexOf(a);m>-1?(e.postMessage({t:"d",c:v,i:n}),r.splice(m,1),(u=d[v])!=null&&u.constructor&&(m=d[v].indexOf(a),m>-1&&d[v].splice(m,1)),d[v].length||delete d[v],console.debug("[Snowy] BroadcastChannel closed."),h=!0):console.debug("[Snowy] BroadcastChannel already closed.")},this.postMessage=function(u){if(e){if(h)throw new Error("Channel already closed");e.postMessage({t:"m",c:v,i:n,m:i,d:u}),i++,i>4294967295&&(i=0)}else s.push(u),console.debug("[Snowy] Message is cached.")},this.flush=function(){if(e){if(f){for(e.postMessage({t:"r",c:v,i:n}),console.debug("[Snowy] ".concat(s.length," message(s) in cache."));s.length;){var u=s.shift();a.postMessage(u)}f=!1,console.debug("[Snowy] All cached messages are flushed away.")}}else throw new Error("Tried to flush when the ports are not ready")},this.receiveMessage=function(u){u.c==v?u.i!=n&&a.dispatchEvent(b("message",u.d,{source:a})):console.debug("[Snowy] Channel ID mismatch. Instance ".concat(n," receives from ").concat(v,", not ").concat(u.c,"."))};var l={};this.dispatchEvent=function(u){var m,w;if(Object.defineProperty(u,"target",{value:a}),Object.defineProperty(u,"currentTarget",{value:a}),(m=l[u.type])!=null&&m.length)for(var C=l[u.type],M=0;M<C.length;M++)((w=C[M])==null?void 0:w.constructor)==Function&&C[M].call(a,u);a["on".concat(u.type)]&&a["on".concat(u.type)].constructor==Function&&a["on".concat(u.type)].call(a,u)},this.addEventListener=function(u,m){var w;(w=l[u])!=null&&w.constructor||(l[u]=[]);var C=l[u].indexOf(m);C==-1&&l[u].push(m)},this.removeEventListener=function(u,m){var w,C;if((w=l[u])!=null&&w.length){var M=l[u].indexOf(m);M>-1&&l[u].splice(M,1)}!((C=l[u])!=null&&C.length)&&l[u].constructor&&delete l[u]}},self.BroadcastChannel=o,p=function(){if(e){e.addEventListener("message",function(k){var a=k.data,n=!1;switch(a.t){case"k":{n=!1,e.postMessage({t:"k"});break}case"m":{var c=d[a.c];if(c!=null&&c.length)for(var i=0;i<c.length;i++)c[i].receiveMessage(a);break}case"c":{for(var s=[],f=0;f<r.length;f++){var h=r[f].name;s.indexOf(h)<0&&s.push(h)}e.postMessage({t:"k",c:s});break}default:n=!0}n&&console.info("ReceiveBroadcast",a)});for(var v=0;v<r.length;v++)r[v].flush()}else throw new Error("Message port isn't yet ready");console.info("[Snowy] Snowy is active.")},$=function(){if(!e){var v=new SharedWorker(self.SNOWY_PATH||"/snowy.js");v.port.start();var k=function(a){a.data.t=="swc"&&(v.port.removeEventListener("message",k),e=v.port,e.postMessage({t:"k"}),p())};v.port.addEventListener("message",k)}},$());var e,r,d,o,p,$})()});var I=Gt(()=>{"use strict";Vt();{let b=function(e,r){let d=new FileReader;return new Promise((o,p)=>{switch(d.addEventListener("abort",()=>{p(new Error("Blob read aborted"))}),d.addEventListener("error",$=>{p(d.error||$.data||new Error("Blob read error"))}),d.addEventListener("load",()=>{o(d.result)}),r.toLowerCase()){case"arraybuffer":case"buffer":{d.readAsArrayBuffer(e);break}case"string":case"text":{d.readAsText(e);break}default:p(new Error(`Unknown target ${r}`))}})};Blob.prototype.arrayBuffer=Blob.prototype.arrayBuffer||function(){return b(this,"buffer")},Blob.prototype.text=Blob.prototype.text||function(){return b(this,"text")}}String.prototype.replaceAll=String.prototype.replaceAll||function(b,e){let r=0,d=16,o=this,p=[];for(;r<d&&o.lastIndexOf(b)>-1;){let $=o.lastIndexOf(b);p.unshift(o.slice($+b.length)),o=o.slice(0,$),$==0&&p.unshift(""),r++}return o.length&&p.unshift(o),p.join(e)||""},String.prototype.padStart=String.prototype.padStart||function(b,e){if(e){let r=this;for(;r.length<b;)r=`${e}${r}`;return r}},String.prototype.padEnd=String.prototype.padEnd||function(b,e){if(e){let r=this;for(;r.length<b;)r+=e;return r}}});var ga=Ra((Pr,Ut)=>{I();(function(){"use strict";let b={fatal:!0},e=[new TextDecoder("iso-8859-15",b),new TextDecoder("sjis",b),new TextDecoder("euc-jp",b),new TextDecoder("utf-8",b),new TextDecoder("utf-16",b),new TextDecoder("ascii")],r={debug:!1,parse:function(d,o){if(d instanceof Uint8Array)return r.Uint8(d);if(typeof d=="string")return r.Base64(d);if(d instanceof HTMLElement&&d.type==="file")return r.addListener(d,o);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(d,o){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(d===void 0||!(d instanceof HTMLElement)||d.tagName!=="INPUT"||d.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;o=o||function(){},d.addEventListener("change",function(p){if(!p.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let $=new FileReader;$.readAsArrayBuffer(p.target.files[0]),$.onload=function(v){o(r.Uint8(new Uint8Array(v.target.result)))}})},Base64:function(d){let o=function(v){var k="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(v=v.replace(/^.*?base64,/,""),v=String(v).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(v))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");v+="==".slice(2-(3&v.length));let a,n="",c,i,s=0;for(;s<v.length;)a=k.indexOf(v.charAt(s++))<<18|k.indexOf(v.charAt(s++))<<12|(c=k.indexOf(v.charAt(s++)))<<6|(i=k.indexOf(v.charAt(s++))),n+=c===64?String.fromCharCode(a>>16&255):i===64?String.fromCharCode(a>>16&255,a>>8&255):String.fromCharCode(a>>16&255,a>>8&255,255&a);return n}(d=String(d));var p=o.length;let $=new Uint8Array(new ArrayBuffer(p));for(let v=0;v<p;v++)$[v]=o.charCodeAt(v);return r.Uint8($)},Uint8:function($){let o={data:null,pointer:0,movePointer:function(c){return this.pointer+=c,this.pointer},readInt:function(c){if((c=Math.min(c,this.data.byteLength-this.pointer))<1)return-1;let i=0;if(1<c)for(let s=1;s<=c-1;s++)i+=this.data.getUint8(this.pointer)*Math.pow(256,c-s),this.pointer++;return i+=this.data.getUint8(this.pointer),this.pointer++,i},readStr:function(c){let i=new Uint8Array(c),s=!1,f;i.forEach((h,l)=>{i[l]=this.readInt(1)});for(let h=0;h<e.length;h++)if(!s)try{if(f=e[h].decode(i),h==0)for(let l=0;l<f.length;l++){let u=f.charCodeAt(l);if(u>191||u>127&&u<160)throw new RangeError(`Invalid code point: ${u}`)}s=!0,console.debug(`String byte sequence in ${e[h].encoding}`)}catch(l){console.debug(`SMF string ${l}`)}return f||"String byte sequence read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let c=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)c=this.readInt(1);else{let s=[];for(;128<=this.data.getUint8(this.pointer);)s.push(this.readInt(1)-128);var i=this.readInt(1);for(let f=1;f<=s.length;f++)c+=s[s.length-f]*Math.pow(128,f);c+=i}return c}};if(o.data=new DataView($.buffer,$.byteOffset,$.byteLength),o.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;o.readInt(4);let p={};p.formatType=o.readInt(2),p.tracks=o.readInt(2),p.track=[];var $=o.readInt(1),v=o.readInt(1);128<=$?(p.timeDivision=[],p.timeDivision[0]=$-128,p.timeDivision[1]=v):p.timeDivision=256*$+v;for(let c=1;c<=p.tracks;c++){p.track[c-1]={event:[]};var k,a=o.readInt(4);if(a===-1)break;if(a!==1297379947)return!1;o.readInt(4);let i=0,s=!1,f,h;for(;!s&&(i++,p.track[c-1].event[i-1]={},p.track[c-1].event[i-1].deltaTime=o.readIntVLV(),(f=o.readInt(1))!==-1);)if(128<=f?h=f:(f=h,o.movePointer(-1)),f===255){p.track[c-1].event[i-1].type=255,p.track[c-1].event[i-1].metaType=o.readInt(1);var n=o.readIntVLV();switch(p.track[c-1].event[i-1].metaType){case 47:case-1:s=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:p.track[c-1].event[i-1].data=o.readStr(n);break;case 33:case 89:case 81:p.track[c-1].event[i-1].data=o.readInt(n);break;case 84:p.track[c-1].event[i-1].data=[],p.track[c-1].event[i-1].data[0]=o.readInt(1),p.track[c-1].event[i-1].data[1]=o.readInt(1),p.track[c-1].event[i-1].data[2]=o.readInt(1),p.track[c-1].event[i-1].data[3]=o.readInt(1),p.track[c-1].event[i-1].data[4]=o.readInt(1);break;case 88:p.track[c-1].event[i-1].data=[],p.track[c-1].event[i-1].data[0]=o.readInt(1),p.track[c-1].event[i-1].data[1]=o.readInt(1),p.track[c-1].event[i-1].data[2]=o.readInt(1),p.track[c-1].event[i-1].data[3]=o.readInt(1);break;default:this.customInterpreter!==null&&(p.track[c-1].event[i-1].data=this.customInterpreter(p.track[c-1].event[i-1].metaType,o,n)),this.customInterpreter!==null&&p.track[c-1].event[i-1].data!==!1||(o.readInt(n),p.track[c-1].event[i-1].data=o.readInt(n),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((f=f.toString(16).split(""))[1]||f.unshift("0"),p.track[c-1].event[i-1].type=parseInt(f[0],16),p.track[c-1].event[i-1].channel=parseInt(f[1],16),p.track[c-1].event[i-1].type){case 15:this.customInterpreter!==null&&(p.track[c-1].event[i-1].data=this.customInterpreter(p.track[c-1].event[i-1].type,o,!1)),this.customInterpreter!==null&&p.track[c-1].event[i-1].data!==!1||(k=o.readIntVLV(),p.track[c-1].event[i-1].data=o.readInt(k),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:p.track[c-1].event[i-1].data=[],p.track[c-1].event[i-1].data[0]=o.readInt(1),p.track[c-1].event[i-1].data[1]=o.readInt(1);break;case 12:case 13:p.track[c-1].event[i-1].data=o.readInt(1);break;case-1:s=!0;break;default:if(this.customInterpreter!==null&&(p.track[c-1].event[i-1].data=this.customInterpreter(p.track[c-1].event[i-1].metaType,o,!1)),this.customInterpreter===null||p.track[c-1].event[i-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return p},customInterpreter:null};if(typeof Ut<"u")Ut.exports=r;else{let d=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;d.MidiParser=r}})()});I();I();var Z,Ft,wt=(Ft=class{constructor(){S(this,Z,{})}addEventListener(b,e){t(this,Z)[b]||(t(this,Z)[b]=[]),t(this,Z)[b].unshift(e)}removeEventListener(b,e){if(t(this,Z)[b]){let r=t(this,Z)[b].indexOf(e);r>-1&&t(this,Z)[b].splice(r,1),t(this,Z)[b].length<1&&delete t(this,Z)[b]}}dispatchEvent(b,e){var o;let r=new Event(b),d=this;r.data=e,((o=t(this,Z)[b])==null?void 0:o.length)>0&&t(this,Z)[b].forEach(function(p){try{p==null||p.call(d,r)}catch($){console.error($)}}),this[`on${b}`]&&this[`on${b}`](r)}},Z=new WeakMap,Ft);I();I();var Kt=function(b,e){let r=Math.min(b.length,e.length),d=b.slice(0,r),o=e.slice(0,r),p=0,$=0;for(;$<r&&p==0;)p=Math.sign(d[$]-o[$]),$++;return p},de=function(b=""){this.name=b,this.pool=[],this.point=function(e,r=!1){if(this.pool.length>0){let d=this.pool.length,o=1<<Math.floor(Math.log2(d)),p=o,$=64;for(;o>=1&&$>=0;){if($<=0)throw new Error("TTL reached.");if(p==d)p-=o;else{let k=Kt(e,this.pool[p]);switch(k){case 0:{$=0;break}case 1:{p+o<=d&&(p+=o);break}case-1:{p!=0&&(p-=o);break}default:console.warn(`Unexpected result ${k}.`)}}o=o>>1,$--}let v=!0;if(p>=this.pool.length)v=!1;else{let k=this;this.pool[p].forEach(function(a,n,c){v&&a!=e[n]&&(v=!1)}),!v&&Kt(e,this.pool[p])>0&&p++}return v||r?p:-1}else return r?0:-1},this.add=function(e,r){return e.data=r,this.pool.splice(this.point(e,!0),0,e),this},this.default=function(e){console.warn(`No match in "${this.name||"(unknown)"}" for "${e}". Default action not defined.`)},this.get=function(e){let r=this.point(e);if(r>-1)return this.pool[r].data;this.default(e)},this.run=function(e,...r){let d=this.point(e);d>-1?e.subarray?this.pool[d].data(e.subarray(this.pool[d].length),...r):this.pool[d].data(e.slice(this.pool[d].length),...r):this.default(e,...r)}};I();var Aa=["MSB","PRG","LSB","NME","ELC","DRM"],Rt=function(b){let e=Math.floor(b/10),r=b%10;return`${e.toString(16)}${r}`},Y,zt,Dt=(zt=class{constructor(...b){S(this,Y,void 0);D(this,"strictMode",!1);this.loadFiles(...b)}get(b=0,e=0,r=0,d){var u,m;let o=[b,e,r],p,$=1,v=0,k,a=Array.from(arguments);switch(d){case"xg":{switch(b){case 0:{r==126?a[2]=125:r==127&&(a[2]=0);break}case 16:{r==126&&(a[2]=0);break}case 32:{r>125&&(a[2]=0),a[2]+=4;break}case 33:case 34:case 35:case 36:{r>125&&(a[2]=0),a[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:a[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{r==126&&(a[2]=0);break}case 48:case 64:case 126:case 127:{r==126&&(a[2]=0);break}}break}case"gs":{b==0&&r<5?a[2]=0:b>125&&r<5&&r!=2&&(a[2]=b,a[0]=0);break}case"g2":case"sd":{b>>1==40?a[2]|=16:b>95&&b<100&&(a[2]|=16,e>>3==15&&(a[0]=96));break}case"sg":{b==8&&r==0&&(a[2]=5);break}case"s90es":{r<8?a[2]+=17:r<32?a[2]+=13:a[2]=(a[2]>>3)+19;break}case"motif":{r<8?a[2]+=28:r<32?a[2]+=13:a[2]=(a[2]>>3)+19;break}}let n=" ",c="M",i=0,s=0;switch(a[0]){case 0:{a[2]==127?c="MT-a":a[2]==126?c="MT-b":a[2]==7?c="GM-k":a[2]==5?c="SG-a":a[2]==4?c="SP-l":a[2]==0||d=="gs"&&a[2]<5?c="GM-a":(c="y",i=3);break}case 8:{d=="sg"?c="GM-s":c="r:";break}case 32:case 33:case 34:case 35:case 36:{d=="xg"&&(c=`${["AP","VL","PF","DX","AN"][b&7]}-${"abcdefgh"[r]}`);break}case 48:{c=`yM${(a[2]>>3).toString().padStart(2,"0")}`,i=1;break}case 56:{c="GM-b";break}case 61:case 120:{c="rDrm";break}case 62:{c="kDrm";break}case 63:{if(a[2]<17){let w=a[2];c=w<10?"kP:":"kC:",c+=w%10}else a[2]<34?c=["Pre1","Pre2","Pre3","Pre4","Usr1","Usr2","DrmP","DrmU","Plg1","Plg2","Plg3","Pre1","Pre2","Pre3","Pre4","Pre5","Pre6"][a[2]-17]:c="Ds";break}case 64:{c="ySFX";break}case 67:{c="DX:S";break}case 80:case 81:case 82:case 83:{c=`Prg${"UABC"[a[0]-80]}`;break}case 88:case 89:case 90:case 91:{c=`Cmb${"UABC"[a[0]-88]}`;break}case 95:{c=`${["DR","PC"][a[2]]}-d`;break}case 96:{c=a[2]==106?"AP-a":a[2]>>4==1?"SDg":"PF",a[2]>63?s=63:a[2]>>4==1&&(s=16),i=3;break}case 97:{c=a[2]>>4==1?"SDa":"VL:",i=3,a[2]>>4==1?s=16:s=112;break}case 98:{c=a[2]>>4==1?"SDb":"SG-a",i=3,s=16;break}case 99:{c=a[2]>>4==1?"SDc":"DX",a[2]>63?s=63:a[2]>>4==1&&(s=16),i=3;break}case 100:{c="AN",a[2]>63?s=63:a[2]>>4==1&&(s=16),i=3;break}case 104:case 105:case 106:case 107:{c="SDd",s=104;break}case 121:{c=`GM-${a[2]?"":"a"}`,i=3;break}case 122:{c="lDrm";break}case 126:{c="yDrS";break}case 127:{a[2]==127?c="rDrm":c="yDrm";break}default:a[0]<48?c="r:":c="M"}c.length<4&&(c+=`${[b,r,a[0],a[2]][i]-s}`.padStart(4-c.length,"0")),d=="xg"&&(b==0?a[2]<100?c=c.replace("y0","y:"):a[2]==125&&(c="y126"):b==16?(p=`Voice${((a[2]<<7)+a[1]+1).toString().padStart(3,"0")}`,n=" "):b==35&&r>>1==2&&(p=`DXCH_${(((a[2]&1)<<7)+e+1).toString().padStart(3,"0")}`,n=" "));let f=[a[0],a[1],a[2]];for(;!((p==null?void 0:p.length)>=0);)if(p=(u=t(this,Y)[a[1]||0][(a[0]<<7)+a[2]])==null?void 0:u.name,p){let w=t(this,Y)[a[1]||0][(a[0]<<7)+a[2]];$=(w==null?void 0:w.poly)||$,v=(w==null?void 0:w.type)||v,k=w==null?void 0:w.drum}else if(this.strictMode)p="",n="?";else if(a[0]==0&&a[1]==0&&a[2]==0)p="Unloaded";else if(t(this,Y)[a[1]||0][a[0]<<7])a[0]==0?(a[2]=0,n="^"):a[2]<1?(a[0]=0,n="*"):(a[2]--,n="^");else if(b==48)a[0]=0,a[2]=0,n="!";else if(b==62)a[1]--,n=" ",a[1]<1&&!(p!=null&&p.length)&&(a[0]=0,n="!");else if(b<63)a[0]==0?(a[2]=0,n="^"):a[2]<1?(a[0]=0,n="*"):a[2]--;else if(b==80)p=`PrgU:${e.toString().padStart(3,"0")}`,n="!";else if(b==88)p=`CmbU:${e.toString().padStart(3,"0")}`,n="!";else if(b==121)p=`GM2Vox0${r}`,n="#";else if(b==122){if(a[1]==32?a[1]==0:a[1]%=7,p=(m=t(this,Y)[a[1]||0][(a[0]<<7)+a[2]])==null?void 0:m.name,p){n=" ";let w=t(this,Y)[a[1]||0][(a[0]<<7)+a[2]];$=(w==null?void 0:w.poly)||$,v=(w==null?void 0:w.type)||v,k=w==null?void 0:w.drum}else p="",n="*";}else a[1]==0?(p=`${b.toString().padStart(3,"0")} ${e.toString().padStart(3,"0")} ${r.toString().padStart(3,"0")}`,n="!"):a[0]==0?(a[2]=0,n="^"):a[2]>0?a[2]--:a[1]>0?(a[1]=0,n="!"):(a[0]=0,n="?");let h=[a[0],a[1],a[2]];(d=="gs"||d=="ns5r")&&n=="^"&&(n=" "),b==127&&n=="^"&&(n=" "),n!=" "&&self.debugMode&&(p="");let l="??";switch(a[0]){case 0:{a[2]==0?l="GM":a[2]==5||a[2]==7?l="KG":a[2]<126?l="XG":a[2]==127&&(l="MT");break}case 32:case 33:case 35:case 36:{a[2]>4?l=["AP","VL","PF","DX","AN"][a[0]-32]:l="GS";break}case 48:{l="MU";break}case 56:{l="AG";break}case 61:case 80:case 83:case 88:case 89:case 91:{l="AI";break}case 62:case 82:case 90:{l="XD";break}case 63:{a[2]<17?l="KR":a[2]<34?l="ES":l="DS";break}case 64:case 126:{l="XG";break}case 67:case 99:{l=a[2]>>4==1?"SD":"DX";break}case 81:{l="RW";break}case 95:{l=["DR","PC"][a[2]];break}case 96:{l=a[2]==106?"AP":a[2]>>4==1?"SD":"PF";break}case 97:{l=a[2]>>4==1?"SD":"VL";break}case 98:{l=a[2]>>4==1?"SD":"SG";break}case 100:{l="AN";break}case 104:case 105:case 106:case 107:{l="SD";break}case 120:{l="GS";break}case 121:{l=a[2]?"G2":"GM";break}case 122:{l="KG";break}case 127:{l=a[2]==127?"MT":e==0?"GM":"XG";break}default:a[0]<48&&(a[0]==16&&d=="xg"?l="XG":l="GS")}return{name:p||`${Rt(b||0)} ${Rt(e||0)} ${Rt(r||0)}`,poly:$,type:v,drum:k,iid:f,eid:h,sid:o,ending:n,sect:c,standard:l}}async load(b,e,r="(internal)"){let d=this,o=[],p=0,$=0;b.split(`
`).forEach(function(v,k){let a=v.split("\t"),n=[];if(k==0){if(a.forEach(function(c,i){o[Aa.indexOf(c)]=i}),o.length<4){console.debug("Debugger launched.");debugger}}else{let c=0,i=0,s=0,f,h=1,l=0,u;a.forEach(async function(w,C){switch(C){case o[0]:{c=parseInt(w);break}case o[1]:{i=parseInt(w);break}case o[2]:{s=parseInt(w);break}case o[3]:{f=w;break}case o[4]:{w=parseInt(w),w<16?h=w+1:l=(w&15)+1;break}case o[5]:{u=w;break}}}),t(d,Y)[i]=t(d,Y)[i]||[];let m=t(d,Y)[i];if(!m[c<<7|s]||e){let w={msb:c,prg:i,lsb:s,name:f,poly:h,type:l,drum:u};m[c<<7|s]=w,p++}$++}}),e||console.debug(`Map "${r}": ${$} total, ${p} loaded.`)}clearRange(b){let e=b.prg!=null?b.prg.constructor==Array?b.prg:[b.prg,b.prg]:[0,127],r=b.msb!=null?b.msb.constructor==Array?b.msb:[b.msb,b.msb]:[0,127],d=b.lsb!=null?b.lsb.constructor==Array?b.lsb:[b.lsb,b.lsb]:[0,127];for(let o=r[0];o<=r[1];o++){let p=o<<7;for(let $=d[0];$<=d[1];$++){let v=p+$;for(let k=e[0];k<=e[1];k++)delete t(this,Y)[k][v]}}}init(){x(this,Y,[]);for(let b=0;b<128;b++)t(this,Y).push([""])}async loadFiles(...b){this.init();let e=this;b.forEach(async function(r){try{await fetch(`./data/bank/${r}.tsv`).then(function(d){return d.text()}).then(d=>{e.load(d,!1,r)})}catch(d){console.error(`Failed loading "${r}.tsv".`)}})}},Y=new WeakMap,zt);I();I();var Je,qt,Qt=(qt=class{constructor(){S(this,Je,{});D(this,"context")}set(b,e){t(this,Je)[b]=e}has(b){return!!t(this,Je)[b]}async read(b,e){if(!this.has(b))throw new Error(`No decoder registered for "${b}"`);return await t(this,Je)[b].call(this.context||this,e)}},Je=new WeakMap,qt);var La=function(b,e){let r=!0;return e.forEach((d,o)=>{r=r&&b[o]==d}),r},Yt=function(b){let e=0;return b.forEach(r=>{e*=256,e+=r}),e},dt=new TextDecoder,kt=new Qt;kt.set("s7e",async function(b){let e=new Uint8Array(await b.slice(0,65536).arrayBuffer()),r="MSB\tLSB\tPRG\tNME",d=[0,0,0,0],o=32,p=0,$=0,v=!0,k=[],a=0;for(;v;){let n=e.subarray(p);([()=>{dt.decode(n.subarray(0,4))=="YSFC"?(p+=80,$=1):p++},()=>{if(La(n.subarray(0,4),d))k.forEach((c,i,s)=>{let f=Yt(e.subarray(c.start+4,c.start+8));c.length=f}),$=2;else{let c=dt.decode(n.subarray(0,4)),i=Yt(n.subarray(4,8));k.push({type:c,start:i}),p+=8}},()=>{let c=k[a],i=e.subarray(c.start,c.start+c.length),s=32;switch(c.type){case"ENVC":{let f=o;for(;f<i.length;){let h=i.subarray(f,f+s),l=dt.decode(h.subarray(0,10)).trimEnd();l.slice(0,5)=="Init "&&(l=""),l&&(r+=`
063	${(h[17]+13).toString().padStart(3,"0")}	${h[19].toString().padStart(3,"0")}	${l}`),f+=s}break}case"EDVC":{let f=o;for(;f<i.length;){let h=i.subarray(f,f+s),l=dt.decode(h.subarray(0,10)).trimEnd();l.slice(0,5)=="Init "&&(l=""),l&&(r+=`
063	024	${h[19].toString().padStart(3,"0")}	${l}`),f+=s}break}case"EPVC":{let f=32,h=o;for(;h<i.length;){let l=i.subarray(h,h+f),u=dt.decode(l.subarray(0,10)).trimEnd();u=="----------"&&(u=""),u&&(r+=`
063	${(l[17]+1).toString().padStart(3,"0")}	${l[19].toString().padStart(3,"0")}	${u}`),h+=f}break}}a++,a>=k.length&&($=3,v=!1)}][$]||(()=>{v=!1}))()}return r});I();var ft=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]),ht=["melodic","drums","drum set 1","drum set 2","drum set 3","drum set 4","drum set 5","drum set 6","drum set 7","drum set 8"],Ia=[17.1,18.6,20.2,21.8,23.3,24.9,26.5,28,29.6,31.2,32.8,34.3,35.9,37.5,39,40.6,42.2,43.7,45.3,46.9,48.4,50],et=[20,22,25,28,32,36,40,45,50,56,63,70,80,90,100,110,125,140,160,180,200,225,250,280,315,355,400,450,500,560,630,700,800,900,1e3,1100,1200,1400,1600,1800,2e3,2200,2500,2800,3200,3600,4e3,4500,5e3,5600,6300,7e3,8e3,9e3,1e4,11e3,12e3,14e3,16e3,18e3,2e4],Wt=[0,.04,.08,.13,.17,.21,.25,.29,.34,.38,.42,.46,.51,.55,.59,.63,.67,.72,.76,.8,.84,.88,.93,.97,1.01,1.05,1.09,1.14,1.18,1.22,1.26,1.3,1.35,1.39,1.43,1.47,1.51,1.56,1.6,1.64,1.68,1.72,1.77,1.81,1.85,1.89,1.94,1.98,2.02,2.06,2.1,2.15,2.19,2.23,2.27,2.31,2.36,2.4,2.44,2.48,2.52,2.57,2.61,2.65,2.69,2.78,2.86,2.94,3.03,3.11,3.2,3.28,3.37,3.45,3.53,3.62,3.7,3.87,4.04,4.21,4,37,4.54,4.71,4.88,5.05,5.22,5.38,5.55,5.72,6.06,6.39,6.73,7.07,7.4,7.74,8.08,8.41,8.75,9.08,9.42,9.76,10.1,10.8,11.4,12.1,12.8,13.5,14.1,14.8,15.5,16.2,16.8,17.5,18.2,19.5,20.9,22.2,23.6,24.9,26.2,27.6,28.9,30.3,31.6,33,34.3,37,39.7],jt=function(b){let e=.1,r=-.3;return b>66?(e=5,r=315):b>56?(e=1,r=47):b>46&&(e=.5,r=18.5),e*b-r},Zt=function(b){return b>105?Ia[b-106]:b>100?b*1.1-100:b/10},Jt=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),Ot={};`hi*,
ka,か
ki,き
ku,く
ke,け
ko,こ
ky,き!
kw,くl
tsu,つ
ts,つl
sa,さ
si,すぃ
su,す
se,せ
so,そ
shi,し
sh,し!
ta,た
ti,てぃ
tu,とぅ
te,て
to,と
tchy,ち!
tchi,ち
na,な
ni,に
nu,ぬ
ne,ね
no,の
ny,に!
nn,ん
ha,は
hi,ひ
hu,ほぅ
he,へ
ho,ほ
hy,ひ!
fa,ふぁ
fi,ふぃ
fu,ふ
fe,ふぇ
fo,ふぉ
ma,ま
mi,み
mu,む
me,め
mo,も
my,み!
mm,
ra,ら
ri,り
ru,る
re,れ
ro,ろ
ry,り!
wa,わ
wi,うぃ
we,うぇ
wo,を
nga,ガ
ngi,ギ
ngu,グ
nge,ゲ
ngo,ゴ
ngy,ギ!
ng,
ga,が
gi,ぎ
gu,ぐ
ge,げ
go,ご
gy,ぎ!
gw,ぐl
za,ざ
zi,ずぃ
zu,ず
ze,ぜ
zo,ぞ
ja,じゃ
ji,じ
ju,じゅ
je,じぇ
jo,じょ
jy,じ!
da,だ
di,でぃ
du,どぅ
de,で
do,ど
dy,で!
ba,ば
bi,び
bu,ぶ
be,べ
bo,ぼ
by,び!
va,ゔぁ
vi,ゔぃ
vu,ゔ
ve,ゔぇ
vo,ゔぉ
pa,ぱ
pi,ぴ
pu,ぷ
pe,ペ
po,ぽ
py,ぴ!
!ya,ゃ
!yu,ゅ
!ye,ぇ
!yo,ょ
ya,や
yu,ゆ
ye,いぇ
yo,よ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
la,ぁ
li,ぃ
lu,ぅ
le,ぇ
lo,ぉ
a,あ
i,い
u,う
e,え
o,お
*,っ
~,
^,
_,`.split(`
`).forEach(b=>{let e=b.split(",");Ot[e[0]]=e[1]});var ea=function(b){let e=b;b[0]=="*"&&(e=e.slice(1)),["aa","ii","uu","ee","oo"].forEach(d=>{for(;e.indexOf(d)>-1;)e=e.replace(d,d[0])});for(let d in Ot)e=e.replaceAll(d,Ot[d]);e.indexOf("\u3093")==0&&e.length>1&&(e=e.slice(1));let r=e.indexOf("!");return r>-1&&e.length>1&&(e=e.slice(r+1)),e},ta=function(b){return b?b<96?`cc${b}`:["aftertouch","velocity","pitch bend"][b-96]:"off"};I();var At=["room 1","room 2","room 3","hall 1","hall 2","plate","delay","panning delay"],aa=["chorus 1","chorus 2","chorus 3","chorus 4","feedback","flanger","short delay","short delay feedback"],ra=["delay 1","delay 2","delay 3","delay 4","pan delay 1","pan delay 2","pan delay 3","pan delay 4","delay to reverb","pan repeat"];var Pa={0:"thru",256:"stereo EQ",257:"spectrum",258:"enhancer",259:"humanizer",272:"overdrive",273:"distortion",288:"phaser",289:"auto wah",290:"rotary",291:"stereo flanger",292:"step flanger",293:"tremelo",294:"auto pan",304:"compressor",305:"limiter",320:"hexa chorus",321:"tremelo chorus",322:"stereo chorus",323:"space D",324:"3D chorus",336:"stereo delay",337:"modulated delay",338:"3-tap delay",339:"4-tap delay",340:"tremelo control delay",341:"reverb",342:"gate reverb",343:"3D delay",352:"2-pitch shifter",353:"feedback pitch shifter",368:"3D auto",369:"3D manual",370:"Lo-Fi 1",371:"Lo-Fi 2",512:"overdrive - chorus",513:"overdrive - flanger",514:"overdrive - delay",515:"distortion - chorus",516:"distortion - flanger",517:"distortion - delay",518:"enhancer - chorus",519:"enhancer - flanger",520:"enhancer - delay",521:"chorus - delay",522:"flanger - delay",523:"chorus - flanger",524:"rotary multi",1024:"guitar multi 1",1025:"guitar multi 2",1026:"guitar multi 3",1027:"clean guitar multi 1",1028:"clean guitar multi 2",1029:"bass multi",1030:"rhodes multi",1280:"keyboard multi",4352:"chorus / delay",4353:"flanger / delay",4354:"chorus / flanger",4355:"overdrive / distortion",4356:"overdrive / rotary",4357:"overdrive / phaser",4358:"overdrive / auto wah",4359:"phaser / rotary",4360:"phaser / auto wah"},Ua={66307:["drive"],66309:["vowel",b=>"aiueo"[b]],94723:["pre-filter"],94724:["Lo-Fi type"],94725:["post-filter"],94979:["Lo-Fi type"],94980:["fill type",b=>["off","LPF","HPF"][b]],94984:["noise type",b=>["white","pink"][b]],94987:["disc type",b=>["LP","SP","EP","RND"]],94990:["hum type",b=>`${b+5}0Hz`],94993:["M/S",b=>["mono","stereo"][b]]},Lt=function(b){return Pa[(b[0]-32<<8)+b[1]]||`0x${b[0].toString(16).padStart(2,"0")}${b[1].toString(16).padStart(2,"0")}`},sa=function(b,e,r){let d=(b[0]-32<<16)+(b[1]<<8)+e,o=Ua[d]||{},p=o[0];if(p!=null&&p.length)return p+=`: ${(o[1]||function(){})(r)||r}`,p},It=[68,48,95,78,41,3,110,122,0];I();var J=function(b=64){return Math.round(2e3*Math.log10(b/64))/100},ia=function(b,e,r){let d=[],o=r==!1?e.readIntVLV():r;b==0||b==127;for(let p=0;p<o;p++){let $=e.readInt(1);if(d.push($),$!=247){if($!=240){if($>127)return console.debug(`Early termination: ${d}`),d.pop(),e.backOne(),e.backOne(),new Uint8Array(d)}}}return new Uint8Array(d)},Te=function(b){let e=0;return b.forEach(r=>{e+=r,e=e&127}),~e+1&127},pe=function(b,e){let r=0,d=0;for(let o=0;o<b.length;o++){let p=o%8-1,$=(d>>p&1)<<7,v=b[o];v+=$,o%8!=0?(e(v,r,b),r++):d=b[o]}};var ut=function(b){let e=Math.floor(b*14.2);return e<128?e:0};var be=["?","gm","gs","xg","g2","mt32","ns5r","x5d","05rw","sd","k11","sg","krs","s90es","motif"],Ba={gm2:"g2","mt-32":"mt32","c/m":"mt32",ag10:"05rw","ag-10":"05rw","05r/w":"05rw",x5:"05rw",x5dr:"x5d",gmega:"k11","kross 2":"krs","motif es":"motif","s90 es":"s90es"},Na=["melodic","drum","menu"],na=[[0,0,0,0,121,0,0,82,81,97,0,0,63,63,63],[0,0,4,0,0,127,0,0,0,0,0,0,0,0,0]],Pe=[120,127,120,127,120,127,61,62,62,105,122,122,120,127,127],Ha=[0,3,81,84,88],ca={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},oa={0:0,1:1,2:3,5:4},la={0:0,1:1,2:2,5:3},da=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],fa=[36,37,48,49,52,53],Tt=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65],ha={26:127,29:0,30:0,31:0,52:12,53:54},bt=[0,1,2,4,5,6,7,8,10,11,32,38,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,84,91,92,93,94,95,98,99,100,101,128,12,13,16,17,18,19,14,15,20,21,26,28,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],_a=[2,12,13,14,15,16,17,18,19,20,21,136,130,131,132,133,134,135,137,138,139,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],Ga=[33,99,100,32,102,8,9,10],ua=[0,16,25,40,32,64,26,48],T={};be.forEach((b,e)=>{T[b]=e});var y={length:bt.length};bt.forEach((b,e)=>{y[b]=e});var ne={length:Tt.length};Tt.forEach((b,e)=>{ne[b]=e});var Xa={};Na.forEach((b,e)=>{Xa[b]=e});var A=function(){return!!self.Bun||self.debugMode||!1},Va=function(b){let e=[],r=0;return b==null||b.forEach(function(d,o){d==247?e.push(b.subarray(r,o)):d==240&&(r=o+1)}),e.length||e.push(b.subarray(0)),A()&&console.debug(e),e};var E={ch:128,cc:bt.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,rpnt:4,ace:8,drm:8,dpn:Tt.length,dnc:128,ext:2,efx:7,cvn:12,redir:32},pt={bank0:128},P,W,ge,ve,ie,Ee,ba,me,K,O,g,ce,U,V,ee,F,z,$e,ye,Ue,te,R,L,tt,j,ae,at,Be,fe,gt,Ce,he,rt,Me,Re,oe,_,B,Ne,st,it,De,Oe,yt,nt,ue,N,xt,Et,He,Pt,re,we,Ae,q,_e,X,vt,St,Ge,Xe,se,le,ke,Ve,Fe,Ke,pa,Dr=(pa=class extends wt{constructor(){super();S(this,ie);D(this,"NOTE_IDLE",0);D(this,"NOTE_ATTACK",1);D(this,"NOTE_DECAY",2);D(this,"NOTE_SUSTAIN",3);D(this,"NOTE_HELD",4);D(this,"NOTE_RELEASE",5);D(this,"NOTE_SOSTENUTO_ATTACK",8);D(this,"NOTE_SOSTENUTO_DECAY",9);D(this,"NOTE_SOSTENUTO_SUSTAIN",10);D(this,"NOTE_SOSTENUTO_HELD",11);D(this,"CH_MELODIC",0);D(this,"CH_DRUMS",1);D(this,"CH_DRUM1",2);D(this,"CH_DRUM2",3);D(this,"CH_DRUM3",4);D(this,"CH_DRUM4",5);D(this,"CH_DRUM5",6);D(this,"CH_DRUM6",7);D(this,"CH_DRUM7",8);D(this,"CH_DRUM8",9);D(this,"EXT_NONE",0);D(this,"EXT_VL",1);D(this,"EXT_DX",3);D(this,"VLBC_BRTHEXPR",1);D(this,"VLBC_VELOINIT",2);D(this,"VLBC_VELOALL",3);S(this,P,0);S(this,W,0);S(this,ge,0);S(this,ve,new Array(11));S(this,me,new Uint8Array(E.ch));S(this,K,new Uint8Array(E.ch));S(this,O,new Uint8Array(E.ch));S(this,g,new Uint8Array(E.ch*E.cc));S(this,ce,new Uint8Array(E.ace));S(this,U,new Uint8Array(E.ch));S(this,V,new Uint8Array(E.ch*E.nn));S(this,ee,new Uint8Array(E.ch));S(this,F,new Uint16Array(E.pl));S(this,z,new Uint8Array(E.pl));S(this,$e,new Int16Array(E.ch));S(this,ye,new Uint8Array(E.ch));S(this,Ue,0);S(this,te,new Uint8Array(E.ch*E.ext));S(this,R,new Uint8Array(E.ch*E.rpn));S(this,L,new Uint8Array(E.ch*E.rpnt));S(this,tt,new Int8Array(E.ch*fa.length));S(this,j,new Uint8Array(E.drm*E.dpn*E.dnc));S(this,ae,new Uint8Array(E.efx*3));S(this,at,new Uint8Array(E.ch));S(this,Be,new Uint8Array(E.ch*E.redir));S(this,fe,new Uint8Array(E.ch));S(this,gt,new Uint8Array(E.ch*E.cvn));S(this,Ce,new Uint8Array(128));S(this,he,new Uint8Array(E.cmt*8));S(this,rt,new Uint8Array(1024));S(this,Me,new Uint8Array(E.cmt*64));S(this,Re,0);S(this,oe,0);S(this,_,void 0);S(this,B,100);S(this,Ne,0);S(this,st,500);S(this,it,0);S(this,De,"");S(this,Oe,0);S(this,yt,0);S(this,nt,0);S(this,ue,!0);S(this,N,!1);S(this,xt,1);S(this,Et,void 0);S(this,He,new Array(E.ch));S(this,Pt,new Uint8Array(2));S(this,re,[]);S(this,we,new Uint8Array(E.ch));S(this,Ae,new Uint8Array(E.tr));D(this,"baseBank",new Dt("gm","gm2","xg","gs","ns5r","sd","gmega","plg-150vl","plg-150pf","plg-150dx","plg-150an","plg-150dr","plg-100sg","krs","s90es"));D(this,"userBank",new Dt("gm"));D(this,"initOnReset",!1);D(this,"aiEfxName","");S(this,q,[]);S(this,_e,void 0);S(this,X,{nOff:(e,r)=>{let d=e*128+r,o=t(this,F).lastIndexOf(d);if(o>-1)if(t(this,g)[E.cc*e+y[64]]>63)t(this,z)[o]=this.NOTE_HELD,this.dispatchEvent("note",{part:e,note:r,velo:t(this,V)[d],state:this.NOTE_HELD});else if(t(this,g)[E.cc*e+y[66]]>63&&t(this,z)[o]==this.NOTE_SOSTENUTO_SUSTAIN)t(this,z)[o]=this.NOTE_SOSTENUTO_HELD,this.dispatchEvent("note",{part:e,note:r,velo:t(this,V)[d],state:this.NOTE_SOSTENUTO_HELD});else{t(this,F)[o]=0,t(this,V)[d]=0,t(this,z)[o]=this.NOTE_IDLE;let p=this.getExt(e)[1];(p==this.VLBC_VELOINIT||p==this.VLBC_VELOALL)&&(t(this,g)[E.cc*e+y[129]]=0),this.dispatchEvent("note",{part:e,note:r,velo:0,state:this.NOTE_IDLE})}},nOn:(e,r,d)=>{let o=e*128+r,p=0;for(t(this,ee)[e]&&t(this,X).ano(e);t(this,z)[p]>0&&t(this,F)[p]!=o;)p++;if(p<E.pl){t(this,F)[p]=o,t(this,V)[o]=d,t(this,z)[p]=this.NOTE_SUSTAIN,t(this,ye)[e]<d&&(t(this,ye)[e]=d);let $=this.getExt(e)[1];($==this.VLBC_VELOINIT||$==this.VLBC_VELOALL)&&(t(this,g)[E.cc*e+y[129]]=d),this.dispatchEvent("note",{part:e,note:r,velo:d,state:this.NOTE_SUSTAIN})}else console.error("Polyphony exceeded.")},nAt:(e,r,d)=>{},cAt:(e,r)=>{},hoOf:e=>{t(this,z).forEach((r,d)=>{if(r==this.NOTE_HELD){let o=t(this,F)[d],p=o>>7;e==p&&(t(this,z)[d]=this.NOTE_IDLE,t(this,F)[d]=0,t(this,V)[o]=0,this.dispatchEvent("note",{part:e,note:o&127,velo:0,state:this.NOTE_IDLE}))}})},soOn:e=>{t(this,z).forEach((r,d)=>{let o;switch(r){case this.NOTE_ATTACK:{o=this.NOTE_SOSTENUTO_ATTACK;break}case this.NOTE_DECAY:{o=this.NOTE_SOSTENUTO_DECAY;break}case this.NOTE_SUSTAIN:{o=this.NOTE_SOSTENUTO_SUSTAIN;break}}if(o){t(this,z)[d]=o;let p=t(this,F)[d];this.dispatchEvent("note",{part:e,note:p&127,velo:t(this,V)[p],state:o})}})},soOf:e=>{t(this,z).forEach((r,d)=>{if(r==this.NOTE_SOSTENUTO_HELD){let o=t(this,F)[d],p=o>>7;e==p&&(t(this,z)[d]=this.NOTE_IDLE,t(this,F)[d]=0,t(this,V)[o]=0,this.dispatchEvent("note",{part:e,note:o&127,velo:0,state:this.NOTE_IDLE}))}})},ano:e=>{t(this,F).forEach((r,d,o)=>{let p=r>>7,$=r&127;r==0&&t(this,V)[0]==0||p==e&&t(this,X).nOff(p,$)})}});S(this,vt,{8:function(e){let r=e.channel,d=e.data[0];t(this,X).nOff(r,d)},9:function(e){let r=e.channel;this.setChActive(r,1);let d=e.data[0],o=e.data[1];o>0?t(this,X).nOn(r,d,o):t(this,X).nOff(r,d)},10:function(e){let r=e.channel,d=r*128+e.data[0];t(this,F).indexOf(d)>-1&&(t(this,V)[d]=data[1],this.getExt(r)[1]==this.VLBC_VELOALL&&(t(this,g)[E.cc*r+y[129]]=data[1]),this.dispatchEvent("note",{part:r,note:e.data[0],velo:e.data[1],state:this.NOTE_SUSTAIN}))},11:function(e){let r=e.channel,d=t(this,He)[r],o=d[e.data[0]];o&&(e.data[0]=o),[0,32].indexOf(e.data[0])>-1&&(()=>{switch(t(this,P)){case T.s90es:case T.motif:{if(e.data[0]==0){[0,63].indexOf(e.data[1])>-1&&this.setChActive(r,1);break}e.data[1]&&this.setChActive(r,1);break}default:{this.setChActive(r,1);break}}})();let p=r*E.cc,$=r*E.ext;switch(e.data[0]){case 96:return;case 97:return;case 120:return;case 121:{t(this,X).ano(r),t(this,$e)[r]=0,t(this,g)[p+y[1]]=0,t(this,g)[p+y[5]]=0,t(this,g)[p+y[64]]=0,t(this,g)[p+y[65]]=0,t(this,g)[p+y[66]]=0,t(this,g)[p+y[67]]=0,t(this,g)[p+y[11]]=127,t(this,g)[p+y[101]]=127,t(this,g)[p+y[100]]=127,t(this,g)[p+y[99]]=127,t(this,g)[p+y[98]]=127;return}case 123:{t(this,X).ano(r);return}case 124:{t(this,X).ano(r);return}case 125:{t(this,X).ano(r);return}case 126:{t(this,ee)[r]=1,t(this,X).ano(r);return}case 127:{t(this,ee)[r]=0,t(this,X).ano(r);return}}if(y[e.data[0]]==null)console.warn(`cc${e.data[0]} is not accepted.`);else{switch(_a.indexOf(e.data[0])>-1&&this.allocateAce(e.data[0]),e.data[0]){case 0:{switch(A()&&console.debug(`${be[t(this,P)]}, CH${r+1}: ${e.data[1]}`),t(this,P)==0?e.data[1]<48?(t(this,O)[r]>0&&(e.data[1]=t(this,g)[p],e.data[1]=120,console.debug(`Forced channel ${r+1} to stay drums.`)),e.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${e.data[1]}`),this.switchMode("gs"))):e.data[1]==62?this.switchMode(t(this,_).x5==82?"x5d":"05rw"):e.data[1]==63?this.switchMode(this.modeIdx[t(this,_).ds]):(e.data[1]==64||e.data[1]==127)&&this.switchMode("xg"):t(this,P)==T.gs?e.data[1]<56&&t(this,O)[r]>0&&(e.data[1]=t(this,g)[p],e.data[1]=120,console.debug(`Forced channel ${r+1} to stay drums.`)):t(this,P)==T.gm&&(e.data[1]<48?t(this,O)[r]>0&&(e.data[1]=120,this.switchMode("gs",!0),console.debug(`Forced channel ${r+1} to stay drums.`)):(e.data[1]==64||e.data[1]==127)&&this.switchMode("xg",!0)),t(this,P)){case T.xg:{[79,95,126,127].indexOf(e.data[1])>-1?t(this,O)[r]==0&&(this.setChType(r,this.CH_DRUM2),console.debug(`CH${r+1} set to drums by MSB.`)):t(this,O)[r]>0&&(this.setChType(r,this.CH_MELODIC),console.debug(`CH${r+1} set to melodic by MSB.`)),[33,81,97].indexOf(e.data[1])>-1?t(this,te)[$]=this.EXT_VL:[35,67,83,99].indexOf(e.data[1])>-1?t(this,te)[$]=this.EXT_DX:t(this,te)[$]=this.EXT_NONE;break}case T["05rw"]:case T.x5d:case T.ns5r:{[61,62,126,127].indexOf(e.data[1])>-1?t(this,O)[r]==this.CH_MELODIC&&(this.setChType(r,this.CH_DRUM2),console.debug(`CH${r+1} set to drums by MSB.`)):[80,81,82,83].indexOf(e.data[1])>-1||t(this,O)[r]!=this.CH_MELODIC&&(this.setChType(r,this.CH_MELODIC),console.debug(`CH${r+1} set to melodic by MSB.`));break}case T.sd:{[104,105,106,107].indexOf(e.data[1])>-1?t(this,O)[r]==0&&(this.setChType(r,this.CH_DRUM2),console.debug(`CH${r+1} set to drums by MSB.`)):t(this,O)[r]>0&&(this.setChType(r,this.CH_MELODIC),console.debug(`CH${r+1} set to melodic by MSB.`));break}case T.g2:{e.data[1]==120?t(this,O)[r]==0&&(this.setChType(r,this.CH_DRUMS),console.debug(`CH${r+1} set to drums by MSB.`)):t(this,O)[r]>0&&(this.setChType(r,this.CH_MELODIC),console.debug(`CH${r+1} set to melodic by MSB.`));break}}this.dispatchEvent("voice",{part:r});break}case 2:{this.getExt(r)[1]==this.VLBC_BRTHEXPR&&(t(this,g)[p+y[129]]=e.data[1]);break}case 6:{if(t(this,Ue)){[T.xg,T.gs,T.ns5r].indexOf(t(this,P))<0&&console.warn(`NRPN commits are not available under "${be[t(this,P)]}" mode, even when they are supported in Octavia.`);let v=t(this,g)[p+y[99]],k=t(this,g)[p+y[98]];if(v==1){let a=Ga.indexOf(k);if(a>-1)t(this,g)[p+y[71+a]]=e.data[1],A()&&console.debug(`Redirected NRPN 1 ${k} to cc${71+a}.`),this.dispatchEvent("cc",{part:r,cc:71+a,data:e.data[1]});else{let n=fa.indexOf(k);n>-1?t(this,tt)[r*10+n]=e.data[1]-64:console.warn(`NRPN 0x01${k.toString(16).padStart(2,"0")} is not supported.`),A()&&console.debug(`CH${r+1} voice NRPN ${k} commit`)}}else{if(Tt.indexOf(v)<0){let n=`NRPN 0x${v.toString(16).padStart(2,"0")}${k.toString(16).padStart(2,"0")} `;v==127?console.warn(`${n}is not necessary. Consider removing it.`):console.warn(`${n}is not supported.`)}else{let n=t(this,O)[r]-2;n<0?console.warn(`CH${r+1} cannot accept drum NRPN as type ${ht[t(this,O)[r]]}.`):t(this,j)[(n*E.dpn+ne[v])*E.dnc+k]=e.data[1]}A()&&console.debug(`CH${r+1} (${ht[t(this,O)[r]]}) drum NRPN ${v} commit`)}}else{let v=oa[t(this,g)[p+y[100]]],k=la[t(this,g)[p+y[100]]];t(this,g)[p+y[101]]==0&&v!=null&&(A()&&console.debug(`CH${r+1} RPN 0 ${t(this,g)[p+y[100]]} commit: ${e.data[1]}`),e.data[1]=Math.min(Math.max(e.data[1],da[v][0]),da[v][1]),t(this,R)[r*E.rpn+v]=e.data[1],t(this,L)[r*E.rpnt+k]=1)}break}case 32:{switch(A()&&console.debug(`${be[t(this,P)]}, CH${r+1} LSB: ${e.data[1]}`),t(this,P)){case T.s90es:case T.motif:{this.setChType(r,[32,40].indexOf(e.data[1])>-1?this.CH_DRUMS:this.CH_MELODIC,t(this,P),!0);break}}this.getExt(r)[0]==this.EXT_DX,this.dispatchEvent("voice",{part:r});break}case 38:{if(!t(this,Ue)){let v=oa[t(this,g)[p+100]],k=la[t(this,g)[p+100]];t(this,g)[p+101]==0&&v!=null&&(t(this,R)[r*E.rpn+v+1]=e.data[1],t(this,L)[r*E.rpnt+k]=1)}break}case 64:{e.data[1]<64&&t(this,X).hoOf(r);break}case 66:{e.data[1]>>6?t(this,X).soOn(r):t(this,X).soOf(r);break}case 98:case 99:{x(this,Ue,1);break}case 100:case 101:{x(this,Ue,0);break}}t(this,g)[p+y[e.data[0]]]=e.data[1],this.dispatchEvent("cc",{part:r,cc:e.data[0],data:e.data[1]})}},12:function(e){let r=e.channel;switch(t(this,P)){case T.s90es:case T.motif:{e.data&&this.setChActive(r,1);break}default:this.setChActive(r,1)}if(this.getExt(r)[0]==this.EXT_DX){let d=E.cc*r}t(this,U)[r]=e.data,t(this,fe)[r]=0,A()&&console.debug(`T:${e.track} C:${r} P:${e.data}`),this.dispatchEvent("voice",{part:r})},13:function(e){let r=this,d=e.channel;t(this,F).forEach(function(o){let p=o>>7;d==p&&(t(r,V)[o]=e.data,r.dispatchEvent("note",{part:d,note:o&127,velo:e.data,state:r.NOTE_SUSTAIN}))})},14:function(e){let r=e.channel;t(this,$e)[r]=e.data[1]*128+e.data[0]-8192,this.dispatchEvent("pitch",{part:r,pitch:this.getPitchShift(r)})},15:function(e){Va(e.data).forEach(r=>{let d=r[0],o=r[1];(t(this,St)[d]||function(){console.debug(`Unknown manufacturer ${d}.`)})(o,r.subarray(2),e.track)})},248:function(e){},250:function(e){},251:function(e){},252:function(e){},254:function(e){},255:function(e){(t(this,q)[e.meta]||function(d,o,p){}).call(this,e.data,e.track,e.meta),e.meta!=32&&x(this,Ne,0);let r=Ha.indexOf(e.meta)>-1;if(A()&&console.debug(e),r)return e.reply="meta",e}});S(this,St,{64:(e,r,d)=>{t(this,Ve).run(r,d,e)},65:(e,r,d)=>{if(r[0]<16){if(r[1]==72){let o=r[r.length-1],p=Te(r.subarray(3,r.length-1));o==p?t(this,le).run(r.subarray(0,r.length-1),d,e):console.warn(`Bad SD checksum ${o} - should be ${p}.`)}else t(this,le).run(r,d,e);}else{let o=r[r.length-1],p=Te(r.subarray(2,r.length-1));o==p?t(this,le).run(r.subarray(0,r.length-1),d,e):console.warn(`Bad GS checksum ${o} - should be ${p}.`)}},66:(e,r,d)=>{t(this,ke).run(r,d,e)},67:(e,r,d)=>{t(this,se).run(r,d,e)},68:(e,r,d)=>{t(this,Ke).run(r,d,e)},71:(e,r,d)=>{t(this,Fe).run(r,d,e)},126:(e,r,d)=>{t(this,Ge).run(r,d,e)},127:(e,r,d)=>{this.switchMode("gm"),t(this,Xe).run(r,d,e)}});S(this,Ge,void 0);S(this,Xe,void 0);S(this,se,void 0);S(this,le,void 0);S(this,ke,void 0);S(this,Ve,void 0);S(this,Fe,void 0);S(this,Ke,void 0);let e=this;x(e,ie,new Uint8Array(256),ba),t(e,ve)[10]=new Uint8Array(512),x(e,_e,new de),x(e,_,{x5:82,ds:T.krs}),e.userBank.strictMode=!0,e.userBank.load(`MSB	PRG	LSB	NME
062	000	000	
122	000	000	
122	001	000	
122	002	000	
122	003	000	
122	004	000	
122	005	000	
122	006	000	`),e.addEventListener("metacommit",function(a){var c,i;let{data:n}=a;((c=t(e,re)[0])==null?void 0:c.type)==n.type&&(i=t(e,re)[0])!=null&&i.amend?(t(e,re)[0].amend=n.amend,t(e,re)[0].data+=n.data):t(e,re).unshift(n)}),t(e,q)[1]=function(a){var n,c,i,s,f;switch(a=a.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),a.slice(0,2)){case"@I":{x(this,N,!0),this.dispatchEvent("metacommit",{type:"Kar.Info",data:(n=a.slice(2))==null?void 0:n.trimLeft()});break}case"@K":{x(this,N,!0),this.dispatchEvent("metacommit",{type:"Kar.Mode",data:(c=a.slice(2))==null?void 0:c.trimLeft()}),console.debug(`Karaoke mode active: ${a.slice(2)}`);break}case"@L":{x(this,N,!0),this.dispatchEvent("metacommit",{type:"Kar.Lang",data:(i=a.slice(2))==null?void 0:i.trimLeft()});break}case"@T":{x(this,N,!0),this.dispatchEvent("metacommit",{type:"KarTitle",data:(s=a.slice(2))==null?void 0:s.trimLeft()});break}case"@V":{x(this,N,!0),this.dispatchEvent("metacommit",{type:"Kar.Ver.",data:(f=a.slice(2))==null?void 0:f.trimLeft()});break}case"XF":{let h=a.slice(2).split(":");switch(h[0]){case"hd":{h.slice(1).forEach((l,u)=>{l.length&&this.dispatchEvent("metacommit",{type:["XfSngDte","XfSngRgn","XfSngCat","XfSongBt","XfSngIns","XfSngVoc","XfSngCmp","XfSngLrc","XfSngArr","XfSngPer","XfSngPrg","XfSngTag"][u],data:l})});break}case"ln":{h.slice(1).forEach((l,u)=>{l.length&&this.dispatchEvent("metacommit",{type:["XfKarLng","XfKarNme","XfKarCmp","XfKarLrc","XfKarArr","XfKarPer","XfKarPrg"][u],data:l})});break}default:this.dispatchEvent("metacommit",{type:"XfUnData",data:a})}break}default:t(this,N)?a[0]=="\\"?(this.dispatchEvent("metacommit",{type:"KarLyric",data:"",amend:!1}),this.dispatchEvent("metacommit",{type:"KarLyric",data:a.slice(1),amend:!0})):a[0]=="/"?(this.dispatchEvent("metacommit",{type:"KarLyric",data:"",mask:!0,amend:!1}),this.dispatchEvent("metacommit",{type:"KarLyric",data:a.slice(1),mask:!0,amend:!0})):this.dispatchEvent("metacommit",{type:"KarLyric",data:a,amend:!0}):a.split(`
`).forEach((h,l)=>{this.dispatchEvent("metacommit",{type:"Cmn.Text",data:h,mask:l!=0})})}},t(e,q)[2]=function(a){this.dispatchEvent("metacommit",{type:"Copyrite",data:a})},t(e,q)[3]=function(a,n){n<1&&t(this,Ne)<1&&this.dispatchEvent("metacommit",{type:"TrkTitle",data:a})},t(e,q)[4]=function(a,n){this.dispatchEvent("metacommit",{type:"Instrmnt",data:a})},t(e,q)[5]=function(a){a.trim()==""?this.dispatchEvent("metacommit",{type:"C.Lyrics",data:"",amend:!1}):this.dispatchEvent("metacommit",{type:"C.Lyrics",data:a,amend:!0})},t(e,q)[6]=function(a){this.dispatchEvent("metacommit",{type:"C.Marker",data:a})},t(e,q)[7]=function(a){this.dispatchEvent("metacommit",{type:"CuePoint",data:a})},t(e,q)[32]=function(a){x(this,Ne,a[0]+1)},t(e,q)[33]=function(a,n){t(e,Ae)[n]=a+1},t(e,q)[81]=function(a,n){x(e,st,a/1e3)},t(e,q)[127]=function(a,n){t(e,_e).run(a,n)},t(e,_e).default=function(a){console.warn(`Unrecognized sequencer-specific byte sequence: ${a}`)},t(e,_e).add([67,0,1],function(a,n){t(e,Ae)[n]=a[0]+1}),x(e,Ge,new de("universal non-realtime")),x(e,Xe,new de("universal realtime")),x(e,se,new de("Yamaha")),x(e,le,new de("Roland")),x(e,ke,new de("Korg")),x(e,Ve,new de("Kawai")),x(e,Fe,new de("Akai")),x(e,Ke,new de("Casio"));let r=new de("DX7+ Dump"),d=function(a){console.info(`Unrecognized SysEx in "${this.name}" set.
%o`,a)};t(e,Ge).default=d,t(e,Xe).default=d,t(e,se).default=d,t(e,le).default=d,t(e,ke).default=d,t(e,Ve).default=d,t(e,Fe).default=d,t(e,Ke).default=d,r.default=d,t(e,Ge).add([9],a=>{e.switchMode(["gm","?","g2"][a[0]-1],!0),x(e,N,t(e,N)||!1),console.info(`MIDI reset: ${["GM","Init","GM2"][a[0]-1]}`),a[0]==2&&e.init()}),t(e,Xe).add([4,1],a=>{x(e,B,((a[1]<<7)+a[0])/16383*100),e.dispatchEvent("mastervolume",t(e,B))}).add([4,3],a=>((a[1]<<7)+a[0]-8192)/8192).add([4,4],a=>a[1]-64).add([4,5],a=>{let n=a[0],c=a[1],i=a[2],s=3,f=s+(n<<1),h=f+c;if(n!=1){console.error(`Unsupported GM2 global parameter set: slotpath length too long (${n})!
`,a);return}let l=0,u=0,m=0;switch(a.subarray(s,f).forEach(w=>{l=l<<7,l|=w}),a.subarray(f,h).forEach((w,C)=>{u|=w<<C*7}),a.subarray(h).forEach((w,C)=>{m|=w<<C*7}),A()&&console.debug(`GM2 global parameter: (${a.subarray(3,f)}; p: ${u}, v: ${m})`),l){case 129:{u==0&&(e.setEffectType(0,52,m),e.dispatchEvent("efxreverb",e.getEffectType(0)));break}case 130:{u==0&&(e.setEffectType(1,52,m|16),e.dispatchEvent("efxchorus",e.getEffectType(1)));break}default:A()&&console.debug("GM2 global paramater slot path unknown.")}}),t(this,se).add([76,0,0],a=>{switch(a[0]){case 125:{e.initDrums(),console.info(`XG drum setup reset: ${a}`);break}case 126:{e.switchMode("xg",!0),x(e,N,!1),console.info("MIDI reset: XG");break}default:{let n=[0,0,0,0],c=(i,s)=>{n[s]=i};if(a.subarray(1).forEach((i,s)=>{let f=s+a[0];([c,c,c,c,h=>{x(this,B,h*129/16383*100),e.dispatchEvent("mastervolume",t(e,B))},h=>{},h=>{}][f]||(()=>{}))(i,s)}),a[0]<4){let i=0;n.forEach(s=>{i=i<<4,i+=s}),i-=1024}}}}).add([76,2,1],a=>{let n="XG ";a[0]<32?(n+="reverb ",a.subarray(1).forEach((c,i)=>{([s=>{e.setEffectTypeRaw(0,!1,s),console.info(`${n}main type: ${ft[s]}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},s=>{e.setEffectTypeRaw(0,!0,s),console.debug(`${n}sub type: ${s+1}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},s=>{console.debug(`${n}time: ${jt(s)}s`)},s=>{console.debug(`${n}diffusion: ${s}`)},s=>{console.debug(`${n}initial delay: ${s}`)},s=>{console.debug(`${n}HPF cutoff: ${et[s]}Hz`)},s=>{console.debug(`${n}LPF cutoff: ${et[s]}Hz`)},s=>{console.debug(`${n}width: ${s}`)},s=>{console.debug(`${n}height: ${s}`)},s=>{console.debug(`${n}depth: ${s}`)},s=>{console.debug(`${n}wall type: ${s}`)},s=>{console.debug(`${n}dry/wet: ${s}`)},s=>{console.debug(`${n}send: ${J(s)}dB`)},s=>{console.debug(`${n}pan: ${s-64}`)},!1,!1,s=>{console.debug(`${n}delay: ${s}`)},s=>{console.debug(`${n}density: ${s}`)},s=>{console.debug(`${n}balance: ${s}`)},s=>{},s=>{console.debug(`${n}feedback: ${s}`)},s=>{}][a[0]+i]||function(){console.warn(`Unknown XG reverb address: ${a[0]}.`)})(c)})):a[0]<64?(n+="chorus ",a.subarray(1).forEach((c,i)=>{([s=>{e.setEffectTypeRaw(1,!1,s),console.info(`${n}main type: ${ft[s]}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},s=>{e.setEffectTypeRaw(1,!0,s),console.debug(`${n}sub type: ${s+1}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},s=>{console.debug(`${n}LFO: ${Wt[s]}Hz`)},s=>{},s=>{console.debug(`${n}feedback: ${s}`)},s=>{console.debug(`${n}delay offset: ${Zt(s)}ms`)},s=>{},s=>{console.debug(`${n}low: ${et[s]}Hz`)},s=>{console.debug(`${n}low: ${s-64}dB`)},s=>{console.debug(`${n}high: ${et[s]}Hz`)},s=>{console.debug(`${n}high: ${s-64}dB`)},s=>{console.debug(`${n}dry/wet: ${s}`)},s=>{console.debug(`${n}send: ${J(s)}dB`)},s=>{console.debug(`${n}pan: ${s-64}`)},s=>{console.debug(`${n}to reverb: ${J(s)}dB`)},!1,s=>{},s=>{},s=>{},s=>{console.debug(`${n}LFO phase diff: ${(s-64)*3}deg`)},s=>{console.debug(`${n}input mode: ${s?"stereo":"mono"}`)},s=>{}][a[0]-32+i]||function(){console.warn(`Unknown XG chorus address: ${a[0]}.`)})(c)})):a[0]<86?(n+="variation ",a.subarray(1).forEach((c,i)=>{([s=>{e.setEffectTypeRaw(2,!1,s),console.info(`${n}main type: ${ft[s]}`),e.dispatchEvent("efxdelay",e.getEffectType(2))},s=>{e.setEffectTypeRaw(2,!0,s),console.debug(`${n}sub type: ${s+1}`),e.dispatchEvent("efxdelay",e.getEffectType(2))}][a[0]-64+i]||function(){})(c)})):a[0]<97?(n+="variation ",a.subarray(1).forEach((c,i)=>{[s=>{console.debug(`${n}send: ${J(s)}dB`)},s=>{console.debug(`${n}pan: ${s-64}`)},s=>{console.debug(`${n}to reverb: ${J(s)}dB`)},s=>{console.debug(`${n}to chorus: ${J(s)}dB`)},s=>{console.debug(`${n}connection: ${s?"system":"insertion"}`)},s=>{console.debug(`${n}channel: CH${s+1}`)},s=>{console.debug(`${n}mod wheel: ${s-64}`)},s=>{console.debug(`${n}bend wheel: ${s-64}`)},s=>{console.debug(`${n}channel after touch: ${s-64}`)},s=>{console.debug(`${n}AC1: ${s-64}`)},s=>{console.debug(`${n}AC2: ${s-64}`)}][a[0]-86+i](c)})):a[0]>111&&a[0]<118?n+="variation ":console.warn(`Unknown XG variation address: ${a[0]}`)}).add([76,2,64],a=>{a.subarray(1).forEach((n,c)=>{let i=c+a[0];if(i==0)console.debug(`XG EQ preset: ${["flat","jazz","pop","rock","classic"][n]}`);else{let s=i-1>>2,f=i-1&3,h=`XG EQ ${s} ${["gain","freq","Q","shape"][f]}: `;[()=>{console.debug(`${h}${n-64}dB`)},()=>{console.debug(`${h}${n} (raw)`)},()=>{console.debug(`${h}${n/10}`)},()=>{console.debug(`${h}${["shelf","peak"][+!!n]}`)}][f]()}})}).add([76,3],a=>{let n=a[0],c=a[1],i=`XG Insertion ${a[0]+1} `;a.subarray(2).forEach((s,f)=>{([h=>{e.setEffectTypeRaw(3+n,!1,h),console.info(`${i}main type: ${ft[h]}`),e.dispatchEvent(`efxinsert${n}`,e.getEffectType(3+n))},h=>{e.setEffectTypeRaw(3+n,!0,h),console.debug(`${i}sub type: ${h+1}`),e.dispatchEvent(`efxinsert${n}`,e.getEffectType(3+n))}][c+f]||function(){})(s)})}).add([76,6,0],a=>{let n=a[0];n<64?e.setLetterDisplay(a.subarray(1),"XG letter display",n):x(e,Oe,Date.now())}).add([76,7,0],a=>{let n=a[0];x(e,W,0),x(e,ge,Date.now()+3200),t(e,ie,Ee).fill(0);let c=a.subarray(1);for(let i=0;i<n;i++)c.unshift(0);c.forEach(function(i,s){let f=Math.floor(s/16),h=s%16,l=(h*3+f)*7,u=7,m=0;for(l-=h*5,f==2&&(u=2);m<u;)t(e,ie,Ee)[l+m]=i>>6-m&1,m++})}).add([76,8],(a,n)=>{let c=e.chRedir(a[0],n,!0),i=a[1],s=E.cc*c,f=`XG CH${c+1} `,h=`Unknown XG part address ${i}.`;a.subarray(2).forEach((l,u)=>{i<1?console.debug(h):i<41?([()=>{t(e,g)[s+y[0]]=l,e.dispatchEvent("voice",{part:c})},()=>{t(e,g)[s+y[32]]=l,e.dispatchEvent("voice",{part:c})},()=>{t(e,U)[c]=l,e.dispatchEvent("voice",{part:c})},()=>{let m=e.chRedir(l,n,!0);t(e,K)[c]=m,c!=m&&(e.buildRchTree(),console.info(`${f}receives from CH${m+1}`))},()=>{t(e,ee)[c]=+!l},()=>{},()=>{e.setChType(c,l,T.xg),console.debug(`${f}type: ${ht[l]||l}`)},()=>{t(e,R)[E.rpn*c+3]=l,t(e,L)[E.rpnt*c+2]=1},!1,!1,()=>{t(e,g)[s+y[7]]=l},!1,!1,()=>{t(e,g)[s+y[10]]=l||128},!1,!1,()=>{t(e,g)[s+y[128]]=l},()=>{t(e,g)[s+y[93]]=l},()=>{t(e,g)[s+y[91]]=l},()=>{t(e,g)[s+y[94]]=l},()=>{t(e,g)[s+y[76]]=l},()=>{t(e,g)[s+y[77]]=l},()=>{t(e,g)[s+y[78]]=l},()=>{t(e,g)[s+y[74]]=l},()=>{t(e,g)[s+y[71]]=l},()=>{t(e,g)[s+y[73]]=l},()=>{t(e,g)[s+y[75]]=l},()=>{t(e,g)[s+y[72]]=l}][i+u-1]||(()=>{}))():i<48?console.debug(h):i<111?i>102&&i<105&&(t(e,g)[s+y[[5,65][i&1]]]=l):i<114?console.debug(h):i<116?console.debug(`${f}EQ ${["bass","treble"][i&1]} gain: ${l-64}dB`):i<118?console.debug(h):i<120?console.debug(`${f}EQ ${["bass","treble"][i&1]} freq: ${l}`):console.debug(h)})}).add([76,9],(a,n)=>{let c=e.chRedir(a[0],n,!0),i=a[1],s=E.cc*c,f=`PLG-VL CH${c+1} `;a.subarray(2).forEach((h,l)=>{let u=l+i;switch(u){case 1:{console.info(`${f}breath mode: ${["system","breath","velocity","touch EG"][h]}`);break}case 0:case 27:case 28:break;default:if(u<27){let m=u-3>>1,w=["pressure","embouchure","tonguing","scream","breath noise","growl","throat formant","harmonic enhancer","damping","absorption","amplification","brightness"][m];u&1?u<23?(console.debug(`${f}${w} control source: ${ta(h)}`),h&&h<96&&e.allocateAce(130+m),t(e,Be)[E.redir*c+m+2]=h,e.buildRccMap()):console.debug(`${f}${w} scale break point: ${h}`):(console.debug(`${f}${w} depth: ${h-64}`),t(e,g)[s+y[130+m]]=h)}}})}).add([76,10],a=>{}).add([76,16],a=>{}).add([76,17,0,0],a=>{}).add([76,112],a=>{switch(console.debug(`XG enable PLG-${["VL","SG","DX","AN","PF","DR","PC","AP"][a[0]]} for CH${a[2]+1}.`),a[0]){case 0:{t(e,te)[E.ext*a[2]]=e.EXT_VL;break}case 2:{t(e,te)[E.ext*a[2]]=e.EXT_DX;break}default:t(e,te)[E.ext*a[2]]=e.EXT_NONE}}).add([73,0,0],(a,n)=>{let c=a[0],i="MU1000 System: ";a.subarray(1).forEach((s,f)=>{let h=c+f;h==8?console.debug(`${i}LCD contrast set to ${s}.`):h==18?(x(e,oe,s?126:0),console.debug(`${i}bank defaults to ${s?"MU100 Native":"MU Basic"}.`)):h>=64&&h<69&&[()=>{e.dispatchEvent("channelactive",s)},()=>{s<8?(e.dispatchEvent("channelmin",s<<4),console.debug(`Octavia System: Minimum CH${(s<<4)+1}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{s<8?(e.dispatchEvent("channelmax",(s<<4)+15),console.debug(`Octavia System: Maximum CH${(s<<4)+16}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges")},()=>{x(e,ue,!!s),console.info(`Octavia System: RS receiving ${["dis","en"][s]}abled.`)}][h-64]()})}).add([73,10,0],(a,n)=>{let c=a[0],i=`MU1000 RS${t(e,ue)?"":" (ignored)"}: `;if(c<16)switch(c){case 2:{let s=e.chRedir(0,n,!0);t(e,ue)&&(e.dispatchEvent("channelmin",s),e.dispatchEvent("channelmax",s+63)),console.info(`${i}Show CH1~64`);break}case 3:{let s=e.chRedir(a[1]<<5,n,!0);t(e,ue)&&e.dispatchEvent("channelmin",s),t(e,ue)&&e.dispatchEvent("channelmax",s+31),console.info(`${i}Show CH${s+1}~CH${s+32}`);break}default:console.debug(`${i}unknown switch ${c} invoked.`)}else if(c<32){if(t(e,ue)){let s=e.chRedir(c-16+(t(e,nt)<<4),n,!0);e.dispatchEvent("channelactive",s)}}else if(c<36){let s=e.chRedir(c-32<<4,n,!0);t(e,ue)&&(e.dispatchEvent("channelmin",s),e.dispatchEvent("channelmax",s+15),x(e,nt,c-32)),console.info(`${i}Show CH${s+1}~CH${s+16}`)}}).add([93,3],(a,n)=>{let c=e.chRedir(a[0],n,!0),i=`PLG-100SG CH${c+1} `,s=Date.now();if(a[1]==0){let f="",h=0;a.subarray(2).forEach((l,u)=>{u%2==0?f+=Jt[l]||l.toString().padStart("0"):h+=l*13}),s>=t(e,it)&&this.dispatchEvent("metacommit",{type:"SGLyrics",data:"",amend:!1}),this.dispatchEvent("metacommit",{type:"SGLyrics",data:`${ea(f)}`,amend:!0}),x(e,it,s+Math.ceil(h/2)+t(e,st)),A()&&console.debug(`${i}vocals: ${f}`)}else console.warn(`Unknown PLG-100SG data: ${a}`)}).add([98,0],(a,n,c)=>{let i=a[0],s=a.length-5,f=a.length-1;if(i!=s){console.info(`PLG-DX native dump size mismatch! Gave ${i} instead of ${a.length-5}.`);return}let h=Te(a.subarray(4,f));if(h!=a[f]){console.info(`Bad PLG-DX checksum ${a[f]} - should be ${h}.`);return}a[0]=98,t(e,se).run(a.subarray(0,f),n,c,{noAce:!0})}).add([98,96],(a,n,c,i)=>{let s=e.chRedir(a[0],n,!0),f=E.cc*s,h=a[1];a.subarray(2).forEach((l,u)=>{let m=h+u;if(!(m<10)){if(m==10)e.resetAce();else if(m<27){let w=m+131;i!=null&&i.noAce||e.allocateAce(w),t(e,g)[f+y[w]]=l,e.dispatchEvent("cc",{part:s,cc:w,data:l})}}})}).add([100,0],(a,n,c)=>{let i=a.subarray(0,a.length-1);if(a[0]+5!=a.length){console.warn(`Yamaha DX7+ dump SysEx size mismatch! Expected ${a.length}, but got ${a[0]}:
`,a);return}let s=Te(i),f=a[a.length-1];if(s!=f){console.warn(`Yamaha DX7+ dump SysEx checksum mismatch! Expected ${s}, but got ${f}:
`,a);return}r.run(i.subarray(1))}).add([100,76],(a,n,c)=>{let i=a[0]>>4,s=a[0]&15,f=a[1];switch(i){case 2:{let h=e.chRedir(s,n,!0),l=E.cc*h;a.subarray(2).forEach((u,m)=>{let w=m+f;if(!(w<7)){if(w<23){let C=w+135;e.allocateAce(C),t(e,g)[l+y[C]]=u,e.dispatchEvent("cc",{part:h,cc:C,data:u})}}});break}default:console.info("Unknown DX7+ multipart: %o",a)}}),r.add([14,31],a=>{t(e,g)[E.cc*a[0]+y[64]]=0,t(e,X).ano(a[0]),e.switchMode("xg"),e.resetAce(),console.debug(`Yamaha DX7+ reset CH${a[0]+1}.`)}).add([76,112],async a=>{let n=a[0],c=E.cc*n,i=E.ext*n,s=E.cvn*n;t(e,te)[i]=e.EXT_DX,t(e,fe)[n]=1;let f=t(e,gt).subarray(s,s+E.cvn);f.fill(32),a.subarray(1).forEach((h,l)=>{if(l<10)f[l]=Math.max(h,32);else if(!(l<40)){if(l<56){let u=l+102;t(e,g)[c+y[u]]=h,e.dispatchEvent("cc",{part:n,cc:u,data:h})}}}),t(e,U)[n]=n&127,t(e,g)[E.cc*n+y[0]]=35,t(e,g)[E.cc*n+y[32]]=n>>7|4,e.dispatchEvent("voice",{part:n}),console.debug(`DX7+ CH${n+1} dump: %o`,a)});let o=function(a,n,c,i){},p=function(a,n){let c=a*E.dpn,i=n[0],s=n[1];n.subarray(2).forEach((f,h)=>{let l=h+s,u=-1;l<16?([()=>{u=24},()=>{u=25},()=>{u=26},()=>{},()=>{u=28},()=>{u=29},()=>{u=30},()=>{u=31},()=>{},()=>{},()=>{},()=>{u=20},()=>{u=21},()=>{u=22},()=>{u=23},()=>{}][l]||(()=>{console.debug(`Unknown XG-style drum param ${l} on set ${a+1}.`)}))():l<32||(l<40?([()=>{u=48},()=>{u=49},!1,!1,()=>{u=52},()=>{u=53}][l-32]||(()=>{console.debug(`Unknown XG-style drum param ${l} on set ${a+1}.`)}))():l<80||([()=>{u=36}][l-80]||(()=>{console.debug(`Unknown XG-style drum param ${l} on set ${a+1}.`)}))()),u>=0?(A()&&console.debug(c,u,i,f),t(e,j)[(c+ne[u])*E.dnc+i]=f):A()&&console.debug(`XG-style drum param ${l} has no writes.`)})},$=function(a,n,c){let i=a*E.dpn,s=(n<<7)+c[0];c.subarray(1).forEach((f,h)=>{let l=h+s,u=l&127,m=l>>7,w=-1;m>1&&([()=>{w=26},()=>{},()=>{w=28},()=>{w=29},()=>{w=30},()=>{},()=>{},()=>{w=31}][m-2]||(()=>{console.debug(`Unknown GS-style drum param ${m} on set ${a+1}.`)}))(),w>-1?(A()&&console.debug(i,w,u,f),t(e,j)[(i+ne[w])*E.dnc+u]=f):A()&&console.debug(`GS-style drum param ${m} has no writes.`)})};t(this,se).add([76,48],(a,n,c)=>{p(0,a)}).add([76,49],(a,n,c)=>{p(1,a)}).add([76,50],(a,n,c)=>{p(2,a)}).add([76,51],(a,n,c)=>{p(3,a)}).add([76,52],(a,n,c)=>{p(4,a)}).add([76,53],(a,n,c)=>{p(5,a)}).add([76,54],(a,n,c)=>{p(6,a)}).add([76,55],(a,n,c)=>{p(7,a)}),t(this,se).add([89,0],(a,n,c)=>{if(e.eprom){let i=a[0],s=(a[1]<<14)+(a[2]<<7)+a[3]+(e.eprom.offset||0);A()&&console.debug(`MU1000 EPROM trail to 0x${s.toString(16).padStart(6,"0")}, ${i} bytes.`);let f=e.eprom.data;a.subarray(4).forEach((h,l)=>{let u=l>>3,m=l&7;if(m==7)for(let w=0;w<7;w++)f[s+7*u+w]+=(h>>6-w&1)<<7;else f[s+7*u+m]=h})}}).add([89,1],(a,n,c)=>{let i=(a[0]<<21)+(a[1]<<14)+(a[2]<<7)+a[3];A()&&console.debug(`MU1000 EPROM jump to 0x${i.toString(16).padStart(6,"0")}.`),e.eprom&&(e.eprom.offset=i)}).add([89,2],(a,n,c)=>{if(e.eprom){let i=(a[0]<<21)+(a[1]<<14)+(a[2]<<7)+a[3]+(e.eprom.offset||0);A()&&console.debug(`MU1000 EPROM write to 0x${i.toString(16).padStart(6,"0")}.`);let s=e.eprom.data;a.subarray(4).forEach((f,h)=>{let l=h>>3,u=h&7;if(u==7)for(let m=0;m<7;m++)s[i+7*l+m]+=(f>>6-m&1)<<7;else s[i+7*l+u]=f})}}).add([89,3],(a,n,c)=>{}),t(this,se).add([39,48],(a,n,c)=>{}).add([43,0,0],(a,n,c)=>{let i=[0,0,0,0],s=(f,h)=>{i[h]=f};if(a.subarray(1).forEach((f,h)=>{let l=h+a[0];[s,s,s,s,()=>{x(this,B,f*129/16383*100),e.dispatchEvent("mastervolume",t(e,B))},()=>f-64,()=>f||128,()=>f,()=>f,()=>{console.debug(`TG300 variation on cc${f}.`)}][l](f,l)}),a[0]<4){let f=0;i.forEach(h=>{f=f<<4,f+=h}),f-=1024}}).add([43,1,0],(a,n,c)=>{}).add([43,2],(a,n,c)=>{let i=e.chRedir(a[0],n,!0),s=a[1],f=E.cc*i,h=`TG300 CH${i+1} `;a.subarray(2).forEach((l,u)=>{u<5?([()=>{},()=>{t(e,g)[f+y[0]]=l,e.dispatchEvent("voice",{part:i})},()=>{t(e,g)[f+y[32]]=l,e.dispatchEvent("voice",{part:i})},()=>{t(e,U)[i]=l,e.dispatchEvent("voice",{part:i})},()=>{let m=e.chRedir(l,n,!0);t(e,K)[i]=m,i!=m&&(e.buildRchTree(),console.info(`${h}receives from CH${m+1}`))}][u+s]||(()=>{}))(l,u+s):u<21||(u<47?([()=>{t(e,ee)[i]=+!l},()=>{},()=>{},()=>{t(e,R)[E.rpn*i+3]=l,t(e,L)[E.rpnt*i+2]=1},()=>{},()=>{t(e,g)[f+y[7]]=l},!1,!1,()=>{t(e,g)[f+y[10]]=l||128},!1,!1,()=>{console.debug(`${h} AC1 at cc${l}`)},()=>{console.debug(`${h} AC2 at cc${l}`)},()=>{t(e,g)[f+y[128]]=l},()=>{t(e,g)[f+y[93]]=l},()=>{t(e,g)[f+y[91]]=l},()=>{t(e,g)[f+y[94]]=l},()=>{t(e,g)[f+y[76]]=l},()=>{t(e,g)[f+y[77]]=l},()=>{t(e,g)[f+y[74]]=l},()=>{t(e,g)[f+y[71]]=l},()=>{t(e,g)[f+y[73]]=l},()=>{t(e,g)[f+y[75]]=l},()=>{t(e,g)[f+y[72]]=l},()=>{t(e,g)[f+y[78]]=l}][u+s-21]||(()=>{}))(l,u+s):u<95||([()=>{t(e,g)[f+y[65]]=l},()=>{t(e,g)[f+y[5]]=l}][u+s-95]||(()=>{}))(l,u+s))})}).add([43,7,0],(a,n,c)=>{let i=a[0];e.setLetterDisplay(a.subarray(1),"TG300 letter display",i)}).add([43,7,1],(a,n,c)=>{x(e,W,0),x(e,ge,Date.now()+3200),t(e,ie,Ee).fill(0),a.forEach(function(i,s){let f=Math.floor(s/16),h=s%16,l=(h*3+f)*7,u=7,m=0;for(l-=h*5,f==2&&(u=2);m<u;)t(e,ie,Ee)[l+m]=i>>6-m&1,m++})}),t(this,le).add([66,18,0,0,127],(a,n,c)=>{e.switchMode("gs",!0),t(e,g)[E.cc*9]=120,t(e,g)[E.cc*25]=120,t(e,g)[E.cc*41]=120,t(e,g)[E.cc*57]=120,x(e,oe,3),x(e,N,!1),t(e,we).fill(0),console.info(`GS system to ${["single","dual"][a[0]]} mode.`)}).add([66,18,64,0],(a,n,c)=>{switch(a[0]){case 127:{e.switchMode("gs",!0),t(e,g)[E.cc*9]=120,t(e,g)[E.cc*25]=120,t(e,g)[E.cc*41]=120,t(e,g)[E.cc*57]=120,x(e,N,!1),t(e,we).fill(0),console.info("MIDI reset: GS");break}default:{let i=[0,0,0,0],s=(f,h)=>{i[h]=f};if(a.subarray(1).forEach((f,h)=>{let l=h+a[0];[s,s,s,s,u=>{x(this,B,u*129/16383*100),e.dispatchEvent("mastervolume",t(e,B))},u=>{},u=>{}][l](f,h)}),a[0]<4){let f=0;i.forEach(h=>{f=f<<4,f+=h}),f-=1024}}}}).add([66,18,64,1],a=>{let n=a[0];if(n<16){let c="".padStart(n," ");a.subarray(1).forEach((i,s)=>{c+=String.fromCharCode(Math.max(32,i))}),c=c.padEnd(16," "),console.debug(`GS patch name: ${c}`)}else n<48||(n<65?a.subarray(1).forEach((c,i)=>{let s=`GS ${n+i>55?"chorus":"reverb"} `;([()=>{console.info(`${s}type: ${At[c]}`),e.setEffectType(0,40,c),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{},()=>{},()=>{},()=>{},()=>{},!1,()=>{console.debug(`${s}predelay: ${c}ms`)},()=>{console.info(`${s}type: ${aa[c]}`),e.setEffectType(1,40,16+c),e.dispatchEvent("efxchorus",e.getEffectType(1))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${s}to reverb: ${J(c)}`)},()=>{console.debug(`${s}to delay: ${J(c)}`)}][n+i-48]||(()=>{}))()}):n<80?console.debug(`Unknown GS patch address: ${n}`):n<91?a.subarray(1).forEach((c,i)=>{let s="GS delay ";([()=>{console.info(`${s}type: ${ra[c]}`),e.setEffectType(2,40,32+c),e.dispatchEvent("efxdelay",e.getEffectType(2))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${s}to reverb: ${J(c)}`)}][n+i-80]||(()=>{}))()}):console.debug(`Unknown GS patch address: ${n}`))}).add([66,18,64,2],a=>{let n="GS EQ ";a.subarray(1).forEach((c,i)=>{([()=>{console.debug(`${n}low freq: ${[200,400][c]}Hz`)},()=>{console.debug(`${n}low gain: ${c-64}dB`)},()=>{console.debug(`${n}high freq: ${[3e3,6e3][c]}Hz`)},()=>{console.debug(`${n}high gain: ${c-64}dB`)}][a[0]+i]||function(){console.warn(`Unknown GS EQ address: ${a[0]+i}`)})()})}).add([66,18,64,3],a=>{let n="GS EFX ",c=function(i,s){let f=sa(t(e,ae).subarray(10,12),s,i);f&&console.debug(`${n}${Lt(t(e,ae).subarray(10,12))} ${f}`)};a.subarray(1).forEach((i,s)=>{([()=>{e.setEffectTypeRaw(3,!1,32+i),e.dispatchEvent("efxinsert0",e.getEffectType(3))},()=>{e.setEffectTypeRaw(3,!0,i),console.info(`${n}type: ${Lt(t(e,ae).subarray(10,12))}`),e.dispatchEvent("efxinsert0",e.getEffectType(3))},!1,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,()=>{console.debug(`${n}to reverb: ${J(i)}dB`)},()=>{console.debug(`${n}to chorus: ${J(i)}dB`)},()=>{console.debug(`${n}to delay: ${J(i)}dB`)},!1,()=>{console.debug(`${n}1 source: ${i}`),i&&i<96&&e.allocateAce(i)},()=>{console.debug(`${n}1 depth: ${i-64}`)},()=>{console.debug(`${n}2 source: ${i}`),i&&i<96&&e.allocateAce(i)},()=>{console.debug(`${n}2 depth: ${i-64}`)},()=>{console.debug(`${n}to EQ: ${i?"ON":"OFF"}`)}][a[0]+s]||function(f,h){console.warn(`Unknown GS EFX address: ${h}`)})(i,a[0]+s)})}).add([66,18,65],a=>{$((a[0]>>4)+1<<1,a[0]&15,a.subarray(1))}).add([69,18,16],a=>{var n;switch(a[0]){case 0:{let c=a[1];e.setLetterDisplay(a.subarray(2),"GS display text",c);break}case 32:{x(e,ge,Date.now()+3200),a[1]==0&&(x(e,W,Math.max(Math.min(a[2]-1,9),0)),A()&&console.debug(`GS switch display page ${a[2]-1}.`));break}default:if(a[0]<6){t(e,W)>9&&x(e,W,0);let c=a[0]-1<<1|a[1]>>6;t(e,W)==c&&x(e,ge,Date.now()+3200),(n=t(e,ve)[c])!=null&&n.length||(t(e,ve)[c]=new Uint8Array(256));let i=t(e,ve)[c];A()&&console.debug(`GS frame draw page ${c}.`);let s=a[1]&63;i.fill(0),a.subarray(2).forEach(function(h,l){let u=l+s,m=Math.floor(u/16),w=u%16,C=(w*4+m)*5,M=5,G=0;for(C-=w*4,m==3&&(M=1);G<M;)i[C+G]=h>>4-G&1,G++})}else console.warn(`Unknown GS display section: ${a[0]}`)}});let v=function(a,n,c){let i=a[0],s=E.cc*n,f=E.rpn*n,h=`GS CH${n+1} `;i<3?(a.subarray(1).forEach((l,u)=>{[()=>{t(e,g)[s+y[0]]=l},()=>{t(e,U)[n]=l},()=>{let m=0;l<16?m=e.chRedir(l,c,!0):m=E.ch,t(e,K)[n]=m,n!=m&&(e.buildRchTree(),console.info(`${h}receives from CH${m+1}`))}][i+u]()}),e.dispatchEvent("voice",{part:n})):i<19||(i<44?a.subarray(1).forEach((l,u)=>{([()=>{t(e,ee)[n]=+!l},!1,()=>{e.setChType(n,l<<1,T.gs),console.debug(`${h}type: ${l?"drum ":"melodic"}${l||""}`)},()=>{t(e,R)[f+3]=l,t(e,L)[E.rpnt*n+2]=1},!1,()=>{t(e,g)[s+y[7]]=l},!1,!1,()=>{t(e,g)[s+y[10]]=l||128},!1,!1,()=>{console.debug(`${h}CC 1: cc${l}`)},()=>{console.debug(`${h}CC 2: cc${l}`)},()=>{t(e,g)[s+y[93]]=l},()=>{t(e,g)[s+y[91]]=l},!1,!1,()=>{t(e,R)[f+1]=l,t(e,L)[E.rpnt*n+1]=1},()=>{t(e,R)[f+2]=l,t(e,L)[E.rpnt*n+1]=1},()=>{t(e,g)[s+y[94]]=l}][i+u-19]||(()=>{}))()}):i<76||console.debug(`Unknown GS part address: ${i}`))},k=function(a,n){let c=a[0],i=`GS CH${n+1} `;c<2?a.subarray(1).forEach((s,f)=>{[()=>{t(e,g)[E.cc*n+y[32]]=s},()=>{}][c+f]()}):c<32?console.warn(`Unknown GS misc address: ${c}`):c<35?a.subarray(1).forEach((s,f)=>{[()=>{console.debug(`${i}EQ: o${["ff","n"][s]}`)},()=>{},()=>{console.debug(`${i}EFX: o${["ff","n"][s]}`),t(e,at)[n]=s,e.dispatchEvent("partefxtoggle",{part:n,active:s})}][c+f-32]()}):console.warn(`Unknown GS misc address: ${c}`)};t(this,le).add([66,18,64,16],(a,n)=>{v(a,e.chRedir(9,n,!0),n)}).add([66,18,64,17],(a,n)=>{v(a,e.chRedir(0,n,!0),n)}).add([66,18,64,18],(a,n)=>{v(a,e.chRedir(1,n,!0),n)}).add([66,18,64,19],(a,n)=>{v(a,e.chRedir(2,n,!0),n)}).add([66,18,64,20],(a,n)=>{v(a,e.chRedir(3,n,!0),n)}).add([66,18,64,21],(a,n)=>{v(a,e.chRedir(4,n,!0),n)}).add([66,18,64,22],(a,n)=>{v(a,e.chRedir(5,n,!0),n)}).add([66,18,64,23],(a,n)=>{v(a,e.chRedir(6,n,!0),n)}).add([66,18,64,24],(a,n)=>{v(a,e.chRedir(7,n,!0),n)}).add([66,18,64,25],(a,n)=>{v(a,e.chRedir(8,n,!0),n)}).add([66,18,64,26],(a,n)=>{v(a,e.chRedir(10,n,!0),n)}).add([66,18,64,27],(a,n)=>{v(a,e.chRedir(11,n,!0),n)}).add([66,18,64,28],(a,n)=>{v(a,e.chRedir(12,n,!0),n)}).add([66,18,64,29],(a,n)=>{v(a,e.chRedir(13,n,!0),n)}).add([66,18,64,30],(a,n)=>{v(a,e.chRedir(14,n,!0),n)}).add([66,18,64,31],(a,n)=>{v(a,e.chRedir(15,n,!0),n)}).add([66,18,64,64],(a,n)=>{k(a,e.chRedir(9,n,!0))}).add([66,18,64,65],(a,n)=>{k(a,e.chRedir(0,n,!0))}).add([66,18,64,66],(a,n)=>{k(a,e.chRedir(1,n,!0))}).add([66,18,64,67],(a,n)=>{k(a,e.chRedir(2,n,!0))}).add([66,18,64,68],(a,n)=>{k(a,e.chRedir(3,n,!0))}).add([66,18,64,69],(a,n)=>{k(a,e.chRedir(4,n,!0))}).add([66,18,64,70],(a,n)=>{k(a,e.chRedir(5,n,!0))}).add([66,18,64,71],(a,n)=>{k(a,e.chRedir(6,n,!0))}).add([66,18,64,72],(a,n)=>{k(a,e.chRedir(7,n,!0))}).add([66,18,64,73],(a,n)=>{k(a,e.chRedir(8,n,!0))}).add([66,18,64,74],(a,n)=>{k(a,e.chRedir(10,n,!0))}).add([66,18,64,75],(a,n)=>{k(a,e.chRedir(11,n,!0))}).add([66,18,64,76],(a,n)=>{k(a,e.chRedir(12,n,!0))}).add([66,18,64,77],(a,n)=>{k(a,e.chRedir(13,n,!0))}).add([66,18,64,78],(a,n)=>{k(a,e.chRedir(14,n,!0))}).add([66,18,64,79],(a,n)=>{k(a,e.chRedir(15,n,!0))}),t(this,ke).add([54,65],(a,n)=>{e.switchMode("x5d");let c=a[a.length-1],i=a.subarray(0,a.length-1),s=Te(i);s!=c&&(console.info(`X5D multi parameters checksum mismatch! Expected ${s}, got ${c}.`),console.debug(a));let f=(a[1]<<7)+a[0],h=(a[3]<<7)+a[2],l=e.chRedir(f&15,n,!0),u=E.cc*l;[()=>{h<1||(h<101?(e.setChType(l,e.CH_MELODIC,T.x5d),t(e,U)[l]=h-1,t(e,g)[u+y[0]]=t(e,_).x5):h<229?(e.setChType(l,e.CH_MELODIC,T.x5d),t(e,U)[l]=h-101,t(e,g)[u+y[0]]=56):(e.setChType(l,e.CH_DRUMS,T.x5d),t(e,U)[l]=ua[h-229]||0,t(e,g)[u+y[0]]=62)),e.dispatchEvent("voice",{part:l})},()=>{t(e,g)[u+y[7]]=h},()=>{h<31&&(t(e,g)[u+y[10]]=Math.round((h-15)*4.2+64))},()=>{t(e,g)[u+y[93]]=ut(h)},()=>{t(e,g)[u+y[91]]=ut(h)},()=>{t(e,R)[l*E.rpn+3]=h>8191?h-16320:64+h,t(e,L)[E.rpnt*l+2]=1},()=>{t(e,R)[l*E.rpn+1]=h>8191?h-16320:64+h,t(e,L)[E.rpnt*l+1]=1},()=>{h>0&&(t(e,R)[l*E.rpn]=h,t(e,L)[E.rpnt*l]=1)},()=>{}][f>>4]()}).add([54,76,0],(a,n)=>{e.switchMode(t(e,_).x5=="81"?"05rw":"x5d",!0);let c="",i=t(e,_).x5,s=0,f=0,h="MSB\tPRG\tLSB\tNME";pe(a,function(l,u){if(u<16400){let m=u%164;switch(!0){case m<10:{l>31&&(c+=String.fromCharCode(l));break}case m==10:break;case m==11:{h+=`
${i}	${s}	${f}	${c.trim().replace("Init Voice","")}`,s++,c="";break}}s>99&&(i=90,s=0)}}),e.userBank.clearRange({msb:t(e,_).x5,prg:[0,99],lsb:0}),e.userBank.load(h),A()&&console.debug(h),e.forceVoiceRefresh()}).add([54,77,0],(a,n)=>{e.switchMode(t(e,_).x5=="81"?"05rw":"x5d",!0);let c="",i=90,s=0,f=0,h="MSB\tPRG\tLSB\tNME";pe(a,function(l,u){if(u<13600){let m=u%136;switch(!0){case m<10:{l>31&&(c+=String.fromCharCode(l));break}case m==11:{h+=`
${i}	${s}	${f}	${c.trim().replace("Init Combi","")}`,s++,c="";break}}}}),e.userBank.clearRange({msb:90,prg:[0,99],lsb:0}),e.userBank.load(h),A()&&console.debug(h),e.forceVoiceRefresh()}).add([54,78],(a,n)=>{e.switchMode(t(e,_).x5=="81"?"05rw":"x5d",!0),console.debug(`X5D mode switch requested: ${["combi","combi edit","prog","prog edit","multi","global"][a[0]]} mode.`)}).add([54,85],(a,n)=>{e.switchMode(t(e,_).x5=="81"?"05rw":"x5d",!0),pe(a,(c,i)=>{i>0&&i<3&&(e.setEffectType(i-1,44,c),e.dispatchEvent(`efx${["reverb","chorus"][i-1]}`,e.getEffectType(i-1)))})}).add([54,104],(a,n)=>{e.switchMode(t(e,_).x5=="81"?"05rw":"x5d",!0),pe(a,function(c,i,s,f){if(i<192){let h=e.chRedir(Math.floor(i/12),n,!0),l=h*E.cc;switch(i%12){case 0:{c<128?(e.setChType(h,e.CH_MELODIC,T.x5d),t(e,g)[l+y[0]]=t(e,_).x5,t(e,U)[h]=c):(e.setChType(h,e.CH_DRUMS,T.x5d),t(e,g)[l+y[0]]=62,t(e,U)[h]=ua[c-128]),c>0&&e.setChActive(h,1),e.dispatchEvent("voice",{part:h});break}case 1:{t(e,g)[l+y[7]]=c;break}case 2:{t(e,R)[h*E.rpn+3]=c>127?c-192:64+c,t(e,L)[E.rpnt*h+2]=1;break}case 3:{t(e,R)[h*E.rpn+1]=c>127?c-192:64+c,t(e,L)[E.rpnt*h+1]=1;break}case 4:{c<31&&(t(e,g)[l+y[10]]=Math.round((c-15)*4.2+64));break}case 5:{let u=c>>4,m=c&15;t(e,g)[l+y[91]]=ut(m),t(e,g)[l+y[93]]=ut(u);break}case 10:break;case 11:{let u=e.chRedir(c&15,n,!0),m=c>>4;t(e,K)[h]=c,(u!=h||m)&&(console.info(`X5D Part CH${h+1} receives from CH${u+1}.`),e.buildRchTree())}}}else{let h=e.chRedir(i-192,n,!0)}})}),t(this,le).add([22,18,127],a=>{e.switchMode("mt32",!0),x(e,N,!1),e.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),console.info("MIDI reset: MT-32")}).add([22,18,0],(a,n,c)=>{e.switchMode("mt32");let i=e.chRedir(c,n,!0),s=a[1];a.subarray(2).forEach((f,h)=>{let l=h+s;t(e,Ce)[l+(i-1)*16]=f,([!1,()=>{let u=t(e,Ce)[i-1<<4];if(u<3){if(t(e,fe)[i]=1,u==2)for(let m=0;m<name.length;m++)t(e,he)[(i-1)*E.cmt+m]=t(e,Me)[f*E.cmt+m];else{let m=e.baseBank.get(0,f+(u<<6),127,"mt32").name;for(let w=0;w<m.length;w++)t(e,he)[(i-1)*E.cmt+w]=m.charCodeAt(w)}e.dispatchEvent("voice",{part:i})}},()=>{t(e,R)[i*E.rpn+3]=f+40,t(e,L)[E.rpnt*i+2]=1},()=>{t(e,R)[i*E.rpn+1]=f+14,t(e,L)[E.rpnt*i+1]=1},()=>{t(e,R)[i*E.rpn]=f,t(e,L)[E.rpnt*i]=1},!1,()=>{t(e,g)[E.cc*i+y[91]]=f?127:0},!1,()=>{t(e,g)[E.cc*i+y[7]]=f},()=>{t(e,g)[E.cc*i+y[10]]=Math.ceil(f*9.05)}][l]||(()=>{}))()})}).add([22,18,1],(a,n,c)=>{e.switchMode("mt32");let i=c&7;console.debug(`MT-32 slot #${c+1} Drum: ${a}`);let s=a[0]<<7|a[1];a.subarray(2).forEach((f,h)=>{let l=h+s,u=(l>>2)+24,m=l&3,w=i*E.dpn;if(A()&&console.debug(`MT-32 temp drum note ${u} param ${m}: ${f}`),u<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${u}`);return}[()=>{},()=>{t(e,j)[(w+ne[26])*E.dnc+u]=Math.round(f*1.27)},()=>{t(e,j)[(w+ne[26])*E.dnc+u]=f*9+1&127},()=>{t(e,j)[(w+ne[26])*E.dnc+u]=f?127:0}][m]()})}).add([22,18,2],(a,n,c)=>{e.switchMode("mt32");let i=e.chRedir(c,n,!0),s=a[1]+(a[0]<<7);s<10&&(t(e,fe)[i]=1),a.subarray(2).forEach((f,h)=>{let l=h+s;l<14&&(t(e,he)[(i-1)*E.cmt+l]=f)}),e.dispatchEvent("voice",{part:i})}).add([22,18,3],(a,n,c)=>{e.switchMode("mt32");let i=c&7;if(a[0]){let s=(a[0]-1<<7)+a[1]-16;a.subarray(2).forEach((f,h)=>{let l=h+s,u=(l>>2)+24,m=l&3,w=i*E.dpn;if(A()&&console.debug(`MT-32 dev drum note ${u} param ${m}: ${f}`),u<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${u}`);return}[()=>{},()=>{t(e,j)[(w+ne[26])*E.dnc+u]=Math.round(f*1.27)},()=>{t(e,j)[(w+ne[26])*E.dnc+u]=f*9+1&127},()=>{t(e,j)[(w+ne[26])*E.dnc+u]=f?127:0}][m]()})}else{let s=a[1];a.subarray(2).forEach((f,h)=>{let l=h+s;t(e,Ce)[l]=f;let u=e.chRedir(1+(l>>4),n,!0),m=l&15;([!1,()=>{let w=t(e,Ce)[u-1<<4];if(w<3)if(t(e,fe)[u]=1,w==2)for(let C=0;C<name.length;C++)t(e,he)[(u-1)*E.cmt+C]=t(e,Me)[f*E.cmt+C];else{let C=e.baseBank.get(0,f+(w<<6),127,"mt32").name;for(let M=0;M<C.length;M++)t(e,he)[(u-1)*E.cmt+M]=C.charCodeAt(M)}e.dispatchEvent("voice",{part:u})},()=>{t(e,R)[u*E.rpn+3]=f+40,t(e,L)[E.rpnt*u+2]=1},()=>{t(e,R)[u*E.rpn+1]=f+14,t(e,L)[E.rpnt*u+1]=1},()=>{t(e,R)[u*E.rpn]=f,t(e,L)[E.rpnt*u]=1},!1,()=>{t(e,g)[E.cc*u+y[91]]=f?127:0},!1,()=>{t(e,g)[E.cc*u+y[7]]=f},()=>{t(e,g)[E.cc*u+y[10]]=Math.ceil(f*9.05)}][m]||(()=>{}))()})}}).add([22,18,4],(a,n,c)=>{e.switchMode("mt32");let i=a[1]+(a[0]<<7),s=[];a.subarray(2).forEach((f,h)=>{let l=h+i,u=e.chRedir(Math.floor(l/246+1),n,!0),m=l%246;m<14&&(t(e,he)[(u-1)*E.cmt+m]=f),m<10&&(t(e,fe)[u]=1),s.indexOf(u)<0&&s.push(u)}),s.forEach(f=>{e.dispatchEvent("voice",{part:f})})}).add([22,18,5],(a,n,c)=>{e.switchMode("mt32");let i=(a[0]<<7)+a[1];a.subarray(2).forEach((s,f)=>{let h=i+f,l=Math.floor(h/8),u=h&7,m=l*8;t(e,rt)[h]=s,([!1,()=>{let w=t(e,rt)[m];if(w<3){let C="";if(w==2){let G=E.cmt*l;C=`MT-m:${s.toString().padStart(3,"0")}`}else C=e.baseBank.get(0,s+(w<<6),127,"mt32").name;e.userBank.clearRange({msb:0,lsb:127,prg:l});let M=`MSB	LSB	PRG	NME
000	127	${l}	${C}`;e.userBank.load(M,!0)}}][u]||(()=>{}))()}),e.forceVoiceRefresh()}).add([22,18,8],(a,n,c)=>{e.switchMode("mt32");let i=((a[0]&1)<<7)+a[1];a.subarray(2).forEach((s,f)=>{let h=i+f;h<E.cmt&&(t(e,Me)[(a[0]>>1)*E.cmt+h]=s)}),e.forceVoiceRefresh()}).add([22,18,16],(a,n,c)=>{e.switchMode("mt32");let i=a[1],s=!1,f=function(h,l){t(e,K)[l-12]=h,s=!0};a.subarray(2).forEach((h,l)=>{let u=l+i;([!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,f,f,f,f,f,f,f,f,f,()=>{x(e,B,h),e.dispatchEvent("mastervolume",t(e,B))}][u]||(()=>{}))(h,l)}),s&&e.buildRchTree()}).add([22,18,32],a=>{e.switchMode("mt32");let n=a[1],c=" ".repeat(n);a.subarray(2).forEach(i=>{i>31?c+=String.fromCharCode(i):c+=" "}),x(e,De,c.padStart(20," ")),x(e,Oe,Date.now()+3200)}).add([22,18,82],(a,n)=>{let c=e.chRedir(0,n,!0);for(let i=0;i<16;i++)t(e,X).ano(c+i),i&&i<10&&(t(e,U)[c+i]=It[i-1]);console.info("MT-32 alt reset complete.")}),t(this,ke).add([66,0],(a,n)=>{e.switchMode("ns5r",!0),x(e,N,!1),console.debug(`NS5R mode switch requested: ${["global","multi","prog edit","comb edit","drum edit","effect edit"][a[0]]} mode.`)}).add([66,1],(a,n)=>{e.switchMode(["ns5r","05rw"][a[0]],!0),x(e,N,!1)}).add([66,18,0,0],(a,n)=>{let c=a[0];switch(c){case 124:case 126:case 127:{e.switchMode("ns5r",!0),x(e,N,!1);break}case 125:{e.initDrums(),console.info(`NS5R drum setup reset: ${a}`);break}default:if(c<10){let i=[0,0,0,0],s=(f,h)=>{i[h]=f};if(a.subarray(1).forEach((f,h)=>{[s,s,s,s,()=>{x(e,B,f*129/16383*100),e.dispatchEvent("mastervolume",t(e,B))},()=>f-64,()=>f-64,()=>{},()=>{},()=>{}][c+h]()}),a[0]<4){let f=0;i.forEach(h=>{f=f<<4,f+=h}),f-=1024}}}}).add([66,18,0,1],(a,n)=>{}).add([66,18,0,2],(a,n)=>{}).add([66,18,1],(a,n)=>{let c=e.chRedir(a[0],n,!0),i=c*E.cc,s=a[1],f=`NS5R CH${c+1} `;a.subarray(2).forEach((h,l)=>{let u=s+l;u<3?([()=>{t(e,g)[i+y[0]]=h||pt.bank0},()=>{t(e,g)[i+y[32]]=h},()=>{t(e,U)[c]=h}][u](),e.dispatchEvent("voice",{part:c})):u<8||(u<14?[()=>{let m=e.chRedir(h,n,!0);t(e,K)[c]=m,c!=m&&(e.buildRchTree(),console.info(`${f}receives from CH${m+1}`))},()=>{t(e,ee)[c]=+!h},()=>{e.setChType(c,h,T.ns5r),console.debug(`${f}type: ${ht[h]}`)},()=>{t(e,R)[E.rpn*c+3]=h,t(e,L)[E.rpnt*c+2]=1},()=>{},()=>{}][u-8]():u<16||(u<33?[()=>{t(e,g)[i+y[7]]=h},()=>{t(e,g)[i+y[11]]=h},()=>{},()=>{},()=>{t(e,g)[i+y[10]]=h||128},()=>{},()=>{},()=>{t(e,g)[i+y[93]]=h},()=>{t(e,g)[i+y[91]]=h},()=>{t(e,g)[i+y[76]]=h},()=>{t(e,g)[i+y[77]]=h},()=>{t(e,g)[i+y[78]]=h},()=>{t(e,g)[i+y[74]]=h},()=>{t(e,g)[i+y[71]]=h},()=>{t(e,g)[i+y[73]]=h},()=>{t(e,g)[i+y[75]]=h},()=>{t(e,g)[i+y[72]]=h}][u-16]():u<112||u<114&&[()=>{t(e,g)[i+y[5]]=h},()=>{t(e,g)[i+y[65]]=h}][u-112]()))})}).add([66,18,8,0],(a,n)=>{let c=a[0];if(c<32)e.setLetterDisplay(a.subarray(1,33),"NS5R letter display");else{let i=c-32;x(e,ge,Date.now()+3200),x(e,W,10),t(e,ie,Ee).fill(0);let s=a.subarray(1),f=4;s.forEach(function(h,l){let u=l+i,m=u>>4,w=u&15;if(u<80){let C=m<f?h:h>>3,M=0,G=m<f?6:3;for(;C>0;)t(e,ie,Ee)[w*32+m*7+(G-M)]=C&1,C=C>>1,M++}})}}).add([66,18,48],(a,n,c)=>{p(0,a)}).add([66,18,49],(a,n,c)=>{p(1,a)}).add([66,18,50],(a,n,c)=>{p(2,a)}).add([66,18,51],(a,n,c)=>{p(3,a)}).add([66,18,52],(a,n,c)=>{p(4,a)}).add([66,18,53],(a,n,c)=>{p(5,a)}).add([66,18,54],(a,n,c)=>{p(6,a)}).add([66,18,55],(a,n,c)=>{p(7,a)}).add([66,52],(a,n)=>{e.switchMode("ns5r",!0),x(e,N,!1);let c="";pe(a,(i,s)=>{s<8?(i>31&&(c+=String.fromCharCode(i)),s==7&&(e.aiEfxName=c)):s<10&&(e.setEffectType(s-8,44,i),e.dispatchEvent(`efx${["reverb","chorus"][s-8]}`,e.getEffectType(s-8)))})}).add([66,53],(a,n)=>{e.switchMode("ns5r",!0),x(e,N,!1);let c="",i=a[a.length-1],s=a.subarray(0,a.length-1),f=Te(s);f!=i&&(console.info(`NS5R current multi dump checksum mismatch! Expected ${f}, got ${i}.`),console.debug(a)),pe(s,function(h,l){switch(!0){case l<2944:{let u=e.chRedir(Math.floor(l/92),n,!0),m=u*E.cc;switch(l%92){case 0:{t(e,g)[m+y[0]]=h,e.dispatchEvent("voice",{part:u});break}case 1:{t(e,g)[m+y[32]]=h,!h&&!t(e,g)[m+y[0]]&&(t(e,g)[m+y[0]]=pt.bank0),e.dispatchEvent("voice",{part:u});break}case 2:{t(e,U)[u]=h,h>0&&e.setChActive(u,1),e.dispatchEvent("voice",{part:u});break}case 3:{let w=e.chRedir(h,n,!0);t(e,K)[u]=w,u!=w&&(console.info(`NS5R CH${u+1} receives from CH${w+1}.`),e.buildRchTree());break}case 7:{t(e,O)[u]=h,e.dispatchEvent("voice",{part:u});break}case 8:{t(e,R)[u*E.rpn+3]=h<40||h>88?h+(h>63?-192:64):h,t(e,L)[E.rpnt*u+2]=1;break}case 9:case 10:{t(e,g)[m+y[7]]=h;break}case 11:{t(e,g)[m+y[11]]=h;break}case 14:{t(e,g)[m+y[10]]=h||128;break}case 19:{t(e,g)[m+y[93]]=h;break}case 20:{t(e,g)[m+y[91]]=h;break}case 84:{t(e,g)[m+y[65]]=h;break}case 85:{t(e,g)[m+y[5]]=h;break}}break}case l<3096:break;case l<3134:{let u=l-3096;u<8?(h>31&&(c+=String.fromCharCode(h)),u==7&&(e.aiEfxName=c)):u<10&&(e.setEffectType(u-8,44,h),e.dispatchEvent(`efx${["reverb","chorus"][u-8]}`,e.getEffectType(u-8)));break}case l<8566:break}})}).add([66,54],(a,n)=>{e.switchMode("ns5r",!0);let c="",i=80,s=0,f=0,h="MSB\tPRG\tLSB\tNME";pe(a,function(l,u){let m=u%158;switch(!0){case m<10:{l>31&&(c+=String.fromCharCode(l));break}case m==10:break;case m==11:{i=l&127;break}case m==12:{f=l&127;break}case m==13:{h+=`
${i}	${s}	${f}	${c.trim().replace("Init Voice","")}`,s++,c="";break}}}),e.userBank.clearRange({msb:80,lsb:0}),e.userBank.load(h),A()&&console.debug(h),e.forceVoiceRefresh()}).add([66,55],(a,n)=>{e.switchMode("ns5r",!0);let c="",i=88,s=0,f=0,h="MSB\tPRG\tLSB\tNME";pe(a,function(l,u){let m=u%126;switch(!0){case m<10:{l>31&&(c+=String.fromCharCode(l));break}case m==11:break;case m==12:break;case m==13:{h+=`
${i}	${s}	${f}	${c.trim().replace("Init Combi","")}`,s++,c="";break}}}),e.userBank.clearRange({msb:88,lsb:0}),e.userBank.load(h),A()&&console.debug(h),e.forceVoiceRefresh()}).add([66,125],a=>{e.dispatchEvent("backlight",["green","orange","red",!1,"yellow","blue","purple"][a[0]]||"white")}).add([66,127],a=>{let n=a[a.length-1],c=a.subarray(0,a.length-1),i=Te(c);i!=n&&(console.info(`NS5R screen dump checksum mismatch! Expected ${i}, got ${n}.`),console.debug(a));let s=new Uint8Array(5760);pe(a,(f,h,l)=>{if(h<720)for(let u=0;u<8;u++)s[h*8+u]=f>>7-u&1}),e.dispatchEvent("screen",{type:"ns5r",data:s})}).add([76],(a,n,c)=>{t(e,ke).run([66,...a],n,c)}),t(this,Ve).add([16,0,8,0],(a,n,c)=>{let i=(a[2]<<4)+a[3],s="K11 ";([()=>{e.switchMode("k11",!0),x(e,N,!1),x(e,oe,i?4:0),console.info("MIDI reset: GMega/K11")},()=>{e.setEffectType(0,24,i),console.debug(`${s}reverb type: ${i}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{console.debug(`${s}reverb time: ${i}`)},()=>{console.debug(`${s}reverb time: ${i}`)},()=>{console.debug(`${s}reverb predelay: ${i}`)},()=>{console.debug(`${s}reverb predelay: ${i}`)},()=>{console.debug(`${s}depth high: ${i}`)},()=>{console.debug(`${s}depth high: ${i}`)},()=>{console.debug(`${s}depth low: ${i}`)},()=>{console.debug(`${s}depth low: ${i}`)}][a[0]]||(()=>{}))()}).add([16,0,8,1],(a,n,c)=>{let i=e.chRedir(a[1],n,!0),s=E.cc*i,f=E.rpn*i,h=(a[3]<<4)+a[4],l=`K11 CH${i+1} `;([()=>{h<128?(e.setChType(i,e.CH_MELODIC,T.k11),t(e,g)[s+y[0]]=0,t(e,U)[i]=h):(e.setChType(i,e.CH_DRUMS,T.k11),t(e,U)[i]=h-128),e.dispatchEvent("voice",{part:i})},()=>{let u=e.chRedir(h,n,!0);t(e,K)[i]=u,i!=u&&(e.buildRchTree(),console.info(`${l}receives from CH${u+1}`))},()=>{t(e,g)[s+y[7]]=h},()=>{uupThis.setChActive(i,h)},()=>{t(e,g)[s+y[10]]=h},()=>{t(e,R)[f+3]=h+40,t(e,L)[E.rpnt*i+2]=1},()=>{t(e,R)[f+1]=h>>1,t(e,R)[f+2]=h&1,t(e,L)[E.rpnt*i+1]=1},()=>{t(e,g)[s+y[91]]=h?127:0},()=>{},()=>{t(e,g)[s+y[74]]=h},()=>{t(e,g)[s+y[73]]=h},()=>{t(e,g)[s+y[72]]=h}][a[0]]||(()=>{}))()}).add([16,0,9,0],(a,n,c)=>{let i=(a[2]<<4)+a[3],s="GMLX ";([()=>{console.debug(`${s}reverb type: ${i}`)},()=>{console.debug(`${s}reverb time: ${i}`)},()=>{console.debug(`${s}reverb predelay: ${i}`)},()=>{console.debug(`${s}depth high: ${i}`)},()=>{console.debug(`${s}depth low: ${i}`)}][a[0]]||(()=>{}))()}).add([16,0,9,3],(a,n,c)=>{let i=(a[2]<<4)+a[3],s=e.chRedir(a[1],n,!0),f=s*E.cc;[()=>{i<128?(e.setChType(s,e.CH_MELODIC,T.k11),t(e,g)[f+y[0]]=0,t(e,g)[f+y[32]]=0,t(e,U)[s]=i):i<160?(e.setChType(s,e.CH_MELODIC,T.k11),t(e,g)[f+y[0]]=0,t(e,g)[f+y[32]]=7,t(e,U)[s]=i-100):(e.setChType(s,e.CH_DRUMS,T.k11),t(e,g)[f+y[0]]=122,t(e,g)[f+y[32]]=0,t(e,U)[s]=i-160),e.dispatchEvent("voice",{part:s})},()=>{let h=e.chRedir(i,n,!0);t(e,K)[s]=h,s!=h&&(e.buildRchTree(),console.info(`GMLX CH${s+1} receives from CH${h+1}`))}][a[0]]()}).add([16,0,9,4],(a,n,c)=>{let i=(a[2]<<4)+a[3],s=e.chRedir(a[1],n,!0),f=s*E.cc,h=s*E.rpn,l=`GMLX CH${s+1} `;[()=>{e.setChActive(s,i)},()=>{t(e,g)[f+y[7]]=i},()=>{t(e,g)[f+y[10]]=i},()=>{t(e,g)[f+y[91]]=i?127:0},()=>{t(e,R)[h+3]=i+40,t(e,L)[E.rpnt*s+2]=1},()=>{t(e,R)[h+1]=i,t(e,L)[E.rpnt*s+1]=1},()=>{t(e,R)[h]=i,t(e,L)[E.rpnt*s]=1},()=>{}][a[0]]()}),t(this,Fe).add([66,93,64],(a,n,c)=>{let i=a[2];switch(a[0]){case 0:{switch(a[1]){case 4:{x(e,B,i*129/16383*100),e.dispatchEvent("mastervolume",t(e,B));break}case 5:{i-64;break}case 6:{console.debug(`SG global reverb: ${i?"on":"off"}`);break}case 127:{e.switchMode("sg",!0);break}}break}case 1:{switch(a[1]){case 48:{console.debug(`SG reverb type: ${At[i]}`);break}}break}default:if(a[0]>>4==1){let s=e.chRedir(a[0]&15,n,!0);if(a[1]==2){let f=e.chRedir(i,n,!0);t(e,K)[s]=f,s!=f&&(e.buildRchTree(),console.info(`SG CH${s+1} receives from CH${f+1}`))}else a[1]==19&&(t(e,g)[E.cc*s+y[7]]=i)}else console.warn(`Unknown AKAI SG SysEx: ${a}`)}}),t(this,Ke).add([9],(a,n,c)=>{console.debug(`GZ set effect: ${["stage reverb","hall reverb","room reverb","chorus","tremelo","phaser","rotary speaker","enhancer","flanger","EQ"][a[0]]||"off"}`)}),t(this,se).add([127,0],(a,n,c)=>{e.switchMode("motif");let i=new Uint8Array([127,1,...a]);t(e,se).run(i,n,c)}).add([127,1,0,0],(a,n,c)=>{e.switchMode("s90es");let i="S90/Motif ES system ",s=a[0];a.subarray(1).forEach((f,h)=>{([()=>{x(e,B,f*12900/16383),e.dispatchEvent("mastervolume",t(e,B))}][s+h]||(()=>{console.info(`Unrecognized ${i}ID: ${s+h}`)}))()})}).add([127,1,0,0,14],(a,n,c)=>{e.switchMode("s90es");let i="S90/Motif ES bulk header ",s=[];s[95]=(f,h,l)=>{console.debug(`${i}multi edit buffer: ${f[1]}`)},(s[a[0]]||(()=>{console.info(`Unrecognized ${i}ID: ${a[0]}.`)}))(a.subarray(1))}).add([127,1,0,0,15],(a,n,c)=>{e.switchMode("s90es");let i="S90/Motif ES bulk footer ",s=[];s[95]=(f,h,l)=>{console.debug(`${i}multi edit buffer: ${f[1]}`)},(s[a[0]]||(()=>{console.info(`Unrecognized ${i}ID: ${a[0]}.`)}))(a.subarray(1))}).add([127,1,0,58,55],(a,n,c)=>{e.switchMode("s90es");let i=e.chRedir(a[0],n,!0),s=E.cc*i,f=a[1],h=`S90/Motif ES bulk CH${i<16?i+1:"U"+(i-95)} `;console.debug(h,a),!(a[0]>15)&&a.subarray(2).forEach((l,u)=>{([()=>{t(e,g)[s+y[0]]=l,e.dispatchEvent("voice",{part:i})},()=>{l&&e.setChActive(i,1),t(e,g)[s+y[32]]=l,e.setChType(i,[32,40].indexOf(l)>-1?e.CH_DRUMS:e.CH_MELODIC,t(e,P),!0),e.dispatchEvent("voice",{part:i})},()=>{l&&e.setChActive(i,1),t(e,U)[i]=l,e.dispatchEvent("voice",{part:i})},()=>{let m=e.chRedir(l,n,!0);t(e,K)[i]=m,i!=m&&(e.buildRchTree(),console.info(`${h}receives from CH${m+1}`))},()=>{t(e,ee)[i]=l?0:1},!1,!1,!1,!1,!1,!1,!1,!1,()=>{t(e,g)[s+y[7]]=l},()=>{t(e,g)[s+y[10]]=l},!1,!1,!1,()=>{t(e,g)[s+y[91]]=l},()=>{t(e,g)[s+y[93]]=l},()=>{t(e,g)[s+y[94]]=l},()=>{t(e,g)[s+y[128]]=l},()=>{},()=>{t(e,g)[s+y[74]]=l},()=>{t(e,g)[s+y[71]]=l},!1,()=>{t(e,g)[s+y[65]]=l},()=>{t(e,g)[s+y[5]]=l},()=>{}][f+u]||(()=>{}))()})}).add([127,1,54,16],(a,n,c)=>{e.switchMode("s90es");let i=a[0];a.subarray(1).forEach((s,f)=>{let l=`S90/Motif ES EQ${(f>>2)+1} `;([()=>{let u=s-64},()=>{let u=et[s]},()=>{let u=s/10},()=>{let u=s}][i+f&3]||(()=>{}))()})}),t(this,le).add([0,72,18,0,0,0,0],(a,n,c)=>{e.switchMode("sd",!0),console.info("MIDI reset: SD")}).add([0,72,18,16,0],(a,n,c)=>{let i=a[0]>>5,s=a[0]&31;switch(i){case 0:{let f=a[0]>>1,h=a[1];switch(f){case 1:{a.subarray(2).forEach((l,u,m)=>{let w=u+h;switch(w){case 0:{l&&(e.setEffectType(1,60,l-1),e.dispatchEvent("efxchorus",e.getEffectType(1)),console.debug(`SD MFX Cho: ${w} - ${l}`));break}}});break}case 2:{a.subarray(2).forEach((l,u)=>{let m=u+h;switch(m){case 0:{l&&(e.setEffectType(0,55+l,0),e.dispatchEvent("efxreverb",e.getEffectType(0)),console.debug(`SD MFX Rev: ${m} - ${l}`));break}}});break}case 3:case 4:case 5:{let l=f-1;a.subarray(2).forEach((u,m)=>{let w=m+h;switch(console.debug(`SD MFX ${l-2}: ${w} - ${u}`),w){case 0:{e.setEffectTypeRaw(l,62,u),e.dispatchEvent(`efx${l>2?"delay":"insert"+(l-4)}`,e.getEffectType(l));break}}}),console.debug(`SD MFX message:
%o`,a);break}default:console.debug(`Unknown SD-90 global effects message:
%o`,a)}break}case 1:{let f=e.chRedir(s,n,!0),h=a[1],l=f*E.cc;a.subarray(2).forEach((u,m)=>{let w=h+m;w<37?([()=>{},()=>{},0,()=>{},()=>{switch(t(e,g)[l+y[0]]=u,u){case 104:case 105:case 106:case 107:case 120:{t(e,O)[f]||e.setChType(f,e.CH_DRUMS);break}default:t(e,O)[f]&&e.setChType(f,e.CH_MELODIC)}e.dispatchEvent("voice",{part:f})},()=>{t(e,g)[l+y[32]]=u,e.dispatchEvent("voice",{part:f})},()=>{t(e,U)[f]=u,e.dispatchEvent("voice",{part:f})},()=>{t(e,g)[l+y[7]]=u},()=>{t(e,g)[l+y[10]]=u},()=>{},()=>{},()=>{u<2&&(t(e,ee)[f]=u)},()=>{u<2&&(t(e,g)[l+y[68]]=u?127:0)},()=>{},()=>{u<2&&(t(e,g)[l+y[65]]=u?127:0)},()=>{t(e,g)[l+y[5]]=u&15<<4|t(e,g)[l+y[5]]&15},()=>{t(e,g)[l+y[5]]=u&15|(t(e,g)[l+y[5]]&240)>>4},()=>{t(e,g)[l+y[74]]=u},()=>{t(e,g)[l+y[71]]=u},()=>{t(e,g)[l+y[73]]=u},()=>{t(e,g)[l+y[72]]=u},0,0,0,0,0,0,0,()=>{t(e,g)[l+y[128]]=u},()=>{t(e,g)[l+y[93]]=u},()=>{t(e,g)[l+y[91]]=u},0,0,()=>{t(e,g)[l+y[75]]=u},()=>{t(e,g)[l+y[76]]=u},()=>{t(e,g)[l+y[77]]=u},()=>{t(e,g)[l+y[78]]=u}][w]||(()=>{}))():w<63||(w<64?(t(e,O)[f]?t(e,g)[l+y[0]]=104|u:t(e,g)[l+y[0]]=96|u,e.dispatchEvent("voice",{part:f})):console.debug(`Unknown SD-90 global CH${f+1} param setup message:
%o`,a))});break}case 2:{let f=e.chRedir(s,n,!0),h=a[1];console.debug(`Unknown SD-90 global CH${f+1} MIDI setup message:
%o`,a.subarray(2));break}default:console.warn(`Unknown SD-90 global part setup message:
%o`,a)}})}chRedir(e,r,d){if(t(this,Ae)[r])return(t(this,Ae)[r]-1)*16+e;if([2,3].indexOf(t(this,oe))>-1){if(d==1)return e;let o=0,p=!0;for(;p;)t(this,we)[e+o]==0?(t(this,we)[e+o]=r,console.debug(`Assign track ${r} to channel ${e+o+1}.`),p=!1):t(this,we)[e+o]==r?p=!1:(o+=16,o>=128&&(o=0,p=!1));return e+o}else return e}forceVoiceRefresh(){for(let e=0;e<E.ch;e++)t(this,me)[e]&&this.dispatchEvent("voice",{part:e})}buildRchTree(){let e=[];t(this,K).forEach((r,d)=>{var o;r<E.ch&&((o=e[r])!=null&&o.constructor||(e[r]=[]),e[r].push(d))}),x(this,Et,e)}buildRccMap(){let e=this;for(let r=0;r<E.ch;r++)t(e,He)[r]={};t(e,Be).forEach((r,d)=>{r&&(t(e,He)[Math.floor(d/E.redir)][r]=d%E.redir|128)}),A()&&console.debug(t(e,He))}getActive(){return t(this,me)}getCc(e){let r=e*E.cc,d=t(this,g).subarray(r,r+E.cc);return d[y[0]]=d[y[0]]||t(this,Re),d[y[32]]=d[y[32]]||t(this,oe),d[y[0]]==pt.bank0&&(d[y[0]]=0),d}getCcCh(e,r){if(bt.indexOf(r)<0)throw new Error("CC number not accepted");return t(this,g)[E.cc*e+y[r]]}getCcAll(){let e=t(this,g).slice();for(let r=0;r<E.ch;r++){let d=r*E.cc;e[d+y[0]]=e[d+y[0]]||t(this,Re),e[d+y[32]]=e[d+y[32]]||t(this,oe),e[y[0]]==pt.bank0&&(e[y[0]]=0)}return e}getChSource(){return t(this,K)}getChType(){return t(this,O)}setChType(e,r,d=t(this,P),o=!1){r&=15,t(this,O)[e]=r,r>0&&!o&&(t(this,g)[e*E.cc+y[0]]=Pe[d])}setChActive(e,r=0){t(this,me)[e]!=r&&this.dispatchEvent("channeltoggle",{part:e,active:r}),t(this,me)[e]=r}getExt(e){let r=E.ext*e,d=t(this,te).subarray(r,r+E.ext),o=new Uint8Array(d.length);return o.set(d),o[1]=o[1]||t(this,xt),o}getPitch(){return t(this,$e)}getProgram(){return t(this,U)}getTexts(){return t(this,re).slice()}getVel(e){let r=new Map,d=this;return t(d,F).forEach(function(o,p){let $=Math.floor(o/128),v=o%128;e==$&&t(d,V)[o]>0&&r.set(v,{v:t(d,V)[o],s:t(d,z)[p]})}),r}getBitmap(){return{bitmap:t(this,ie,Ee),expire:t(this,ge)}}getLetter(){return{text:t(this,De),set:t(this,yt),expire:t(this,Oe)}}getMode(){return be[t(this,P)]}getMaster(){return{volume:t(this,B)}}getRawStrength(){let e=this;return t(this,F).forEach(function(r){let d=Math.floor(r/128);t(e,V)[r]>t(e,ye)[d]&&(t(e,ye)[d]=t(e,V)[r])}),t(this,ye)}getStrength(){let e=[],r=this;return this.getRawStrength().forEach(function(d,o){e[o]=Math.floor(d*t(r,g)[o*E.cc+y[7]]*t(r,g)[o*E.cc+y[11]]*t(r,B)/803288)}),e}getRpn(){return t(this,R)}getNrpn(){return t(this,tt)}getVoice(e,r,d,o){let p=e||t(this,Re),$=r,v=d||t(this,oe);p==pt.bank0&&(p=0),be[t(this,P)]=="ns5r"&&p>0&&p<56&&(v=3);let k=this.userBank.get(p,$,v,o);if(be[t(this,P)]=="mt32"&&k.name.indexOf("MT-m:")==0){let a=parseInt(k.name.slice(5)),n=a*E.cmt,c="";t(this,Me).subarray(n,n+10).forEach(s=>{s>31&&(c+=String.fromCharCode(s))});let i=`MSB	LSB	PRG	NME
0	127	${$}	${c}`;this.userBank.load(i,!0),k.name=c,k.ending=" "}return(k.ending!=" "||!k.name.length)&&(k=this.baseBank.get(p,$,v,o)),k}getChVoice(e){let r=this.getVoice(t(this,g)[e*E.cc+y[0]],t(this,U)[e],t(this,g)[e*E.cc+y[32]],be[t(this,P)]);if(t(this,fe)[e]){let d="";switch(t(this,P)){case T.mt32:{t(this,he).subarray(E.cmt*(e-1),E.cmt*(e-1)+10).forEach(o=>{d+=String.fromCharCode(Math.max(o,32))}),d=d.trimRight();break}default:{let o=E.cvn*e;t(this,gt).subarray(o,o+E.cvn).forEach(p=>{d+=String.fromCharCode(Math.max(p,32))}),d=d.trimRight()}}d.length&&(r.ending="~",r.name=d)}return r}getRawPitch(){return t(this,$e)}getPitchShift(e){let r=this,d=e*E.rpn,o=t(r,R)[d];return t(r,L)[e*E.rpnt]||t(r,P)==T.mt32&&(o=12),t(r,$e)[e]/8192*o+(t(r,R)[d+3]-64)+((t(r,R)[d+1]<<7)+t(r,R)[d+2]-8192)/8192}getEffectType(e=0){let r=3*e+1;return t(this,ae).subarray(r,r+2)}setEffectTypeRaw(e=0,r,d){let o=3*e;t(this,ae)[o]=1,t(this,ae)[o+1+ +r]=d}setEffectType(e=0,r,d){this.setEffectTypeRaw(e,!1,r),this.setEffectTypeRaw(e,!0,d)}getEffectSink(){return t(this,at)}setLetterDisplay(e,r,d=0,o=3200){let p=this,$;x(p,De," ".repeat(d)),e.forEach(v=>{x(p,De,t(p,De)+String.fromCharCode(v>31?v:32)),v<32&&($=$||new Set,$.add(v))}),x(p,yt,Date.now()),x(p,Oe,Date.now()+o),$&&($=Array.from($),$.forEach((v,k,a)=>{a[k]=v.toString(16).padStart(2,"0")}),console.warn(`${r}${r?" ":""}invalid code point${$.length>1?"s":""}: 0x${$.join(", 0x")}`))}setDetectionTargets(e="?",r=0){let d=this,o=-1;switch(e.replaceAll(", ",",").split(",").forEach(p=>{p=p.toLowerCase();let $=be.indexOf(Ba[p]||p);A()&&console.debug(`Mapped mode "${p}" to ID "${$}".`),$>-1&&(o=$)}),A()&&console.debug(`Set detection target to ID "${o}".`),o>0&&(t(d,_).x5=82,t(d,_).ds=T.krs),o){case T["05rw"]:{t(d,_).x5=81;break}case T.s90es:t(d,_).ds=T.s90es;case T.motif:t(d,_).ds=T.motif}}allocateAce(e){if(!e||e<128&&e>95){console.warn(`cc${e} cannot be allocated as an active custom effect.`);return}let r=!0,d=0;for(;r&&d<E.ace;)t(this,ce)[d]==e?r=!1:t(this,ce)[d]||(r=!1,t(this,ce)[d]=e,console.info(`Allocated cc${e} to ACE slot ${d}.`)),d++;d>=E.ace&&console.warn("ACE slots are full.")}releaseAce(e){let r=!0,d=0;for(;r&&d<E.ace;)t(this,ce)[d]==e&&(t(this,ce)[d]=0,r=!1),d++;r&&A()&&console.debug(`No ACE slot was allocated to cc${e}.`)}resetAce(){t(this,ce).fill(0),console.info("All ACE slots have been reset.")}getAce(){return t(this,ce)}getChAce(e,r){if(r<0||r>=E.ace)throw new RangeError("No such ACE slot");let d=t(this,ce)[r];if(d){if(bt.indexOf(d)>=0)return t(this,g)[e*E.cc+y[d]];throw new Error(`Invalid ACE source: ${d}`)}else return 0}initDrums(){let e=this;t(e,j).fill(64);for(let r=0;r<E.drm;r++){let d=r*E.dpn;for(let o in ha){let p=ha[o],$=(d+ne[o])*E.dnc;t(e,j).subarray($,$+E.dnc).fill(p)}}}init(e=0){let r=this;x(r,Re,0),x(r,oe,0),x(r,Ne,0),t(r,me).fill(0),t(r,g).fill(0),t(r,ce).fill(0),t(r,U).fill(0),t(r,V).fill(0),t(r,F).fill(0),t(r,ee).fill(0),t(r,ye).fill(0),t(r,$e).fill(0),t(r,tt).fill(0),t(r,L).fill(0),t(r,te).fill(0),t(r,Be).fill(0),x(r,B,100),x(r,re,[]),x(r,st,500),x(r,it,0),x(r,ge,0),x(r,W,0),t(r,ie,Ee).fill(0),x(r,N,!1),x(r,nt,0),x(r,ue,!0),r.initDrums(),t(r,K).forEach(function(d,o,p){p[o]=o}),e==0&&(r.dispatchEvent("mode","?"),x(r,P,0),t(r,we).fill(0),t(r,Ae).fill(0),x(r,Oe,0),x(r,De,"")),t(r,g)[E.cc*9]=Pe[0],t(r,g)[E.cc*25]=Pe[0],t(r,g)[E.cc*41]=Pe[0],t(r,g)[E.cc*57]=Pe[0],t(r,O).fill(r.CH_MELODIC),t(r,O)[9]=r.CH_DRUM1,t(r,O)[25]=r.CH_DRUM3,t(r,O)[41]=r.CH_DRUMS,t(r,O)[57]=r.CH_DRUMS,t(r,O)[73]=r.CH_DRUM5,t(r,O)[89]=r.CH_DRUM7,t(r,O)[105]=r.CH_DRUMS,t(r,O)[121]=r.CH_DRUMS,t(r,rt).fill(0),t(r,Me).fill(0),t(r,Ce).fill(0),t(r,he).fill(0),t(r,fe).fill(0),t(r,ae).fill(0),t(r,at).fill(0),r.aiEfxName="",r.userBank.clearRange({msb:0,lsb:127,prg:[0,127]});for(let d=0;d<E.ch;d++){let o=d*E.cc;t(r,g)[o+y[7]]=100,t(r,g)[o+y[11]]=127,t(r,g)[o+y[2]]=127,t(r,g)[o+y[10]]=64,t(r,g).subarray(o+y[71],o+y[71]+8).fill(64),t(r,g).subarray(o+y[130],o+y[157]+1).fill(64),t(r,g)[o+y[91]]=40,t(r,g)[o+y[101]]=127,t(r,g)[o+y[100]]=127,t(r,g)[o+y[99]]=127,t(r,g)[o+y[98]]=127;let p=d*E.rpn;t(r,R)[p]=2,t(r,R)[p+1]=64,t(r,R)[p+2]=0,t(r,R)[p+3]=64,t(r,R)[p+4]=0,t(r,R)[p+5]=0;let $=d*E.ext;t(r,te)[$+1]=r.VLBC_BRTHEXPR;let v=d*E.redir;t(r,Be)[v+8]=13}r.buildRchTree(),r.buildRccMap(),r.dispatchEvent("mastervolume",t(r,B)),r.dispatchEvent("efxreverb",r.getEffectType(0)),r.dispatchEvent("efxchorus",r.getEffectType(1)),r.dispatchEvent("efxdelay",r.getEffectType(2)),r.dispatchEvent("efxinsert0",r.getEffectType(3)),r.dispatchEvent("efxinsert1",r.getEffectType(4)),r.dispatchEvent("efxinsert2",r.getEffectType(5)),r.dispatchEvent("efxinsert3",r.getEffectType(6)),r.dispatchEvent("reset"),r.switchMode("?")}switchMode(e,r=!1,d=!1){var $;let o=this,p=be.indexOf(e);if(p>-1){if(t(o,P)==0||r){let v=t(o,P);o.initOnReset&&r&&(this.init(1),v=T["?"]),x(o,P,p),x(o,W,0),x(o,Re,na[0][p]),x(o,oe,na[1][p]);for(let a=0;a<E.ch;a++)t(o,O)[a]>0&&t(o,g)[a*E.cc+y[0]]==Pe[v]&&(t(o,g)[a*E.cc]=Pe[p]);switch(p){case T.mt32:{It.forEach((a,n)=>{let c=n+1;t(o,me)[c]||(t(o,U)[c]=a,t(o,g)[c*E.cc+y[91]]=127)});for(let a=1;a<10;a++)o.dispatchEvent("voice",{part:a});break}}let k;switch(p){case T["?"]:case T.g2:{k=[52,4,52,18,0,0,0,0];break}case T.xg:{k=[1,0,65,0,5,0,0,0];break}case T.gm:case T.gs:{k=[40,4,40,18,40,32,32,0];break}case T.sd:{k=[58,0,60,0,61,0,61,0];break}case T["05rw"]:case T.x5d:case T.ns5r:{k=[44,1,44,19,44,0,44,0];break}case T.k11:case T.sg:{k=[24,0,0,0,0,0,0,0];break}case T.mt32:{k=[40,4,0,0,0,0,0,0];break}default:k=[0,0,0,0,0,0,0,0]}for(let a=0;a<E.efx;a++)!t(o,ae)[3*a]&&($=k[a<<1])!=null&&$.constructor&&(t(o,ae)[3*a+1]=k[2*a],t(o,ae)[3*a+2]=k[2*a+1],o.dispatchEvent(`efx${["reverb","chorus","delay","insert0"][a]}`,o.getEffectType(a)));d&&o.setDetectionTargets(e),o.dispatchEvent("mode",e),o.forceVoiceRefresh()}}else throw new Error(`Unknown mode ${e}`)}newStrength(){t(this,ye).fill(0)}runJson(e){var r;if(e.type>14)return e.type==15&&e.data.constructor!=Uint8Array&&(e.data=Uint8Array.from(e.data)),t(this,vt)[e.type].call(this,e);{let d=this.chRedir(e.part,e.track),o=!1;(r=t(this,Et)[d])==null||r.forEach(p=>{e.channel=p,o=!0,t(this,vt)[e.type].call(this,e)}),o||console.warn(`${ca[e.type]?ca[e.type]:e.type}${[11,12].includes(e.type)?(e.data[0]!=null?e.data[0]:e.data).toString():""} event sent to CH${d+1} without any recipient.`)}t(this,re).length>100&&t(this,re).splice(100,t(this,re).length-99)}runRaw(e){}async loadBank(e,r){let d=this;switch(e=e.toLowerCase(),e){case"s7e":{d.userBank.clearRange({msb:63,lsb:[21,22]}),d.userBank.clearRange({msb:63,lsb:[24,27]});break}default:throw new Error(`Unknown bank format ${e}`)}switch(e){case"s7e":{kt.context=this,d.userBank.load(await kt.read(e,r));break}}d.forceVoiceRefresh()}},P=new WeakMap,W=new WeakMap,ge=new WeakMap,ve=new WeakMap,ie=new WeakSet,Ee=function(){return t(this,ve)[t(this,W)]},ba=function(e){t(this,ve)[t(this,W)]=e},me=new WeakMap,K=new WeakMap,O=new WeakMap,g=new WeakMap,ce=new WeakMap,U=new WeakMap,V=new WeakMap,ee=new WeakMap,F=new WeakMap,z=new WeakMap,$e=new WeakMap,ye=new WeakMap,Ue=new WeakMap,te=new WeakMap,R=new WeakMap,L=new WeakMap,tt=new WeakMap,j=new WeakMap,ae=new WeakMap,at=new WeakMap,Be=new WeakMap,fe=new WeakMap,gt=new WeakMap,Ce=new WeakMap,he=new WeakMap,rt=new WeakMap,Me=new WeakMap,Re=new WeakMap,oe=new WeakMap,_=new WeakMap,B=new WeakMap,Ne=new WeakMap,st=new WeakMap,it=new WeakMap,De=new WeakMap,Oe=new WeakMap,yt=new WeakMap,nt=new WeakMap,ue=new WeakMap,N=new WeakMap,xt=new WeakMap,Et=new WeakMap,He=new WeakMap,Pt=new WeakMap,re=new WeakMap,we=new WeakMap,Ae=new WeakMap,q=new WeakMap,_e=new WeakMap,X=new WeakMap,vt=new WeakMap,St=new WeakMap,Ge=new WeakMap,Xe=new WeakMap,se=new WeakMap,le=new WeakMap,ke=new WeakMap,Ve=new WeakMap,Fe=new WeakMap,Ke=new WeakMap,pa);var Ht=Oa(ga(),1);I();I();var mt,ya,va=(ya=class{constructor(b,e,r,d){S(this,mt,!1);x(this,mt,b),this.start=e,this.end=r,this.data=d}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return t(this,mt)}},mt=new WeakMap,ya),Bt=class extends va{constructor(b,e,r){super(!0,b,e,r)}},ma=class extends va{constructor(b,e){super(!1,b,b,e)}},ze,Ea,Nt=(Ea=class extends Array{constructor(){super(...arguments);S(this,ze,-1)}resetIndex(e){x(this,ze,-1)}fresh(){this.sort(function(e,r){return e.start==r.start?0:(+(e.start>r.start)<<1)-1}),this.forEach(function(e,r){e.index=r})}step(e,r=!1){let d=[];if(r)for(let o=0;o<this.length&&!(this[o].start>e);o++){if(this[o].end<e)continue;d.push(this[o])}else{let o=this.getRange(t(this,ze)==-1?0:e-1,e),p=this;o.forEach(function($){$.index>t(p,ze)&&(d.push($),x(p,ze,$.index))})}return d}getRange(e,r){var v;e>r&&([e,r]=[r,e]);let d=[],o=-1,p=Math.ceil(Math.sqrt(this.length)),$=!0;for(let k=0;k<this.length;k+=p)this[k+p]?o<0&&this[k+p].start>=e&&(o=k):o=o<0?k:o;for(;$;)((v=this[o])==null?void 0:v.end)<r?this[o].start>=e&&d.push(this[o]):$=!1,o++;return d}},ze=new WeakMap,Ea);var Fa=0xffffffffffff,$a=function(b){let e=new Nt,r=this,d=b.timeDivision,o=120,p=new Nt,$=0,v=0;p.push(new Bt(0,Fa,[120,0])),b.track.forEach(function(c){$=0,c.event.forEach(function(i){$+=i.deltaTime,i.type==255&&(i==null?void 0:i.metaType)==81&&(o=6e7/i.data,p[p.length-1]&&p.push(new Bt($,0xffffffffffff,[o,0])))})}),p.fresh(),p.forEach(function(c,i,s){i>0&&(s[i-1].end=c.start)});let k=120;p.forEach(function(c,i,s){i>0&&(c.end==c.start?s.splice(s.indexOf(c),1):k==c.data[0]&&(s[i-1].end=c.end,s.splice(s.indexOf(c),1)),k=c.data[0])});let a=0,n=120;return p.forEach(function(c){let i=c.start,s=i/n/d*60+a;n=c.data[0],a=s-i/n/d*60,c.data[1]=a}),console.debug("All tempo changes: ",p),o=120,$=0,v=0,b.track.forEach(function(c,i){$=0,v=0;let s=i+1;c.event.forEach(function(f,h){$+=f.deltaTime;let l=p.step($,!0)[0];l&&(o=l.data[0],v=l.data[1]);let u={type:f.type,data:f.data,track:s,part:0};f.type>14?u.meta=f.metaType:u.part=f.channel,e.push(new ma($/o/d*60+v,u))})}),e.fresh(),self.midiEvents=e,console.debug(`Parsed a type ${b.formatType} MIDI sequence.`),e};Ht.default.customInterpreter=ia;var H=function(b,e,r){b.addEventListener(r,d=>{e.dispatchEvent(r,d.data)})},qe,Qe,ct,xe,Ye,ot,We,$t,Le,Ie,Q,je,Se,Ze,wa,jr=(wa=class extends wt{constructor(e,r=.5,d=.5){super();D(this,"device");S(this,qe,void 0);S(this,Qe,{});S(this,ct,[]);S(this,xe,"");S(this,Ye,[]);S(this,ot,[]);S(this,We,new Uint8ClampedArray(128));S(this,$t,new Uint8ClampedArray(128));S(this,Le,.5);S(this,Ie,120);S(this,Q,4);S(this,je,4);S(this,Se,0);S(this,Ze,0);D(this,"smoothingAtk",0);D(this,"smoothingDcy",0);let o=this;o.smoothingAtk=r,o.smoothingDcy=d,o.device=e,o.addEventListener("meta",function(p){var $;($=p==null?void 0:p.data)==null||$.forEach(function(v){(t(o,Ye)[v.meta]||console.debug).call(o,v.meta,v.data)})}),H(o.device,o,"mode"),H(o.device,o,"mastervolume"),H(o.device,o,"channelactive"),H(o.device,o,"channelmin"),H(o.device,o,"channelmax"),H(o.device,o,"channelreset"),H(o.device,o,"channeltoggle"),H(o.device,o,"screen"),H(o.device,o,"metacommit"),H(o.device,o,"voice"),H(o.device,o,"pitch"),H(o.device,o,"note"),H(o.device,o,"reset"),H(o.device,o,"efxreverb"),H(o.device,o,"efxchorus"),H(o.device,o,"efxdelay"),H(o.device,o,"efxinsert0"),H(o.device,o,"efxinsert1"),H(o.device,o,"efxinsert2"),H(o.device,o,"efxinsert3"),H(o.device,o,"partefxtoggle"),o.addEventListener("note",function({data:p}){t(o,ot).push(p)}),t(o,Ye)[3]=function(p,$){var v;((v=t(o,xe))==null?void 0:v.length)<1&&(x(o,xe,$),o.dispatchEvent("title",t(o,xe)))},t(o,Ye)[81]=function(p,$){let v=o.noteProgress,k=t(o,Le)||.5;x(o,Ie,6e7/$),x(o,Le,$/1e6),x(o,Se,t(o,Se)+(v*(k/t(o,Le))-v)),o.dispatchEvent("tempo",t(o,Ie))},t(o,Ye)[88]=function(p,$){let v=o.noteProgress,k=o.noteOverall,a=o.noteBar,n=o.noteBeat,c=t(o,Q),i=t(o,je);x(o,Q,$[0]),x(o,je,1<<$[1]);let s=24*(32/$[3])/$[2];if(c!=t(o,Q)){let f=a;x(o,Se,t(o,Se)-f*(t(o,Q)-c)),n+1>=c&&(c<t(o,Q)?x(o,Se,t(o,Se)-Math.ceil(t(o,Q)-n-1)):x(o,Se,t(o,Se)+t(o,Q)))}o.dispatchEvent("tsig",o.getTimeSig())}}reset(){var r;let e=this;e.dispatchEvent("reset"),(r=t(e,qe))==null||r.resetIndex(),e.device.init(),x(e,xe,""),x(e,Le,.5),x(e,Ie,120),x(e,Q,4),x(e,je,4),x(e,Se,0),x(e,Ze,0),e.dispatchEvent("tempo",t(e,Ie)),e.dispatchEvent("title",t(e,xe))}init(){this.reset(),x(this,qe,void 0)}async loadFile(e){x(this,qe,$a(Ht.default.parse(new Uint8Array(await e.arrayBuffer()))))}async loadMap(e,r){let d=this,o=0,p=0,$=0,v,k;e.split(`
`).forEach((a,n)=>{if(!a)return;let c=a.split("\t");if(n){if(!$)return;let i="",s="";c.forEach((f,h)=>{switch(h){case v:{i=f;break}case k:{s=f;break}}}),!t(d,Qe)[i]||r?(t(d,Qe)[i]=s,o++):self.debugMode&&console.debug(`Voice "${s}" (${i}) seems to be in conflict with (${t(d,Qe)[i]}).`),p++}else c.forEach((i,s)=>{switch(i){case"ID":{v=s,$++;break}case"Name":{k=s,$++;break}default:console.debug(`Unknown map field: ${i}`)}})}),console.debug(`Voice names: ${p} total, ${o} loaded.`),d==null||d.device.forceVoiceRefresh()}async loadEfx(e,r){let d=this,o=0,p=0,$,v,k;e.split(`
`).forEach((a,n)=>{if(a)if(n){let c=0,i;a.split("\t").forEach((s,f)=>{switch(f){case $:{c|=parseInt(s,16)<<8;break}case v:{c|=parseInt(s,16);break}case k:{i=s;break}}}),!t(d,ct)[c]||r?(t(d,ct)[c]=i,o++):self.debugMode&&console.debug(`EFX ID 0x${c.toString(16).padStart(4,"0")} (${i}) seems to be in conflict.`),p++}else a.split("\t").forEach((c,i)=>{switch(c){case"MSB":{$=i;break}case"LSB":{v=i;break}case"Name":{k=i;break}default:console.debug(`Unknown EFX field: ${c}`)}})}),console.debug(`EFX: ${p} total, ${o} loaded.`),d.dispatchEvent("efxreverb",d.device.getEffectType(0)),d.dispatchEvent("efxchorus",d.device.getEffectType(1)),d.dispatchEvent("efxdelay",d.device.getEffectType(2)),d.dispatchEvent("efxinsert0",d.device.getEffectType(3)),d.dispatchEvent("efxinsert1",d.device.getEffectType(4)),d.dispatchEvent("efxinsert2",d.device.getEffectType(5)),d.dispatchEvent("efxinsert3",d.device.getEffectType(6))}switchMode(e,r=!1){this.device.switchMode(e,r)}getMode(){return this.device.getMode()}getVoice(){return this.device.getVoice(...arguments)}getChVoice(e){return this.device.getChVoice(e)}getMapped(e){return t(this,Qe)[e]||e}getEfx([e,r]){let d=e<<8|r;return t(this,ct)[d]||`0x${d.toString(16).padStart(4,"0")}`}get noteProgress(){return t(this,Ze)/t(this,Le)}get noteOverall(){return this.noteProgress-t(this,Se)}get noteBar(){return Math.floor(this.noteOverall/t(this,Q))}get noteBeat(){let e=this.noteOverall%t(this,Q);return e<0&&(e+=t(this,Q)),e}getTimeSig(){return[t(this,Q),t(this,je)]}getTempo(){return t(this,Ie)}sendCmd(e){this.device.runJson(e)}render(e){var w;e>t(this,Ze)&&x(this,Ze,e);let r=((w=t(this,qe))==null?void 0:w.step(e))||[],d=0,o=new Set,p={},$=[],v=this,k=[];for(v.device.getStrength().forEach((C,M)=>{t(v,$t)[M]=C}),v.device.newStrength(),r.forEach(function(C){let M=C.data,G=v.device.runJson(M);switch(G==null?void 0:G.reply){case"meta":{k.push(G);break}}G!=null&&G.reply&&delete G.reply});t(v,ot).length>0;){let C=t(v,ot).shift(),M=C.part<<7|C.note;C.state?(o.add(M),p[M]=C.velo):o.has(M)&&($.push({part:C.part,note:C.note,velo:p[M],state:v.device.NOTE_SUSTAIN}),d++)}(k==null?void 0:k.length)>0&&v.dispatchEvent("meta",k);let a=v.device.getActive(),n=[],c=v.device.getPitch(),i=v.device.getCcAll(),s=v.device.getProgram(),f=v.device.getChType(),h=[],l=v.device.getStrength();l.forEach(function(C,M,G){G[M]=Math.max(t(v,$t)[M],C);let lt=G[M]-t(v,We)[M],_t=y.length*M;if(lt>=0){let Ct=4*.25**(i[_t+y[73]]/64);t(v,We)[M]+=Math.ceil(lt-lt*v.smoothingAtk**Ct)}else{let Ct=4*.25**(i[_t+y[72]]/64);t(v,We)[M]+=Math.floor(lt-lt*v.smoothingDcy**Ct)}});let u=0;return a.forEach(function(C,M){C&&(n[M]=v.device.getVel(M),h[M]=v.device.getExt(M),u+=n[M].size)}),{extraPoly:d,extraNotes:$,curPoly:u,chInUse:a,chKeyPr:n,chPitch:c,chProgr:s,chContr:i,chType:f,chExt:h,eventCount:r.length,title:t(v,xe),bitmap:v.device.getBitmap(),letter:v.device.getLetter(),texts:v.device.getTexts(),master:v.device.getMaster(),mode:v.device.getMode(),strength:t(v,We).slice(),velo:l,rpn:v.device.getRpn(),tSig:v.getTimeSig(),tempo:v.getTempo(),noteBar:v.noteBar,noteBeat:v.noteBeat,ace:v.device.getAce(),rawVelo:v.device.getStrength(),rawPitch:v.device.getRawPitch(),efxSink:v.device.getEffectSink()}}},qe=new WeakMap,Qe=new WeakMap,ct=new WeakMap,xe=new WeakMap,Ye=new WeakMap,ot=new WeakMap,We=new WeakMap,$t=new WeakMap,Le=new WeakMap,Ie=new WeakMap,Q=new WeakMap,je=new WeakMap,Se=new WeakMap,Ze=new WeakMap,wa);export{jr as RootDisplay,y as ccToPos,ne as dnToPos};