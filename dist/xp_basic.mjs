var Pr=Object.create;var At=Object.defineProperty;var Rr=Object.getOwnPropertyDescriptor;var Dr=Object.getOwnPropertyNames;var Or=Object.getPrototypeOf,Ar=Object.prototype.hasOwnProperty;var Ir=(g,e,a)=>e in g?At(g,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):g[e]=a;var zt=(g,e)=>()=>(g&&(e=g(g=0)),e);var Lr=(g,e)=>()=>(e||g((e={exports:{}}).exports,e),e.exports);var Ur=(g,e,a,h)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Dr(e))!Ar.call(g,n)&&n!==a&&At(g,n,{get:()=>e[n],enumerable:!(h=Rr(e,n))||h.enumerable});return g};var Br=(g,e,a)=>(a=g!=null?Pr(Or(g)):{},Ur(e||!g||!g.__esModule?At(a,"default",{value:g,enumerable:!0}):a,g));var P=(g,e,a)=>(Ir(g,typeof e!="symbol"?e+"":e,a),a),qt=(g,e,a)=>{if(!e.has(g))throw TypeError("Cannot "+a)};var t=(g,e,a)=>(qt(g,e,"read from private field"),a?a.call(g):e.get(g)),T=(g,e,a)=>{if(e.has(g))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(g):e.set(g,a)},x=(g,e,a,h)=>(qt(g,e,"write to private field"),h?h.call(g,a):e.set(g,a),a);var Wt=zt(()=>{"use strict";U();(function(){var g=function(v,k,r){var o,l;if(self.MessageEvent)switch(v){case"message":{l=new MessageEvent(v,{data:k,ports:r==null?void 0:r.ports}),Object.defineProperty(l,"source",{value:r==null?void 0:r.source});break}default:l=new Event(v)}else l=document.createEvent("Event"),l.initEvent(v,!1,!1),r&&v=="message"&&(l.data=k,r.source&&Object.defineProperty(l,"source",{value:r.source}),(o=r.ports)!=null&&o.length&&Object.defineProperty(l,"ports",{value:r.ports}));return l};self.BroadcastChannel?console.info("[Snowy] Snowy is disabled."):(console.info("[Snowy] Snowy is enabled. Path: ".concat(self.SNOWY_PATH||"/snowy.js")),a=[],h={},n=function(v){var k,r=this;if((this==null?void 0:this.constructor)!=n)throw new TypeError("Illegal constructor");a.push(this),(k=h[v])!=null&&k.constructor||(h[v]=[]),h[v].push(this);var o=Math.floor(Math.random()*281474976710656),l=[],i=0,s=[],c=!0,d=!1;Object.defineProperty(this,"id",{get:function(){return o}}),Object.defineProperty(this,"name",{value:v}),this.close=function(){var f,$=a.indexOf(r);$>-1?(e.postMessage({t:"d",c:v,i:o}),a.splice($,1),(f=h[v])!=null&&f.constructor&&($=h[v].indexOf(r),$>-1&&h[v].splice($,1)),h[v].length||delete h[v],console.debug("[Snowy] BroadcastChannel closed."),d=!0):console.debug("[Snowy] BroadcastChannel already closed.")},this.postMessage=function(f){if(e){if(d)throw new Error("Channel already closed");e.postMessage({t:"m",c:v,i:o,m:i,d:f}),i++,i>4294967295&&(i=0)}else s.push(f),console.debug("[Snowy] Message is cached.")},this.flush=function(){if(e){if(c){for(e.postMessage({t:"r",c:v,i:o}),console.debug("[Snowy] ".concat(s.length," message(s) in cache."));s.length;){var f=s.shift();r.postMessage(f)}c=!1,console.debug("[Snowy] All cached messages are flushed away.")}}else throw new Error("Tried to flush when the ports are not ready")},this.receiveMessage=function(f){f.c==v?f.i!=o&&r.dispatchEvent(g("message",f.d,{source:r})):console.debug("[Snowy] Channel ID mismatch. Instance ".concat(o," receives from ").concat(v,", not ").concat(f.c,"."))};var u={};this.dispatchEvent=function(f){var $,w;if(Object.defineProperty(f,"target",{value:r}),Object.defineProperty(f,"currentTarget",{value:r}),($=u[f.type])!=null&&$.length)for(var C=u[f.type],M=0;M<C.length;M++)((w=C[M])==null?void 0:w.constructor)==Function&&C[M].call(r,f);r["on".concat(f.type)]&&r["on".concat(f.type)].constructor==Function&&r["on".concat(f.type)].call(r,f)},this.addEventListener=function(f,$){var w;(w=u[f])!=null&&w.constructor||(u[f]=[]);var C=u[f].indexOf($);C==-1&&u[f].push($)},this.removeEventListener=function(f,$){var w,C;if((w=u[f])!=null&&w.length){var M=u[f].indexOf($);M>-1&&u[f].splice(M,1)}!((C=u[f])!=null&&C.length)&&u[f].constructor&&delete u[f]}},self.BroadcastChannel=n,p=function(){if(e){e.addEventListener("message",function(k){var r=k.data,o=!1;switch(r.t){case"k":{o=!1,e.postMessage({t:"k"});break}case"m":{var l=h[r.c];if(l!=null&&l.length)for(var i=0;i<l.length;i++)l[i].receiveMessage(r);break}case"c":{for(var s=[],c=0;c<a.length;c++){var d=a[c].name;s.indexOf(d)<0&&s.push(d)}e.postMessage({t:"k",c:s});break}default:o=!0}o&&console.info("ReceiveBroadcast",r)});for(var v=0;v<a.length;v++)a[v].flush()}else throw new Error("Message port isn't yet ready");console.info("[Snowy] Snowy is active.")},y=function(){if(!e){var v=new SharedWorker(self.SNOWY_PATH||"/snowy.js");v.port.start();var k=function(r){r.data.t=="swc"&&(v.port.removeEventListener("message",k),e=v.port,e.postMessage({t:"k"}),p())};v.port.addEventListener("message",k)}},y());var e,a,h,n,p,y})()});var U=zt(()=>{"use strict";Wt();{let g=function(e,a){let h=new FileReader;return new Promise((n,p)=>{switch(h.addEventListener("abort",()=>{p(new Error("Blob read aborted"))}),h.addEventListener("error",y=>{p(h.error||y.data||new Error("Blob read error"))}),h.addEventListener("load",()=>{n(h.result)}),a.toLowerCase()){case"arraybuffer":case"buffer":{h.readAsArrayBuffer(e);break}case"string":case"text":{h.readAsText(e);break}default:p(new Error(`Unknown target ${a}`))}})};Blob.prototype.arrayBuffer=Blob.prototype.arrayBuffer||function(){return g(this,"buffer")},Blob.prototype.text=Blob.prototype.text||function(){return g(this,"text")}}String.prototype.replaceAll=String.prototype.replaceAll||function(g,e){let a=0,h=16,n=this,p=[];for(;a<h&&n.lastIndexOf(g)>-1;){let y=n.lastIndexOf(g);p.unshift(n.slice(y+g.length)),n=n.slice(0,y),y==0&&p.unshift(""),a++}return n.length&&p.unshift(n),p.join(e)||""},String.prototype.padStart=String.prototype.padStart||function(g,e){if(e){let a=this;for(;a.length<g;)a=`${e}${a}`;return a}},String.prototype.padEnd=String.prototype.padEnd||function(g,e){if(e){let a=this;for(;a.length<g;)a+=e;return a}}});var wr=Lr((Ga,Xt)=>{U();(function(){"use strict";let g={fatal:!0},e=[new TextDecoder("iso-8859-15",g),new TextDecoder("sjis",g),new TextDecoder("euc-jp",g),new TextDecoder("utf-8",g),new TextDecoder("utf-16",g),new TextDecoder("ascii")],a={debug:!1,parse:function(h,n){if(h instanceof Uint8Array)return a.Uint8(h);if(typeof h=="string")return a.Base64(h);if(h instanceof HTMLElement&&h.type==="file")return a.addListener(h,n);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(h,n){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(h===void 0||!(h instanceof HTMLElement)||h.tagName!=="INPUT"||h.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;n=n||function(){},h.addEventListener("change",function(p){if(!p.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let y=new FileReader;y.readAsArrayBuffer(p.target.files[0]),y.onload=function(v){n(a.Uint8(new Uint8Array(v.target.result)))}})},Base64:function(h){let n=function(v){var k="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(v=v.replace(/^.*?base64,/,""),v=String(v).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(v))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");v+="==".slice(2-(3&v.length));let r,o="",l,i,s=0;for(;s<v.length;)r=k.indexOf(v.charAt(s++))<<18|k.indexOf(v.charAt(s++))<<12|(l=k.indexOf(v.charAt(s++)))<<6|(i=k.indexOf(v.charAt(s++))),o+=l===64?String.fromCharCode(r>>16&255):i===64?String.fromCharCode(r>>16&255,r>>8&255):String.fromCharCode(r>>16&255,r>>8&255,255&r);return o}(h=String(h));var p=n.length;let y=new Uint8Array(new ArrayBuffer(p));for(let v=0;v<p;v++)y[v]=n.charCodeAt(v);return a.Uint8(y)},Uint8:function(y){let n={data:null,pointer:0,movePointer:function(l){return this.pointer+=l,this.pointer},readInt:function(l){if((l=Math.min(l,this.data.byteLength-this.pointer))<1)return-1;let i=0;if(1<l)for(let s=1;s<=l-1;s++)i+=this.data.getUint8(this.pointer)*Math.pow(256,l-s),this.pointer++;return i+=this.data.getUint8(this.pointer),this.pointer++,i},readStr:function(l){let i=new Uint8Array(l),s=!1,c;i.forEach((d,u)=>{i[u]=this.readInt(1)});for(let d=0;d<e.length;d++)if(!s)try{if(c=e[d].decode(i),d==0)for(let u=0;u<c.length;u++){let f=c.charCodeAt(u);if(f>191||f>127&&f<160)throw new RangeError(`Invalid code point: ${f}`)}s=!0,console.debug(`String byte sequence in ${e[d].encoding}`)}catch(u){console.debug(`SMF string ${u}`)}return c||"String byte sequence read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let l=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)l=this.readInt(1);else{let s=[];for(;128<=this.data.getUint8(this.pointer);)s.push(this.readInt(1)-128);var i=this.readInt(1);for(let c=1;c<=s.length;c++)l+=s[s.length-c]*Math.pow(128,c);l+=i}return l}};if(n.data=new DataView(y.buffer,y.byteOffset,y.byteLength),n.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;n.readInt(4);let p={};p.formatType=n.readInt(2),p.tracks=n.readInt(2),p.track=[];var y=n.readInt(1),v=n.readInt(1);128<=y?(p.timeDivision=[],p.timeDivision[0]=y-128,p.timeDivision[1]=v):p.timeDivision=256*y+v;for(let l=1;l<=p.tracks;l++){p.track[l-1]={event:[]};var k,r=n.readInt(4);if(r===-1)break;if(r!==1297379947)return!1;n.readInt(4);let i=0,s=!1,c,d;for(;!s&&(i++,p.track[l-1].event[i-1]={},p.track[l-1].event[i-1].deltaTime=n.readIntVLV(),(c=n.readInt(1))!==-1);)if(128<=c?d=c:(c=d,n.movePointer(-1)),c===255){p.track[l-1].event[i-1].type=255,p.track[l-1].event[i-1].metaType=n.readInt(1);var o=n.readIntVLV();switch(p.track[l-1].event[i-1].metaType){case 47:case-1:s=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:p.track[l-1].event[i-1].data=n.readStr(o);break;case 33:case 89:case 81:p.track[l-1].event[i-1].data=n.readInt(o);break;case 84:p.track[l-1].event[i-1].data=[],p.track[l-1].event[i-1].data[0]=n.readInt(1),p.track[l-1].event[i-1].data[1]=n.readInt(1),p.track[l-1].event[i-1].data[2]=n.readInt(1),p.track[l-1].event[i-1].data[3]=n.readInt(1),p.track[l-1].event[i-1].data[4]=n.readInt(1);break;case 88:p.track[l-1].event[i-1].data=[],p.track[l-1].event[i-1].data[0]=n.readInt(1),p.track[l-1].event[i-1].data[1]=n.readInt(1),p.track[l-1].event[i-1].data[2]=n.readInt(1),p.track[l-1].event[i-1].data[3]=n.readInt(1);break;default:this.customInterpreter!==null&&(p.track[l-1].event[i-1].data=this.customInterpreter(p.track[l-1].event[i-1].metaType,n,o)),this.customInterpreter!==null&&p.track[l-1].event[i-1].data!==!1||(n.readInt(o),p.track[l-1].event[i-1].data=n.readInt(o),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((c=c.toString(16).split(""))[1]||c.unshift("0"),p.track[l-1].event[i-1].type=parseInt(c[0],16),p.track[l-1].event[i-1].channel=parseInt(c[1],16),p.track[l-1].event[i-1].type){case 15:this.customInterpreter!==null&&(p.track[l-1].event[i-1].data=this.customInterpreter(p.track[l-1].event[i-1].type,n,!1)),this.customInterpreter!==null&&p.track[l-1].event[i-1].data!==!1||(k=n.readIntVLV(),p.track[l-1].event[i-1].data=n.readInt(k),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:p.track[l-1].event[i-1].data=[],p.track[l-1].event[i-1].data[0]=n.readInt(1),p.track[l-1].event[i-1].data[1]=n.readInt(1);break;case 12:case 13:p.track[l-1].event[i-1].data=n.readInt(1);break;case-1:s=!0;break;default:if(this.customInterpreter!==null&&(p.track[l-1].event[i-1].data=this.customInterpreter(p.track[l-1].event[i-1].metaType,n,!1)),this.customInterpreter===null||p.track[l-1].event[i-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return p},customInterpreter:null};if(typeof Xt<"u")Xt.exports=a;else{let h=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;h.MidiParser=a}})()});U();U();var te,Qt,Mt=(Qt=class{constructor(){T(this,te,{})}addEventListener(g,e){t(this,te)[g]||(t(this,te)[g]=[]),t(this,te)[g].unshift(e)}removeEventListener(g,e){if(t(this,te)[g]){let a=t(this,te)[g].indexOf(e);a>-1&&t(this,te)[g].splice(a,1),t(this,te)[g].length<1&&delete t(this,te)[g]}}dispatchEvent(g,e){var n;let a=new Event(g),h=this;a.data=e,((n=t(this,te)[g])==null?void 0:n.length)>0&&t(this,te)[g].forEach(function(p){try{p==null||p.call(h,a)}catch(y){console.error(y)}}),this[`on${g}`]&&this[`on${g}`](a)}},te=new WeakMap,Qt);U();U();var Yt=function(g,e){let a=Math.min(g.length,e.length),h=g.slice(0,a),n=e.slice(0,a),p=0,y=0;for(;y<a&&p==0;)p=Math.sign(h[y]-n[y]),y++;return p},ue=function(g=""){this.name=g,this.pool=[],this.point=function(e,a=!1){if(this.pool.length>0){let h=this.pool.length,n=1<<Math.floor(Math.log2(h)),p=n,y=64;for(;n>=1&&y>=0;){if(y<=0)throw new Error("TTL reached.");if(p==h)p-=n;else{let k=Yt(e,this.pool[p]);switch(k){case 0:{y=0;break}case 1:{p+n<=h&&(p+=n);break}case-1:{p!=0&&(p-=n);break}default:console.warn(`Unexpected result ${k}.`)}}n=n>>1,y--}let v=!0;if(p>=this.pool.length)v=!1;else{let k=this;this.pool[p].forEach(function(r,o,l){v&&r!=e[o]&&(v=!1)}),!v&&Yt(e,this.pool[p])>0&&p++}return v||a?p:-1}else return a?0:-1},this.add=function(e,a){return e.data=a,this.pool.splice(this.point(e,!0),0,e),this},this.default=function(e){console.warn(`No match in "${this.name||"(unknown)"}" for "${e}". Default action not defined.`)},this.get=function(e){let a=this.point(e);if(a>-1)return this.pool[a].data;this.default(e)},this.run=function(e,...a){let h=this.point(e);h>-1?e.subarray?this.pool[h].data(e.subarray(this.pool[h].length),...a):this.pool[h].data(e.slice(this.pool[h].length),...a):this.default(e,...a)}};U();var Nr=["MSB","PRG","LSB","NME","ELC","DRM"],It=function(g){let e=Math.floor(g/10),a=g%10;return`${e.toString(16)}${a}`},J,jt,Lt=(jt=class{constructor(...g){T(this,J,void 0);P(this,"strictMode",!1);this.loadFiles(...g)}get(g=0,e=0,a=0,h){var f,$;let n=[g,e,a],p,y=1,v=0,k,r=Array.from(arguments);switch(h){case"xg":{switch(g){case 0:{a==126?r[2]=125:a==127&&(r[2]=0);break}case 16:{a==126&&(r[2]=0);break}case 32:{a>125&&(r[2]=0),r[2]+=4;break}case 33:case 34:case 35:case 36:{a>125&&(r[2]=0),r[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:r[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{a==126&&(r[2]=0);break}case 48:case 64:case 126:case 127:{a==126&&(r[2]=0);break}}break}case"gs":case"sc":{g==0&&a<5?r[2]=0:g>125&&a<5&&a!=2&&(r[2]=g,r[0]=0);break}case"g2":case"sd":{g>>1==40?r[2]|=16:g>95&&g<100&&(r[2]|=16,e>>4==7&&(r[0]=96));break}case"sg":{g==8&&a==0&&(r[2]=5);break}case"s90es":{a<8?r[2]+=17:a<32?r[2]+=13:r[2]=(r[2]>>3)+19;break}case"motif":{a<8?r[2]+=28:a<32?r[2]+=13:r[2]=(r[2]>>3)+19;break}}let o=" ",l="M",i=0,s=0;switch(r[0]){case 0:{r[2]==127?l="MT-a":r[2]==126?l="MT-b":r[2]==7?l="GM-k":r[2]==5?l="SG-a":r[2]==4?l="SP-l":r[2]==0||(h=="gs"||h=="sc")&&r[2]<5?l="GM-a":(l="y",i=3);break}case 8:{h=="sg"?l="GM-s":l="r:";break}case 32:case 33:case 34:case 35:case 36:{h=="xg"&&(l=`${["AP","VL","PF","DX","AN"][g&7]}-${"abcdefgh"[a]}`);break}case 48:{l=`yM${(r[2]>>3).toString().padStart(2,"0")}`,i=1;break}case 56:{l="GM-b";break}case 57:l=["yDOC","QY10","QY20"][r[2]-112]||"yMxv";case 61:case 120:{l="rDrm";break}case 62:{l="kDrm";break}case 63:{if(r[2]<17){let w=r[2];l=w<10?"kP:":"kC:",l+=w%10}else r[2]<34?l=["Pre1","Pre2","Pre3","Pre4","Usr1","Usr2","DrmP","DrmU","Plg1","Plg2","Plg3","Pre1","Pre2","Pre3","Pre4","Pre5","Pre6"][r[2]-17]:l="Ds";break}case 64:{l="ySFX";break}case 67:{l="DX:S";break}case 80:case 81:case 82:case 83:{l=`Prg${"UABC"[r[0]-80]}`;break}case 88:case 89:case 90:case 91:{l=`Cmb${"UABC"[r[0]-88]}`;break}case 95:{l=`${["DR","PC"][r[2]]}-d`;break}case 96:{l=r[2]==106?"AP-a":r[2]>>4==1?"SDg":"PF",r[2]>63?s=63:r[2]>>4==1&&(s=16),i=3;break}case 97:{l=r[2]>>4==1?"SDa":"VL:",i=3,r[2]>>4==1?s=16:s=112;break}case 98:{l=r[2]>>4==1?"SDb":"SG-a",i=3,s=16;break}case 99:{l=r[2]>>4==1?"SDc":"DX",r[2]>63?s=63:r[2]>>4==1&&(s=16),i=3;break}case 100:{l="AN",r[2]>63?s=63:r[2]>>4==1&&(s=16),i=3;break}case 104:case 105:case 106:case 107:{l="SDd",s=104;break}case 121:{l=`GM-${r[2]?"":"a"}`,i=3;break}case 122:{l="lDrm";break}case 126:{l="yDrS";break}case 127:{r[2]==127?l="rDrm":l="yDrm";break}default:r[0]<48?l="r:":l="M"}l.length<4&&(l+=`${[g,a,r[0],r[2]][i]-s}`.padStart(4-l.length,"0")),h=="xg"&&(g==0?r[2]<100?l=l.replace("y0","y:"):r[2]==125&&(l="y126"):g==16?(p=`Voice${((r[2]<<7)+r[1]+1).toString().padStart(3,"0")}`,o=" "):g==35&&a>>1==2&&(p=`DXCH_${(((r[2]&1)<<7)+e+1).toString().padStart(3,"0")}`,o=" "));let c=[r[0],r[1],r[2]];for(;!((p==null?void 0:p.length)>=0);)if(p=(f=t(this,J)[r[1]||0][(r[0]<<7)+r[2]])==null?void 0:f.name,p){let w=t(this,J)[r[1]||0][(r[0]<<7)+r[2]];y=(w==null?void 0:w.poly)||y,v=(w==null?void 0:w.type)||v,k=w==null?void 0:w.drum}else if(this.strictMode)p="",o="?";else if(r[0]==0&&r[1]==0&&r[2]==0)p="Unloaded";else if(t(this,J)[r[1]||0][r[0]<<7])r[0]==0?(r[2]=0,o="^"):r[2]<1?(r[0]=0,o="*"):(r[2]--,o="^");else if(g==48)r[0]=0,r[2]=0,o="!";else if(g==62)r[1]--,o=" ",r[1]<1&&!(p!=null&&p.length)&&(r[0]=0,o="!");else if(g<63)r[0]==0?(r[2]=0,o="^"):r[2]<1?(r[0]=0,o="*"):r[2]--;else if(g==80)p=`PrgU:${e.toString().padStart(3,"0")}`,o="!";else if(g==88)p=`CmbU:${e.toString().padStart(3,"0")}`,o="!";else if(g==121)p=`GM2Vox0${a}`,o="#";else if(g==122)if(r[1]==32?r[1]==0:r[1]%=7,p=($=t(this,J)[r[1]||0][(r[0]<<7)+r[2]])==null?void 0:$.name,p){o=" ";let w=t(this,J)[r[1]||0][(r[0]<<7)+r[2]];y=(w==null?void 0:w.poly)||y,v=(w==null?void 0:w.type)||v,k=w==null?void 0:w.drum}else p="",o="*";else r[1]==0?(p=`${g.toString().padStart(3,"0")} ${e.toString().padStart(3,"0")} ${a.toString().padStart(3,"0")}`,o="!"):r[0]==0?(r[2]=0,o="^"):r[2]>0?r[2]--:r[1]>0?(r[1]=0,o="!"):(r[0]=0,o="?");let d=[r[0],r[1],r[2]];(h=="gs"||h=="sc"||h=="ns5r")&&o=="^"&&(o=" "),g==127&&o=="^"&&(o=" "),o!=" "&&self.debugMode&&(p="");let u="??";switch(r[0]){case 0:{r[2]==0?u="GM":r[2]==5||r[2]==7?u="KG":r[2]<126?u="XG":r[2]==127&&(u="MT");break}case 32:case 33:case 35:case 36:{r[2]>4?u=["AP","VL","PF","DX","AN"][r[0]-32]:u="GS";break}case 48:{u="MU";break}case 56:{u="AG";break}case 61:case 80:case 83:case 88:case 89:case 91:{u="AI";break}case 62:case 82:case 90:{u="XD";break}case 63:{r[2]<17?u="KR":r[2]<34?u="ES":u="DS";break}case 64:case 126:{u="XG";break}case 67:case 99:{u=r[2]>>4==1?"SD":"DX";break}case 81:{u="RW";break}case 95:{u=["DR","PC"][r[2]];break}case 96:{u=r[2]==106?"AP":r[2]>>4==1?"SD":"PF";break}case 97:{u=r[2]>>4==1?"SD":"VL";break}case 98:{u=r[2]>>4==1?"SD":"SG";break}case 100:{u="AN";break}case 104:case 105:case 106:case 107:{u="SD";break}case 120:{u="GS";break}case 121:{u=r[2]?"G2":"GM";break}case 122:{u="KG";break}case 127:{u=r[2]==127?"MT":e==0?"GM":"XG";break}default:r[0]<48&&(r[0]==16&&h=="xg"?u="XG":u="GS")}return{name:p||`${It(g||0)} ${It(e||0)} ${It(a||0)}`,poly:y,type:v,drum:k,iid:c,eid:d,sid:n,ending:o,sect:l,standard:u}}async load(g,e,a="(internal)"){let h=this,n=[],p=0,y=0;g.split(`
`).forEach(function(v,k){let r=v.split("	"),o=[];if(k==0){if(r.forEach(function(l,i){n[Nr.indexOf(l)]=i}),n.length<4){console.debug("Debugger launched.");debugger}}else{let l=0,i=0,s=0,c,d=1,u=0,f;r.forEach(async function(w,C){switch(C){case n[0]:{l=parseInt(w);break}case n[1]:{i=parseInt(w);break}case n[2]:{s=parseInt(w);break}case n[3]:{c=w;break}case n[4]:{w=parseInt(w),w<16?d=w+1:u=(w&15)+1;break}case n[5]:{f=w;break}}}),t(h,J)[i]=t(h,J)[i]||[];let $=t(h,J)[i];if(!$[l<<7|s]||e){let w={msb:l,prg:i,lsb:s,name:c,poly:d,type:u,drum:f};$[l<<7|s]=w,p++}y++}}),e||console.debug(`Map "${a}": ${y} total, ${p} loaded.`)}clearRange(g){let e=g.prg!=null?g.prg.constructor==Array?g.prg:[g.prg,g.prg]:[0,127],a=g.msb!=null?g.msb.constructor==Array?g.msb:[g.msb,g.msb]:[0,127],h=g.lsb!=null?g.lsb.constructor==Array?g.lsb:[g.lsb,g.lsb]:[0,127];for(let n=a[0];n<=a[1];n++){let p=n<<7;for(let y=h[0];y<=h[1];y++){let v=p+y;for(let k=e[0];k<=e[1];k++)delete t(this,J)[k][v]}}}init(){x(this,J,[]);for(let g=0;g<128;g++)t(this,J).push([""])}async loadFiles(...g){this.init();let e=this;g.forEach(async function(a){try{await fetch(`./data/bank/${a}.tsv`).then(function(h){return h.text()}).then(h=>{e.load(h,!1,a)})}catch(h){console.error(`Failed loading "${a}.tsv".`)}})}},J=new WeakMap,jt);U();U();var it,Zt,Jt=(Zt=class{constructor(){T(this,it,{});P(this,"context")}set(g,e){t(this,it)[g]=e}has(g){return!!t(this,it)[g]}async read(g,e){if(!this.has(g))throw new Error(`No decoder registered for "${g}"`);return await t(this,it)[g].call(this.context||this,e)}},it=new WeakMap,Zt);var Hr=function(g,e){let a=!0;return e.forEach((h,n)=>{a=a&&g[n]==h}),a},gt=function(g){let e=0;return g.forEach(a=>{e*=256,e+=a}),e},ve=new TextDecoder,bt=new Jt;bt.set("s7e",async function(g){let e=new Uint8Array(await g.slice(0,65536).arrayBuffer()),a="MSB	LSB	PRG	NME",h=[0,0,0,0],n=32,p=0,y=0,v=!0,k=[],r=0;for(;v;){let o=e.subarray(p);([()=>{ve.decode(o.subarray(0,4))=="YSFC"?(p+=80,y=1):p++},()=>{if(Hr(o.subarray(0,4),h))k.forEach((l,i,s)=>{let c=gt(e.subarray(l.start+4,l.start+8));l.length=c}),y=2;else{let l=ve.decode(o.subarray(0,4)),i=gt(o.subarray(4,8));k.push({type:l,start:i}),p+=8}},()=>{let l=k[r],i=e.subarray(l.start,l.start+l.length),s=32;switch(l.type){case"ENVC":{let c=n;for(;c<i.length;){let d=i.subarray(c,c+s),u=ve.decode(d.subarray(0,10)).trimEnd();u.slice(0,5)=="Init "&&(u=""),u&&(a+=`
063	${(d[17]+13).toString().padStart(3,"0")}	${d[19].toString().padStart(3,"0")}	${u}`),c+=s}break}case"EDVC":{let c=n;for(;c<i.length;){let d=i.subarray(c,c+s),u=ve.decode(d.subarray(0,10)).trimEnd();u.slice(0,5)=="Init "&&(u=""),u&&(a+=`
063	024	${d[19].toString().padStart(3,"0")}	${u}`),c+=s}break}case"EPVC":{let c=32,d=n;for(;d<i.length;){let u=i.subarray(d,d+c),f=ve.decode(u.subarray(0,10)).trimEnd();f=="----------"&&(f=""),f&&(a+=`
063	${(u[17]+1).toString().padStart(3,"0")}	${u[19].toString().padStart(3,"0")}	${f}`),d+=c}break}}r++,r>=k.length&&(y=3,v=!1)}][y]||(()=>{v=!1}))()}return a});bt.set("pcg",async function(g){let e=new Uint8Array(await g.arrayBuffer()),a="MSB	LSB	PRG	NME",h=100,n=0,p=0,y=!0,v=[],k=0;for(;y;){let r=e.subarray(h);([()=>{y=ve.decode(r.subarray(0,4))=="INI2",p=r[15],h+=16,n=1},()=>{let o=ve.decode(r.subarray(0,4)),l=r[5],i=r[7],s=r[11],c=gt(r.subarray(12,16)),d=gt(r.subarray(16,20)),u=gt(r.subarray(36,40)),f=ve.decode(r.subarray(44,44+s));v.push({type:o,tipMsb:l,tipLsb:i,nameLen:s,length:c,start:d,entryLen:u,name:f}),h+=64,p--,p<1&&(n=2)},()=>{let o=v[k],l=e.subarray(o.start,o.start+o.length);switch(o.type){case"PRG1":break;case"PBK1":{let i=63,s=(o.tipMsb?6:0)+o.tipLsb;for(let c=0;c<128;c++){let d=c*o.entryLen,u=l.subarray(d,d+o.entryLen),f=ve.decode(u.subarray(0,24)).trimEnd().replace("InitProg","");f.length&&s>5&&(a+=`
${i.toString().padStart(3,"0")}	${s.toString().padStart(3,"0")}	${c.toString().padStart(3,"0")}	${f}`)}break}case"CBK1":{let i=63,s=(o.tipMsb?3:0)+o.tipLsb+10;for(let c=0;c<128;c++){let d=c*o.entryLen,u=l.subarray(d,d+o.entryLen),f=ve.decode(u.subarray(0,24)).trimEnd().replace("InitCombi","");f.length&&s>12&&(a+=`
${i.toString().padStart(3,"0")}	${s.toString().padStart(3,"0")}	${c.toString().padStart(3,"0")}	${f}`)}break}}k++,k>=v.length&&(n=3,y=!1)}][n]||(()=>{y=!1}))()}return a});U();var Et=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]),mt=["melodic","drums","drum set 1","drum set 2","drum set 3","drum set 4","drum set 5","drum set 6","drum set 7","drum set 8"],_r=[17.1,18.6,20.2,21.8,23.3,24.9,26.5,28,29.6,31.2,32.8,34.3,35.9,37.5,39,40.6,42.2,43.7,45.3,46.9,48.4,50],st=[20,22,25,28,32,36,40,45,50,56,63,70,80,90,100,110,125,140,160,180,200,225,250,280,315,355,400,450,500,560,630,700,800,900,1e3,1100,1200,1400,1600,1800,2e3,2200,2500,2800,3200,3600,4e3,4500,5e3,5600,6300,7e3,8e3,9e3,1e4,11e3,12e3,14e3,16e3,18e3,2e4],er=[0,.04,.08,.13,.17,.21,.25,.29,.34,.38,.42,.46,.51,.55,.59,.63,.67,.72,.76,.8,.84,.88,.93,.97,1.01,1.05,1.09,1.14,1.18,1.22,1.26,1.3,1.35,1.39,1.43,1.47,1.51,1.56,1.6,1.64,1.68,1.72,1.77,1.81,1.85,1.89,1.94,1.98,2.02,2.06,2.1,2.15,2.19,2.23,2.27,2.31,2.36,2.4,2.44,2.48,2.52,2.57,2.61,2.65,2.69,2.78,2.86,2.94,3.03,3.11,3.2,3.28,3.37,3.45,3.53,3.62,3.7,3.87,4.04,4.21,4,37,4.54,4.71,4.88,5.05,5.22,5.38,5.55,5.72,6.06,6.39,6.73,7.07,7.4,7.74,8.08,8.41,8.75,9.08,9.42,9.76,10.1,10.8,11.4,12.1,12.8,13.5,14.1,14.8,15.5,16.2,16.8,17.5,18.2,19.5,20.9,22.2,23.6,24.9,26.2,27.6,28.9,30.3,31.6,33,34.3,37,39.7],tr=function(g){let e=.1,a=-.3;return g>66?(e=5,a=315):g>56?(e=1,a=47):g>46&&(e=.5,a=18.5),e*g-a},rr=function(g){return g>105?_r[g-106]:g>100?g*1.1-100:g/10},ar=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),Ut={};`hi*,
ka,か
ki,き
ku,く
ke,け
ko,こ
ky,き!
kw,くl
tsu,つ
ts,つl
sa,さ
si,すぃ
su,す
se,せ
so,そ
shi,し
sh,し!
ta,た
ti,てぃ
tu,とぅ
te,て
to,と
tchy,ち!
tchi,ち
na,な
ni,に
nu,ぬ
ne,ね
no,の
ny,に!
nn,ん
ha,は
hi,ひ
hu,ほぅ
he,へ
ho,ほ
hy,ひ!
fa,ふぁ
fi,ふぃ
fu,ふ
fe,ふぇ
fo,ふぉ
ma,ま
mi,み
mu,む
me,め
mo,も
my,み!
mm,
ra,ら
ri,り
ru,る
re,れ
ro,ろ
ry,り!
wa,わ
wi,うぃ
we,うぇ
wo,を
nga,ガ
ngi,ギ
ngu,グ
nge,ゲ
ngo,ゴ
ngy,ギ!
ng,
ga,が
gi,ぎ
gu,ぐ
ge,げ
go,ご
gy,ぎ!
gw,ぐl
za,ざ
zi,ずぃ
zu,ず
ze,ぜ
zo,ぞ
ja,じゃ
ji,じ
ju,じゅ
je,じぇ
jo,じょ
jy,じ!
da,だ
di,でぃ
du,どぅ
de,で
do,ど
dy,で!
ba,ば
bi,び
bu,ぶ
be,べ
bo,ぼ
by,び!
va,ゔぁ
vi,ゔぃ
vu,ゔ
ve,ゔぇ
vo,ゔぉ
pa,ぱ
pi,ぴ
pu,ぷ
pe,ペ
po,ぽ
py,ぴ!
!ya,ゃ
!yu,ゅ
!ye,ぇ
!yo,ょ
ya,や
yu,ゆ
ye,いぇ
yo,よ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
la,ぁ
li,ぃ
lu,ぅ
le,ぇ
lo,ぉ
a,あ
i,い
u,う
e,え
o,お
*,っ
~,
^,
_,`.split(`
`).forEach(g=>{let e=g.split(",");Ut[e[0]]=e[1]});var ir=function(g){let e=g;g[0]=="*"&&(e=e.slice(1)),["aa","ii","uu","ee","oo"].forEach(h=>{for(;e.indexOf(h)>-1;)e=e.replace(h,h[0])});for(let h in Ut)e=e.replaceAll(h,Ut[h]);e.indexOf("ん")==0&&e.length>1&&(e=e.slice(1));let a=e.indexOf("!");return a>-1&&e.length>1&&(e=e.slice(a+1)),e},sr=function(g){return g?g<96?`cc${g}`:["aftertouch","velocity","pitch bend"][g-96]:"off"};U();var Bt=["room 1","room 2","room 3","hall 1","hall 2","plate","delay","panning delay"],nr=["chorus 1","chorus 2","chorus 3","chorus 4","feedback","flanger","short delay","short delay feedback"],cr=["delay 1","delay 2","delay 3","delay 4","pan delay 1","pan delay 2","pan delay 3","pan delay 4","delay to reverb","pan repeat"];var Gr={0:"thru",256:"stereo EQ",257:"spectrum",258:"enhancer",259:"humanizer",272:"overdrive",273:"distortion",288:"phaser",289:"auto wah",290:"rotary",291:"stereo flanger",292:"step flanger",293:"tremelo",294:"auto pan",304:"compressor",305:"limiter",320:"hexa chorus",321:"tremelo chorus",322:"stereo chorus",323:"space D",324:"3D chorus",336:"stereo delay",337:"modulated delay",338:"3-tap delay",339:"4-tap delay",340:"tremelo control delay",341:"reverb",342:"gate reverb",343:"3D delay",352:"2-pitch shifter",353:"feedback pitch shifter",368:"3D auto",369:"3D manual",370:"Lo-Fi 1",371:"Lo-Fi 2",512:"overdrive - chorus",513:"overdrive - flanger",514:"overdrive - delay",515:"distortion - chorus",516:"distortion - flanger",517:"distortion - delay",518:"enhancer - chorus",519:"enhancer - flanger",520:"enhancer - delay",521:"chorus - delay",522:"flanger - delay",523:"chorus - flanger",524:"rotary multi",1024:"guitar multi 1",1025:"guitar multi 2",1026:"guitar multi 3",1027:"clean guitar multi 1",1028:"clean guitar multi 2",1029:"bass multi",1030:"rhodes multi",1280:"keyboard multi",4352:"chorus / delay",4353:"flanger / delay",4354:"chorus / flanger",4355:"overdrive / distortion",4356:"overdrive / rotary",4357:"overdrive / phaser",4358:"overdrive / auto wah",4359:"phaser / rotary",4360:"phaser / auto wah"},Xr={66307:["drive"],66309:["vowel",g=>"aiueo"[g]],94723:["pre-filter"],94724:["Lo-Fi type"],94725:["post-filter"],94979:["Lo-Fi type"],94980:["fill type",g=>["off","LPF","HPF"][g]],94984:["noise type",g=>["white","pink"][g]],94987:["disc type",g=>["LP","SP","EP","RND"]],94990:["hum type",g=>`${g+5}0Hz`],94993:["M/S",g=>["mono","stereo"][g]]},Nt=function(g){return Gr[(g[0]-32<<8)+g[1]]||`0x${g[0].toString(16).padStart(2,"0")}${g[1].toString(16).padStart(2,"0")}`},or=function(g,e,a){let h=(g[0]-32<<16)+(g[1]<<8)+e,n=Xr[h]||{},p=n[0];if(p!=null&&p.length)return p+=`: ${(n[1]||function(){})(a)||a}`,p},Ht=[68,48,95,78,41,3,110,122,0];U();var re=function(g=64){return Math.round(2e3*Math.log10(g/64))/100},lr=function(g,e,a){let h=[],n=a==!1?e.readIntVLV():a;g==0||g==127;for(let p=0;p<n;p++){let y=e.readInt(1);if(h.push(y),y!=247){if(y!=240){if(y>127)return console.debug(`Early termination: ${h}`),h.pop(),e.backOne(),e.backOne(),new Uint8Array(h)}}}return new Uint8Array(h)},De=function(g){let e=0;return g.forEach(a=>{e+=a,e=e&127}),~e+1&127},pe=function(g,e){let a=0,h=0;for(let n=0;n<g.length;n++){let p=n%8-1,y=(h>>p&1)<<7,v=g[n];v+=y,n%8!=0?(e(v,a,g),a++):h=g[n]}};var yt=function(g){let e=Math.floor(g*14.2);return e<128?e:0},O=function(){return!!self.Bun||self.debugMode||!1};var W=["?","gm","gs","sc","xg","g2","mt32","doc","qy10","qy20","ns5r","x5d","05rw","k11","sg","sd","krs","s90es","motif","trin"],Vr={gm2:"g2","mt-32":"mt32","c/m":"mt32",ag10:"05rw","ag-10":"05rw","05r/w":"05rw",x5:"05rw",x5dr:"x5d",gmega:"k11","kross 2":"krs","motif es":"motif","s90 es":"s90es",trinity:"trin","tr-rack":"trin"},Fr=["melodic","drum","menu"],dr={"?":[0,0,120],gm:[0,0,127],gs:[0,0,120],sc:[0,0,120],xg:[0,0,127],g2:[0,0,120],mt32:[0,127,127],doc:[57,112,127],qy10:[57,113,127],qy20:[57,114,127],ns5r:[0,0,61],x5d:[82,0,62],"05rw":[81,0,62],k11:[0,0,122],sg:[0,0,122],sd:[97,0,105],krs:[63,0,120],s90es:[63,0,127],motif:[63,0,127],trin:[63,0,127]};var _t=[120,127,120,127,120,127,127,61,62,62,122,122,105,120,127,127,127],fr=[9,25,41,57,73,89,105,121],Kr=[0,3,81,84,88],hr={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},ur={0:0,1:1,2:3,5:4},pr={0:0,1:1,2:2,5:3},gr=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],br=[36,37,48,49,52,53],Dt=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65],Er={26:127,29:0,30:0,31:0,52:12,53:54},vt=[0,1,2,4,5,6,7,8,10,11,32,38,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,84,91,92,93,94,95,98,99,100,101,128,12,13,16,17,18,19,14,15,20,21,26,28,80,81,83,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],zr=[2,12,13,14,15,16,17,18,19,20,21,80,81,83,136,130,131,132,133,134,135,137,138,139,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],qr=[33,99,100,32,102,8,9,10],mr=[0,16,25,40,32,64,26,48],S={};W.forEach((g,e)=>{S[g]=e});var E={length:vt.length};vt.forEach((g,e)=>{E[g]=e});var le={length:Dt.length};Dt.forEach((g,e)=>{le[g]=e});var Wr={};Fr.forEach((g,e)=>{Wr[g]=e});var Qr=function(g){let e=[],a=0;return g==null||g.forEach(function(h,n){h==247?e.push(g.subarray(a,n)):h==240&&(a=n+1)}),e.length||e.push(g.subarray(0)),O()&&console.debug(e),e};var yr=8,m={port:yr,ch:yr<<4,cc:vt.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,rpnt:4,ace:8,drm:8,dpn:Dt.length,dnc:128,ext:3,efx:7,cvn:12,redir:32,invalidCh:255},nt={bank0:128},A,Y,ge,Se,oe,xe,$r,de,F,D,b,fe,I,K,ae,z,Q,Te,$e,Ge,ie,R,L,ct,ee,be,se,ot,Xe,X,Oe,Ee,$t,Ae,me,lt,Ie,q,B,we,wt,H,Ve,dt,ft,Le,Ue,kt,ht,ye,G,Pt,xt,Fe,Gt,ne,Ce,Be,j,Ke,V,St,Rt,ze,qe,ce,he,ke,We,Qe,Ye,vr,Ua=(vr=class extends Mt{constructor(){super();T(this,oe);P(this,"NOTE_IDLE",0);P(this,"NOTE_ATTACK",1);P(this,"NOTE_DECAY",2);P(this,"NOTE_SUSTAIN",3);P(this,"NOTE_HELD",4);P(this,"NOTE_RELEASE",5);P(this,"NOTE_SOSTENUTO_ATTACK",8);P(this,"NOTE_SOSTENUTO_DECAY",9);P(this,"NOTE_SOSTENUTO_SUSTAIN",10);P(this,"NOTE_SOSTENUTO_HELD",11);P(this,"CH_MELODIC",0);P(this,"CH_DRUMS",1);P(this,"CH_DRUM1",2);P(this,"CH_DRUM2",3);P(this,"CH_DRUM3",4);P(this,"CH_DRUM4",5);P(this,"CH_DRUM5",6);P(this,"CH_DRUM6",7);P(this,"CH_DRUM7",8);P(this,"CH_DRUM8",9);P(this,"DUMP_ALL",0);P(this,"DUMP_ONCE",1);P(this,"DUMP_MODE",2);P(this,"EXT_NONE",0);P(this,"EXT_VL",1);P(this,"EXT_DX",3);P(this,"VLBC_BRTHEXPR",1);P(this,"VLBC_VELOINIT",2);P(this,"VLBC_VELOALL",3);P(this,"CH_INACTIVE",0);P(this,"CH_ACTIVE",1);P(this,"CH_DISABLED",2);T(this,A,0);T(this,Y,0);T(this,ge,0);T(this,Se,new Array(11));T(this,de,new Uint8Array(m.ch));T(this,F,new Uint8Array(m.ch));T(this,D,new Uint8Array(m.ch));T(this,b,new Uint8Array(m.ch*m.cc));T(this,fe,new Uint8Array(m.ace));T(this,I,new Uint8Array(m.ch));T(this,K,new Uint8Array(m.ch*m.nn));T(this,ae,new Uint8Array(m.ch));T(this,z,new Uint16Array(m.pl));T(this,Q,new Uint8Array(m.pl));T(this,Te,new Int16Array(m.ch));T(this,$e,new Uint8Array(m.ch));T(this,Ge,0);T(this,ie,new Uint8Array(m.ch*m.ext));T(this,R,new Uint8Array(m.ch*m.rpn));T(this,L,new Uint8Array(m.ch*m.rpnt));T(this,ct,new Int8Array(m.ch*br.length));T(this,ee,new Uint8Array(m.drm*m.dpn*m.dnc));T(this,be,new Uint8Array(m.drm*2));T(this,se,new Uint8Array(m.efx*3));T(this,ot,new Uint8Array(m.ch));T(this,Xe,new Uint8Array(m.ch*m.redir));T(this,X,new Uint8Array(m.port));T(this,Oe,new Uint8Array(m.ch));T(this,Ee,new Uint8Array(m.ch));T(this,$t,new Uint8Array(m.ch*m.cvn));T(this,Ae,new Uint8Array(128));T(this,me,new Uint8Array(m.cmt*8));T(this,lt,new Uint8Array(1024));T(this,Ie,new Uint8Array(m.cmt*64));T(this,q,{});T(this,B,void 0);T(this,we,void 0);T(this,wt,void 0);T(this,H,100);T(this,Ve,0);T(this,dt,500);T(this,ft,0);T(this,Le,"");T(this,Ue,0);T(this,kt,0);T(this,ht,0);T(this,ye,!0);T(this,G,!1);T(this,Pt,1);T(this,xt,void 0);T(this,Fe,new Array(m.ch));T(this,Gt,new Uint8Array(2));T(this,ne,[]);T(this,Ce,new Uint8Array(m.ch));T(this,Be,new Uint8Array(m.tr));P(this,"baseBank",new Lt("gm","gm2","xg","gs","ns5r","sd","gmega","plg-150vl","plg-150pf","plg-150dx","plg-150an","plg-150dr","plg-100sg","kross","s90es"));P(this,"userBank",new Lt("gm"));P(this,"initOnReset",!1);P(this,"aiEfxName","");T(this,j,[]);T(this,Ke,void 0);T(this,V,{nOff:(e,a)=>{let h=e*128+a,n=t(this,z).lastIndexOf(h);if(n>-1)if(t(this,b)[m.cc*e+E[64]]>63)t(this,Q)[n]=this.NOTE_HELD,this.dispatchEvent("note",{part:e,note:a,velo:t(this,K)[h],state:this.NOTE_HELD});else if(t(this,b)[m.cc*e+E[66]]>63&&t(this,Q)[n]==this.NOTE_SOSTENUTO_SUSTAIN)t(this,Q)[n]=this.NOTE_SOSTENUTO_HELD,this.dispatchEvent("note",{part:e,note:a,velo:t(this,K)[h],state:this.NOTE_SOSTENUTO_HELD});else{t(this,z)[n]=0,t(this,K)[h]=0,t(this,Q)[n]=this.NOTE_IDLE;let p=this.getExt(e)[1];(p==this.VLBC_VELOINIT||p==this.VLBC_VELOALL)&&(t(this,b)[m.cc*e+E[129]]=0),this.dispatchEvent("note",{part:e,note:a,velo:0,state:this.NOTE_IDLE})}},nOn:(e,a,h)=>{let n=e*128+a,p=0;for(t(this,ae)[e]&&t(this,V).ano(e);t(this,Q)[p]>0&&t(this,z)[p]!=n;)p++;if(p<m.pl){t(this,z)[p]=n,t(this,K)[n]=h,t(this,Q)[p]=this.NOTE_SUSTAIN,t(this,$e)[e]<h&&(t(this,$e)[e]=h);let y=this.getExt(e)[1];(y==this.VLBC_VELOINIT||y==this.VLBC_VELOALL)&&(t(this,b)[m.cc*e+E[129]]=h),this.dispatchEvent("note",{part:e,note:a,velo:h,state:this.NOTE_SUSTAIN})}else console.error("Polyphony exceeded.")},nAt:(e,a,h)=>{},cAt:(e,a)=>{},hoOf:e=>{t(this,Q).forEach((a,h)=>{if(a==this.NOTE_HELD){let n=t(this,z)[h],p=n>>7;e==p&&(t(this,Q)[h]=this.NOTE_IDLE,t(this,z)[h]=0,t(this,K)[n]=0,this.dispatchEvent("note",{part:e,note:n&127,velo:0,state:this.NOTE_IDLE}))}})},soOn:e=>{t(this,Q).forEach((a,h)=>{let n;switch(a){case this.NOTE_ATTACK:{n=this.NOTE_SOSTENUTO_ATTACK;break}case this.NOTE_DECAY:{n=this.NOTE_SOSTENUTO_DECAY;break}case this.NOTE_SUSTAIN:{n=this.NOTE_SOSTENUTO_SUSTAIN;break}}if(n){t(this,Q)[h]=n;let p=t(this,z)[h];this.dispatchEvent("note",{part:e,note:p&127,velo:t(this,K)[p],state:n})}})},soOf:e=>{t(this,Q).forEach((a,h)=>{if(a==this.NOTE_SOSTENUTO_HELD){let n=t(this,z)[h],p=n>>7;e==p&&(t(this,Q)[h]=this.NOTE_IDLE,t(this,z)[h]=0,t(this,K)[n]=0,this.dispatchEvent("note",{part:e,note:n&127,velo:0,state:this.NOTE_IDLE}))}})},ano:e=>{t(this,z).forEach((a,h,n)=>{let p=a>>7,y=a&127;a==0&&t(this,K)[0]==0||p==e&&t(this,V).nOff(p,y)})}});T(this,St,{8:function(e){let a=e.channel,h=e.data[0];t(this,V).nOff(a,h)},9:function(e){let a=e.channel,h=this;if(h.getChModeId(a)==S.xg&&t(h,D)[a]>1){let y=h.getChDrumFirstWrite(a);y[0]&&y[1]!=m.invalidCh&&!t(h,de)[a]&&(h.copyChSetup(y[1],a),h.dispatchEvent("voice",{part:a}),console.debug(`Part CH${a+1} copied from CH${y[1]}.`))}h.setChActive(a,1);let n=e.data[0],p=e.data[1];p>0?t(h,V).nOn(a,n,p):t(h,V).nOff(a,n)},10:function(e){let a=e.channel,h=a*128+e.data[0];t(this,z).indexOf(h)>-1&&(t(this,K)[h]=data[1],this.getExt(a)[1]==this.VLBC_VELOALL&&(t(this,b)[m.cc*a+E[129]]=data[1]),this.dispatchEvent("note",{part:a,note:e.data[0],velo:e.data[1],state:this.NOTE_SUSTAIN}))},11:function(e){let a=e.channel,h=this,n=t(this,Fe)[a],p=n[e.data[0]];p&&(e.data[0]=p),[0,32].indexOf(e.data[0])>-1&&(()=>{switch(t(this,A)){case S.s90es:case S.motif:{if(e.data[0]==0){[0,63].indexOf(e.data[1])>-1&&this.setChActive(a,1);break}e.data[1]&&this.setChActive(a,1);break}default:{this.setChActive(a,1);break}}})();let y=a*m.cc,v=a*m.ext;switch(e.data[0]){case 96:return;case 97:return;case 120:return;case 121:{t(this,V).ano(a),t(this,Te)[a]=0,t(this,b)[y+E[1]]=0,t(this,b)[y+E[5]]=0,t(this,b)[y+E[64]]=0,t(this,b)[y+E[65]]=0,t(this,b)[y+E[66]]=0,t(this,b)[y+E[67]]=0,t(this,b)[y+E[11]]=127,t(this,b)[y+E[101]]=127,t(this,b)[y+E[100]]=127,t(this,b)[y+E[99]]=127,t(this,b)[y+E[98]]=127;return}case 123:{t(this,V).ano(a);return}case 124:{t(this,V).ano(a);return}case 125:{t(this,V).ano(a);return}case 126:{t(this,ae)[a]=1,t(this,V).ano(a);return}case 127:{t(this,ae)[a]=0,t(this,V).ano(a);return}}if(E[e.data[0]]==null)console.warn(`cc${e.data[0]} is not accepted.`);else{switch(zr.indexOf(e.data[0])>-1&&this.allocateAce(e.data[0]),e.data[0]){case 0:{switch(O()&&console.debug(`${W[t(this,A)]}, CH${a+1}: ${e.data[1]}`),t(this,A)==0?e.data[1]<48?(t(this,D)[a]>0&&(e.data[1]=t(this,b)[y],e.data[1]=120,console.debug(`Forced channel ${a+1} to stay drums.`)),e.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${e.data[1]}`),this.switchMode("gs"))):e.data[1]==56?this.switchMode(t(this,B).x5==82?"x5d":"05rw"):e.data[1]==62?this.switchMode(t(this,B).x5==82?"x5d":"05rw"):e.data[1]==63?this.switchMode(W[t(this,B).ds]):(e.data[1]==64||e.data[1]==127)&&this.switchMode("xg"):t(this,A)==S.gs||t(this,A)==S.sc?e.data[1]<56&&t(this,D)[a]>0&&(e.data[1]=t(this,b)[y],e.data[1]=120,console.debug(`Forced channel ${a+1} to stay drums.`)):t(this,A)==S.gm&&(e.data[1]<48?t(this,D)[a]>0&&(e.data[1]=120,this.switchMode("gs",!0),console.debug(`Forced channel ${a+1} to stay drums.`)):(e.data[1]==64||e.data[1]==127)&&this.switchMode("xg",!0)),t(this,A)){case S.xg:{[79,95,126,127].indexOf(e.data[1])>-1?t(this,D)[a]==0&&(this.setChType(a,this.CH_DRUM2),console.debug(`CH${a+1} set to drums by MSB.`)):t(this,D)[a]>0&&(this.setChType(a,this.CH_MELODIC),console.debug(`CH${a+1} set to melodic by MSB.`)),[33,81,97].indexOf(e.data[1])>-1?t(this,ie)[v]=this.EXT_VL:[35,67,83,99].indexOf(e.data[1])>-1?t(this,ie)[v]=this.EXT_DX:t(this,ie)[v]=this.EXT_NONE;break}case S["05rw"]:case S.x5d:case S.ns5r:{[61,62,126,127].indexOf(e.data[1])>-1?t(this,D)[a]==this.CH_MELODIC&&(this.setChType(a,this.CH_DRUM2),console.debug(`CH${a+1} set to drums by MSB.`)):[80,81,82,83].indexOf(e.data[1])>-1||t(this,D)[a]!=this.CH_MELODIC&&(this.setChType(a,this.CH_MELODIC),console.debug(`CH${a+1} set to melodic by MSB.`));break}case S.sd:{[104,105,106,107].indexOf(e.data[1])>-1?t(this,D)[a]==0&&(this.setChType(a,this.CH_DRUM2),console.debug(`CH${a+1} set to drums by MSB.`)):t(this,D)[a]>0&&(this.setChType(a,this.CH_MELODIC),console.debug(`CH${a+1} set to melodic by MSB.`));break}case S.g2:{e.data[1]==120?t(this,D)[a]==0&&(this.setChType(a,this.CH_DRUMS),console.debug(`CH${a+1} set to drums by MSB.`)):t(this,D)[a]>0&&(this.setChType(a,this.CH_MELODIC),console.debug(`CH${a+1} set to melodic by MSB.`));break}}this.dispatchEvent("voice",{part:a});break}case 2:{this.getExt(a)[1]==this.VLBC_BRTHEXPR&&(t(this,b)[y+E[129]]=e.data[1]);break}case 6:{if(t(this,Ge)){[S.xg,S.gs,S.sc,S.ns5r].indexOf(t(this,A))<0&&console.warn(`NRPN commits are not available under "${W[t(this,A)]}" mode, even when they are supported in Octavia.`);let k=t(this,b)[y+E[99]],r=t(this,b)[y+E[98]];if(k==1){let o=qr.indexOf(r);if(o>-1)t(this,b)[y+E[71+o]]=e.data[1],O()&&console.debug(`Redirected NRPN 1 ${r} to cc${71+o}.`),this.dispatchEvent("cc",{part:a,cc:71+o,data:e.data[1]});else{let l=br.indexOf(r);l>-1?t(this,ct)[a*10+l]=e.data[1]-64:console.warn(`NRPN 0x01${r.toString(16).padStart(2,"0")} is not supported.`),O()&&console.debug(`CH${a+1} voice NRPN ${r} commit`)}}else{if(Dt.indexOf(k)<0){let l=`NRPN 0x${k.toString(16).padStart(2,"0")}${r.toString(16).padStart(2,"0")} `;k==127?console.warn(`${l}is not necessary. Consider removing it.`):console.warn(`${l}is not supported.`)}else{let l=t(this,D)[a]-2;l<0?console.warn(`CH${a+1} cannot accept drum NRPN as type ${mt[t(this,D)[a]]}.`):t(this,ee)[(l*m.dpn+le[k])*m.dnc+r]=e.data[1]}O()&&console.debug(`CH${a+1} (${mt[t(this,D)[a]]}) drum NRPN ${k} commit`)}}else{let k=ur[t(this,b)[y+E[100]]],r=pr[t(this,b)[y+E[100]]];t(this,b)[y+E[101]]==0&&k!=null&&(O()&&console.debug(`CH${a+1} RPN 0 ${t(this,b)[y+E[100]]} commit: ${e.data[1]}`),e.data[1]=Math.min(Math.max(e.data[1],gr[k][0]),gr[k][1]),t(this,R)[a*m.rpn+k]=e.data[1],t(this,L)[a*m.rpnt+r]=1,this.dispatchEvent("pitch",{part:a,pitch:this.getPitchShift(a)}))}break}case 32:{switch(O()&&console.debug(`${W[t(this,A)]}, CH${a+1} LSB: ${e.data[1]}`),t(this,A)){case S.s90es:case S.motif:{this.setChType(a,[32,40].indexOf(e.data[1])>-1?this.CH_DRUMS:this.CH_MELODIC,t(this,A),!0);break}}this.getExt(a)[0]==this.EXT_DX,this.dispatchEvent("voice",{part:a});break}case 38:{if(!t(this,Ge)){let k=ur[t(this,b)[y+100]],r=pr[t(this,b)[y+100]];t(this,b)[y+101]==0&&k!=null&&(t(this,R)[a*m.rpn+k+1]=e.data[1],t(this,L)[a*m.rpnt+r]=1)}break}case 64:{e.data[1]<64&&t(this,V).hoOf(a);break}case 66:{e.data[1]>>6?t(this,V).soOn(a):t(this,V).soOf(a);break}case 98:case 99:{x(this,Ge,1);break}case 100:case 101:{x(this,Ge,0);break}}t(this,b)[y+E[e.data[0]]]=e.data[1],this.dispatchEvent("cc",{part:a,cc:e.data[0],data:e.data[1]})}h.getChModeId(a)==S.xg&&t(h,D)[a]&&h.setDrumFirstWrite(a)},12:function(e){let a=e.channel,h=this;switch(t(h,A)){case S.s90es:case S.motif:{e.data&&h.setChActive(a,1);break}default:h.setChActive(a,1)}if(h.getExt(a)[0]==h.EXT_DX){let n=m.cc*a}t(h,I)[a]=e.data,t(h,Ee)[a]=0,O()&&console.debug(`T:${e.track} C:${a} P:${e.data}`),h.dispatchEvent("voice",{part:a}),h.getChModeId(a)==S.xg&&t(h,D)[a]&&h.setDrumFirstWrite(a)},13:function(e){let a=this,h=e.channel;t(this,z).forEach(function(n){let p=n>>7;h==p&&(t(a,K)[n]=e.data,a.dispatchEvent("note",{part:h,note:n&127,velo:e.data,state:a.NOTE_SUSTAIN}))})},14:function(e){let a=e.channel;t(this,Te)[a]=e.data[1]*128+e.data[0]-8192,this.dispatchEvent("pitch",{part:a,pitch:this.getPitchShift(a)})},15:function(e){Qr(e.data).forEach(a=>{let h=a[0],n=a[1];(t(this,Rt)[h]||function(){console.debug(`Unknown manufacturer ${h}.`)})(n,a.subarray(2),e.track)})},248:function(e){},250:function(e){},251:function(e){},252:function(e){},254:function(e){},255:function(e){(t(this,j)[e.meta]||function(h,n,p){}).call(this,e.data,e.track,e.meta),e.meta!=32&&x(this,Ve,0);let a=Kr.indexOf(e.meta)>-1;if(O()&&console.debug(e),a)return e.reply="meta",e}});T(this,Rt,{64:(e,a,h)=>{t(this,We).run(a,h,e)},65:(e,a,h)=>{if(a[0]<16)if(a[1]==72){let n=a[a.length-1],p=De(a.subarray(3,a.length-1));n==p?t(this,he).run(a.subarray(0,a.length-1),h,e):console.warn(`Bad SD checksum ${n} - should be ${p}.`)}else t(this,he).run(a,h,e);else{let n=a[a.length-1],p=De(a.subarray(2,a.length-1));n==p?t(this,he).run(a.subarray(0,a.length-1),h,e):console.warn(`Bad GS checksum ${n} - should be ${p}.`)}},66:(e,a,h)=>{t(this,ke).run(a,h,e)},67:(e,a,h)=>{t(this,ce).run(a,h,e)},68:(e,a,h)=>{t(this,Ye).run(a,h,e)},71:(e,a,h)=>{t(this,Qe).run(a,h,e)},126:(e,a,h)=>{t(this,ze).run(a,h,e)},127:(e,a,h)=>{this.switchMode("gm"),t(this,qe).run(a,h,e)}});T(this,ze,void 0);T(this,qe,void 0);T(this,ce,void 0);T(this,he,void 0);T(this,ke,void 0);T(this,We,void 0);T(this,Qe,void 0);T(this,Ye,void 0);let e=this;x(e,oe,new Uint8Array(256),$r),t(e,Se)[10]=new Uint8Array(512),x(e,Ke,new ue),x(e,B,{x5:82,ds:S.krs,smotif:S.s90es,gs:4,sc:3}),x(e,we,{dumpLimit:e.DUMP_MODE}),x(e,wt,new Proxy(t(e,we),{set:()=>{}}));for(let r in dr){let o=S[r];o==null?console.debug(`SubDB build error: "${r}" does not exist`):t(e,q)[o]=new Uint8Array(dr[r])}e.userBank.strictMode=!0,e.userBank.load(`MSB	PRG	LSB	NME
062	000	000	
122	000	000	
122	001	000	
122	002	000	
122	003	000	
122	004	000	
122	005	000	
122	006	000	`),e.addEventListener("metacommit",function(r){var l,i;let{data:o}=r;((l=t(e,ne)[0])==null?void 0:l.type)==o.type&&((i=t(e,ne)[0])!=null&&i.amend)?(t(e,ne)[0].amend=o.amend,t(e,ne)[0].data+=o.data):t(e,ne).unshift(o)}),t(e,j)[1]=function(r){var o,l,i,s,c;switch(r=r.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),r.slice(0,2)){case"@I":{x(this,G,!0),this.dispatchEvent("metacommit",{type:"Kar.Info",data:(o=r.slice(2))==null?void 0:o.trimLeft()});break}case"@K":{x(this,G,!0),this.dispatchEvent("metacommit",{type:"Kar.Mode",data:(l=r.slice(2))==null?void 0:l.trimLeft()}),console.debug(`Karaoke mode active: ${r.slice(2)}`);break}case"@L":{x(this,G,!0),this.dispatchEvent("metacommit",{type:"Kar.Lang",data:(i=r.slice(2))==null?void 0:i.trimLeft()});break}case"@T":{x(this,G,!0),this.dispatchEvent("metacommit",{type:"KarTitle",data:(s=r.slice(2))==null?void 0:s.trimLeft()});break}case"@V":{x(this,G,!0),this.dispatchEvent("metacommit",{type:"Kar.Ver.",data:(c=r.slice(2))==null?void 0:c.trimLeft()});break}case"XF":{let d=r.slice(2).split(":");switch(d[0]){case"hd":{d.slice(1).forEach((u,f)=>{u.length&&this.dispatchEvent("metacommit",{type:["XfSngDte","XfSngRgn","XfSngCat","XfSongBt","XfSngIns","XfSngVoc","XfSngCmp","XfSngLrc","XfSngArr","XfSngPer","XfSngPrg","XfSngTag"][f],data:u})});break}case"ln":{d.slice(1).forEach((u,f)=>{u.length&&this.dispatchEvent("metacommit",{type:["XfKarLng","XfKarNme","XfKarCmp","XfKarLrc","XfKarArr","XfKarPer","XfKarPrg"][f],data:u})});break}default:this.dispatchEvent("metacommit",{type:"XfUnData",data:r})}break}default:t(this,G)?r[0]=="\\"?(this.dispatchEvent("metacommit",{type:"KarLyric",data:"",amend:!1}),this.dispatchEvent("metacommit",{type:"KarLyric",data:r.slice(1),amend:!0})):r[0]=="/"?(this.dispatchEvent("metacommit",{type:"KarLyric",data:"",mask:!0,amend:!1}),this.dispatchEvent("metacommit",{type:"KarLyric",data:r.slice(1),mask:!0,amend:!0})):this.dispatchEvent("metacommit",{type:"KarLyric",data:r,amend:!0}):r.split(`
`).forEach((d,u)=>{this.dispatchEvent("metacommit",{type:"Cmn.Text",data:d,mask:u!=0})})}},t(e,j)[2]=function(r){this.dispatchEvent("metacommit",{type:"Copyrite",data:r})},t(e,j)[3]=function(r,o){o<1&&t(this,Ve)<1&&this.dispatchEvent("metacommit",{type:"TrkTitle",data:r})},t(e,j)[4]=function(r,o){this.dispatchEvent("metacommit",{type:"Instrmnt",data:r})},t(e,j)[5]=function(r){r.trim()==""?this.dispatchEvent("metacommit",{type:"C.Lyrics",data:"",amend:!1}):this.dispatchEvent("metacommit",{type:"C.Lyrics",data:r,amend:!0})},t(e,j)[6]=function(r){this.dispatchEvent("metacommit",{type:"C.Marker",data:r})},t(e,j)[7]=function(r){this.dispatchEvent("metacommit",{type:"CuePoint",data:r})},t(e,j)[32]=function(r){x(this,Ve,r[0]+1)},t(e,j)[33]=function(r,o){O()&&console.debug(`Track ${o} requests to get assigned to output ${r}.`),t(e,Be)[o]=r+1},t(e,j)[81]=function(r,o){x(e,dt,r/1e3)},t(e,j)[127]=function(r,o){t(e,Ke).run(r,o)},t(e,Ke).default=function(r){console.warn(`Unrecognized sequencer-specific byte sequence: ${r}`)},t(e,Ke).add([67,0,1],function(r,o){t(e,Be)[o]=r[0]+1}),x(e,ze,new ue("universal non-realtime")),x(e,qe,new ue("universal realtime")),x(e,ce,new ue("Yamaha")),x(e,he,new ue("Roland")),x(e,ke,new ue("Korg")),x(e,We,new ue("Kawai")),x(e,Qe,new ue("Akai")),x(e,Ye,new ue("Casio"));let a=new ue("DX7+ Dump"),h=function(r){console.info(`Unrecognized SysEx in "${this.name}" set.
%o`,r)};t(e,ze).default=h,t(e,qe).default=h,t(e,ce).default=h,t(e,he).default=h,t(e,ke).default=h,t(e,We).default=h,t(e,Qe).default=h,t(e,Ye).default=h,a.default=h,t(e,ze).add([9],(r,o,l)=>{e.switchMode(["gm","?","g2"][r[0]-1],!0),e.setPortMode(e.getTrackPort(o),1,S[["gm","?","g2"][r[0]-1]]),x(e,G,t(e,G)||!1),console.info(`MIDI reset: ${["GM","Init","GM2"][r[0]-1]}`),r[0]==2&&e.init()}),t(e,qe).add([4,1],(r,o,l)=>{e.dispatchEvent("mupromptex"),x(e,H,((r[1]<<7)+r[0])/16383*100),e.dispatchEvent("mastervolume",t(e,H))}).add([4,3],(r,o,l)=>((r[1]<<7)+r[0]-8192)/8192).add([4,4],(r,o,l)=>r[1]-64).add([4,5],(r,o,l)=>{e.dispatchEvent("mupromptex");let i=r[0],s=r[1],c=r[2],d=3,u=d+(i<<1),f=u+s;if(i!=1){console.error(`Unsupported GM2 global parameter set: slotpath length too long (${i})!
`,r);return}let $=0,w=0,C=0;switch(r.subarray(d,u).forEach(M=>{$=$<<7,$|=M}),r.subarray(u,f).forEach((M,_)=>{w|=M<<_*7}),r.subarray(f).forEach((M,_)=>{C|=M<<_*7}),O()&&console.debug(`GM2 global parameter: (${r.subarray(3,u)}; p: ${w}, v: ${C})`),$){case 129:{w==0&&(e.setEffectType(0,52,C),e.dispatchEvent("efxreverb",e.getEffectType(0)));break}case 130:{w==0&&(e.setEffectType(1,52,C|16),e.dispatchEvent("efxchorus",e.getEffectType(1)));break}default:O()&&console.debug("GM2 global paramater slot path unknown.")}}),t(this,ce).add([76,0,0],(r,o,l)=>{switch(r[0]){case 125:{e.initDrums(),console.info(`XG drum setup reset: ${r}`);break}case 126:{e.switchMode("xg",!0),e.setPortMode(e.getTrackPort(o),4,S.xg),x(e,G,!1),console.info("MIDI reset: XG");break}default:{e.dispatchEvent("mupromptex");let i=[0,0,0,0],s=(c,d)=>{i[d]=c};if(r.subarray(1).forEach((c,d)=>{let u=d+r[0];([s,s,s,s,f=>{x(this,H,f*129/16383*100),e.dispatchEvent("mastervolume",t(e,H))},f=>{},f=>{}][u]||(()=>{}))(c,d)}),r[0]<4){let c=0;i.forEach(d=>{c=c<<4,c+=d}),c-=1024}}}}).add([76,2,1],(r,o,l)=>{e.dispatchEvent("mupromptex");let i="XG ";r[0]<32?(i+="reverb ",r.subarray(1).forEach((s,c)=>{([d=>{e.setEffectTypeRaw(0,!1,d),console.info(`${i}main type: ${Et[d]}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},d=>{e.setEffectTypeRaw(0,!0,d),console.debug(`${i}sub type: ${d+1}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},d=>{console.debug(`${i}time: ${tr(d)}s`)},d=>{console.debug(`${i}diffusion: ${d}`)},d=>{console.debug(`${i}initial delay: ${d}`)},d=>{console.debug(`${i}HPF cutoff: ${st[d]}Hz`)},d=>{console.debug(`${i}LPF cutoff: ${st[d]}Hz`)},d=>{console.debug(`${i}width: ${d}`)},d=>{console.debug(`${i}height: ${d}`)},d=>{console.debug(`${i}depth: ${d}`)},d=>{console.debug(`${i}wall type: ${d}`)},d=>{console.debug(`${i}dry/wet: ${d}`)},d=>{console.debug(`${i}send: ${re(d)}dB`)},d=>{console.debug(`${i}pan: ${d-64}`)},!1,!1,d=>{console.debug(`${i}delay: ${d}`)},d=>{console.debug(`${i}density: ${d}`)},d=>{console.debug(`${i}balance: ${d}`)},d=>{},d=>{console.debug(`${i}feedback: ${d}`)},d=>{}][r[0]+c]||function(){console.warn(`Unknown XG reverb address: ${r[0]}.`)})(s)})):r[0]<64?(i+="chorus ",r.subarray(1).forEach((s,c)=>{([d=>{e.setEffectTypeRaw(1,!1,d),console.info(`${i}main type: ${Et[d]}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},d=>{e.setEffectTypeRaw(1,!0,d),console.debug(`${i}sub type: ${d+1}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},d=>{console.debug(`${i}LFO: ${er[d]}Hz`)},d=>{},d=>{console.debug(`${i}feedback: ${d}`)},d=>{console.debug(`${i}delay offset: ${rr(d)}ms`)},d=>{},d=>{console.debug(`${i}low: ${st[d]}Hz`)},d=>{console.debug(`${i}low: ${d-64}dB`)},d=>{console.debug(`${i}high: ${st[d]}Hz`)},d=>{console.debug(`${i}high: ${d-64}dB`)},d=>{console.debug(`${i}dry/wet: ${d}`)},d=>{console.debug(`${i}send: ${re(d)}dB`)},d=>{console.debug(`${i}pan: ${d-64}`)},d=>{console.debug(`${i}to reverb: ${re(d)}dB`)},!1,d=>{},d=>{},d=>{},d=>{console.debug(`${i}LFO phase diff: ${(d-64)*3}deg`)},d=>{console.debug(`${i}input mode: ${d?"stereo":"mono"}`)},d=>{}][r[0]-32+c]||function(){console.warn(`Unknown XG chorus address: ${r[0]}.`)})(s)})):r[0]<86?(i+="variation ",r.subarray(1).forEach((s,c)=>{([d=>{e.setEffectTypeRaw(2,!1,d),console.info(`${i}main type: ${Et[d]}`),e.dispatchEvent("efxdelay",e.getEffectType(2))},d=>{e.setEffectTypeRaw(2,!0,d),console.debug(`${i}sub type: ${d+1}`),e.dispatchEvent("efxdelay",e.getEffectType(2))}][r[0]-64+c]||function(){})(s)})):r[0]<97?(i+="variation ",r.subarray(1).forEach((s,c)=>{[d=>{console.debug(`${i}send: ${re(d)}dB`)},d=>{console.debug(`${i}pan: ${d-64}`)},d=>{console.debug(`${i}to reverb: ${re(d)}dB`)},d=>{console.debug(`${i}to chorus: ${re(d)}dB`)},d=>{console.debug(`${i}connection: ${d?"system":"insertion"}`)},d=>{console.debug(`${i}channel: CH${d+1}`)},d=>{console.debug(`${i}mod wheel: ${d-64}`)},d=>{console.debug(`${i}bend wheel: ${d-64}`)},d=>{console.debug(`${i}channel after touch: ${d-64}`)},d=>{console.debug(`${i}AC1: ${d-64}`)},d=>{console.debug(`${i}AC2: ${d-64}`)}][r[0]-86+c](s)})):r[0]>111&&r[0]<118?i+="variation ":console.warn(`Unknown XG variation address: ${r[0]}`)}).add([76,2,64],(r,o,l)=>{r.subarray(1).forEach((i,s)=>{let c=s+r[0];if(c==0)console.debug(`XG EQ preset: ${["flat","jazz","pop","rock","classic"][i]}`);else{let d=c-1>>2,u=c-1&3,f=`XG EQ ${d} ${["gain","freq","Q","shape"][u]}: `;[()=>{console.debug(`${f}${i-64}dB`)},()=>{console.debug(`${f}${i} (raw)`)},()=>{console.debug(`${f}${i/10}`)},()=>{console.debug(`${f}${["shelf","peak"][+!!i]}`)}][u]()}})}).add([76,3],(r,o,l)=>{e.dispatchEvent("mupromptex");let i=r[0],s=r[1],c=`XG Insertion ${r[0]+1} `;r.subarray(2).forEach((d,u)=>{([f=>{e.setEffectTypeRaw(3+i,!1,f),console.info(`${c}main type: ${Et[f]}`),e.dispatchEvent(`efxinsert${i}`,e.getEffectType(3+i))},f=>{e.setEffectTypeRaw(3+i,!0,f),console.debug(`${c}sub type: ${f+1}`),e.dispatchEvent(`efxinsert${i}`,e.getEffectType(3+i))}][s+u]||function(){})(d)})}).add([76,6,0],(r,o,l)=>{let i=r[0];i<64?e.setLetterDisplay(r.subarray(1),"XG letter display",i):x(e,Ue,Date.now())}).add([76,7,0],(r,o,l)=>{let i=r[0];x(e,Y,0),x(e,ge,Date.now()+3200),t(e,oe,xe).fill(0);let s=r.subarray(1);for(let c=0;c<i;c++)s.unshift(0);s.forEach(function(c,d){let u=Math.floor(d/16),f=d%16,$=(f*3+u)*7,w=7,C=0;for($-=f*5,u==2&&(w=2);C<w;)t(e,oe,xe)[$+C]=c>>6-C&1,C++})}).add([76,8],(r,o)=>{e.dispatchEvent("mupromptex");let l=e.chRedir(r[0],o,!0),i=r[1],s=m.cc*l,c=`XG CH${l+1} `,d=`Unknown XG part address ${i}.`,u=!0;r.subarray(2).forEach((f,$)=>{u=!0,i<1?console.debug(d):i<41?([()=>{t(e,b)[s+E[0]]=f,e.dispatchEvent("voice",{part:l})},()=>{t(e,b)[s+E[32]]=f,e.dispatchEvent("voice",{part:l})},()=>{t(e,I)[l]=f,e.dispatchEvent("voice",{part:l})},()=>{u=!1;let w=e.chRedir(f,o,!0);t(e,F)[l]=w,l!=w&&(e.buildRchTree(),console.info(`${c}receives from CH${w+1}`)),t(e,de)[l]||(e.copyChSetup(w,l,!0),console.debug(`${c}copied from CH${w+1}.`),e.setChActive(l,1),e.dispatchEvent("voice",{part:l}))},()=>{t(e,ae)[l]=+!f},()=>{},()=>{u=!1,e.setChType(l,f,S.xg),console.debug(`${c}type: ${mt[f]||f}`),e.dispatchEvent("voice",{part:l})},()=>{t(e,R)[m.rpn*l+3]=f,t(e,L)[m.rpnt*l+2]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)})},!1,!1,()=>{t(e,b)[s+E[7]]=f},!1,!1,()=>{t(e,b)[s+E[10]]=f||128},!1,!1,()=>{t(e,b)[s+E[128]]=f,e.allocateAce(128)},()=>{t(e,b)[s+E[93]]=f},()=>{t(e,b)[s+E[91]]=f},()=>{t(e,b)[s+E[94]]=f},()=>{t(e,b)[s+E[76]]=f},()=>{t(e,b)[s+E[77]]=f},()=>{t(e,b)[s+E[78]]=f},()=>{t(e,b)[s+E[74]]=f},()=>{t(e,b)[s+E[71]]=f},()=>{t(e,b)[s+E[73]]=f},()=>{t(e,b)[s+E[75]]=f},()=>{t(e,b)[s+E[72]]=f}][i+$-1]||(()=>{}))():i<48?console.debug(d):i<111?i>102&&i<105&&(t(e,b)[s+E[[5,65][i&1]]]=f):i<114?console.debug(d):i<116?console.debug(`${c}EQ ${["bass","treble"][i&1]} gain: ${f-64}dB`):i<118?console.debug(d):i<120?console.debug(`${c}EQ ${["bass","treble"][i&1]} freq: ${f}`):console.debug(d)}),u&&t(e,D)[l]>1&&e.setDrumFirstWrite(l)}).add([76,9],(r,o)=>{let l=e.chRedir(r[0],o,!0),i=r[1],s=m.cc*l,c=`PLG-VL CH${l+1} `;r.subarray(2).forEach((d,u)=>{let f=u+i;switch(f){case 1:{console.info(`${c}breath mode: ${["system","breath","velocity","touch EG"][d]}`);break}case 0:case 27:case 28:break;default:if(f<27){let $=f-3>>1,w=["pressure","embouchure","tonguing","scream","breath noise","growl","throat formant","harmonic enhancer","damping","absorption","amplification","brightness"][$];f&1?f<23?(console.debug(`${c}${w} control source: ${sr(d)}`),d&&d<96&&e.allocateAce(130+$),t(e,Xe)[m.redir*l+$+2]=d,e.buildRccMap()):console.debug(`${c}${w} scale break point: ${d}`):(console.debug(`${c}${w} depth: ${d-64}`),t(e,b)[s+E[130+$]]=d)}}})}).add([76,10],(r,o,l)=>{}).add([76,16],(r,o,l)=>{}).add([76,17,0,0],(r,o,l)=>{}).add([76,112],(r,o,l)=>{switch(console.debug(`XG enable PLG-${["VL","SG","DX","AN","PF","DR","PC","AP"][r[0]]} for CH${r[2]+1}.`),r[0]){case 0:{t(e,ie)[m.ext*r[2]]=e.EXT_VL;break}case 2:{t(e,ie)[m.ext*r[2]]=e.EXT_DX;break}default:t(e,ie)[m.ext*r[2]]=e.EXT_NONE}}).add([73,0,0],(r,o)=>{let l=r[0],i="MU1000 System - ";r.subarray(1).forEach((s,c)=>{let d=l+c;d==8?console.debug(`${i}LCD contrast: ${s}.`):d==18?(t(e,q)[S.xg][1]=s?126:0,console.debug(`${i}default bank: ${s?"MU100 Native":"MU Basic"}.`),e.dispatchEvent("banklevel",{mode:"xg",data:+!!s}),e.forceVoiceRefresh()):d>=64&&d<69&&[()=>{e.dispatchEvent("channelactive",s)},()=>{s<8?(e.dispatchEvent("channelmin",s<<4),console.debug(`Octavia System: Minimum CH${(s<<4)+1}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{s<8?(e.dispatchEvent("channelmax",(s<<4)+15),console.debug(`Octavia System: Maximum CH${(s<<4)+16}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges")},()=>{x(e,ye,!!s),console.info(`Octavia System: RS receiving ${["dis","en"][s]}abled.`)}][d-64]()})}).add([73,10,0],(r,o)=>{let l=r[0],i=`MU1000 RS${t(e,ye)?"":" (ignored)"}: `;if(l<16)switch(l){case 2:{let s=e.chRedir(0,o,!0);t(e,ye)&&(e.dispatchEvent("channelmin",s),e.dispatchEvent("channelmax",s+63)),console.info(`${i}Show CH1~64`);break}case 3:{let s=e.chRedir(r[1]<<5,o,!0);t(e,ye)&&e.dispatchEvent("channelmin",s),t(e,ye)&&e.dispatchEvent("channelmax",s+31),console.info(`${i}Show CH${s+1}~CH${s+32}`);break}default:console.debug(`${i}unknown switch ${l} invoked.`)}else if(l<32){if(t(e,ye)){let s=e.chRedir(l-16+(t(e,ht)<<4),o,!0);e.dispatchEvent("channelactive",s)}}else if(l<36){let s=e.chRedir(l-32<<4,o,!0);t(e,ye)&&(e.dispatchEvent("channelmin",s),e.dispatchEvent("channelmax",s+15),x(e,ht,l-32)),console.info(`${i}Show CH${s+1}~CH${s+16}`)}}).add([73,11,0],(r,o)=>{let l="MU1000 System - channel ",i="Octavia System - channel ",s=r[0];r.subarray(1).forEach((c,d)=>{let u=s+d;([()=>{e.setChActive(c,1),e.dispatchEvent("channelactive",c),O()&&console.debug(`${l}current part: CH${c+1}`)},()=>{c<5?(e.dispatchEvent("portrange",1<<c),console.debug(`${l}port range: ${1<<c} port(s)`)):(e.dispatchEvent("portrange",0),console.debug(`${l}port range: reset`))},()=>{c<16?(e.dispatchEvent("portstart",c),console.debug(`${i}start port: ${"ABCDEFGHIJKLMNOP"[c]}`)):(e.dispatchEvent("portstart",255),console.debug(`${i}start port: reset`))}][u]||(()=>{console.debug(`${l}unknown address: ${u}`)}))()})}).add([93,3],(r,o)=>{let l=e.chRedir(r[0],o,!0),i=`PLG-100SG CH${l+1} `,s=Date.now();if(r[1]==0){let c="",d=0;r.subarray(2).forEach((u,f)=>{f%2==0?c+=ar[u]||u.toString().padStart("0"):d+=u*13}),s>=t(e,ft)&&this.dispatchEvent("metacommit",{type:"SGLyrics",data:"",amend:!1}),this.dispatchEvent("metacommit",{type:"SGLyrics",data:`${ir(c)}`,amend:!0}),x(e,ft,s+Math.ceil(d/2)+t(e,dt)),O()&&console.debug(`${i}vocals: ${c}`)}else console.warn(`Unknown PLG-100SG data: ${r}`)}).add([98,0],(r,o,l)=>{e.dispatchEvent("mupromptex");let i=r[0],s=r.length-5,c=r.length-1;if(i!=s){console.info(`PLG-DX native dump size mismatch! Gave ${i} instead of ${r.length-5}.`);return}let d=De(r.subarray(4,c));if(d!=r[c]){console.info(`Bad PLG-DX checksum ${r[c]} - should be ${d}.`);return}r[0]=98,t(e,ce).run(r.subarray(0,c),o,l,{noAce:!0})}).add([98,96],(r,o,l,i)=>{let s=e.chRedir(r[0],o,!0),c=m.cc*s,d=r[1];r.subarray(2).forEach((u,f)=>{let $=d+f;if(!($<10)){if($==10)e.resetAce();else if($<27){let w=$+131;i!=null&&i.noAce||e.allocateAce(w),t(e,b)[c+E[w]]=u,e.dispatchEvent("cc",{part:s,cc:w,data:u})}}})}).add([100,0],(r,o,l)=>{let i=r.subarray(0,r.length-1);if(r[0]+5!=r.length){console.warn(`Yamaha DX7+ dump SysEx size mismatch! Expected ${r.length}, but got ${r[0]}:
`,r);return}let s=De(i),c=r[r.length-1];if(s!=c){console.warn(`Yamaha DX7+ dump SysEx checksum mismatch! Expected ${s}, but got ${c}:
`,r);return}a.run(i.subarray(1))}).add([100,76],(r,o,l)=>{let i=r[0]>>4,s=r[0]&15,c=r[1];switch(i){case 2:{let d=e.chRedir(s,o,!0),u=m.cc*d;r.subarray(2).forEach((f,$)=>{let w=$+c;if(!(w<7)){if(w<23){let C=w+135;e.allocateAce(C),t(e,b)[u+E[C]]=f,e.dispatchEvent("cc",{part:d,cc:C,data:f})}}});break}default:console.info("Unknown DX7+ multipart: %o",r)}}),a.add([14,31],(r,o,l)=>{t(e,b)[m.cc*r[0]+E[64]]=0,t(e,V).ano(r[0]),e.switchMode("xg"),e.setPortMode(e.getTrackPort(o),1,S.xg),e.resetAce(),console.debug(`Yamaha DX7+ reset CH${r[0]+1}.`)}).add([76,112],async r=>{let o=r[0],l=m.cc*o,i=m.ext*o,s=m.cvn*o;t(e,ie)[i]=e.EXT_DX,t(e,Ee)[o]=1;let c=t(e,$t).subarray(s,s+m.cvn);c.fill(32),r.subarray(1).forEach((d,u)=>{if(u<10)c[u]=Math.max(d,32);else if(!(u<40)){if(u<56){let f=u+102;t(e,b)[l+E[f]]=d,e.dispatchEvent("cc",{part:o,cc:f,data:d})}}}),t(e,I)[o]=o&127,t(e,b)[m.cc*o+E[0]]=35,t(e,b)[m.cc*o+E[32]]=o>>7|4,e.dispatchEvent("voice",{part:o}),console.debug(`DX7+ CH${o+1} dump: %o`,r)});let n=function(r,o,l,i){},p=function(r,o){e.dispatchEvent("mupromptex");let l=r*m.dpn,i=o[0],s=o[1];o.subarray(2).forEach((c,d)=>{let u=d+s,f=-1;u<16?([()=>{f=24},()=>{f=25},()=>{f=26},()=>{},()=>{f=28},()=>{f=29},()=>{f=30},()=>{f=31},()=>{},()=>{},()=>{},()=>{f=20},()=>{f=21},()=>{f=22},()=>{f=23},()=>{}][u]||(()=>{console.debug(`Unknown XG-style drum param ${u} on set ${r+1}.`)}))():u<32||(u<40?([()=>{f=48},()=>{f=49},!1,!1,()=>{f=52},()=>{f=53}][u-32]||(()=>{console.debug(`Unknown XG-style drum param ${u} on set ${r+1}.`)}))():u<80||([()=>{f=36}][u-80]||(()=>{console.debug(`Unknown XG-style drum param ${u} on set ${r+1}.`)}))()),f>=0?(O()&&console.debug(l,f,i,c),t(e,ee)[(l+le[f])*m.dnc+i]=c):O()&&console.debug(`XG-style drum param ${u} has no writes.`)})},y=function(r,o,l){e.dispatchEvent("mupromptex");let i=r*m.dpn,s=(o<<7)+l[0];l.subarray(1).forEach((c,d)=>{let u=d+s,f=u&127,$=u>>7,w=-1;$>1&&([()=>{w=26},()=>{},()=>{w=28},()=>{w=29},()=>{w=30},()=>{},()=>{},()=>{w=31}][$-2]||(()=>{console.debug(`Unknown GS-style drum param ${$} on set ${r+1}.`)}))(),w>-1?(O()&&console.debug(i,w,f,c),t(e,ee)[(i+le[w])*m.dnc+f]=c):O()&&console.debug(`GS-style drum param ${$} has no writes.`)})};t(this,ce).add([76,48],(r,o,l)=>{p(0,r)}).add([76,49],(r,o,l)=>{p(1,r)}).add([76,50],(r,o,l)=>{p(2,r)}).add([76,51],(r,o,l)=>{p(3,r)}).add([76,52],(r,o,l)=>{p(4,r)}).add([76,53],(r,o,l)=>{p(5,r)}).add([76,54],(r,o,l)=>{p(6,r)}).add([76,55],(r,o,l)=>{p(7,r)}),t(this,ce).add([89,0],(r,o,l)=>{if(e.eprom){let i=r[0],s=(r[1]<<14)+(r[2]<<7)+r[3]+(e.eprom.offset||0);O()&&console.debug(`MU1000 EPROM trail to 0x${s.toString(16).padStart(6,"0")}, ${i} bytes.`);let c=e.eprom.data;r.subarray(4).forEach((d,u)=>{let f=u>>3,$=u&7;if($==7)for(let w=0;w<7;w++)c[s+7*f+w]+=(d>>6-w&1)<<7;else c[s+7*f+$]=d})}}).add([89,1],(r,o,l)=>{let i=(r[0]<<21)+(r[1]<<14)+(r[2]<<7)+r[3];O()&&console.debug(`MU1000 EPROM jump to 0x${i.toString(16).padStart(6,"0")}.`),e.eprom&&(e.eprom.offset=i)}).add([89,2],(r,o,l)=>{if(e.eprom){let i=(r[0]<<21)+(r[1]<<14)+(r[2]<<7)+r[3]+(e.eprom.offset||0);O()&&console.debug(`MU1000 EPROM write to 0x${i.toString(16).padStart(6,"0")}.`);let s=e.eprom.data;r.subarray(4).forEach((c,d)=>{let u=d>>3,f=d&7;if(f==7)for(let $=0;$<7;$++)s[i+7*u+$]+=(c>>6-$&1)<<7;else s[i+7*u+f]=c})}}).add([89,3],(r,o,l)=>{}),t(this,ce).add([39,48],(r,o,l)=>{}).add([43,0,0],(r,o,l)=>{e.dispatchEvent("mupromptex");let i=[0,0,0,0],s=(c,d)=>{i[d]=c};if(r.subarray(1).forEach((c,d)=>{let u=d+r[0];[s,s,s,s,()=>{x(this,H,c*129/16383*100),e.dispatchEvent("mastervolume",t(e,H))},()=>c-64,()=>c||128,()=>c,()=>c,()=>{console.debug(`TG300 variation on cc${c}.`)}][u](c,u)}),r[0]<4){let c=0;i.forEach(d=>{c=c<<4,c+=d}),c-=1024}}).add([43,1,0],(r,o,l)=>{e.dispatchEvent("mupromptex")}).add([43,2],(r,o,l)=>{e.dispatchEvent("mupromptex");let i=e.chRedir(r[0],o,!0),s=r[1],c=m.cc*i,d=`TG300 CH${i+1} `;r.subarray(2).forEach((u,f)=>{f<5?([()=>{},()=>{t(e,b)[c+E[0]]=u,e.dispatchEvent("voice",{part:i})},()=>{t(e,b)[c+E[32]]=u,e.dispatchEvent("voice",{part:i})},()=>{t(e,I)[i]=u,e.dispatchEvent("voice",{part:i})},()=>{let $=e.chRedir(u,o,!0);t(e,F)[i]=$,i!=$&&(e.buildRchTree(),console.info(`${d}receives from CH${$+1}`))}][f+s]||(()=>{}))(u,f+s):f<21||(f<47?([()=>{t(e,ae)[i]=+!u},()=>{},()=>{},()=>{t(e,R)[m.rpn*i+3]=u,t(e,L)[m.rpnt*i+2]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{},()=>{t(e,b)[c+E[7]]=u},!1,!1,()=>{t(e,b)[c+E[10]]=u||128},!1,!1,()=>{console.debug(`${d} AC1 at cc${u}`)},()=>{console.debug(`${d} AC2 at cc${u}`)},()=>{t(e,b)[c+E[128]]=u,e.allocateAce(128)},()=>{t(e,b)[c+E[93]]=u},()=>{t(e,b)[c+E[91]]=u},()=>{t(e,b)[c+E[94]]=u},()=>{t(e,b)[c+E[76]]=u},()=>{t(e,b)[c+E[77]]=u},()=>{t(e,b)[c+E[74]]=u},()=>{t(e,b)[c+E[71]]=u},()=>{t(e,b)[c+E[73]]=u},()=>{t(e,b)[c+E[75]]=u},()=>{t(e,b)[c+E[72]]=u},()=>{t(e,b)[c+E[78]]=u}][f+s-21]||(()=>{}))(u,f+s):f<95||([()=>{t(e,b)[c+E[65]]=u},()=>{t(e,b)[c+E[5]]=u}][f+s-95]||(()=>{}))(u,f+s))})}).add([43,7,0],(r,o,l)=>{let i=r[0];e.setLetterDisplay(r.subarray(1),"TG300 letter display",i)}).add([43,7,1],(r,o,l)=>{x(e,Y,0),x(e,ge,Date.now()+3200),t(e,oe,xe).fill(0),r.forEach(function(i,s){let c=Math.floor(s/16),d=s%16,u=(d*3+c)*7,f=7,$=0;for(u-=d*5,c==2&&(f=2);$<f;)t(e,oe,xe)[u+$]=i>>6-$&1,$++})}),t(this,he).add([66,18,0,0,127],(r,o,l)=>{e.switchMode("sc",!0),e.setPortMode(e.getTrackPort(o),2,S.sc),t(e,b)[m.cc*9]=120,t(e,b)[m.cc*25]=120,t(e,b)[m.cc*41]=120,t(e,b)[m.cc*57]=120,t(e,q)[S.sc][1]=t(e,B).sc,x(e,G,!1),t(e,Ce).fill(0),console.info(`GS system to ${["single","dual"][r[0]]} mode.`)}).add([66,18,64,0],(r,o,l)=>{switch(r[0]){case 127:{e.switchMode("gs",!0),e.setPortMode(e.getTrackPort(o),2,S.gs),t(e,q)[S.gs][1]=t(e,B).gs,t(e,b)[m.cc*9]=120,t(e,b)[m.cc*25]=120,t(e,b)[m.cc*41]=120,t(e,b)[m.cc*57]=120,x(e,G,!1),t(e,Ce).fill(0),console.info("MIDI reset: GS");break}default:{e.dispatchEvent("mupromptex");let i=[0,0,0,0],s=(c,d)=>{i[d]=c};if(r.subarray(1).forEach((c,d)=>{let u=d+r[0];[s,s,s,s,f=>{x(this,H,f*129/16383*100),e.dispatchEvent("mastervolume",t(e,H))},f=>{},f=>{}][u](c,d)}),r[0]<4){let c=0;i.forEach(d=>{c=c<<4,c+=d}),c-=1024}}}}).add([66,18,64,1],(r,o,l)=>{e.dispatchEvent("mupromptex");let i=r[0];if(i<16){let s="".padStart(i," ");r.subarray(1).forEach((c,d)=>{s+=String.fromCharCode(Math.max(32,c))}),s=s.padEnd(16," "),console.debug(`GS patch name: ${s}`)}else i<48||(i<65?r.subarray(1).forEach((s,c)=>{let d=`GS ${i+c>55?"chorus":"reverb"} `;([()=>{console.info(`${d}type: ${Bt[s]}`),e.setEffectType(0,40,s),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{},()=>{},()=>{},()=>{},()=>{},!1,()=>{console.debug(`${d}predelay: ${s}ms`)},()=>{console.info(`${d}type: ${nr[s]}`),e.setEffectType(1,40,16+s),e.dispatchEvent("efxchorus",e.getEffectType(1))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${d}to reverb: ${re(s)}`)},()=>{console.debug(`${d}to delay: ${re(s)}`)}][i+c-48]||(()=>{}))()}):i<80?console.debug(`Unknown GS patch address: ${i}`):i<91?r.subarray(1).forEach((s,c)=>{let d="GS delay ";([()=>{console.info(`${d}type: ${cr[s]}`),e.setEffectType(2,40,32+s),e.dispatchEvent("efxdelay",e.getEffectType(2))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${d}to reverb: ${re(s)}`)}][i+c-80]||(()=>{}))()}):console.debug(`Unknown GS patch address: ${i}`))}).add([66,18,64,2],(r,o,l)=>{let i="GS EQ ";r.subarray(1).forEach((s,c)=>{([()=>{console.debug(`${i}low freq: ${[200,400][s]}Hz`)},()=>{console.debug(`${i}low gain: ${s-64}dB`)},()=>{console.debug(`${i}high freq: ${[3e3,6e3][s]}Hz`)},()=>{console.debug(`${i}high gain: ${s-64}dB`)}][r[0]+c]||function(){console.warn(`Unknown GS EQ address: ${r[0]+c}`)})()})}).add([66,18,64,3],(r,o,l)=>{e.dispatchEvent("mupromptex");let i="GS EFX ",s=function(c,d){let u=or(t(e,se).subarray(10,12),d,c);u&&console.debug(`${i}${Nt(t(e,se).subarray(10,12))} ${u}`)};r.subarray(1).forEach((c,d)=>{([()=>{e.setEffectTypeRaw(3,!1,32+c),e.dispatchEvent("efxinsert0",e.getEffectType(3))},()=>{e.setEffectTypeRaw(3,!0,c),console.info(`${i}type: ${Nt(t(e,se).subarray(10,12))}`),e.dispatchEvent("efxinsert0",e.getEffectType(3))},!1,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,()=>{console.debug(`${i}to reverb: ${re(c)}dB`)},()=>{console.debug(`${i}to chorus: ${re(c)}dB`)},()=>{console.debug(`${i}to delay: ${re(c)}dB`)},!1,()=>{console.debug(`${i}1 source: ${c}`),c&&c<96&&e.allocateAce(c)},()=>{console.debug(`${i}1 depth: ${c-64}`)},()=>{console.debug(`${i}2 source: ${c}`),c&&c<96&&e.allocateAce(c)},()=>{console.debug(`${i}2 depth: ${c-64}`)},()=>{console.debug(`${i}to EQ: ${c?"ON":"OFF"}`)}][r[0]+d]||function(u,f){console.warn(`Unknown GS EFX address: ${f}`)})(c,r[0]+d)})}).add([66,18,65],(r,o,l)=>{y((r[0]>>4)+1<<1,r[0]&15,r.subarray(1))}).add([69,18,16],(r,o,l)=>{var i;switch(r[0]){case 0:{let s=r[1];e.setLetterDisplay(r.subarray(2),"GS display text",s);break}case 32:{x(e,ge,Date.now()+3200),r[1]==0&&(r[2]?(x(e,Y,Math.max(Math.min(r[2]-1,9),0)),O()&&console.debug(`GS switch display page ${r[2]-1}.`)):(x(e,Y,0),x(e,ge,Date.now()),O()&&console.debug("GS disable display page.")));break}default:if(r[0]<6){t(e,Y)>9&&x(e,Y,0);let s=r[0]-1<<1|r[1]>>6;t(e,Y)==s&&x(e,ge,Date.now()+3200),(i=t(e,Se)[s])!=null&&i.length||(t(e,Se)[s]=new Uint8Array(256));let c=t(e,Se)[s];O()&&console.debug(`GS frame draw page ${s}.`);let d=r[1]&63;c.fill(0),r.subarray(2).forEach(function(f,$){let w=$+d,C=Math.floor(w/16),M=w%16,_=(M*4+C)*5,Re=5,_e=0;for(_-=M*4,C==3&&(Re=1);_e<Re;)c[_+_e]=f>>4-_e&1,_e++})}else console.warn(`Unknown GS display section: ${r[0]}`)}});let v=function(r,o,l){e.dispatchEvent("mupromptex");let i=r[0],s=m.cc*o,c=m.rpn*o,d=`GS CH${o+1} `;i<3?(r.subarray(1).forEach((u,f)=>{[()=>{t(e,b)[s+E[0]]=u},()=>{t(e,I)[o]=u},()=>{let $=0;u<16?$=e.chRedir(u,l,!0):$=m.ch,t(e,F)[o]=$,o!=$&&(e.buildRchTree(),console.info(`${d}receives from CH${$+1}`))}][i+f]()}),e.dispatchEvent("voice",{part:o})):i<19||(i<44?r.subarray(1).forEach((u,f)=>{([()=>{t(e,ae)[o]=+!u},!1,()=>{e.setChType(o,u<<1,S.gs),console.debug(`${d}type: ${u?"drum ":"melodic"}${u||""}`)},()=>{t(e,R)[c+3]=u,t(e,L)[m.rpnt*o+2]=1,e.dispatchEvent("pitch",{part:o,pitch:e.getPitchShift(o)})},!1,()=>{t(e,b)[s+E[7]]=u},!1,!1,()=>{t(e,b)[s+E[10]]=u||128},!1,!1,()=>{console.debug(`${d}CC 1: cc${u}`)},()=>{console.debug(`${d}CC 2: cc${u}`)},()=>{t(e,b)[s+E[93]]=u},()=>{t(e,b)[s+E[91]]=u},!1,!1,()=>{t(e,R)[c+1]=u,t(e,L)[m.rpnt*o+1]=1,e.dispatchEvent("pitch",{part:o,pitch:e.getPitchShift(o)})},()=>{t(e,R)[c+2]=u,t(e,L)[m.rpnt*o+1]=1,e.dispatchEvent("pitch",{part:o,pitch:e.getPitchShift(o)})},()=>{t(e,b)[s+E[94]]=u}][i+f-19]||(()=>{}))()}):i<76||console.debug(`Unknown GS part address: ${i}`))},k=function(r,o){let l=r[0],i=`GS CH${o+1} `;l<2?r.subarray(1).forEach((s,c)=>{[()=>{t(e,b)[m.cc*o+E[32]]=s},()=>{}][l+c]()}):l<32?console.warn(`Unknown GS misc address: ${l}`):l<35?r.subarray(1).forEach((s,c)=>{[()=>{console.debug(`${i}EQ: o${["ff","n"][s]}`)},()=>{},()=>{console.debug(`${i}EFX: o${["ff","n"][s]}`),t(e,ot)[o]=s,e.dispatchEvent("partefxtoggle",{part:o,active:s})}][l+c-32]()}):console.warn(`Unknown GS misc address: ${l}`)};t(this,he).add([66,18,64,16],(r,o)=>{v(r,e.chRedir(9,o,!0),o)}).add([66,18,64,17],(r,o)=>{v(r,e.chRedir(0,o,!0),o)}).add([66,18,64,18],(r,o)=>{v(r,e.chRedir(1,o,!0),o)}).add([66,18,64,19],(r,o)=>{v(r,e.chRedir(2,o,!0),o)}).add([66,18,64,20],(r,o)=>{v(r,e.chRedir(3,o,!0),o)}).add([66,18,64,21],(r,o)=>{v(r,e.chRedir(4,o,!0),o)}).add([66,18,64,22],(r,o)=>{v(r,e.chRedir(5,o,!0),o)}).add([66,18,64,23],(r,o)=>{v(r,e.chRedir(6,o,!0),o)}).add([66,18,64,24],(r,o)=>{v(r,e.chRedir(7,o,!0),o)}).add([66,18,64,25],(r,o)=>{v(r,e.chRedir(8,o,!0),o)}).add([66,18,64,26],(r,o)=>{v(r,e.chRedir(10,o,!0),o)}).add([66,18,64,27],(r,o)=>{v(r,e.chRedir(11,o,!0),o)}).add([66,18,64,28],(r,o)=>{v(r,e.chRedir(12,o,!0),o)}).add([66,18,64,29],(r,o)=>{v(r,e.chRedir(13,o,!0),o)}).add([66,18,64,30],(r,o)=>{v(r,e.chRedir(14,o,!0),o)}).add([66,18,64,31],(r,o)=>{v(r,e.chRedir(15,o,!0),o)}).add([66,18,64,64],(r,o)=>{k(r,e.chRedir(9,o,!0))}).add([66,18,64,65],(r,o)=>{k(r,e.chRedir(0,o,!0))}).add([66,18,64,66],(r,o)=>{k(r,e.chRedir(1,o,!0))}).add([66,18,64,67],(r,o)=>{k(r,e.chRedir(2,o,!0))}).add([66,18,64,68],(r,o)=>{k(r,e.chRedir(3,o,!0))}).add([66,18,64,69],(r,o)=>{k(r,e.chRedir(4,o,!0))}).add([66,18,64,70],(r,o)=>{k(r,e.chRedir(5,o,!0))}).add([66,18,64,71],(r,o)=>{k(r,e.chRedir(6,o,!0))}).add([66,18,64,72],(r,o)=>{k(r,e.chRedir(7,o,!0))}).add([66,18,64,73],(r,o)=>{k(r,e.chRedir(8,o,!0))}).add([66,18,64,74],(r,o)=>{k(r,e.chRedir(10,o,!0))}).add([66,18,64,75],(r,o)=>{k(r,e.chRedir(11,o,!0))}).add([66,18,64,76],(r,o)=>{k(r,e.chRedir(12,o,!0))}).add([66,18,64,77],(r,o)=>{k(r,e.chRedir(13,o,!0))}).add([66,18,64,78],(r,o)=>{k(r,e.chRedir(14,o,!0))}).add([66,18,64,79],(r,o)=>{k(r,e.chRedir(15,o,!0))}),t(this,ke).add([54,65],(r,o)=>{let l=t(e,B).x5=="81"?"05rw":"x5d";e.switchMode(l,!0),e.setPortMode(e.getTrackPort(o),1,S[l]);let i=r[r.length-1],s=r.subarray(0,r.length-1),c=De(s);c!=i&&(console.info(`X5D multi parameters checksum mismatch! Expected ${c}, got ${i}.`),console.debug(r));let d=(r[1]<<7)+r[0],u=(r[3]<<7)+r[2],f=e.chRedir(d&15,o,!0),$=m.cc*f;[()=>{u<1||(u<101?(e.setChType(f,e.CH_MELODIC,S.x5d),t(e,I)[f]=u-1,t(e,b)[$+E[0]]=t(e,B).x5):u<229?(e.setChType(f,e.CH_MELODIC,S.x5d),t(e,I)[f]=u-101,t(e,b)[$+E[0]]=56):(e.setChType(f,e.CH_DRUMS,S.x5d),t(e,I)[f]=mr[u-229]||0,t(e,b)[$+E[0]]=62)),e.dispatchEvent("voice",{part:f})},()=>{t(e,b)[$+E[7]]=u},()=>{u<31&&(t(e,b)[$+E[10]]=Math.round((u-15)*4.2+64))},()=>{t(e,b)[$+E[93]]=yt(u)},()=>{t(e,b)[$+E[91]]=yt(u)},()=>{t(e,R)[f*m.rpn+3]=u>8191?u-16320:64+u,t(e,L)[m.rpnt*f+2]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)})},()=>{t(e,R)[f*m.rpn+1]=u>8191?u-16320:64+u,t(e,L)[m.rpnt*f+1]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)})},()=>{u>0&&(t(e,R)[f*m.rpn]=u,t(e,L)[m.rpnt*f]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)}))},()=>{}][d>>4]()}).add([54,76,0],(r,o)=>{e.dispatchEvent("mupromptex");let l=t(e,B).x5=="81"?"05rw":"x5d";e.switchMode(l),e.setPortMode(e.getTrackPort(o),1,S[l]);let i="",s=t(e,B).x5,c=0,d=0,u="MSB	PRG	LSB	NME";pe(r,function(f,$){if($<16400){let w=$%164;switch(!0){case w<10:{f>31&&(i+=String.fromCharCode(f));break}case w==10:break;case w==11:{u+=`
${s}	${c}	${d}	${i.trim().replace("Init Voice","")}`,c++,i="";break}}c>99&&(s=90,c=0)}}),e.userBank.clearRange({msb:t(e,B).x5,prg:[0,99],lsb:0}),e.userBank.load(u),O()&&console.debug(u),e.forceVoiceRefresh()}).add([54,77,0],(r,o)=>{e.dispatchEvent("mupromptex");let l=t(e,B).x5=="81"?"05rw":"x5d";e.switchMode(l),e.setPortMode(e.getTrackPort(o),1,S[l]);let i="",s=90,c=0,d=0,u="MSB	PRG	LSB	NME";pe(r,function(f,$){if($<13600){let w=$%136;switch(!0){case w<10:{f>31&&(i+=String.fromCharCode(f));break}case w==11:{u+=`
${s}	${c}	${d}	${i.trim().replace("Init Combi","")}`,c++,i="";break}}}}),e.userBank.clearRange({msb:90,prg:[0,99],lsb:0}),e.userBank.load(u),O()&&console.debug(u),e.forceVoiceRefresh()}).add([54,78],(r,o)=>{let l=t(e,B).x5=="81"?"05rw":"x5d";e.switchMode(l),e.setPortMode(e.getTrackPort(o),1,S[l]),console.debug(`X5D mode switch requested: ${["combi","combi edit","prog","prog edit","multi","global"][r[0]]} mode.`)}).add([54,85],(r,o)=>{e.dispatchEvent("mupromptex");let l=t(e,B).x5=="81"?"05rw":"x5d";e.switchMode(l),e.setPortMode(e.getTrackPort(o),1,S[l]),pe(r,(i,s)=>{s>0&&s<3&&(e.setEffectType(s-1,44,i),e.dispatchEvent(`efx${["reverb","chorus"][s-1]}`,e.getEffectType(s-1)))})}).add([54,104],(r,o)=>{e.dispatchEvent("mupromptex");let l=t(e,B).x5=="81"?"05rw":"x5d";e.switchMode(l,!0);let i=e.getTrackPort(o);if(t(e,X)[i]&&t(e,X)[i]!=S[l])if(t(e,we).dumpLimit==e.DUMP_MODE){console.warn(`Dump cancelled for track ${o}. Port ${String.fromCharCode(65+i)} mode "${W[t(e,X)[i]]}" mismatch, should be "${l}".`);return}else console.info(`Track ${o} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+i)}.`);e.setPortMode(i,1,S[l]),pe(r,function(s,c,d,u){if(c<192){let f=e.chRedir(Math.floor(c/12),o,!0),$=f*m.cc;switch(c%12){case 0:{s<128?(e.setChType(f,e.CH_MELODIC,S.x5d),t(e,b)[$+E[0]]=t(e,B).x5,t(e,I)[f]=s):(e.setChType(f,e.CH_DRUMS,S.x5d),t(e,b)[$+E[0]]=62,t(e,I)[f]=mr[s-128]),s>0&&e.setChActive(f,1),e.dispatchEvent("voice",{part:f});break}case 1:{t(e,b)[$+E[7]]=s;break}case 2:{t(e,R)[f*m.rpn+3]=s>127?s-192:64+s,t(e,L)[m.rpnt*f+2]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)});break}case 3:{t(e,R)[f*m.rpn+1]=s>127?s-192:64+s,t(e,L)[m.rpnt*f+1]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)});break}case 4:{s<31&&(t(e,b)[$+E[10]]=Math.round((s-15)*4.2+64));break}case 5:{let w=s>>4,C=s&15;t(e,b)[$+E[91]]=yt(C),t(e,b)[$+E[93]]=yt(w);break}case 10:break;case 11:{let w=e.chRedir(s&15,o,!0),C=s>>4;t(e,F)[f]=s,(w!=f||C)&&(console.info(`X5D Part CH${f+1} receives from CH${w+1}.`),e.buildRchTree())}}}else{let f=e.chRedir(c-192,o,!0)}})}),t(this,he).add([22,18,127],(r,o,l)=>{e.switchMode("mt32",!0),e.setPortMode(e.getTrackPort(o),1,S.mt32),x(e,G,!1),e.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),console.info("MIDI reset: MT-32")}).add([22,18,0],(r,o,l)=>{e.switchMode("mt32");let i=e.chRedir(l,o,!0),s=r[1];r.subarray(2).forEach((c,d)=>{let u=d+s;t(e,Ae)[u+(i-1)*16]=c,([!1,()=>{let f=t(e,Ae)[i-1<<4];if(f<3){if(t(e,Ee)[i]=1,f==2)for(let $=0;$<name.length;$++)t(e,me)[(i-1)*m.cmt+$]=t(e,Ie)[c*m.cmt+$];else{let $=e.baseBank.get(0,c+(f<<6),127,"mt32").name;for(let w=0;w<$.length;w++)t(e,me)[(i-1)*m.cmt+w]=$.charCodeAt(w)}e.dispatchEvent("voice",{part:i})}},()=>{t(e,R)[i*m.rpn+3]=c+40,t(e,L)[m.rpnt*i+2]=1},()=>{t(e,R)[i*m.rpn+1]=c+14,t(e,L)[m.rpnt*i+1]=1},()=>{t(e,R)[i*m.rpn]=c,t(e,L)[m.rpnt*i]=1},!1,()=>{t(e,b)[m.cc*i+E[91]]=c?127:0},!1,()=>{t(e,b)[m.cc*i+E[7]]=c},()=>{t(e,b)[m.cc*i+E[10]]=Math.ceil(c*9.05)}][u]||(()=>{}))()})}).add([22,18,1],(r,o,l)=>{e.switchMode("mt32");let i=l&7;console.debug(`MT-32 slot #${l+1} Drum: ${r}`);let s=r[0]<<7|r[1];r.subarray(2).forEach((c,d)=>{let u=d+s,f=(u>>2)+24,$=u&3,w=i*m.dpn;if(O()&&console.debug(`MT-32 temp drum note ${f} param ${$}: ${c}`),f<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${f}`);return}[()=>{},()=>{t(e,ee)[(w+le[26])*m.dnc+f]=Math.round(c*1.27)},()=>{t(e,ee)[(w+le[26])*m.dnc+f]=c*9+1&127},()=>{t(e,ee)[(w+le[26])*m.dnc+f]=c?127:0}][$]()})}).add([22,18,2],(r,o,l)=>{e.switchMode("mt32");let i=e.chRedir(l,o,!0),s=r[1]+(r[0]<<7);s<10&&(t(e,Ee)[i]=1),r.subarray(2).forEach((c,d)=>{let u=d+s;u<14&&(t(e,me)[(i-1)*m.cmt+u]=c)}),e.dispatchEvent("voice",{part:i})}).add([22,18,3],(r,o,l)=>{e.switchMode("mt32");let i=l&7;if(r[0]){let s=(r[0]-1<<7)+r[1]-16;r.subarray(2).forEach((c,d)=>{let u=d+s,f=(u>>2)+24,$=u&3,w=i*m.dpn;if(O()&&console.debug(`MT-32 dev drum note ${f} param ${$}: ${c}`),f<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${f}`);return}[()=>{},()=>{t(e,ee)[(w+le[26])*m.dnc+f]=Math.round(c*1.27)},()=>{t(e,ee)[(w+le[26])*m.dnc+f]=c*9+1&127},()=>{t(e,ee)[(w+le[26])*m.dnc+f]=c?127:0}][$]()})}else{let s=r[1];r.subarray(2).forEach((c,d)=>{let u=d+s;t(e,Ae)[u]=c;let f=e.chRedir(1+(u>>4),o,!0),$=u&15;([!1,()=>{let w=t(e,Ae)[f-1<<4];if(w<3)if(t(e,Ee)[f]=1,w==2)for(let C=0;C<name.length;C++)t(e,me)[(f-1)*m.cmt+C]=t(e,Ie)[c*m.cmt+C];else{let C=e.baseBank.get(0,c+(w<<6),127,"mt32").name;for(let M=0;M<C.length;M++)t(e,me)[(f-1)*m.cmt+M]=C.charCodeAt(M)}e.dispatchEvent("voice",{part:f})},()=>{t(e,R)[f*m.rpn+3]=c+40,t(e,L)[m.rpnt*f+2]=1},()=>{t(e,R)[f*m.rpn+1]=c+14,t(e,L)[m.rpnt*f+1]=1},()=>{t(e,R)[f*m.rpn]=c,t(e,L)[m.rpnt*f]=1},!1,()=>{t(e,b)[m.cc*f+E[91]]=c?127:0},!1,()=>{t(e,b)[m.cc*f+E[7]]=c},()=>{t(e,b)[m.cc*f+E[10]]=Math.ceil(c*9.05)}][$]||(()=>{}))()})}}).add([22,18,4],(r,o,l)=>{e.switchMode("mt32");let i=r[1]+(r[0]<<7),s=[];r.subarray(2).forEach((c,d)=>{let u=d+i,f=e.chRedir(Math.floor(u/246+1),o,!0),$=u%246;$<14&&(t(e,me)[(f-1)*m.cmt+$]=c),$<10&&(t(e,Ee)[f]=1),s.indexOf(f)<0&&s.push(f)}),s.forEach(c=>{e.dispatchEvent("voice",{part:c})})}).add([22,18,5],(r,o,l)=>{e.switchMode("mt32");let i=(r[0]<<7)+r[1];r.subarray(2).forEach((s,c)=>{let d=i+c,u=Math.floor(d/8),f=d&7,$=u*8;t(e,lt)[d]=s,([!1,()=>{let w=t(e,lt)[$];if(w<3){let C="";if(w==2){let _=m.cmt*u;C=`MT-m:${s.toString().padStart(3,"0")}`}else C=e.baseBank.get(0,s+(w<<6),127,"mt32").name;e.userBank.clearRange({msb:0,lsb:127,prg:u});let M=`MSB	LSB	PRG	NME
000	127	${u}	${C}`;e.userBank.load(M,!0)}}][f]||(()=>{}))()}),e.forceVoiceRefresh()}).add([22,18,8],(r,o,l)=>{e.switchMode("mt32");let i=((r[0]&1)<<7)+r[1],s=r[0]>>1,c=!1;if(r.subarray(2).forEach((d,u)=>{let f=i+u;f<m.cmt&&(t(e,Ie)[s*m.cmt+f]=d,c=!0)}),c){e.userBank.clearRange({msb:0,lsb:127,prg:s});let d=`MSB	LSB	PRG	NME
000	127	${s}	MT-m:${s}`;e.userBank.load(d,!0)}e.forceVoiceRefresh()}).add([22,18,16],(r,o,l)=>{e.switchMode("mt32");let i=r[1],s=!1,c=function(d,u){t(e,F)[u-12]=d,s=!0};r.subarray(2).forEach((d,u)=>{let f=u+i;([!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,c,c,c,c,c,c,c,c,c,()=>{x(e,H,d),e.dispatchEvent("mastervolume",t(e,H))}][f]||(()=>{}))(d,u)}),s&&e.buildRchTree()}).add([22,18,32],(r,o,l)=>{e.switchMode("mt32");let i=r[1],s=" ".repeat(i);r.subarray(2).forEach(c=>{c>31?s+=String.fromCharCode(c):s+=" "}),x(e,Le,s.padStart(20," ")),x(e,Ue,Date.now()+3200)}).add([22,18,82],(r,o)=>{let l=e.chRedir(0,o,!0);for(let i=0;i<16;i++)t(e,V).ano(l+i),i&&i<10&&(t(e,I)[l+i]=Ht[i-1]);console.info("MT-32 alt reset complete.")}),t(this,ke).add([66,0],(r,o)=>{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(o),2,S.ns5r),x(e,G,!1),console.debug(`NS5R mode switch requested: ${["global","multi","prog edit","comb edit","drum edit","effect edit"][r[0]]} mode.`)}).add([66,1],(r,o)=>{let l=["ns5r","05rw"][r[0]];e.switchMode(l,!0),e.setPortMode(e.getTrackPort(o),2,S[l]),x(e,G,!1)}).add([66,18,0,0],(r,o)=>{let l=r[0];switch(l){case 124:case 126:case 127:{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(o),2,S.ns5r),x(e,G,!1);break}case 125:{e.initDrums(),console.info(`NS5R drum setup reset: ${r}`);break}default:if(l<10){let i=[0,0,0,0],s=(c,d)=>{i[d]=c};if(r.subarray(1).forEach((c,d)=>{[s,s,s,s,()=>{x(e,H,c*129/16383*100),e.dispatchEvent("mastervolume",t(e,H))},()=>c-64,()=>c-64,()=>{},()=>{},()=>{}][l+d]()}),r[0]<4){let c=0;i.forEach(d=>{c=c<<4,c+=d}),c-=1024}}}}).add([66,18,0,1],(r,o)=>{}).add([66,18,0,2],(r,o)=>{}).add([66,18,1],(r,o)=>{e.dispatchEvent("mupromptex");let l=e.chRedir(r[0],o,!0),i=l*m.cc,s=r[1],c=`NS5R CH${l+1} `;r.subarray(2).forEach((d,u)=>{let f=s+u;f<3?([()=>{t(e,b)[i+E[0]]=d||nt.bank0},()=>{t(e,b)[i+E[32]]=d},()=>{t(e,I)[l]=d}][f](),e.dispatchEvent("voice",{part:l})):f<8||(f<14?[()=>{let $=e.chRedir(d,o,!0);t(e,F)[l]=$,l!=$&&(e.buildRchTree(),console.info(`${c}receives from CH${$+1}`))},()=>{t(e,ae)[l]=+!d},()=>{e.setChType(l,d,S.ns5r),console.debug(`${c}type: ${mt[d]}`)},()=>{t(e,R)[m.rpn*l+3]=d,t(e,L)[m.rpnt*l+2]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)})},()=>{},()=>{}][f-8]():f<16||(f<33?[()=>{t(e,b)[i+E[7]]=d},()=>{t(e,b)[i+E[11]]=d},()=>{},()=>{},()=>{t(e,b)[i+E[10]]=d||128},()=>{},()=>{},()=>{t(e,b)[i+E[93]]=d},()=>{t(e,b)[i+E[91]]=d},()=>{t(e,b)[i+E[76]]=d},()=>{t(e,b)[i+E[77]]=d},()=>{t(e,b)[i+E[78]]=d},()=>{t(e,b)[i+E[74]]=d},()=>{t(e,b)[i+E[71]]=d},()=>{t(e,b)[i+E[73]]=d},()=>{t(e,b)[i+E[75]]=d},()=>{t(e,b)[i+E[72]]=d}][f-16]():f<112||f<114&&[()=>{t(e,b)[i+E[5]]=d},()=>{t(e,b)[i+E[65]]=d}][f-112]()))})}).add([66,18,8,0],(r,o)=>{let l=r[0];if(l<32)e.setLetterDisplay(r.subarray(1,33),"NS5R letter display");else{let i=l-32;x(e,ge,Date.now()+3200),x(e,Y,10),t(e,oe,xe).fill(0);let s=r.subarray(1),c=4;s.forEach(function(d,u){let f=u+i,$=f>>4,w=f&15;if(f<80){let C=$<c?d:d>>3,M=0,_=$<c?6:3;for(;C>0;)t(e,oe,xe)[w*32+$*7+(_-M)]=C&1,C=C>>1,M++}})}}).add([66,18,48],(r,o,l)=>{p(0,r)}).add([66,18,49],(r,o,l)=>{p(1,r)}).add([66,18,50],(r,o,l)=>{p(2,r)}).add([66,18,51],(r,o,l)=>{p(3,r)}).add([66,18,52],(r,o,l)=>{p(4,r)}).add([66,18,53],(r,o,l)=>{p(5,r)}).add([66,18,54],(r,o,l)=>{p(6,r)}).add([66,18,55],(r,o,l)=>{p(7,r)}).add([66,52],(r,o)=>{e.switchMode("ns5r"),x(e,G,!1);let l="";pe(r,(i,s)=>{s<8?(i>31&&(l+=String.fromCharCode(i)),s==7&&(e.aiEfxName=l)):s<10&&(e.setEffectType(s-8,44,i),e.dispatchEvent(`efx${["reverb","chorus"][s-8]}`,e.getEffectType(s-8)))})}).add([66,53],(r,o)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r"),x(e,G,!1);let l="",i=r[r.length-1],s=r.subarray(0,r.length-1),c=De(s);c!=i&&(console.info(`NS5R current multi dump checksum mismatch! Expected ${c}, got ${i}.`),console.debug(r));let d=e.getTrackPort(o);if(t(e,X)[d]&&t(e,X)[d]!=S.ns5r)if(t(e,we).dumpLimit==e.DUMP_MODE){console.warn(`Dump cancelled for track ${o}. Port ${String.fromCharCode(65+d)} mode "${W[t(e,X)[d]]}" mismatch, should be "ns5r".`);return}else console.info(`Track ${o} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+d)}.`);e.setPortMode(d,2,S.ns5r),pe(s,function(u,f){switch(!0){case f<2944:{let $=e.chRedir(Math.floor(f/92),o,!0),w=$*m.cc;switch(f%92){case 0:{t(e,b)[w+E[0]]=u,e.dispatchEvent("voice",{part:$});break}case 1:{t(e,b)[w+E[32]]=u,!u&&!t(e,b)[w+E[0]]&&(t(e,b)[w+E[0]]=nt.bank0),e.dispatchEvent("voice",{part:$});break}case 2:{t(e,I)[$]=u,u>0&&e.setChActive($,1),e.dispatchEvent("voice",{part:$});break}case 3:{let C=e.chRedir(u,o,!0);t(e,F)[$]=C,$!=C&&(console.info(`NS5R CH${$+1} receives from CH${C+1}.`),e.buildRchTree());break}case 7:{t(e,D)[$]=u,e.dispatchEvent("voice",{part:$});break}case 8:{t(e,R)[$*m.rpn+3]=u<40||u>88?u+(u>63?-192:64):u,t(e,L)[m.rpnt*$+2]=1,e.dispatchEvent("pitch",{part:$,pitch:e.getPitchShift($)});break}case 9:case 10:{t(e,b)[w+E[7]]=u;break}case 11:{t(e,b)[w+E[11]]=u;break}case 14:{t(e,b)[w+E[10]]=u||128;break}case 19:{t(e,b)[w+E[93]]=u;break}case 20:{t(e,b)[w+E[91]]=u;break}case 84:{t(e,b)[w+E[65]]=u;break}case 85:{t(e,b)[w+E[5]]=u;break}}break}case f<3096:break;case f<3134:{let $=f-3096;$<8?(u>31&&(l+=String.fromCharCode(u)),$==7&&(e.aiEfxName=l)):$<10&&(e.setEffectType($-8,44,u),e.dispatchEvent(`efx${["reverb","chorus"][$-8]}`,e.getEffectType($-8)));break}case f<8566:break}})}).add([66,54],(r,o)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r");let l="",i=80,s=0,c=0,d="MSB	PRG	LSB	NME";pe(r,function(u,f){let $=f%158;switch(!0){case $<10:{u>31&&(l+=String.fromCharCode(u));break}case $==10:break;case $==11:{i=u&127;break}case $==12:{c=u&127;break}case $==13:{d+=`
${i}	${s}	${c}	${l.trim().replace("Init Voice","")}`,s++,l="";break}}}),e.userBank.clearRange({msb:80,lsb:0}),e.userBank.load(d),O()&&console.debug(d),e.forceVoiceRefresh()}).add([66,55],(r,o)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r");let l="",i=88,s=0,c=0,d="MSB	PRG	LSB	NME";pe(r,function(u,f){let $=f%126;switch(!0){case $<10:{u>31&&(l+=String.fromCharCode(u));break}case $==11:break;case $==12:break;case $==13:{d+=`
${i}	${s}	${c}	${l.trim().replace("Init Combi","")}`,s++,l="";break}}}),e.userBank.clearRange({msb:88,lsb:0}),e.userBank.load(d),O()&&console.debug(d),e.forceVoiceRefresh()}).add([66,125],(r,o,l)=>{e.dispatchEvent("backlight",["green","orange","red",!1,"yellow","blue","purple"][r[0]]||"white")}).add([66,127],(r,o,l)=>{let i=r[r.length-1],s=r.subarray(0,r.length-1),c=De(s);c!=i&&(console.info(`NS5R screen dump checksum mismatch! Expected ${c}, got ${i}.`),console.debug(r));let d=new Uint8Array(5760);pe(r,(u,f,$)=>{if(f<720)for(let w=0;w<8;w++)d[f*8+w]=u>>7-w&1}),e.dispatchEvent("screen",{type:"ns5r",data:d})}).add([76],(r,o,l)=>{t(e,ke).run([66,...r],o,l)}),t(this,We).add([16,0,8,0],(r,o,l)=>{let i=(r[2]<<4)+r[3],s="K11 ";([()=>{e.switchMode("k11",!0),e.setPortMode(e.getTrackPort(o),2,S.k11),x(e,G,!1),t(e,q)[S.k11][1]=i?4:0,console.info("MIDI reset: GMega/K11")},()=>{e.setEffectType(0,24,i),console.debug(`${s}reverb type: ${i}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{console.debug(`${s}reverb time: ${i}`)},()=>{console.debug(`${s}reverb time: ${i}`)},()=>{console.debug(`${s}reverb predelay: ${i}`)},()=>{console.debug(`${s}reverb predelay: ${i}`)},()=>{console.debug(`${s}depth high: ${i}`)},()=>{console.debug(`${s}depth high: ${i}`)},()=>{console.debug(`${s}depth low: ${i}`)},()=>{console.debug(`${s}depth low: ${i}`)}][r[0]]||(()=>{}))()}).add([16,0,8,1],(r,o,l)=>{e.dispatchEvent("mupromptex");let i=e.chRedir(r[1],o,!0),s=m.cc*i,c=m.rpn*i,d=(r[3]<<4)+r[4],u=`K11 CH${i+1} `;([()=>{d<128?(e.setChType(i,e.CH_MELODIC,S.k11),t(e,b)[s+E[0]]=0,t(e,I)[i]=d):(e.setChType(i,e.CH_DRUMS,S.k11),t(e,I)[i]=d-128),e.dispatchEvent("voice",{part:i})},()=>{let f=e.chRedir(d,o,!0);t(e,F)[i]=f,i!=f&&(e.buildRchTree(),console.info(`${u}receives from CH${f+1}`))},()=>{t(e,b)[s+E[7]]=d},()=>{uupThis.setChActive(i,d)},()=>{t(e,b)[s+E[10]]=d},()=>{t(e,R)[c+3]=d+40,t(e,L)[m.rpnt*i+2]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{t(e,R)[c+1]=d>>1,t(e,R)[c+2]=d&1,t(e,L)[m.rpnt*i+1]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{t(e,b)[s+E[91]]=d?127:0},()=>{},()=>{t(e,b)[s+E[74]]=d},()=>{t(e,b)[s+E[73]]=d},()=>{t(e,b)[s+E[72]]=d}][r[0]]||(()=>{}))()}).add([16,0,9,0],(r,o,l)=>{e.dispatchEvent("mupromptex");let i=(r[2]<<4)+r[3],s="GMLX ";([()=>{console.debug(`${s}reverb type: ${i}`)},()=>{console.debug(`${s}reverb time: ${i}`)},()=>{console.debug(`${s}reverb predelay: ${i}`)},()=>{console.debug(`${s}depth high: ${i}`)},()=>{console.debug(`${s}depth low: ${i}`)}][r[0]]||(()=>{}))()}).add([16,0,9,3],(r,o,l)=>{e.dispatchEvent("mupromptex");let i=(r[2]<<4)+r[3],s=e.chRedir(r[1],o,!0),c=s*m.cc;[()=>{i<128?(e.setChType(s,e.CH_MELODIC,S.k11),t(e,b)[c+E[0]]=0,t(e,b)[c+E[32]]=0,t(e,I)[s]=i):i<160?(e.setChType(s,e.CH_MELODIC,S.k11),t(e,b)[c+E[0]]=0,t(e,b)[c+E[32]]=7,t(e,I)[s]=i-100):(e.setChType(s,e.CH_DRUMS,S.k11),t(e,b)[c+E[0]]=122,t(e,b)[c+E[32]]=0,t(e,I)[s]=i-160),e.dispatchEvent("voice",{part:s})},()=>{let d=e.chRedir(i,o,!0);t(e,F)[s]=d,s!=d&&(e.buildRchTree(),console.info(`GMLX CH${s+1} receives from CH${d+1}`))}][r[0]]()}).add([16,0,9,4],(r,o,l)=>{e.dispatchEvent("mupromptex");let i=(r[2]<<4)+r[3],s=e.chRedir(r[1],o,!0),c=s*m.cc,d=s*m.rpn,u=`GMLX CH${s+1} `;[()=>{e.setChActive(s,i)},()=>{t(e,b)[c+E[7]]=i},()=>{t(e,b)[c+E[10]]=i},()=>{t(e,b)[c+E[91]]=i?127:0},()=>{t(e,R)[d+3]=i+40,t(e,L)[m.rpnt*s+2]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},()=>{t(e,R)[d+1]=i,t(e,L)[m.rpnt*s+1]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},()=>{t(e,R)[d]=i,t(e,L)[m.rpnt*s]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},()=>{}][r[0]]()}),t(this,Qe).add([66,93,64],(r,o,l)=>{let i=r[2];switch(r[0]){case 0:{switch(r[1]){case 4:{e.dispatchEvent("mupromptex"),x(e,H,i*129/16383*100),e.dispatchEvent("mastervolume",t(e,H));break}case 5:{e.dispatchEvent("mupromptex"),i-64;break}case 6:{e.dispatchEvent("mupromptex"),console.debug(`SG global reverb: ${i?"on":"off"}`);break}case 127:{e.switchMode("sg",!0),e.setPortMode(e.getTrackPort(o),1,S.sg);break}}break}case 1:{switch(r[1]){case 48:{e.dispatchEvent("mupromptex"),console.debug(`SG reverb type: ${Bt[i]}`);break}}break}default:if(r[0]>>4==1){e.dispatchEvent("mupromptex");let s=e.chRedir(r[0]&15,o,!0);if(r[1]==2){let c=e.chRedir(i,o,!0);t(e,F)[s]=c,s!=c&&(e.buildRchTree(),console.info(`SG CH${s+1} receives from CH${c+1}`))}else r[1]==19&&(t(e,b)[m.cc*s+E[7]]=i)}else console.warn(`Unknown AKAI SG SysEx: ${r}`)}}),t(this,Ye).add([9],(r,o,l)=>{e.dispatchEvent("mupromptex"),console.debug(`GZ set effect: ${["stage reverb","hall reverb","room reverb","chorus","tremolo","phaser","rotary speaker","enhancer","flanger","EQ"][r[0]]||"off"}`)}),t(this,ce).add([127,0],(r,o,l)=>{e.switchMode("motif");let i=new Uint8Array([127,1,...r]);t(e,ce).run(i,o,l)}).add([127,1,0,0],(r,o,l)=>{e.switchMode("s90es");let i="S90/Motif ES system ",s=r[0];r.subarray(1).forEach((c,d)=>{([()=>{x(e,H,c*12900/16383),e.dispatchEvent("mastervolume",t(e,H))}][s+d]||(()=>{console.info(`Unrecognized ${i}ID: ${s+d}`)}))()})}).add([127,1,0,36,54,1],(r,o,l)=>{e.switchMode("s90es");let i="S90/Motif ES reverb ",s=r[0];r.subarray(1).forEach((c,d)=>{([()=>{e.setEffectTypeRaw(0,!1,c&15|112)},()=>{e.setEffectTypeRaw(0,!0,c)}][s+d]||(()=>{}))()}),e.dispatchEvent("efxreverb",e.getEffectType(0))}).add([127,1,0,37,54,2],(r,o,l)=>{e.switchMode("s90es");let i="S90/Motif ES chorus ",s=r[0];r.subarray(1).forEach((c,d)=>{([()=>{e.setEffectTypeRaw(1,!1,c&15|112)},()=>{e.setEffectTypeRaw(1,!0,c)}][s+d]||(()=>{}))()}),e.dispatchEvent("efxchorus",e.getEffectType(1))}).add([127,1,0,34,54,3],(r,o,l)=>{e.switchMode("s90es");let i="S90/Motif ES insert 1 ",s=r[0];r.subarray(1).forEach((c,d)=>{([()=>{e.setEffectTypeRaw(3,!1,c&15|112)},()=>{e.setEffectTypeRaw(3,!0,c)}][s+d]||(()=>{}))()}),e.dispatchEvent("efxinsert0",e.getEffectType(3))}).add([127,1,0,34,54,4],(r,o,l)=>{e.switchMode("s90es");let i="S90/Motif ES insert 2 ",s=r[0];r.subarray(1).forEach((c,d)=>{([()=>{e.setEffectTypeRaw(4,!1,c&15|112)},()=>{e.setEffectTypeRaw(4,!0,c)}][s+d]||(()=>{}))()}),e.dispatchEvent("efxinsert1",e.getEffectType(4))}).add([127,1,0,35,54,17],(r,o,l)=>{e.switchMode("s90es");let i="S90/Motif ES variation ",s=r[0];r.subarray(1).forEach((c,d)=>{([()=>{e.setEffectTypeRaw(2,!1,c&15|112)},()=>{e.setEffectTypeRaw(2,!0,c)}][s+d]||(()=>{}))()}),e.dispatchEvent("efxdelay",e.getEffectType(2))}).add([127,1,0,58,55],(r,o,l)=>{e.dispatchEvent("mupromptex"),e.switchMode("s90es");let i=e.getTrackPort(o);if(t(e,X)[i]&&t(e,X)[i]!=t(e,B).smotif)if(t(e,we).dumpLimit==e.DUMP_MODE){console.warn(`Dump cancelled for track ${o}. Port ${String.fromCharCode(65+i)} mode "${W[t(e,X)[i]]}" mismatch, should be "${W[t(e,B).smotif]}".`);return}else console.info(`Track ${o} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+i)}.`);let s=e.chRedir(r[0],o,!0),c=m.cc*s,d=r[1];r[0]>15&&(s=r[0]+32);let u=`Track ${o} S90/Motif ES bulk CH${s<128?s+1:"U"+(s-127)} `;console.debug(u,r),!(r[0]>15)&&r.subarray(2).forEach((f,$)=>{([()=>{t(e,b)[c+E[0]]=f,e.dispatchEvent("voice",{part:s})},()=>{f&&e.setChActive(s,1),t(e,b)[c+E[32]]=f,e.setChType(s,[32,40].indexOf(f)>-1?e.CH_DRUMS:e.CH_MELODIC,t(e,A),!0),e.dispatchEvent("voice",{part:s})},()=>{f&&e.setChActive(s,1),t(e,I)[s]=f,e.dispatchEvent("voice",{part:s})},()=>{let w=e.chRedir(f,o,!0);t(e,F)[s]=w,s!=w&&(e.buildRchTree(),console.info(`${u}receives from CH${w+1}`))},()=>{t(e,ae)[s]=f?0:1},!1,!1,!1,!1,!1,!1,!1,!1,()=>{f!=100&&e.setChActive(s,1),t(e,b)[c+E[7]]=f},()=>{f!=64&&e.setChActive(s,1),t(e,b)[c+E[10]]=f},!1,!1,!1,()=>{t(e,b)[c+E[91]]=f},()=>{f&&e.setChActive(s,1),t(e,b)[c+E[93]]=f},()=>{f&&e.setChActive(s,1),t(e,b)[c+E[94]]=f},()=>{f!=127&&e.setChActive(s,1),t(e,b)[c+E[128]]=f,e.allocateAce(128)},()=>{},()=>{f!=64&&e.setChActive(s,1),t(e,b)[c+E[74]]=f},()=>{f!=64&&e.setChActive(s,1),t(e,b)[c+E[71]]=f},!1,()=>{t(e,b)[c+E[65]]=f},()=>{t(e,b)[c+E[5]]=f},()=>{}][d+$]||(()=>{}))()})}).add([127,1,54,16],(r,o,l)=>{e.switchMode("s90es");let i=r[0];r.subarray(1).forEach((s,c)=>{let u=`S90/Motif ES EQ${(c>>2)+1} `;([()=>{let f=s-64},()=>{let f=st[s]},()=>{let f=s/10},()=>{let f=s}][i+c&3]||(()=>{}))()})}),t(this,he).add([0,72,18,0,0,0,0],(r,o,l)=>{e.switchMode("sd",!0),e.setPortMode(e.getTrackPort(o),2,S.sd),console.info("MIDI reset: SD")}).add([0,72,18,16,0],(r,o,l)=>{e.dispatchEvent("mupromptex");let i=r[0]>>5,s=r[0]&31;switch(i){case 0:{let c=r[0]>>1,d=r[1];switch(c){case 1:{r.subarray(2).forEach((u,f,$)=>{let w=f+d;switch(w){case 0:{u&&(e.setEffectType(1,60,u-1),e.dispatchEvent("efxchorus",e.getEffectType(1)),console.debug(`SD MFX Cho: ${w} - ${u}`));break}}});break}case 2:{r.subarray(2).forEach((u,f)=>{let $=f+d;switch($){case 0:{u&&(e.setEffectType(0,55+u,0),e.dispatchEvent("efxreverb",e.getEffectType(0)),console.debug(`SD MFX Rev: ${$} - ${u}`));break}}});break}case 3:case 4:case 5:{let u=c-1;r.subarray(2).forEach((f,$)=>{let w=$+d;switch(console.debug(`SD MFX ${u-2}: ${w} - ${f}`),w){case 0:{e.setEffectTypeRaw(u,62,f),e.dispatchEvent(`efx${u>2?"delay":"insert"+(u-4)}`,e.getEffectType(u));break}}}),console.debug(`SD MFX message:
%o`,r);break}default:console.debug(`Unknown SD-90 global effects message:
%o`,r)}break}case 1:{let c=e.chRedir(s,o,!0),d=r[1],u=c*m.cc;r.subarray(2).forEach((f,$)=>{let w=d+$;w<37?([()=>{},()=>{},0,()=>{},()=>{switch(t(e,b)[u+E[0]]=f,f){case 104:case 105:case 106:case 107:case 120:{t(e,D)[c]||e.setChType(c,e.CH_DRUMS);break}default:t(e,D)[c]&&e.setChType(c,e.CH_MELODIC)}e.dispatchEvent("voice",{part:c})},()=>{t(e,b)[u+E[32]]=f,e.dispatchEvent("voice",{part:c})},()=>{t(e,I)[c]=f,e.dispatchEvent("voice",{part:c})},()=>{t(e,b)[u+E[7]]=f},()=>{t(e,b)[u+E[10]]=f},()=>{},()=>{},()=>{f<2&&(t(e,ae)[c]=f)},()=>{f<2&&(t(e,b)[u+E[68]]=f?127:0)},()=>{},()=>{f<2&&(t(e,b)[u+E[65]]=f?127:0)},()=>{t(e,b)[u+E[5]]=f&15<<4|t(e,b)[u+E[5]]&15},()=>{t(e,b)[u+E[5]]=f&15|(t(e,b)[u+E[5]]&240)>>4},()=>{t(e,b)[u+E[74]]=f},()=>{t(e,b)[u+E[71]]=f},()=>{t(e,b)[u+E[73]]=f},()=>{t(e,b)[u+E[72]]=f},0,0,0,0,0,0,0,()=>{t(e,b)[u+E[128]]=f,e.allocateAce(128)},()=>{t(e,b)[u+E[93]]=f},()=>{t(e,b)[u+E[91]]=f},0,0,()=>{t(e,b)[u+E[75]]=f},()=>{t(e,b)[u+E[76]]=f},()=>{t(e,b)[u+E[77]]=f},()=>{t(e,b)[u+E[78]]=f}][w]||(()=>{}))():w<63||(w<64?(t(e,D)[c]?t(e,b)[u+E[0]]=104|f:t(e,b)[u+E[0]]=96|f,e.dispatchEvent("voice",{part:c})):console.debug(`Unknown SD-90 global CH${c+1} param setup message:
%o`,r))});break}case 2:{let c=e.chRedir(s,o,!0),d=r[1];console.debug(`Unknown SD-90 global CH${c+1} MIDI setup message:
%o`,r.subarray(2));break}default:console.warn(`Unknown SD-90 global part setup message:
%o`,r)}}),t(e,ke).add([0,1,73,78],(r,o,l)=>{e.switchMode("krs"),e.setPortMode(e.getTrackPort(o),1,S.krs),console.debug("Might be KORG KROSS 2 mode reset... Not sure.")}).add([0,1,73,117,2,37],(r,o,l)=>{e.switchMode("krs");let i=e.getTrackPort(o);if(t(e,X)[i]&&t(e,X)[i]!=S.krs)if(t(e,we).dumpLimit==e.DUMP_MODE){console.warn(`Dump cancelled. Port ${String.fromCharCode(65+i)} mode "${W[t(e,X)[i]]}" mismatch, should be "krs".`);return}else console.info(`Track ${o} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+i)}.`);e.setPortMode(e.getTrackPort(o),1,S.krs);let s="KROSS 2 BMT1 ",c="";pe(r,(d,u)=>{if(u<24)c+=String.fromCharCode(Math.max(32,d));else if(!(u<1276)){let f=u-1276,$=e.chRedir(Math.floor(f/44),o,!0),w=f%44,C=m.cc*$;w<15?([()=>{d&&e.setChActive($,1),t(e,I)[$]=d,e.dispatchEvent("voice",{part:$})},()=>{d&&e.setChActive($,1),d<10?(t(e,b)[C+E[0]]=63,t(e,b)[C+E[32]]=d):d<20?(t(e,b)[C+E[0]]=121,t(e,b)[C+E[32]]=d-10):d<24&&(t(e,b)[C+E[0]]=[120,0,56,62][d-20],t(e,b)[C+E[32]]=0),e.dispatchEvent("voice",{part:$})},()=>{let M=e.chRedir(d&15,o,!0);t(e,F)[$]=M,console.info(`${s}CH${$+1} receives from CH${M+1}`),d>>5&1||(e.setChActive($,0),console.debug(`KORG KROSS 2 CH${$+1} is disabled.`))},!1,!1,()=>{t(e,b)[C+E[7]]=d},!1,()=>{},()=>{},!1,!1,!1,!1,!1,()=>{t(e,b)[C+E[10]]=d||128}][w]||(()=>{}))():w<36||([()=>{t(e,b)[C+E[74]]=(d+128&255)-64},()=>{t(e,b)[C+E[71]]=(d+128&255)-64},!1,!1,()=>{t(e,b)[C+E[73]]=(d+128&255)-64},()=>{t(e,b)[C+E[75]]=(d+128&255)-64},!1,()=>{t(e,b)[C+E[72]]=(d+128&255)-64}][w]||(()=>{}))()}}),c=c.trimRight(),e.dispatchEvent("metacommit",{type:"EORTitle",data:c})})}chRedir(e,a,h){let n=this;if(t(n,Be)[a])return(t(n,Be)[a]-1)*16+e;if(t(n,A)==S.sc){if(h==1)return e;let p=0,y=!0;for(;y;)t(n,Ce)[e+p]==0?(t(n,Ce)[e+p]=a,console.debug(`Assign track ${a} to channel ${e+p+1}.`),y=!1):t(this,Ce)[e+p]==a?y=!1:(p+=16,p>=128&&(p=0,y=!1));return e+p}else return e}getTrackPort(e){return this.chRedir(0,e,!0)>>4}forceVoiceRefresh(){for(let e=0;e<m.ch;e++)t(this,de)[e]&&this.dispatchEvent("voice",{part:e})}buildRchTree(){let e=[];t(this,F).forEach((a,h)=>{var n;a<m.ch&&((n=e[a])!=null&&n.constructor||(e[a]=[]),e[a].push(h))}),x(this,xt,e)}buildRccMap(){let e=this;for(let a=0;a<m.ch;a++)t(e,Fe)[a]={};t(e,Xe).forEach((a,h)=>{a&&(t(e,Fe)[Math.floor(h/m.redir)][a]=h%m.redir|128)}),O()&&console.debug(t(e,Fe))}getActive(){return t(this,de)}getCc(e){let a=this,h=e*m.cc,n=t(a,b).subarray(h,h+m.cc);return n[E[0]]=n[E[0]]||t(a,q)[a.getChModeId(e)][0],n[E[32]]=n[E[32]]||t(a,q)[a.getChModeId(e)][1],n[E[0]]==nt.bank0&&(n[E[0]]=0),n}getCcCh(e,a){let h=this;if(vt.indexOf(a)<0)throw new Error("CC number not accepted");let n=t(h,b)[m.cc*e+E[a]];switch(a){case 0:{n=n||t(h,q)[h.getChModeId(e)][0],n==nt.bank0&&(n=0);break}case 32:{n=n||t(h,q)[h.getChModeId(e)][1];break}}return n}getCcAll(){let e=this,a=t(e,b).slice();for(let h=0;h<m.ch;h++){let n=h*m.cc;a[n+E[0]]=a[n+E[0]]||t(e,q)[e.getChModeId(h)][0],a[n+E[32]]=a[n+E[32]]||t(e,q)[e.getChModeId(h)][1],a[E[0]]==nt.bank0&&(a[E[0]]=0)}return a}getChSource(){return t(this,F)}getChType(){return t(this,D)}setChType(e,a,h=t(this,A),n=!1){a&=15,t(this,D)[e]=a,a>0&&!n&&(t(this,b)[e*m.cc+E[0]]=_t[h])}setChActive(e,a=0){t(this,de)[e]!=a&&this.dispatchEvent("channeltoggle",{part:e,active:a}),t(this,de)[e]=a}getExt(e){let a=m.ext*e,h=t(this,ie).subarray(a,a+m.ext),n=new Uint8Array(h.length);return n.set(h),n[1]=n[1]||t(this,Pt),n}getPitch(){return t(this,Te)}getProgram(){return t(this,I)}getTexts(){return t(this,ne).slice()}getVel(e){let a=new Map,h=this;return t(h,z).forEach(function(n,p){let y=Math.floor(n/128),v=n%128;e==y&&t(h,K)[n]>0&&a.set(v,{v:t(h,K)[n],s:t(h,Q)[p]})}),a}getBitmap(){return{bitmap:t(this,oe,xe),expire:t(this,ge)}}getLetter(){return{text:t(this,Le),set:t(this,kt),expire:t(this,Ue)}}getMode(){return W[t(this,A)]}getMaster(){return{volume:t(this,H)}}getRawStrength(){let e=this;return t(this,z).forEach(function(a){let h=Math.floor(a/128);t(e,K)[a]>t(e,$e)[h]&&(t(e,$e)[h]=t(e,K)[a])}),t(this,$e)}getStrength(){let e=[],a=this;return this.getRawStrength().forEach(function(h,n){e[n]=Math.floor(h*t(a,b)[n*m.cc+E[7]]*t(a,b)[n*m.cc+E[11]]*t(a,H)/803288)}),e}getRpn(){return t(this,R)}getNrpn(){return t(this,ct)}getVoice(e,a,h,n){let p=this,y=e||t(p,q)[t(p,A)][0],v=a,k=h||t(p,q)[t(p,A)][1];y==nt.bank0&&(y=0),W[t(p,A)]=="ns5r"&&y>0&&y<56&&(k=3);let r=p.userBank.get(y,v,k,n);if(W[t(p,A)]=="mt32"&&r.name.indexOf("MT-m:")==0){let o=parseInt(r.name.slice(5)),l=o*m.cmt,i="";t(p,Ie).subarray(l,l+10).forEach(c=>{c>31&&(i+=String.fromCharCode(c))});let s=`MSB	LSB	PRG	NME
0	127	${v}	${i}`;p.userBank.load(s,!0),r.name=i,r.ending=" "}return(r.ending!=" "||!r.name.length)&&(r=p.baseBank.get(y,v,k,n)),r}getChVoice(e){let a=this,h=a.getVoice(a.getCcCh(e,0),t(a,I)[e],a.getCcCh(e,32),a.getChMode(e));if(t(a,Ee)[e]){let n="";switch(t(a,A)){case S.mt32:{t(a,me).subarray(m.cmt*(e-1),m.cmt*(e-1)+10).forEach(p=>{n+=String.fromCharCode(Math.max(p,32))}),n=n.trimRight();break}default:{let p=m.cvn*e;t(a,$t).subarray(p,p+m.cvn).forEach(y=>{n+=String.fromCharCode(Math.max(y,32))}),n=n.trimRight()}}n.length&&(h.ending="~",h.name=n)}return h}getRawPitch(){return t(this,Te)}getPitchShift(e){let a=this,h=e*m.rpn,n=t(a,R)[h];return t(a,L)[e*m.rpnt]||t(a,A)==S.mt32&&(n=12),t(a,Te)[e]/8192*n+(t(a,R)[h+3]-64)+((t(a,R)[h+1]<<7)+t(a,R)[h+2]-8192)/8192}getEffectType(e=0){let a=3*e+1;return t(this,se).subarray(a,a+2)}setEffectTypeRaw(e=0,a,h){let n=3*e;t(this,se)[n]=1,t(this,se)[n+1+ +a]=h}setEffectType(e=0,a,h){this.setEffectTypeRaw(e,!1,a),this.setEffectTypeRaw(e,!0,h)}getEffectSink(){return t(this,ot)}setLetterDisplay(e,a,h=0,n=3200){let p=this,y;x(p,Le," ".repeat(h)),e.forEach(v=>{x(p,Le,t(p,Le)+String.fromCharCode(v>31?v:32)),v<32&&(y=y||new Set,y.add(v))}),x(p,kt,Date.now()),x(p,Ue,Date.now()+n),y&&(y=Array.from(y),y.forEach((v,k,r)=>{r[k]=v.toString(16).padStart(2,"0")}),console.warn(`${a}${a?" ":""}invalid code point${y.length>1?"s":""}: 0x${y.join(", 0x")}`))}setDetectionTargets(e="?",a=0){let h=this,n=-1;switch(e.replaceAll(", ",",").split(",").forEach(p=>{p=p.toLowerCase();let y=W.indexOf(Vr[p]||p);O()&&console.debug(`Mapped mode "${p}" to ID "${y}".`),y>-1&&(n=y)}),O()&&console.debug(`Set detection target to ID "${n}".`),n>0&&(t(h,B).x5=82,t(h,B).ds=S.krs),n){case S["05rw"]:{t(h,B).x5=81;break}case S.s90es:t(h,B).ds=S.s90es,t(h,B).smotif=S.s90es;case S.motif:t(h,B).ds=S.motif,t(h,B).smotif=S.motif}}setGsTargets(e=!1,a=4){if(!a)a=e?3:4;else{if(a>4||a<0)throw new Error(`Invalid GS level ${a}`);if(e&&a>>1!=1)throw new Error(`Invalid SC level ${a}`)}let h=this;t(h,B)[e?"sc":"gs"]=a,t(h,q)[S[e?"sc":"gs"]][1]=a,h.forceVoiceRefresh()}getConfigs(){return t(this,wt)}setDumpLimit(e){if(e>2||e<0)throw new RangeError("Invalid dump limit.");t(this,we).dumpLimit=e}allocateAce(e){if(!e||e<128&&e>95){console.warn(`cc${e} cannot be allocated as an active custom effect.`);return}let a=!0,h=0;for(;a&&h<m.ace;)t(this,fe)[h]==e?a=!1:t(this,fe)[h]||(a=!1,t(this,fe)[h]=e,console.info(`Allocated cc${e} to ACE slot ${h}.`)),h++;h>=m.ace&&console.warn("ACE slots are full.")}releaseAce(e){let a=!0,h=0;for(;a&&h<m.ace;)t(this,fe)[h]==e&&(t(this,fe)[h]=0,a=!1),h++;a&&O()&&console.debug(`No ACE slot was allocated to cc${e}.`)}resetAce(){t(this,fe).fill(0),console.info("All ACE slots have been reset.")}getAce(){return t(this,fe)}getChAce(e,a){if(a<0||a>=m.ace)throw new RangeError("No such ACE slot");let h=t(this,fe)[a];if(h){if(vt.indexOf(h)>=0)return t(this,b)[e*m.cc+E[h]];throw new Error(`Invalid ACE source: ${h}`)}else return 0}initDrums(){let e=this;t(e,ee).fill(64);for(let a=0;a<m.drm;a++){let h=a*m.dpn;for(let n in Er){let p=Er[n],y=(h+le[n])*m.dnc;t(e,ee).subarray(y,y+m.dnc).fill(p)}}}init(e=0){let a=this;x(a,Ve,0),t(a,q)[S.xg][1]=0,a.dispatchEvent("banklevel",{mode:"xg",data:0}),t(a,de).fill(0),t(a,b).fill(0),t(a,fe).fill(0),t(a,I).fill(0),t(a,K).fill(0),t(a,z).fill(0),t(a,ae).fill(0),t(a,$e).fill(0),t(a,Te).fill(0),t(a,ct).fill(0),t(a,L).fill(0),t(a,ie).fill(0),t(a,X).fill(0),t(a,Oe).fill(0),t(a,Xe).fill(0),x(a,H,100),x(a,ne,[]),x(a,dt,500),x(a,ft,0),x(a,ge,0),x(a,Y,0),t(a,oe,xe).fill(0),x(a,G,!1),x(a,ht,0),x(a,ye,!0),a.initDrums(),t(a,F).forEach(function(h,n,p){p[n]=n}),e==0&&(a.dispatchEvent("mode","?"),x(a,A,0),t(a,Ce).fill(0),t(a,Be).fill(0),x(a,Ue,0),x(a,Le,"")),fr.forEach(h=>{t(a,b)[m.cc*h]=_t[0]}),t(a,D).fill(a.CH_MELODIC),t(a,D)[9]=a.CH_DRUM1,t(a,D)[25]=a.CH_DRUM3,t(a,D)[41]=a.CH_DRUMS,t(a,D)[57]=a.CH_DRUMS,t(a,D)[73]=a.CH_DRUM5,t(a,D)[89]=a.CH_DRUM7,t(a,D)[105]=a.CH_DRUMS,t(a,D)[121]=a.CH_DRUMS;for(let h=0;h<m.drm;h++)t(a,be)[h<<1]=0,t(a,be)[h<<1|1]=m.invalidCh;t(a,lt).fill(0),t(a,Ie).fill(0),t(a,Ae).fill(0),t(a,me).fill(0),t(a,Ee).fill(0),t(a,se).fill(0),t(a,ot).fill(0),a.aiEfxName="",a.userBank.clearRange({msb:0,lsb:127,prg:[0,127]});for(let h=0;h<m.ch;h++){let n=h*m.cc;t(a,b)[n+E[7]]=100,t(a,b)[n+E[11]]=127,t(a,b)[n+E[2]]=127,t(a,b)[n+E[10]]=64,t(a,b).subarray(n+E[71],n+E[71]+8).fill(64),t(a,b)[n+E[128]]=127,t(a,b).subarray(n+E[130],n+E[157]+1).fill(64),t(a,b)[n+E[91]]=40,t(a,b)[n+E[101]]=127,t(a,b)[n+E[100]]=127,t(a,b)[n+E[99]]=127,t(a,b)[n+E[98]]=127;let p=h*m.rpn;t(a,R)[p]=2,t(a,R)[p+1]=64,t(a,R)[p+2]=0,t(a,R)[p+3]=64,t(a,R)[p+4]=0,t(a,R)[p+5]=0;let y=h*m.ext;t(a,ie)[y+1]=a.VLBC_BRTHEXPR;let v=h*m.redir;t(a,Xe)[v+8]=13}a.buildRchTree(),a.buildRccMap(),a.dispatchEvent("mastervolume",t(a,H)),a.dispatchEvent("efxreverb",a.getEffectType(0)),a.dispatchEvent("efxchorus",a.getEffectType(1)),a.dispatchEvent("efxdelay",a.getEffectType(2)),a.dispatchEvent("efxinsert0",a.getEffectType(3)),a.dispatchEvent("efxinsert1",a.getEffectType(4)),a.dispatchEvent("efxinsert2",a.getEffectType(5)),a.dispatchEvent("efxinsert3",a.getEffectType(6)),a.dispatchEvent("reset"),a.switchMode("?")}setChMode(e,a){let h=this;if(e<0||e>=m.ch)throw new RangeError(`Invalid CH${e+1}`);if(port<0||a>=W.length)throw new RangeError(`Invalid mode ID ${a}`);t(h,Oe)[e]=a,h.dispatchEvent("voice",{part:e})}getChMode(e,a){return W[this.getChModeId(e,a)]}getChModeId(e,a){return a?t(this,Oe)[e]||t(this,X)[e>>4]:t(this,Oe)[e]||t(this,X)[e>>4]||t(this,A)}setPortMode(e,a,h){let n=this;if(e<0||e>=m.ch>>4)throw new RangeError(`Invalid port ${e+1}`);if(a<1)throw new RangeError("Range must be a positive integer");if(e+a>=m.ch>>4)throw new RangeError("Range must be in bound");if(e<0||h>=W.length)throw new RangeError(`Invalid mode ID ${h}`);for(let p=e;p<e+a;p++){t(n,X)[p]=h;for(let y=p<<4;y<p+1<<4;y++)n.dispatchEvent("voice",{part:y})}}copyChSetup(e,a,h){if(e==a){console.warn(`Failed attempt at overwriting CH${e+1} with its own data.`);return}let n=this;if(h&&t(n,de)[a]){console.warn(`Failed attempt at copying setup data from CH${e+1} to CH${a+1}.`);return}let p=m.cc*e,y=m.cc*a;t(n,I)[a]=t(n,I)[e],t(n,b).set(t(n,b).subarray(p,p+m.cc),y)}setDrumFirstWrite(e,a){let h=this,n=t(h,D)[e];if(n<2)return;let p=n-2;if(t(h,be)[p<<1])if(a)t(h,be)[p<<1]=0,O()&&console.debug(`First write part for drum set ${p+1} has been reset.`);else return;else a?console.warn(`First write part for drum set ${p+1} is already blank.`):(t(h,be)[p<<1]=1,t(h,be)[p<<1|1]=e,console.debug(`First write part for drum set ${p+1} is set to CH${e}.`))}getChDrumFirstWrite(e){let a=this,h=t(a,D)[e];if(h<2)return;let n=h-2;return t(a,be).subarray(n<<1,n+1<<1)}getDrumFirstWrite(e){if(e>=0&&e<m.drm)return t(this,be).subarray(e<<1,e+1<<1)}switchMode(e,a=!1,h=!1){var y;let n=this,p=S[e];if(p>-1){if(t(n,A)==0||a){let v=t(n,A);n.initOnReset&&a&&(this.init(1),v=S["?"]),x(n,A,p),x(n,Y,0);for(let r=0;r<m.ch;r++)t(n,D)[r]>0&&t(n,Oe)[r]==0&&(t(n,b)[r*m.cc]=_t[p]);switch(p){case S.mt32:{Ht.forEach((r,o)=>{let l=o+1;t(n,de)[l]||(t(n,I)[l]=r,t(n,b)[l*m.cc+E[91]]=127)});for(let r=1;r<10;r++)n.dispatchEvent("voice",{part:r});break}}let k;switch(p){case S["?"]:case S.g2:{k=[52,4,52,18,0,0,0,0];break}case S.xg:{k=[1,0,65,0,5,0,0,0];break}case S.gm:case S.gs:case S.sc:{k=[40,4,40,18,40,32,32,0];break}case S.sd:{k=[58,0,60,0,61,0,61,0];break}case S["05rw"]:case S.x5d:case S.ns5r:{k=[44,1,44,19,44,0,44,0];break}case S.k11:case S.sg:{k=[24,0,0,0,0,0,0,0];break}case S.mt32:{k=[40,4,0,0,0,0,0,0];break}case S.motif:case S.s90es:{k=[113,0,117,0,114,0,0,0];break}default:k=[0,0,0,0,0,0,0,0]}for(let r=0;r<m.efx;r++)!t(n,se)[3*r]&&((y=k[r<<1])!=null&&y.constructor)&&(t(n,se)[3*r+1]=k[2*r],t(n,se)[3*r+2]=k[2*r+1],n.dispatchEvent(`efx${["reverb","chorus","delay","insert0"][r]}`,n.getEffectType(r)));h&&n.setDetectionTargets(e),n.dispatchEvent("mode",e),n.forceVoiceRefresh(),fr.forEach(r=>{n.dispatchEvent("voice",{part:r})})}}else throw new Error(`Unknown mode ${e}`)}newStrength(){t(this,$e).fill(0)}runJson(e){var a;if(e.type>14)return e.type==15&&e.data.constructor!=Uint8Array&&(e.data=Uint8Array.from(e.data)),t(this,St)[e.type].call(this,e);{let h=this.chRedir(e.part,e.track),n=!1;(a=t(this,xt)[h])==null||a.forEach(p=>{e.channel=p,n=!0,t(this,St)[e.type].call(this,e)}),n||console.warn(`${hr[e.type]?hr[e.type]:e.type}${[11,12].includes(e.type)?(e.data[0]!=null?e.data[0]:e.data).toString():""} event sent to CH${h+1} without any recipient.`)}t(this,ne).length>100&&t(this,ne).splice(100,t(this,ne).length-99)}runRaw(e){}async loadBank(e,a){let h=this;switch(e=e.toLowerCase(),e){case"s7e":{h.userBank.clearRange({msb:63,lsb:[21,22]}),h.userBank.clearRange({msb:63,lsb:[24,27]});break}case"pcg":{h.userBank.clearRange({msb:63,lsb:[6,9]}),h.userBank.clearRange({msb:63,lsb:[13,16]});break}default:throw new Error(`Unknown bank format ${e}`)}switch(e){case"s7e":case"pcg":{bt.context=this,await h.userBank.load(await bt.read(e,a),!1);break}}h.forceVoiceRefresh()}},A=new WeakMap,Y=new WeakMap,ge=new WeakMap,Se=new WeakMap,oe=new WeakSet,xe=function(){return t(this,Se)[t(this,Y)]},$r=function(e){t(this,Se)[t(this,Y)]=e},de=new WeakMap,F=new WeakMap,D=new WeakMap,b=new WeakMap,fe=new WeakMap,I=new WeakMap,K=new WeakMap,ae=new WeakMap,z=new WeakMap,Q=new WeakMap,Te=new WeakMap,$e=new WeakMap,Ge=new WeakMap,ie=new WeakMap,R=new WeakMap,L=new WeakMap,ct=new WeakMap,ee=new WeakMap,be=new WeakMap,se=new WeakMap,ot=new WeakMap,Xe=new WeakMap,X=new WeakMap,Oe=new WeakMap,Ee=new WeakMap,$t=new WeakMap,Ae=new WeakMap,me=new WeakMap,lt=new WeakMap,Ie=new WeakMap,q=new WeakMap,B=new WeakMap,we=new WeakMap,wt=new WeakMap,H=new WeakMap,Ve=new WeakMap,dt=new WeakMap,ft=new WeakMap,Le=new WeakMap,Ue=new WeakMap,kt=new WeakMap,ht=new WeakMap,ye=new WeakMap,G=new WeakMap,Pt=new WeakMap,xt=new WeakMap,Fe=new WeakMap,Gt=new WeakMap,ne=new WeakMap,Ce=new WeakMap,Be=new WeakMap,j=new WeakMap,Ke=new WeakMap,V=new WeakMap,St=new WeakMap,Rt=new WeakMap,ze=new WeakMap,qe=new WeakMap,ce=new WeakMap,he=new WeakMap,ke=new WeakMap,We=new WeakMap,Qe=new WeakMap,Ye=new WeakMap,vr);var Kt=Br(wr(),1);U();U();var Tt,kr,Sr=(kr=class{constructor(g,e,a,h){T(this,Tt,!1);x(this,Tt,g),this.start=e,this.end=a,this.data=h}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return t(this,Tt)}},Tt=new WeakMap,kr),Vt=class extends Sr{constructor(g,e,a){super(!0,g,e,a)}},Tr=class extends Sr{constructor(g,e){super(!1,g,g,e)}},je,xr,Ft=(xr=class extends Array{constructor(){super(...arguments);T(this,je,-1)}resetIndex(e){x(this,je,-1)}fresh(){this.sort(function(e,a){return e.start==a.start?0:(+(e.start>a.start)<<1)-1}),this.forEach(function(e,a){e.index=a})}step(e,a=!1){let h=[];if(a)for(let n=0;n<this.length&&!(this[n].start>e);n++){if(this[n].end<e)continue;h.push(this[n])}else{let n=this.getRange(t(this,je)==-1?0:e-1,e),p=this;n.forEach(function(y){y.index>t(p,je)&&(h.push(y),x(p,je,y.index))})}return h}getRange(e,a){var v;e>a&&([e,a]=[a,e]);let h=[],n=-1,p=Math.ceil(Math.sqrt(this.length)),y=!0;for(let k=0;k<this.length;k+=p)this[k+p]?n<0&&this[k+p].start>=e&&(n=k):n=n<0?k:n;for(;y;)((v=this[n])==null?void 0:v.end)<a?this[n].start>=e&&h.push(this[n]):y=!1,n++;return h}},je=new WeakMap,xr);var Yr=0xffffffffffff,Cr=function(g){let e=new Ft,a=this,h=g.timeDivision,n=120,p=new Ft,y=0,v=0;p.push(new Vt(0,Yr,[120,0])),g.track.forEach(function(l){y=0,l.event.forEach(function(i){y+=i.deltaTime,i.type==255&&(i==null?void 0:i.metaType)==81&&(n=6e7/i.data,p[p.length-1]&&p.push(new Vt(y,0xffffffffffff,[n,0])))})}),p.fresh(),p.forEach(function(l,i,s){i>0&&(s[i-1].end=l.start)});let k=120;p.forEach(function(l,i,s){i>0&&(l.end==l.start?s.splice(s.indexOf(l),1):k==l.data[0]&&(s[i-1].end=l.end,s.splice(s.indexOf(l),1)),k=l.data[0])});let r=0,o=120;return p.forEach(function(l){let i=l.start,s=i/o/h*60+r;o=l.data[0],r=s-i/o/h*60,l.data[1]=r}),console.debug("All tempo changes: ",p),n=120,y=0,v=0,g.track.forEach(function(l,i){y=0,v=0;let s=i+1;l.event.forEach(function(c,d){y+=c.deltaTime;let u=p.step(y,!0)[0];u&&(n=u.data[0],v=u.data[1]);let f={type:c.type,data:c.data,track:s,part:0};c.type>14?f.meta=c.metaType:f.part=c.channel,e.push(new Tr(y/n/h*60+v,f))})}),e.fresh(),self.midiEvents=e,console.debug(`Parsed a type ${g.formatType} MIDI sequence.`),e};Kt.default.customInterpreter=lr;var N=function(g,e,a){g.addEventListener(a,h=>{e.dispatchEvent(a,h.data)})},Ze,Je,ut,Me,et,pt,tt,Ct,Ne,He,Z,rt,Pe,at,Mr,ai=(Mr=class extends Mt{constructor(e,a=.5,h=.5){super();P(this,"device");T(this,Ze,void 0);T(this,Je,{});T(this,ut,[]);T(this,Me,"");T(this,et,[]);T(this,pt,[]);T(this,tt,new Uint8ClampedArray(128));T(this,Ct,new Uint8ClampedArray(128));T(this,Ne,.5);T(this,He,120);T(this,Z,4);T(this,rt,4);T(this,Pe,0);T(this,at,0);P(this,"smoothingAtk",0);P(this,"smoothingDcy",0);let n=this;n.smoothingAtk=a,n.smoothingDcy=h,n.device=e,n.addEventListener("meta",function(p){var y;(y=p==null?void 0:p.data)==null||y.forEach(function(v){(t(n,et)[v.meta]||console.debug).call(n,v.meta,v.data)})}),N(n.device,n,"mode"),N(n.device,n,"mastervolume"),N(n.device,n,"channelactive"),N(n.device,n,"channelmin"),N(n.device,n,"channelmax"),N(n.device,n,"portrange"),N(n.device,n,"portstart"),N(n.device,n,"channelreset"),N(n.device,n,"channeltoggle"),N(n.device,n,"screen"),N(n.device,n,"metacommit"),N(n.device,n,"voice"),N(n.device,n,"pitch"),N(n.device,n,"note"),N(n.device,n,"reset"),N(n.device,n,"banklevel"),N(n.device,n,"efxreverb"),N(n.device,n,"efxchorus"),N(n.device,n,"efxdelay"),N(n.device,n,"efxinsert0"),N(n.device,n,"efxinsert1"),N(n.device,n,"efxinsert2"),N(n.device,n,"efxinsert3"),N(n.device,n,"partefxtoggle"),n.addEventListener("note",function({data:p}){t(n,pt).push(p)}),t(n,et)[3]=function(p,y){var v;((v=t(n,Me))==null?void 0:v.length)<1&&(x(n,Me,y),n.dispatchEvent("title",t(n,Me)))},t(n,et)[81]=function(p,y){let v=n.noteProgress,k=t(n,Ne)||.5;x(n,He,6e7/y),x(n,Ne,y/1e6),x(n,Pe,t(n,Pe)+(v*(k/t(n,Ne))-v)),n.dispatchEvent("tempo",t(n,He))},t(n,et)[88]=function(p,y){let v=n.noteProgress,k=n.noteOverall,r=n.noteBar,o=n.noteBeat,l=t(n,Z),i=t(n,rt);x(n,Z,y[0]),x(n,rt,1<<y[1]);let s=24*(32/y[3])/y[2];if(l!=t(n,Z)){let c=r;x(n,Pe,t(n,Pe)-c*(t(n,Z)-l)),o+1>=l&&(l<t(n,Z)?x(n,Pe,t(n,Pe)-Math.ceil(t(n,Z)-o-1)):x(n,Pe,t(n,Pe)+t(n,Z)))}n.dispatchEvent("tsig",n.getTimeSig())}}reset(){var a;let e=this;e.dispatchEvent("reset"),(a=t(e,Ze))==null||a.resetIndex(),e.device.init(),x(e,Me,""),x(e,Ne,.5),x(e,He,120),x(e,Z,4),x(e,rt,4),x(e,Pe,0),x(e,at,0),e.dispatchEvent("tempo",t(e,He)),e.dispatchEvent("title",t(e,Me))}init(){this.reset(),x(this,Ze,void 0)}async loadFile(e){x(this,Ze,Cr(Kt.default.parse(new Uint8Array(await e.arrayBuffer()))))}async loadMap(e,a){let h=this,n=0,p=0,y=0,v,k;e.split(`
`).forEach((r,o)=>{if(!r)return;let l=r.split("	");if(o){if(!y)return;let i="",s="";l.forEach((c,d)=>{switch(d){case v:{i=c;break}case k:{s=c;break}}}),!t(h,Je)[i]||a?(t(h,Je)[i]=s,n++):self.debugMode&&console.debug(`Voice "${s}" (${i}) seems to be in conflict with (${t(h,Je)[i]}).`),p++}else l.forEach((i,s)=>{switch(i){case"ID":{v=s,y++;break}case"Name":{k=s,y++;break}default:console.debug(`Unknown map field: ${i}`)}})}),console.debug(`Voice names: ${p} total, ${n} loaded.`),h==null||h.device.forceVoiceRefresh()}async loadEfx(e,a){let h=this,n=0,p=0,y,v,k;e.split(`
`).forEach((r,o)=>{if(r)if(o){let l=0,i;r.split("	").forEach((s,c)=>{switch(c){case y:{l|=parseInt(s,16)<<8;break}case v:{l|=parseInt(s,16);break}case k:{i=s;break}}}),!t(h,ut)[l]||a?(t(h,ut)[l]=i,n++):self.debugMode&&console.debug(`EFX ID 0x${l.toString(16).padStart(4,"0")} (${i}) seems to be in conflict.`),p++}else r.split("	").forEach((l,i)=>{switch(l){case"MSB":{y=i;break}case"LSB":{v=i;break}case"Name":{k=i;break}default:console.debug(`Unknown EFX field: ${l}`)}})}),console.debug(`EFX: ${p} total, ${n} loaded.`),h.dispatchEvent("efxreverb",h.device.getEffectType(0)),h.dispatchEvent("efxchorus",h.device.getEffectType(1)),h.dispatchEvent("efxdelay",h.device.getEffectType(2)),h.dispatchEvent("efxinsert0",h.device.getEffectType(3)),h.dispatchEvent("efxinsert1",h.device.getEffectType(4)),h.dispatchEvent("efxinsert2",h.device.getEffectType(5)),h.dispatchEvent("efxinsert3",h.device.getEffectType(6))}switchMode(e,a=!1){this.device.switchMode(e,a)}getMode(){return this.device.getMode()}getVoice(){return this.device.getVoice(...arguments)}getChVoice(e){return this.device.getChVoice(e)}getMapped(e){return t(this,Je)[e]||e}getEfx([e,a]){let h=e<<8|a;return t(this,ut)[h]||`0x${h.toString(16).padStart(4,"0")}`}get noteProgress(){return t(this,at)/t(this,Ne)}get noteOverall(){return this.noteProgress-t(this,Pe)}get noteBar(){return Math.floor(this.noteOverall/t(this,Z))}get noteBeat(){let e=this.noteOverall%t(this,Z);return e<0&&(e+=t(this,Z)),e}getTimeSig(){return[t(this,Z),t(this,rt)]}getTempo(){return t(this,He)}sendCmd(e){this.device.runJson(e)}render(e){var w;e>t(this,at)&&x(this,at,e);let a=((w=t(this,Ze))==null?void 0:w.step(e))||[],h=0,n=new Set,p={},y=[],v=this,k=[];for(v.device.getStrength().forEach((C,M)=>{t(v,Ct)[M]=C}),v.device.newStrength(),a.forEach(function(C){let M=C.data,_=v.device.runJson(M);switch(_==null?void 0:_.reply){case"meta":{k.push(_);break}}_!=null&&_.reply&&delete _.reply});t(v,pt).length>0;){let C=t(v,pt).shift(),M=C.part<<7|C.note;C.state?(n.add(M),p[M]=C.velo):n.has(M)&&(y.push({part:C.part,note:C.note,velo:p[M],state:v.device.NOTE_SUSTAIN}),h++)}(k==null?void 0:k.length)>0&&v.dispatchEvent("meta",k);let r=v.device.getActive(),o=[],l=v.device.getPitch(),i=v.device.getCcAll(),s=v.device.getProgram(),c=v.device.getChType(),d=[],u=v.device.getStrength();u.forEach(function(C,M,_){_[M]=Math.max(t(v,Ct)[M],C);let Re=_[M]-t(v,tt)[M],_e=E.length*M;if(Re>=0){let Ot=4*.25**(i[_e+E[73]]/64);t(v,tt)[M]+=Math.ceil(Re-Re*v.smoothingAtk**Ot)}else{let Ot=4*.25**(i[_e+E[72]]/64);t(v,tt)[M]+=Math.floor(Re-Re*v.smoothingDcy**Ot)}});let f=0;return r.forEach(function(C,M){C&&(o[M]=v.device.getVel(M),d[M]=v.device.getExt(M),f+=o[M].size)}),{extraPoly:h,extraNotes:y,curPoly:f,chInUse:r,chKeyPr:o,chPitch:l,chProgr:s,chContr:i,chType:c,chExt:d,eventCount:a.length,title:t(v,Me),bitmap:v.device.getBitmap(),letter:v.device.getLetter(),texts:v.device.getTexts(),master:v.device.getMaster(),mode:v.device.getMode(),strength:t(v,tt).slice(),velo:u,rpn:v.device.getRpn(),tSig:v.getTimeSig(),tempo:v.getTempo(),noteBar:v.noteBar,noteBeat:v.noteBeat,ace:v.device.getAce(),rawVelo:v.device.getStrength(),rawStrength:v.device.getRawStrength(),rawPitch:v.device.getRawPitch(),efxSink:v.device.getEffectSink()}}},Ze=new WeakMap,Je=new WeakMap,ut=new WeakMap,Me=new WeakMap,et=new WeakMap,pt=new WeakMap,tt=new WeakMap,Ct=new WeakMap,Ne=new WeakMap,He=new WeakMap,Z=new WeakMap,rt=new WeakMap,Pe=new WeakMap,at=new WeakMap,Mr);export{ai as RootDisplay,m as allocated,E as ccToPos,le as dnToPos};
