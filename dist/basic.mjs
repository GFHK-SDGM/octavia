var W=Object.create;var _=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty;var ee=(e,a)=>()=>(a||e((a={exports:{}}).exports,a),a.exports);var te=(e,a,r,t)=>{if(a&&typeof a=="object"||typeof a=="function")for(let n of Z(a))!j.call(e,n)&&n!==r&&_(e,n,{get:()=>a[n],enumerable:!(t=Y(a,n))||t.enumerable});return e};var ae=(e,a,r)=>(r=e!=null?W(J(e)):{},te(a||!e||!e.__esModule?_(r,"default",{value:e,enumerable:!0}):r,e));var K=ee((ht,I)=>{(function(){"use strict";let e={fatal:!0},a=[new TextDecoder("iso-8859-15",e),new TextDecoder("sjis",e),new TextDecoder("euc-jp",e),new TextDecoder("utf-8",e),new TextDecoder("utf-16",e),new TextDecoder("ascii")],r={debug:!1,parse:function(t,n){if(t instanceof Uint8Array)return r.Uint8(t);if(typeof t=="string")return r.Base64(t);if(t instanceof HTMLElement&&t.type==="file")return r.addListener(t,n);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(t,n){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(t===void 0||!(t instanceof HTMLElement)||t.tagName!=="INPUT"||t.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;n=n||function(){},t.addEventListener("change",function(i){if(!i.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let h=new FileReader;h.readAsArrayBuffer(i.target.files[0]),h.onload=function(o){n(r.Uint8(new Uint8Array(o.target.result)))}})},Base64:function(t){let n=function(o){var g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(o=o.replace(/^.*?base64,/,""),o=String(o).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(o))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");o+="==".slice(2-(3&o.length));let u,f="",s,c,l=0;for(;l<o.length;)u=g.indexOf(o.charAt(l++))<<18|g.indexOf(o.charAt(l++))<<12|(s=g.indexOf(o.charAt(l++)))<<6|(c=g.indexOf(o.charAt(l++))),f+=s===64?String.fromCharCode(u>>16&255):c===64?String.fromCharCode(u>>16&255,u>>8&255):String.fromCharCode(u>>16&255,u>>8&255,255&u);return f}(t=String(t));var i=n.length;let h=new Uint8Array(new ArrayBuffer(i));for(let o=0;o<i;o++)h[o]=n.charCodeAt(o);return r.Uint8(h)},Uint8:function(h){let n={data:null,pointer:0,movePointer:function(s){return this.pointer+=s,this.pointer},readInt:function(s){if((s=Math.min(s,this.data.byteLength-this.pointer))<1)return-1;let c=0;if(1<s)for(let l=1;l<=s-1;l++)c+=this.data.getUint8(this.pointer)*Math.pow(256,s-l),this.pointer++;return c+=this.data.getUint8(this.pointer),this.pointer++,c},readStr:function(s){let c=new Uint8Array(s),l=!1,d;c.forEach((b,p)=>{c[p]=this.readInt(1)});for(let b=0;b<a.length;b++)if(!l)try{if(d=a[b].decode(c),b==0)for(let p=0;p<d.length;p++){let m=d.charCodeAt(p);if(m>191||m>127&&m<160)throw new RangeError(`Invalid code point: ${m}`)}l=!0,console.debug(`String byte sequence in ${a[b].encoding}`)}catch(p){console.debug(`SMF string ${p}`)}return d||"String byte sequence read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let s=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)s=this.readInt(1);else{let l=[];for(;128<=this.data.getUint8(this.pointer);)l.push(this.readInt(1)-128);var c=this.readInt(1);for(let d=1;d<=l.length;d++)s+=l[l.length-d]*Math.pow(128,d);s+=c}return s}};if(n.data=new DataView(h.buffer,h.byteOffset,h.byteLength),n.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;n.readInt(4);let i={};i.formatType=n.readInt(2),i.tracks=n.readInt(2),i.track=[];var h=n.readInt(1),o=n.readInt(1);128<=h?(i.timeDivision=[],i.timeDivision[0]=h-128,i.timeDivision[1]=o):i.timeDivision=256*h+o;for(let s=1;s<=i.tracks;s++){i.track[s-1]={event:[]};var g,u=n.readInt(4);if(u===-1)break;if(u!==1297379947)return!1;n.readInt(4);let c=0,l=!1,d,b;for(;!l&&(c++,i.track[s-1].event[c-1]={},i.track[s-1].event[c-1].deltaTime=n.readIntVLV(),(d=n.readInt(1))!==-1);)if(128<=d?b=d:(d=b,n.movePointer(-1)),d===255){i.track[s-1].event[c-1].type=255,i.track[s-1].event[c-1].metaType=n.readInt(1);var f=n.readIntVLV();switch(i.track[s-1].event[c-1].metaType){case 47:case-1:l=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:i.track[s-1].event[c-1].data=n.readStr(f);break;case 33:case 89:case 81:i.track[s-1].event[c-1].data=n.readInt(f);break;case 84:i.track[s-1].event[c-1].data=[],i.track[s-1].event[c-1].data[0]=n.readInt(1),i.track[s-1].event[c-1].data[1]=n.readInt(1),i.track[s-1].event[c-1].data[2]=n.readInt(1),i.track[s-1].event[c-1].data[3]=n.readInt(1),i.track[s-1].event[c-1].data[4]=n.readInt(1);break;case 88:i.track[s-1].event[c-1].data=[],i.track[s-1].event[c-1].data[0]=n.readInt(1),i.track[s-1].event[c-1].data[1]=n.readInt(1),i.track[s-1].event[c-1].data[2]=n.readInt(1),i.track[s-1].event[c-1].data[3]=n.readInt(1);break;default:this.customInterpreter!==null&&(i.track[s-1].event[c-1].data=this.customInterpreter(i.track[s-1].event[c-1].metaType,n,f)),this.customInterpreter!==null&&i.track[s-1].event[c-1].data!==!1||(n.readInt(f),i.track[s-1].event[c-1].data=n.readInt(f),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((d=d.toString(16).split(""))[1]||d.unshift("0"),i.track[s-1].event[c-1].type=parseInt(d[0],16),i.track[s-1].event[c-1].channel=parseInt(d[1],16),i.track[s-1].event[c-1].type){case 15:this.customInterpreter!==null&&(i.track[s-1].event[c-1].data=this.customInterpreter(i.track[s-1].event[c-1].type,n,!1)),this.customInterpreter!==null&&i.track[s-1].event[c-1].data!==!1||(g=n.readIntVLV(),i.track[s-1].event[c-1].data=n.readInt(g),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:i.track[s-1].event[c-1].data=[],i.track[s-1].event[c-1].data[0]=n.readInt(1),i.track[s-1].event[c-1].data[1]=n.readInt(1);break;case 12:case 13:i.track[s-1].event[c-1].data=n.readInt(1);break;case-1:l=!0;break;default:if(this.customInterpreter!==null&&(i.track[s-1].event[c-1].data=this.customInterpreter(i.track[s-1].event[c-1].metaType,n,!1)),this.customInterpreter===null||i.track[s-1].event[c-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return i},customInterpreter:null};if(typeof I<"u")I.exports=r;else{let t=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;t.MidiParser=r}})()});var P=class{#e={};addEventListener(e,a){this.#e[e]||(this.#e[e]=[]),this.#e[e].unshift(a)}removeEventListener(e,a){if(this.#e[e]){let r=this.#e[e].indexOf(a);r>-1&&this.#e[e].splice(r,1),this.#e[e].length<1&&delete this.#e[e]}}dispatchEvent(e,a){let r=new Event(e),t=this;r.data=a,this.#e[e]?.length>0&&this.#e[e].forEach(function(n){try{n?.call(t,r)}catch(i){console.error(i)}}),this[`on${e}`]&&this[`on${e}`](r)}};var G=class{#e={};context;set(e,a){this.#e[e]=a}has(e){return!!this.#e[e]}async read(e,a){if(!this.has(e))throw new Error(`No decoder registered for "${e}"`);return await this.#e[e].call(this.context||this,a)}};var re=function(e,a){let r=!0;return a.forEach((t,n)=>{r=r&&e[n]==t}),r},T=function(e){let a=0;return e.forEach(r=>{a*=256,a+=r}),a},k=new TextDecoder,R=new G;R.set("s7e",async function(e){let a=new Uint8Array(await e.slice(0,65536).arrayBuffer()),r="MSB	LSB	PRG	NME",t=[0,0,0,0],n=32,i=0,h=0,o=!0,g=[],u=0;for(;o;){let f=a.subarray(i);([()=>{k.decode(f.subarray(0,4))=="YSFC"?(i+=80,h=1):i++},()=>{if(re(f.subarray(0,4),t))g.forEach((s,c,l)=>{let d=T(a.subarray(s.start+4,s.start+8));s.length=d}),h=2;else{let s=k.decode(f.subarray(0,4)),c=T(f.subarray(4,8));g.push({type:s,start:c}),i+=8}},()=>{let s=g[u],c=a.subarray(s.start,s.start+s.length),l=32;switch(s.type){case"ENVC":{let d=n;for(;d<c.length;){let b=c.subarray(d,d+l),p=k.decode(b.subarray(0,10)).trimEnd();p.slice(0,5)=="Init "&&(p=""),p&&(r+=`
063	${(b[17]+13).toString().padStart(3,"0")}	${b[19].toString().padStart(3,"0")}	${p}`),d+=l}break}case"EDVC":{let d=n;for(;d<c.length;){let b=c.subarray(d,d+l),p=k.decode(b.subarray(0,10)).trimEnd();p.slice(0,5)=="Init "&&(p=""),p&&(r+=`
063	024	${b[19].toString().padStart(3,"0")}	${p}`),d+=l}break}case"EPVC":{let d=32,b=n;for(;b<c.length;){let p=c.subarray(b,b+d),m=k.decode(p.subarray(0,10)).trimEnd();m=="----------"&&(m=""),m&&(r+=`
063	${(p[17]+1).toString().padStart(3,"0")}	${p[19].toString().padStart(3,"0")}	${m}`),b+=d}break}}u++,u>=g.length&&(h=3,o=!1)}][h]||(()=>{o=!1}))()}return r});R.set("pcg",async function(e){let a=new Uint8Array(await e.arrayBuffer()),r="MSB	LSB	PRG	NME",t=100,n=0,i=0,h=!0,o=[],g=0;for(;h;){let u=a.subarray(t);([()=>{h=k.decode(u.subarray(0,4))=="INI2",i=u[15],t+=16,n=1},()=>{let f=k.decode(u.subarray(0,4)),s=u[5],c=u[7],l=u[11],d=T(u.subarray(12,16)),b=T(u.subarray(16,20)),p=T(u.subarray(36,40)),m=k.decode(u.subarray(44,44+l));o.push({type:f,tipMsb:s,tipLsb:c,nameLen:l,length:d,start:b,entryLen:p,name:m}),t+=64,i--,i<1&&(n=2)},()=>{let f=o[g],s=a.subarray(f.start,f.start+f.length);switch(f.type){case"PRG1":break;case"PBK1":{let c=63,l=(f.tipMsb?6:0)+f.tipLsb;for(let d=0;d<128;d++){let b=d*f.entryLen,p=s.subarray(b,b+f.entryLen),m=k.decode(p.subarray(0,24)).trimEnd().replace("InitProg","");m.length&&l>5&&(r+=`
${c.toString().padStart(3,"0")}	${l.toString().padStart(3,"0")}	${d.toString().padStart(3,"0")}	${m}`)}break}case"CBK1":{let c=63,l=(f.tipMsb?3:0)+f.tipLsb+10;for(let d=0;d<128;d++){let b=d*f.entryLen,p=s.subarray(b,b+f.entryLen),m=k.decode(p.subarray(0,24)).trimEnd().replace("InitCombi","");m.length&&l>12&&(r+=`
${c.toString().padStart(3,"0")}	${l.toString().padStart(3,"0")}	${d.toString().padStart(3,"0")}	${m}`)}break}}g++,g>=o.length&&(n=3,h=!1)}][n]||(()=>{h=!1}))()}return r});var ie=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]);var se=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),ne={};`hi*,
ka,か
ki,き
ku,く
ke,け
ko,こ
ky,き!
kw,くl
tsu,つ
ts,つl
sa,さ
si,すぃ
su,す
se,せ
so,そ
shi,し
sh,し!
ta,た
ti,てぃ
tu,とぅ
te,て
to,と
tchy,ち!
tchi,ち
na,な
ni,に
nu,ぬ
ne,ね
no,の
ny,に!
nn,ん
ha,は
hi,ひ
hu,ほぅ
he,へ
ho,ほ
hy,ひ!
fa,ふぁ
fi,ふぃ
fu,ふ
fe,ふぇ
fo,ふぉ
ma,ま
mi,み
mu,む
me,め
mo,も
my,み!
mm,ㇺ
ra,ら
ri,り
ru,る
re,れ
ro,ろ
ry,り!
wa,わ
wi,うぃ
we,うぇ
wo,を
nga,か゚
ngi,き゚
ngu,く゚
nge,け゚
ngo,こ゚
ngy,き゚!
ng,ン
ga,が
gi,ぎ
gu,ぐ
ge,げ
go,ご
gy,ぎ!
gw,ぐl
za,ざ
zi,ずぃ
zu,ず
ze,ぜ
zo,ぞ
ja,じゃ
ji,じ
ju,じゅ
je,じぇ
jo,じょ
jy,じ!
da,だ
di,でぃ
du,どぅ
de,で
do,ど
dy,で!
ba,ば
bi,び
bu,ぶ
be,べ
bo,ぼ
by,び!
va,ゔぁ
vi,ゔぃ
vu,ゔ
ve,ゔぇ
vo,ゔぉ
pa,ぱ
pi,ぴ
pu,ぷ
pe,ペ
po,ぽ
py,ぴ!
!ya,ゃ
!yu,ゅ
!ye,ぇ
!yo,ょ
ya,や
yu,ゆ
ye,いぇ
yo,よ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
la,ぁ
li,ぃ
lu,ぅ
le,ぇ
lo,ぉ
a,あ
i,い
u,う
e,え
o,お
*,っ
~,
^,
_,`.split(`
`).forEach(e=>{let a=e.split(",");ne[a[0]]=a[1]});var X=function(e,a,r){let t=[],n=r==!1?a.readIntVLV():r;e==0||e==127;for(let i=0;i<n;i++){let h=a.readInt(1);if(t.push(h),h!=247){if(h!=240){if(h>127)return console.debug(`Early termination: ${t}`),t.pop(),a.backOne(),a.backOne(),new Uint8Array(t)}}}return new Uint8Array(t)};var ce=["?","gm","gs","sc","xg","g2","mt32","doc","qy10","qy20","ns5r","x5d","05rw","k11","sg","sd","krs","s90es","motif","trin"];var oe=["melodic","drum","menu"];var le=[36,37,48,49,52,53],A=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65];var O=[0,1,2,4,5,6,7,8,10,11,32,38,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,84,91,92,93,94,95,98,99,100,101,128,12,13,16,17,18,19,14,15,20,21,26,28,22,80,81,82,83,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157];var de={};ce.forEach((e,a)=>{de[e]=a});var S={length:O.length};O.forEach((e,a)=>{S[e]=a});var F={length:A.length};A.forEach((e,a)=>{F[e]=a});var he={};oe.forEach((e,a)=>{he[e]=a});var D=8,v={port:D,ch:D<<4,chShift:Math.ceil(Math.log2(D))+4,cc:O.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,rpnt:4,nrpn:le.length,ace:8,drm:8,dpn:A.length,dnc:128,ext:3,efx:7,cvn:12,redir:32,vxPrim:3,invalidCh:255},x={bank0:128},fe=new Uint16Array(v.ch),ue=new Uint16Array(v.ch),pe=new Uint16Array(v.ch),be=new Uint16Array(v.ch),ge=new Uint16Array(v.ch),V=new Array(v.drm);for(let e=0;e<v.ch;e++)fe[e]=e*v.cc,ue[e]=e*v.rpn,pe[e]=e*v.nrpn,be[e]=e*v.ace,ge[e]=e*v.ext;for(let e=0;e<v.drm;e++){V[e]=new Uint16Array(v.dpn);let a=e*v.dpn*v.dnc;for(let r=0;r<v.dpn;r++)V[e][r]=a+r*v.dnc}var U=ae(K(),1);var z=class{#e=!1;constructor(e,a,r,t){this.#e=e,this.start=a,this.end=r,this.data=t}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#e}},L=class extends z{constructor(e,a,r){super(!0,e,a,r)}},q=class extends z{constructor(e,a){super(!1,e,e,a)}},B=class extends Array{#e=-1;constructor(){super(...arguments)}resetIndex(e){this.#e=-1}fresh(){this.sort(function(e,a){return e.start==a.start?0:(+(e.start>a.start)<<1)-1}),this.forEach(function(e,a){e.index=a})}step(e,a=!1){let r=[];if(a)for(let t=0;t<this.length&&!(this[t].start>e);t++){if(this[t].end<e)continue;r.push(this[t])}else{let t=this.getRange(this.#e==-1?0:e-1,e),n=this;t.forEach(function(i){i.index>n.#e&&(r.push(i),n.#e=i.index)})}return r}getRange(e,a){e>a&&([e,a]=[a,e]);let r=[],t=-1,n=Math.ceil(Math.sqrt(this.length)),i=!0;for(let h=0;h<this.length;h+=n)this[h+n]?t<0&&this[h+n].start>=e&&(t=h):t=t<0?h:t;for(;i;)this[t]?.end<a?this[t].start>=e&&r.push(this[t]):i=!1,t++;return r}};var me=0xffffffffffff,Q=function(e){let a=new B,r=this,t=e.timeDivision,n=120,i=new B,h=0,o=0;i.push(new L(0,me,[120,0])),e.track.forEach(function(s){h=0,s.event.forEach(function(c){h+=c.deltaTime,c.type==255&&c?.metaType==81&&(n=6e7/c.data,i[i.length-1]&&i.push(new L(h,0xffffffffffff,[n,0])))})}),i.fresh(),i.forEach(function(s,c,l){c>0&&(l[c-1].end=s.start)});let g=120;i.forEach(function(s,c,l){c>0&&(s.end==s.start?l.splice(l.indexOf(s),1):g==s.data[0]&&(l[c-1].end=s.end,l.splice(l.indexOf(s),1)),g=s.data[0])});let u=0,f=120;return i.forEach(function(s){let c=s.start,l=c/f/t*60+u;f=s.data[0],u=l-c/f/t*60,s.data[1]=u}),console.debug("All tempo changes: ",i),n=120,h=0,o=0,e.track.forEach(function(s,c){h=0,o=0;let l=c+1;s.event.forEach(function(d,b){h+=d.deltaTime;let p=i.step(h,!0)[0];p&&(n=p.data[0],o=p.data[1]);let m={type:d.type,data:d.data,track:l,part:0};d.type>14?m.meta=d.metaType:m.part=d.channel,a.push(new q(h/n/t*60+o,m))})}),a.fresh(),self.midiEvents=a,console.debug(`Parsed a type ${e.formatType} MIDI sequence.`),a};U.default.customInterpreter=X;var y=function(e,a,r){e.addEventListener(r,t=>{a.dispatchEvent(r,t.data)})},wt=class extends P{device;#e;#i={};#f=[];#r="";#o=[];#u=[];#l=new Uint8ClampedArray(128);#p=new Uint8ClampedArray(128);#s=.5;#n=120;#t=4;#d=4;#a=0;#h=0;#b=new Array(v.ch);#c=new Uint8Array(v.ch);smoothingAtk=0;smoothingDcy=0;reset(){let e=this;e.dispatchEvent("reset"),e.#e?.resetIndex(),e.device.init(),e.#r="",e.#s=.5,e.#n=120,e.#t=4,e.#d=4,e.#a=0,e.#h=0,e.dispatchEvent("tempo",e.#n),e.dispatchEvent("title",e.#r)}init(){this.reset(),this.#e=void 0}async loadFile(e){this.#e=Q(U.default.parse(new Uint8Array(await e.arrayBuffer())))}async loadMap(e,a,r){let t=this,n=0,i=0,h=0,o=0,g,u;e.split(`
`).forEach((f,s)=>{if(!f)return;let c=f.split("	");if(s){if(!o)return;let l="",d="";c.forEach((p,m)=>{switch(m){case g:{l=p;break}case u:{d=p;break}}});let b=!1;t.#i[l]?.priority>r&&(b=!0,h++),!t.#i[l]||b||a?(t.#i[l]={name:d,priority:r},n++):self.debugMode&&console.debug(`Voice "${d}" (${l}) seems to be in conflict with (${t.#i[l]}).`),i++}else c.forEach((l,d)=>{switch(l){case"ID":{g=d,o++;break}case"Name":{u=d,o++;break}default:console.debug(`Unknown map field: ${l}`)}})}),console.debug(`Voice names: ${i} total, ${n} loaded (${n-h} + ${h}).`),t?.device.forceVoiceRefresh()}async loadMapPaths(e){let a=this;e.forEach(async(r,t)=>{a.loadMap(await(await fetch(r)).text(),0,t)})}async loadEfx(e,a){let r=this,t=0,n=0,i,h,o;e.split(`
`).forEach((g,u)=>{if(g)if(u){let f=0,s;g.split("	").forEach((c,l)=>{switch(l){case i:{f|=parseInt(c,16)<<8;break}case h:{f|=parseInt(c,16);break}case o:{s=c;break}}}),!r.#f[f]||a?(r.#f[f]=s,t++):self.debugMode&&console.debug(`EFX ID 0x${f.toString(16).padStart(4,"0")} (${s}) seems to be in conflict.`),n++}else g.split("	").forEach((f,s)=>{switch(f){case"MSB":{i=s;break}case"LSB":{h=s;break}case"Name":{o=s;break}default:console.debug(`Unknown EFX field: ${f}`)}})}),console.debug(`EFX: ${n} total, ${t} loaded.`),r.dispatchEvent("efxreverb",r.device.getEffectType(0)),r.dispatchEvent("efxchorus",r.device.getEffectType(1)),r.dispatchEvent("efxdelay",r.device.getEffectType(2)),r.dispatchEvent("efxinsert0",r.device.getEffectType(3)),r.dispatchEvent("efxinsert1",r.device.getEffectType(4)),r.dispatchEvent("efxinsert2",r.device.getEffectType(5)),r.dispatchEvent("efxinsert3",r.device.getEffectType(6))}switchMode(e,a=!1){this.device.switchMode(e,a)}getMode(){return this.device.getMode()}getVoice(){return this.device.getVoice(...arguments)}getChVoice(e){return this.device.getChVoice(e)}getMapped(e){return this.#i[e]?.name||e}getEfx([e,a]){let r=e<<8|a;return this.#f[r]||`0x${r.toString(16).padStart(4,"0")}`}getVoxBm(e){if(!e)throw new Error("Voice object must be valid");let a=this;if(!a.voxBm)throw new Error("Voice bitmap repository isn't yet initialized");let r=a.voxBm.getBm(e.name);if(!r)switch(e.mode){case"xg":{switch(e.sid[0]){case 0:case 80:case 81:case 83:case 84:case 96:case 97:case 99:case 100:{r=a.voxBm.getBm(a.getVoice(x.bank0,e.sid[1],x.bank0,e.mode).name);break}}break}case"g2":case"sd":{switch(e.sid[0]){case 96:case 97:case 98:case 99:{r=a.voxBm.getBm(a.getVoice(x.bank0,e.sid[1],x.bank0,e.mode).name);break}case 104:case 105:case 106:case 107:{r=a.voxBm.getBm(a.getVoice(120,e.sid[1],x.bank0,e.mode).name);break}}break}case"gs":case"sc":case"k11":case"sg":case"gm":{switch(e.sid[0]){case 120:break;case 122:case 127:{r=a.voxBm.getBm(a.getVoice(120,e.sid[1],0,e.mode).name);break}default:r=a.voxBm.getBm(a.getVoice(0,e.sid[1],0,e.mode).name)}break}default:switch(e.sid[0]){case 56:{r=a.voxBm.getBm(a.getVoice(0,e.sid[1],0,e.mode).name);break}}}return r||(r=a.voxBm.getBm(a.getVoice(e.sid[0],e.sid[1],0,e.mode).name)),r}getChBm(e,a){let r=this;a=a||r.getChVoice(e);let t=r.getVoxBm(a);if(!t){if(!r.sysBm)return;switch(a.mode){case"xg":{switch(a.sid[0]){case 126:{a.sid[1]>>1==56&&(t=r.sysBm.getBm("cat_smpl"));break}case 16:{t=r.sysBm.getBm("cat_smpl");break}case 64:case 67:{t=r.sysBm.getBm("cat_sfx");break}case 32:case 33:case 34:case 35:case 36:case 48:case 82:{t=r.sysBm.getBm("cat_xg");break}}break}default:switch(a.sid[0]){case 63:case 32:case 33:case 34:case 35:case 36:case 48:case 82:{t=r.sysBm.getBm("cat_mex");break}}}}return t||(r.device.getChType()[e]?t=r.sysBm.getBm("cat_drm"):t=r.sysBm.getBm("no_vox")),t}get noteProgress(){return this.#h/this.#s}get noteOverall(){return this.noteProgress-this.#a}get noteBar(){return Math.floor(this.noteOverall/this.#t)}get noteBeat(){let e=this.noteOverall%this.#t;return e<0&&(e+=this.#t),e}get noteOffset(){return this.#a}getTimeSig(){return[this.#t,this.#d]}getTempo(){return this.#n}eachVoice(e){this.#b.forEach(e)}sendCmd(e){this.device.runJson(e)}render(e){e>this.#h&&(this.#h=e);let a=this.#e?.step(e)||[],r=0,t=0,n=new Set,i={},h=[],o=this,g=[];for(o.device.getStrength().forEach(($,E)=>{o.#p[E]=$}),o.device.newStrength(),a.forEach(function($){let E=$.data,w=o.device.runJson(E);switch(w?.reply){case"meta":{g.push(w);break}}w?.reply&&delete w.reply});o.#u.length>0;){let $=o.#u.shift(),E=$.part<<7|$.note;$.state?(n.add(E),i[E]=$.velo):n.has(E)&&(h.push({part:$.part,note:$.note,velo:i[E],state:o.device.NOTE_SUSTAIN}),r++,t+=o.#c[$.part])}g?.length>0&&o.dispatchEvent("meta",g);let u=o.device.getActive(),f=[],s=o.device.getPitch(),c=o.device.getCcAll(),l=o.device.getProgram(),d=o.device.getChType(),b=[],p=o.device.getStrength();p.forEach(function($,E,w){w[E]=Math.max(o.#p[E],$);let C=w[E]-o.#l[E],H=S.length*E;if(C>=0){let M=4*.25**(c[H+S[73]]/64);o.#l[E]+=Math.ceil(C-C*o.smoothingAtk**M)}else{let M=4*.25**(c[H+S[72]]/64);o.#l[E]+=Math.floor(C-C*o.smoothingDcy**M)}});let m=0,N=0;return u.forEach(function($,E){$&&(f[E]=o.device.getVel(E),b[E]=o.device.getExt(E),m+=f[E].size,N+=f[E].size*o.#c[E])}),{extraPoly:r,extraPolyEC:t,extraNotes:h,curPoly:m,curPolyEC:N,chInUse:u,chKeyPr:f,chPitch:s,chProgr:l,chContr:c,chType:d,chExt:b,eventCount:a.length,title:o.#r,bitmap:o.device.getBitmap(),letter:o.device.getLetter(),texts:o.device.getTexts(),master:o.device.getMaster(),mode:o.device.getMode(),strength:o.#l.slice(),velo:p,rpn:o.device.getRpn(),tSig:o.getTimeSig(),tempo:o.getTempo(),noteBar:o.noteBar,noteBeat:o.noteBeat,ace:o.device.getAce(),rawVelo:o.device.getStrength(),rawStrength:o.device.getRawStrength(),rawPitch:o.device.getRawPitch(),efxSink:o.device.getEffectSink()}}constructor(e,a=.5,r=.5){super();let t=this;t.smoothingAtk=a,t.smoothingDcy=r,t.device=e,t.addEventListener("meta",function(n){n?.data?.forEach(function(i){(t.#o[i.meta]||console.debug).call(t,i.meta,i.data)})}),y(t.device,t,"mode"),y(t.device,t,"mastervolume"),y(t.device,t,"channelactive"),y(t.device,t,"channelmin"),y(t.device,t,"channelmax"),y(t.device,t,"portrange"),y(t.device,t,"portstart"),y(t.device,t,"channelreset"),y(t.device,t,"channeltoggle"),y(t.device,t,"screen"),y(t.device,t,"metacommit"),y(t.device,t,"voice"),y(t.device,t,"pitch"),y(t.device,t,"note"),y(t.device,t,"reset"),y(t.device,t,"banklevel"),y(t.device,t,"efxreverb"),y(t.device,t,"efxchorus"),y(t.device,t,"efxdelay"),y(t.device,t,"efxinsert0"),y(t.device,t,"efxinsert1"),y(t.device,t,"efxinsert2"),y(t.device,t,"efxinsert3"),y(t.device,t,"partefxtoggle"),t.addEventListener("note",function({data:n}){t.#u.push(n)}),t.addEventListener("voice",({data:n})=>{let i=t.getChVoice(n.part);t.#b[n.part]=i,t.#c[n.part]=i.poly??1}),t.addEventListener("reset",({data:n})=>{t.#c.fill(1)}),t.#c.fill(1),t.#o[3]=function(n,i){t.#r?.length<1&&(t.#r=i,t.dispatchEvent("title",t.#r))},t.#o[81]=function(n,i){let h=t.noteProgress,o=t.#s||.5;t.#n=6e7/i,t.#s=i/1e6,t.#a+=h*(o/t.#s)-h,t.dispatchEvent("tempo",t.#n)},t.#o[88]=function(n,i){let h=t.noteProgress,o=t.noteOverall,g=t.noteBar,u=t.noteBeat,f=t.#t,s=t.#d;t.#t=i[0],t.#d=1<<i[1];let c=24*(32/i[3])/i[2];if(f!=t.#t){let l=g;t.#a-=l*(t.#t-f),u+1>=f&&(f<t.#t?t.#a-=Math.ceil(t.#t-u-1):t.#a+=t.#t)}t.dispatchEvent("tsig",t.getTimeSig())}}};export{wt as RootDisplay,v as allocated,S as ccToPos,F as dnToPos};
