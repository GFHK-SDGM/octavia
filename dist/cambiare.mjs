var je=Object.create;var ye=Object.defineProperty;var et=Object.getOwnPropertyDescriptor;var tt=Object.getOwnPropertyNames;var at=Object.getPrototypeOf,rt=Object.prototype.hasOwnProperty;var it=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var st=(e,t,s,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let u of tt(t))!rt.call(e,u)&&u!==s&&ye(e,u,{get:()=>t[u],enumerable:!(o=et(t,u))||o.enumerable});return e};var nt=(e,t,s)=>(s=e!=null?je(at(e)):{},st(t||!e||!e.__esModule?ye(s,"default",{value:e,enumerable:!0}):s,e));var Xe=it((fa,fe)=>{(function(){"use strict";let e={fatal:!0},t=[new TextDecoder("iso-8859-15",e),new TextDecoder("sjis",e),new TextDecoder("euc-jp",e),new TextDecoder("utf-8",e),new TextDecoder("utf-16",e),new TextDecoder("ascii")],s={debug:!1,parse:function(o,u){if(o instanceof Uint8Array)return s.Uint8(o);if(typeof o=="string")return s.Base64(o);if(o instanceof HTMLElement&&o.type==="file")return s.addListener(o,u);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(o,u){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(o===void 0||!(o instanceof HTMLElement)||o.tagName!=="INPUT"||o.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;u=u||function(){},o.addEventListener("change",function(p){if(!p.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let y=new FileReader;y.readAsArrayBuffer(p.target.files[0]),y.onload=function(v){u(s.Uint8(new Uint8Array(v.target.result)))}})},Base64:function(o){let u=function(v){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(v=v.replace(/^.*?base64,/,""),v=String(v).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(v))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");v+="==".slice(2-(3&v.length));let d,l="",r,i,c=0;for(;c<v.length;)d=a.indexOf(v.charAt(c++))<<18|a.indexOf(v.charAt(c++))<<12|(r=a.indexOf(v.charAt(c++)))<<6|(i=a.indexOf(v.charAt(c++))),l+=r===64?String.fromCharCode(d>>16&255):i===64?String.fromCharCode(d>>16&255,d>>8&255):String.fromCharCode(d>>16&255,d>>8&255,255&d);return l}(o=String(o));var p=u.length;let y=new Uint8Array(new ArrayBuffer(p));for(let v=0;v<p;v++)y[v]=u.charCodeAt(v);return s.Uint8(y)},Uint8:function(y){let u={data:null,pointer:0,movePointer:function(r){return this.pointer+=r,this.pointer},readInt:function(r){if((r=Math.min(r,this.data.byteLength-this.pointer))<1)return-1;let i=0;if(1<r)for(let c=1;c<=r-1;c++)i+=this.data.getUint8(this.pointer)*Math.pow(256,r-c),this.pointer++;return i+=this.data.getUint8(this.pointer),this.pointer++,i},readStr:function(r){let i=new Uint8Array(r),c=!1,n;i.forEach((f,h)=>{i[h]=this.readInt(1)});for(let f=0;f<t.length;f++)if(!c)try{if(n=t[f].decode(i),f==0)for(let h=0;h<n.length;h++){let b=n.charCodeAt(h);if(b>191||b>127&&b<160)throw new RangeError(`Invalid code point: ${b}`)}c=!0,console.debug(`String byte sequence in ${t[f].encoding}`)}catch(h){console.debug(`SMF string ${h}`)}return n||"String byte sequence read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let r=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)r=this.readInt(1);else{let c=[];for(;128<=this.data.getUint8(this.pointer);)c.push(this.readInt(1)-128);var i=this.readInt(1);for(let n=1;n<=c.length;n++)r+=c[c.length-n]*Math.pow(128,n);r+=i}return r}};if(u.data=new DataView(y.buffer,y.byteOffset,y.byteLength),u.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;u.readInt(4);let p={};p.formatType=u.readInt(2),p.tracks=u.readInt(2),p.track=[];var y=u.readInt(1),v=u.readInt(1);128<=y?(p.timeDivision=[],p.timeDivision[0]=y-128,p.timeDivision[1]=v):p.timeDivision=256*y+v;for(let r=1;r<=p.tracks;r++){p.track[r-1]={event:[]};var a,d=u.readInt(4);if(d===-1)break;if(d!==1297379947)return!1;u.readInt(4);let i=0,c=!1,n,f;for(;!c&&(i++,p.track[r-1].event[i-1]={},p.track[r-1].event[i-1].deltaTime=u.readIntVLV(),(n=u.readInt(1))!==-1);)if(128<=n?f=n:(n=f,u.movePointer(-1)),n===255){p.track[r-1].event[i-1].type=255,p.track[r-1].event[i-1].metaType=u.readInt(1);var l=u.readIntVLV();switch(p.track[r-1].event[i-1].metaType){case 47:case-1:c=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:p.track[r-1].event[i-1].data=u.readStr(l);break;case 33:case 89:case 81:p.track[r-1].event[i-1].data=u.readInt(l);break;case 84:p.track[r-1].event[i-1].data=[],p.track[r-1].event[i-1].data[0]=u.readInt(1),p.track[r-1].event[i-1].data[1]=u.readInt(1),p.track[r-1].event[i-1].data[2]=u.readInt(1),p.track[r-1].event[i-1].data[3]=u.readInt(1),p.track[r-1].event[i-1].data[4]=u.readInt(1);break;case 88:p.track[r-1].event[i-1].data=[],p.track[r-1].event[i-1].data[0]=u.readInt(1),p.track[r-1].event[i-1].data[1]=u.readInt(1),p.track[r-1].event[i-1].data[2]=u.readInt(1),p.track[r-1].event[i-1].data[3]=u.readInt(1);break;default:this.customInterpreter!==null&&(p.track[r-1].event[i-1].data=this.customInterpreter(p.track[r-1].event[i-1].metaType,u,l)),this.customInterpreter!==null&&p.track[r-1].event[i-1].data!==!1||(u.readInt(l),p.track[r-1].event[i-1].data=u.readInt(l),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((n=n.toString(16).split(""))[1]||n.unshift("0"),p.track[r-1].event[i-1].type=parseInt(n[0],16),p.track[r-1].event[i-1].channel=parseInt(n[1],16),p.track[r-1].event[i-1].type){case 15:this.customInterpreter!==null&&(p.track[r-1].event[i-1].data=this.customInterpreter(p.track[r-1].event[i-1].type,u,!1)),this.customInterpreter!==null&&p.track[r-1].event[i-1].data!==!1||(a=u.readIntVLV(),p.track[r-1].event[i-1].data=u.readInt(a),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:p.track[r-1].event[i-1].data=[],p.track[r-1].event[i-1].data[0]=u.readInt(1),p.track[r-1].event[i-1].data[1]=u.readInt(1);break;case 12:case 13:p.track[r-1].event[i-1].data=u.readInt(1);break;case-1:c=!0;break;default:if(this.customInterpreter!==null&&(p.track[r-1].event[i-1].data=this.customInterpreter(p.track[r-1].event[i-1].metaType,u,!1)),this.customInterpreter===null||p.track[r-1].event[i-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return p},customInterpreter:null};if(typeof fe<"u")fe.exports=s;else{let o=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;o.MidiParser=s}})()});var ve=function(e,t){let s=Math.min(e.length,t.length),o=e.slice(0,s),u=t.slice(0,s),p=0,y=0;for(;y<s&&p==0;)p=Math.sign(o[y]-u[y]),y++;return p},I=function(e=""){this.name=e,this.pool=[],this.point=function(t,s=!1){if(this.pool.length>0){let o=this.pool.length,u=1<<Math.floor(Math.log2(o)),p=u,y=64;for(;u>=1&&y>=0;){if(y<=0)throw new Error("TTL reached.");if(p==o)p-=u;else{let a=ve(t,this.pool[p]);switch(a){case 0:{y=0;break}case 1:{p+u<=o&&(p+=u);break}case-1:{p!=0&&(p-=u);break}default:console.warn(`Unexpected result ${a}.`)}}u=u>>1,y--}let v=!0;if(p>=this.pool.length)v=!1;else{let a=this;this.pool[p].forEach(function(d,l,r){v&&d!=t[l]&&(v=!1)}),!v&&ve(t,this.pool[p])>0&&p++}return v||s?p:-1}else return s?0:-1},this.add=function(t,s){return t.data=s,this.pool.splice(this.point(t,!0),0,t),this},this.default=function(t){console.warn(`No match in "${this.name||"(unknown)"}" for "${t}". Default action not defined.`)},this.get=function(t){let s=this.point(t);if(s>-1)return this.pool[s].data;this.default(t)},this.run=function(t,...s){let o=this.point(t);o>-1?t.subarray?this.pool[o].data(t.subarray(this.pool[o].length),...s):this.pool[o].data(t.slice(this.pool[o].length),...s):this.default(t,...s)}};var J=class{#t={};addEventListener(e,t){this.#t[e]||(this.#t[e]=[]),this.#t[e].unshift(t)}removeEventListener(e,t){if(this.#t[e]){let s=this.#t[e].indexOf(t);s>-1&&this.#t[e].splice(s,1),this.#t[e].length<1&&delete this.#t[e]}}dispatchEvent(e,t){let s=new Event(e),o=this;s.data=t,this.#t[e]?.length>0&&this.#t[e].forEach(function(u){try{u?.call(o,s)}catch(p){console.error(p)}}),this[`on${e}`]&&this[`on${e}`](s)}};var ct=["MSB","PRG","LSB","NME","ELC","DRM","LVL"],ot={krs:"KR",s90es:"ES",motif:"ES"},lt={krs:"Kr",s90es:"SE",motif:"ME"},ae=function(e){let t=Math.floor(e/10),s=e%10;return`${t.toString(16)}${s}`},re=class{#t;get bankInfo(){return this.#t}strictMode=!1;get(e=0,t=0,s=0,o){let u=[e,t,s],p,y=1,v=0,a,d,l=Array.from(arguments);switch(o){case"xg":{switch(e){case 0:{s==126?l[2]=125:s==127&&(l[2]=0);break}case 16:{s==126&&(l[2]=0);break}case 32:{s>125&&(l[2]=0),l[2]+=4;break}case 33:{(s>125||s==3)&&(l[2]=0),l[2]+=5;break}case 34:case 35:case 36:{s>125&&(l[2]=0),l[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:l[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{s==126&&(l[2]=0);break}case 48:case 64:case 126:case 127:{s==126&&(e==127&&t==0||(l[2]=0));break}}break}case"gs":case"sc":{e==0&&s<5?l[2]=0:e>125&&s<5&&s!=2&&(l[2]=e,l[0]=0);break}case"g2":case"sd":{e>>1==40?l[2]|=16:e>95&&e<100&&(l[2]|=16,t>>4==7&&(l[0]=96));break}case"sg":{e==8&&s==0&&(l[2]=5);break}case"05rw":case"x5d":{e&&e<56&&(l[0]=56);break}case"s90es":{if(e==0)break;s<8?l[2]+=17:s<32?l[2]+=13:l[2]=(l[2]>>3)+19;break}case"motif":{if(e==0)break;s<8?l[2]+=28:s<32?l[2]+=13:l[2]=(l[2]>>3)+19;break}}let r=" ",i="M",c="",n=0,f=0;switch(l[0]){case 0:{switch(l[2]){case 127:{o=="xg"?i="GM-a":(i="MT-a",c="C/M");break}case 126:{o=="xg"?i="GM-n":(i="MT-b",c="C/M");break}case 7:{i="GM-k",c="GLX";break}case 5:{i="SG-a",c="000";break}case 4:{o=="gs"||o=="sc"?(i="GM-a",c="000"):(i="SP-l",c="C/M");break}case 3:case 2:case 1:{(o=="gs"||o=="sc")&&(i="GM-a",c="000");break}case 0:{i="GM-a";break}default:i="y",n=3}break}case 8:{o=="sg"?i="GM-s":i="r:";break}case 32:case 33:case 34:case 35:case 36:{o=="xg"&&(i=`${["AP","VL","PF","DX","AN"][e&7]}-${"abcdefgh"[s]}`,n=3);break}case 48:{c=`M${(l[2]>>3).toString().padStart(2,"0")}`,i=`y${c}`,n=1;break}case 56:{i="GM-b";break}case 57:i=["yDOC","QY10","QY20"][l[2]-112]||"yMxv",c=["DOC","QY1","QY2"][l[2]-112]||"057";case 61:case 120:{i="rDrm";break}case 62:{i="kDrm";break}case 63:{if(l[2]<17){let k=l[2];i=k<10?"kP:":"kC:",i+=k%10}else l[2]<34?i=["Pre1","Pre2","Pre3","Pre4","Usr1","Usr2","DrmP","DrmU","Plg1","Plg2","Plg3","Pre1","Pre2","Pre3","Pre4","Pre5","Pre6"][l[2]-17]:i="Ds";n=1;break}case 64:{i="ySFX",c="SFX";break}case 67:{i="DX:S";break}case 80:case 81:case 82:case 83:{i=`Prg${"UABC"[l[0]-80]}`;break}case 88:case 89:case 90:case 91:{i=`Cmb${"UABC"[l[0]-88]}`;break}case 95:{i=`${["DR","PC"][l[2]]}-d`;break}case 96:{i=l[2]==106?"AP-a":l[2]>>4==1?"SDg":"PF",l[2]>63?f=63:l[2]>>4==1&&(f=16),n=3;break}case 97:{i=l[2]>>4==1?"SDa":"VL:",n=3,l[2]>>4==1?f=16:f=112;break}case 98:{i=l[2]>>4==1?"SDb":"SG-a",n=3,f=16;break}case 99:{i=l[2]>>4==1?"SDc":"DX",l[2]>63?f=63:l[2]>>4==1&&(f=16),n=3;break}case 100:{i="AN",l[2]>63?f=63:l[2]>>4==1&&(f=16),n=3;break}case 104:case 105:case 106:case 107:{i="SDd",f=104;break}case 121:{i=`GM-${l[2]?"":"a"}`,n=3;break}case 122:{i="lDrm";break}case 126:{i="yDrS";break}case 127:{l[2]==127?i="rDrm":i="yDrm";break}default:l[0]<48?i="r:":i="M"}i.length<4&&(i+=`${[e,s,l[0],l[2]][n]-f}`.padStart(4-i.length,"0")),c.length<3&&(c+=`${[e,s,e,s][n]}`.padStart(3-c.length,"0")),o=="xg"&&(e==0?l[2]<100?i=i.replace("y0","y:"):l[2]==125&&(i="y126"):e==16?(p=`Voice${((l[2]<<7)+l[1]+1).toString().padStart(3,"0")}`,r=" "):e==35&&s>>1==2&&(p=`DXCH_${(((l[2]&1)<<7)+t+1).toString().padStart(3,"0")}`,r=" "));let h=[l[0],l[1],l[2]];for(;!(p?.length>=0);)if(p=this.#t[l[1]||0][(l[0]<<8)+l[2]]?.name,p){let k=this.#t[l[1]||0][(l[0]<<8)+l[2]];y=k?.poly||y,v=k?.type||v,a=k?.drum,d=k?.level}else if(this.strictMode)p="",r="?";else if(l[0]==0&&l[1]==0&&l[2]==0)p="Unloaded";else if(this.#t[l[1]||0][l[0]<<8])l[0]==0?(l[2]=0,r="^"):l[2]<1?(l[0]=0,r="*"):(l[2]--,r="^");else if(e==48)l[0]=0,l[2]=0,r="!";else if(e==62)l[1]--,r=" ",l[1]<1&&!p?.length&&(l[0]=0,r="!");else if(e<63)l[0]==0?(l[2]=0,r="^"):l[2]<1?(l[0]=0,r="*"):l[2]--;else if(e==80)p=`PrgU:${t.toString().padStart(3,"0")}`,r="!";else if(e==88)p=`CmbU:${t.toString().padStart(3,"0")}`,r="!";else if(e==121)p=`GM2Vox0${s}`,r="#";else if(e==122)if(l[1]==32?l[1]==0:l[1]%=7,p=this.#t[l[1]||0][(l[0]<<8)+l[2]]?.name,p){r=" ";let k=this.#t[l[1]||0][(l[0]<<8)+l[2]];y=k?.poly||y,v=k?.type||v,a=k?.drum,d=k?.level}else p="",r="*";else l[1]==0?(p=`${e.toString().padStart(3,"0")} ${t.toString().padStart(3,"0")} ${s.toString().padStart(3,"0")}`,r="!"):l[0]==0?(l[2]=0,r="^"):l[2]>0?l[2]--:l[1]>0?(l[1]=0,r="!"):(l[0]=0,r="?");let b=[l[0],l[1],l[2]];switch(r){case"^":{switch(o){case"gs":case"sc":case"ns5r":{r=" ";break}}e==127&&r=="^"&&(r=" ");break}}let E="??";switch(l[0]){case 0:{l[2]==0?E="GM":l[2]==5||l[2]==7?E="KG":l[2]<126?E="XG":l[2]==127&&(E="MT");break}case 32:case 33:case 35:case 36:{l[2]>4?E=["AP","VL","PF","DX","AN"][l[0]-32]:E="GS";break}case 48:{E="MU";break}case 56:{E="AG";break}case 61:case 80:case 83:case 88:case 89:case 91:{E="AI";break}case 62:case 82:case 90:{E="XD";break}case 63:{l[2]<17?E="KR":l[2]<34?E="ES":E="DS";break}case 64:case 126:{E="XG";break}case 67:case 99:{E=l[2]>>4==1?"SD":"DX";break}case 81:{E="RW";break}case 95:{E=["DR","PC"][l[2]];break}case 96:{E=l[2]==106?"AP":l[2]>>4==1?"SD":"PF";break}case 97:{E=l[2]>>4==1?"SD":"VL";break}case 98:{E=l[2]>>4==1?"SD":"SG";break}case 100:{E="AN";break}case 104:case 105:case 106:case 107:{E="SD";break}case 120:{E="GS";break}case 121:{E=l[2]?"G2":"GM";break}case 122:{E="KG";break}case 127:{E=l[2]==127?"MT":t==0?"GM":"XG";break}default:l[0]<48&&(l[0]==16&&o=="xg"?E="XG":E="GS")}if(r!=" ")switch(o){case"krs":case"s90es":case"motif":{p="",E=ot[o];break}default:self.debugMode&&(p="")}return{name:p||`${lt[o]||o.toUpperCase()}${ae(e||0)}${ae(t||0)}${ae(s||0)}`,poly:y,type:v,drum:a,level:d,iid:h,eid:b,sid:u,ending:r,sect:i,bank:c,standard:E,mode:o}}async load(e,t,s="(internal)",o){let u=this,p=[],y=0,v=0,a=0;e.split(`
`).forEach(function(d,l){let r=d.split("	"),i=[];if(l==0){if(r.forEach(function(c,n){p[ct.indexOf(c)]=n}),p.length<4){console.debug("Debugger launched.");debugger}}else{let c=0,n=0,f=0,h,b=1,E=0,k,x;r.forEach(function(P,N){switch(N){case p[0]:{c=parseInt(P);break}case p[1]:{n=parseInt(P);break}case p[2]:{f=parseInt(P);break}case p[3]:{h=P;break}case p[4]:{P=parseInt(P),P<16?b=P+1:(E=(P&15)+1,b=E);break}case p[5]:{x=P;break}case p[6]:{P?.constructor&&(k=parseInt(P));break}}}),u.#t[n]=u.#t[n]||[];let T=u.#t[n],M={msb:c,prg:n,lsb:f,name:h,poly:b,type:E,drum:x,level:k,priority:o},V=!1;o<T[c<<8|f]?.priority&&(V=!0,a++),(!T[c<<8|f]||V||t)&&(T[c<<8|f]=M,y++),v++}}),t||console.debug(`Map "${s}": ${v} total, ${y} loaded (${y-a} + ${a}).`)}clearRange(e){let t=e.prg!=null?e.prg.constructor==Array?e.prg:[e.prg,e.prg]:[0,127],s=e.msb!=null?e.msb.constructor==Array?e.msb:[e.msb,e.msb]:[0,127],o=e.lsb!=null?e.lsb.constructor==Array?e.lsb:[e.lsb,e.lsb]:[0,127];for(let u=s[0];u<=s[1];u++){let p=u<<8;for(let y=o[0];y<=o[1];y++){let v=p+y;for(let a=t[0];a<=t[1];a++)delete this.#t[a][v]}}}init(){this.#t=[];for(let e=0;e<128;e++)this.#t.push([""])}async loadFiles(...e){this.init();let t=this;e.forEach(async function(s,o){try{t.load(await(await fetch(`./data/bank/${s}.tsv`)).text(),!1,s,o)}catch{console.error(`Failed loading "${s}.tsv".`)}})}constructor(...e){this.loadFiles(...e)}};var Ee=class{#t={};context;set(e,t){this.#t[e]=t}has(e){return!!this.#t[e]}async read(e,t){if(!this.has(e))throw new Error(`No decoder registered for "${e}"`);return await this.#t[e].call(this.context||this,t)}};var dt=function(e,t){let s=!0;return t.forEach((o,u)=>{s=s&&e[u]==o}),s},K=function(e){let t=0;return e.forEach(s=>{t*=256,t+=s}),t},H=new TextDecoder,z=new Ee;z.set("s7e",async function(e){let t=new Uint8Array(await e.slice(0,65536).arrayBuffer()),s="MSB	LSB	PRG	NME",o=[0,0,0,0],u=32,p=0,y=0,v=!0,a=[],d=0;for(;v;){let l=t.subarray(p);([()=>{H.decode(l.subarray(0,4))=="YSFC"?(p+=80,y=1):p++},()=>{if(dt(l.subarray(0,4),o))a.forEach((r,i,c)=>{let n=K(t.subarray(r.start+4,r.start+8));r.length=n}),y=2;else{let r=H.decode(l.subarray(0,4)),i=K(l.subarray(4,8));a.push({type:r,start:i}),p+=8}},()=>{let r=a[d],i=t.subarray(r.start,r.start+r.length),c=32;switch(r.type){case"ENVC":{let n=u;for(;n<i.length;){let f=i.subarray(n,n+c),h=H.decode(f.subarray(0,10)).trimEnd();h.slice(0,5)=="Init "&&(h=""),h&&(s+=`
063	${(f[17]+13).toString().padStart(3,"0")}	${f[19].toString().padStart(3,"0")}	${h}`),n+=c}break}case"EDVC":{let n=u;for(;n<i.length;){let f=i.subarray(n,n+c),h=H.decode(f.subarray(0,10)).trimEnd();h.slice(0,5)=="Init "&&(h=""),h&&(s+=`
063	024	${f[19].toString().padStart(3,"0")}	${h}`),n+=c}break}case"EPVC":{let n=32,f=u;for(;f<i.length;){let h=i.subarray(f,f+n),b=H.decode(h.subarray(0,10)).trimEnd();b=="----------"&&(b=""),b&&(s+=`
063	${(h[17]+1).toString().padStart(3,"0")}	${h[19].toString().padStart(3,"0")}	${b}`),f+=n}break}}d++,d>=a.length&&(y=3,v=!1)}][y]||(()=>{v=!1}))()}return s});z.set("pcg",async function(e){let t=new Uint8Array(await e.arrayBuffer()),s="MSB	LSB	PRG	NME",o=100,u=0,p=0,y=!0,v=[],a=0;for(;y;){let d=t.subarray(o);([()=>{y=H.decode(d.subarray(0,4))=="INI2",p=d[15],o+=16,u=1},()=>{let l=H.decode(d.subarray(0,4)),r=d[5],i=d[7],c=d[11],n=K(d.subarray(12,16)),f=K(d.subarray(16,20)),h=K(d.subarray(36,40)),b=H.decode(d.subarray(44,44+c));v.push({type:l,tipMsb:r,tipLsb:i,nameLen:c,length:n,start:f,entryLen:h,name:b}),o+=64,p--,p<1&&(u=2)},()=>{let l=v[a],r=t.subarray(l.start,l.start+l.length);switch(l.type){case"PRG1":break;case"PBK1":{let i=63,c=(l.tipMsb?6:0)+l.tipLsb;for(let n=0;n<128;n++){let f=n*l.entryLen,h=r.subarray(f,f+l.entryLen),b=H.decode(h.subarray(0,24)).trimEnd().replace("InitProg","");b.length&&c>5&&(s+=`
${i.toString().padStart(3,"0")}	${c.toString().padStart(3,"0")}	${n.toString().padStart(3,"0")}	${b}`)}break}case"CBK1":{let i=63,c=(l.tipMsb?3:0)+l.tipLsb+10;for(let n=0;n<128;n++){let f=n*l.entryLen,h=r.subarray(f,f+l.entryLen),b=H.decode(h.subarray(0,24)).trimEnd().replace("InitCombi","");b.length&&c>12&&(s+=`
${i.toString().padStart(3,"0")}	${c.toString().padStart(3,"0")}	${n.toString().padStart(3,"0")}	${b}`)}break}}a++,a>=v.length&&(u=3,y=!1)}][u]||(()=>{y=!1}))()}return s});var q=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]),W=["melodic","drums","drum set 1","drum set 2","drum set 3","drum set 4","drum set 5","drum set 6","drum set 7","drum set 8"],ft=[17.1,18.6,20.2,21.8,23.3,24.9,26.5,28,29.6,31.2,32.8,34.3,35.9,37.5,39,40.6,42.2,43.7,45.3,46.9,48.4,50],F=[20,22,25,28,32,36,40,45,50,56,63,70,80,90,100,110,125,140,160,180,200,225,250,280,315,355,400,450,500,560,630,700,800,900,1e3,1100,1200,1400,1600,1800,2e3,2200,2500,2800,3200,3600,4e3,4500,5e3,5600,6300,7e3,8e3,9e3,1e4,11e3,12e3,14e3,16e3,18e3,2e4],we=[0,.04,.08,.13,.17,.21,.25,.29,.34,.38,.42,.46,.51,.55,.59,.63,.67,.72,.76,.8,.84,.88,.93,.97,1.01,1.05,1.09,1.14,1.18,1.22,1.26,1.3,1.35,1.39,1.43,1.47,1.51,1.56,1.6,1.64,1.68,1.72,1.77,1.81,1.85,1.89,1.94,1.98,2.02,2.06,2.1,2.15,2.19,2.23,2.27,2.31,2.36,2.4,2.44,2.48,2.52,2.57,2.61,2.65,2.69,2.78,2.86,2.94,3.03,3.11,3.2,3.28,3.37,3.45,3.53,3.62,3.7,3.87,4.04,4.21,4,37,4.54,4.71,4.88,5.05,5.22,5.38,5.55,5.72,6.06,6.39,6.73,7.07,7.4,7.74,8.08,8.41,8.75,9.08,9.42,9.76,10.1,10.8,11.4,12.1,12.8,13.5,14.1,14.8,15.5,16.2,16.8,17.5,18.2,19.5,20.9,22.2,23.6,24.9,26.2,27.6,28.9,30.3,31.6,33,34.3,37,39.7],ke=function(e){let t=.1,s=-.3;return e>66?(t=5,s=315):e>56?(t=1,s=47):e>46&&(t=.5,s=18.5),t*e-s},$e=function(e){return e>105?ft[e-106]:e>100?e*1.1-100:e/10},xe=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),ie={};`hi*,
ka,か
ki,き
ku,く
ke,け
ko,こ
ky,き!
kw,くl
tsu,つ
ts,つl
sa,さ
si,すぃ
su,す
se,せ
so,そ
shi,し
sh,し!
ta,た
ti,てぃ
tu,とぅ
te,て
to,と
tchy,ち!
tchi,ち
na,な
ni,に
nu,ぬ
ne,ね
no,の
ny,に!
nn,ん
ha,は
hi,ひ
hu,ほぅ
he,へ
ho,ほ
hy,ひ!
fa,ふぁ
fi,ふぃ
fu,ふ
fe,ふぇ
fo,ふぉ
ma,ま
mi,み
mu,む
me,め
mo,も
my,み!
mm,ㇺ
ra,ら
ri,り
ru,る
re,れ
ro,ろ
ry,り!
wa,わ
wi,うぃ
we,うぇ
wo,を
nga,か゚
ngi,き゚
ngu,く゚
nge,け゚
ngo,こ゚
ngy,き゚!
ng,ン
ga,が
gi,ぎ
gu,ぐ
ge,げ
go,ご
gy,ぎ!
gw,ぐl
za,ざ
zi,ずぃ
zu,ず
ze,ぜ
zo,ぞ
ja,じゃ
ji,じ
ju,じゅ
je,じぇ
jo,じょ
jy,じ!
da,だ
di,でぃ
du,どぅ
de,で
do,ど
dy,で!
ba,ば
bi,び
bu,ぶ
be,べ
bo,ぼ
by,び!
va,ゔぁ
vi,ゔぃ
vu,ゔ
ve,ゔぇ
vo,ゔぉ
pa,ぱ
pi,ぴ
pu,ぷ
pe,ペ
po,ぽ
py,ぴ!
!ya,ゃ
!yu,ゅ
!ye,ぇ
!yo,ょ
ya,や
yu,ゆ
ye,いぇ
yo,よ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
la,ぁ
li,ぃ
lu,ぅ
le,ぇ
lo,ぉ
a,あ
i,い
u,う
e,え
o,お
*,っ
~,
^,
_,`.split(`
`).forEach(e=>{let t=e.split(",");ie[t[0]]=t[1]});var Te=function(e){let t=e;e[0]=="*"&&(t=t.slice(1)),["aa","ii","uu","ee","oo"].forEach(o=>{for(;t.indexOf(o)>-1;)t=t.replace(o,o[0])});for(let o in ie)t=t.replaceAll(o,ie[o]);t.indexOf("ん")==0&&t.length>1&&(t=t.slice(1));let s=t.indexOf("!");return s>-1&&t.length>1&&(t=t.slice(s+1)),t},Ce=function(e){return e?e<96?`cc${e}`:["aftertouch","velocity","pitch bend"][e-96]:"off"};var se=["room 1","room 2","room 3","hall 1","hall 2","plate","delay","panning delay"],Se=["chorus 1","chorus 2","chorus 3","chorus 4","feedback","flanger","short delay","short delay feedback"],Me=["delay 1","delay 2","delay 3","delay 4","pan delay 1","pan delay 2","pan delay 3","pan delay 4","delay to reverb","pan repeat"];var ht={0:"thru",256:"stereo EQ",257:"spectrum",258:"enhancer",259:"humanizer",272:"overdrive",273:"distortion",288:"phaser",289:"auto wah",290:"rotary",291:"stereo flanger",292:"step flanger",293:"tremelo",294:"auto pan",304:"compressor",305:"limiter",320:"hexa chorus",321:"tremelo chorus",322:"stereo chorus",323:"space D",324:"3D chorus",336:"stereo delay",337:"modulated delay",338:"3-tap delay",339:"4-tap delay",340:"tremelo control delay",341:"reverb",342:"gate reverb",343:"3D delay",352:"2-pitch shifter",353:"feedback pitch shifter",368:"3D auto",369:"3D manual",370:"Lo-Fi 1",371:"Lo-Fi 2",512:"overdrive - chorus",513:"overdrive - flanger",514:"overdrive - delay",515:"distortion - chorus",516:"distortion - flanger",517:"distortion - delay",518:"enhancer - chorus",519:"enhancer - flanger",520:"enhancer - delay",521:"chorus - delay",522:"flanger - delay",523:"chorus - flanger",524:"rotary multi",1024:"guitar multi 1",1025:"guitar multi 2",1026:"guitar multi 3",1027:"clean guitar multi 1",1028:"clean guitar multi 2",1029:"bass multi",1030:"rhodes multi",1280:"keyboard multi",4352:"chorus / delay",4353:"flanger / delay",4354:"chorus / flanger",4355:"overdrive / distortion",4356:"overdrive / rotary",4357:"overdrive / phaser",4358:"overdrive / auto wah",4359:"phaser / rotary",4360:"phaser / auto wah"},ut={66307:["drive"],66309:["vowel",e=>"aiueo"[e]],94723:["pre-filter"],94724:["Lo-Fi type"],94725:["post-filter"],94979:["Lo-Fi type"],94980:["fill type",e=>["off","LPF","HPF"][e]],94984:["noise type",e=>["white","pink"][e]],94987:["disc type",e=>["LP","SP","EP","RND"]],94990:["hum type",e=>`${e+5}0Hz`],94993:["M/S",e=>["mono","stereo"][e]]},ne=function(e){return ht[(e[0]-32<<8)+e[1]]||`0x${e[0].toString(16).padStart(2,"0")}${e[1].toString(16).padStart(2,"0")}`},Pe=function(e,t,s){let o=(e[0]-32<<16)+(e[1]<<8)+t,u=ut[o]||{},p=u[0];if(p?.length)return p+=`: ${(u[1]||function(){})(s)||s}`,p},ce=[68,48,95,78,41,3,110,122,0];var A=function(e=64){return Math.round(2e3*Math.log10(e/64))/100},Re=function(e,t,s){let o=[],u=s==!1?t.readIntVLV():s;e==0||e==127;for(let p=0;p<u;p++){let y=t.readInt(1);if(o.push(y),y!=247){if(y!=240){if(y>127)return console.debug(`Early termination: ${o}`),o.pop(),t.backOne(),t.backOne(),new Uint8Array(o)}}}return new Uint8Array(o)},_=function(e){let t=0;return e.forEach(s=>{t+=s,t=t&127}),~t+1&127},B=function(e,t){let s=0,o=0;for(let u=0;u<e.length;u++){let p=u%8-1,y=(o>>p&1)<<7,v=e[u];v+=y,u%8!=0?(t(v,s,e),s++):o=e[u]}};var Y=function(e){let t=Math.floor(e*14.2);return t<128?t:0},C=function(){return!!self.Bun||self.debugMode||!1};var D=["?","gm","gs","sc","xg","g2","mt32","doc","qy10","qy20","ns5r","x5d","05rw","k11","sg","sd","krs","s90es","motif","trin"],pt={gm2:"g2","mt-32":"mt32","c/m":"mt32",ag10:"05rw","ag-10":"05rw","05r/w":"05rw",x5:"05rw",x5dr:"x5d",gmega:"k11","kross 2":"krs","motif es":"motif","s90 es":"s90es",trinity:"trin","tr-rack":"trin"},mt=["melodic","drum","menu"],De={"?":[0,0,120,0,0],gm:[0,0,127,0,0],gs:[0,0,120,0,0],sc:[0,0,120,0,0],xg:[0,0,127,0,0],g2:[0,0,120,0,0],mt32:[0,127,127,0,127],doc:[57,112,127,57,112],qy10:[57,113,127,57,113],qy20:[57,114,127,57,114],ns5r:[0,0,61,0,0],x5d:[82,0,62,56,0],"05rw":[81,0,62,56,0],k11:[0,0,122,0,0],sg:[0,0,122,0,0],sd:[97,0,105,0,0],krs:[121,0,120,0,0],s90es:[0,0,127,0,0],motif:[0,0,127,0,0],trin:[0,0,127,0,0]},Ae=[9,25,41,57,73,89,105,121],gt=[0,3,81,84,88],Le={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},Oe={0:0,1:1,2:3,5:4},Ie={0:0,1:1,2:2,5:3},Be=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],le=[36,37,48,49,52,53],j=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65],Ue={26:127,29:0,30:0,31:0,52:12,53:54},Q=[0,1,2,4,5,6,7,8,10,11,32,38,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,84,91,92,93,94,95,98,99,100,101,128,12,13,16,17,18,19,14,15,20,21,26,28,22,80,81,82,83,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],bt=[2,12,13,14,15,16,17,18,19,20,21,80,81,83,136,130,131,132,133,134,135,137,138,139,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],yt=[33,102,99,32,100,8,9,10],Ve=[0,16,25,32,40,64,24,48],w={};D.forEach((e,t)=>{w[e]=t});var g={length:Q.length};Q.forEach((e,t)=>{g[e]=t});var L={length:j.length};j.forEach((e,t)=>{L[e]=t});var vt={};mt.forEach((e,t)=>{vt[e]=t});var Et=function(e){let t=[],s=0;return e?.forEach(function(o,u){o==247?t.push(e.subarray(s,u)):o==240&&(s=u+1)}),t.length||t.push(e.subarray(0)),C()&&console.debug(t),t};var oe=8,m={port:oe,ch:oe<<4,chShift:Math.ceil(Math.log2(oe))+4,cc:Q.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,rpnt:4,nrpn:le.length,ace:8,drm:8,dpn:j.length,dnc:128,ext:3,efx:7,cvn:12,redir:32,vxPrim:3,invalidCh:255},U={bank0:128},de=new Uint16Array(m.ch),wt=new Uint16Array(m.ch),kt=new Uint16Array(m.ch),$t=new Uint16Array(m.ch),xt=new Uint16Array(m.ch),Ne=new Array(m.drm);for(let e=0;e<m.ch;e++)de[e]=e*m.cc,wt[e]=e*m.rpn,kt[e]=e*m.nrpn,$t[e]=e*m.ace,xt[e]=e*m.ext;for(let e=0;e<m.drm;e++){Ne[e]=new Uint16Array(m.dpn);let t=e*m.dpn*m.dnc;for(let s=0;s<m.dpn;s++)Ne[e][s]=t+s*m.dnc}var He=class extends J{NOTE_IDLE=0;NOTE_ATTACK=1;NOTE_DECAY=2;NOTE_SUSTAIN=3;NOTE_HELD=4;NOTE_RELEASE=5;NOTE_SOSTENUTO_ATTACK=8;NOTE_SOSTENUTO_DECAY=9;NOTE_SOSTENUTO_SUSTAIN=10;NOTE_SOSTENUTO_HELD=11;CH_MELODIC=0;CH_DRUMS=1;CH_DRUM1=2;CH_DRUM2=3;CH_DRUM3=4;CH_DRUM4=5;CH_DRUM5=6;CH_DRUM6=7;CH_DRUM7=8;CH_DRUM8=9;DUMP_ALL=0;DUMP_ONCE=1;DUMP_MODE=2;EXT_NONE=0;EXT_VL=1;EXT_DX=3;VLBC_BRTHEXPR=1;VLBC_VELOINIT=2;VLBC_VELOALL=3;CH_INACTIVE=0;CH_ACTIVE=1;CH_DISABLED=2;#t=0;#f=0;#k=0;#C=new Array(11);get#$(){return this.#C[this.#f]}set#$(e){this.#C[this.#f]=e}#h=new Uint8Array(m.ch);#g=new Uint8Array(m.ch);#s=new Uint8Array(m.ch);#e=new Uint8Array(m.ch*m.cc);#b=new Uint8Array(m.ch*m.ace);#i=new Uint8Array(m.ch*m.vxPrim);#y=new Uint8Array(m.ch*m.nn);#v=new Uint8Array(m.ch);#o=new Uint16Array(m.pl);#E=new Uint8Array(m.pl);#x=new Int16Array(m.ch);#A=new Uint8Array(m.ch);#F=new Uint8Array(m.ch);#S=new Uint8Array(m.ch*m.ext);#n=new Uint8Array(m.ch*m.rpn);#c=new Uint8Array(m.ch*m.rpnt);#K=new Int8Array(m.ch*le.length);#R=new Uint8Array(m.drm*m.dpn*m.dnc);#I=new Uint8Array(m.drm*2);#M=new Uint8Array(m.efx*3);#z=new Uint8Array(m.ch);#X=new Uint8Array(m.ch*m.redir);#T=new Uint8Array(m.port);#B=new Uint8Array(m.ch);#d=new Uint8Array(m.ch);#q=new Uint8Array(m.ch*m.cvn);#D=new Uint8Array(128);#w=new Uint8Array(m.cmt*8);#Z=new Uint8Array(1024);#a=new Uint8Array(m.cmt*64);#u={};modelEx={sc:{showBar:!0,invBar:!1,invDisp:!1,peakHold:1}};#r;#l;#L;#p=100;#U=0;#J=500;#j=0;#_="";#W=0;#Y=0;#te=0;#V=!0;#m=!1;#ae=1;#fe;#ie=new Array(m.ch);#N=[];#ee=new Uint8Array(m.ch);#re=new Uint8Array(m.tr);baseBank=new re("gm2","ns5r","xg","gs","sd","gmega","plg-vl","plg-pf","plg-dx","plg-an","plg-dr","plg-sg","kross","s90es");userBank=new re("gm");initOnReset=!1;aiEfxName="";chRedir(e,t,s){let o=this;if(o.#re[t])return(o.#re[t]-1)*16+e;if(o.#t==w.sc){if(s==1)return e;let u=0,p=!0;for(;p;)o.#ee[e+u]==0?(o.#ee[e+u]=t,console.debug(`Assign track ${t} to channel ${e+u+1}.`),p=!1):this.#ee[e+u]==t?p=!1:(u+=16,u>=128&&(u=0,p=!1));return e+u}else return e}getTrackPort(e){return this.chRedir(0,e,!0)>>4}forceVoiceRefresh(){for(let e=0;e<m.ch;e++)this.#h[e]&&this.dispatchEvent("voice",{part:e})}#O=[];#se;#P={nOff:(e,t)=>{let s=e*128+t,o=this.#o.lastIndexOf(s);if(o>-1)if(this.#e[m.cc*e+g[64]]>63)this.#E[o]=this.NOTE_HELD,this.dispatchEvent("note",{part:e,note:t,velo:this.#y[s],state:this.NOTE_HELD});else if(this.#e[m.cc*e+g[66]]>63&&this.#E[o]==this.NOTE_SOSTENUTO_SUSTAIN)this.#E[o]=this.NOTE_SOSTENUTO_HELD,this.dispatchEvent("note",{part:e,note:t,velo:this.#y[s],state:this.NOTE_SOSTENUTO_HELD});else{this.#o[o]=0,this.#y[s]=0,this.#E[o]=this.NOTE_IDLE;let u=this.getExt(e)[1];(u==this.VLBC_VELOINIT||u==this.VLBC_VELOALL)&&(this.#e[m.cc*e+g[129]]=0),this.dispatchEvent("note",{part:e,note:t,velo:0,state:this.NOTE_IDLE})}},nOn:(e,t,s)=>{let o=e*128+t,u=0;for(this.#v[e]&&this.#P.ano(e);this.#E[u]>0&&this.#o[u]!=o;)u++;if(u<m.pl){this.#o[u]=o,this.#y[o]=s,this.#E[u]=this.NOTE_SUSTAIN,this.#A[e]<s&&(this.#A[e]=s);let p=this.getExt(e)[1];(p==this.VLBC_VELOINIT||p==this.VLBC_VELOALL)&&(this.#e[m.cc*e+g[129]]=s),this.dispatchEvent("note",{part:e,note:t,velo:s,state:this.NOTE_SUSTAIN})}else console.error("Polyphony exceeded.")},nAt:(e,t,s)=>{},cAt:(e,t)=>{},hoOf:e=>{this.#E.forEach((t,s)=>{if(t==this.NOTE_HELD){let o=this.#o[s],u=o>>7;e==u&&(this.#E[s]=this.NOTE_IDLE,this.#o[s]=0,this.#y[o]=0,this.dispatchEvent("note",{part:e,note:o&127,velo:0,state:this.NOTE_IDLE}))}})},soOn:e=>{this.#E.forEach((t,s)=>{let o;switch(t){case this.NOTE_ATTACK:{o=this.NOTE_SOSTENUTO_ATTACK;break}case this.NOTE_DECAY:{o=this.NOTE_SOSTENUTO_DECAY;break}case this.NOTE_SUSTAIN:{o=this.NOTE_SOSTENUTO_SUSTAIN;break}}if(o){this.#E[s]=o;let u=this.#o[s];this.dispatchEvent("note",{part:e,note:u&127,velo:this.#y[u],state:o})}})},soOf:e=>{this.#E.forEach((t,s)=>{if(t==this.NOTE_SOSTENUTO_HELD){let o=this.#o[s],u=o>>7;e==u&&(this.#E[s]=this.NOTE_IDLE,this.#o[s]=0,this.#y[o]=0,this.dispatchEvent("note",{part:e,note:o&127,velo:0,state:this.NOTE_IDLE}))}})},ano:e=>{this.#o.forEach((t,s,o)=>{let u=t>>7,p=t&127;t==0&&this.#y[0]==0||u==e&&this.#P.nOff(u,p)})}};#he={8:function(e){let t=e.channel,s=e.data[0];this.#P.nOff(t,s)},9:function(e){let t=e.channel,s=this;if(s.getChModeId(t)==w.xg&&s.#s[t]>1){let p=s.getChDrumFirstWrite(t);p[0]&&p[1]!=m.invalidCh&&!s.#h[t]&&(s.copyChSetup(p[1],t),s.dispatchEvent("voice",{part:t}),console.debug(`Part CH${t+1} copied from CH${p[1]}.`))}s.setChActive(t,1);let o=e.data[0],u=e.data[1];u>0?s.#P.nOn(t,o,u):s.#P.nOff(t,o)},10:function(e){let t=e.channel,s=t*128+e.data[0];this.#o.indexOf(s)>-1&&(this.#y[s]=data[1],this.getExt(t)[1]==this.VLBC_VELOALL&&(this.#e[m.cc*t+g[129]]=data[1]),this.dispatchEvent("note",{part:t,note:e.data[0],velo:e.data[1],state:this.NOTE_SUSTAIN}))},11:function(e){let t=e.channel,s=this,o=this.#ie[t],u=o[e.data[0]];u&&(e.data[0]=u),[0,32].indexOf(e.data[0])>-1&&(()=>{switch(this.#t){case w.s90es:case w.motif:{if(e.data[0]==0){[0,63].indexOf(e.data[1])>-1&&this.setChActive(t,1);break}e.data[1]&&this.setChActive(t,1);break}default:{this.setChActive(t,1);break}}})();let p=t*m.cc,y=t*m.ext,v=this.getChModeId(t);switch(e.data[0]){case 96:return;case 97:return;case 120:return;case 121:{this.#P.ano(t),this.#x[t]=0,this.#e[p+g[1]]=0,this.#e[p+g[5]]=0,this.#e[p+g[64]]=0,this.#e[p+g[65]]=0,this.#e[p+g[66]]=0,this.#e[p+g[67]]=0,this.#e[p+g[11]]=127,this.#e[p+g[101]]=127,this.#e[p+g[100]]=127,this.#e[p+g[99]]=127,this.#e[p+g[98]]=127;return}case 123:{this.#P.ano(t);return}case 124:{this.#P.ano(t);return}case 125:{this.#P.ano(t);return}case 126:{this.#v[t]=1,this.#P.ano(t);return}case 127:{this.#v[t]=0,this.#P.ano(t);return}}if(g[e.data[0]]==null)console.warn(`cc${e.data[0]} is not accepted.`);else{switch(bt.indexOf(e.data[0])>-1&&this.allocateAce(t,e.data[0]),e.data[0]){case 0:{switch(C()&&console.debug(`${D[this.#t]}, CH${t+1}: ${e.data[1]}`),this.#t==0?e.data[1]<48?(this.#s[t]>0&&(e.data[1]=this.#e[p],e.data[1]=120,console.debug(`Forced channel ${t+1} to stay drums.`)),e.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${e.data[1]}`),this.switchMode("gs"))):e.data[1]==56?this.switchMode(this.#r.x5==82?"x5d":"05rw"):e.data[1]==62?this.switchMode(this.#r.x5==82?"x5d":"05rw"):e.data[1]==63?this.switchMode(D[this.#r.ds]):(e.data[1]==64||e.data[1]==127)&&this.switchMode("xg"):this.#t==w.gs||this.#t==w.sc?e.data[1]<56&&this.#s[t]>0&&(e.data[1]=this.#e[p],e.data[1]=120,console.debug(`Forced channel ${t+1} to stay drums.`)):this.#t==w.gm&&(e.data[1]<48?this.#s[t]>0&&(e.data[1]=120,this.switchMode("gs",!0),console.debug(`Forced channel ${t+1} to stay drums.`)):(e.data[1]==64||e.data[1]==127)&&this.switchMode("xg",!0)),this.#t){case w.xg:{[79,95,126,127].indexOf(e.data[1])>-1?this.#s[t]==0&&(this.setChType(t,this.CH_DRUM2),console.debug(`CH${t+1} set to drums by MSB.`)):this.#s[t]>0&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`)),[33,81,97].indexOf(e.data[1])>-1?this.#S[y]=this.EXT_VL:[35,67,83,99].indexOf(e.data[1])>-1?this.#S[y]=this.EXT_DX:this.#S[y]=this.EXT_NONE;break}case w["05rw"]:case w.x5d:case w.ns5r:{[61,62,126,127].indexOf(e.data[1])>-1?this.#s[t]==this.CH_MELODIC&&(this.setChType(t,this.CH_DRUM2),console.debug(`CH${t+1} set to drums by MSB.`)):[80,81,82,83].indexOf(e.data[1])>-1||this.#s[t]!=this.CH_MELODIC&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`));break}case w.sd:{[104,105,106,107].indexOf(e.data[1])>-1?this.#s[t]==0&&(this.setChType(t,this.CH_DRUM2),console.debug(`CH${t+1} set to drums by MSB.`)):this.#s[t]>0&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`));break}case w.g2:{e.data[1]==120?this.#s[t]==0&&(this.setChType(t,this.CH_DRUMS),console.debug(`CH${t+1} set to drums by MSB.`)):this.#s[t]>0&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`));break}}break}case 2:{this.getExt(t)[1]==this.VLBC_BRTHEXPR&&(this.#e[p+g[129]]=e.data[1]);break}case 6:{if(this.#F[t]){[w.xg,w.gs,w.sc,w.ns5r].indexOf(this.#t)<0&&console.warn(`NRPN commits are not available under "${D[this.#t]}" mode, even when they are supported in Octavia.`);let a=this.#e[p+g[99]],d=this.#e[p+g[98]];if(a==1){let l=yt.indexOf(d);if(l>-1)this.#e[p+g[71+l]]=e.data[1],C()&&console.debug(`Redirected NRPN 1 ${d} to cc${71+l}.`),this.dispatchEvent("cc",{part:t,cc:71+l,data:e.data[1]});else{let r=le.indexOf(d);r>-1?this.#K[t*10+r]=e.data[1]-64:console.warn(`NRPN 0x01${d.toString(16).padStart(2,"0")} is not supported.`),C()&&console.debug(`CH${t+1} voice NRPN ${d} commit`)}}else{if(j.indexOf(a)<0){let r=`NRPN 0x${a.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")} `;a==127?console.warn(`${r}is not necessary. Consider removing it.`):console.warn(`${r}is not supported.`)}else{let r=this.#s[t]-2;r<0?console.warn(`CH${t+1} cannot accept drum NRPN as type ${W[this.#s[t]]}.`):this.#R[(r*m.dpn+L[a])*m.dnc+d]=e.data[1]}C()&&console.debug(`CH${t+1} (${W[this.#s[t]]}) drum NRPN ${a} commit`)}}else{let a=Oe[this.#e[p+g[100]]],d=Ie[this.#e[p+g[100]]];if(this.#e[p+g[101]]==0&&a!=null)switch(C()&&console.debug(`CH${t+1} RPN 0 ${this.#e[p+g[100]]} commit: ${e.data[1]}`),e.data[1]=Math.min(Math.max(e.data[1],Be[a][0]),Be[a][1]),this.#n[t*m.rpn+a]=e.data[1],this.#c[t*m.rpnt+d]=1,v){case w.xg:case w.gs:case w.sc:case w.mt32:case w.s90es:case w.motif:{switch(this.#e[p+g[100]]){case 1:case 2:{this.dispatchEvent("pitch",{part:t,pitch:this.getPitchShift(t)});break}}break}default:this.dispatchEvent("pitch",{part:t,pitch:this.getPitchShift(t)})}}break}case 32:{switch(C()&&console.debug(`${D[this.#t]}, CH${t+1} LSB: ${e.data[1]}`),this.#t){case w.s90es:case w.motif:{this.setChType(t,[32,40].indexOf(e.data[1])>-1?this.CH_DRUMS:this.CH_MELODIC,this.#t,!0);break}}this.getExt(t)[0]==this.EXT_DX;break}case 38:{if(!this.#F[t]){let a=Oe[this.#e[p+100]],d=Ie[this.#e[p+100]];this.#e[p+101]==0&&a!=null&&(this.#n[t*m.rpn+a+1]=e.data[1],this.#c[t*m.rpnt+d]=1)}break}case 64:{e.data[1]<64&&this.#P.hoOf(t);break}case 66:{e.data[1]>>6?this.#P.soOn(t):this.#P.soOf(t);break}case 98:case 99:{this.#F[t]=1;break}case 100:case 101:{this.#F[t]=0;break}}this.#e[p+g[e.data[0]]]=e.data[1],this.dispatchEvent("cc",{part:t,cc:e.data[0],data:e.data[1]})}s.getChModeId(t)==w.xg&&s.#s[t]&&s.setDrumFirstWrite(t)},12:function(e){let t=e.channel,s=this;switch(s.#t){case w.s90es:case w.motif:{e.data&&s.setChActive(t,1);break}default:s.setChActive(t,1)}if(s.getExt(t)[0]==s.EXT_DX){let o=m.cc*t}s.#i[t]=e.data,s.#d[t]=0,s.pushChPrimitives(t),C()&&console.debug(`T:${e.track} C:${t} P:${e.data}`),s.dispatchEvent("voice",{part:t}),s.getChModeId(t)==w.xg&&s.#s[t]&&s.setDrumFirstWrite(t)},13:function(e){let t=this,s=e.channel;this.#o.forEach(function(o){let u=o>>7;s==u&&(t.#y[o]=e.data,t.dispatchEvent("note",{part:s,note:o&127,velo:e.data,state:t.NOTE_SUSTAIN}))})},14:function(e){let t=e.channel;this.#x[t]=e.data[1]*128+e.data[0]-8192,this.dispatchEvent("pitch",{part:t,pitch:this.getPitchShift(t)})},15:function(e){Et(e.data).forEach(t=>{let s=t[0],o=t[1];(this.#ue[s]||function(){console.debug(`Unknown manufacturer ${s}.`)})(o,t.subarray(2),e.track)})},248:function(e){},250:function(e){},251:function(e){},252:function(e){},254:function(e){},255:function(e){(this.#O[e.meta]||function(s,o,u){}).call(this,e.data,e.track,e.meta),e.meta!=32&&(this.#U=0);let t=gt.indexOf(e.meta)>-1;if(C()&&console.debug(e),t)return e.reply="meta",e}};#ue={64:(e,t,s)=>{this.#oe.run(t,s,e)},65:(e,t,s)=>{if(t[0]<16)if(t[1]==72){let o=t[t.length-1],u=_(t.subarray(3,t.length-1));o==u?this.#G.run(t.subarray(0,t.length-1),s,e):console.warn(`Bad SD checksum ${o} - should be ${u}.`)}else this.#G.run(t,s,e);else{let o=t[t.length-1],u=_(t.subarray(2,t.length-1));o==u?this.#G.run(t.subarray(0,t.length-1),s,e):console.warn(`Bad GS checksum ${o} - should be ${u}.`)}},66:(e,t,s)=>{this.#Q.run(t,s,e)},67:(e,t,s)=>{this.#H.run(t,s,e)},68:(e,t,s)=>{this.#de.run(t,s,e)},71:(e,t,s)=>{this.#le.run(t,s,e)},126:(e,t,s)=>{this.#ne.run(t,s,e)},127:(e,t,s)=>{this.switchMode("gm"),this.#ce.run(t,s,e)}};#ne;#ce;#H;#G;#Q;#oe;#le;#de;buildRchTree(){let e=[];this.#g.forEach((t,s)=>{t<m.ch&&(e[t]?.constructor||(e[t]=[]),e[t].push(s))}),this.#fe=e}buildRccMap(){let e=this;for(let t=0;t<m.ch;t++)e.#ie[t]={};e.#X.forEach((t,s)=>{t&&(e.#ie[Math.floor(s/m.redir)][t]=s%m.redir|128)}),C()&&console.debug(e.#ie)}getActive(){return this.#h}getCc(e){let t=this,s=e*m.cc;return t.#e.subarray(s,s+m.cc)}getCcCh(e,t){let s=this;if(Q.indexOf(t)<0)throw new Error("CC number not accepted");return s.#e[m.cc*e+g[t]]}getCcAll(){return this.#e.slice()}getChSource(){return this.#g}getChType(){return this.#s}setChType(e,t,s=0,o=!1){t&=15;let u=this;s=s||u.getChModeId(e),u.#s[e]=t,t>0&&!o&&(u.#e[e*m.cc+g[0]]=u.#u[s][2],u.pushChPrimitives(e))}setChActive(e,t=0){this.#h[e]!=t&&this.dispatchEvent("channeltoggle",{part:e,active:t}),this.#h[e]=t}getExt(e){let t=m.ext*e,s=this.#S.subarray(t,t+m.ext),o=new Uint8Array(s.length);return o.set(s),o[1]=o[1]||this.#ae,o}getPitch(){return this.#x}getProgram(){return this.#i}getTexts(){return this.#N.slice()}getVel(e){let t=new Map,s=this;return s.#o.forEach(function(o,u){let p=o>>7,y=o&127;e==p&&s.#y[o]>0&&t.set(y,{v:s.#y[o],s:s.#E[u]})}),t}getBitmap(){return{bitmap:this.#$,expire:this.#k}}getLetter(){return{text:this.#_,set:this.#Y,expire:this.#W}}getMode(){return D[this.#t]}getMaster(){return{volume:this.#p}}getRawStrength(){let e=this;return this.#o.forEach(function(t){let s=t>>7;e.#y[t]>e.#A[s]&&(e.#A[s]=e.#y[t])}),this.#A}getStrength(){let e=[],t=this;return this.getRawStrength().forEach(function(s,o){e[o]=Math.floor(s*t.#e[o*m.cc+g[7]]*t.#e[o*m.cc+g[11]]*t.#p/803288)}),e}getRpn(){return this.#n}getNrpn(){return this.#K}getSubDb(){return self?.structuredClone(this.#u)}getVoice(e,t,s,o="?"){let u=this;w[o]?.constructor||(o="?");let p=w[o],y=e||u.#u[p][0],v=t,a=s||u.#u[p][1];y==U.bank0&&(y=0),a==U.bank0&&(a=0),o=="ns5r"&&y>0&&y<56&&(a=3);let d=u.userBank.get(y,v,a,o);if(o=="mt32"&&d.name.indexOf("MT-m:")==0){let l=parseInt(d.name.slice(5)),r=l*m.cmt,i="";u.#a.subarray(r,r+10).forEach(n=>{n>31&&(i+=String.fromCharCode(n))});let c=`MSB	LSB	PRG	NME
0	127	${v}	${i}`;u.userBank.load(c,!0),d.name=i,d.ending=" "}return(d.ending!=" "||!d.name.length)&&(d=u.baseBank.get(y,v,a,o)),d}getChPrimitive(e,t,s){if(t>=m.vxPrim||t?.constructor!=Number)throw new RangeError(`Invalid voice primitive component "${t}"`);if(e>=m.ch)throw new RangeError(`Invalid part "CH${e+1}"`);let o=this,u=o.#i[t<<m.chShift|e];switch(t){case 1:case 2:{s&&(u=u||o.#u[o.getChModeId(e)][t-1]),u==U.bank0&&(u=0);break}}return u}getChPrimitives(e,t){let s=this,o=new Uint8Array(3);return o[1]=s.#i[e],o[0]=s.getChPrimitive(e,1,t),o[2]=s.getChPrimitive(e,2,t),o}pushChPrimitives(e){let t=this;t.#i[1<<m.chShift|e]=t.#e[de[e]+g[0]],t.#i[2<<m.chShift|e]=t.#e[de[e]+g[32]]}getChVoice(e){let t=this,s=t.getVoice(...t.getChPrimitives(e),t.getChMode(e));if(t.#d[e]){let o="";switch(t.#t){case w.mt32:{t.#w.subarray(m.cmt*(e-1),m.cmt*(e-1)+10).forEach(u=>{o+=String.fromCharCode(Math.max(u,32))}),o=o.trimRight();break}default:{let u=m.cvn*e;t.#q.subarray(u,u+m.cvn).forEach(p=>{o+=String.fromCharCode(Math.max(p,32))}),o=o.trimRight()}}o.length&&(s.ending="~",s.name=o)}return s}getRawPitch(){return this.#x}getPitchShift(e){let t=this,s=e*m.rpn,o=t.#n[s];return t.#c[e*m.rpnt]||t.#t==w.mt32&&(o=12),t.#x[e]/8192*o+(t.#n[s+3]-64)+((t.#n[s+1]<<7)+t.#n[s+2]-8192)/8192}getEffectType(e=0){let t=3*e+1;return this.#M.subarray(t,t+2)}setEffectTypeRaw(e=0,t,s){let o=3*e;this.#M[o]=1,this.#M[o+1+ +t]=s}setEffectType(e=0,t,s){this.setEffectTypeRaw(e,!1,t),this.setEffectTypeRaw(e,!0,s)}getEffectSink(){return this.#z}setLetterDisplay(e,t,s=0,o=3200){let u=this,p;u.#_=" ".repeat(s),e.forEach(y=>{u.#_+=String.fromCharCode(y>31?y:32),y<32&&(p=p||new Set,p.add(y))}),u.#Y=Date.now(),u.#W=Date.now()+o,p&&(p=Array.from(p),p.forEach((y,v,a)=>{a[v]=y.toString(16).padStart(2,"0")}),console.warn(`${t}${t?" ":""}invalid code point${p.length>1?"s":""}: 0x${p.join(", 0x")}`))}setDetectionTargets(e="?",t=0){let s=this,o=-1;switch(e.replaceAll(", ",",").split(",").forEach(u=>{u=u.toLowerCase();let p=D.indexOf(pt[u]||u);C()&&console.debug(`Mapped mode "${u}" to ID "${p}".`),p>-1&&(o=p)}),C()&&console.debug(`Set detection target to ID "${o}".`),o>0&&(s.#r.x5=82,s.#r.ds=w.krs),o){case w["05rw"]:{s.#r.x5=81;break}case w.s90es:s.#r.ds=w.s90es,s.#r.smotif=w.s90es;case w.motif:s.#r.ds=w.motif,s.#r.smotif=w.motif}}setGsTargets(e=!1,t=4){if(!t)t=e?3:4;else{if(t>4||t<0)throw new Error(`Invalid GS level ${t}`);if(e&&t>>1!=1)throw new Error(`Invalid SC level ${t}`)}let s=this;s.#r[e?"sc":"gs"]=t,s.#u[w[e?"sc":"gs"]][1]=t,s.forceVoiceRefresh()}getConfigs(){return this.#L}setDumpLimit(e){if(e>2||e<0)throw new RangeError("Invalid dump limit.");this.#l.dumpLimit=e}allocateAce(e=0,t){let s=this;if(!t||t<128&&t>95){console.warn(`cc${t} cannot be allocated as an active custom effect.`);return}let o=!0,u=0,p=m.ace*e;for(;o&&u<m.ace;)s.#b[u+p]==t?o=!1:s.#b[u+p]||(o=!1,s.#b[u+p]=t,console.info(`Allocated cc${t} to ACE slot ${u} in CH${e+1}.`)),u++;u>=m.ace&&console.warn(`ACE slots are full in CH${e+1}.`)}allocateAceAll(e){let t=this;if(!e||e<128&&e>95){console.warn(`cc${e} cannot be allocated as an active custom effect.`);return}for(let s=0;s<m.ch;s++){let o=!0,u=0,p=m.ace*s;for(;o&&u<m.ace;)t.#b[u+p]==e?o=!1:t.#b[u+p]||(o=!1,t.#b[u+p]=e),u++;u>=m.ace&&console.warn(`ACE slots are full in CH${s+1}.`)}}releaseAce(e=0,t){let s=!0,o=m.ace*e,u=o+m.ace;for(;s&&o<u;)this.#b[o]==t&&(this.#b[o]=0,s=!1),o++;s&&C()&&console.debug(`No ACE slot was allocated to cc${t} in CH${e+1}.`)}resetAce(){this.#b.fill(0),console.info("All ACE slots have been reset.")}getAce(){return this.#b}getChAce(e=0,t=0){if(t<0||t>=m.ace)throw new RangeError("No such ACE slot");let s=this.#b[m.ace*e+t];if(s){if(Q.indexOf(s)>=0)return this.#e[e*m.cc+g[s]];throw new Error(`Invalid ACE source in CH${e+1}: ${s}`)}else return 0}initDrums(){let e=this;e.#R.fill(64);for(let t=0;t<m.drm;t++){let s=t*m.dpn;for(let o in Ue){let u=Ue[o],p=(s+L[o])*m.dnc;e.#R.subarray(p,p+m.dnc).fill(u)}}}init(e=0){let t=this;t.#U=0,t.#u[w.xg][1]=0,t.dispatchEvent("banklevel",{mode:"xg",data:0}),t.#h.fill(0),t.#e.fill(0),t.#b.fill(0),t.#i.fill(0),t.#y.fill(0),t.#o.fill(0),t.#v.fill(0),t.#A.fill(0),t.#x.fill(0),t.#K.fill(0),t.#c.fill(0),t.#S.fill(0),t.#T.fill(0),t.#B.fill(0),t.#X.fill(0),t.#p=100,t.#N=[],t.#J=500,t.#j=0,t.#k=0,t.#f=0,t.#$.fill(0),t.#m=!1,t.#te=0,t.#V=!0,t.initDrums(),t.#g.forEach(function(s,o,u){u[o]=o}),e==0&&(t.dispatchEvent("mode","?"),t.#t=0,t.#ee.fill(0),t.#re.fill(0),t.#W=0,t.#_=""),Ae.forEach(s=>{t.#e[m.cc*s]=t.#u[t.getChModeId(s)][2]}),t.#s.fill(t.CH_MELODIC),t.#s[9]=t.CH_DRUM1,t.#s[25]=t.CH_DRUM3,t.#s[41]=t.CH_DRUMS,t.#s[57]=t.CH_DRUMS,t.#s[73]=t.CH_DRUM5,t.#s[89]=t.CH_DRUM7,t.#s[105]=t.CH_DRUMS,t.#s[121]=t.CH_DRUMS;for(let s=0;s<m.drm;s++)t.#I[s<<1]=0,t.#I[s<<1|1]=m.invalidCh;t.#Z.fill(0),t.#a.fill(0),t.#D.fill(0),t.#w.fill(0),t.#d.fill(0),t.#M.fill(0),t.#z.fill(0),t.aiEfxName="",t.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),t.modelEx.sc.showBar=!0,t.modelEx.sc.invBar=!1,t.modelEx.sc.invDisp=!1,t.modelEx.sc.peakHold=1;for(let s=0;s<m.ch;s++){let o=s*m.cc;t.#e[o+g[7]]=100,t.#e[o+g[11]]=127,t.#e[o+g[2]]=127,t.#e[o+g[10]]=64,t.#e.subarray(o+g[71],o+g[71]+8).fill(64),t.#e[o+g[128]]=127,t.#e.subarray(o+g[130],o+g[157]+1).fill(64),t.#e[o+g[91]]=40,t.#e[o+g[101]]=127,t.#e[o+g[100]]=127,t.#e[o+g[99]]=127,t.#e[o+g[98]]=127;let u=s*m.rpn;t.#n[u]=2,t.#n[u+1]=64,t.#n[u+2]=0,t.#n[u+3]=64,t.#n[u+4]=0,t.#n[u+5]=0;let p=s*m.ext;t.#S[p+1]=t.VLBC_BRTHEXPR;let y=s*m.redir;t.#X[y+8]=13}t.buildRchTree(),t.buildRccMap(),t.dispatchEvent("mastervolume",t.#p),t.dispatchEvent("efxreverb",t.getEffectType(0)),t.dispatchEvent("efxchorus",t.getEffectType(1)),t.dispatchEvent("efxdelay",t.getEffectType(2)),t.dispatchEvent("efxinsert0",t.getEffectType(3)),t.dispatchEvent("efxinsert1",t.getEffectType(4)),t.dispatchEvent("efxinsert2",t.getEffectType(5)),t.dispatchEvent("efxinsert3",t.getEffectType(6)),t.dispatchEvent("reset"),t.switchMode("?")}setChMode(e,t){let s=this;if(e<0||e>=m.ch)throw new RangeError(`Invalid CH${e+1}`);if(port<0||t>=D.length)throw new RangeError(`Invalid mode ID ${t}`);s.#B[e]=t,s.dispatchEvent("voice",{part:e})}getChMode(e,t){return D[this.getChModeId(e,t)]}getChModeId(e,t){return t?this.#B[e]||this.#T[e>>4]:this.#B[e]||this.#T[e>>4]||this.#t}setPortMode(e,t,s){let o=this;if(e<0||e>=m.ch>>4)throw new RangeError(`Invalid port ${e+1}`);if(t<1)throw new RangeError("Range must be a positive integer");if(e+t>=m.ch>>4)throw new RangeError("Range must be in bound");if(e<0||s>=D.length)throw new RangeError(`Invalid mode ID ${s}`);for(let u=e;u<e+t;u++){o.#T[u]=s;for(let p=u<<4;p<u+1<<4;p++)o.dispatchEvent("voice",{part:p})}}copyChSetup(e,t,s){if(e==t){console.warn(`Failed attempt at overwriting CH${e+1} with its own data.`);return}let o=this;if(s&&o.#h[t]){console.warn(`Failed attempt at copying setup data from CH${e+1} to CH${t+1}.`);return}let u=m.cc*e,p=m.cc*t;o.#i[t]=o.#i[e],o.#e.set(o.#e.subarray(u,u+m.cc),p),o.pushChPrimitives(t)}setDrumFirstWrite(e,t){let s=this,o=s.#s[e];if(o<2)return;let u=o-2;if(s.#I[u<<1])if(t)s.#I[u<<1]=0,C()&&console.debug(`First write part for drum set ${u+1} has been reset.`);else return;else t?console.warn(`First write part for drum set ${u+1} is already blank.`):(s.#I[u<<1]=1,s.#I[u<<1|1]=e,console.debug(`First write part for drum set ${u+1} is set to CH${e+1}.`))}getChDrumFirstWrite(e){let t=this,s=t.#s[e];if(s<2)return;let o=s-2;return t.#I.subarray(o<<1,o+1<<1)}getDrumFirstWrite(e){if(e>=0&&e<m.drm)return this.#I.subarray(e<<1,e+1<<1)}switchMode(e,t=!1,s=!1){let o=this,u=w[e];if(u>-1){if(o.#t==0||t){let p=o.#t;o.initOnReset&&t&&(this.init(1),p=w["?"]),o.#t=u,o.#f=0;for(let v=0;v<m.ch;v++)o.#s[v]>0&&o.#B[v]==0&&(o.#e[v*m.cc]=o.#u[u][2],o.pushChPrimitives(v));switch(u){case w.mt32:{ce.forEach((v,a)=>{let d=a+1;o.#h[d]||(o.#i[d]=v,o.#e[d*m.cc+g[91]]=127,o.pushChPrimitives(d))});for(let v=1;v<10;v++)o.dispatchEvent("voice",{part:v});break}}let y;switch(u){case w["?"]:case w.g2:{y=[52,4,52,18,0,0,0,0];break}case w.xg:{y=[1,0,65,0,5,0,0,0];break}case w.gm:case w.gs:case w.sc:{y=[40,4,40,18,40,32,32,0];break}case w.sd:{y=[58,0,60,0,61,0,61,0];break}case w["05rw"]:case w.x5d:case w.ns5r:{y=[44,1,44,19,44,0,44,0];break}case w.k11:case w.sg:{y=[24,0,0,0,0,0,0,0];break}case w.mt32:{y=[40,4,0,0,0,0,0,0];break}case w.doc:{y=[24,16,0,0,0,0,0,0];break}case w.motif:case w.s90es:{y=[113,0,117,0,114,0,0,0];break}default:y=[0,0,0,0,0,0,0,0]}for(let v=0;v<m.efx;v++)!o.#M[3*v]&&y[v<<1]?.constructor&&(o.#M[3*v+1]=y[2*v],o.#M[3*v+2]=y[2*v+1],o.dispatchEvent(`efx${["reverb","chorus","delay","insert0"][v]}`,o.getEffectType(v)));s&&o.setDetectionTargets(e),o.dispatchEvent("mode",e),o.forceVoiceRefresh(),Ae.forEach(v=>{o.dispatchEvent("voice",{part:v})})}}else throw new Error(`Unknown mode ${e}`)}newStrength(){this.#A.fill(0)}runJson(e){if(e.type>14)return e.type==15&&e.data.constructor!=Uint8Array&&(e.data=Uint8Array.from(e.data)),this.#he[e.type].call(this,e);{let t=this.chRedir(e.part,e.track),s=!1;this.#fe[t]?.forEach(o=>{e.channel=o,s=!0,this.#he[e.type].call(this,e)}),s||console.warn(`${Le[e.type]?Le[e.type]:e.type}${[11,12].includes(e.type)?(e.data[0]!=null?e.data[0]:e.data).toString():""} event sent to CH${t+1} without any recipient.`)}this.#N.length>100&&this.#N.splice(100,this.#N.length-99)}runRaw(e){}async loadBank(e,t){let s=this;switch(e=e.toLowerCase(),e){case"s7e":{s.userBank.clearRange({msb:63,lsb:[21,22]}),s.userBank.clearRange({msb:63,lsb:[24,27]});break}case"pcg":{s.userBank.clearRange({msb:63,lsb:[6,9]}),s.userBank.clearRange({msb:63,lsb:[13,16]});break}default:throw new Error(`Unknown bank format ${e}`)}switch(e){case"s7e":case"pcg":{z.context=this,await s.userBank.load(await z.read(e,t),!1);break}}s.forceVoiceRefresh()}constructor(){super();let e=this;e.#$=new Uint8Array(256),e.#C[10]=new Uint8Array(512),e.#se=new I,e.#r={x5:82,ds:w.krs,smotif:w.s90es,gs:4,sc:3},e.#l={dumpLimit:e.DUMP_MODE},e.#L=new Proxy(e.#l,{set:()=>{}});for(let a in De){let d=w[a];d==null?console.debug(`SubDB build error: "${a}" does not exist`):e.#u[d]=new Uint8Array(De[a])}e.userBank.strictMode=!0,e.userBank.load(`MSB	PRG	LSB	NME
062	000	000	
122	000	000	
122	001	000	
122	002	000	
122	003	000	
122	004	000	
122	005	000	
122	006	000	`),e.addEventListener("metacommit",function(a){let{data:d}=a;e.#N[0]?.type==d.type&&e.#N[0]?.amend?(e.#N[0].amend=d.amend,e.#N[0].data+=d.data):e.#N.unshift(d)}),e.#O[1]=function(a){switch(a=a.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),a.slice(0,2)){case"@I":{this.#m=!0,this.dispatchEvent("metacommit",{type:"Kar.Info",data:a.slice(2)?.trimLeft()});break}case"@K":{this.#m=!0,this.dispatchEvent("metacommit",{type:"Kar.Mode",data:a.slice(2)?.trimLeft()}),console.debug(`Karaoke mode active: ${a.slice(2)}`);break}case"@L":{this.#m=!0,this.dispatchEvent("metacommit",{type:"Kar.Lang",data:a.slice(2)?.trimLeft()});break}case"@T":{this.#m=!0,this.dispatchEvent("metacommit",{type:"KarTitle",data:a.slice(2)?.trimLeft()});break}case"@V":{this.#m=!0,this.dispatchEvent("metacommit",{type:"Kar.Ver.",data:a.slice(2)?.trimLeft()});break}case"XF":{let d=a.slice(2).split(":");switch(d[0]){case"hd":{d.slice(1).forEach((l,r)=>{l.length&&this.dispatchEvent("metacommit",{type:["XfSngDte","XfSngRgn","XfSngCat","XfSongBt","XfSngIns","XfSngVoc","XfSngCmp","XfSngLrc","XfSngArr","XfSngPer","XfSngPrg","XfSngTag"][r],data:l})});break}case"ln":{d.slice(1).forEach((l,r)=>{l.length&&this.dispatchEvent("metacommit",{type:["XfKarLng","XfKarNme","XfKarCmp","XfKarLrc","XfKarArr","XfKarPer","XfKarPrg"][r],data:l})});break}default:this.dispatchEvent("metacommit",{type:"XfUnData",data:a})}break}default:this.#m?a[0]=="\\"?(this.dispatchEvent("metacommit",{type:"KarLyric",data:"",amend:!1}),this.dispatchEvent("metacommit",{type:"KarLyric",data:a.slice(1),amend:!0})):a[0]=="/"?(this.dispatchEvent("metacommit",{type:"KarLyric",data:"",mask:!0,amend:!1}),this.dispatchEvent("metacommit",{type:"KarLyric",data:a.slice(1),mask:!0,amend:!0})):this.dispatchEvent("metacommit",{type:"KarLyric",data:a,amend:!0}):a.split(`
`).forEach((d,l)=>{this.dispatchEvent("metacommit",{type:"Cmn.Text",data:d,mask:l!=0})})}},e.#O[2]=function(a){this.dispatchEvent("metacommit",{type:"Copyrite",data:a})},e.#O[3]=function(a,d){d<1&&this.#U<1&&this.dispatchEvent("metacommit",{type:"TrkTitle",data:a})},e.#O[4]=function(a,d){this.dispatchEvent("metacommit",{type:"Instrmnt",data:a})},e.#O[5]=function(a){a.trim()==""?this.dispatchEvent("metacommit",{type:"C.Lyrics",data:"",amend:!1}):this.dispatchEvent("metacommit",{type:"C.Lyrics",data:a,amend:!0})},e.#O[6]=function(a){this.dispatchEvent("metacommit",{type:"C.Marker",data:a})},e.#O[7]=function(a){this.dispatchEvent("metacommit",{type:"CuePoint",data:a})},e.#O[32]=function(a){this.#U=a[0]+1},e.#O[33]=function(a,d){C()&&console.debug(`Track ${d} requests to get assigned to output ${a}.`),e.#re[d]=a+1},e.#O[81]=function(a,d){e.#J=a/1e3},e.#O[127]=function(a,d){e.#se.run(a,d)},e.#se.default=function(a){console.warn(`Unrecognized sequencer-specific byte sequence: ${a}`)},e.#se.add([67,0,1],function(a,d){C()&&console.debug(`XGworks requests assigning track ${d} to output ${a[0]}.`),e.#re[d]=a[0]+1}),e.#ne=new I("universal non-realtime"),e.#ce=new I("universal realtime"),e.#H=new I("Yamaha"),e.#G=new I("Roland"),e.#Q=new I("Korg"),e.#oe=new I("Kawai"),e.#le=new I("Akai"),e.#de=new I("Casio");let t=new I("DX7+ Dump"),s=function(a){console.info(`Unrecognized SysEx in "${this.name}" set.
%o`,a)};e.#ne.default=s,e.#ce.default=s,e.#H.default=s,e.#G.default=s,e.#Q.default=s,e.#oe.default=s,e.#le.default=s,e.#de.default=s,t.default=s,e.#ne.add([9],(a,d,l)=>{e.switchMode(["gm","?","g2"][a[0]-1],!0),e.setPortMode(e.getTrackPort(d),1,w[["gm","?","g2"][a[0]-1]]),e.#m=e.#m||!1,console.info(`MIDI reset: ${["GM","Init","GM2"][a[0]-1]}`),a[0]==2&&e.init()}),e.#ce.add([4,1],(a,d,l)=>{e.dispatchEvent("mupromptex"),e.#p=((a[1]<<7)+a[0])/16383*100,e.dispatchEvent("mastervolume",e.#p)}).add([4,3],(a,d,l)=>((a[1]<<7)+a[0]-8192)/8192).add([4,4],(a,d,l)=>a[1]-64).add([4,5],(a,d,l)=>{e.dispatchEvent("mupromptex");let r=a[0],i=a[1],c=a[2],n=3,f=n+(r<<1),h=f+i;if(r!=1){console.error(`Unsupported GM2 global parameter set: slotpath length too long (${r})!
`,a);return}let b=0,E=0,k=0;switch(a.subarray(n,f).forEach(x=>{b=b<<7,b|=x}),a.subarray(f,h).forEach((x,T)=>{E|=x<<T*7}),a.subarray(h).forEach((x,T)=>{k|=x<<T*7}),C()&&console.debug(`GM2 global parameter: (${a.subarray(3,f)}; p: ${E}, v: ${k})`),b){case 129:{E==0&&(e.setEffectType(0,52,k),e.dispatchEvent("efxreverb",e.getEffectType(0)));break}case 130:{E==0&&(e.setEffectType(1,52,k|16),e.dispatchEvent("efxchorus",e.getEffectType(1)));break}default:C()&&console.debug("GM2 global paramater slot path unknown.")}}),this.#H.add([76,0,0],(a,d,l)=>{switch(a[0]){case 125:{e.initDrums(),console.info(`XG drum setup reset: ${a}`);break}case 126:{e.switchMode("xg",!0),e.setPortMode(e.getTrackPort(d),4,w.xg),e.#m=!1,console.info("MIDI reset: XG");break}default:{e.dispatchEvent("mupromptex");let r=[0,0,0,0],i=(c,n)=>{r[n]=c};if(a.subarray(1).forEach((c,n)=>{let f=n+a[0];([i,i,i,i,h=>{this.#p=h*129/16383*100,e.dispatchEvent("mastervolume",e.#p)},h=>{},h=>{}][f]||(()=>{}))(c,n)}),a[0]<4){let c=0;r.forEach(n=>{c=c<<4,c+=n}),c-=1024}}}}).add([76,2,1],(a,d,l)=>{e.dispatchEvent("mupromptex");let r="XG ";a[0]<32?(r+="reverb ",a.subarray(1).forEach((i,c)=>{([n=>{e.setEffectTypeRaw(0,!1,n),console.info(`${r}main type: ${q[n]}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},n=>{e.setEffectTypeRaw(0,!0,n),console.debug(`${r}sub type: ${n+1}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},n=>{console.debug(`${r}time: ${ke(n)}s`)},n=>{console.debug(`${r}diffusion: ${n}`)},n=>{console.debug(`${r}initial delay: ${n}`)},n=>{console.debug(`${r}HPF cutoff: ${F[n]}Hz`)},n=>{console.debug(`${r}LPF cutoff: ${F[n]}Hz`)},n=>{console.debug(`${r}width: ${n}`)},n=>{console.debug(`${r}height: ${n}`)},n=>{console.debug(`${r}depth: ${n}`)},n=>{console.debug(`${r}wall type: ${n}`)},n=>{console.debug(`${r}dry/wet: ${n}`)},n=>{console.debug(`${r}send: ${A(n)}dB`)},n=>{console.debug(`${r}pan: ${n-64}`)},!1,!1,n=>{console.debug(`${r}delay: ${n}`)},n=>{console.debug(`${r}density: ${n}`)},n=>{console.debug(`${r}balance: ${n}`)},n=>{},n=>{console.debug(`${r}feedback: ${n}`)},n=>{}][a[0]+c]||function(){console.warn(`Unknown XG reverb address: ${a[0]}.`)})(i)})):a[0]<64?(r+="chorus ",a.subarray(1).forEach((i,c)=>{([n=>{e.setEffectTypeRaw(1,!1,n),console.info(`${r}main type: ${q[n]}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},n=>{e.setEffectTypeRaw(1,!0,n),console.debug(`${r}sub type: ${n+1}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},n=>{console.debug(`${r}LFO: ${we[n]}Hz`)},n=>{},n=>{console.debug(`${r}feedback: ${n}`)},n=>{console.debug(`${r}delay offset: ${$e(n)}ms`)},n=>{},n=>{console.debug(`${r}low: ${F[n]}Hz`)},n=>{console.debug(`${r}low: ${n-64}dB`)},n=>{console.debug(`${r}high: ${F[n]}Hz`)},n=>{console.debug(`${r}high: ${n-64}dB`)},n=>{console.debug(`${r}dry/wet: ${n}`)},n=>{console.debug(`${r}send: ${A(n)}dB`)},n=>{console.debug(`${r}pan: ${n-64}`)},n=>{console.debug(`${r}to reverb: ${A(n)}dB`)},!1,n=>{},n=>{},n=>{},n=>{console.debug(`${r}LFO phase diff: ${(n-64)*3}deg`)},n=>{console.debug(`${r}input mode: ${n?"stereo":"mono"}`)},n=>{}][a[0]-32+c]||function(){console.warn(`Unknown XG chorus address: ${a[0]}.`)})(i)})):a[0]<86?(r+="variation ",a.subarray(1).forEach((i,c)=>{([n=>{e.setEffectTypeRaw(2,!1,n),console.info(`${r}main type: ${q[n]}`),e.dispatchEvent("efxdelay",e.getEffectType(2))},n=>{e.setEffectTypeRaw(2,!0,n),console.debug(`${r}sub type: ${n+1}`),e.dispatchEvent("efxdelay",e.getEffectType(2))}][a[0]-64+c]||function(){})(i)})):a[0]<97?(r+="variation ",a.subarray(1).forEach((i,c)=>{[n=>{console.debug(`${r}send: ${A(n)}dB`)},n=>{console.debug(`${r}pan: ${n-64}`)},n=>{console.debug(`${r}to reverb: ${A(n)}dB`)},n=>{console.debug(`${r}to chorus: ${A(n)}dB`)},n=>{console.debug(`${r}connection: ${n?"system":"insertion"}`)},n=>{console.debug(`${r}channel: CH${n+1}`)},n=>{console.debug(`${r}mod wheel: ${n-64}`)},n=>{console.debug(`${r}bend wheel: ${n-64}`)},n=>{console.debug(`${r}channel after touch: ${n-64}`)},n=>{console.debug(`${r}AC1: ${n-64}`)},n=>{console.debug(`${r}AC2: ${n-64}`)}][a[0]-86+c](i)})):a[0]>111&&a[0]<118?r+="variation ":console.warn(`Unknown XG variation address: ${a[0]}`)}).add([76,2,64],(a,d,l)=>{a.subarray(1).forEach((r,i)=>{let c=i+a[0];if(c==0)console.debug(`XG EQ preset: ${["flat","jazz","pop","rock","classic"][r]}`);else{let n=c-1>>2,f=c-1&3,h=`XG EQ ${n} ${["gain","freq","Q","shape"][f]}: `;[()=>{console.debug(`${h}${r-64}dB`)},()=>{console.debug(`${h}${r} (raw)`)},()=>{console.debug(`${h}${r/10}`)},()=>{console.debug(`${h}${["shelf","peak"][+!!r]}`)}][f]()}})}).add([76,3],(a,d,l)=>{e.dispatchEvent("mupromptex");let r=a[0],i=a[1],c=`XG Insertion ${a[0]+1} `;a.subarray(2).forEach((n,f)=>{([h=>{e.setEffectTypeRaw(3+r,!1,h),console.info(`${c}main type: ${q[h]}`),e.dispatchEvent(`efxinsert${r}`,e.getEffectType(3+r))},h=>{e.setEffectTypeRaw(3+r,!0,h),console.debug(`${c}sub type: ${h+1}`),e.dispatchEvent(`efxinsert${r}`,e.getEffectType(3+r))}][i+f]||function(){})(n)})}).add([76,6,0],(a,d,l)=>{let r=a[0];r<64?e.setLetterDisplay(a.subarray(1),"XG letter display",r):e.#W=Date.now()}).add([76,7,0],(a,d,l)=>{let r=a[0];e.#f=0,e.#k=Date.now()+3200,e.#$.fill(0);let i=a.subarray(1);for(let c=0;c<r;c++)i.unshift(0);i.forEach(function(c,n){let f=Math.floor(n/16),h=n%16,b=(h*3+f)*7,E=7,k=0;for(b-=h*5,f==2&&(E=2);k<E;)e.#$[b+k]=c>>6-k&1,k++})}).add([76,8],(a,d)=>{e.dispatchEvent("mupromptex");let l=e.chRedir(a[0],d,!0),r=a[1],i=m.cc*l,c=`XG CH${l+1} `,n=`Unknown XG part address ${r}.`,f=!0;a.subarray(2).forEach((h,b)=>{f=!0,r<1?console.debug(n):r<41?([()=>{e.#e[i+g[0]]=h,e.pushChPrimitives(l),e.dispatchEvent("voice",{part:l})},()=>{e.#e[i+g[32]]=h,e.pushChPrimitives(l),e.dispatchEvent("voice",{part:l})},()=>{e.#i[l]=h,e.dispatchEvent("voice",{part:l})},()=>{f=!1;let E=e.chRedir(h,d,!0);e.#g[l]=E,l!=E&&(e.buildRchTree(),console.info(`${c}receives from CH${E+1}`)),e.#h[l]||(e.copyChSetup(E,l,!0),console.debug(`${c}copied from CH${E+1}.`),e.setChActive(l,1),e.dispatchEvent("voice",{part:l}))},()=>{e.#v[l]=+!h},()=>{},()=>{f=!1,e.setChType(l,h,w.xg),console.debug(`${c}type: ${W[h]||h}`),e.dispatchEvent("voice",{part:l})},()=>{e.#n[m.rpn*l+3]=h,e.#c[m.rpnt*l+2]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)})},!1,!1,()=>{e.#e[i+g[7]]=h},!1,!1,()=>{e.#e[i+g[10]]=h||128},!1,!1,()=>{e.#e[i+g[128]]=h,e.allocateAce(l,128)},()=>{e.#e[i+g[93]]=h},()=>{e.#e[i+g[91]]=h},()=>{e.#e[i+g[94]]=h},()=>{e.#e[i+g[76]]=h},()=>{e.#e[i+g[77]]=h},()=>{e.#e[i+g[78]]=h},()=>{e.#e[i+g[74]]=h},()=>{e.#e[i+g[71]]=h},()=>{e.#e[i+g[73]]=h},()=>{e.#e[i+g[75]]=h},()=>{e.#e[i+g[72]]=h}][r+b-1]||(()=>{}))():r<48?console.debug(n):r<111?r>102&&r<105&&(e.#e[i+g[[5,65][r&1]]]=h):r<114?console.debug(n):r<116?console.debug(`${c}EQ ${["bass","treble"][r&1]} gain: ${h-64}dB`):r<118?console.debug(n):r<120?console.debug(`${c}EQ ${["bass","treble"][r&1]} freq: ${h}`):console.debug(n)}),f&&e.#s[l]>1&&e.setDrumFirstWrite(l)}).add([76,9],(a,d)=>{let l=e.chRedir(a[0],d,!0),r=a[1],i=m.cc*l,c=`PLG-VL CH${l+1} `;a.subarray(2).forEach((n,f)=>{let h=f+r;switch(h){case 1:{console.info(`${c}breath mode: ${["system","breath","velocity","touch EG"][n]}`);break}case 0:case 27:case 28:break;default:if(h<27){let b=h-3>>1,E=["pressure","embouchure","tonguing","scream","breath noise","growl","throat formant","harmonic enhancer","damping","absorption","amplification","brightness"][b];h&1?h<23?(console.debug(`${c}${E} control source: ${Ce(n)}`),n&&n<96&&e.allocateAce(l,130+b),e.#X[m.redir*l+b+2]=n,e.buildRccMap()):console.debug(`${c}${E} scale break point: ${n}`):(console.debug(`${c}${E} depth: ${n-64}`),e.#e[i+g[130+b]]=n)}}})}).add([76,10],(a,d,l)=>{}).add([76,16],(a,d,l)=>{}).add([76,17,0,0],(a,d,l)=>{}).add([76,112],(a,d,l)=>{switch(console.debug(`XG enable PLG-${["VL","SG","DX","AN","PF","DR","PC","AP"][a[0]]} for CH${a[2]+1}.`),a[0]){case 0:{e.#S[m.ext*a[2]]=e.EXT_VL;break}case 2:{e.#S[m.ext*a[2]]=e.EXT_DX;break}default:e.#S[m.ext*a[2]]=e.EXT_NONE}}).add([73,0,0],(a,d)=>{let l=a[0],r="MU1000 System - ";a.subarray(1).forEach((i,c)=>{let n=l+c;n==8?console.debug(`${r}LCD contrast: ${i}.`):n==18?(e.#u[w.xg][1]=i?126:0,console.debug(`${r}default bank: ${i?"MU100 Native":"MU Basic"}.`),e.dispatchEvent("banklevel",{mode:"xg",data:+!!i}),e.forceVoiceRefresh()):n>=64&&n<69&&[()=>{e.dispatchEvent("channelactive",i)},()=>{i<8?(e.dispatchEvent("channelmin",i<<4),console.debug(`Octavia System: Minimum CH${(i<<4)+1}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{i<8?(e.dispatchEvent("channelmax",(i<<4)+15),console.debug(`Octavia System: Maximum CH${(i<<4)+16}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges")},()=>{e.#V=!!i,console.info(`Octavia System: RS receiving ${["dis","en"][i]}abled.`)}][n-64]()})}).add([73,10,0],(a,d)=>{let l=a[0],r=`MU1000 RS${e.#V?"":" (ignored)"}: `;if(l<16)switch(l){case 2:{let i=e.chRedir(0,d,!0);e.#V&&(e.dispatchEvent("portrange",4),e.dispatchEvent("portstart",i)),console.info(`${r}Show CH${i+1}~CH${i+64}`);break}case 3:{let i=e.chRedir(a[1]<<5,d,!0);e.#V&&(e.dispatchEvent("portrange",2),e.dispatchEvent("portstart",i)),console.info(`${r}Show CH${i+1}~CH${i+32}`);break}default:console.debug(`${r}unknown switch ${l} invoked.`)}else if(l<32){if(e.#V){let i=e.chRedir(l-16+(e.#te<<4),d,!0);e.dispatchEvent("channelactive",i)}}else if(l<36){let i=e.chRedir(l-32<<4,d,!0);e.#V&&(e.dispatchEvent("portrange",1),e.dispatchEvent("portstart",i>>4),e.#te=l-32),console.info(`${r}Show CH${i+1}~CH${i+16}`)}}).add([73,11,0],(a,d)=>{let l="MU1000 System - channel ",r="Octavia System - channel ",i=a[0];a.subarray(1).forEach((c,n)=>{let f=i+n;([()=>{e.setChActive(c,1),e.dispatchEvent("channelactive",c),C()&&console.debug(`${l}current part: CH${c+1}`)},()=>{c<5?(e.dispatchEvent("portrange",1<<c),console.debug(`${l}port range: ${1<<c} port(s)`)):(e.dispatchEvent("portrange",0),console.debug(`${l}port range: reset`))},()=>{c<16?(e.dispatchEvent("portstart",c),console.debug(`${r}start port: ${"ABCDEFGHIJKLMNOP"[c]}`)):(e.dispatchEvent("portstart",255),console.debug(`${r}start port: reset`))}][f]||(()=>{console.debug(`${l}unknown address: ${f}`)}))()})}).add([93,3],(a,d)=>{let l=e.chRedir(a[0],d,!0),r=`PLG-SG CH${l+1} `,i=Date.now();if(a[1]==0){let c="",n=0;a.subarray(2).forEach((f,h)=>{h%2==0?c+=xe[f]||f.toString().padStart("0"):n+=f*13}),i>=e.#j&&this.dispatchEvent("metacommit",{type:"SGLyrics",data:"",amend:!1}),this.dispatchEvent("metacommit",{type:"SGLyrics",data:`${Te(c)}`,amend:!0}),e.#j=i+Math.ceil(n/2)+e.#J,C()&&console.debug(`${r}vocals: ${c}`)}else console.warn(`Unknown PLG-SG data: ${a}`)}).add([98,0],(a,d,l)=>{e.dispatchEvent("mupromptex");let r=a[0],i=a.length-5,c=a.length-1;if(r!=i){console.info(`PLG-DX native dump size mismatch! Gave ${r} instead of ${a.length-5}.`);return}let n=_(a.subarray(4,c));if(n!=a[c]){console.info(`Bad PLG-DX checksum ${a[c]} - should be ${n}.`);return}a[0]=98,e.#H.run(a.subarray(0,c),d,l,{noAce:!0})}).add([98,96],(a,d,l,r)=>{let i=e.chRedir(a[0],d,!0),c=m.cc*i,n=a[1];a.subarray(2).forEach((f,h)=>{let b=n+h;if(!(b<10)){if(b==10)e.resetAce();else if(b<27){let E=b+131;r?.noAce||e.allocateAce(i,E),e.#e[c+g[E]]=f,e.dispatchEvent("cc",{part:i,cc:E,data:f})}}})}).add([100,0],(a,d,l)=>{let r=a.subarray(0,a.length-1);if(a[0]+5!=a.length){console.warn(`Yamaha DX7+ dump SysEx size mismatch! Expected ${a.length}, but got ${a[0]}:
`,a);return}let i=_(r),c=a[a.length-1];if(i!=c){console.warn(`Yamaha DX7+ dump SysEx checksum mismatch! Expected ${i}, but got ${c}:
`,a);return}t.run(r.subarray(1))}).add([100,76],(a,d,l)=>{let r=a[0]>>4,i=a[0]&15,c=a[1];switch(r){case 2:{let n=e.chRedir(i,d,!0),f=m.cc*n;a.subarray(2).forEach((h,b)=>{let E=b+c;if(!(E<7)){if(E<23){let k=E+135;e.allocateAce(n,k),e.#e[f+g[k]]=h,e.dispatchEvent("cc",{part:n,cc:k,data:h})}}});break}default:console.info("Unknown DX7+ multipart: %o",a)}}).add([1,20],(a,d,l)=>{l==115?(e.switchMode("doc",!0),e.setPortMode(e.getTrackPort(d),1,w.doc),console.info("MIDI reset: DOC")):console.debug(`Unknown Yamaha SysEx: 67, ${l}, ${a.join(", ")}`)}).add([1,17,15,89],(a,d,l)=>{l==115?(e.setEffectType(0,24,a[0]|16),e.dispatchEvent("efxreverb",e.getEffectType(0))):console.debug(`Unknown Yamaha SysEx: 67, ${l}, ${a.join(", ")}`)}).add([1,24],(a,d,l)=>{if(l==115){for(let r=0;r<16;r++){let i=e.chRedir(r,d,!0);e.#e[i*m.cc+g[91]]=127}console.info("DOC Global Reverb: on")}else console.debug(`Unknown Yamaha SysEx: 67, ${l}, ${a.join(", ")}`)}),t.add([14,31],(a,d,l)=>{e.#e[m.cc*a[0]+g[64]]=0,e.#P.ano(a[0]),e.switchMode("xg"),e.setPortMode(e.getTrackPort(d),1,w.xg),e.resetAce(),console.debug(`Yamaha DX7+ reset CH${a[0]+1}.`)}).add([76,112],async a=>{let d=a[0],l=m.cc*d,r=m.ext*d,i=m.cvn*d;e.#S[r]=e.EXT_DX,e.#d[d]=1;let c=e.#q.subarray(i,i+m.cvn);c.fill(32),a.subarray(1).forEach((n,f)=>{if(f<10)c[f]=Math.max(n,32);else if(!(f<40)){if(f<56){let h=f+102;e.#e[l+g[h]]=n,e.dispatchEvent("cc",{part:d,cc:h,data:n})}}}),e.#i[d]=d&127,e.#e[m.cc*d+g[0]]=35,e.#e[m.cc*d+g[32]]=d>>7|4,e.pushChPrimitives(d),e.dispatchEvent("voice",{part:d}),console.debug(`DX7+ CH${d+1} dump: %o`,a)});let o=function(a,d,l,r){},u=function(a,d){e.dispatchEvent("mupromptex");let l=a*m.dpn,r=d[0],i=d[1];d.subarray(2).forEach((c,n)=>{let f=n+i,h=-1;f<16?([()=>{h=24},()=>{h=25},()=>{h=26},()=>{},()=>{h=28},()=>{h=29},()=>{h=30},()=>{h=31},()=>{},()=>{},()=>{},()=>{h=20},()=>{h=21},()=>{h=22},()=>{h=23},()=>{}][f]||(()=>{console.debug(`Unknown XG-style drum param ${f} on set ${a+1}.`)}))():f<32||(f<40?([()=>{h=48},()=>{h=49},!1,!1,()=>{h=52},()=>{h=53}][f-32]||(()=>{console.debug(`Unknown XG-style drum param ${f} on set ${a+1}.`)}))():f<80||([()=>{h=36}][f-80]||(()=>{console.debug(`Unknown XG-style drum param ${f} on set ${a+1}.`)}))()),h>=0?(C()&&console.debug(l,h,r,c),e.#R[(l+L[h])*m.dnc+r]=c):C()&&console.debug(`XG-style drum param ${f} has no writes.`)})},p=function(a,d,l){e.dispatchEvent("mupromptex");let r=a*m.dpn,i=(d<<7)+l[0];l.subarray(1).forEach((c,n)=>{let f=n+i,h=f&127,b=f>>7,E=-1;b>1&&([()=>{E=26},()=>{},()=>{E=28},()=>{E=29},()=>{E=30},()=>{},()=>{},()=>{E=31}][b-2]||(()=>{console.debug(`Unknown GS-style drum param ${b} on set ${a+1}.`)}))(),E>-1?(C()&&console.debug(r,E,h,c),e.#R[(r+L[E])*m.dnc+h]=c):C()&&console.debug(`GS-style drum param ${b} has no writes.`)})};this.#H.add([76,48],(a,d,l)=>{u(0,a)}).add([76,49],(a,d,l)=>{u(1,a)}).add([76,50],(a,d,l)=>{u(2,a)}).add([76,51],(a,d,l)=>{u(3,a)}).add([76,52],(a,d,l)=>{u(4,a)}).add([76,53],(a,d,l)=>{u(5,a)}).add([76,54],(a,d,l)=>{u(6,a)}).add([76,55],(a,d,l)=>{u(7,a)}),this.#H.add([89,0],(a,d,l)=>{if(e.eprom){let r=a[0],i=(a[1]<<14)+(a[2]<<7)+a[3]+(e.eprom.offset||0);C()&&console.debug(`MU1000 EPROM trail to 0x${i.toString(16).padStart(6,"0")}, ${r} bytes.`);let c=e.eprom.data;a.subarray(4).forEach((n,f)=>{let h=f>>3,b=f&7;if(b==7)for(let E=0;E<7;E++)c[i+7*h+E]+=(n>>6-E&1)<<7;else c[i+7*h+b]=n})}}).add([89,1],(a,d,l)=>{let r=(a[0]<<21)+(a[1]<<14)+(a[2]<<7)+a[3];C()&&console.debug(`MU1000 EPROM jump to 0x${r.toString(16).padStart(6,"0")}.`),e.eprom&&(e.eprom.offset=r)}).add([89,2],(a,d,l)=>{if(e.eprom){let r=(a[0]<<21)+(a[1]<<14)+(a[2]<<7)+a[3]+(e.eprom.offset||0);C()&&console.debug(`MU1000 EPROM write to 0x${r.toString(16).padStart(6,"0")}.`);let i=e.eprom.data;a.subarray(4).forEach((c,n)=>{let f=n>>3,h=n&7;if(h==7)for(let b=0;b<7;b++)i[r+7*f+b]+=(c>>6-b&1)<<7;else i[r+7*f+h]=c})}}).add([89,3],(a,d,l)=>{}),this.#H.add([39,48],(a,d,l)=>{}).add([43,0,0],(a,d,l)=>{e.dispatchEvent("mupromptex");let r=[0,0,0,0],i=(c,n)=>{r[n]=c};if(a.subarray(1).forEach((c,n)=>{let f=n+a[0];[i,i,i,i,()=>{this.#p=c*129/16383*100,e.dispatchEvent("mastervolume",e.#p)},()=>c-64,()=>c||128,()=>c,()=>c,()=>{console.debug(`TG300 variation on cc${c}.`)}][f](c,f)}),a[0]<4){let c=0;r.forEach(n=>{c=c<<4,c+=n}),c-=1024}}).add([43,1,0],(a,d,l)=>{e.dispatchEvent("mupromptex")}).add([43,2],(a,d,l)=>{e.dispatchEvent("mupromptex");let r=e.chRedir(a[0],d,!0),i=a[1],c=m.cc*r,n=`TG300 CH${r+1} `;a.subarray(2).forEach((f,h)=>{h<5?([()=>{},()=>{e.#e[c+g[0]]=f,e.pushChPrimitives(r),e.dispatchEvent("voice",{part:r})},()=>{e.#e[c+g[32]]=f,e.pushChPrimitives(r),e.dispatchEvent("voice",{part:r})},()=>{e.#i[r]=f,e.dispatchEvent("voice",{part:r})},()=>{let b=e.chRedir(f,d,!0);e.#g[r]=b,r!=b&&(e.buildRchTree(),console.info(`${n}receives from CH${b+1}`))}][h+i]||(()=>{}))(f,h+i):h<21||(h<47?([()=>{e.#v[r]=+!f},()=>{},()=>{},()=>{e.#n[m.rpn*r+3]=f,e.#c[m.rpnt*r+2]=1,e.dispatchEvent("pitch",{part:r,pitch:e.getPitchShift(r)})},()=>{},()=>{e.#e[c+g[7]]=f},!1,!1,()=>{e.#e[c+g[10]]=f||128},!1,!1,()=>{console.debug(`${n} AC1 at cc${f}`)},()=>{console.debug(`${n} AC2 at cc${f}`)},()=>{e.#e[c+g[128]]=f,e.allocateAce(r,128)},()=>{e.#e[c+g[93]]=f},()=>{e.#e[c+g[91]]=f},()=>{e.#e[c+g[94]]=f},()=>{e.#e[c+g[76]]=f},()=>{e.#e[c+g[77]]=f},()=>{e.#e[c+g[74]]=f},()=>{e.#e[c+g[71]]=f},()=>{e.#e[c+g[73]]=f},()=>{e.#e[c+g[75]]=f},()=>{e.#e[c+g[72]]=f},()=>{e.#e[c+g[78]]=f}][h+i-21]||(()=>{}))(f,h+i):h<95||([()=>{e.#e[c+g[65]]=f},()=>{e.#e[c+g[5]]=f}][h+i-95]||(()=>{}))(f,h+i))})}).add([43,7,0],(a,d,l)=>{let r=a[0];e.setLetterDisplay(a.subarray(1),"TG300 letter display",r)}).add([43,7,1],(a,d,l)=>{e.#f=0,e.#k=Date.now()+3200,e.#$.fill(0),a.forEach(function(r,i){let c=Math.floor(i/16),n=i%16,f=(n*3+c)*7,h=7,b=0;for(f-=n*5,c==2&&(h=2);b<h;)e.#$[f+b]=r>>6-b&1,b++})}),this.#G.add([66,18,0,0,127],(a,d,l)=>{e.switchMode("sc",!0),e.setPortMode(e.getTrackPort(d),2,w.sc),e.#e[m.cc*9]=120,e.#e[m.cc*25]=120,e.#e[m.cc*41]=120,e.#e[m.cc*57]=120,e.#u[w.sc][1]=e.#r.sc,e.#m=!1,e.#ee.fill(0),console.info(`GS system to ${["single","dual"][a[0]]} mode.`)}).add([66,18,64,0],(a,d,l)=>{switch(a[0]){case 127:{e.switchMode("gs",!0),e.setPortMode(e.getTrackPort(d),2,w.gs),e.#u[w.gs][1]=e.#r.gs,e.#e[m.cc*9]=120,e.#e[m.cc*25]=120,e.#e[m.cc*41]=120,e.#e[m.cc*57]=120,e.#m=!1,e.#ee.fill(0),console.info("MIDI reset: GS");break}default:{e.dispatchEvent("mupromptex");let r=[0,0,0,0],i=(c,n)=>{r[n]=c};if(a.subarray(1).forEach((c,n)=>{let f=n+a[0];[i,i,i,i,h=>{this.#p=h*129/16383*100,e.dispatchEvent("mastervolume",e.#p)},h=>{},h=>{}][f](c,n)}),a[0]<4){let c=0;r.forEach(n=>{c=c<<4,c+=n}),c-=1024}}}}).add([66,18,64,1],(a,d,l)=>{e.dispatchEvent("mupromptex");let r=a[0];if(r<16){let i="".padStart(r," ");a.subarray(1).forEach((c,n)=>{i+=String.fromCharCode(Math.max(32,c))}),i=i.padEnd(16," "),console.debug(`GS patch name: ${i}`)}else r<48||(r<65?a.subarray(1).forEach((i,c)=>{let n=`GS ${r+c>55?"chorus":"reverb"} `;([()=>{console.info(`${n}type: ${se[i]}`),e.setEffectType(0,40,i),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{},()=>{},()=>{},()=>{},()=>{},!1,()=>{console.debug(`${n}predelay: ${i}ms`)},()=>{console.info(`${n}type: ${Se[i]}`),e.setEffectType(1,40,16+i),e.dispatchEvent("efxchorus",e.getEffectType(1))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${n}to reverb: ${A(i)}`)},()=>{console.debug(`${n}to delay: ${A(i)}`)}][r+c-48]||(()=>{}))()}):r<80?console.debug(`Unknown GS patch address: ${r}`):r<91?a.subarray(1).forEach((i,c)=>{let n="GS delay ";([()=>{console.info(`${n}type: ${Me[i]}`),e.setEffectType(2,40,32+i),e.dispatchEvent("efxdelay",e.getEffectType(2))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${n}to reverb: ${A(i)}`)}][r+c-80]||(()=>{}))()}):console.debug(`Unknown GS patch address: ${r}`))}).add([66,18,64,2],(a,d,l)=>{let r="GS EQ ";a.subarray(1).forEach((i,c)=>{([()=>{console.debug(`${r}low freq: ${[200,400][i]}Hz`)},()=>{console.debug(`${r}low gain: ${i-64}dB`)},()=>{console.debug(`${r}high freq: ${[3e3,6e3][i]}Hz`)},()=>{console.debug(`${r}high gain: ${i-64}dB`)}][a[0]+c]||function(){console.warn(`Unknown GS EQ address: ${a[0]+c}`)})()})}).add([66,18,64,3],(a,d,l)=>{e.dispatchEvent("mupromptex");let r="GS EFX ",i=function(c,n){let f=Pe(e.#M.subarray(10,12),n,c);f&&console.debug(`${r}${ne(e.#M.subarray(10,12))} ${f}`)};a.subarray(1).forEach((c,n)=>{([()=>{e.setEffectTypeRaw(3,!1,32+c),e.dispatchEvent("efxinsert0",e.getEffectType(3))},()=>{e.setEffectTypeRaw(3,!0,c),console.info(`${r}type: ${ne(e.#M.subarray(10,12))}`),e.dispatchEvent("efxinsert0",e.getEffectType(3))},!1,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,()=>{console.debug(`${r}to reverb: ${A(c)}dB`)},()=>{console.debug(`${r}to chorus: ${A(c)}dB`)},()=>{console.debug(`${r}to delay: ${A(c)}dB`)},!1,()=>{console.debug(`${r}1 source: ${c}`),c&&c<96&&e.allocateAceAll(c)},()=>{console.debug(`${r}1 depth: ${c-64}`)},()=>{console.debug(`${r}2 source: ${c}`),c&&c<96&&e.allocateAceAll(c)},()=>{console.debug(`${r}2 depth: ${c-64}`)},()=>{console.debug(`${r}to EQ: ${c?"ON":"OFF"}`)}][a[0]+n]||function(f,h){console.warn(`Unknown GS EFX address: ${h}`)})(c,a[0]+n)})}).add([66,18,65],(a,d,l)=>{p((a[0]>>4)+1<<1,a[0]&15,a.subarray(1))}).add([69,18,16],(a,d,l)=>{switch(a[0]){case 0:{let r=a[1];e.setLetterDisplay(a.subarray(2),"GS display text",r);break}case 8:{let r=a[1],i=e.modelEx.sc;a.subarray(2).forEach((c,n)=>{([()=>{i.showBar=!(c&1),i.invBar=c>>1&1,i.invDisp=c>>2&1},()=>{i.peakHold=c<4?c:1}][n+r]||(()=>{console.debug("Unsupported GS display type SysEx.")}))()});break}case 32:{e.#k=Date.now()+3200,a[1]==0&&(a[2]?(e.#f=Math.max(Math.min(a[2]-1,9),0),C()&&console.debug(`GS switch display page ${a[2]-1}.`)):(e.#f=0,e.#k=Date.now(),C()&&console.debug("GS disable display page.")));break}default:if(a[0]<6){e.#f>9&&(e.#f=0);let r=a[0]-1<<1|a[1]>>6;e.#f==r&&(e.#k=Date.now()+3200),e.#C[r]?.length||(e.#C[r]=new Uint8Array(256));let i=e.#C[r];C()&&console.debug(`GS frame draw page ${r}.`);let c=a[1]&63;i.fill(0),a.subarray(2).forEach(function(f,h){let b=h+c,E=Math.floor(b/16),k=b%16,x=(k*4+E)*5,T=5,M=0;for(x-=k*4,E==3&&(T=1);M<T;)i[x+M]=f>>4-M&1,M++})}else console.warn(`Unknown GS display section: ${a[0]}`)}}).add([69,18,32],(a,d,l)=>{let r=a[0],i=a[1],c=a.subarray(2);if(r>>4){console.warn(`SC-8850 partial screen dump out of bounds: invalid bundle.
`,a);return}let n=i+c.length,f=i*6-(i*2428>>16<<1),h=n*6-(n*2428>>16<<1);if(f>640){console.warn(`SC-8850 partial screen dump out of bounds: invalid buffer range.
`,a);return}h>640&&(console.info(`SC-8850 partial screen dump out of bounds: invalid buffer end, automatically restricted.
`,a),h=640);let b=new Uint8Array(h-f);c.forEach((x,T)=>{let M=T+i,V=(M*2428&65535)*27>>16==26,P=M*6-(M*2428>>16<<1),N=V?2:0;for(;N<6;)b[P+(5-N)]=x>>N&1,N++});let E=r*108+i,k=E*6-(E*2428>>16<<1);e.dispatchEvent("screen",{type:"sc8850",offset:k,data:b}),C()&&console.debug(`SC-8850 screen dump: bundle ${r+1}, range ${f}~${h}`)});let y=function(a,d,l){e.dispatchEvent("mupromptex");let r=a[0],i=m.cc*d,c=m.rpn*d,n=`GS CH${d+1} `;r<3?(a.subarray(1).forEach((f,h)=>{[()=>{e.#e[i+g[0]]=f,e.pushChPrimitives(d)},()=>{e.#i[d]=f},()=>{let b=0;f<16?b=e.chRedir(f,l,!0):b=m.ch,e.#g[d]=b,d!=b&&(e.buildRchTree(),console.info(`${n}receives from CH${b+1}`))}][r+h]()}),e.dispatchEvent("voice",{part:d})):r<19||(r<44?a.subarray(1).forEach((f,h)=>{([()=>{e.#v[d]=+!f},!1,()=>{e.setChType(d,f<<1,w.gs),console.debug(`${n}type: ${f?"drum ":"melodic"}${f||""}`)},()=>{e.#n[c+3]=f,e.#c[m.rpnt*d+2]=1,e.dispatchEvent("pitch",{part:d,pitch:e.getPitchShift(d)})},!1,()=>{e.#e[i+g[7]]=f},!1,!1,()=>{e.#e[i+g[10]]=f||128},!1,!1,()=>{console.debug(`${n}CC 1: cc${f}`)},()=>{console.debug(`${n}CC 2: cc${f}`)},()=>{e.#e[i+g[93]]=f},()=>{e.#e[i+g[91]]=f},!1,!1,()=>{e.#n[c+1]=f,e.#c[m.rpnt*d+1]=1,e.dispatchEvent("pitch",{part:d,pitch:e.getPitchShift(d)})},()=>{e.#n[c+2]=f,e.#c[m.rpnt*d+1]=1,e.dispatchEvent("pitch",{part:d,pitch:e.getPitchShift(d)})},()=>{e.#e[i+g[94]]=f}][r+h-19]||(()=>{}))()}):r<76||console.debug(`Unknown GS part address: ${r}`))},v=function(a,d){let l=a[0],r=`GS CH${d+1} `;l<2?a.subarray(1).forEach((i,c)=>{[()=>{e.#e[m.cc*d+g[32]]=i},()=>{}][l+c]()}):l<32?console.warn(`Unknown GS misc address: ${l}`):l<35?a.subarray(1).forEach((i,c)=>{[()=>{console.debug(`${r}EQ: o${["ff","n"][i]}`)},()=>{},()=>{console.debug(`${r}EFX: o${["ff","n"][i]}`),e.#z[d]=i,e.dispatchEvent("partefxtoggle",{part:d,active:i})}][l+c-32]()}):console.warn(`Unknown GS misc address: ${l}`)};this.#G.add([66,18,64,16],(a,d)=>{y(a,e.chRedir(9,d,!0),d)}).add([66,18,64,17],(a,d)=>{y(a,e.chRedir(0,d,!0),d)}).add([66,18,64,18],(a,d)=>{y(a,e.chRedir(1,d,!0),d)}).add([66,18,64,19],(a,d)=>{y(a,e.chRedir(2,d,!0),d)}).add([66,18,64,20],(a,d)=>{y(a,e.chRedir(3,d,!0),d)}).add([66,18,64,21],(a,d)=>{y(a,e.chRedir(4,d,!0),d)}).add([66,18,64,22],(a,d)=>{y(a,e.chRedir(5,d,!0),d)}).add([66,18,64,23],(a,d)=>{y(a,e.chRedir(6,d,!0),d)}).add([66,18,64,24],(a,d)=>{y(a,e.chRedir(7,d,!0),d)}).add([66,18,64,25],(a,d)=>{y(a,e.chRedir(8,d,!0),d)}).add([66,18,64,26],(a,d)=>{y(a,e.chRedir(10,d,!0),d)}).add([66,18,64,27],(a,d)=>{y(a,e.chRedir(11,d,!0),d)}).add([66,18,64,28],(a,d)=>{y(a,e.chRedir(12,d,!0),d)}).add([66,18,64,29],(a,d)=>{y(a,e.chRedir(13,d,!0),d)}).add([66,18,64,30],(a,d)=>{y(a,e.chRedir(14,d,!0),d)}).add([66,18,64,31],(a,d)=>{y(a,e.chRedir(15,d,!0),d)}).add([66,18,64,64],(a,d)=>{v(a,e.chRedir(9,d,!0))}).add([66,18,64,65],(a,d)=>{v(a,e.chRedir(0,d,!0))}).add([66,18,64,66],(a,d)=>{v(a,e.chRedir(1,d,!0))}).add([66,18,64,67],(a,d)=>{v(a,e.chRedir(2,d,!0))}).add([66,18,64,68],(a,d)=>{v(a,e.chRedir(3,d,!0))}).add([66,18,64,69],(a,d)=>{v(a,e.chRedir(4,d,!0))}).add([66,18,64,70],(a,d)=>{v(a,e.chRedir(5,d,!0))}).add([66,18,64,71],(a,d)=>{v(a,e.chRedir(6,d,!0))}).add([66,18,64,72],(a,d)=>{v(a,e.chRedir(7,d,!0))}).add([66,18,64,73],(a,d)=>{v(a,e.chRedir(8,d,!0))}).add([66,18,64,74],(a,d)=>{v(a,e.chRedir(10,d,!0))}).add([66,18,64,75],(a,d)=>{v(a,e.chRedir(11,d,!0))}).add([66,18,64,76],(a,d)=>{v(a,e.chRedir(12,d,!0))}).add([66,18,64,77],(a,d)=>{v(a,e.chRedir(13,d,!0))}).add([66,18,64,78],(a,d)=>{v(a,e.chRedir(14,d,!0))}).add([66,18,64,79],(a,d)=>{v(a,e.chRedir(15,d,!0))}),this.#Q.add([54,65],(a,d)=>{let l=e.#r.x5=="81"?"05rw":"x5d";e.switchMode(l,!0),e.setPortMode(e.getTrackPort(d),1,w[l]);let r=a[a.length-1],i=a.subarray(0,a.length-1),c=_(i);c!=r&&(console.info(`X5D multi parameters checksum mismatch! Expected ${c}, got ${r}.`),console.debug(a));let n=(a[1]<<7)+a[0],f=(a[3]<<7)+a[2],h=e.chRedir(n&15,d,!0),b=m.cc*h;[()=>{f<1||(f<101?(e.setChType(h,e.CH_MELODIC,w.x5d),e.#i[h]=f-1,e.#e[b+g[0]]=e.#r.x5):f<229?(e.setChType(h,e.CH_MELODIC,w.x5d),e.#i[h]=f-101,e.#e[b+g[0]]=56):(e.setChType(h,e.CH_DRUMS,w.x5d),e.#i[h]=Ve[f-229]||0,e.#e[b+g[0]]=62)),e.pushChPrimitives(h),e.dispatchEvent("voice",{part:h})},()=>{e.#e[b+g[7]]=f},()=>{f<31&&(e.#e[b+g[10]]=Math.round((f-15)*4.2+64))},()=>{e.#e[b+g[93]]=Y(f)},()=>{e.#e[b+g[91]]=Y(f)},()=>{e.#n[h*m.rpn+3]=f>8191?f-16320:64+f,e.#c[m.rpnt*h+2]=1,e.dispatchEvent("pitch",{part:h,pitch:e.getPitchShift(h)})},()=>{e.#n[h*m.rpn+1]=f>8191?f-16320:64+f,e.#c[m.rpnt*h+1]=1,e.dispatchEvent("pitch",{part:h,pitch:e.getPitchShift(h)})},()=>{f>0&&(e.#n[h*m.rpn]=f,e.#c[m.rpnt*h]=1,e.dispatchEvent("pitch",{part:h,pitch:e.getPitchShift(h)}))},()=>{}][n>>4]()}).add([54,76,0],(a,d)=>{e.dispatchEvent("mupromptex");let l=e.#r.x5=="81"?"05rw":"x5d";e.switchMode(l),e.setPortMode(e.getTrackPort(d),1,w[l]);let r="",i=e.#r.x5,c=0,n=0,f="MSB	PRG	LSB	NME";B(a,function(h,b){if(b<16400){let E=b%164;switch(!0){case E<10:{h>31&&(r+=String.fromCharCode(h));break}case E==10:break;case E==11:{f+=`
${i}	${c}	${n}	${r.trim().replace("Init Voice","")}`,c++,r="";break}}c>99&&(i=90,c=0)}}),e.userBank.clearRange({msb:e.#r.x5,prg:[0,99],lsb:0}),e.userBank.load(f),C()&&console.debug(f),e.forceVoiceRefresh()}).add([54,77,0],(a,d)=>{e.dispatchEvent("mupromptex");let l=e.#r.x5=="81"?"05rw":"x5d";e.switchMode(l),e.setPortMode(e.getTrackPort(d),1,w[l]);let r="",i=90,c=0,n=0,f="MSB	PRG	LSB	NME";B(a,function(h,b){if(b<13600){let E=b%136;switch(!0){case E<10:{h>31&&(r+=String.fromCharCode(h));break}case E==11:{f+=`
${i}	${c}	${n}	${r.trim().replace("Init Combi","")}`,c++,r="";break}}}}),e.userBank.clearRange({msb:90,prg:[0,99],lsb:0}),e.userBank.load(f),C()&&console.debug(f),e.forceVoiceRefresh()}).add([54,78],(a,d)=>{let l=e.#r.x5=="81"?"05rw":"x5d";e.switchMode(l),e.setPortMode(e.getTrackPort(d),1,w[l]),console.debug(`X5D mode switch requested: ${["combi","combi edit","prog","prog edit","multi","global"][a[0]]} mode.`)}).add([54,85],(a,d)=>{e.dispatchEvent("mupromptex");let l=e.#r.x5=="81"?"05rw":"x5d";e.switchMode(l),e.setPortMode(e.getTrackPort(d),1,w[l]),B(a,(r,i)=>{i>0&&i<3&&(e.setEffectType(i-1,44,r),e.dispatchEvent(`efx${["reverb","chorus"][i-1]}`,e.getEffectType(i-1)))})}).add([54,104],(a,d)=>{e.dispatchEvent("mupromptex");let l=e.#r.x5=="81"?"05rw":"x5d";e.switchMode(l,!0);let r=e.getTrackPort(d);if(e.#T[r]&&e.#T[r]!=w[l])if(e.#l.dumpLimit==e.DUMP_MODE){console.warn(`Dump cancelled for track ${d}. Port ${String.fromCharCode(65+r)} mode "${D[e.#T[r]]}" mismatch, should be "${l}".`);return}else console.info(`Track ${d} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+r)}.`);e.setPortMode(r,1,w[l]),B(a,function(i,c,n,f){if(c<192){let h=e.chRedir(Math.floor(c/12),d,!0),b=h*m.cc;switch(c%12){case 0:{i<128?(e.setChType(h,e.CH_MELODIC,w.x5d),e.#e[b+g[0]]=e.#r.x5,e.#i[h]=i):(e.setChType(h,e.CH_DRUMS,w.x5d),e.#e[b+g[0]]=62,e.#i[h]=Ve[i-128]),i>0&&e.setChActive(h,1),e.pushChPrimitives(h),e.dispatchEvent("voice",{part:h});break}case 1:{e.#e[b+g[7]]=i;break}case 2:{e.#n[h*m.rpn+3]=i>127?i-192:64+i,e.#c[m.rpnt*h+2]=1,e.dispatchEvent("pitch",{part:h,pitch:e.getPitchShift(h)});break}case 3:{e.#n[h*m.rpn+1]=i>127?i-192:64+i,e.#c[m.rpnt*h+1]=1,e.dispatchEvent("pitch",{part:h,pitch:e.getPitchShift(h)});break}case 4:{i<31&&(e.#e[b+g[10]]=Math.round((i-15)*4.2+64));break}case 5:{let E=i>>4,k=i&15;e.#e[b+g[91]]=Y(k),e.#e[b+g[93]]=Y(E);break}case 10:{e.#s[h]||(e.#e[b+g[0]]=i>>6?56:e.#r.x5,e.pushChPrimitives(h),e.dispatchEvent("voice",{part:h}));break}case 11:{let E=e.chRedir(i&15,d,!0),k=i>>4;e.#g[h]=i,(E!=h||k)&&(console.info(`X5D Part CH${h+1} receives from CH${E+1}.`),e.buildRchTree())}}}else{let h=e.chRedir(c-192,d,!0)}})}),this.#G.add([22,18,127],(a,d,l)=>{e.switchMode("mt32",!0),e.setPortMode(e.getTrackPort(d),1,w.mt32),e.#m=!1,e.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),console.info("MIDI reset: MT-32")}).add([22,18,0],(a,d,l)=>{e.switchMode("mt32");let r=e.chRedir(l,d,!0),i=a[1];a.subarray(2).forEach((c,n)=>{let f=n+i;e.#D[f+(r-1)*16]=c,([!1,()=>{let h=e.#D[r-1<<4];if(h<3){if(e.#d[r]=1,h==2)for(let b=0;b<name.length;b++)e.#w[(r-1)*m.cmt+b]=e.#a[c*m.cmt+b];else{let b=e.baseBank.get(0,c+(h<<6),127,"mt32").name;for(let E=0;E<b.length;E++)e.#w[(r-1)*m.cmt+E]=b.charCodeAt(E)}e.dispatchEvent("voice",{part:r})}},()=>{e.#n[r*m.rpn+3]=c+40,e.#c[m.rpnt*r+2]=1},()=>{e.#n[r*m.rpn+1]=c+14,e.#c[m.rpnt*r+1]=1},()=>{e.#n[r*m.rpn]=c,e.#c[m.rpnt*r]=1},!1,()=>{e.#e[m.cc*r+g[91]]=c?127:0},!1,()=>{e.#e[m.cc*r+g[7]]=c},()=>{e.#e[m.cc*r+g[10]]=Math.ceil(c*9.05)}][f]||(()=>{}))()})}).add([22,18,1],(a,d,l)=>{e.switchMode("mt32");let r=l&7;console.debug(`MT-32 slot #${l+1} Drum: ${a}`);let i=a[0]<<7|a[1];a.subarray(2).forEach((c,n)=>{let f=n+i,h=(f>>2)+24,b=f&3,E=r*m.dpn;if(C()&&console.debug(`MT-32 temp drum note ${h} param ${b}: ${c}`),h<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${h}`);return}[()=>{},()=>{e.#R[(E+L[26])*m.dnc+h]=Math.round(c*1.27)},()=>{e.#R[(E+L[26])*m.dnc+h]=c*9+1&127},()=>{e.#R[(E+L[26])*m.dnc+h]=c?127:0}][b]()})}).add([22,18,2],(a,d,l)=>{e.switchMode("mt32");let r=e.chRedir(l,d,!0),i=a[1]+(a[0]<<7);i<10&&(e.#d[r]=1),a.subarray(2).forEach((c,n)=>{let f=n+i;f<14&&(e.#w[(r-1)*m.cmt+f]=c)}),e.dispatchEvent("voice",{part:r})}).add([22,18,3],(a,d,l)=>{e.switchMode("mt32");let r=l&7;if(a[0]){let i=(a[0]-1<<7)+a[1]-16;a.subarray(2).forEach((c,n)=>{let f=n+i,h=(f>>2)+24,b=f&3,E=r*m.dpn;if(C()&&console.debug(`MT-32 dev drum note ${h} param ${b}: ${c}`),h<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${h}`);return}[()=>{},()=>{e.#R[(E+L[26])*m.dnc+h]=Math.round(c*1.27)},()=>{e.#R[(E+L[26])*m.dnc+h]=c*9+1&127},()=>{e.#R[(E+L[26])*m.dnc+h]=c?127:0}][b]()})}else{let i=a[1];a.subarray(2).forEach((c,n)=>{let f=n+i;e.#D[f]=c;let h=e.chRedir(1+(f>>4),d,!0),b=f&15;([!1,()=>{let E=e.#D[h-1<<4];if(E<3)if(e.#d[h]=1,E==2)for(let k=0;k<name.length;k++)e.#w[(h-1)*m.cmt+k]=e.#a[c*m.cmt+k];else{let k=e.baseBank.get(0,c+(E<<6),127,"mt32").name;for(let x=0;x<k.length;x++)e.#w[(h-1)*m.cmt+x]=k.charCodeAt(x)}e.dispatchEvent("voice",{part:h})},()=>{e.#n[h*m.rpn+3]=c+40,e.#c[m.rpnt*h+2]=1},()=>{e.#n[h*m.rpn+1]=c+14,e.#c[m.rpnt*h+1]=1},()=>{e.#n[h*m.rpn]=c,e.#c[m.rpnt*h]=1},!1,()=>{e.#e[m.cc*h+g[91]]=c?127:0},!1,()=>{e.#e[m.cc*h+g[7]]=c},()=>{e.#e[m.cc*h+g[10]]=Math.ceil(c*9.05)}][b]||(()=>{}))()})}}).add([22,18,4],(a,d,l)=>{e.switchMode("mt32");let r=a[1]+(a[0]<<7),i=[];a.subarray(2).forEach((c,n)=>{let f=n+r,h=e.chRedir(Math.floor(f/246+1),d,!0),b=f%246;b<14&&(e.#w[(h-1)*m.cmt+b]=c),b<10&&(e.#d[h]=1),i.indexOf(h)<0&&i.push(h)}),i.forEach(c=>{e.dispatchEvent("voice",{part:c})})}).add([22,18,5],(a,d,l)=>{e.switchMode("mt32");let r=(a[0]<<7)+a[1];a.subarray(2).forEach((i,c)=>{let n=r+c,f=Math.floor(n/8),h=n&7,b=f*8;e.#Z[n]=i,([!1,()=>{let E=e.#Z[b];if(E<3){let k="";if(E==2){let T=m.cmt*f;k=`MT-m:${i.toString().padStart(3,"0")}`}else k=e.baseBank.get(0,i+(E<<6),127,"mt32").name;e.userBank.clearRange({msb:0,lsb:127,prg:f});let x=`MSB	LSB	PRG	NME
000	127	${f}	${k}`;e.userBank.load(x,!0)}}][h]||(()=>{}))()}),e.forceVoiceRefresh()}).add([22,18,8],(a,d,l)=>{e.switchMode("mt32");let r=((a[0]&1)<<7)+a[1],i=a[0]>>1,c=!1;if(a.subarray(2).forEach((n,f)=>{let h=r+f;h<m.cmt&&(e.#a[i*m.cmt+h]=n,c=!0)}),c){e.userBank.clearRange({msb:0,lsb:127,prg:i});let n=`MSB	LSB	PRG	NME
000	127	${i}	MT-m:${i}`;e.userBank.load(n,!0)}e.forceVoiceRefresh()}).add([22,18,16],(a,d,l)=>{e.switchMode("mt32");let r=a[1],i=!1,c=function(n,f){e.#g[f-12]=n,i=!0};a.subarray(2).forEach((n,f)=>{let h=f+r;([!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,c,c,c,c,c,c,c,c,c,()=>{e.#p=n,e.dispatchEvent("mastervolume",e.#p)}][h]||(()=>{}))(n,f)}),i&&e.buildRchTree()}).add([22,18,32],(a,d,l)=>{e.switchMode("mt32");let r=a[1],i=" ".repeat(r);a.subarray(2).forEach(c=>{c>31?i+=String.fromCharCode(c):i+=" "}),e.#_=i.padStart(20," "),e.#W=Date.now()+3200}).add([22,18,82],(a,d)=>{let l=e.chRedir(0,d,!0);for(let r=0;r<16;r++)e.#P.ano(l+r),r&&r<10&&(e.#i[l+r]=ce[r-1]);console.info("MT-32 alt reset complete.")}),this.#Q.add([66,0],(a,d)=>{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(d),2,w.ns5r),e.#m=!1,console.debug(`NS5R mode switch requested: ${["global","multi","prog edit","comb edit","drum edit","effect edit"][a[0]]} mode.`)}).add([66,1],(a,d)=>{let l=["ns5r","05rw"][a[0]];e.switchMode(l,!0),e.setPortMode(e.getTrackPort(d),2,w[l]),e.#m=!1}).add([66,18,0,0],(a,d)=>{let l=a[0];switch(l){case 124:case 126:case 127:{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(d),2,w.ns5r),e.#m=!1;break}case 125:{e.initDrums(),console.info(`NS5R drum setup reset: ${a}`);break}default:if(l<10){let r=[0,0,0,0],i=(c,n)=>{r[n]=c};if(a.subarray(1).forEach((c,n)=>{[i,i,i,i,()=>{e.#p=c*129/16383*100,e.dispatchEvent("mastervolume",e.#p)},()=>c-64,()=>c-64,()=>{},()=>{},()=>{}][l+n]()}),a[0]<4){let c=0;r.forEach(n=>{c=c<<4,c+=n}),c-=1024}}}}).add([66,18,0,1],(a,d)=>{}).add([66,18,0,2],(a,d)=>{}).add([66,18,1],(a,d)=>{e.dispatchEvent("mupromptex");let l=e.chRedir(a[0],d,!0),r=l*m.cc,i=a[1],c=`NS5R CH${l+1} `;a.subarray(2).forEach((n,f)=>{let h=i+f;h<3?([()=>{e.#e[r+g[0]]=n||U.bank0,e.pushChPrimitives(l)},()=>{e.#e[r+g[32]]=n,e.pushChPrimitives(l)},()=>{e.#i[l]=n}][h](),e.dispatchEvent("voice",{part:l})):h<8||(h<14?[()=>{let b=e.chRedir(n,d,!0);e.#g[l]=b,l!=b&&(e.buildRchTree(),console.info(`${c}receives from CH${b+1}`))},()=>{e.#v[l]=+!n},()=>{e.setChType(l,n,w.ns5r),console.debug(`${c}type: ${W[n]}`)},()=>{e.#n[m.rpn*l+3]=n,e.#c[m.rpnt*l+2]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)})},()=>{},()=>{}][h-8]():h<16||(h<33?[()=>{e.#e[r+g[7]]=n},()=>{e.#e[r+g[11]]=n},()=>{},()=>{},()=>{e.#e[r+g[10]]=n||128},()=>{},()=>{},()=>{e.#e[r+g[93]]=n},()=>{e.#e[r+g[91]]=n},()=>{e.#e[r+g[76]]=n},()=>{e.#e[r+g[77]]=n},()=>{e.#e[r+g[78]]=n},()=>{e.#e[r+g[74]]=n},()=>{e.#e[r+g[71]]=n},()=>{e.#e[r+g[73]]=n},()=>{e.#e[r+g[75]]=n},()=>{e.#e[r+g[72]]=n}][h-16]():h<112||h<114&&[()=>{e.#e[r+g[5]]=n},()=>{e.#e[r+g[65]]=n}][h-112]()))})}).add([66,18,8,0],(a,d)=>{let l=a[0];if(l<32)e.setLetterDisplay(a.subarray(1,33),"NS5R letter display");else{let r=l-32;e.#k=Date.now()+3200,e.#f=10,e.#$.fill(0);let i=a.subarray(1),c=4;i.forEach(function(n,f){let h=f+r,b=h>>4,E=h&15;if(h<80){let k=b<c?n:n>>3,x=0,T=b<c?6:3;for(;k>0;)e.#$[E*32+b*7+(T-x)]=k&1,k=k>>1,x++}})}}).add([66,18,48],(a,d,l)=>{u(0,a)}).add([66,18,49],(a,d,l)=>{u(1,a)}).add([66,18,50],(a,d,l)=>{u(2,a)}).add([66,18,51],(a,d,l)=>{u(3,a)}).add([66,18,52],(a,d,l)=>{u(4,a)}).add([66,18,53],(a,d,l)=>{u(5,a)}).add([66,18,54],(a,d,l)=>{u(6,a)}).add([66,18,55],(a,d,l)=>{u(7,a)}).add([66,52],(a,d)=>{e.switchMode("ns5r"),e.#m=!1;let l="";B(a,(r,i)=>{i<8?(r>31&&(l+=String.fromCharCode(r)),i==7&&(e.aiEfxName=l)):i<10&&(e.setEffectType(i-8,44,r),e.dispatchEvent(`efx${["reverb","chorus"][i-8]}`,e.getEffectType(i-8)))})}).add([66,53],(a,d)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r"),e.#m=!1;let l="",r=a[a.length-1],i=a.subarray(0,a.length-1),c=_(i);c!=r&&(console.info(`NS5R current multi dump checksum mismatch! Expected ${c}, got ${r}.`),console.debug(a));let n=e.getTrackPort(d);if(e.#T[n]&&e.#T[n]!=w.ns5r)if(e.#l.dumpLimit==e.DUMP_MODE){console.warn(`Dump cancelled for track ${d}. Port ${String.fromCharCode(65+n)} mode "${D[e.#T[n]]}" mismatch, should be "ns5r".`);return}else console.info(`Track ${d} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+n)}.`);e.setPortMode(n,2,w.ns5r),B(i,function(f,h){switch(!0){case h<2944:{let b=e.chRedir(Math.floor(h/92),d,!0),E=b*m.cc;switch(h%92){case 0:{e.#e[E+g[0]]=f,e.pushChPrimitives(b),e.dispatchEvent("voice",{part:b});break}case 1:{e.#e[E+g[32]]=f,!f&&!e.#e[E+g[0]]&&(e.#e[E+g[0]]=U.bank0),e.pushChPrimitives(b),e.dispatchEvent("voice",{part:b});break}case 2:{e.#i[b]=f,f>0&&e.setChActive(b,1),e.dispatchEvent("voice",{part:b});break}case 3:{let k=e.chRedir(f,d,!0);e.#g[b]=k,b!=k&&(console.info(`NS5R CH${b+1} receives from CH${k+1}.`),e.buildRchTree());break}case 7:{e.#s[b]=f,e.dispatchEvent("voice",{part:b});break}case 8:{e.#n[b*m.rpn+3]=f<40||f>88?f+(f>63?-192:64):f,e.#c[m.rpnt*b+2]=1,e.dispatchEvent("pitch",{part:b,pitch:e.getPitchShift(b)});break}case 9:case 10:{e.#e[E+g[7]]=f;break}case 11:{e.#e[E+g[11]]=f;break}case 14:{e.#e[E+g[10]]=f||128;break}case 19:{e.#e[E+g[93]]=f;break}case 20:{e.#e[E+g[91]]=f;break}case 84:{e.#e[E+g[65]]=f;break}case 85:{e.#e[E+g[5]]=f;break}}break}case h<3096:break;case h<3134:{let b=h-3096;b<8?(f>31&&(l+=String.fromCharCode(f)),b==7&&(e.aiEfxName=l)):b<10&&(e.setEffectType(b-8,44,f),e.dispatchEvent(`efx${["reverb","chorus"][b-8]}`,e.getEffectType(b-8)));break}case h<8566:break}})}).add([66,54],(a,d)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r");let l="",r=80,i=0,c=0,n="MSB	PRG	LSB	NME";B(a,function(f,h){let b=h%158;switch(!0){case b<10:{f>31&&(l+=String.fromCharCode(f));break}case b==10:break;case b==11:{r=f&127;break}case b==12:{c=f&127;break}case b==13:{n+=`
${r}	${i}	${c}	${l.trim().replace("Init Voice","")}`,i++,l="";break}}}),e.userBank.clearRange({msb:80,lsb:0}),e.userBank.load(n),C()&&console.debug(n),e.forceVoiceRefresh()}).add([66,55],(a,d)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r");let l="",r=88,i=0,c=0,n="MSB	PRG	LSB	NME";B(a,function(f,h){let b=h%126;switch(!0){case b<10:{f>31&&(l+=String.fromCharCode(f));break}case b==11:break;case b==12:break;case b==13:{n+=`
${r}	${i}	${c}	${l.trim().replace("Init Combi","")}`,i++,l="";break}}}),e.userBank.clearRange({msb:88,lsb:0}),e.userBank.load(n),C()&&console.debug(n),e.forceVoiceRefresh()}).add([66,125],(a,d,l)=>{e.dispatchEvent("backlight",["green","orange","red",!1,"yellow","blue","purple"][a[0]]||"white")}).add([66,127],(a,d,l)=>{let r=a[a.length-1],i=a.subarray(0,a.length-1),c=_(i);c!=r&&(console.info(`NS5R screen dump checksum mismatch! Expected ${c}, got ${r}.`),console.debug(a));let n=new Uint8Array(5760);B(a,(f,h,b)=>{if(h<720)for(let E=0;E<8;E++)n[h*8+E]=f>>7-E&1}),e.dispatchEvent("screen",{type:"ns5r",data:n})}).add([76],(a,d,l)=>{e.#Q.run([66,...a],d,l)}),this.#oe.add([16,0,8,0],(a,d,l)=>{let r=(a[2]<<4)+a[3],i="K11 ";([()=>{e.switchMode("k11",!0),e.setPortMode(e.getTrackPort(d),2,w.k11),e.#m=!1,e.#u[w.k11][1]=r?4:0,console.info("MIDI reset: GMega/K11")},()=>{e.setEffectType(0,24,r),console.debug(`${i}reverb type: ${r}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{console.debug(`${i}reverb time: ${r}`)},()=>{console.debug(`${i}reverb time: ${r}`)},()=>{console.debug(`${i}reverb predelay: ${r}`)},()=>{console.debug(`${i}reverb predelay: ${r}`)},()=>{console.debug(`${i}depth high: ${r}`)},()=>{console.debug(`${i}depth high: ${r}`)},()=>{console.debug(`${i}depth low: ${r}`)},()=>{console.debug(`${i}depth low: ${r}`)}][a[0]]||(()=>{}))()}).add([16,0,8,1],(a,d,l)=>{e.dispatchEvent("mupromptex");let r=e.chRedir(a[1],d,!0),i=m.cc*r,c=m.rpn*r,n=(a[3]<<4)+a[4],f=`K11 CH${r+1} `;([()=>{n<128?(e.setChType(r,e.CH_MELODIC,w.k11),e.#e[i+g[0]]=0,e.#i[r]=n):(e.setChType(r,e.CH_DRUMS,w.k11),e.#i[r]=n-128),e.pushChPrimitives(r),e.dispatchEvent("voice",{part:r})},()=>{let h=e.chRedir(n,d,!0);e.#g[r]=h,r!=h&&(e.buildRchTree(),console.info(`${f}receives from CH${h+1}`))},()=>{e.#e[i+g[7]]=n},()=>{uupThis.setChActive(r,n)},()=>{e.#e[i+g[10]]=n},()=>{e.#n[c+3]=n+40,e.#c[m.rpnt*r+2]=1,e.dispatchEvent("pitch",{part:r,pitch:e.getPitchShift(r)})},()=>{e.#n[c+1]=n>>1,e.#n[c+2]=n&1,e.#c[m.rpnt*r+1]=1,e.dispatchEvent("pitch",{part:r,pitch:e.getPitchShift(r)})},()=>{e.#e[i+g[91]]=n?127:0},()=>{},()=>{e.#e[i+g[74]]=n},()=>{e.#e[i+g[73]]=n},()=>{e.#e[i+g[72]]=n}][a[0]]||(()=>{}))()}).add([16,0,9,0],(a,d,l)=>{e.dispatchEvent("mupromptex");let r=(a[2]<<4)+a[3],i="GMLX ";([()=>{console.debug(`${i}reverb type: ${r}`)},()=>{console.debug(`${i}reverb time: ${r}`)},()=>{console.debug(`${i}reverb predelay: ${r}`)},()=>{console.debug(`${i}depth high: ${r}`)},()=>{console.debug(`${i}depth low: ${r}`)}][a[0]]||(()=>{}))()}).add([16,0,9,3],(a,d,l)=>{e.dispatchEvent("mupromptex");let r=(a[2]<<4)+a[3],i=e.chRedir(a[1],d,!0),c=i*m.cc;[()=>{r<128?(e.setChType(i,e.CH_MELODIC,w.k11),e.#e[c+g[0]]=0,e.#e[c+g[32]]=0,e.#i[i]=r):r<160?(e.setChType(i,e.CH_MELODIC,w.k11),e.#e[c+g[0]]=0,e.#e[c+g[32]]=7,e.#i[i]=r-100):(e.setChType(i,e.CH_DRUMS,w.k11),e.#e[c+g[0]]=122,e.#e[c+g[32]]=0,e.#i[i]=r-160),e.pushChPrimitives(i),e.dispatchEvent("voice",{part:i})},()=>{let n=e.chRedir(r,d,!0);e.#g[i]=n,i!=n&&(e.buildRchTree(),console.info(`GMLX CH${i+1} receives from CH${n+1}`))}][a[0]]()}).add([16,0,9,4],(a,d,l)=>{e.dispatchEvent("mupromptex");let r=(a[2]<<4)+a[3],i=e.chRedir(a[1],d,!0),c=i*m.cc,n=i*m.rpn,f=`GMLX CH${i+1} `;[()=>{e.setChActive(i,r)},()=>{e.#e[c+g[7]]=r},()=>{e.#e[c+g[10]]=r},()=>{e.#e[c+g[91]]=r?127:0},()=>{e.#n[n+3]=r+40,e.#c[m.rpnt*i+2]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{e.#n[n+1]=r,e.#c[m.rpnt*i+1]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{e.#n[n]=r,e.#c[m.rpnt*i]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{}][a[0]]()}),this.#le.add([66,93,64],(a,d,l)=>{let r=a[2];switch(a[0]){case 0:{switch(a[1]){case 4:{e.dispatchEvent("mupromptex"),e.#p=r*129/16383*100,e.dispatchEvent("mastervolume",e.#p);break}case 5:{e.dispatchEvent("mupromptex"),r-64;break}case 6:{e.dispatchEvent("mupromptex"),console.debug(`SG global reverb: ${r?"on":"off"}`);break}case 127:{e.switchMode("sg",!0),e.setPortMode(e.getTrackPort(d),1,w.sg);break}}break}case 1:{switch(a[1]){case 48:{e.dispatchEvent("mupromptex"),console.debug(`SG reverb type: ${se[r]}`);break}}break}default:if(a[0]>>4==1){e.dispatchEvent("mupromptex");let i=e.chRedir(a[0]&15,d,!0);if(a[1]==2){let c=e.chRedir(r,d,!0);e.#g[i]=c,i!=c&&(e.buildRchTree(),console.info(`SG CH${i+1} receives from CH${c+1}`))}else a[1]==19&&(e.#e[m.cc*i+g[7]]=r)}else console.warn(`Unknown AKAI SG SysEx: ${a}`)}}),this.#de.add([9],(a,d,l)=>{e.dispatchEvent("mupromptex"),console.debug(`GZ set effect: ${["stage reverb","hall reverb","room reverb","chorus","tremolo","phaser","rotary speaker","enhancer","flanger","EQ"][a[0]]||"off"}`)}),this.#H.add([127,0],(a,d,l)=>{e.switchMode("motif");let r=new Uint8Array([127,1,...a]);e.#H.run(r,d,l)}).add([127,1,0,0],(a,d,l)=>{e.switchMode("s90es");let r="S90/Motif ES system ",i=a[0];a.subarray(1).forEach((c,n)=>{([()=>{e.#p=c*12900/16383,e.dispatchEvent("mastervolume",e.#p)}][i+n]||(()=>{console.info(`Unrecognized ${r}ID: ${i+n}`)}))()})}).add([127,1,0,36,54,1],(a,d,l)=>{e.switchMode("s90es");let r="S90/Motif ES reverb ",i=a[0];a.subarray(1).forEach((c,n)=>{([()=>{e.setEffectTypeRaw(0,!1,c&15|112)},()=>{e.setEffectTypeRaw(0,!0,c)}][i+n]||(()=>{}))()}),e.dispatchEvent("efxreverb",e.getEffectType(0))}).add([127,1,0,37,54,2],(a,d,l)=>{e.switchMode("s90es");let r="S90/Motif ES chorus ",i=a[0];a.subarray(1).forEach((c,n)=>{([()=>{e.setEffectTypeRaw(1,!1,c&15|112)},()=>{e.setEffectTypeRaw(1,!0,c)}][i+n]||(()=>{}))()}),e.dispatchEvent("efxchorus",e.getEffectType(1))}).add([127,1,0,34,54,3],(a,d,l)=>{e.switchMode("s90es");let r="S90/Motif ES insert 1 ",i=a[0];a.subarray(1).forEach((c,n)=>{([()=>{e.setEffectTypeRaw(3,!1,c&15|112)},()=>{e.setEffectTypeRaw(3,!0,c)}][i+n]||(()=>{}))()}),e.dispatchEvent("efxinsert0",e.getEffectType(3))}).add([127,1,0,34,54,4],(a,d,l)=>{e.switchMode("s90es");let r="S90/Motif ES insert 2 ",i=a[0];a.subarray(1).forEach((c,n)=>{([()=>{e.setEffectTypeRaw(4,!1,c&15|112)},()=>{e.setEffectTypeRaw(4,!0,c)}][i+n]||(()=>{}))()}),e.dispatchEvent("efxinsert1",e.getEffectType(4))}).add([127,1,0,35,54,17],(a,d,l)=>{e.switchMode("s90es");let r="S90/Motif ES variation ",i=a[0];a.subarray(1).forEach((c,n)=>{([()=>{e.setEffectTypeRaw(2,!1,c&15|112)},()=>{e.setEffectTypeRaw(2,!0,c)}][i+n]||(()=>{}))()}),e.dispatchEvent("efxdelay",e.getEffectType(2))}).add([127,1,0,58,55],(a,d,l)=>{e.dispatchEvent("mupromptex"),e.switchMode("s90es");let r=e.getTrackPort(d);if(e.#T[r]&&e.#T[r]!=e.#r.smotif)if(e.#l.dumpLimit==e.DUMP_MODE){console.warn(`Dump cancelled for track ${d}. Port ${String.fromCharCode(65+r)} mode "${D[e.#T[r]]}" mismatch, should be "${D[e.#r.smotif]}".`);return}else console.info(`Track ${d} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+r)}.`);let i=e.chRedir(a[0],d,!0),c=m.cc*i,n=a[1];a[0]>15&&(i=a[0]+32);let f=`Track ${d} S90/Motif ES bulk CH${i<128?i+1:"U"+(i-127)} `;console.debug(f,a),!(a[0]>15)&&a.subarray(2).forEach((h,b)=>{([()=>{e.#e[c+g[0]]=h,e.pushChPrimitives(i),e.dispatchEvent("voice",{part:i})},()=>{h&&e.setChActive(i,1),e.#e[c+g[32]]=h,e.getChPrimitive(i,1)==63&&e.setChType(i,[32,40].indexOf(h)>-1?e.CH_DRUMS:e.CH_MELODIC,e.#t,!0),e.pushChPrimitives(i),e.dispatchEvent("voice",{part:i})},()=>{h&&e.setChActive(i,1),e.#i[i]=h,e.dispatchEvent("voice",{part:i})},()=>{let E=e.chRedir(h,d,!0);e.#g[i]=E,i!=E&&(e.buildRchTree(),console.info(`${f}receives from CH${E+1}`))},()=>{e.#v[i]=h?0:1},!1,!1,!1,!1,!1,!1,!1,!1,()=>{h!=100&&e.setChActive(i,1),e.#e[c+g[7]]=h},()=>{h!=64&&e.setChActive(i,1),e.#e[c+g[10]]=h},!1,!1,!1,()=>{e.#e[c+g[91]]=h},()=>{h&&e.setChActive(i,1),e.#e[c+g[93]]=h},()=>{h&&e.setChActive(i,1),e.#e[c+g[94]]=h},()=>{h!=127&&e.setChActive(i,1),e.#e[c+g[128]]=h,e.allocateAce(i,128)},()=>{},()=>{h!=64&&e.setChActive(i,1),e.#e[c+g[74]]=h},()=>{h!=64&&e.setChActive(i,1),e.#e[c+g[71]]=h},!1,()=>{e.#e[c+g[65]]=h},()=>{e.#e[c+g[5]]=h},()=>{}][n+b]||(()=>{}))()})}).add([127,1,54,16],(a,d,l)=>{e.switchMode("s90es");let r=a[0];a.subarray(1).forEach((i,c)=>{let f=`S90/Motif ES EQ${(c>>2)+1} `;([()=>{let h=i-64},()=>{let h=F[i]},()=>{let h=i/10},()=>{let h=i}][r+c&3]||(()=>{}))()})}),this.#G.add([0,72,18,0,0,0,0],(a,d,l)=>{e.switchMode("sd",!0),e.setPortMode(e.getTrackPort(d),2,w.sd),console.info("MIDI reset: SD")}).add([0,72,18,16,0],(a,d,l)=>{e.dispatchEvent("mupromptex");let r=a[0]>>5,i=a[0]&31;switch(r){case 0:{let c=a[0]>>1,n=a[1];switch(c){case 1:{a.subarray(2).forEach((f,h,b)=>{let E=h+n;switch(E){case 0:{f&&(e.setEffectType(1,60,f-1),e.dispatchEvent("efxchorus",e.getEffectType(1)),console.debug(`SD MFX Cho: ${E} - ${f}`));break}}});break}case 2:{a.subarray(2).forEach((f,h)=>{let b=h+n;switch(b){case 0:{f&&(e.setEffectType(0,55+f,0),e.dispatchEvent("efxreverb",e.getEffectType(0)),console.debug(`SD MFX Rev: ${b} - ${f}`));break}}});break}case 3:case 4:case 5:{let f=c-1;a.subarray(2).forEach((h,b)=>{let E=b+n;switch(console.debug(`SD MFX ${f-2}: ${E} - ${h}`),E){case 0:{e.setEffectTypeRaw(f,62,h),e.dispatchEvent(`efx${f>2?"delay":"insert"+(f-4)}`,e.getEffectType(f));break}}}),console.debug(`SD MFX message:
%o`,a);break}default:console.debug(`Unknown SD-90 global effects message:
%o`,a)}break}case 1:{let c=e.chRedir(i,d,!0),n=a[1],f=c*m.cc;a.subarray(2).forEach((h,b)=>{let E=n+b;E<37?([()=>{},()=>{},0,()=>{},()=>{switch(e.#e[f+g[0]]=h,h){case 104:case 105:case 106:case 107:case 120:{e.#s[c]||e.setChType(c,e.CH_DRUMS);break}default:e.#s[c]&&e.setChType(c,e.CH_MELODIC)}e.pushChPrimitives(c),e.dispatchEvent("voice",{part:c})},()=>{e.#e[f+g[32]]=h,e.pushChPrimitives(c),e.dispatchEvent("voice",{part:c})},()=>{e.#i[c]=h,e.dispatchEvent("voice",{part:c})},()=>{e.#e[f+g[7]]=h},()=>{e.#e[f+g[10]]=h},()=>{},()=>{},()=>{h<2&&(e.#v[c]=h)},()=>{h<2&&(e.#e[f+g[68]]=h?127:0)},()=>{},()=>{h<2&&(e.#e[f+g[65]]=h?127:0)},()=>{e.#e[f+g[5]]=h&15<<4|e.#e[f+g[5]]&15},()=>{e.#e[f+g[5]]=h&15|(e.#e[f+g[5]]&240)>>4},()=>{e.#e[f+g[74]]=h},()=>{e.#e[f+g[71]]=h},()=>{e.#e[f+g[73]]=h},()=>{e.#e[f+g[72]]=h},0,0,0,0,0,0,0,()=>{e.#e[f+g[128]]=h,e.allocateAce(128)},()=>{e.#e[f+g[93]]=h},()=>{e.#e[f+g[91]]=h},0,0,()=>{e.#e[f+g[75]]=h},()=>{e.#e[f+g[76]]=h},()=>{e.#e[f+g[77]]=h},()=>{e.#e[f+g[78]]=h}][E]||(()=>{}))():E<63||(E<64?(e.#s[c]?e.#e[f+g[0]]=104|h:e.#e[f+g[0]]=96|h,e.dispatchEvent("voice",{part:c})):console.debug(`Unknown SD-90 global CH${c+1} param setup message:
%o`,a))});break}case 2:{let c=e.chRedir(i,d,!0),n=a[1];console.debug(`Unknown SD-90 global CH${c+1} MIDI setup message:
%o`,a.subarray(2));break}default:console.warn(`Unknown SD-90 global part setup message:
%o`,a)}}),e.#Q.add([0,1,73,78],(a,d,l)=>{e.switchMode("krs"),e.setPortMode(e.getTrackPort(d),1,w.krs),console.debug("Might be KORG KROSS 2 mode reset... Not sure.")}).add([0,1,73,117,2,37],(a,d,l)=>{e.switchMode("krs");let r=e.getTrackPort(d);if(e.#T[r]&&e.#T[r]!=w.krs)if(e.#l.dumpLimit==e.DUMP_MODE){console.warn(`Dump cancelled. Port ${String.fromCharCode(65+r)} mode "${D[e.#T[r]]}" mismatch, should be "krs".`);return}else console.info(`Track ${d} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+r)}.`);e.setPortMode(e.getTrackPort(d),1,w.krs);let i="KROSS 2 BMT1 ",c="";B(a,(n,f)=>{if(f<24)c+=String.fromCharCode(Math.max(32,n));else if(!(f<1276)){let h=f-1276,b=e.chRedir(Math.floor(h/44),d,!0),E=h%44,k=m.cc*b;E<15?([()=>{n&&e.setChActive(b,1),e.#i[b]=n,e.dispatchEvent("voice",{part:b})},()=>{n&&e.setChActive(b,1),n<10?(e.#e[k+g[0]]=63,e.#e[k+g[32]]=n):n<20?(e.#e[k+g[0]]=121,e.#e[k+g[32]]=n-10):n<24&&(e.#e[k+g[0]]=[120,0,56,62][n-20],e.#e[k+g[32]]=0),e.pushChPrimitives(b),e.dispatchEvent("voice",{part:b})},()=>{let x=e.chRedir(n&15,d,!0);e.#g[b]=x,console.info(`${i}CH${b+1} receives from CH${x+1}`)},!1,!1,()=>{e.#e[k+g[7]]=n},!1,()=>{},()=>{},!1,!1,!1,!1,!1,()=>{e.#e[k+g[10]]=n||128}][E]||(()=>{}))():E<36||([()=>{e.#e[k+g[74]]=(n+128&255)-64},()=>{e.#e[k+g[71]]=(n+128&255)-64},!1,!1,()=>{e.#e[k+g[73]]=(n+128&255)-64},()=>{e.#e[k+g[75]]=(n+128&255)-64},!1,()=>{e.#e[k+g[72]]=(n+128&255)-64}][E]||(()=>{}))()}}),c=c.trimRight(),e.dispatchEvent("metacommit",{type:"EORTitle",data:c})})}};var pe=nt(Xe(),1);var Ge=class{#t=!1;constructor(e,t,s,o){this.#t=e,this.start=t,this.end=s,this.data=o}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#t}},he=class extends Ge{constructor(e,t,s){super(!0,e,t,s)}},_e=class extends Ge{constructor(e,t){super(!1,e,e,t)}},ue=class extends Array{#t=-1;constructor(){super(...arguments)}resetIndex(e){this.#t=-1}fresh(){this.sort(function(e,t){return e.start==t.start?0:(+(e.start>t.start)<<1)-1}),this.forEach(function(e,t){e.index=t})}step(e,t=!1){let s=[];if(t)for(let o=0;o<this.length&&!(this[o].start>e);o++){if(this[o].end<e)continue;s.push(this[o])}else{let o=this.getRange(this.#t==-1?0:e-1,e),u=this;o.forEach(function(p){p.index>u.#t&&(s.push(p),u.#t=p.index)})}return s}getRange(e,t){e>t&&([e,t]=[t,e]);let s=[],o=-1,u=Math.ceil(Math.sqrt(this.length)),p=!0;for(let y=0;y<this.length;y+=u)this[y+u]?o<0&&this[y+u].start>=e&&(o=y):o=o<0?y:o;for(;p;)this[o]?.end<t?this[o].start>=e&&s.push(this[o]):p=!1,o++;return s}};var Tt=0xffffffffffff,Fe=function(e){let t=new ue,s=this,o=e.timeDivision,u=120,p=new ue,y=0,v=0;p.push(new he(0,Tt,[120,0])),e.track.forEach(function(r){y=0,r.event.forEach(function(i){y+=i.deltaTime,i.type==255&&i?.metaType==81&&(u=6e7/i.data,p[p.length-1]&&p.push(new he(y,0xffffffffffff,[u,0])))})}),p.fresh(),p.forEach(function(r,i,c){i>0&&(c[i-1].end=r.start)});let a=120;p.forEach(function(r,i,c){i>0&&(r.end==r.start?c.splice(c.indexOf(r),1):a==r.data[0]&&(c[i-1].end=r.end,c.splice(c.indexOf(r),1)),a=r.data[0])});let d=0,l=120;return p.forEach(function(r){let i=r.start,c=i/l/o*60+d;l=r.data[0],d=c-i/l/o*60,r.data[1]=d}),console.debug("All tempo changes: ",p),u=120,y=0,v=0,e.track.forEach(function(r,i){y=0,v=0;let c=i+1;r.event.forEach(function(n,f){y+=n.deltaTime;let h=p.step(y,!0)[0];h&&(u=h.data[0],v=h.data[1]);let b={type:n.type,data:n.data,track:c,part:0};n.type>14?b.meta=n.metaType:b.part=n.channel,t.push(new _e(y/u/o*60+v,b))})}),t.fresh(),self.midiEvents=t,console.debug(`Parsed a type ${e.formatType} MIDI sequence.`),t};pe.default.customInterpreter=Re;var S=function(e,t,s){e.addEventListener(s,o=>{t.dispatchEvent(s,o.data)})},Ke=class extends J{device;#t;#f={};#k=[];#C="";#$=[];#h=[];#g=new Uint8ClampedArray(128);#s=new Uint8ClampedArray(128);#e=.5;#b=120;#i=4;#y=4;#v=0;#o=0;#E=new Array(m.ch);#x=new Uint8Array(m.ch);smoothingAtk=0;smoothingDcy=0;reset(){let e=this;e.dispatchEvent("reset"),e.#t?.resetIndex(),e.device.init(),e.#C="",e.#e=.5,e.#b=120,e.#i=4,e.#y=4,e.#v=0,e.#o=0,e.dispatchEvent("tempo",e.#b),e.dispatchEvent("title",e.#C)}init(){this.reset(),this.#t=void 0}async loadFile(e){this.#t=Fe(pe.default.parse(new Uint8Array(await e.arrayBuffer())))}async loadMap(e,t,s){let o=this,u=0,p=0,y=0,v=0,a,d;e.split(`
`).forEach((l,r)=>{if(!l)return;let i=l.split("	");if(r){if(!v)return;let c="",n="";i.forEach((h,b)=>{switch(b){case a:{c=h;break}case d:{n=h;break}}});let f=!1;o.#f[c]?.priority>s&&(f=!0,y++),!o.#f[c]||f||t?(o.#f[c]={name:n,priority:s},u++):self.debugMode&&console.debug(`Voice "${n}" (${c}) seems to be in conflict with (${o.#f[c]}).`),p++}else i.forEach((c,n)=>{switch(c){case"ID":{a=n,v++;break}case"Name":{d=n,v++;break}default:console.debug(`Unknown map field: ${c}`)}})}),console.debug(`Voice names: ${p} total, ${u} loaded (${u-y} + ${y}).`),o?.device.forceVoiceRefresh()}async loadMapPaths(e){let t=this;e.forEach(async(s,o)=>{t.loadMap(await(await fetch(s)).text(),0,o)})}async loadEfx(e,t){let s=this,o=0,u=0,p,y,v;e.split(`
`).forEach((a,d)=>{if(a)if(d){let l=0,r;a.split("	").forEach((i,c)=>{switch(c){case p:{l|=parseInt(i,16)<<8;break}case y:{l|=parseInt(i,16);break}case v:{r=i;break}}}),!s.#k[l]||t?(s.#k[l]=r,o++):self.debugMode&&console.debug(`EFX ID 0x${l.toString(16).padStart(4,"0")} (${r}) seems to be in conflict.`),u++}else a.split("	").forEach((l,r)=>{switch(l){case"MSB":{p=r;break}case"LSB":{y=r;break}case"Name":{v=r;break}default:console.debug(`Unknown EFX field: ${l}`)}})}),console.debug(`EFX: ${u} total, ${o} loaded.`),s.dispatchEvent("efxreverb",s.device.getEffectType(0)),s.dispatchEvent("efxchorus",s.device.getEffectType(1)),s.dispatchEvent("efxdelay",s.device.getEffectType(2)),s.dispatchEvent("efxinsert0",s.device.getEffectType(3)),s.dispatchEvent("efxinsert1",s.device.getEffectType(4)),s.dispatchEvent("efxinsert2",s.device.getEffectType(5)),s.dispatchEvent("efxinsert3",s.device.getEffectType(6))}switchMode(e,t=!1){this.device.switchMode(e,t)}getMode(){return this.device.getMode()}getVoice(){return this.device.getVoice(...arguments)}getChVoice(e){return this.device.getChVoice(e)}getMapped(e){return this.#f[e]?.name||e}getEfx([e,t]){let s=e<<8|t;return this.#k[s]||`0x${s.toString(16).padStart(4,"0")}`}getVoxBm(e){if(!e)throw new Error("Voice object must be valid");let t=this;if(!t.voxBm)throw new Error("Voice bitmap repository isn't yet initialized");let s=t.voxBm.getBm(e.name);if(!s)switch(e.mode){case"xg":{switch(e.sid[0]){case 0:case 80:case 81:case 83:case 84:case 96:case 97:case 99:case 100:{s=t.voxBm.getBm(t.getVoice(U.bank0,e.sid[1],U.bank0,e.mode).name);break}}break}case"g2":case"sd":{switch(e.sid[0]){case 96:case 97:case 98:case 99:{s=t.voxBm.getBm(t.getVoice(U.bank0,e.sid[1],U.bank0,e.mode).name);break}case 104:case 105:case 106:case 107:{s=t.voxBm.getBm(t.getVoice(120,e.sid[1],U.bank0,e.mode).name);break}}break}case"gs":case"sc":case"k11":case"sg":case"gm":{switch(e.sid[0]){case 120:break;case 122:case 127:{s=t.voxBm.getBm(t.getVoice(120,e.sid[1],0,e.mode).name);break}default:s=t.voxBm.getBm(t.getVoice(0,e.sid[1],0,e.mode).name)}break}default:switch(e.sid[0]){case 56:{s=t.voxBm.getBm(t.getVoice(0,e.sid[1],0,e.mode).name);break}}}return s||(s=t.voxBm.getBm(t.getVoice(e.sid[0],e.sid[1],0,e.mode).name)),s}getChBm(e,t){let s=this;t=t||s.getChVoice(e);let o=s.getVoxBm(t);if(!o){if(!s.sysBm)return;switch(t.mode){case"xg":{switch(t.sid[0]){case 126:{t.sid[1]>>1==56&&(o=s.sysBm.getBm("cat_smpl"));break}case 16:{o=s.sysBm.getBm("cat_smpl");break}case 64:case 67:{o=s.sysBm.getBm("cat_sfx");break}case 32:case 33:case 34:case 35:case 36:case 48:case 82:{o=s.sysBm.getBm("cat_xg");break}}break}default:switch(t.sid[0]){case 63:case 32:case 33:case 34:case 35:case 36:case 48:case 82:{o=s.sysBm.getBm("cat_mex");break}}}}return o||(s.device.getChType()[e]?o=s.sysBm.getBm("cat_drm"):o=s.sysBm.getBm("no_vox")),o}get noteProgress(){return this.#o/this.#e}get noteOverall(){return this.noteProgress-this.#v}get noteBar(){return Math.floor(this.noteOverall/this.#i)}get noteBeat(){let e=this.noteOverall%this.#i;return e<0&&(e+=this.#i),e}get noteOffset(){return this.#v}getTimeSig(){return[this.#i,this.#y]}getTempo(){return this.#b}eachVoice(e){this.#E.forEach(e)}sendCmd(e){this.device.runJson(e)}render(e){e>this.#o&&(this.#o=e);let t=this.#t?.step(e)||[],s=0,o=0,u=new Set,p={},y=[],v=this,a=[];for(v.device.getStrength().forEach((x,T)=>{v.#s[T]=x}),v.device.newStrength(),t.forEach(function(x){let T=x.data,M=v.device.runJson(T);switch(M?.reply){case"meta":{a.push(M);break}}M?.reply&&delete M.reply});v.#h.length>0;){let x=v.#h.shift(),T=x.part<<7|x.note;x.state?(u.add(T),p[T]=x.velo):u.has(T)&&(y.push({part:x.part,note:x.note,velo:p[T],state:v.device.NOTE_SUSTAIN}),s++,o+=v.#x[x.part])}a?.length>0&&v.dispatchEvent("meta",a);let d=v.device.getActive(),l=[],r=v.device.getPitch(),i=v.device.getCcAll(),c=v.device.getProgram(),n=v.device.getChType(),f=[],h=v.device.getStrength();h.forEach(function(x,T,M){M[T]=Math.max(v.#s[T],x);let V=M[T]-v.#g[T],P=g.length*T;if(V>=0){let N=4*.25**(i[P+g[73]]/64);v.#g[T]+=Math.ceil(V-V*v.smoothingAtk**N)}else{let N=4*.25**(i[P+g[72]]/64);v.#g[T]+=Math.floor(V-V*v.smoothingDcy**N)}});let b=0,E=0;return d.forEach(function(x,T){x&&(l[T]=v.device.getVel(T),f[T]=v.device.getExt(T),b+=l[T].size,E+=l[T].size*v.#x[T])}),{extraPoly:s,extraPolyEC:o,extraNotes:y,curPoly:b,curPolyEC:E,chInUse:d,chKeyPr:l,chPitch:r,chProgr:c,chContr:i,chType:n,chExt:f,eventCount:t.length,title:v.#C,bitmap:v.device.getBitmap(),letter:v.device.getLetter(),texts:v.device.getTexts(),master:v.device.getMaster(),mode:v.device.getMode(),strength:v.#g.slice(),velo:h,rpn:v.device.getRpn(),tSig:v.getTimeSig(),tempo:v.getTempo(),noteBar:v.noteBar,noteBeat:v.noteBeat,ace:v.device.getAce(),rawVelo:v.device.getStrength(),rawStrength:v.device.getRawStrength(),rawPitch:v.device.getRawPitch(),efxSink:v.device.getEffectSink()}}constructor(e,t=.5,s=.5){super();let o=this;o.smoothingAtk=t,o.smoothingDcy=s,o.device=e,o.addEventListener("meta",function(u){u?.data?.forEach(function(p){(o.#$[p.meta]||console.debug).call(o,p.meta,p.data)})}),S(o.device,o,"mode"),S(o.device,o,"mastervolume"),S(o.device,o,"channelactive"),S(o.device,o,"channelmin"),S(o.device,o,"channelmax"),S(o.device,o,"portrange"),S(o.device,o,"portstart"),S(o.device,o,"channelreset"),S(o.device,o,"channeltoggle"),S(o.device,o,"screen"),S(o.device,o,"metacommit"),S(o.device,o,"voice"),S(o.device,o,"pitch"),S(o.device,o,"note"),S(o.device,o,"reset"),S(o.device,o,"banklevel"),S(o.device,o,"efxreverb"),S(o.device,o,"efxchorus"),S(o.device,o,"efxdelay"),S(o.device,o,"efxinsert0"),S(o.device,o,"efxinsert1"),S(o.device,o,"efxinsert2"),S(o.device,o,"efxinsert3"),S(o.device,o,"partefxtoggle"),o.addEventListener("note",function({data:u}){o.#h.push(u)}),o.addEventListener("voice",({data:u})=>{let p=o.getChVoice(u.part);o.#E[u.part]=p,o.#x[u.part]=p.poly??1}),o.addEventListener("reset",({data:u})=>{o.#x.fill(1)}),o.#x.fill(1),o.#$[3]=function(u,p){o.#C?.length<1&&(o.#C=p,o.dispatchEvent("title",o.#C))},o.#$[81]=function(u,p){let y=o.noteProgress,v=o.#e||.5;o.#b=6e7/p,o.#e=p/1e6,o.#v+=y*(v/o.#e)-y,o.dispatchEvent("tempo",o.#b)},o.#$[88]=function(u,p){let y=o.noteProgress,v=o.noteOverall,a=o.noteBar,d=o.noteBeat,l=o.#i,r=o.#y;o.#i=p[0],o.#y=1<<p[1];let i=24*(32/p[3])/p[2];if(l!=o.#i){let c=a;o.#v-=c*(o.#i-l),d+1>=l&&(l<o.#i?o.#v-=Math.ceil(o.#i-d-1):o.#v+=o.#i)}o.dispatchEvent("tsig",o.getTimeSig())}}};var Ct=class extends EventTarget{static sleep(e){return new Promise(t=>{self.AbortSignal?AbortSignal.timeout(e).addEventListener("abort",t):setTimeout(t,e)})}#t;#f;#k=!1;get finished(){return this.#k}finish(){this.#k=!0,this.#f&&this.#f()}wait(){if(!this.#k)return this.#t}constructor(){super(),this.#t=new Promise(e=>{this.#f=()=>{this.#k=!0,e()}})}},ze=Ct;var me=new Uint8Array(40),Z=0,ge,Ma=setInterval(()=>{ge&&(me[Z]=!me[Z],Z++,Z>34&&(Z=0))},1e3/50);Uint8Array.prototype.render=function(e){let t=0,s=0,o=this.width||5,u=this.height||8;for(let p=0;p<this.length;p++)e(this[p],t,s,this),t++,t>=o&&(t=0,s++)};var qe=class{#t=[];loaded=new ze;async load(e,t=!1,s="(internal)"){let o=this,u=0,p=0;console.debug(`Font "${s||"(internal)"}": loading started.`),e.split(`
`).forEach(function(y,v){if(v>0&&y?.length>0){let a=y.split("	"),d=parseInt(a[0],16);if(p++,o.#t[d]&&!t)return;let l=new Uint8Array(40);Array.from(a[1]).forEach(async function(r,i){let c=i&1?4:0,n=i>>1,f=parseInt(r,16),h=3;for(;f>0||h>=0;){let b=(c+h)*5+n;l[b]=f&1,f=f>>1,h--}}),l.width=5,l.height=8,o.#t[d]=l,u++}}),o.loaded.finished||o.loaded.finish(),console.debug(`Font "${s||"(internal)"}": ${p} total, ${u} loaded.`)}async loadFile(e,t=!1){let s=this;console.debug(`Requested font file from "${e}".`),await s.load(await(await fetch(e)).text(),t,e),ge=!1}constructor(...e){ge=!0,(async()=>{for(let t=0;t<e.length;t++)await this.loadFile(e[t])})()}getCP(e){return this.#t[e]}getStr(e){let t=[],s=this;return Array.from(e).forEach(function(o){t.push(s.#t[o.charCodeAt(0)]||s.#t[32]||me)}),t}keys(){return Object.keys(this.#t)}data(e){return this.#t[e]}};var ee=16/9,te=64,G=new Float64Array(49),St="Vx,Dr,D1,D2,D3,D4,D5,D6,D7,D8".split(","),Mt=[1,3,6,8,10],We=[0,.5,1,1.5,2,3,3.5,4,4.5,5,5.5,6],Pt=2*Math.PI,Rt={"?":"Unset",gm:"General MIDI",g2:"General MIDI 2",xg:"Yamaha XG",gs:"Roland GS",sc:"Roland GS",mt32:"Roland MT-32",doc:"Yamaha DOC",qy10:"YAMAHA QY10",qy20:"YAMAHA QY20",sd:"Roland SD",x5d:"Korg X5D","05rw":"Korg 05R/W",ns5r:"Korg NS5R",k11:"Kawai K11",sg:"Akai SG",krs:"Korg KROSS 2",s90es:"Yamaha S90 ES",motif:"Yamaha Motif ES"},Dt={Copyrite:"Copyright","Cmn.Text":"Text","C.Lyrics":"Lyrics","C.Marker":"Marker",CuePoint:"Cue Point",Instrmnt:"Instrument","Kar.Info":"Kar Info","Kar.Mode":"Karaoke","Kar.Lang":"Language",KarTitle:"Kar Title",KarLyric:"Kar Lyrics","Kar.Ver.":"Kar Version",SGLyrics:"SG Lyrics",TrkTitle:"Title",EORTitle:"Real Title",XfSngDte:"XF Date",XfSngRgn:"XF Region",XfSngCat:"XF Category",XfSongBt:"XF Beat",XfSngIns:"XF Instr.",XfSngVoc:"XF Vocalist",XfSngCmp:"XF Composer",XfSngLrc:"XF Lyricist",XfSngArr:"XF Arranger",XfSngPer:"XF Perform.",XfSngPrg:"XF Program.",XfSngTag:"XF Tags",XfKarLng:"XF Lang.",XfKarNme:"XF Name",XfKarCmp:"XK Composer",XfKarLrc:"XK Lyricist",XfKarArr:"XK Arranger",XfKarPer:"XK Perform.",XfKarPrg:"XK Program."},At=["XfSongBt","XfSngIns"],be=[[],[4,2],[3,2]],Lt=[{l:0,t:0},{l:0,t:416},{l:960,t:0},{l:960,t:416}],Ye={none:{font4:[0,0],cfont4:[0,0],font7:[0,0]},macos:{font4:[2,0],cfont4:[1,0],font7:[0,0]},chromium:{font4:[1,0],cfont4:[0,0],font7:[1,0]}},Qe={xg:["9efaa0","006415"],doc:["9efaa0","006415"],qy10:["9efaa0","006415"],qy20:["9efaa0","006415"],ns5r:["9efaa0","006415"],x5d:["9efaa0","006415"],"05rw":["9efaa0","006415"],k11:["9efaa0","006415"],s90es:["9efaa0","006415"],motif:["9efaa0","006415"],gm:["a1f3ff","005e88"],g2:["a1f3ff","005e88"],krs:["a1f3ff","005e88"],gs:["ffe1a5","804e00"],sc:["ffe1a5","804e00"],mt32:["ffe1a5","804e00"],sd:["ffe1a5","804e00"],sg:["ffdddd","990022"]};G.forEach((e,t,s)=>{s[t]=Math.PI*t/12});var $=function(e,t,s={}){let o=document.createElement(e);t?.forEach(l=>{o.classList.add(l)});let{t:u,l:p,w:y,h:v,i:a,a:d}=s;return u?.constructor&&(o.style.top=u?.length?u:`${u}px`),p?.constructor&&(o.style.left=p?.length?p:`${p}px`),y?.constructor&&(o.style.width=y?.length?y:`${y}px`),v?.constructor&&(o.style.height=v?.length?v:`${v}px`),a?.constructor&&o.appendChild(document.createTextNode(a)),d?.constructor&&(o.style.textAlign=d),o};var R=function(e,t){t?.forEach(s=>{e.appendChild(s)})},O=function(e,t){t.forEach(s=>{e.classList.contains(s)&&e.classList.remove(s)})},X=function(e,t){t.forEach(s=>{e.classList.contains(s)||e.classList.add(s)})},Ot=new Array(128).fill(0);Ot.forEach((e,t,s)=>{s[t]=Math.floor(24*t/12.7)/10});var It=new Array(128).fill(0);It.forEach((e,t,s)=>{s[t]=Math.abs(Math.round(48*(t-64)/12.7)/10)});var Je=new Array(11).fill(null);Je.forEach((e,t,s)=>{s[t]=`${Math.round(t*12/.0128)/100}%`});var Bt=new Array(128).fill(null);Bt.forEach((e,t,s)=>{s[t]=`${Math.round(t/1.27)/100}`});var Ze=function(e,t){e.innerText=t,e.rNew=!0;let s=e.measureText(t);e.rWidth=s.width};HTMLElement.prototype.setTextRaw=function(e){let t;this.childNodes[0]?.nodeType==3?(t=this.childNodes[0],t.data=e):(t=document.createTextNode(e),this.prepend(t))};var Oa=class extends Ke{#t=16;#f=32;#k=128;#C=!1;#$="";#h;#g=0;#s=0;#e=0;#b=0;#i=0;#y;#v=0;#o=!1;#E=m.invalidCh;#x=1;#A=0;#F=0;#S=0;#n=new Uint8Array(1280);#c=new Uint8Array(1280);#K=new Uint8Array(1280);#R=new Uint8Array(512);#I=new Uint8Array(512);#M=new Uint8Array(512);#z=new Uint8Array(m.ch);#X;#T;#B;#d;#q;#D="fcdaff";#w="ffffff";#Z="?";#a={};#u={};#r=[];#l={};#L={};eventViewMode=0;useElementCount=!0;#p=[];#U="comb";glyphs=new qe;panStyle=11;#J(e,t,s,o=0,u=0){let p=this,{width:y,height:v}=e.canvas,a,d,l,r,i=p.#x,c=o>3,n=Mt.indexOf(t%12)>-1;switch(p.#U){case"block":case"comb":{a=Math.round(t*y/128),d=Math.round((t+1)*y/128),l=d-a,r=i==1?2:1;break}case"piano":{a=Math.round((Math.floor(t/12)*7+We[t%12])*y/75*1.0044642857142856),d=Math.round((Math.floor(t/12)*7+We[t%12]+1)*y/75*1.0044642857142856)-1,l=d-a,r=i==1?3:1;break}case"line":{let f=t-u;Math.abs(u)>2&&(f=t-Math.sign(u)*2),d=Math.round((t+.5)*y/128),a=Math.round((f+.5)*y/128)}default:}switch(e.fillStyle=`#${n?p.#D:p.#w}${(s<<1|s>>6).toString(16).padStart(2,"0")}`,e.strokeStyle=e.fillStyle,e.lineWidth=i==1?4:2,e.lineDashOffset=0,p.#U){case"block":{let f=e.canvas.height-1;e.fillRect(a,0,l,f),c&&e.clearRect(a+r,r,l-(r<<1),f-(r<<1));break}case"comb":{let f=(n?Math.round((e.canvas.height<<1)/3):e.canvas.height)-1;e.fillRect(a,0,l,f),c&&e.clearRect(a+r,r,l-(r<<1),f-(r<<1));break}case"piano":{let f=n?0:e.canvas.height>>1,h=(e.canvas.height>>1)-1;e.fillRect(a,f,l,h),c&&e.clearRect(a+r,f+r,l-(r<<1),h-(r<<1));break}case"line":{if(c)switch(i){case 4:{e.setLineDash(be[2]);break}default:e.setLineDash(be[1])}else e.setLineDash(be[0]),i!=4&&self?.document?.mozFullScreen&&(a+=.5,d+=.5);e.beginPath(),e.moveTo(a,(i==4||!c)&&self?.document?.mozFullScreen?1:0),e.lineTo(d,(v>>1)+1),e.lineTo(a,v),e.stroke();break}default:}}#j(e,t){let s=this;(e?.chInUse||t).forEach((o,u)=>{if(o){let p=s.#r[u>>4][u&15].cxt;p.clearRect(0,0,p.canvas.width,p.canvas.height),e.chKeyPr[u].forEach(({v:y,s:v},a)=>{s.#J(p,a,y,v,s.device.getPitchShift(u))})}})}#_(e){let t=this;Date.now()-t.#g>4e3&&(t.#s=0,t.#e=142-t.#l.view.clientHeight,(t.#h?.clientWidth||0)>840&&(t.#s=840-t.#h.clientWidth),t.#l.view.style.transform=`translateX(${t.#s}px) translateY(${t.#e}px)`,e&&(t.#g=0))}#W(){let e=self.innerWidth/self.innerHeight,t=1,s=self.innerWidth,o=self.innerHeight;e>=ee?(t=Math.min(Math.round(self.innerHeight/1080*1e4)/1e4,100),s=Math.ceil(self.innerHeight*ee)):e<ee&&(t=Math.min(Math.round(self.innerWidth/1920*1e4)/1e4,100),o=Math.ceil(self.innerWidth/ee)),this.#B.style.width=`${s}px`,this.#B.style.height=`${o}px`,this.#d.style.transform=`scale(${t})`}#Y;#te(){let e=this,t=e.#X?.currentTime||0,s=e.render(t),o=Date.now(),u=s.curPoly+s.extraPoly,p=s.curPolyEC+s.extraPolyEC;e.#b<u&&(e.#b=u),e.#i<p&&(e.#i=p),e.#a.curPoly.setTextRaw(`${e.useElementCount?p:u}`.padStart(3,"0")),e.#a.maxPoly.setTextRaw(`${e.useElementCount?e.#i:e.#b}`.padStart(3,"0")),e.#X?.realtime?(e.#a.barCount.setTextRaw("LINE"),e.#a.barDelim.style.display="none",e.#a.barNote.setTextRaw("IN")):(e.#a.barCount.setTextRaw(s.noteBar+1),e.#a.barDelim.style.display="",e.#a.barNote.setTextRaw(Math.floor(s.noteBeat)+1));let y=[7,11,1,91,93,94,74,5,256,256],v=e.#A+e.#x;for(let r=0;r<m.ch;r++){let i=r>>4,c=r*m.cc,n=r*m.ace,f=e.#r[i][r&15];if(s.chInUse[r]&&i>=e.#A&&i<v){y[8]=s.ace[n+0]||256,y[9]=s.ace[n+1]||256,f.ccVis.clearRect(0,0,109,25),f.ccVis.fillStyle=`#${e.#D}`,f.ccVis.strokeStyle=`#${e.#D}`,f.ccVis.lineWidth=2;for(let b=0;b<y.length;b++){let E=y[b];if(E<256){let k=s.chContr[c+g[E]],x=k*24/127;if(x>0){let T=24-x;f.ccVis.fillRect(b*6,T,4,x)}}}let h=s.chContr[c+g[10]]||1;switch(e.panStyle){case 7:case 6:case 5:case 3:case 2:case 1:{let b=(h+125)*.024933275,E=(h-64)*.024933275;f.ccVis.beginPath(),h>127?e.panStyle>>1&1&&(f.ccVis.arc(84.5,22.5,21.5,0,G[12],!0),f.ccVis.stroke()):(e.panStyle>>1&1&&(h<64?(f.ccVis.arc(84.5,22.5,21.5,G[18],b,!0),f.ccVis.stroke()):h>64&&(f.ccVis.arc(84.5,22.5,21.5,G[18],b),f.ccVis.stroke())),e.panStyle&1&&(f.ccVis.strokeStyle=`#${e.#w}`,f.ccVis.lineWidth=e.panStyle>>2?1:3,f.ccVis.beginPath(),f.ccVis.moveTo(84.5,22.5),h==64?f.ccVis.lineTo(84.5,4):f.ccVis.lineTo(84.5+18*Math.sin(E),22.5-18.5*Math.cos(E)),f.ccVis.stroke())),e.panStyle>>2&1&&(f.ccVis.fillStyle=`#${e.#w}`,f.ccVis.beginPath(),f.ccVis.arc(84.5,22.5,2.5,0,G[4]),f.ccVis.fill());break}case 11:case 10:case 9:{let b=(h+77)*.033244367,E=(h-64)*.033244367;f.ccVis.beginPath(),h>127?e.panStyle>>1&1&&(f.ccVis.arc(84.5,16.5,15.5,G[26],G[34],!0),f.ccVis.stroke()):(e.panStyle>>1&1&&(h<64?(f.ccVis.arc(84.5,16.5,15.5,G[18],b,!0),f.ccVis.stroke()):h>64&&(f.ccVis.arc(84.5,16.5,15.5,G[18],b),f.ccVis.stroke())),e.panStyle&1&&(f.ccVis.strokeStyle=`#${e.#w}`,f.ccVis.lineWidth=3,f.ccVis.beginPath(),f.ccVis.moveTo(84.5,16.5),h==64?f.ccVis.lineTo(84.5,4):f.ccVis.lineTo(84.5+11.5*Math.sin(E),16.5-11.5*Math.cos(E)),f.ccVis.stroke())),(!(e.panStyle&1)||h>>7)&&(f.ccVis.fillStyle=`#${e.#w}`,f.ccVis.beginPath(),f.ccVis.arc(84.5,16.5,2.5,0,G[24]),f.ccVis.fill());break}default:{let b=Math.abs(h-64)/2.625;h<64?f.ccVis.fillRect(84-b,0,b,24):h>127?(f.ccVis.fillRect(60,0,49,24),f.ccVis.clearRect(61,1,47,22)):f.ccVis.fillRect(85,0,b,24),f.ccVis.fillStyle=`#${e.#w}`,f.ccVis.fillRect(84,0,1,24)}}if(f.metre.clearRect(0,0,121,25),f.metre.fillStyle=`#${e.#w}`,f.metre.globalCompositeOperation="source-over",f.metre.rWidth>f.metre.canvas.width){f.metre.rNew&&(f.metre.rNew=!1,f.metre.rOffset=t);let b=t-(f.metre.rOffset||0),E=32,k=f.metre.rWidth-f.metre.canvas.width+E,x=b*-25%(f.metre.rWidth+E+48)+48;x>0&&(x=0),f.metre.fillText(f.metre.innerText,x,3+e.#q.cfont4[0]),Math.abs(x)>k&&f.metre.fillText(f.metre.innerText,x+f.metre.rWidth+E,3+e.#q.cfont4[0])}else f.metre.fillText(f.metre.innerText,0,3+e.#q.cfont4[0]);switch(f.metre.globalCompositeOperation="xor",f.metre.fillRect(0,0,s.strength[r]*121/255,25),f.extVis.clearRect(0,0,47,25),f.extVis.fillStyle=`#${e.#w}`,s.chExt[r][0]){case e.device.EXT_VL:{let b=(s.chContr[c+g[136]]-64)/64||s.rawPitch[r]/8192;b=b*-4+4;let E=+!!s.rawVelo[r]*(s.chContr[c+g[129]]*s.chContr[c+g[11]]/16129);!E&&s.rawStrength[r]&&(E=s.rawStrength[r]*s.chContr[c+g[11]]/16129),E*=32;let k=0;f.extVis.beginPath(),f.extVis.moveTo(0,12-b-3),f.extVis.lineTo(7+E,12),f.extVis.lineTo(0,12+b+3),f.extVis.fill(),f.extVis.fillStyle=`#${e.#D}`,f.extVis.beginPath(),f.extVis.ellipse(43,12,4,4+k,0,0,Pt),f.extVis.fill();break}case e.device.EXT_DX:{s.chContr.subarray(c+g[142],c+g[157]+1).forEach((E,k)=>{k>=8&&(f.extVis.fillStyle=`#${e.#D}`);let x=k*3,T=(E-64)/5.82;T>=0?f.extVis.fillRect(x,12-T,2,T+1):f.extVis.fillRect(x,12,2,1-T)});break}}}}let a=new Array(m.ch);if(e.#r.forEach((r,i)=>{r.forEach((c,n)=>{c.refresh&&(c.refresh=!1,a[i<<7|n]=!0)})}),["line"].indexOf(e.#U)>-1)for(;e.#p.length>0;){let r=e.#p.shift();a[r.part]=!0}e.#j(s,a),s.extraNotes.forEach(r=>{let{part:i,note:c,velo:n,state:f}=r,h=e.#r[i>>4][i&15].cxt;e.#J(h,c,n,f,e.device.getPitchShift(i))});let d=e.#L.cxt;o>s.bitmap.expire?e.#M.fill(0):s.bitmap.bitmap.length>256?s.bitmap.bitmap.forEach((r,i)=>{e.#M[i]=r?255:0}):s.bitmap.bitmap.forEach((r,i)=>{e.#M[i<<1]=r?255:0,e.#M[i<<1|1]=r?255:0}),e.#K.fill(0),o<=s.letter.expire&&e.glyphs.getStr(s.letter.text).forEach((r,i)=>{let c=(i&15)*5,n=i>>4<<3;r.forEach((f,h)=>{let b=c+h%5,E=n+Math.floor(h/5);e.#K[E*80+b]=f?255:0})}),e.#R.forEach((r,i,c)=>{let n=e.#M[i];n>r?c[i]+=Math.min(n-r,te):n<r&&(c[i]-=Math.min(r-n,te))}),e.#n.forEach((r,i,c)=>{let n=e.#K[i];n>r?c[i]+=Math.min(n-r,te):n<r&&(c[i]-=Math.min(r-n,te))}),e.#R.forEach((r,i)=>{let c=i>>5,n=i&31;e.#I[i]!=r?(d.clearRect(252+(n<<2),c<<2,3,3),r&&(d.fillStyle=`#${e.#w}${r.toString(16).padStart(2,"0")}`,d.fillRect(252+(n<<2),c<<2,3,3))):C()&&(d.clearRect(252+(n<<2),c<<2,3,3),r&&(d.fillStyle=`#ff0000${r.toString(16).padStart(2,"0")}`,d.fillRect(252+(n<<2),c<<2,3,3)))}),e.#n.forEach((r,i)=>{let c=Math.floor(i/80),n=i%80;n+=Math.floor(n/5),e.#c[i]!=r?(d.clearRect(n<<2,(c|16)<<2,3,3),r&&(d.fillStyle=`#${e.#w}${r.toString(16).padStart(2,"0")}`,d.fillRect(n<<2,(c|16)<<2,3,3))):C()&&(d.clearRect(n<<2,(c|16)<<2,3,3),r&&(d.fillStyle=`#ff0000${r.toString(16).padStart(2,"0")}`,d.fillRect(n<<2,(c|16)<<2,3,3)))}),e.#I.forEach((r,i,c)=>{c[i]=e.#R[i]}),e.#c.forEach((r,i,c)=>{c[i]=e.#n[i]});let l=(self.performance||self.Date).now();switch(e.eventViewMode){case 0:{e.#a.events.setTextRaw(`${s.eventCount}`.padStart(3,"0"));break}case 1:{let r=1e3/(l-e.#F);r>99?(r=Math.round(r),e.#a.events.setTextRaw(`${r}`)):r>9?(r=Math.round(r*10)/10,e.#a.events.setTextRaw(`${Math.floor(r)}.${Math.floor(r*10%10)}`)):(r=Math.round(r*100)/100,e.#a.events.setTextRaw(`${Math.floor(r)}.${Math.floor(r*100%100)}`));break}default:e.#a.events.setTextRaw("")}e.#F=l}#V;#m;get style(){return this.#U}set style(e){let t=this;t.#U=e,t.#j(t.render(t.#X?.currentTime||0)),O(t.#d,["cambiare-style-block","cambiare-style-comb","cambiare-style-piano","cambiare-style-line"]),X(t.#d,[`cambiare-style-${e}`])}setClockSource(e){this.#X=e}setPixelProfile(e){let t=this;if(Ye[e]){let s=Ye[e];t.#q=s,t.#d&&(t.#d.style.setProperty("--pcp-font4",`translate(${s.font4[1]}px, ${s.font4[0]}px)`),t.#d.style.setProperty("--pcp-font7",`translate(${s.font7[1]}px, ${s.font7[0]}px)`))}else throw new Error(`"${e}" is not a valid pixel correction profile`)}setMode(e){let t=this;O(t.#d,["cambiare-mode-gm","cambiare-mode-xg","cambiare-mode-gs","cambiare-mode-sc","cambiare-mode-ns5r","cambiare-mode-05rw","cambiare-mode-x5d","cambiare-mode-k11","cambiare-mode-sg","cambiare-mode-g2","cambiare-mode-mt32","cambiare-mode-doc","cambiare-mode-qy10","cambiare-mode-qy20","cambiare-mode-sd","cambiare-mode-krs","cambiare-mode-s90es","cambiare-mode-motif"]),e!="?"&&X(t.#d,[`cambiare-mode-${e}`]),t.#Z=e,t.#D=(Qe[e]||["fcdaff","742b81"])[t.#S]}setScheme(e=0){let t=this;t.#S=e?1:0,t.#w=["ffffff","000000"][t.#S],[O,X][t.#S](t.#d,["cambiare-scheme-light"]),t.#D=(Qe[t.#Z]||["fcdaff","742b81"])[t.#S]}#ae(e){let t=this,s=t.#x,o=t.#A;t.#r.forEach((u,p)=>{if(p>=o&&p<o+s){X(u.root,["port-active"]);let y=p-o,{l:v,t:a}=Lt[y*(4/s)];u.root.style.top=`${a}px`,u.root.style.left=`${v}px`,u.forEach((d,l)=>{d.root.style.top=`${l*(s>2?26:52)}px`})}else O(u.root,["port-active"]),u.root.style.top="",u.root.style.left="",u.forEach((y,v)=>{y.root.style.top=""});e&&u.forEach((y,v)=>{y.cxt.canvas.width=t.#x==1?1193:495,y.cxt.canvas.height=t.#x==4?26:52})})}setPort(e){let t=this;O(t.#d,["cambiare-start0","cambiare-start1","cambiare-start2","cambiare-start3","cambiare-start4","cambiare-start5","cambiare-start6","cambiare-start7"]),X(t.#d,[`cambiare-start${e}`]),t.#A=e,t.#ae(!1)}setRange(e){let t=this;O(t.#d,["cambiare-port1","cambiare-port2","cambiare-port4","cambiare-compact"]),X(t.#d,[`cambiare-${e}`]),t.#x=parseInt(e.slice(4))||1,t.#ae(!0)}setFrameTime(e=20){let t=this;t.#m?.constructor&&clearInterval(t.#m),e<5?e=5:e>100&&(e=100),t.#m=setInterval(t.#V,e),t.smoothingAtk=Math.pow(.1,e/20),t.smoothingDcy=Math.pow(.75,e/20)}attach(e){let t=this;t.#T=e;let s=$("div",["cambiare-container"]);e.appendChild(s),t.#B=s;let o=$("div",["cambiare-canvas","cambiare-port1","cambiare-start0","cambiare-style-block"]);s.appendChild(o),t.#d=o,self.addEventListener("resize",t.#Y),t.#Y(),t.setFrameTime(20),t.#a.root=$("div",["sect-info"]),t.#a.events=$("span",["field","pcp-font4"],{t:1,l:0,w:35,h:33}),t.#a.curPoly=$("span",["field","pcp-font4"],{t:1,l:52,w:35,h:33}),t.#a.maxPoly=$("span",["field","pcp-font4"],{t:1,l:98,w:35,h:33}),t.#a.sigN=$("span",["field","pcp-font4"],{t:1,l:194,w:23,h:33,a:"right"}),t.#a.sigD=$("span",["field","pcp-font4"],{t:1,l:232,w:23,h:33}),t.#a.barCount=$("span",["field","pcp-font4"],{t:1,l:304,w:35,h:33,a:"right"}),t.#a.barDelim=$("span",["field","field-label","pcp-font4"],{t:0,l:343,w:8,h:33,i:"/"}),t.#a.barNote=$("span",["field","pcp-font4"],{t:1,l:354,w:23,h:33}),t.#a.tempo=$("span",["field","pcp-font4"],{t:1,l:454,w:64,h:33,a:"right"}),t.#a.volume=$("span",["field","pcp-font4"],{t:1,l:562,w:63,h:33,a:"right"}),t.#a.mode=$("span",["field","pcp-font4"],{t:1,l:708,w:152,h:33}),t.#a.reverb=$("span",["field","pcp-font4"],{t:1,l:1e3,w:190,h:33}),t.#a.chorus=$("span",["field","pcp-font4"],{t:1,l:1240,w:190,h:33}),t.#a.delay=$("span",["field","pcp-font4"],{t:1,l:1475,w:190,h:33}),t.#a.insert=$("span",["field","pcp-font4"],{t:1,l:1706,w:190,h:33}),t.#a.title=$("span",["field","pcp-font4"],{t:35,l:50,w:810,h:33}),o.appendChild(t.#a.root),R(t.#a.root,[t.#a.events,t.#a.curPoly,$("span",["field","field-label","pcp-font4"],{t:1,l:89,w:5,h:33,i:":"}),t.#a.maxPoly,$("span",["field","field-key","pcp-font7"],{t:1,l:148,w:41,h:33,i:"TSig"}),t.#a.sigN,$("span",["field","field-label","pcp-font4"],{t:0,l:221,w:8,h:33,i:"/"}),t.#a.sigD,$("span",["field","field-key","pcp-font7"],{t:1,l:268,w:30,h:33,i:"Bar"}),t.#a.barCount,t.#a.barDelim,t.#a.barNote,$("span",["field","field-key","pcp-font7"],{t:1,l:390,w:61,h:33,i:"Tempo",a:"right"}),t.#a.tempo,$("span",["field","field-key","pcp-font7"],{t:1,l:528,w:29,h:33,i:"Vol"}),t.#a.volume,$("span",["field","field-label","pcp-font4"],{t:1,l:626,w:17,h:33,i:"%"}),$("span",["field","field-key","pcp-font7"],{t:1,l:652,w:52,h:33,i:"Mode"}),t.#a.mode,$("span",["field","field-key","pcp-font7"],{t:1,l:960,w:34,h:33,i:"Rev"}),t.#a.reverb,$("span",["field","field-key","pcp-font7"],{t:1,l:1198,w:36,h:33,i:"Cho"}),t.#a.chorus,$("span",["field","field-key","pcp-font7"],{t:1,l:1438,w:31,h:33,i:"Var"}),t.#a.delay,$("span",["field","field-key","pcp-font7"],{t:1,l:1673,w:27,h:33,i:"Ins"}),t.#a.insert,$("span",["field","field-key","pcp-font7"],{t:35,l:0,w:44,h:33,i:"Title"}),t.#a.title]),t.#u.root=$("div",["sect-mark"]),t.#u.left=$("div",["sect-mark-left","boundary"],{t:0,l:0}),t.#u.right=$("div",["sect-mark-right","boundary"],{t:0,l:960}),o.appendChild(t.#u.root),R(t.#u.root,[t.#u.left,t.#u.right]),R(t.#u.left,[$("span",["field","field-key"],{t:0,l:0,w:26,h:33,i:"CH"}),$("span",["field","field-key"],{t:0,l:30,w:49,h:33,i:"Voice"}),$("span",["field","field-key","mark-send-title"],{t:2,l:164,w:25,h:18,i:"Send"}),$("span",["field","field-label","mark-send-param"],{t:16,l:146,w:58,h:16,i:"VEMRCDBP12",a:"center"}),$("span",["field","field-key"],{t:0,l:212,w:35,h:33,i:"Pan"}),$("span",["field","field-key"],{t:0,l:256,w:45,h:33,i:"Note"})]),R(t.#u.right,[$("span",["field","field-key"],{t:0,l:0,w:26,h:33,i:"CH"}),$("span",["field","field-key"],{t:0,l:30,w:49,h:33,i:"Voice"}),$("span",["field","field-key","mark-send-title"],{t:2,l:164,w:25,h:18,i:"Send"}),$("span",["field","field-label","mark-send-param"],{t:16,l:146,w:58,h:16,i:"VEMRCDBP12",a:"center"}),$("span",["field","field-key"],{t:0,l:212,w:35,h:33,i:"Pan"}),$("span",["field","field-key"],{t:0,l:256,w:45,h:33,i:"Note"})]),t.#r.root=$("div",["sect-part"]);for(let u=0;u<m.ch>>4;u++){let p=u<<4;t.#r[u]=[],t.#r[u].root=$("div",["boundary",`part-port-${u}`]);for(let y=0;y<16;y++){let v=(p|y)+1;v>=100?v=`${Math.floor(v/10).toString(16)}${v%10}`:v=`${v}`.padStart(2,"0"),t.#r[u][y]={root:$("div",["boundary","part-channel"]),major:$("div",["boundary","part-info-major"]),minor:$("div",["boundary","part-info-minor"],{t:26}),keys:$("div",["boundary","part-keys"]),notes:$("div",["boundary","part-keyboard"]),cxt:$("canvas",["field"]).getContext("2d"),number:$("span",["field","field-label","pcp-font4"],{t:1,w:18,h:25,i:v}),voice:$("span",["field"],{l:22,t:1,w:121,h:25}),metre:$("canvas",["field"]).getContext("2d"),type:$("span",["field","field-label","pcp-font4"],{t:1,w:18,h:25}),std:$("span",["field","pcp-font4"],{l:22,t:1,w:20,h:25,a:"center"}),msb:$("span",["field","pcp-font4"],{l:48,t:1,w:27,h:25}),prg:$("span",["field","pcp-font4"],{l:81,t:1,w:27,h:25}),lsb:$("span",["field","pcp-font4"],{l:114,t:1,w:27,h:25}),ccVis:$("canvas",["field"],{l:145,t:1}).getContext("2d"),extVis:$("canvas",["field"],{l:207,t:1}).getContext("2d"),ccUpdate:!1};let a=t.#r[u][y];Je.forEach(d=>{a.notes.appendChild($("span",["field","part-csplit"],{l:d}))}),a.notes.appendChild($("span",["field","part-csplit","part-cdive"],{l:0,w:"100%",h:1})),a.metre.canvas.width=121,a.metre.canvas.height=25,a.metre.textBaseline="top",a.metre.font="20px 'PT Sans Narrow'",a.ccVis.canvas.width=109,a.ccVis.canvas.height=25,a.ccVis.fillStyle=`#${t.#w}`,a.extVis.canvas.width=47,a.extVis.canvas.height=25,a.extVis.fillStyle=`#${t.#w}`,R(a.notes,[a.cxt.canvas]),R(a.keys,[a.notes]),R(a.voice,[a.metre.canvas]),R(a.major,[a.number,a.voice,a.ccVis.canvas]),R(a.minor,[a.type,a.std,a.msb,a.prg,a.lsb,a.extVis.canvas]),R(a.root,[a.major,a.minor,a.keys]),R(t.#r[u].root,[a.root]),a.number.addEventListener("contextmenu",d=>{d.preventDefault(),d.stopImmediatePropagation();let l=u<<4|y;t.#z[l]=+!t.#z[l],[O,X][t.#z[l]](a.root,["part-hidden"])})}t.#r.root.appendChild(t.#r[u].root)}o.appendChild(t.#r.root),t.#l.root=$("div",["sect-meta"]),t.#l.view=$("div",["boundary"]),o.appendChild(t.#l.root),R(t.#l.root,[t.#l.view]),t.#L.root=$("div",["sect-pix","boundary"],{l:1529,t:950,w:379,h:127}),t.#L.cxt=$("canvas",["field"]).getContext("2d"),t.#L.fps=$("span",["field","field-key"],{l:0,w:"100%",h:1}),t.#L.cxt.canvas.width=379,t.#L.cxt.canvas.height=127,R(t.#L.root,[t.#L.cxt.canvas]),o.appendChild(t.#L.root),t.addEventListener("mode",u=>{t.#a.mode.setTextRaw(`${Rt[u.data]}`),t.setMode(u.data)}),t.addEventListener("mastervolume",u=>{let p=Math.round(u.data*100)/100;t.#a.volume.setTextRaw(`${Math.floor(p)}.${`${Math.floor(p%1*100)}`.padStart(2,"0")}`)}),t.addEventListener("tempo",u=>{let p=Math.round(u.data*100);t.#a.tempo.setTextRaw(`${Math.floor(p/100)}.${`${Math.floor(p%100)}`.padStart(2,"0")}`)}),t.addEventListener("tsig",u=>{[t.#a.sigN.innerText,t.#a.sigD.innerText]=u.data}),t.addEventListener("title",u=>{t.#a.title.setTextRaw(u.data||"No Title")}),t.addEventListener("voice",({data:u})=>{let p=t.getChVoice(u.part),y=t.#r[u.part>>4][u.part&15];Ze(y.metre,t.getMapped(p.name)),y.type.setTextRaw(St[t.device.getChType()[u.part]]),y.std.setTextRaw(p.standard),y.msb.setTextRaw(`${p.sid[0]}`.padStart(3,"0")),y.prg.setTextRaw(`${p.sid[1]}`.padStart(3,"0")),y.lsb.setTextRaw(`${p.sid[2]}`.padStart(3,"0"))}),t.addEventListener("pitch",u=>{let{part:p,pitch:y}=u.data;t.#r[p>>4][p&15].notes.style.transform=`translateX(${y/1.28}%)`}),t.addEventListener("efxreverb",u=>{t.#a.reverb.setTextRaw(t.getEfx(u.data))}),t.addEventListener("efxchorus",u=>{t.#a.chorus.setTextRaw(t.getEfx(u.data))}),t.addEventListener("efxdelay",u=>{t.#a.delay.setTextRaw(t.getEfx(u.data))}),t.addEventListener("efxinsert0",u=>{t.#a.insert.setTextRaw(t.getEfx(u.data))}),t.addEventListener("partefxtoggle",u=>{let{part:p,active:y}=u.data;[O,X][y](t.#r[p>>4][p&15].number,["part-efx"])}),t.addEventListener("channeltoggle",u=>{let{part:p,active:y}=u.data;[O,X][y](t.#r[p>>4][p&15].root,["part-active"])}),t.addEventListener("channelactive",u=>{if(t.#E<m.ch){let y=t.#r[t.#E>>4][t.#E&15].number;O(y,["part-focus"])}let p=u.data;if(p<m.ch){let y=t.#r[p>>4][p&15].number;X(y,["part-focus"]),t.#E=p}}),t.addEventListener("metacommit",u=>{let p=u.data;if(t.#C&&p.type==t.#$&&t.#h)switch(p.type){case"C.Lyrics":case"KarLyric":case"SGLyrics":{R(t.#h,[$("span",["meta-slice"],{i:p.data})]);break}default:t.#h.childNodes[0].data+=p.data}else if(p.data?.length&&At.indexOf(p.type)==-1){let y=$("div",["meta-line"]),v=$("span",["field","field-key","meta-type"],{i:Dt[p.type]||p.type});switch(p.mask&&(v.style.display="none"),p.type){case"C.Lyrics":case"KarLyric":case"SGLyrics":{t.#h=$("span",["field","meta-data"]),R(t.#h,[$("span",["meta-slice"],{i:p.data})]);break}default:t.#h=$("span",["field","meta-data"],{i:p.data})}for(t.#l.view.appendChild(y),R(y,[v,t.#h]),t.#l.view.children.length>t.#f&&(t.#v=Date.now()+500,t.#o==0&&console.debug("Meta event garbage collector triggered."),t.#o=1);t.#l.view.children.length>t.#k;)t.#l.view.children[0].remove()}t.#C=p.amend||!1,t.#$=p.type||"",t.#_()}),t.#l.view.style.transform="translateX(0px) translateY(140px)",t.#y=setInterval(async()=>{let u=Date.now();if(t.#o!=0)switch(t.#o){case 1:{if(u<t.#v)break;t.#l.view.style.transition="none";let p=0;for(;t.#l.view.children.length>t.#t;)t.#l.view.children[0].remove(),p++;t.#_(),console.debug(`Meta event garbage collector removed ${p} events.`),t.#o=2;break}case 2:{if(u<t.#v+100)break;t.#l.view.style.transition="",C()&&console.debug("Meta event garbage collector restored meta animation."),t.#o=0;break}}},40),t.dispatchEvent("mode","?"),t.dispatchEvent("mastervolume",100),t.dispatchEvent("tempo",120),t.dispatchEvent("tsig",[4,4]),t.dispatchEvent("title",""),t.dispatchEvent("efxreverb",t.device.getEffectType(0)),t.dispatchEvent("efxchorus",t.device.getEffectType(1)),t.dispatchEvent("efxdelay",t.device.getEffectType(2)),t.dispatchEvent("efxinsert0",t.device.getEffectType(3)),t.#ae(!0)}detach(e){let t=this;self.removeEventListener("resize",t.#Y),t.#d.remove(),t.#d=void 0,t.#B.remove(),t.#B=void 0,t.#T=void 0,clearInterval(t.#m),clearInterval(t.#y)}constructor(e,t){super(new He,.1,.75);let s=this;s.#Y=s.#W.bind(this),s.#V=s.#te.bind(this),e&&s.attach(e),t&&s.setClockSource(t),s.setPixelProfile("none"),s.addEventListener("reset",()=>{s.#b=0,s.#i=0,s.#C=!1,s.#$="",s.#h=null,s.#E=m.invalidCh;try{let o=s.#l.view.children;for(let u=o.length-1;u>=0;u--)o[u].remove();s.#l.view.style.transform="translateX(0px) translateY(140px)";for(let u=0;u<m.ch;u++){let p=s.#r[u>>4][u&15];O(p.root,["part-active"]),O(p.number,["part-efx","part-focus"]),Ze(p.metre,""),p.type.setTextRaw(""),p.std.setTextRaw(""),p.msb.setTextRaw(""),p.prg.setTextRaw(""),p.lsb.setTextRaw(""),p.notes.style.transform="",p.ccUpdate=!0}}catch{}}),s.addEventListener("pitch",({data:o})=>{s.#p.push(o)})}};export{Oa as Cambiare};
