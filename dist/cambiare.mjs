var ze=Object.create;var he=Object.defineProperty;var qe=Object.getOwnPropertyDescriptor;var We=Object.getOwnPropertyNames;var Ye=Object.getPrototypeOf,Qe=Object.prototype.hasOwnProperty;var Ze=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Je=(e,t,n,l)=>{if(t&&typeof t=="object"||typeof t=="function")for(let h of We(t))!Qe.call(e,h)&&h!==n&&he(e,h,{get:()=>t[h],enumerable:!(l=qe(t,h))||l.enumerable});return e};var je=(e,t,n)=>(n=e!=null?ze(Ye(e)):{},Je(t||!e||!e.__esModule?he(n,"default",{value:e,enumerable:!0}):n,e));var Ue=Ze((Zt,se)=>{(function(){"use strict";let e={fatal:!0},t=[new TextDecoder("iso-8859-15",e),new TextDecoder("sjis",e),new TextDecoder("euc-jp",e),new TextDecoder("utf-8",e),new TextDecoder("utf-16",e),new TextDecoder("ascii")],n={debug:!1,parse:function(l,h){if(l instanceof Uint8Array)return n.Uint8(l);if(typeof l=="string")return n.Base64(l);if(l instanceof HTMLElement&&l.type==="file")return n.addListener(l,h);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(l,h){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(l===void 0||!(l instanceof HTMLElement)||l.tagName!=="INPUT"||l.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;h=h||function(){},l.addEventListener("change",function(p){if(!p.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let y=new FileReader;y.readAsArrayBuffer(p.target.files[0]),y.onload=function(v){h(n.Uint8(new Uint8Array(v.target.result)))}})},Base64:function(l){let h=function(v){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(v=v.replace(/^.*?base64,/,""),v=String(v).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(v))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");v+="==".slice(2-(3&v.length));let i,d="",r,s,o=0;for(;o<v.length;)i=a.indexOf(v.charAt(o++))<<18|a.indexOf(v.charAt(o++))<<12|(r=a.indexOf(v.charAt(o++)))<<6|(s=a.indexOf(v.charAt(o++))),d+=r===64?String.fromCharCode(i>>16&255):s===64?String.fromCharCode(i>>16&255,i>>8&255):String.fromCharCode(i>>16&255,i>>8&255,255&i);return d}(l=String(l));var p=h.length;let y=new Uint8Array(new ArrayBuffer(p));for(let v=0;v<p;v++)y[v]=h.charCodeAt(v);return n.Uint8(y)},Uint8:function(y){let h={data:null,pointer:0,movePointer:function(r){return this.pointer+=r,this.pointer},readInt:function(r){if((r=Math.min(r,this.data.byteLength-this.pointer))<1)return-1;let s=0;if(1<r)for(let o=1;o<=r-1;o++)s+=this.data.getUint8(this.pointer)*Math.pow(256,r-o),this.pointer++;return s+=this.data.getUint8(this.pointer),this.pointer++,s},readStr:function(r){let s=new Uint8Array(r),o=!1,c;s.forEach((u,f)=>{s[f]=this.readInt(1)});for(let u=0;u<t.length;u++)if(!o)try{if(c=t[u].decode(s),u==0)for(let f=0;f<c.length;f++){let b=c.charCodeAt(f);if(b>191||b>127&&b<160)throw new RangeError(`Invalid code point: ${b}`)}o=!0,console.debug(`String byte sequence in ${t[u].encoding}`)}catch(f){console.debug(`SMF string ${f}`)}return c||"String byte sequence read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let r=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)r=this.readInt(1);else{let o=[];for(;128<=this.data.getUint8(this.pointer);)o.push(this.readInt(1)-128);var s=this.readInt(1);for(let c=1;c<=o.length;c++)r+=o[o.length-c]*Math.pow(128,c);r+=s}return r}};if(h.data=new DataView(y.buffer,y.byteOffset,y.byteLength),h.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;h.readInt(4);let p={};p.formatType=h.readInt(2),p.tracks=h.readInt(2),p.track=[];var y=h.readInt(1),v=h.readInt(1);128<=y?(p.timeDivision=[],p.timeDivision[0]=y-128,p.timeDivision[1]=v):p.timeDivision=256*y+v;for(let r=1;r<=p.tracks;r++){p.track[r-1]={event:[]};var a,i=h.readInt(4);if(i===-1)break;if(i!==1297379947)return!1;h.readInt(4);let s=0,o=!1,c,u;for(;!o&&(s++,p.track[r-1].event[s-1]={},p.track[r-1].event[s-1].deltaTime=h.readIntVLV(),(c=h.readInt(1))!==-1);)if(128<=c?u=c:(c=u,h.movePointer(-1)),c===255){p.track[r-1].event[s-1].type=255,p.track[r-1].event[s-1].metaType=h.readInt(1);var d=h.readIntVLV();switch(p.track[r-1].event[s-1].metaType){case 47:case-1:o=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:p.track[r-1].event[s-1].data=h.readStr(d);break;case 33:case 89:case 81:p.track[r-1].event[s-1].data=h.readInt(d);break;case 84:p.track[r-1].event[s-1].data=[],p.track[r-1].event[s-1].data[0]=h.readInt(1),p.track[r-1].event[s-1].data[1]=h.readInt(1),p.track[r-1].event[s-1].data[2]=h.readInt(1),p.track[r-1].event[s-1].data[3]=h.readInt(1),p.track[r-1].event[s-1].data[4]=h.readInt(1);break;case 88:p.track[r-1].event[s-1].data=[],p.track[r-1].event[s-1].data[0]=h.readInt(1),p.track[r-1].event[s-1].data[1]=h.readInt(1),p.track[r-1].event[s-1].data[2]=h.readInt(1),p.track[r-1].event[s-1].data[3]=h.readInt(1);break;default:this.customInterpreter!==null&&(p.track[r-1].event[s-1].data=this.customInterpreter(p.track[r-1].event[s-1].metaType,h,d)),this.customInterpreter!==null&&p.track[r-1].event[s-1].data!==!1||(h.readInt(d),p.track[r-1].event[s-1].data=h.readInt(d),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((c=c.toString(16).split(""))[1]||c.unshift("0"),p.track[r-1].event[s-1].type=parseInt(c[0],16),p.track[r-1].event[s-1].channel=parseInt(c[1],16),p.track[r-1].event[s-1].type){case 15:this.customInterpreter!==null&&(p.track[r-1].event[s-1].data=this.customInterpreter(p.track[r-1].event[s-1].type,h,!1)),this.customInterpreter!==null&&p.track[r-1].event[s-1].data!==!1||(a=h.readIntVLV(),p.track[r-1].event[s-1].data=h.readInt(a),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:p.track[r-1].event[s-1].data=[],p.track[r-1].event[s-1].data[0]=h.readInt(1),p.track[r-1].event[s-1].data[1]=h.readInt(1);break;case 12:case 13:p.track[r-1].event[s-1].data=h.readInt(1);break;case-1:o=!0;break;default:if(this.customInterpreter!==null&&(p.track[r-1].event[s-1].data=this.customInterpreter(p.track[r-1].event[s-1].metaType,h,!1)),this.customInterpreter===null||p.track[r-1].event[s-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return p},customInterpreter:null};if(typeof se<"u")se.exports=n;else{let l=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;l.MidiParser=n}})()});var ue=function(e,t){let n=Math.min(e.length,t.length),l=e.slice(0,n),h=t.slice(0,n),p=0,y=0;for(;y<n&&p==0;)p=Math.sign(l[y]-h[y]),y++;return p},L=function(e=""){this.name=e,this.pool=[],this.point=function(t,n=!1){if(this.pool.length>0){let l=this.pool.length,h=1<<Math.floor(Math.log2(l)),p=h,y=64;for(;h>=1&&y>=0;){if(y<=0)throw new Error("TTL reached.");if(p==l)p-=h;else{let a=ue(t,this.pool[p]);switch(a){case 0:{y=0;break}case 1:{p+h<=l&&(p+=h);break}case-1:{p!=0&&(p-=h);break}default:console.warn(`Unexpected result ${a}.`)}}h=h>>1,y--}let v=!0;if(p>=this.pool.length)v=!1;else{let a=this;this.pool[p].forEach(function(i,d,r){v&&i!=t[d]&&(v=!1)}),!v&&ue(t,this.pool[p])>0&&p++}return v||n?p:-1}else return n?0:-1},this.add=function(t,n){return t.data=n,this.pool.splice(this.point(t,!0),0,t),this},this.default=function(t){console.warn(`No match in "${this.name||"(unknown)"}" for "${t}". Default action not defined.`)},this.get=function(t){let n=this.point(t);if(n>-1)return this.pool[n].data;this.default(t)},this.run=function(t,...n){let l=this.point(t);l>-1?t.subarray?this.pool[l].data(t.subarray(this.pool[l].length),...n):this.pool[l].data(t.slice(this.pool[l].length),...n):this.default(t,...n)}};var W=class{#t={};addEventListener(e,t){this.#t[e]||(this.#t[e]=[]),this.#t[e].unshift(t)}removeEventListener(e,t){if(this.#t[e]){let n=this.#t[e].indexOf(t);n>-1&&this.#t[e].splice(n,1),this.#t[e].length<1&&delete this.#t[e]}}dispatchEvent(e,t){let n=new Event(e),l=this;n.data=t,this.#t[e]?.length>0&&this.#t[e].forEach(function(h){try{h?.call(l,n)}catch(p){console.error(p)}}),this[`on${e}`]&&this[`on${e}`](n)}};var et=["MSB","PRG","LSB","NME","ELC","DRM"],j=function(e){let t=Math.floor(e/10),n=e%10;return`${t.toString(16)}${n}`},ee=class{#t;strictMode=!1;get(e=0,t=0,n=0,l){let h=[e,t,n],p,y=1,v=0,a,i=Array.from(arguments);switch(l){case"xg":{switch(e){case 0:{n==126?i[2]=125:n==127&&(i[2]=0);break}case 16:{n==126&&(i[2]=0);break}case 32:{n>125&&(i[2]=0),i[2]+=4;break}case 33:case 34:case 35:case 36:{n>125&&(i[2]=0),i[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:i[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{n==126&&(i[2]=0);break}case 48:case 64:case 126:case 127:{n==126&&(i[2]=0);break}}break}case"gs":case"sc":{e==0&&n<5?i[2]=0:e>125&&n<5&&n!=2&&(i[2]=e,i[0]=0);break}case"g2":case"sd":{e>>1==40?i[2]|=16:e>95&&e<100&&(i[2]|=16,t>>4==7&&(i[0]=96));break}case"sg":{e==8&&n==0&&(i[2]=5);break}case"s90es":{n<8?i[2]+=17:n<32?i[2]+=13:i[2]=(i[2]>>3)+19;break}case"motif":{n<8?i[2]+=28:n<32?i[2]+=13:i[2]=(i[2]>>3)+19;break}}let d=" ",r="M",s="",o=0,c=0;switch(i[0]){case 0:{switch(i[2]){case 127:{l=="xg"?r="GM-a":(r="MT-a",s="C/M");break}case 126:{l=="xg"?r="GM-n":(r="MT-b",s="C/M");break}case 7:{r="GM-k",s="GLX";break}case 5:{r="SG-a",s="000";break}case 4:{l=="gs"||l=="sc"?(r="GM-a",s="000"):(r="SP-l",s="C/M");break}case 3:case 2:case 1:{(l=="gs"||l=="sc")&&(r="GM-a",s="000");break}case 0:{r="GM-a";break}default:r="y",o=3}break}case 8:{l=="sg"?r="GM-s":r="r:";break}case 32:case 33:case 34:case 35:case 36:{l=="xg"&&(r=`${["AP","VL","PF","DX","AN"][e&7]}-${"abcdefgh"[n]}`,o=3);break}case 48:{s=`M${(i[2]>>3).toString().padStart(2,"0")}`,r=`y${s}`,o=1;break}case 56:{r="GM-b";break}case 57:r=["yDOC","QY10","QY20"][i[2]-112]||"yMxv",s=["DOC","QY1","QY2"][i[2]-112]||"057";case 61:case 120:{r="rDrm";break}case 62:{r="kDrm";break}case 63:{if(i[2]<17){let E=i[2];r=E<10?"kP:":"kC:",r+=E%10}else i[2]<34?r=["Pre1","Pre2","Pre3","Pre4","Usr1","Usr2","DrmP","DrmU","Plg1","Plg2","Plg3","Pre1","Pre2","Pre3","Pre4","Pre5","Pre6"][i[2]-17]:r="Ds";o=1;break}case 64:{r="ySFX",s="SFX";break}case 67:{r="DX:S";break}case 80:case 81:case 82:case 83:{r=`Prg${"UABC"[i[0]-80]}`;break}case 88:case 89:case 90:case 91:{r=`Cmb${"UABC"[i[0]-88]}`;break}case 95:{r=`${["DR","PC"][i[2]]}-d`;break}case 96:{r=i[2]==106?"AP-a":i[2]>>4==1?"SDg":"PF",i[2]>63?c=63:i[2]>>4==1&&(c=16),o=3;break}case 97:{r=i[2]>>4==1?"SDa":"VL:",o=3,i[2]>>4==1?c=16:c=112;break}case 98:{r=i[2]>>4==1?"SDb":"SG-a",o=3,c=16;break}case 99:{r=i[2]>>4==1?"SDc":"DX",i[2]>63?c=63:i[2]>>4==1&&(c=16),o=3;break}case 100:{r="AN",i[2]>63?c=63:i[2]>>4==1&&(c=16),o=3;break}case 104:case 105:case 106:case 107:{r="SDd",c=104;break}case 121:{r=`GM-${i[2]?"":"a"}`,o=3;break}case 122:{r="lDrm";break}case 126:{r="yDrS";break}case 127:{i[2]==127?r="rDrm":r="yDrm";break}default:i[0]<48?r="r:":r="M"}r.length<4&&(r+=`${[e,n,i[0],i[2]][o]-c}`.padStart(4-r.length,"0")),s.length<3&&(s+=`${[e,n,e,n][o]}`.padStart(3-s.length,"0")),l=="xg"&&(e==0?i[2]<100?r=r.replace("y0","y:"):i[2]==125&&(r="y126"):e==16?(p=`Voice${((i[2]<<7)+i[1]+1).toString().padStart(3,"0")}`,d=" "):e==35&&n>>1==2&&(p=`DXCH_${(((i[2]&1)<<7)+t+1).toString().padStart(3,"0")}`,d=" "));let u=[i[0],i[1],i[2]];for(;!(p?.length>=0);)if(p=this.#t[i[1]||0][(i[0]<<7)+i[2]]?.name,p){let E=this.#t[i[1]||0][(i[0]<<7)+i[2]];y=E?.poly||y,v=E?.type||v,a=E?.drum}else if(this.strictMode)p="",d="?";else if(i[0]==0&&i[1]==0&&i[2]==0)p="Unloaded";else if(this.#t[i[1]||0][i[0]<<7])i[0]==0?(i[2]=0,d="^"):i[2]<1?(i[0]=0,d="*"):(i[2]--,d="^");else if(e==48)i[0]=0,i[2]=0,d="!";else if(e==62)i[1]--,d=" ",i[1]<1&&!p?.length&&(i[0]=0,d="!");else if(e<63)i[0]==0?(i[2]=0,d="^"):i[2]<1?(i[0]=0,d="*"):i[2]--;else if(e==80)p=`PrgU:${t.toString().padStart(3,"0")}`,d="!";else if(e==88)p=`CmbU:${t.toString().padStart(3,"0")}`,d="!";else if(e==121)p=`GM2Vox0${n}`,d="#";else if(e==122)if(i[1]==32?i[1]==0:i[1]%=7,p=this.#t[i[1]||0][(i[0]<<7)+i[2]]?.name,p){d=" ";let E=this.#t[i[1]||0][(i[0]<<7)+i[2]];y=E?.poly||y,v=E?.type||v,a=E?.drum}else p="",d="*";else i[1]==0?(p=`${e.toString().padStart(3,"0")} ${t.toString().padStart(3,"0")} ${n.toString().padStart(3,"0")}`,d="!"):i[0]==0?(i[2]=0,d="^"):i[2]>0?i[2]--:i[1]>0?(i[1]=0,d="!"):(i[0]=0,d="?");let f=[i[0],i[1],i[2]];switch(d){case"^":{switch(l){case"gs":case"sc":case"ns5r":{d=" ";break}}e==127&&d=="^"&&(d=" ");break}}let b="??";switch(i[0]){case 0:{i[2]==0?b="GM":i[2]==5||i[2]==7?b="KG":i[2]<126?b="XG":i[2]==127&&(b="MT");break}case 32:case 33:case 35:case 36:{i[2]>4?b=["AP","VL","PF","DX","AN"][i[0]-32]:b="GS";break}case 48:{b="MU";break}case 56:{b="AG";break}case 61:case 80:case 83:case 88:case 89:case 91:{b="AI";break}case 62:case 82:case 90:{b="XD";break}case 63:{i[2]<17?b="KR":i[2]<34?b="ES":b="DS";break}case 64:case 126:{b="XG";break}case 67:case 99:{b=i[2]>>4==1?"SD":"DX";break}case 81:{b="RW";break}case 95:{b=["DR","PC"][i[2]];break}case 96:{b=i[2]==106?"AP":i[2]>>4==1?"SD":"PF";break}case 97:{b=i[2]>>4==1?"SD":"VL";break}case 98:{b=i[2]>>4==1?"SD":"SG";break}case 100:{b="AN";break}case 104:case 105:case 106:case 107:{b="SD";break}case 120:{b="GS";break}case 121:{b=i[2]?"G2":"GM";break}case 122:{b="KG";break}case 127:{b=i[2]==127?"MT":t==0?"GM":"XG";break}default:i[0]<48&&(i[0]==16&&l=="xg"?b="XG":b="GS")}return d!=" "&&(l=="krs"||self.debugMode)&&(p="",b="KR"),{name:p||`${j(e||0)} ${j(t||0)} ${j(n||0)}`,poly:y,type:v,drum:a,iid:u,eid:f,sid:h,ending:d,sect:r,bank:s,standard:b,mode:l}}async load(e,t,n="(internal)"){let l=this,h=[],p=0,y=0;e.split(`
`).forEach(function(v,a){let i=v.split("	"),d=[];if(a==0){if(i.forEach(function(r,s){h[et.indexOf(r)]=s}),h.length<4){console.debug("Debugger launched.");debugger}}else{let r=0,s=0,o=0,c,u=1,f=0,b;i.forEach(async function($,x){switch(x){case h[0]:{r=parseInt($);break}case h[1]:{s=parseInt($);break}case h[2]:{o=parseInt($);break}case h[3]:{c=$;break}case h[4]:{$=parseInt($),$<16?u=$+1:f=($&15)+1;break}case h[5]:{b=$;break}}}),l.#t[s]=l.#t[s]||[];let E=l.#t[s];if(!E[r<<7|o]||t){let $={msb:r,prg:s,lsb:o,name:c,poly:u,type:f,drum:b};E[r<<7|o]=$,p++}y++}}),t||console.debug(`Map "${n}": ${y} total, ${p} loaded.`)}clearRange(e){let t=e.prg!=null?e.prg.constructor==Array?e.prg:[e.prg,e.prg]:[0,127],n=e.msb!=null?e.msb.constructor==Array?e.msb:[e.msb,e.msb]:[0,127],l=e.lsb!=null?e.lsb.constructor==Array?e.lsb:[e.lsb,e.lsb]:[0,127];for(let h=n[0];h<=n[1];h++){let p=h<<7;for(let y=l[0];y<=l[1];y++){let v=p+y;for(let a=t[0];a<=t[1];a++)delete this.#t[a][v]}}}init(){this.#t=[];for(let e=0;e<128;e++)this.#t.push([""])}async loadFiles(...e){this.init();let t=this;e.forEach(async function(n){try{await fetch(`./data/bank/${n}.tsv`).then(function(l){return l.text()}).then(l=>{t.load(l,!1,n)})}catch{console.error(`Failed loading "${n}.tsv".`)}})}constructor(...e){this.loadFiles(...e)}};var pe=class{#t={};context;set(e,t){this.#t[e]=t}has(e){return!!this.#t[e]}async read(e,t){if(!this.has(e))throw new Error(`No decoder registered for "${e}"`);return await this.#t[e].call(this.context||this,t)}};var tt=function(e,t){let n=!0;return t.forEach((l,h)=>{n=n&&e[h]==l}),n},V=function(e){let t=0;return e.forEach(n=>{t*=256,t+=n}),t},U=new TextDecoder,G=new pe;G.set("s7e",async function(e){let t=new Uint8Array(await e.slice(0,65536).arrayBuffer()),n="MSB	LSB	PRG	NME",l=[0,0,0,0],h=32,p=0,y=0,v=!0,a=[],i=0;for(;v;){let d=t.subarray(p);([()=>{U.decode(d.subarray(0,4))=="YSFC"?(p+=80,y=1):p++},()=>{if(tt(d.subarray(0,4),l))a.forEach((r,s,o)=>{let c=V(t.subarray(r.start+4,r.start+8));r.length=c}),y=2;else{let r=U.decode(d.subarray(0,4)),s=V(d.subarray(4,8));a.push({type:r,start:s}),p+=8}},()=>{let r=a[i],s=t.subarray(r.start,r.start+r.length),o=32;switch(r.type){case"ENVC":{let c=h;for(;c<s.length;){let u=s.subarray(c,c+o),f=U.decode(u.subarray(0,10)).trimEnd();f.slice(0,5)=="Init "&&(f=""),f&&(n+=`
063	${(u[17]+13).toString().padStart(3,"0")}	${u[19].toString().padStart(3,"0")}	${f}`),c+=o}break}case"EDVC":{let c=h;for(;c<s.length;){let u=s.subarray(c,c+o),f=U.decode(u.subarray(0,10)).trimEnd();f.slice(0,5)=="Init "&&(f=""),f&&(n+=`
063	024	${u[19].toString().padStart(3,"0")}	${f}`),c+=o}break}case"EPVC":{let c=32,u=h;for(;u<s.length;){let f=s.subarray(u,u+c),b=U.decode(f.subarray(0,10)).trimEnd();b=="----------"&&(b=""),b&&(n+=`
063	${(f[17]+1).toString().padStart(3,"0")}	${f[19].toString().padStart(3,"0")}	${b}`),u+=c}break}}i++,i>=a.length&&(y=3,v=!1)}][y]||(()=>{v=!1}))()}return n});G.set("pcg",async function(e){let t=new Uint8Array(await e.arrayBuffer()),n="MSB	LSB	PRG	NME",l=100,h=0,p=0,y=!0,v=[],a=0;for(;y;){let i=t.subarray(l);([()=>{y=U.decode(i.subarray(0,4))=="INI2",p=i[15],l+=16,h=1},()=>{let d=U.decode(i.subarray(0,4)),r=i[5],s=i[7],o=i[11],c=V(i.subarray(12,16)),u=V(i.subarray(16,20)),f=V(i.subarray(36,40)),b=U.decode(i.subarray(44,44+o));v.push({type:d,tipMsb:r,tipLsb:s,nameLen:o,length:c,start:u,entryLen:f,name:b}),l+=64,p--,p<1&&(h=2)},()=>{let d=v[a],r=t.subarray(d.start,d.start+d.length);switch(d.type){case"PRG1":break;case"PBK1":{let s=63,o=(d.tipMsb?6:0)+d.tipLsb;for(let c=0;c<128;c++){let u=c*d.entryLen,f=r.subarray(u,u+d.entryLen),b=U.decode(f.subarray(0,24)).trimEnd().replace("InitProg","");b.length&&o>5&&(n+=`
${s.toString().padStart(3,"0")}	${o.toString().padStart(3,"0")}	${c.toString().padStart(3,"0")}	${b}`)}break}case"CBK1":{let s=63,o=(d.tipMsb?3:0)+d.tipLsb+10;for(let c=0;c<128;c++){let u=c*d.entryLen,f=r.subarray(u,u+d.entryLen),b=U.decode(f.subarray(0,24)).trimEnd().replace("InitCombi","");b.length&&o>12&&(n+=`
${s.toString().padStart(3,"0")}	${o.toString().padStart(3,"0")}	${c.toString().padStart(3,"0")}	${b}`)}break}}a++,a>=v.length&&(h=3,y=!1)}][h]||(()=>{y=!1}))()}return n});var _=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]),F=["melodic","drums","drum set 1","drum set 2","drum set 3","drum set 4","drum set 5","drum set 6","drum set 7","drum set 8"],at=[17.1,18.6,20.2,21.8,23.3,24.9,26.5,28,29.6,31.2,32.8,34.3,35.9,37.5,39,40.6,42.2,43.7,45.3,46.9,48.4,50],X=[20,22,25,28,32,36,40,45,50,56,63,70,80,90,100,110,125,140,160,180,200,225,250,280,315,355,400,450,500,560,630,700,800,900,1e3,1100,1200,1400,1600,1800,2e3,2200,2500,2800,3200,3600,4e3,4500,5e3,5600,6300,7e3,8e3,9e3,1e4,11e3,12e3,14e3,16e3,18e3,2e4],ge=[0,.04,.08,.13,.17,.21,.25,.29,.34,.38,.42,.46,.51,.55,.59,.63,.67,.72,.76,.8,.84,.88,.93,.97,1.01,1.05,1.09,1.14,1.18,1.22,1.26,1.3,1.35,1.39,1.43,1.47,1.51,1.56,1.6,1.64,1.68,1.72,1.77,1.81,1.85,1.89,1.94,1.98,2.02,2.06,2.1,2.15,2.19,2.23,2.27,2.31,2.36,2.4,2.44,2.48,2.52,2.57,2.61,2.65,2.69,2.78,2.86,2.94,3.03,3.11,3.2,3.28,3.37,3.45,3.53,3.62,3.7,3.87,4.04,4.21,4,37,4.54,4.71,4.88,5.05,5.22,5.38,5.55,5.72,6.06,6.39,6.73,7.07,7.4,7.74,8.08,8.41,8.75,9.08,9.42,9.76,10.1,10.8,11.4,12.1,12.8,13.5,14.1,14.8,15.5,16.2,16.8,17.5,18.2,19.5,20.9,22.2,23.6,24.9,26.2,27.6,28.9,30.3,31.6,33,34.3,37,39.7],me=function(e){let t=.1,n=-.3;return e>66?(t=5,n=315):e>56?(t=1,n=47):e>46&&(t=.5,n=18.5),t*e-n},be=function(e){return e>105?at[e-106]:e>100?e*1.1-100:e/10},ye=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),te={};`hi*,
ka,か
ki,き
ku,く
ke,け
ko,こ
ky,き!
kw,くl
tsu,つ
ts,つl
sa,さ
si,すぃ
su,す
se,せ
so,そ
shi,し
sh,し!
ta,た
ti,てぃ
tu,とぅ
te,て
to,と
tchy,ち!
tchi,ち
na,な
ni,に
nu,ぬ
ne,ね
no,の
ny,に!
nn,ん
ha,は
hi,ひ
hu,ほぅ
he,へ
ho,ほ
hy,ひ!
fa,ふぁ
fi,ふぃ
fu,ふ
fe,ふぇ
fo,ふぉ
ma,ま
mi,み
mu,む
me,め
mo,も
my,み!
mm,
ra,ら
ri,り
ru,る
re,れ
ro,ろ
ry,り!
wa,わ
wi,うぃ
we,うぇ
wo,を
nga,ガ
ngi,ギ
ngu,グ
nge,ゲ
ngo,ゴ
ngy,ギ!
ng,
ga,が
gi,ぎ
gu,ぐ
ge,げ
go,ご
gy,ぎ!
gw,ぐl
za,ざ
zi,ずぃ
zu,ず
ze,ぜ
zo,ぞ
ja,じゃ
ji,じ
ju,じゅ
je,じぇ
jo,じょ
jy,じ!
da,だ
di,でぃ
du,どぅ
de,で
do,ど
dy,で!
ba,ば
bi,び
bu,ぶ
be,べ
bo,ぼ
by,び!
va,ゔぁ
vi,ゔぃ
vu,ゔ
ve,ゔぇ
vo,ゔぉ
pa,ぱ
pi,ぴ
pu,ぷ
pe,ペ
po,ぽ
py,ぴ!
!ya,ゃ
!yu,ゅ
!ye,ぇ
!yo,ょ
ya,や
yu,ゆ
ye,いぇ
yo,よ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
la,ぁ
li,ぃ
lu,ぅ
le,ぇ
lo,ぉ
a,あ
i,い
u,う
e,え
o,お
*,っ
~,
^,
_,`.split(`
`).forEach(e=>{let t=e.split(",");te[t[0]]=t[1]});var Ee=function(e){let t=e;e[0]=="*"&&(t=t.slice(1)),["aa","ii","uu","ee","oo"].forEach(l=>{for(;t.indexOf(l)>-1;)t=t.replace(l,l[0])});for(let l in te)t=t.replaceAll(l,te[l]);t.indexOf("ん")==0&&t.length>1&&(t=t.slice(1));let n=t.indexOf("!");return n>-1&&t.length>1&&(t=t.slice(n+1)),t},ve=function(e){return e?e<96?`cc${e}`:["aftertouch","velocity","pitch bend"][e-96]:"off"};var ae=["room 1","room 2","room 3","hall 1","hall 2","plate","delay","panning delay"],we=["chorus 1","chorus 2","chorus 3","chorus 4","feedback","flanger","short delay","short delay feedback"],$e=["delay 1","delay 2","delay 3","delay 4","pan delay 1","pan delay 2","pan delay 3","pan delay 4","delay to reverb","pan repeat"];var rt={0:"thru",256:"stereo EQ",257:"spectrum",258:"enhancer",259:"humanizer",272:"overdrive",273:"distortion",288:"phaser",289:"auto wah",290:"rotary",291:"stereo flanger",292:"step flanger",293:"tremelo",294:"auto pan",304:"compressor",305:"limiter",320:"hexa chorus",321:"tremelo chorus",322:"stereo chorus",323:"space D",324:"3D chorus",336:"stereo delay",337:"modulated delay",338:"3-tap delay",339:"4-tap delay",340:"tremelo control delay",341:"reverb",342:"gate reverb",343:"3D delay",352:"2-pitch shifter",353:"feedback pitch shifter",368:"3D auto",369:"3D manual",370:"Lo-Fi 1",371:"Lo-Fi 2",512:"overdrive - chorus",513:"overdrive - flanger",514:"overdrive - delay",515:"distortion - chorus",516:"distortion - flanger",517:"distortion - delay",518:"enhancer - chorus",519:"enhancer - flanger",520:"enhancer - delay",521:"chorus - delay",522:"flanger - delay",523:"chorus - flanger",524:"rotary multi",1024:"guitar multi 1",1025:"guitar multi 2",1026:"guitar multi 3",1027:"clean guitar multi 1",1028:"clean guitar multi 2",1029:"bass multi",1030:"rhodes multi",1280:"keyboard multi",4352:"chorus / delay",4353:"flanger / delay",4354:"chorus / flanger",4355:"overdrive / distortion",4356:"overdrive / rotary",4357:"overdrive / phaser",4358:"overdrive / auto wah",4359:"phaser / rotary",4360:"phaser / auto wah"},it={66307:["drive"],66309:["vowel",e=>"aiueo"[e]],94723:["pre-filter"],94724:["Lo-Fi type"],94725:["post-filter"],94979:["Lo-Fi type"],94980:["fill type",e=>["off","LPF","HPF"][e]],94984:["noise type",e=>["white","pink"][e]],94987:["disc type",e=>["LP","SP","EP","RND"]],94990:["hum type",e=>`${e+5}0Hz`],94993:["M/S",e=>["mono","stereo"][e]]},re=function(e){return rt[(e[0]-32<<8)+e[1]]||`0x${e[0].toString(16).padStart(2,"0")}${e[1].toString(16).padStart(2,"0")}`},ke=function(e,t,n){let l=(e[0]-32<<16)+(e[1]<<8)+t,h=it[l]||{},p=h[0];if(p?.length)return p+=`: ${(h[1]||function(){})(n)||n}`,p},ie=[68,48,95,78,41,3,110,122,0];var P=function(e=64){return Math.round(2e3*Math.log10(e/64))/100},xe=function(e,t,n){let l=[],h=n==!1?t.readIntVLV():n;e==0||e==127;for(let p=0;p<h;p++){let y=t.readInt(1);if(l.push(y),y!=247){if(y!=240){if(y>127)return console.debug(`Early termination: ${l}`),l.pop(),t.backOne(),t.backOne(),new Uint8Array(l)}}}return new Uint8Array(l)},N=function(e){let t=0;return e.forEach(n=>{t+=n,t=t&127}),~t+1&127},I=function(e,t){let n=0,l=0;for(let h=0;h<e.length;h++){let p=h%8-1,y=(l>>p&1)<<7,v=e[h];v+=y,h%8!=0?(t(v,n,e),n++):l=e[h]}};var K=function(e){let t=Math.floor(e*14.2);return t<128?t:0},T=function(){return!!self.Bun||self.debugMode||!1};var R=["?","gm","gs","sc","xg","g2","mt32","doc","qy10","qy20","ns5r","x5d","05rw","k11","sg","sd","krs","s90es","motif","trin"],st={gm2:"g2","mt-32":"mt32","c/m":"mt32",ag10:"05rw","ag-10":"05rw","05r/w":"05rw",x5:"05rw",x5dr:"x5d",gmega:"k11","kross 2":"krs","motif es":"motif","s90 es":"s90es",trinity:"trin","tr-rack":"trin"},nt=["melodic","drum","menu"],Te={"?":[0,0,120],gm:[0,0,127],gs:[0,0,120],sc:[0,0,120],xg:[0,0,127],g2:[0,0,120],mt32:[0,127,127],doc:[57,112,127],qy10:[57,113,127],qy20:[57,114,127],ns5r:[0,0,61],x5d:[82,0,62],"05rw":[81,0,62],k11:[0,0,122],sg:[0,0,122],sd:[97,0,105],krs:[121,0,120],s90es:[0,0,127],motif:[0,0,127],trin:[0,0,127]},Se=[9,25,41,57,73,89,105,121],ct=[0,3,81,84,88],Ce={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},Me={0:0,1:1,2:3,5:4},Re={0:0,1:1,2:2,5:3},Pe=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],De=[36,37,48,49,52,53],Y=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65],Ae={26:127,29:0,30:0,31:0,52:12,53:54},z=[0,1,2,4,5,6,7,8,10,11,32,38,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,84,91,92,93,94,95,98,99,100,101,128,12,13,16,17,18,19,14,15,20,21,26,28,80,81,83,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],ot=[2,12,13,14,15,16,17,18,19,20,21,80,81,83,136,130,131,132,133,134,135,137,138,139,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],lt=[33,99,100,32,102,8,9,10],Le=[0,16,25,40,32,64,26,48],w={};R.forEach((e,t)=>{w[e]=t});var m={length:z.length};z.forEach((e,t)=>{m[e]=t});var A={length:Y.length};Y.forEach((e,t)=>{A[e]=t});var dt={};nt.forEach((e,t)=>{dt[e]=t});var ft=function(e){let t=[],n=0;return e?.forEach(function(l,h){l==247?t.push(e.subarray(n,h)):l==240&&(n=h+1)}),t.length||t.push(e.subarray(0)),T()&&console.debug(t),t};var Ie=8,g={port:Ie,ch:Ie<<4,cc:z.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,rpnt:4,ace:8,drm:8,dpn:Y.length,dnc:128,ext:3,efx:7,cvn:12,redir:32,invalidCh:255},D={bank0:128},Oe=class extends W{NOTE_IDLE=0;NOTE_ATTACK=1;NOTE_DECAY=2;NOTE_SUSTAIN=3;NOTE_HELD=4;NOTE_RELEASE=5;NOTE_SOSTENUTO_ATTACK=8;NOTE_SOSTENUTO_DECAY=9;NOTE_SOSTENUTO_SUSTAIN=10;NOTE_SOSTENUTO_HELD=11;CH_MELODIC=0;CH_DRUMS=1;CH_DRUM1=2;CH_DRUM2=3;CH_DRUM3=4;CH_DRUM4=5;CH_DRUM5=6;CH_DRUM6=7;CH_DRUM7=8;CH_DRUM8=9;DUMP_ALL=0;DUMP_ONCE=1;DUMP_MODE=2;EXT_NONE=0;EXT_VL=1;EXT_DX=3;VLBC_BRTHEXPR=1;VLBC_VELOINIT=2;VLBC_VELOALL=3;CH_INACTIVE=0;CH_ACTIVE=1;CH_DISABLED=2;#t=0;#m=0;#T=0;#h=new Array(11);get#w(){return this.#h[this.#m]}set#w(e){this.#h[this.#m]=e}#k=new Uint8Array(g.ch);#u=new Uint8Array(g.ch);#i=new Uint8Array(g.ch);#e=new Uint8Array(g.ch*g.cc);#d=new Uint8Array(g.ch*g.ace);#r=new Uint8Array(g.ch);#p=new Uint8Array(g.ch*g.nn);#b=new Uint8Array(g.ch);#g=new Uint16Array(g.pl);#x=new Uint8Array(g.pl);#I=new Int16Array(g.ch);#O=new Uint8Array(g.ch);#U=new Uint8Array(g.ch);#M=new Uint8Array(g.ch*g.ext);#s=new Uint8Array(g.ch*g.rpn);#o=new Uint8Array(g.ch*g.rpnt);#H=new Int8Array(g.ch*De.length);#l=new Uint8Array(g.drm*g.dpn*g.dnc);#P=new Uint8Array(g.drm*2);#S=new Uint8Array(g.efx*3);#a=new Uint8Array(g.ch);#R=new Uint8Array(g.ch*g.redir);#n=new Uint8Array(g.port);#E=new Uint8Array(g.ch);#$=new Uint8Array(g.ch);#z=new Uint8Array(g.ch*g.cvn);#A=new Uint8Array(128);#L=new Uint8Array(g.cmt*8);#q=new Uint8Array(1024);#_=new Uint8Array(g.cmt*64);#y={};#c;#X;#Y;#f=100;#G=0;#ne=500;#ce=0;#Q="";#Z=0;#le=0;#oe=0;#F=!0;#v=!1;#he=1;#de;#j=new Array(g.ch);#B=[];#W=new Uint8Array(g.ch);#J=new Uint8Array(g.tr);baseBank=new ee("gm","gm2","xg","gs","ns5r","sd","gmega","plg-vl","plg-pf","plg-dx","plg-an","plg-dr","plg-sg","kross","s90es");userBank=new ee("gm");initOnReset=!1;aiEfxName="";chRedir(e,t,n){let l=this;if(l.#J[t])return(l.#J[t]-1)*16+e;if(l.#t==w.sc){if(n==1)return e;let h=0,p=!0;for(;p;)l.#W[e+h]==0?(l.#W[e+h]=t,console.debug(`Assign track ${t} to channel ${e+h+1}.`),p=!1):this.#W[e+h]==t?p=!1:(h+=16,h>=128&&(h=0,p=!1));return e+h}else return e}getTrackPort(e){return this.chRedir(0,e,!0)>>4}forceVoiceRefresh(){for(let e=0;e<g.ch;e++)this.#k[e]&&this.dispatchEvent("voice",{part:e})}#D=[];#ee;#C={nOff:(e,t)=>{let n=e*128+t,l=this.#g.lastIndexOf(n);if(l>-1)if(this.#e[g.cc*e+m[64]]>63)this.#x[l]=this.NOTE_HELD,this.dispatchEvent("note",{part:e,note:t,velo:this.#p[n],state:this.NOTE_HELD});else if(this.#e[g.cc*e+m[66]]>63&&this.#x[l]==this.NOTE_SOSTENUTO_SUSTAIN)this.#x[l]=this.NOTE_SOSTENUTO_HELD,this.dispatchEvent("note",{part:e,note:t,velo:this.#p[n],state:this.NOTE_SOSTENUTO_HELD});else{this.#g[l]=0,this.#p[n]=0,this.#x[l]=this.NOTE_IDLE;let h=this.getExt(e)[1];(h==this.VLBC_VELOINIT||h==this.VLBC_VELOALL)&&(this.#e[g.cc*e+m[129]]=0),this.dispatchEvent("note",{part:e,note:t,velo:0,state:this.NOTE_IDLE})}},nOn:(e,t,n)=>{let l=e*128+t,h=0;for(this.#b[e]&&this.#C.ano(e);this.#x[h]>0&&this.#g[h]!=l;)h++;if(h<g.pl){this.#g[h]=l,this.#p[l]=n,this.#x[h]=this.NOTE_SUSTAIN,this.#O[e]<n&&(this.#O[e]=n);let p=this.getExt(e)[1];(p==this.VLBC_VELOINIT||p==this.VLBC_VELOALL)&&(this.#e[g.cc*e+m[129]]=n),this.dispatchEvent("note",{part:e,note:t,velo:n,state:this.NOTE_SUSTAIN})}else console.error("Polyphony exceeded.")},nAt:(e,t,n)=>{},cAt:(e,t)=>{},hoOf:e=>{this.#x.forEach((t,n)=>{if(t==this.NOTE_HELD){let l=this.#g[n],h=l>>7;e==h&&(this.#x[n]=this.NOTE_IDLE,this.#g[n]=0,this.#p[l]=0,this.dispatchEvent("note",{part:e,note:l&127,velo:0,state:this.NOTE_IDLE}))}})},soOn:e=>{this.#x.forEach((t,n)=>{let l;switch(t){case this.NOTE_ATTACK:{l=this.NOTE_SOSTENUTO_ATTACK;break}case this.NOTE_DECAY:{l=this.NOTE_SOSTENUTO_DECAY;break}case this.NOTE_SUSTAIN:{l=this.NOTE_SOSTENUTO_SUSTAIN;break}}if(l){this.#x[n]=l;let h=this.#g[n];this.dispatchEvent("note",{part:e,note:h&127,velo:this.#p[h],state:l})}})},soOf:e=>{this.#x.forEach((t,n)=>{if(t==this.NOTE_SOSTENUTO_HELD){let l=this.#g[n],h=l>>7;e==h&&(this.#x[n]=this.NOTE_IDLE,this.#g[n]=0,this.#p[l]=0,this.dispatchEvent("note",{part:e,note:l&127,velo:0,state:this.NOTE_IDLE}))}})},ano:e=>{this.#g.forEach((t,n,l)=>{let h=t>>7,p=t&127;t==0&&this.#p[0]==0||h==e&&this.#C.nOff(h,p)})}};#fe={8:function(e){let t=e.channel,n=e.data[0];this.#C.nOff(t,n)},9:function(e){let t=e.channel,n=this;if(n.getChModeId(t)==w.xg&&n.#i[t]>1){let p=n.getChDrumFirstWrite(t);p[0]&&p[1]!=g.invalidCh&&!n.#k[t]&&(n.copyChSetup(p[1],t),n.dispatchEvent("voice",{part:t}),console.debug(`Part CH${t+1} copied from CH${p[1]}.`))}n.setChActive(t,1);let l=e.data[0],h=e.data[1];h>0?n.#C.nOn(t,l,h):n.#C.nOff(t,l)},10:function(e){let t=e.channel,n=t*128+e.data[0];this.#g.indexOf(n)>-1&&(this.#p[n]=data[1],this.getExt(t)[1]==this.VLBC_VELOALL&&(this.#e[g.cc*t+m[129]]=data[1]),this.dispatchEvent("note",{part:t,note:e.data[0],velo:e.data[1],state:this.NOTE_SUSTAIN}))},11:function(e){let t=e.channel,n=this,l=this.#j[t],h=l[e.data[0]];h&&(e.data[0]=h),[0,32].indexOf(e.data[0])>-1&&(()=>{switch(this.#t){case w.s90es:case w.motif:{if(e.data[0]==0){[0,63].indexOf(e.data[1])>-1&&this.setChActive(t,1);break}e.data[1]&&this.setChActive(t,1);break}default:{this.setChActive(t,1);break}}})();let p=t*g.cc,y=t*g.ext,v=this.getChModeId(t);switch(e.data[0]){case 96:return;case 97:return;case 120:return;case 121:{this.#C.ano(t),this.#I[t]=0,this.#e[p+m[1]]=0,this.#e[p+m[5]]=0,this.#e[p+m[64]]=0,this.#e[p+m[65]]=0,this.#e[p+m[66]]=0,this.#e[p+m[67]]=0,this.#e[p+m[11]]=127,this.#e[p+m[101]]=127,this.#e[p+m[100]]=127,this.#e[p+m[99]]=127,this.#e[p+m[98]]=127;return}case 123:{this.#C.ano(t);return}case 124:{this.#C.ano(t);return}case 125:{this.#C.ano(t);return}case 126:{this.#b[t]=1,this.#C.ano(t);return}case 127:{this.#b[t]=0,this.#C.ano(t);return}}if(m[e.data[0]]==null)console.warn(`cc${e.data[0]} is not accepted.`);else{switch(ot.indexOf(e.data[0])>-1&&this.allocateAce(t,e.data[0]),e.data[0]){case 0:{switch(T()&&console.debug(`${R[this.#t]}, CH${t+1}: ${e.data[1]}`),this.#t==0?e.data[1]<48?(this.#i[t]>0&&(e.data[1]=this.#e[p],e.data[1]=120,console.debug(`Forced channel ${t+1} to stay drums.`)),e.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${e.data[1]}`),this.switchMode("gs"))):e.data[1]==56?this.switchMode(this.#c.x5==82?"x5d":"05rw"):e.data[1]==62?this.switchMode(this.#c.x5==82?"x5d":"05rw"):e.data[1]==63?this.switchMode(R[this.#c.ds]):(e.data[1]==64||e.data[1]==127)&&this.switchMode("xg"):this.#t==w.gs||this.#t==w.sc?e.data[1]<56&&this.#i[t]>0&&(e.data[1]=this.#e[p],e.data[1]=120,console.debug(`Forced channel ${t+1} to stay drums.`)):this.#t==w.gm&&(e.data[1]<48?this.#i[t]>0&&(e.data[1]=120,this.switchMode("gs",!0),console.debug(`Forced channel ${t+1} to stay drums.`)):(e.data[1]==64||e.data[1]==127)&&this.switchMode("xg",!0)),this.#t){case w.xg:{[79,95,126,127].indexOf(e.data[1])>-1?this.#i[t]==0&&(this.setChType(t,this.CH_DRUM2),console.debug(`CH${t+1} set to drums by MSB.`)):this.#i[t]>0&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`)),[33,81,97].indexOf(e.data[1])>-1?this.#M[y]=this.EXT_VL:[35,67,83,99].indexOf(e.data[1])>-1?this.#M[y]=this.EXT_DX:this.#M[y]=this.EXT_NONE;break}case w["05rw"]:case w.x5d:case w.ns5r:{[61,62,126,127].indexOf(e.data[1])>-1?this.#i[t]==this.CH_MELODIC&&(this.setChType(t,this.CH_DRUM2),console.debug(`CH${t+1} set to drums by MSB.`)):[80,81,82,83].indexOf(e.data[1])>-1||this.#i[t]!=this.CH_MELODIC&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`));break}case w.sd:{[104,105,106,107].indexOf(e.data[1])>-1?this.#i[t]==0&&(this.setChType(t,this.CH_DRUM2),console.debug(`CH${t+1} set to drums by MSB.`)):this.#i[t]>0&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`));break}case w.g2:{e.data[1]==120?this.#i[t]==0&&(this.setChType(t,this.CH_DRUMS),console.debug(`CH${t+1} set to drums by MSB.`)):this.#i[t]>0&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`));break}}this.dispatchEvent("voice",{part:t});break}case 2:{this.getExt(t)[1]==this.VLBC_BRTHEXPR&&(this.#e[p+m[129]]=e.data[1]);break}case 6:{if(this.#U[t]){[w.xg,w.gs,w.sc,w.ns5r].indexOf(this.#t)<0&&console.warn(`NRPN commits are not available under "${R[this.#t]}" mode, even when they are supported in Octavia.`);let a=this.#e[p+m[99]],i=this.#e[p+m[98]];if(a==1){let d=lt.indexOf(i);if(d>-1)this.#e[p+m[71+d]]=e.data[1],T()&&console.debug(`Redirected NRPN 1 ${i} to cc${71+d}.`),this.dispatchEvent("cc",{part:t,cc:71+d,data:e.data[1]});else{let r=De.indexOf(i);r>-1?this.#H[t*10+r]=e.data[1]-64:console.warn(`NRPN 0x01${i.toString(16).padStart(2,"0")} is not supported.`),T()&&console.debug(`CH${t+1} voice NRPN ${i} commit`)}}else{if(Y.indexOf(a)<0){let r=`NRPN 0x${a.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")} `;a==127?console.warn(`${r}is not necessary. Consider removing it.`):console.warn(`${r}is not supported.`)}else{let r=this.#i[t]-2;r<0?console.warn(`CH${t+1} cannot accept drum NRPN as type ${F[this.#i[t]]}.`):this.#l[(r*g.dpn+A[a])*g.dnc+i]=e.data[1]}T()&&console.debug(`CH${t+1} (${F[this.#i[t]]}) drum NRPN ${a} commit`)}}else{let a=Me[this.#e[p+m[100]]],i=Re[this.#e[p+m[100]]];if(this.#e[p+m[101]]==0&&a!=null)switch(T()&&console.debug(`CH${t+1} RPN 0 ${this.#e[p+m[100]]} commit: ${e.data[1]}`),e.data[1]=Math.min(Math.max(e.data[1],Pe[a][0]),Pe[a][1]),this.#s[t*g.rpn+a]=e.data[1],this.#o[t*g.rpnt+i]=1,v){case w.xg:case w.gs:case w.sc:case w.mt32:case w.s90es:case w.motif:{switch(this.#e[p+m[100]]){case 1:case 2:{this.dispatchEvent("pitch",{part:t,pitch:this.getPitchShift(t)});break}}break}default:this.dispatchEvent("pitch",{part:t,pitch:this.getPitchShift(t)})}}break}case 32:{switch(T()&&console.debug(`${R[this.#t]}, CH${t+1} LSB: ${e.data[1]}`),this.#t){case w.s90es:case w.motif:{this.setChType(t,[32,40].indexOf(e.data[1])>-1?this.CH_DRUMS:this.CH_MELODIC,this.#t,!0);break}}this.getExt(t)[0]==this.EXT_DX,this.dispatchEvent("voice",{part:t});break}case 38:{if(!this.#U[t]){let a=Me[this.#e[p+100]],i=Re[this.#e[p+100]];this.#e[p+101]==0&&a!=null&&(this.#s[t*g.rpn+a+1]=e.data[1],this.#o[t*g.rpnt+i]=1)}break}case 64:{e.data[1]<64&&this.#C.hoOf(t);break}case 66:{e.data[1]>>6?this.#C.soOn(t):this.#C.soOf(t);break}case 98:case 99:{this.#U[t]=1;break}case 100:case 101:{this.#U[t]=0;break}}this.#e[p+m[e.data[0]]]=e.data[1],this.dispatchEvent("cc",{part:t,cc:e.data[0],data:e.data[1]})}n.getChModeId(t)==w.xg&&n.#i[t]&&n.setDrumFirstWrite(t)},12:function(e){let t=e.channel,n=this;switch(n.#t){case w.s90es:case w.motif:{e.data&&n.setChActive(t,1);break}default:n.setChActive(t,1)}if(n.getExt(t)[0]==n.EXT_DX){let l=g.cc*t}n.#r[t]=e.data,n.#$[t]=0,T()&&console.debug(`T:${e.track} C:${t} P:${e.data}`),n.dispatchEvent("voice",{part:t}),n.getChModeId(t)==w.xg&&n.#i[t]&&n.setDrumFirstWrite(t)},13:function(e){let t=this,n=e.channel;this.#g.forEach(function(l){let h=l>>7;n==h&&(t.#p[l]=e.data,t.dispatchEvent("note",{part:n,note:l&127,velo:e.data,state:t.NOTE_SUSTAIN}))})},14:function(e){let t=e.channel;this.#I[t]=e.data[1]*128+e.data[0]-8192,this.dispatchEvent("pitch",{part:t,pitch:this.getPitchShift(t)})},15:function(e){ft(e.data).forEach(t=>{let n=t[0],l=t[1];(this.#ue[n]||function(){console.debug(`Unknown manufacturer ${n}.`)})(l,t.subarray(2),e.track)})},248:function(e){},250:function(e){},251:function(e){},252:function(e){},254:function(e){},255:function(e){(this.#D[e.meta]||function(n,l,h){}).call(this,e.data,e.track,e.meta),e.meta!=32&&(this.#G=0);let t=ct.indexOf(e.meta)>-1;if(T()&&console.debug(e),t)return e.reply="meta",e}};#ue={64:(e,t,n)=>{this.#re.run(t,n,e)},65:(e,t,n)=>{if(t[0]<16)if(t[1]==72){let l=t[t.length-1],h=N(t.subarray(3,t.length-1));l==h?this.#V.run(t.subarray(0,t.length-1),n,e):console.warn(`Bad SD checksum ${l} - should be ${h}.`)}else this.#V.run(t,n,e);else{let l=t[t.length-1],h=N(t.subarray(2,t.length-1));l==h?this.#V.run(t.subarray(0,t.length-1),n,e):console.warn(`Bad GS checksum ${l} - should be ${h}.`)}},66:(e,t,n)=>{this.#K.run(t,n,e)},67:(e,t,n)=>{this.#N.run(t,n,e)},68:(e,t,n)=>{this.#se.run(t,n,e)},71:(e,t,n)=>{this.#ie.run(t,n,e)},126:(e,t,n)=>{this.#te.run(t,n,e)},127:(e,t,n)=>{this.switchMode("gm"),this.#ae.run(t,n,e)}};#te;#ae;#N;#V;#K;#re;#ie;#se;buildRchTree(){let e=[];this.#u.forEach((t,n)=>{t<g.ch&&(e[t]?.constructor||(e[t]=[]),e[t].push(n))}),this.#de=e}buildRccMap(){let e=this;for(let t=0;t<g.ch;t++)e.#j[t]={};e.#R.forEach((t,n)=>{t&&(e.#j[Math.floor(n/g.redir)][t]=n%g.redir|128)}),T()&&console.debug(e.#j)}getActive(){return this.#k}getCc(e){let t=this,n=e*g.cc,l=t.#e.subarray(n,n+g.cc);return l[m[0]]=l[m[0]]||t.#y[t.getChModeId(e)][0],l[m[32]]=l[m[32]]||t.#y[t.getChModeId(e)][1],l[m[0]]==D.bank0&&(l[m[0]]=0),l}getCcCh(e,t){let n=this;if(z.indexOf(t)<0)throw new Error("CC number not accepted");let l=n.#e[g.cc*e+m[t]];switch(t){case 0:{l=l||n.#y[n.getChModeId(e)][0],l==D.bank0&&(l=0);break}case 32:{l=l||n.#y[n.getChModeId(e)][1];break}}return l}getCcAll(){let e=this,t=e.#e.slice();for(let n=0;n<g.ch;n++){let l=n*g.cc;t[l+m[0]]=t[l+m[0]]||e.#y[e.getChModeId(n)][0],t[l+m[32]]=t[l+m[32]]||e.#y[e.getChModeId(n)][1],t[m[0]]==D.bank0&&(t[m[0]]=0)}return t}getChSource(){return this.#u}getChType(){return this.#i}setChType(e,t,n=0,l=!1){t&=15;let h=this;n=n||h.getChModeId(e),h.#i[e]=t,t>0&&!l&&(h.#e[e*g.cc+m[0]]=h.#y[n][2])}setChActive(e,t=0){this.#k[e]!=t&&this.dispatchEvent("channeltoggle",{part:e,active:t}),this.#k[e]=t}getExt(e){let t=g.ext*e,n=this.#M.subarray(t,t+g.ext),l=new Uint8Array(n.length);return l.set(n),l[1]=l[1]||this.#he,l}getPitch(){return this.#I}getProgram(){return this.#r}getTexts(){return this.#B.slice()}getVel(e){let t=new Map,n=this;return n.#g.forEach(function(l,h){let p=Math.floor(l/128),y=l%128;e==p&&n.#p[l]>0&&t.set(y,{v:n.#p[l],s:n.#x[h]})}),t}getBitmap(){return{bitmap:this.#w,expire:this.#T}}getLetter(){return{text:this.#Q,set:this.#le,expire:this.#Z}}getMode(){return R[this.#t]}getMaster(){return{volume:this.#f}}getRawStrength(){let e=this;return this.#g.forEach(function(t){let n=Math.floor(t/128);e.#p[t]>e.#O[n]&&(e.#O[n]=e.#p[t])}),this.#O}getStrength(){let e=[],t=this;return this.getRawStrength().forEach(function(n,l){e[l]=Math.floor(n*t.#e[l*g.cc+m[7]]*t.#e[l*g.cc+m[11]]*t.#f/803288)}),e}getRpn(){return this.#s}getNrpn(){return this.#H}getSubDb(){return self?.structuredClone(this.#y)}getVoice(e,t,n,l="?"){let h=this;w[l]?.constructor||(l="?");let p=w[l],y=e||h.#y[p][0],v=t,a=n||h.#y[p][1];y==D.bank0&&(y=0),a==D.bank0&&(a=0),l=="ns5r"&&y>0&&y<56&&(a=3);let i=h.userBank.get(y,v,a,l);if(l=="mt32"&&i.name.indexOf("MT-m:")==0){let d=parseInt(i.name.slice(5)),r=d*g.cmt,s="";h.#_.subarray(r,r+10).forEach(c=>{c>31&&(s+=String.fromCharCode(c))});let o=`MSB	LSB	PRG	NME
0	127	${v}	${s}`;h.userBank.load(o,!0),i.name=s,i.ending=" "}return(i.ending!=" "||!i.name.length)&&(i=h.baseBank.get(y,v,a,l)),i}getChVoice(e){let t=this,n=t.getVoice(t.getCcCh(e,0),t.#r[e],t.getCcCh(e,32),t.getChMode(e));if(t.#$[e]){let l="";switch(t.#t){case w.mt32:{t.#L.subarray(g.cmt*(e-1),g.cmt*(e-1)+10).forEach(h=>{l+=String.fromCharCode(Math.max(h,32))}),l=l.trimRight();break}default:{let h=g.cvn*e;t.#z.subarray(h,h+g.cvn).forEach(p=>{l+=String.fromCharCode(Math.max(p,32))}),l=l.trimRight()}}l.length&&(n.ending="~",n.name=l)}return n}getRawPitch(){return this.#I}getPitchShift(e){let t=this,n=e*g.rpn,l=t.#s[n];return t.#o[e*g.rpnt]||t.#t==w.mt32&&(l=12),t.#I[e]/8192*l+(t.#s[n+3]-64)+((t.#s[n+1]<<7)+t.#s[n+2]-8192)/8192}getEffectType(e=0){let t=3*e+1;return this.#S.subarray(t,t+2)}setEffectTypeRaw(e=0,t,n){let l=3*e;this.#S[l]=1,this.#S[l+1+ +t]=n}setEffectType(e=0,t,n){this.setEffectTypeRaw(e,!1,t),this.setEffectTypeRaw(e,!0,n)}getEffectSink(){return this.#a}setLetterDisplay(e,t,n=0,l=3200){let h=this,p;h.#Q=" ".repeat(n),e.forEach(y=>{h.#Q+=String.fromCharCode(y>31?y:32),y<32&&(p=p||new Set,p.add(y))}),h.#le=Date.now(),h.#Z=Date.now()+l,p&&(p=Array.from(p),p.forEach((y,v,a)=>{a[v]=y.toString(16).padStart(2,"0")}),console.warn(`${t}${t?" ":""}invalid code point${p.length>1?"s":""}: 0x${p.join(", 0x")}`))}setDetectionTargets(e="?",t=0){let n=this,l=-1;switch(e.replaceAll(", ",",").split(",").forEach(h=>{h=h.toLowerCase();let p=R.indexOf(st[h]||h);T()&&console.debug(`Mapped mode "${h}" to ID "${p}".`),p>-1&&(l=p)}),T()&&console.debug(`Set detection target to ID "${l}".`),l>0&&(n.#c.x5=82,n.#c.ds=w.krs),l){case w["05rw"]:{n.#c.x5=81;break}case w.s90es:n.#c.ds=w.s90es,n.#c.smotif=w.s90es;case w.motif:n.#c.ds=w.motif,n.#c.smotif=w.motif}}setGsTargets(e=!1,t=4){if(!t)t=e?3:4;else{if(t>4||t<0)throw new Error(`Invalid GS level ${t}`);if(e&&t>>1!=1)throw new Error(`Invalid SC level ${t}`)}let n=this;n.#c[e?"sc":"gs"]=t,n.#y[w[e?"sc":"gs"]][1]=t,n.forceVoiceRefresh()}getConfigs(){return this.#Y}setDumpLimit(e){if(e>2||e<0)throw new RangeError("Invalid dump limit.");this.#X.dumpLimit=e}allocateAce(e=0,t){let n=this;if(!t||t<128&&t>95){console.warn(`cc${t} cannot be allocated as an active custom effect.`);return}let l=!0,h=0,p=g.ace*e;for(;l&&h<g.ace;)n.#d[h+p]==t?l=!1:n.#d[h+p]||(l=!1,n.#d[h+p]=t,console.info(`Allocated cc${t} to ACE slot ${h} in CH${e+1}.`)),h++;h>=g.ace&&console.warn(`ACE slots are full in CH${e+1}.`)}allocateAceAll(e){let t=this;if(!e||e<128&&e>95){console.warn(`cc${e} cannot be allocated as an active custom effect.`);return}for(let n=0;n<g.ch;n++){let l=!0,h=0,p=g.ace*n;for(;l&&h<g.ace;)t.#d[h+p]==e?l=!1:t.#d[h+p]||(l=!1,t.#d[h+p]=e),h++;h>=g.ace&&console.warn(`ACE slots are full in CH${n+1}.`)}}releaseAce(e=0,t){let n=!0,l=g.ace*e,h=l+g.ace;for(;n&&l<h;)this.#d[l]==t&&(this.#d[l]=0,n=!1),l++;n&&T()&&console.debug(`No ACE slot was allocated to cc${t} in CH${e+1}.`)}resetAce(){this.#d.fill(0),console.info("All ACE slots have been reset.")}getAce(){return this.#d}getChAce(e=0,t=0){if(t<0||t>=g.ace)throw new RangeError("No such ACE slot");let n=this.#d[g.ace*e+t];if(n){if(z.indexOf(n)>=0)return this.#e[e*g.cc+m[n]];throw new Error(`Invalid ACE source in CH${e+1}: ${n}`)}else return 0}initDrums(){let e=this;e.#l.fill(64);for(let t=0;t<g.drm;t++){let n=t*g.dpn;for(let l in Ae){let h=Ae[l],p=(n+A[l])*g.dnc;e.#l.subarray(p,p+g.dnc).fill(h)}}}init(e=0){let t=this;t.#G=0,t.#y[w.xg][1]=0,t.dispatchEvent("banklevel",{mode:"xg",data:0}),t.#k.fill(0),t.#e.fill(0),t.#d.fill(0),t.#r.fill(0),t.#p.fill(0),t.#g.fill(0),t.#b.fill(0),t.#O.fill(0),t.#I.fill(0),t.#H.fill(0),t.#o.fill(0),t.#M.fill(0),t.#n.fill(0),t.#E.fill(0),t.#R.fill(0),t.#f=100,t.#B=[],t.#ne=500,t.#ce=0,t.#T=0,t.#m=0,t.#w.fill(0),t.#v=!1,t.#oe=0,t.#F=!0,t.initDrums(),t.#u.forEach(function(n,l,h){h[l]=l}),e==0&&(t.dispatchEvent("mode","?"),t.#t=0,t.#W.fill(0),t.#J.fill(0),t.#Z=0,t.#Q=""),Se.forEach(n=>{t.#e[g.cc*n]=t.#y[t.getChModeId(n)][2]}),t.#i.fill(t.CH_MELODIC),t.#i[9]=t.CH_DRUM1,t.#i[25]=t.CH_DRUM3,t.#i[41]=t.CH_DRUMS,t.#i[57]=t.CH_DRUMS,t.#i[73]=t.CH_DRUM5,t.#i[89]=t.CH_DRUM7,t.#i[105]=t.CH_DRUMS,t.#i[121]=t.CH_DRUMS;for(let n=0;n<g.drm;n++)t.#P[n<<1]=0,t.#P[n<<1|1]=g.invalidCh;t.#q.fill(0),t.#_.fill(0),t.#A.fill(0),t.#L.fill(0),t.#$.fill(0),t.#S.fill(0),t.#a.fill(0),t.aiEfxName="",t.userBank.clearRange({msb:0,lsb:127,prg:[0,127]});for(let n=0;n<g.ch;n++){let l=n*g.cc;t.#e[l+m[7]]=100,t.#e[l+m[11]]=127,t.#e[l+m[2]]=127,t.#e[l+m[10]]=64,t.#e.subarray(l+m[71],l+m[71]+8).fill(64),t.#e[l+m[128]]=127,t.#e.subarray(l+m[130],l+m[157]+1).fill(64),t.#e[l+m[91]]=40,t.#e[l+m[101]]=127,t.#e[l+m[100]]=127,t.#e[l+m[99]]=127,t.#e[l+m[98]]=127;let h=n*g.rpn;t.#s[h]=2,t.#s[h+1]=64,t.#s[h+2]=0,t.#s[h+3]=64,t.#s[h+4]=0,t.#s[h+5]=0;let p=n*g.ext;t.#M[p+1]=t.VLBC_BRTHEXPR;let y=n*g.redir;t.#R[y+8]=13}t.buildRchTree(),t.buildRccMap(),t.dispatchEvent("mastervolume",t.#f),t.dispatchEvent("efxreverb",t.getEffectType(0)),t.dispatchEvent("efxchorus",t.getEffectType(1)),t.dispatchEvent("efxdelay",t.getEffectType(2)),t.dispatchEvent("efxinsert0",t.getEffectType(3)),t.dispatchEvent("efxinsert1",t.getEffectType(4)),t.dispatchEvent("efxinsert2",t.getEffectType(5)),t.dispatchEvent("efxinsert3",t.getEffectType(6)),t.dispatchEvent("reset"),t.switchMode("?")}setChMode(e,t){let n=this;if(e<0||e>=g.ch)throw new RangeError(`Invalid CH${e+1}`);if(port<0||t>=R.length)throw new RangeError(`Invalid mode ID ${t}`);n.#E[e]=t,n.dispatchEvent("voice",{part:e})}getChMode(e,t){return R[this.getChModeId(e,t)]}getChModeId(e,t){return t?this.#E[e]||this.#n[e>>4]:this.#E[e]||this.#n[e>>4]||this.#t}setPortMode(e,t,n){let l=this;if(e<0||e>=g.ch>>4)throw new RangeError(`Invalid port ${e+1}`);if(t<1)throw new RangeError("Range must be a positive integer");if(e+t>=g.ch>>4)throw new RangeError("Range must be in bound");if(e<0||n>=R.length)throw new RangeError(`Invalid mode ID ${n}`);for(let h=e;h<e+t;h++){l.#n[h]=n;for(let p=h<<4;p<h+1<<4;p++)l.dispatchEvent("voice",{part:p})}}copyChSetup(e,t,n){if(e==t){console.warn(`Failed attempt at overwriting CH${e+1} with its own data.`);return}let l=this;if(n&&l.#k[t]){console.warn(`Failed attempt at copying setup data from CH${e+1} to CH${t+1}.`);return}let h=g.cc*e,p=g.cc*t;l.#r[t]=l.#r[e],l.#e.set(l.#e.subarray(h,h+g.cc),p)}setDrumFirstWrite(e,t){let n=this,l=n.#i[e];if(l<2)return;let h=l-2;if(n.#P[h<<1])if(t)n.#P[h<<1]=0,T()&&console.debug(`First write part for drum set ${h+1} has been reset.`);else return;else t?console.warn(`First write part for drum set ${h+1} is already blank.`):(n.#P[h<<1]=1,n.#P[h<<1|1]=e,console.debug(`First write part for drum set ${h+1} is set to CH${e+1}.`))}getChDrumFirstWrite(e){let t=this,n=t.#i[e];if(n<2)return;let l=n-2;return t.#P.subarray(l<<1,l+1<<1)}getDrumFirstWrite(e){if(e>=0&&e<g.drm)return this.#P.subarray(e<<1,e+1<<1)}switchMode(e,t=!1,n=!1){let l=this,h=w[e];if(h>-1){if(l.#t==0||t){let p=l.#t;l.initOnReset&&t&&(this.init(1),p=w["?"]),l.#t=h,l.#m=0;for(let v=0;v<g.ch;v++)l.#i[v]>0&&l.#E[v]==0&&(l.#e[v*g.cc]=l.#y[h][2]);switch(h){case w.mt32:{ie.forEach((v,a)=>{let i=a+1;l.#k[i]||(l.#r[i]=v,l.#e[i*g.cc+m[91]]=127)});for(let v=1;v<10;v++)l.dispatchEvent("voice",{part:v});break}}let y;switch(h){case w["?"]:case w.g2:{y=[52,4,52,18,0,0,0,0];break}case w.xg:{y=[1,0,65,0,5,0,0,0];break}case w.gm:case w.gs:case w.sc:{y=[40,4,40,18,40,32,32,0];break}case w.sd:{y=[58,0,60,0,61,0,61,0];break}case w["05rw"]:case w.x5d:case w.ns5r:{y=[44,1,44,19,44,0,44,0];break}case w.k11:case w.sg:{y=[24,0,0,0,0,0,0,0];break}case w.mt32:{y=[40,4,0,0,0,0,0,0];break}case w.doc:{y=[24,16,0,0,0,0,0,0];break}case w.motif:case w.s90es:{y=[113,0,117,0,114,0,0,0];break}default:y=[0,0,0,0,0,0,0,0]}for(let v=0;v<g.efx;v++)!l.#S[3*v]&&y[v<<1]?.constructor&&(l.#S[3*v+1]=y[2*v],l.#S[3*v+2]=y[2*v+1],l.dispatchEvent(`efx${["reverb","chorus","delay","insert0"][v]}`,l.getEffectType(v)));n&&l.setDetectionTargets(e),l.dispatchEvent("mode",e),l.forceVoiceRefresh(),Se.forEach(v=>{l.dispatchEvent("voice",{part:v})})}}else throw new Error(`Unknown mode ${e}`)}newStrength(){this.#O.fill(0)}runJson(e){if(e.type>14)return e.type==15&&e.data.constructor!=Uint8Array&&(e.data=Uint8Array.from(e.data)),this.#fe[e.type].call(this,e);{let t=this.chRedir(e.part,e.track),n=!1;this.#de[t]?.forEach(l=>{e.channel=l,n=!0,this.#fe[e.type].call(this,e)}),n||console.warn(`${Ce[e.type]?Ce[e.type]:e.type}${[11,12].includes(e.type)?(e.data[0]!=null?e.data[0]:e.data).toString():""} event sent to CH${t+1} without any recipient.`)}this.#B.length>100&&this.#B.splice(100,this.#B.length-99)}runRaw(e){}async loadBank(e,t){let n=this;switch(e=e.toLowerCase(),e){case"s7e":{n.userBank.clearRange({msb:63,lsb:[21,22]}),n.userBank.clearRange({msb:63,lsb:[24,27]});break}case"pcg":{n.userBank.clearRange({msb:63,lsb:[6,9]}),n.userBank.clearRange({msb:63,lsb:[13,16]});break}default:throw new Error(`Unknown bank format ${e}`)}switch(e){case"s7e":case"pcg":{G.context=this,await n.userBank.load(await G.read(e,t),!1);break}}n.forceVoiceRefresh()}constructor(){super();let e=this;e.#w=new Uint8Array(256),e.#h[10]=new Uint8Array(512),e.#ee=new L,e.#c={x5:82,ds:w.krs,smotif:w.s90es,gs:4,sc:3},e.#X={dumpLimit:e.DUMP_MODE},e.#Y=new Proxy(e.#X,{set:()=>{}});for(let a in Te){let i=w[a];i==null?console.debug(`SubDB build error: "${a}" does not exist`):e.#y[i]=new Uint8Array(Te[a])}e.userBank.strictMode=!0,e.userBank.load(`MSB	PRG	LSB	NME
062	000	000	
122	000	000	
122	001	000	
122	002	000	
122	003	000	
122	004	000	
122	005	000	
122	006	000	`),e.addEventListener("metacommit",function(a){let{data:i}=a;e.#B[0]?.type==i.type&&e.#B[0]?.amend?(e.#B[0].amend=i.amend,e.#B[0].data+=i.data):e.#B.unshift(i)}),e.#D[1]=function(a){switch(a=a.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),a.slice(0,2)){case"@I":{this.#v=!0,this.dispatchEvent("metacommit",{type:"Kar.Info",data:a.slice(2)?.trimLeft()});break}case"@K":{this.#v=!0,this.dispatchEvent("metacommit",{type:"Kar.Mode",data:a.slice(2)?.trimLeft()}),console.debug(`Karaoke mode active: ${a.slice(2)}`);break}case"@L":{this.#v=!0,this.dispatchEvent("metacommit",{type:"Kar.Lang",data:a.slice(2)?.trimLeft()});break}case"@T":{this.#v=!0,this.dispatchEvent("metacommit",{type:"KarTitle",data:a.slice(2)?.trimLeft()});break}case"@V":{this.#v=!0,this.dispatchEvent("metacommit",{type:"Kar.Ver.",data:a.slice(2)?.trimLeft()});break}case"XF":{let i=a.slice(2).split(":");switch(i[0]){case"hd":{i.slice(1).forEach((d,r)=>{d.length&&this.dispatchEvent("metacommit",{type:["XfSngDte","XfSngRgn","XfSngCat","XfSongBt","XfSngIns","XfSngVoc","XfSngCmp","XfSngLrc","XfSngArr","XfSngPer","XfSngPrg","XfSngTag"][r],data:d})});break}case"ln":{i.slice(1).forEach((d,r)=>{d.length&&this.dispatchEvent("metacommit",{type:["XfKarLng","XfKarNme","XfKarCmp","XfKarLrc","XfKarArr","XfKarPer","XfKarPrg"][r],data:d})});break}default:this.dispatchEvent("metacommit",{type:"XfUnData",data:a})}break}default:this.#v?a[0]=="\\"?(this.dispatchEvent("metacommit",{type:"KarLyric",data:"",amend:!1}),this.dispatchEvent("metacommit",{type:"KarLyric",data:a.slice(1),amend:!0})):a[0]=="/"?(this.dispatchEvent("metacommit",{type:"KarLyric",data:"",mask:!0,amend:!1}),this.dispatchEvent("metacommit",{type:"KarLyric",data:a.slice(1),mask:!0,amend:!0})):this.dispatchEvent("metacommit",{type:"KarLyric",data:a,amend:!0}):a.split(`
`).forEach((i,d)=>{this.dispatchEvent("metacommit",{type:"Cmn.Text",data:i,mask:d!=0})})}},e.#D[2]=function(a){this.dispatchEvent("metacommit",{type:"Copyrite",data:a})},e.#D[3]=function(a,i){i<1&&this.#G<1&&this.dispatchEvent("metacommit",{type:"TrkTitle",data:a})},e.#D[4]=function(a,i){this.dispatchEvent("metacommit",{type:"Instrmnt",data:a})},e.#D[5]=function(a){a.trim()==""?this.dispatchEvent("metacommit",{type:"C.Lyrics",data:"",amend:!1}):this.dispatchEvent("metacommit",{type:"C.Lyrics",data:a,amend:!0})},e.#D[6]=function(a){this.dispatchEvent("metacommit",{type:"C.Marker",data:a})},e.#D[7]=function(a){this.dispatchEvent("metacommit",{type:"CuePoint",data:a})},e.#D[32]=function(a){this.#G=a[0]+1},e.#D[33]=function(a,i){T()&&console.debug(`Track ${i} requests to get assigned to output ${a}.`),e.#J[i]=a+1},e.#D[81]=function(a,i){e.#ne=a/1e3},e.#D[127]=function(a,i){e.#ee.run(a,i)},e.#ee.default=function(a){console.warn(`Unrecognized sequencer-specific byte sequence: ${a}`)},e.#ee.add([67,0,1],function(a,i){T()&&console.debug(`XGworks requests assigning track ${i} to output ${a[0]}.`),e.#J[i]=a[0]+1}),e.#te=new L("universal non-realtime"),e.#ae=new L("universal realtime"),e.#N=new L("Yamaha"),e.#V=new L("Roland"),e.#K=new L("Korg"),e.#re=new L("Kawai"),e.#ie=new L("Akai"),e.#se=new L("Casio");let t=new L("DX7+ Dump"),n=function(a){console.info(`Unrecognized SysEx in "${this.name}" set.
%o`,a)};e.#te.default=n,e.#ae.default=n,e.#N.default=n,e.#V.default=n,e.#K.default=n,e.#re.default=n,e.#ie.default=n,e.#se.default=n,t.default=n,e.#te.add([9],(a,i,d)=>{e.switchMode(["gm","?","g2"][a[0]-1],!0),e.setPortMode(e.getTrackPort(i),1,w[["gm","?","g2"][a[0]-1]]),e.#v=e.#v||!1,console.info(`MIDI reset: ${["GM","Init","GM2"][a[0]-1]}`),a[0]==2&&e.init()}),e.#ae.add([4,1],(a,i,d)=>{e.dispatchEvent("mupromptex"),e.#f=((a[1]<<7)+a[0])/16383*100,e.dispatchEvent("mastervolume",e.#f)}).add([4,3],(a,i,d)=>((a[1]<<7)+a[0]-8192)/8192).add([4,4],(a,i,d)=>a[1]-64).add([4,5],(a,i,d)=>{e.dispatchEvent("mupromptex");let r=a[0],s=a[1],o=a[2],c=3,u=c+(r<<1),f=u+s;if(r!=1){console.error(`Unsupported GM2 global parameter set: slotpath length too long (${r})!
`,a);return}let b=0,E=0,$=0;switch(a.subarray(c,u).forEach(x=>{b=b<<7,b|=x}),a.subarray(u,f).forEach((x,C)=>{E|=x<<C*7}),a.subarray(f).forEach((x,C)=>{$|=x<<C*7}),T()&&console.debug(`GM2 global parameter: (${a.subarray(3,u)}; p: ${E}, v: ${$})`),b){case 129:{E==0&&(e.setEffectType(0,52,$),e.dispatchEvent("efxreverb",e.getEffectType(0)));break}case 130:{E==0&&(e.setEffectType(1,52,$|16),e.dispatchEvent("efxchorus",e.getEffectType(1)));break}default:T()&&console.debug("GM2 global paramater slot path unknown.")}}),this.#N.add([76,0,0],(a,i,d)=>{switch(a[0]){case 125:{e.initDrums(),console.info(`XG drum setup reset: ${a}`);break}case 126:{e.switchMode("xg",!0),e.setPortMode(e.getTrackPort(i),4,w.xg),e.#v=!1,console.info("MIDI reset: XG");break}default:{e.dispatchEvent("mupromptex");let r=[0,0,0,0],s=(o,c)=>{r[c]=o};if(a.subarray(1).forEach((o,c)=>{let u=c+a[0];([s,s,s,s,f=>{this.#f=f*129/16383*100,e.dispatchEvent("mastervolume",e.#f)},f=>{},f=>{}][u]||(()=>{}))(o,c)}),a[0]<4){let o=0;r.forEach(c=>{o=o<<4,o+=c}),o-=1024}}}}).add([76,2,1],(a,i,d)=>{e.dispatchEvent("mupromptex");let r="XG ";a[0]<32?(r+="reverb ",a.subarray(1).forEach((s,o)=>{([c=>{e.setEffectTypeRaw(0,!1,c),console.info(`${r}main type: ${_[c]}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},c=>{e.setEffectTypeRaw(0,!0,c),console.debug(`${r}sub type: ${c+1}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},c=>{console.debug(`${r}time: ${me(c)}s`)},c=>{console.debug(`${r}diffusion: ${c}`)},c=>{console.debug(`${r}initial delay: ${c}`)},c=>{console.debug(`${r}HPF cutoff: ${X[c]}Hz`)},c=>{console.debug(`${r}LPF cutoff: ${X[c]}Hz`)},c=>{console.debug(`${r}width: ${c}`)},c=>{console.debug(`${r}height: ${c}`)},c=>{console.debug(`${r}depth: ${c}`)},c=>{console.debug(`${r}wall type: ${c}`)},c=>{console.debug(`${r}dry/wet: ${c}`)},c=>{console.debug(`${r}send: ${P(c)}dB`)},c=>{console.debug(`${r}pan: ${c-64}`)},!1,!1,c=>{console.debug(`${r}delay: ${c}`)},c=>{console.debug(`${r}density: ${c}`)},c=>{console.debug(`${r}balance: ${c}`)},c=>{},c=>{console.debug(`${r}feedback: ${c}`)},c=>{}][a[0]+o]||function(){console.warn(`Unknown XG reverb address: ${a[0]}.`)})(s)})):a[0]<64?(r+="chorus ",a.subarray(1).forEach((s,o)=>{([c=>{e.setEffectTypeRaw(1,!1,c),console.info(`${r}main type: ${_[c]}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},c=>{e.setEffectTypeRaw(1,!0,c),console.debug(`${r}sub type: ${c+1}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},c=>{console.debug(`${r}LFO: ${ge[c]}Hz`)},c=>{},c=>{console.debug(`${r}feedback: ${c}`)},c=>{console.debug(`${r}delay offset: ${be(c)}ms`)},c=>{},c=>{console.debug(`${r}low: ${X[c]}Hz`)},c=>{console.debug(`${r}low: ${c-64}dB`)},c=>{console.debug(`${r}high: ${X[c]}Hz`)},c=>{console.debug(`${r}high: ${c-64}dB`)},c=>{console.debug(`${r}dry/wet: ${c}`)},c=>{console.debug(`${r}send: ${P(c)}dB`)},c=>{console.debug(`${r}pan: ${c-64}`)},c=>{console.debug(`${r}to reverb: ${P(c)}dB`)},!1,c=>{},c=>{},c=>{},c=>{console.debug(`${r}LFO phase diff: ${(c-64)*3}deg`)},c=>{console.debug(`${r}input mode: ${c?"stereo":"mono"}`)},c=>{}][a[0]-32+o]||function(){console.warn(`Unknown XG chorus address: ${a[0]}.`)})(s)})):a[0]<86?(r+="variation ",a.subarray(1).forEach((s,o)=>{([c=>{e.setEffectTypeRaw(2,!1,c),console.info(`${r}main type: ${_[c]}`),e.dispatchEvent("efxdelay",e.getEffectType(2))},c=>{e.setEffectTypeRaw(2,!0,c),console.debug(`${r}sub type: ${c+1}`),e.dispatchEvent("efxdelay",e.getEffectType(2))}][a[0]-64+o]||function(){})(s)})):a[0]<97?(r+="variation ",a.subarray(1).forEach((s,o)=>{[c=>{console.debug(`${r}send: ${P(c)}dB`)},c=>{console.debug(`${r}pan: ${c-64}`)},c=>{console.debug(`${r}to reverb: ${P(c)}dB`)},c=>{console.debug(`${r}to chorus: ${P(c)}dB`)},c=>{console.debug(`${r}connection: ${c?"system":"insertion"}`)},c=>{console.debug(`${r}channel: CH${c+1}`)},c=>{console.debug(`${r}mod wheel: ${c-64}`)},c=>{console.debug(`${r}bend wheel: ${c-64}`)},c=>{console.debug(`${r}channel after touch: ${c-64}`)},c=>{console.debug(`${r}AC1: ${c-64}`)},c=>{console.debug(`${r}AC2: ${c-64}`)}][a[0]-86+o](s)})):a[0]>111&&a[0]<118?r+="variation ":console.warn(`Unknown XG variation address: ${a[0]}`)}).add([76,2,64],(a,i,d)=>{a.subarray(1).forEach((r,s)=>{let o=s+a[0];if(o==0)console.debug(`XG EQ preset: ${["flat","jazz","pop","rock","classic"][r]}`);else{let c=o-1>>2,u=o-1&3,f=`XG EQ ${c} ${["gain","freq","Q","shape"][u]}: `;[()=>{console.debug(`${f}${r-64}dB`)},()=>{console.debug(`${f}${r} (raw)`)},()=>{console.debug(`${f}${r/10}`)},()=>{console.debug(`${f}${["shelf","peak"][+!!r]}`)}][u]()}})}).add([76,3],(a,i,d)=>{e.dispatchEvent("mupromptex");let r=a[0],s=a[1],o=`XG Insertion ${a[0]+1} `;a.subarray(2).forEach((c,u)=>{([f=>{e.setEffectTypeRaw(3+r,!1,f),console.info(`${o}main type: ${_[f]}`),e.dispatchEvent(`efxinsert${r}`,e.getEffectType(3+r))},f=>{e.setEffectTypeRaw(3+r,!0,f),console.debug(`${o}sub type: ${f+1}`),e.dispatchEvent(`efxinsert${r}`,e.getEffectType(3+r))}][s+u]||function(){})(c)})}).add([76,6,0],(a,i,d)=>{let r=a[0];r<64?e.setLetterDisplay(a.subarray(1),"XG letter display",r):e.#Z=Date.now()}).add([76,7,0],(a,i,d)=>{let r=a[0];e.#m=0,e.#T=Date.now()+3200,e.#w.fill(0);let s=a.subarray(1);for(let o=0;o<r;o++)s.unshift(0);s.forEach(function(o,c){let u=Math.floor(c/16),f=c%16,b=(f*3+u)*7,E=7,$=0;for(b-=f*5,u==2&&(E=2);$<E;)e.#w[b+$]=o>>6-$&1,$++})}).add([76,8],(a,i)=>{e.dispatchEvent("mupromptex");let d=e.chRedir(a[0],i,!0),r=a[1],s=g.cc*d,o=`XG CH${d+1} `,c=`Unknown XG part address ${r}.`,u=!0;a.subarray(2).forEach((f,b)=>{u=!0,r<1?console.debug(c):r<41?([()=>{e.#e[s+m[0]]=f,e.dispatchEvent("voice",{part:d})},()=>{e.#e[s+m[32]]=f,e.dispatchEvent("voice",{part:d})},()=>{e.#r[d]=f,e.dispatchEvent("voice",{part:d})},()=>{u=!1;let E=e.chRedir(f,i,!0);e.#u[d]=E,d!=E&&(e.buildRchTree(),console.info(`${o}receives from CH${E+1}`)),e.#k[d]||(e.copyChSetup(E,d,!0),console.debug(`${o}copied from CH${E+1}.`),e.setChActive(d,1),e.dispatchEvent("voice",{part:d}))},()=>{e.#b[d]=+!f},()=>{},()=>{u=!1,e.setChType(d,f,w.xg),console.debug(`${o}type: ${F[f]||f}`),e.dispatchEvent("voice",{part:d})},()=>{e.#s[g.rpn*d+3]=f,e.#o[g.rpnt*d+2]=1,e.dispatchEvent("pitch",{part:d,pitch:e.getPitchShift(d)})},!1,!1,()=>{e.#e[s+m[7]]=f},!1,!1,()=>{e.#e[s+m[10]]=f||128},!1,!1,()=>{e.#e[s+m[128]]=f,e.allocateAce(d,128)},()=>{e.#e[s+m[93]]=f},()=>{e.#e[s+m[91]]=f},()=>{e.#e[s+m[94]]=f},()=>{e.#e[s+m[76]]=f},()=>{e.#e[s+m[77]]=f},()=>{e.#e[s+m[78]]=f},()=>{e.#e[s+m[74]]=f},()=>{e.#e[s+m[71]]=f},()=>{e.#e[s+m[73]]=f},()=>{e.#e[s+m[75]]=f},()=>{e.#e[s+m[72]]=f}][r+b-1]||(()=>{}))():r<48?console.debug(c):r<111?r>102&&r<105&&(e.#e[s+m[[5,65][r&1]]]=f):r<114?console.debug(c):r<116?console.debug(`${o}EQ ${["bass","treble"][r&1]} gain: ${f-64}dB`):r<118?console.debug(c):r<120?console.debug(`${o}EQ ${["bass","treble"][r&1]} freq: ${f}`):console.debug(c)}),u&&e.#i[d]>1&&e.setDrumFirstWrite(d)}).add([76,9],(a,i)=>{let d=e.chRedir(a[0],i,!0),r=a[1],s=g.cc*d,o=`PLG-VL CH${d+1} `;a.subarray(2).forEach((c,u)=>{let f=u+r;switch(f){case 1:{console.info(`${o}breath mode: ${["system","breath","velocity","touch EG"][c]}`);break}case 0:case 27:case 28:break;default:if(f<27){let b=f-3>>1,E=["pressure","embouchure","tonguing","scream","breath noise","growl","throat formant","harmonic enhancer","damping","absorption","amplification","brightness"][b];f&1?f<23?(console.debug(`${o}${E} control source: ${ve(c)}`),c&&c<96&&e.allocateAce(d,130+b),e.#R[g.redir*d+b+2]=c,e.buildRccMap()):console.debug(`${o}${E} scale break point: ${c}`):(console.debug(`${o}${E} depth: ${c-64}`),e.#e[s+m[130+b]]=c)}}})}).add([76,10],(a,i,d)=>{}).add([76,16],(a,i,d)=>{}).add([76,17,0,0],(a,i,d)=>{}).add([76,112],(a,i,d)=>{switch(console.debug(`XG enable PLG-${["VL","SG","DX","AN","PF","DR","PC","AP"][a[0]]} for CH${a[2]+1}.`),a[0]){case 0:{e.#M[g.ext*a[2]]=e.EXT_VL;break}case 2:{e.#M[g.ext*a[2]]=e.EXT_DX;break}default:e.#M[g.ext*a[2]]=e.EXT_NONE}}).add([73,0,0],(a,i)=>{let d=a[0],r="MU1000 System - ";a.subarray(1).forEach((s,o)=>{let c=d+o;c==8?console.debug(`${r}LCD contrast: ${s}.`):c==18?(e.#y[w.xg][1]=s?126:0,console.debug(`${r}default bank: ${s?"MU100 Native":"MU Basic"}.`),e.dispatchEvent("banklevel",{mode:"xg",data:+!!s}),e.forceVoiceRefresh()):c>=64&&c<69&&[()=>{e.dispatchEvent("channelactive",s)},()=>{s<8?(e.dispatchEvent("channelmin",s<<4),console.debug(`Octavia System: Minimum CH${(s<<4)+1}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{s<8?(e.dispatchEvent("channelmax",(s<<4)+15),console.debug(`Octavia System: Maximum CH${(s<<4)+16}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges")},()=>{e.#F=!!s,console.info(`Octavia System: RS receiving ${["dis","en"][s]}abled.`)}][c-64]()})}).add([73,10,0],(a,i)=>{let d=a[0],r=`MU1000 RS${e.#F?"":" (ignored)"}: `;if(d<16)switch(d){case 2:{let s=e.chRedir(0,i,!0);e.#F&&(e.dispatchEvent("portrange",4),e.dispatchEvent("portstart",s)),console.info(`${r}Show CH${s+1}~CH${s+64}`);break}case 3:{let s=e.chRedir(a[1]<<5,i,!0);e.#F&&(e.dispatchEvent("portrange",2),e.dispatchEvent("portstart",s)),console.info(`${r}Show CH${s+1}~CH${s+32}`);break}default:console.debug(`${r}unknown switch ${d} invoked.`)}else if(d<32){if(e.#F){let s=e.chRedir(d-16+(e.#oe<<4),i,!0);e.dispatchEvent("channelactive",s)}}else if(d<36){let s=e.chRedir(d-32<<4,i,!0);e.#F&&(e.dispatchEvent("portrange",1),e.dispatchEvent("portstart",s>>4),e.#oe=d-32),console.info(`${r}Show CH${s+1}~CH${s+16}`)}}).add([73,11,0],(a,i)=>{let d="MU1000 System - channel ",r="Octavia System - channel ",s=a[0];a.subarray(1).forEach((o,c)=>{let u=s+c;([()=>{e.setChActive(o,1),e.dispatchEvent("channelactive",o),T()&&console.debug(`${d}current part: CH${o+1}`)},()=>{o<5?(e.dispatchEvent("portrange",1<<o),console.debug(`${d}port range: ${1<<o} port(s)`)):(e.dispatchEvent("portrange",0),console.debug(`${d}port range: reset`))},()=>{o<16?(e.dispatchEvent("portstart",o),console.debug(`${r}start port: ${"ABCDEFGHIJKLMNOP"[o]}`)):(e.dispatchEvent("portstart",255),console.debug(`${r}start port: reset`))}][u]||(()=>{console.debug(`${d}unknown address: ${u}`)}))()})}).add([93,3],(a,i)=>{let d=e.chRedir(a[0],i,!0),r=`PLG-SG CH${d+1} `,s=Date.now();if(a[1]==0){let o="",c=0;a.subarray(2).forEach((u,f)=>{f%2==0?o+=ye[u]||u.toString().padStart("0"):c+=u*13}),s>=e.#ce&&this.dispatchEvent("metacommit",{type:"SGLyrics",data:"",amend:!1}),this.dispatchEvent("metacommit",{type:"SGLyrics",data:`${Ee(o)}`,amend:!0}),e.#ce=s+Math.ceil(c/2)+e.#ne,T()&&console.debug(`${r}vocals: ${o}`)}else console.warn(`Unknown PLG-SG data: ${a}`)}).add([98,0],(a,i,d)=>{e.dispatchEvent("mupromptex");let r=a[0],s=a.length-5,o=a.length-1;if(r!=s){console.info(`PLG-DX native dump size mismatch! Gave ${r} instead of ${a.length-5}.`);return}let c=N(a.subarray(4,o));if(c!=a[o]){console.info(`Bad PLG-DX checksum ${a[o]} - should be ${c}.`);return}a[0]=98,e.#N.run(a.subarray(0,o),i,d,{noAce:!0})}).add([98,96],(a,i,d,r)=>{let s=e.chRedir(a[0],i,!0),o=g.cc*s,c=a[1];a.subarray(2).forEach((u,f)=>{let b=c+f;if(!(b<10)){if(b==10)e.resetAce();else if(b<27){let E=b+131;r?.noAce||e.allocateAce(s,E),e.#e[o+m[E]]=u,e.dispatchEvent("cc",{part:s,cc:E,data:u})}}})}).add([100,0],(a,i,d)=>{let r=a.subarray(0,a.length-1);if(a[0]+5!=a.length){console.warn(`Yamaha DX7+ dump SysEx size mismatch! Expected ${a.length}, but got ${a[0]}:
`,a);return}let s=N(r),o=a[a.length-1];if(s!=o){console.warn(`Yamaha DX7+ dump SysEx checksum mismatch! Expected ${s}, but got ${o}:
`,a);return}t.run(r.subarray(1))}).add([100,76],(a,i,d)=>{let r=a[0]>>4,s=a[0]&15,o=a[1];switch(r){case 2:{let c=e.chRedir(s,i,!0),u=g.cc*c;a.subarray(2).forEach((f,b)=>{let E=b+o;if(!(E<7)){if(E<23){let $=E+135;e.allocateAce(c,$),e.#e[u+m[$]]=f,e.dispatchEvent("cc",{part:c,cc:$,data:f})}}});break}default:console.info("Unknown DX7+ multipart: %o",a)}}).add([1,20],(a,i,d)=>{d==115?(e.switchMode("doc",!0),e.setPortMode(e.getTrackPort(i),1,w.doc),console.info("MIDI reset: DOC")):console.debug(`Unknown Yamaha SysEx: 67, ${d}, ${a.join(", ")}`)}).add([1,17,15,89],(a,i,d)=>{d==115?(e.setEffectType(0,24,a[0]|16),e.dispatchEvent("efxreverb",e.getEffectType(0))):console.debug(`Unknown Yamaha SysEx: 67, ${d}, ${a.join(", ")}`)}).add([1,24],(a,i,d)=>{if(d==115){for(let r=0;r<16;r++){let s=e.chRedir(r,i,!0);e.#e[s*g.cc+m[91]]=127}console.info("DOC Global Reverb: on")}else console.debug(`Unknown Yamaha SysEx: 67, ${d}, ${a.join(", ")}`)}),t.add([14,31],(a,i,d)=>{e.#e[g.cc*a[0]+m[64]]=0,e.#C.ano(a[0]),e.switchMode("xg"),e.setPortMode(e.getTrackPort(i),1,w.xg),e.resetAce(),console.debug(`Yamaha DX7+ reset CH${a[0]+1}.`)}).add([76,112],async a=>{let i=a[0],d=g.cc*i,r=g.ext*i,s=g.cvn*i;e.#M[r]=e.EXT_DX,e.#$[i]=1;let o=e.#z.subarray(s,s+g.cvn);o.fill(32),a.subarray(1).forEach((c,u)=>{if(u<10)o[u]=Math.max(c,32);else if(!(u<40)){if(u<56){let f=u+102;e.#e[d+m[f]]=c,e.dispatchEvent("cc",{part:i,cc:f,data:c})}}}),e.#r[i]=i&127,e.#e[g.cc*i+m[0]]=35,e.#e[g.cc*i+m[32]]=i>>7|4,e.dispatchEvent("voice",{part:i}),console.debug(`DX7+ CH${i+1} dump: %o`,a)});let l=function(a,i,d,r){},h=function(a,i){e.dispatchEvent("mupromptex");let d=a*g.dpn,r=i[0],s=i[1];i.subarray(2).forEach((o,c)=>{let u=c+s,f=-1;u<16?([()=>{f=24},()=>{f=25},()=>{f=26},()=>{},()=>{f=28},()=>{f=29},()=>{f=30},()=>{f=31},()=>{},()=>{},()=>{},()=>{f=20},()=>{f=21},()=>{f=22},()=>{f=23},()=>{}][u]||(()=>{console.debug(`Unknown XG-style drum param ${u} on set ${a+1}.`)}))():u<32||(u<40?([()=>{f=48},()=>{f=49},!1,!1,()=>{f=52},()=>{f=53}][u-32]||(()=>{console.debug(`Unknown XG-style drum param ${u} on set ${a+1}.`)}))():u<80||([()=>{f=36}][u-80]||(()=>{console.debug(`Unknown XG-style drum param ${u} on set ${a+1}.`)}))()),f>=0?(T()&&console.debug(d,f,r,o),e.#l[(d+A[f])*g.dnc+r]=o):T()&&console.debug(`XG-style drum param ${u} has no writes.`)})},p=function(a,i,d){e.dispatchEvent("mupromptex");let r=a*g.dpn,s=(i<<7)+d[0];d.subarray(1).forEach((o,c)=>{let u=c+s,f=u&127,b=u>>7,E=-1;b>1&&([()=>{E=26},()=>{},()=>{E=28},()=>{E=29},()=>{E=30},()=>{},()=>{},()=>{E=31}][b-2]||(()=>{console.debug(`Unknown GS-style drum param ${b} on set ${a+1}.`)}))(),E>-1?(T()&&console.debug(r,E,f,o),e.#l[(r+A[E])*g.dnc+f]=o):T()&&console.debug(`GS-style drum param ${b} has no writes.`)})};this.#N.add([76,48],(a,i,d)=>{h(0,a)}).add([76,49],(a,i,d)=>{h(1,a)}).add([76,50],(a,i,d)=>{h(2,a)}).add([76,51],(a,i,d)=>{h(3,a)}).add([76,52],(a,i,d)=>{h(4,a)}).add([76,53],(a,i,d)=>{h(5,a)}).add([76,54],(a,i,d)=>{h(6,a)}).add([76,55],(a,i,d)=>{h(7,a)}),this.#N.add([89,0],(a,i,d)=>{if(e.eprom){let r=a[0],s=(a[1]<<14)+(a[2]<<7)+a[3]+(e.eprom.offset||0);T()&&console.debug(`MU1000 EPROM trail to 0x${s.toString(16).padStart(6,"0")}, ${r} bytes.`);let o=e.eprom.data;a.subarray(4).forEach((c,u)=>{let f=u>>3,b=u&7;if(b==7)for(let E=0;E<7;E++)o[s+7*f+E]+=(c>>6-E&1)<<7;else o[s+7*f+b]=c})}}).add([89,1],(a,i,d)=>{let r=(a[0]<<21)+(a[1]<<14)+(a[2]<<7)+a[3];T()&&console.debug(`MU1000 EPROM jump to 0x${r.toString(16).padStart(6,"0")}.`),e.eprom&&(e.eprom.offset=r)}).add([89,2],(a,i,d)=>{if(e.eprom){let r=(a[0]<<21)+(a[1]<<14)+(a[2]<<7)+a[3]+(e.eprom.offset||0);T()&&console.debug(`MU1000 EPROM write to 0x${r.toString(16).padStart(6,"0")}.`);let s=e.eprom.data;a.subarray(4).forEach((o,c)=>{let u=c>>3,f=c&7;if(f==7)for(let b=0;b<7;b++)s[r+7*u+b]+=(o>>6-b&1)<<7;else s[r+7*u+f]=o})}}).add([89,3],(a,i,d)=>{}),this.#N.add([39,48],(a,i,d)=>{}).add([43,0,0],(a,i,d)=>{e.dispatchEvent("mupromptex");let r=[0,0,0,0],s=(o,c)=>{r[c]=o};if(a.subarray(1).forEach((o,c)=>{let u=c+a[0];[s,s,s,s,()=>{this.#f=o*129/16383*100,e.dispatchEvent("mastervolume",e.#f)},()=>o-64,()=>o||128,()=>o,()=>o,()=>{console.debug(`TG300 variation on cc${o}.`)}][u](o,u)}),a[0]<4){let o=0;r.forEach(c=>{o=o<<4,o+=c}),o-=1024}}).add([43,1,0],(a,i,d)=>{e.dispatchEvent("mupromptex")}).add([43,2],(a,i,d)=>{e.dispatchEvent("mupromptex");let r=e.chRedir(a[0],i,!0),s=a[1],o=g.cc*r,c=`TG300 CH${r+1} `;a.subarray(2).forEach((u,f)=>{f<5?([()=>{},()=>{e.#e[o+m[0]]=u,e.dispatchEvent("voice",{part:r})},()=>{e.#e[o+m[32]]=u,e.dispatchEvent("voice",{part:r})},()=>{e.#r[r]=u,e.dispatchEvent("voice",{part:r})},()=>{let b=e.chRedir(u,i,!0);e.#u[r]=b,r!=b&&(e.buildRchTree(),console.info(`${c}receives from CH${b+1}`))}][f+s]||(()=>{}))(u,f+s):f<21||(f<47?([()=>{e.#b[r]=+!u},()=>{},()=>{},()=>{e.#s[g.rpn*r+3]=u,e.#o[g.rpnt*r+2]=1,e.dispatchEvent("pitch",{part:r,pitch:e.getPitchShift(r)})},()=>{},()=>{e.#e[o+m[7]]=u},!1,!1,()=>{e.#e[o+m[10]]=u||128},!1,!1,()=>{console.debug(`${c} AC1 at cc${u}`)},()=>{console.debug(`${c} AC2 at cc${u}`)},()=>{e.#e[o+m[128]]=u,e.allocateAce(r,128)},()=>{e.#e[o+m[93]]=u},()=>{e.#e[o+m[91]]=u},()=>{e.#e[o+m[94]]=u},()=>{e.#e[o+m[76]]=u},()=>{e.#e[o+m[77]]=u},()=>{e.#e[o+m[74]]=u},()=>{e.#e[o+m[71]]=u},()=>{e.#e[o+m[73]]=u},()=>{e.#e[o+m[75]]=u},()=>{e.#e[o+m[72]]=u},()=>{e.#e[o+m[78]]=u}][f+s-21]||(()=>{}))(u,f+s):f<95||([()=>{e.#e[o+m[65]]=u},()=>{e.#e[o+m[5]]=u}][f+s-95]||(()=>{}))(u,f+s))})}).add([43,7,0],(a,i,d)=>{let r=a[0];e.setLetterDisplay(a.subarray(1),"TG300 letter display",r)}).add([43,7,1],(a,i,d)=>{e.#m=0,e.#T=Date.now()+3200,e.#w.fill(0),a.forEach(function(r,s){let o=Math.floor(s/16),c=s%16,u=(c*3+o)*7,f=7,b=0;for(u-=c*5,o==2&&(f=2);b<f;)e.#w[u+b]=r>>6-b&1,b++})}),this.#V.add([66,18,0,0,127],(a,i,d)=>{e.switchMode("sc",!0),e.setPortMode(e.getTrackPort(i),2,w.sc),e.#e[g.cc*9]=120,e.#e[g.cc*25]=120,e.#e[g.cc*41]=120,e.#e[g.cc*57]=120,e.#y[w.sc][1]=e.#c.sc,e.#v=!1,e.#W.fill(0),console.info(`GS system to ${["single","dual"][a[0]]} mode.`)}).add([66,18,64,0],(a,i,d)=>{switch(a[0]){case 127:{e.switchMode("gs",!0),e.setPortMode(e.getTrackPort(i),2,w.gs),e.#y[w.gs][1]=e.#c.gs,e.#e[g.cc*9]=120,e.#e[g.cc*25]=120,e.#e[g.cc*41]=120,e.#e[g.cc*57]=120,e.#v=!1,e.#W.fill(0),console.info("MIDI reset: GS");break}default:{e.dispatchEvent("mupromptex");let r=[0,0,0,0],s=(o,c)=>{r[c]=o};if(a.subarray(1).forEach((o,c)=>{let u=c+a[0];[s,s,s,s,f=>{this.#f=f*129/16383*100,e.dispatchEvent("mastervolume",e.#f)},f=>{},f=>{}][u](o,c)}),a[0]<4){let o=0;r.forEach(c=>{o=o<<4,o+=c}),o-=1024}}}}).add([66,18,64,1],(a,i,d)=>{e.dispatchEvent("mupromptex");let r=a[0];if(r<16){let s="".padStart(r," ");a.subarray(1).forEach((o,c)=>{s+=String.fromCharCode(Math.max(32,o))}),s=s.padEnd(16," "),console.debug(`GS patch name: ${s}`)}else r<48||(r<65?a.subarray(1).forEach((s,o)=>{let c=`GS ${r+o>55?"chorus":"reverb"} `;([()=>{console.info(`${c}type: ${ae[s]}`),e.setEffectType(0,40,s),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{},()=>{},()=>{},()=>{},()=>{},!1,()=>{console.debug(`${c}predelay: ${s}ms`)},()=>{console.info(`${c}type: ${we[s]}`),e.setEffectType(1,40,16+s),e.dispatchEvent("efxchorus",e.getEffectType(1))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${c}to reverb: ${P(s)}`)},()=>{console.debug(`${c}to delay: ${P(s)}`)}][r+o-48]||(()=>{}))()}):r<80?console.debug(`Unknown GS patch address: ${r}`):r<91?a.subarray(1).forEach((s,o)=>{let c="GS delay ";([()=>{console.info(`${c}type: ${$e[s]}`),e.setEffectType(2,40,32+s),e.dispatchEvent("efxdelay",e.getEffectType(2))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${c}to reverb: ${P(s)}`)}][r+o-80]||(()=>{}))()}):console.debug(`Unknown GS patch address: ${r}`))}).add([66,18,64,2],(a,i,d)=>{let r="GS EQ ";a.subarray(1).forEach((s,o)=>{([()=>{console.debug(`${r}low freq: ${[200,400][s]}Hz`)},()=>{console.debug(`${r}low gain: ${s-64}dB`)},()=>{console.debug(`${r}high freq: ${[3e3,6e3][s]}Hz`)},()=>{console.debug(`${r}high gain: ${s-64}dB`)}][a[0]+o]||function(){console.warn(`Unknown GS EQ address: ${a[0]+o}`)})()})}).add([66,18,64,3],(a,i,d)=>{e.dispatchEvent("mupromptex");let r="GS EFX ",s=function(o,c){let u=ke(e.#S.subarray(10,12),c,o);u&&console.debug(`${r}${re(e.#S.subarray(10,12))} ${u}`)};a.subarray(1).forEach((o,c)=>{([()=>{e.setEffectTypeRaw(3,!1,32+o),e.dispatchEvent("efxinsert0",e.getEffectType(3))},()=>{e.setEffectTypeRaw(3,!0,o),console.info(`${r}type: ${re(e.#S.subarray(10,12))}`),e.dispatchEvent("efxinsert0",e.getEffectType(3))},!1,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,()=>{console.debug(`${r}to reverb: ${P(o)}dB`)},()=>{console.debug(`${r}to chorus: ${P(o)}dB`)},()=>{console.debug(`${r}to delay: ${P(o)}dB`)},!1,()=>{console.debug(`${r}1 source: ${o}`),o&&o<96&&e.allocateAceAll(o)},()=>{console.debug(`${r}1 depth: ${o-64}`)},()=>{console.debug(`${r}2 source: ${o}`),o&&o<96&&e.allocateAceAll(o)},()=>{console.debug(`${r}2 depth: ${o-64}`)},()=>{console.debug(`${r}to EQ: ${o?"ON":"OFF"}`)}][a[0]+c]||function(u,f){console.warn(`Unknown GS EFX address: ${f}`)})(o,a[0]+c)})}).add([66,18,65],(a,i,d)=>{p((a[0]>>4)+1<<1,a[0]&15,a.subarray(1))}).add([69,18,16],(a,i,d)=>{switch(a[0]){case 0:{let r=a[1];e.setLetterDisplay(a.subarray(2),"GS display text",r);break}case 32:{e.#T=Date.now()+3200,a[1]==0&&(a[2]?(e.#m=Math.max(Math.min(a[2]-1,9),0),T()&&console.debug(`GS switch display page ${a[2]-1}.`)):(e.#m=0,e.#T=Date.now(),T()&&console.debug("GS disable display page.")));break}default:if(a[0]<6){e.#m>9&&(e.#m=0);let r=a[0]-1<<1|a[1]>>6;e.#m==r&&(e.#T=Date.now()+3200),e.#h[r]?.length||(e.#h[r]=new Uint8Array(256));let s=e.#h[r];T()&&console.debug(`GS frame draw page ${r}.`);let o=a[1]&63;s.fill(0),a.subarray(2).forEach(function(u,f){let b=f+o,E=Math.floor(b/16),$=b%16,x=($*4+E)*5,C=5,H=0;for(x-=$*4,E==3&&(C=1);H<C;)s[x+H]=u>>4-H&1,H++})}else console.warn(`Unknown GS display section: ${a[0]}`)}});let y=function(a,i,d){e.dispatchEvent("mupromptex");let r=a[0],s=g.cc*i,o=g.rpn*i,c=`GS CH${i+1} `;r<3?(a.subarray(1).forEach((u,f)=>{[()=>{e.#e[s+m[0]]=u},()=>{e.#r[i]=u},()=>{let b=0;u<16?b=e.chRedir(u,d,!0):b=g.ch,e.#u[i]=b,i!=b&&(e.buildRchTree(),console.info(`${c}receives from CH${b+1}`))}][r+f]()}),e.dispatchEvent("voice",{part:i})):r<19||(r<44?a.subarray(1).forEach((u,f)=>{([()=>{e.#b[i]=+!u},!1,()=>{e.setChType(i,u<<1,w.gs),console.debug(`${c}type: ${u?"drum ":"melodic"}${u||""}`)},()=>{e.#s[o+3]=u,e.#o[g.rpnt*i+2]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},!1,()=>{e.#e[s+m[7]]=u},!1,!1,()=>{e.#e[s+m[10]]=u||128},!1,!1,()=>{console.debug(`${c}CC 1: cc${u}`)},()=>{console.debug(`${c}CC 2: cc${u}`)},()=>{e.#e[s+m[93]]=u},()=>{e.#e[s+m[91]]=u},!1,!1,()=>{e.#s[o+1]=u,e.#o[g.rpnt*i+1]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{e.#s[o+2]=u,e.#o[g.rpnt*i+1]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{e.#e[s+m[94]]=u}][r+f-19]||(()=>{}))()}):r<76||console.debug(`Unknown GS part address: ${r}`))},v=function(a,i){let d=a[0],r=`GS CH${i+1} `;d<2?a.subarray(1).forEach((s,o)=>{[()=>{e.#e[g.cc*i+m[32]]=s},()=>{}][d+o]()}):d<32?console.warn(`Unknown GS misc address: ${d}`):d<35?a.subarray(1).forEach((s,o)=>{[()=>{console.debug(`${r}EQ: o${["ff","n"][s]}`)},()=>{},()=>{console.debug(`${r}EFX: o${["ff","n"][s]}`),e.#a[i]=s,e.dispatchEvent("partefxtoggle",{part:i,active:s})}][d+o-32]()}):console.warn(`Unknown GS misc address: ${d}`)};this.#V.add([66,18,64,16],(a,i)=>{y(a,e.chRedir(9,i,!0),i)}).add([66,18,64,17],(a,i)=>{y(a,e.chRedir(0,i,!0),i)}).add([66,18,64,18],(a,i)=>{y(a,e.chRedir(1,i,!0),i)}).add([66,18,64,19],(a,i)=>{y(a,e.chRedir(2,i,!0),i)}).add([66,18,64,20],(a,i)=>{y(a,e.chRedir(3,i,!0),i)}).add([66,18,64,21],(a,i)=>{y(a,e.chRedir(4,i,!0),i)}).add([66,18,64,22],(a,i)=>{y(a,e.chRedir(5,i,!0),i)}).add([66,18,64,23],(a,i)=>{y(a,e.chRedir(6,i,!0),i)}).add([66,18,64,24],(a,i)=>{y(a,e.chRedir(7,i,!0),i)}).add([66,18,64,25],(a,i)=>{y(a,e.chRedir(8,i,!0),i)}).add([66,18,64,26],(a,i)=>{y(a,e.chRedir(10,i,!0),i)}).add([66,18,64,27],(a,i)=>{y(a,e.chRedir(11,i,!0),i)}).add([66,18,64,28],(a,i)=>{y(a,e.chRedir(12,i,!0),i)}).add([66,18,64,29],(a,i)=>{y(a,e.chRedir(13,i,!0),i)}).add([66,18,64,30],(a,i)=>{y(a,e.chRedir(14,i,!0),i)}).add([66,18,64,31],(a,i)=>{y(a,e.chRedir(15,i,!0),i)}).add([66,18,64,64],(a,i)=>{v(a,e.chRedir(9,i,!0))}).add([66,18,64,65],(a,i)=>{v(a,e.chRedir(0,i,!0))}).add([66,18,64,66],(a,i)=>{v(a,e.chRedir(1,i,!0))}).add([66,18,64,67],(a,i)=>{v(a,e.chRedir(2,i,!0))}).add([66,18,64,68],(a,i)=>{v(a,e.chRedir(3,i,!0))}).add([66,18,64,69],(a,i)=>{v(a,e.chRedir(4,i,!0))}).add([66,18,64,70],(a,i)=>{v(a,e.chRedir(5,i,!0))}).add([66,18,64,71],(a,i)=>{v(a,e.chRedir(6,i,!0))}).add([66,18,64,72],(a,i)=>{v(a,e.chRedir(7,i,!0))}).add([66,18,64,73],(a,i)=>{v(a,e.chRedir(8,i,!0))}).add([66,18,64,74],(a,i)=>{v(a,e.chRedir(10,i,!0))}).add([66,18,64,75],(a,i)=>{v(a,e.chRedir(11,i,!0))}).add([66,18,64,76],(a,i)=>{v(a,e.chRedir(12,i,!0))}).add([66,18,64,77],(a,i)=>{v(a,e.chRedir(13,i,!0))}).add([66,18,64,78],(a,i)=>{v(a,e.chRedir(14,i,!0))}).add([66,18,64,79],(a,i)=>{v(a,e.chRedir(15,i,!0))}),this.#K.add([54,65],(a,i)=>{let d=e.#c.x5=="81"?"05rw":"x5d";e.switchMode(d,!0),e.setPortMode(e.getTrackPort(i),1,w[d]);let r=a[a.length-1],s=a.subarray(0,a.length-1),o=N(s);o!=r&&(console.info(`X5D multi parameters checksum mismatch! Expected ${o}, got ${r}.`),console.debug(a));let c=(a[1]<<7)+a[0],u=(a[3]<<7)+a[2],f=e.chRedir(c&15,i,!0),b=g.cc*f;[()=>{u<1||(u<101?(e.setChType(f,e.CH_MELODIC,w.x5d),e.#r[f]=u-1,e.#e[b+m[0]]=e.#c.x5):u<229?(e.setChType(f,e.CH_MELODIC,w.x5d),e.#r[f]=u-101,e.#e[b+m[0]]=56):(e.setChType(f,e.CH_DRUMS,w.x5d),e.#r[f]=Le[u-229]||0,e.#e[b+m[0]]=62)),e.dispatchEvent("voice",{part:f})},()=>{e.#e[b+m[7]]=u},()=>{u<31&&(e.#e[b+m[10]]=Math.round((u-15)*4.2+64))},()=>{e.#e[b+m[93]]=K(u)},()=>{e.#e[b+m[91]]=K(u)},()=>{e.#s[f*g.rpn+3]=u>8191?u-16320:64+u,e.#o[g.rpnt*f+2]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)})},()=>{e.#s[f*g.rpn+1]=u>8191?u-16320:64+u,e.#o[g.rpnt*f+1]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)})},()=>{u>0&&(e.#s[f*g.rpn]=u,e.#o[g.rpnt*f]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)}))},()=>{}][c>>4]()}).add([54,76,0],(a,i)=>{e.dispatchEvent("mupromptex");let d=e.#c.x5=="81"?"05rw":"x5d";e.switchMode(d),e.setPortMode(e.getTrackPort(i),1,w[d]);let r="",s=e.#c.x5,o=0,c=0,u="MSB	PRG	LSB	NME";I(a,function(f,b){if(b<16400){let E=b%164;switch(!0){case E<10:{f>31&&(r+=String.fromCharCode(f));break}case E==10:break;case E==11:{u+=`
${s}	${o}	${c}	${r.trim().replace("Init Voice","")}`,o++,r="";break}}o>99&&(s=90,o=0)}}),e.userBank.clearRange({msb:e.#c.x5,prg:[0,99],lsb:0}),e.userBank.load(u),T()&&console.debug(u),e.forceVoiceRefresh()}).add([54,77,0],(a,i)=>{e.dispatchEvent("mupromptex");let d=e.#c.x5=="81"?"05rw":"x5d";e.switchMode(d),e.setPortMode(e.getTrackPort(i),1,w[d]);let r="",s=90,o=0,c=0,u="MSB	PRG	LSB	NME";I(a,function(f,b){if(b<13600){let E=b%136;switch(!0){case E<10:{f>31&&(r+=String.fromCharCode(f));break}case E==11:{u+=`
${s}	${o}	${c}	${r.trim().replace("Init Combi","")}`,o++,r="";break}}}}),e.userBank.clearRange({msb:90,prg:[0,99],lsb:0}),e.userBank.load(u),T()&&console.debug(u),e.forceVoiceRefresh()}).add([54,78],(a,i)=>{let d=e.#c.x5=="81"?"05rw":"x5d";e.switchMode(d),e.setPortMode(e.getTrackPort(i),1,w[d]),console.debug(`X5D mode switch requested: ${["combi","combi edit","prog","prog edit","multi","global"][a[0]]} mode.`)}).add([54,85],(a,i)=>{e.dispatchEvent("mupromptex");let d=e.#c.x5=="81"?"05rw":"x5d";e.switchMode(d),e.setPortMode(e.getTrackPort(i),1,w[d]),I(a,(r,s)=>{s>0&&s<3&&(e.setEffectType(s-1,44,r),e.dispatchEvent(`efx${["reverb","chorus"][s-1]}`,e.getEffectType(s-1)))})}).add([54,104],(a,i)=>{e.dispatchEvent("mupromptex");let d=e.#c.x5=="81"?"05rw":"x5d";e.switchMode(d,!0);let r=e.getTrackPort(i);if(e.#n[r]&&e.#n[r]!=w[d])if(e.#X.dumpLimit==e.DUMP_MODE){console.warn(`Dump cancelled for track ${i}. Port ${String.fromCharCode(65+r)} mode "${R[e.#n[r]]}" mismatch, should be "${d}".`);return}else console.info(`Track ${i} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+r)}.`);e.setPortMode(r,1,w[d]),I(a,function(s,o,c,u){if(o<192){let f=e.chRedir(Math.floor(o/12),i,!0),b=f*g.cc;switch(o%12){case 0:{s<128?(e.setChType(f,e.CH_MELODIC,w.x5d),e.#e[b+m[0]]=e.#c.x5,e.#r[f]=s):(e.setChType(f,e.CH_DRUMS,w.x5d),e.#e[b+m[0]]=62,e.#r[f]=Le[s-128]),s>0&&e.setChActive(f,1),e.dispatchEvent("voice",{part:f});break}case 1:{e.#e[b+m[7]]=s;break}case 2:{e.#s[f*g.rpn+3]=s>127?s-192:64+s,e.#o[g.rpnt*f+2]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)});break}case 3:{e.#s[f*g.rpn+1]=s>127?s-192:64+s,e.#o[g.rpnt*f+1]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)});break}case 4:{s<31&&(e.#e[b+m[10]]=Math.round((s-15)*4.2+64));break}case 5:{let E=s>>4,$=s&15;e.#e[b+m[91]]=K($),e.#e[b+m[93]]=K(E);break}case 10:break;case 11:{let E=e.chRedir(s&15,i,!0),$=s>>4;e.#u[f]=s,(E!=f||$)&&(console.info(`X5D Part CH${f+1} receives from CH${E+1}.`),e.buildRchTree())}}}else{let f=e.chRedir(o-192,i,!0)}})}),this.#V.add([22,18,127],(a,i,d)=>{e.switchMode("mt32",!0),e.setPortMode(e.getTrackPort(i),1,w.mt32),e.#v=!1,e.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),console.info("MIDI reset: MT-32")}).add([22,18,0],(a,i,d)=>{e.switchMode("mt32");let r=e.chRedir(d,i,!0),s=a[1];a.subarray(2).forEach((o,c)=>{let u=c+s;e.#A[u+(r-1)*16]=o,([!1,()=>{let f=e.#A[r-1<<4];if(f<3){if(e.#$[r]=1,f==2)for(let b=0;b<name.length;b++)e.#L[(r-1)*g.cmt+b]=e.#_[o*g.cmt+b];else{let b=e.baseBank.get(0,o+(f<<6),127,"mt32").name;for(let E=0;E<b.length;E++)e.#L[(r-1)*g.cmt+E]=b.charCodeAt(E)}e.dispatchEvent("voice",{part:r})}},()=>{e.#s[r*g.rpn+3]=o+40,e.#o[g.rpnt*r+2]=1},()=>{e.#s[r*g.rpn+1]=o+14,e.#o[g.rpnt*r+1]=1},()=>{e.#s[r*g.rpn]=o,e.#o[g.rpnt*r]=1},!1,()=>{e.#e[g.cc*r+m[91]]=o?127:0},!1,()=>{e.#e[g.cc*r+m[7]]=o},()=>{e.#e[g.cc*r+m[10]]=Math.ceil(o*9.05)}][u]||(()=>{}))()})}).add([22,18,1],(a,i,d)=>{e.switchMode("mt32");let r=d&7;console.debug(`MT-32 slot #${d+1} Drum: ${a}`);let s=a[0]<<7|a[1];a.subarray(2).forEach((o,c)=>{let u=c+s,f=(u>>2)+24,b=u&3,E=r*g.dpn;if(T()&&console.debug(`MT-32 temp drum note ${f} param ${b}: ${o}`),f<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${f}`);return}[()=>{},()=>{e.#l[(E+A[26])*g.dnc+f]=Math.round(o*1.27)},()=>{e.#l[(E+A[26])*g.dnc+f]=o*9+1&127},()=>{e.#l[(E+A[26])*g.dnc+f]=o?127:0}][b]()})}).add([22,18,2],(a,i,d)=>{e.switchMode("mt32");let r=e.chRedir(d,i,!0),s=a[1]+(a[0]<<7);s<10&&(e.#$[r]=1),a.subarray(2).forEach((o,c)=>{let u=c+s;u<14&&(e.#L[(r-1)*g.cmt+u]=o)}),e.dispatchEvent("voice",{part:r})}).add([22,18,3],(a,i,d)=>{e.switchMode("mt32");let r=d&7;if(a[0]){let s=(a[0]-1<<7)+a[1]-16;a.subarray(2).forEach((o,c)=>{let u=c+s,f=(u>>2)+24,b=u&3,E=r*g.dpn;if(T()&&console.debug(`MT-32 dev drum note ${f} param ${b}: ${o}`),f<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${f}`);return}[()=>{},()=>{e.#l[(E+A[26])*g.dnc+f]=Math.round(o*1.27)},()=>{e.#l[(E+A[26])*g.dnc+f]=o*9+1&127},()=>{e.#l[(E+A[26])*g.dnc+f]=o?127:0}][b]()})}else{let s=a[1];a.subarray(2).forEach((o,c)=>{let u=c+s;e.#A[u]=o;let f=e.chRedir(1+(u>>4),i,!0),b=u&15;([!1,()=>{let E=e.#A[f-1<<4];if(E<3)if(e.#$[f]=1,E==2)for(let $=0;$<name.length;$++)e.#L[(f-1)*g.cmt+$]=e.#_[o*g.cmt+$];else{let $=e.baseBank.get(0,o+(E<<6),127,"mt32").name;for(let x=0;x<$.length;x++)e.#L[(f-1)*g.cmt+x]=$.charCodeAt(x)}e.dispatchEvent("voice",{part:f})},()=>{e.#s[f*g.rpn+3]=o+40,e.#o[g.rpnt*f+2]=1},()=>{e.#s[f*g.rpn+1]=o+14,e.#o[g.rpnt*f+1]=1},()=>{e.#s[f*g.rpn]=o,e.#o[g.rpnt*f]=1},!1,()=>{e.#e[g.cc*f+m[91]]=o?127:0},!1,()=>{e.#e[g.cc*f+m[7]]=o},()=>{e.#e[g.cc*f+m[10]]=Math.ceil(o*9.05)}][b]||(()=>{}))()})}}).add([22,18,4],(a,i,d)=>{e.switchMode("mt32");let r=a[1]+(a[0]<<7),s=[];a.subarray(2).forEach((o,c)=>{let u=c+r,f=e.chRedir(Math.floor(u/246+1),i,!0),b=u%246;b<14&&(e.#L[(f-1)*g.cmt+b]=o),b<10&&(e.#$[f]=1),s.indexOf(f)<0&&s.push(f)}),s.forEach(o=>{e.dispatchEvent("voice",{part:o})})}).add([22,18,5],(a,i,d)=>{e.switchMode("mt32");let r=(a[0]<<7)+a[1];a.subarray(2).forEach((s,o)=>{let c=r+o,u=Math.floor(c/8),f=c&7,b=u*8;e.#q[c]=s,([!1,()=>{let E=e.#q[b];if(E<3){let $="";if(E==2){let C=g.cmt*u;$=`MT-m:${s.toString().padStart(3,"0")}`}else $=e.baseBank.get(0,s+(E<<6),127,"mt32").name;e.userBank.clearRange({msb:0,lsb:127,prg:u});let x=`MSB	LSB	PRG	NME
000	127	${u}	${$}`;e.userBank.load(x,!0)}}][f]||(()=>{}))()}),e.forceVoiceRefresh()}).add([22,18,8],(a,i,d)=>{e.switchMode("mt32");let r=((a[0]&1)<<7)+a[1],s=a[0]>>1,o=!1;if(a.subarray(2).forEach((c,u)=>{let f=r+u;f<g.cmt&&(e.#_[s*g.cmt+f]=c,o=!0)}),o){e.userBank.clearRange({msb:0,lsb:127,prg:s});let c=`MSB	LSB	PRG	NME
000	127	${s}	MT-m:${s}`;e.userBank.load(c,!0)}e.forceVoiceRefresh()}).add([22,18,16],(a,i,d)=>{e.switchMode("mt32");let r=a[1],s=!1,o=function(c,u){e.#u[u-12]=c,s=!0};a.subarray(2).forEach((c,u)=>{let f=u+r;([!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,o,o,o,o,o,o,o,o,o,()=>{e.#f=c,e.dispatchEvent("mastervolume",e.#f)}][f]||(()=>{}))(c,u)}),s&&e.buildRchTree()}).add([22,18,32],(a,i,d)=>{e.switchMode("mt32");let r=a[1],s=" ".repeat(r);a.subarray(2).forEach(o=>{o>31?s+=String.fromCharCode(o):s+=" "}),e.#Q=s.padStart(20," "),e.#Z=Date.now()+3200}).add([22,18,82],(a,i)=>{let d=e.chRedir(0,i,!0);for(let r=0;r<16;r++)e.#C.ano(d+r),r&&r<10&&(e.#r[d+r]=ie[r-1]);console.info("MT-32 alt reset complete.")}),this.#K.add([66,0],(a,i)=>{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(i),2,w.ns5r),e.#v=!1,console.debug(`NS5R mode switch requested: ${["global","multi","prog edit","comb edit","drum edit","effect edit"][a[0]]} mode.`)}).add([66,1],(a,i)=>{let d=["ns5r","05rw"][a[0]];e.switchMode(d,!0),e.setPortMode(e.getTrackPort(i),2,w[d]),e.#v=!1}).add([66,18,0,0],(a,i)=>{let d=a[0];switch(d){case 124:case 126:case 127:{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(i),2,w.ns5r),e.#v=!1;break}case 125:{e.initDrums(),console.info(`NS5R drum setup reset: ${a}`);break}default:if(d<10){let r=[0,0,0,0],s=(o,c)=>{r[c]=o};if(a.subarray(1).forEach((o,c)=>{[s,s,s,s,()=>{e.#f=o*129/16383*100,e.dispatchEvent("mastervolume",e.#f)},()=>o-64,()=>o-64,()=>{},()=>{},()=>{}][d+c]()}),a[0]<4){let o=0;r.forEach(c=>{o=o<<4,o+=c}),o-=1024}}}}).add([66,18,0,1],(a,i)=>{}).add([66,18,0,2],(a,i)=>{}).add([66,18,1],(a,i)=>{e.dispatchEvent("mupromptex");let d=e.chRedir(a[0],i,!0),r=d*g.cc,s=a[1],o=`NS5R CH${d+1} `;a.subarray(2).forEach((c,u)=>{let f=s+u;f<3?([()=>{e.#e[r+m[0]]=c||D.bank0},()=>{e.#e[r+m[32]]=c},()=>{e.#r[d]=c}][f](),e.dispatchEvent("voice",{part:d})):f<8||(f<14?[()=>{let b=e.chRedir(c,i,!0);e.#u[d]=b,d!=b&&(e.buildRchTree(),console.info(`${o}receives from CH${b+1}`))},()=>{e.#b[d]=+!c},()=>{e.setChType(d,c,w.ns5r),console.debug(`${o}type: ${F[c]}`)},()=>{e.#s[g.rpn*d+3]=c,e.#o[g.rpnt*d+2]=1,e.dispatchEvent("pitch",{part:d,pitch:e.getPitchShift(d)})},()=>{},()=>{}][f-8]():f<16||(f<33?[()=>{e.#e[r+m[7]]=c},()=>{e.#e[r+m[11]]=c},()=>{},()=>{},()=>{e.#e[r+m[10]]=c||128},()=>{},()=>{},()=>{e.#e[r+m[93]]=c},()=>{e.#e[r+m[91]]=c},()=>{e.#e[r+m[76]]=c},()=>{e.#e[r+m[77]]=c},()=>{e.#e[r+m[78]]=c},()=>{e.#e[r+m[74]]=c},()=>{e.#e[r+m[71]]=c},()=>{e.#e[r+m[73]]=c},()=>{e.#e[r+m[75]]=c},()=>{e.#e[r+m[72]]=c}][f-16]():f<112||f<114&&[()=>{e.#e[r+m[5]]=c},()=>{e.#e[r+m[65]]=c}][f-112]()))})}).add([66,18,8,0],(a,i)=>{let d=a[0];if(d<32)e.setLetterDisplay(a.subarray(1,33),"NS5R letter display");else{let r=d-32;e.#T=Date.now()+3200,e.#m=10,e.#w.fill(0);let s=a.subarray(1),o=4;s.forEach(function(c,u){let f=u+r,b=f>>4,E=f&15;if(f<80){let $=b<o?c:c>>3,x=0,C=b<o?6:3;for(;$>0;)e.#w[E*32+b*7+(C-x)]=$&1,$=$>>1,x++}})}}).add([66,18,48],(a,i,d)=>{h(0,a)}).add([66,18,49],(a,i,d)=>{h(1,a)}).add([66,18,50],(a,i,d)=>{h(2,a)}).add([66,18,51],(a,i,d)=>{h(3,a)}).add([66,18,52],(a,i,d)=>{h(4,a)}).add([66,18,53],(a,i,d)=>{h(5,a)}).add([66,18,54],(a,i,d)=>{h(6,a)}).add([66,18,55],(a,i,d)=>{h(7,a)}).add([66,52],(a,i)=>{e.switchMode("ns5r"),e.#v=!1;let d="";I(a,(r,s)=>{s<8?(r>31&&(d+=String.fromCharCode(r)),s==7&&(e.aiEfxName=d)):s<10&&(e.setEffectType(s-8,44,r),e.dispatchEvent(`efx${["reverb","chorus"][s-8]}`,e.getEffectType(s-8)))})}).add([66,53],(a,i)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r"),e.#v=!1;let d="",r=a[a.length-1],s=a.subarray(0,a.length-1),o=N(s);o!=r&&(console.info(`NS5R current multi dump checksum mismatch! Expected ${o}, got ${r}.`),console.debug(a));let c=e.getTrackPort(i);if(e.#n[c]&&e.#n[c]!=w.ns5r)if(e.#X.dumpLimit==e.DUMP_MODE){console.warn(`Dump cancelled for track ${i}. Port ${String.fromCharCode(65+c)} mode "${R[e.#n[c]]}" mismatch, should be "ns5r".`);return}else console.info(`Track ${i} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+c)}.`);e.setPortMode(c,2,w.ns5r),I(s,function(u,f){switch(!0){case f<2944:{let b=e.chRedir(Math.floor(f/92),i,!0),E=b*g.cc;switch(f%92){case 0:{e.#e[E+m[0]]=u,e.dispatchEvent("voice",{part:b});break}case 1:{e.#e[E+m[32]]=u,!u&&!e.#e[E+m[0]]&&(e.#e[E+m[0]]=D.bank0),e.dispatchEvent("voice",{part:b});break}case 2:{e.#r[b]=u,u>0&&e.setChActive(b,1),e.dispatchEvent("voice",{part:b});break}case 3:{let $=e.chRedir(u,i,!0);e.#u[b]=$,b!=$&&(console.info(`NS5R CH${b+1} receives from CH${$+1}.`),e.buildRchTree());break}case 7:{e.#i[b]=u,e.dispatchEvent("voice",{part:b});break}case 8:{e.#s[b*g.rpn+3]=u<40||u>88?u+(u>63?-192:64):u,e.#o[g.rpnt*b+2]=1,e.dispatchEvent("pitch",{part:b,pitch:e.getPitchShift(b)});break}case 9:case 10:{e.#e[E+m[7]]=u;break}case 11:{e.#e[E+m[11]]=u;break}case 14:{e.#e[E+m[10]]=u||128;break}case 19:{e.#e[E+m[93]]=u;break}case 20:{e.#e[E+m[91]]=u;break}case 84:{e.#e[E+m[65]]=u;break}case 85:{e.#e[E+m[5]]=u;break}}break}case f<3096:break;case f<3134:{let b=f-3096;b<8?(u>31&&(d+=String.fromCharCode(u)),b==7&&(e.aiEfxName=d)):b<10&&(e.setEffectType(b-8,44,u),e.dispatchEvent(`efx${["reverb","chorus"][b-8]}`,e.getEffectType(b-8)));break}case f<8566:break}})}).add([66,54],(a,i)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r");let d="",r=80,s=0,o=0,c="MSB	PRG	LSB	NME";I(a,function(u,f){let b=f%158;switch(!0){case b<10:{u>31&&(d+=String.fromCharCode(u));break}case b==10:break;case b==11:{r=u&127;break}case b==12:{o=u&127;break}case b==13:{c+=`
${r}	${s}	${o}	${d.trim().replace("Init Voice","")}`,s++,d="";break}}}),e.userBank.clearRange({msb:80,lsb:0}),e.userBank.load(c),T()&&console.debug(c),e.forceVoiceRefresh()}).add([66,55],(a,i)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r");let d="",r=88,s=0,o=0,c="MSB	PRG	LSB	NME";I(a,function(u,f){let b=f%126;switch(!0){case b<10:{u>31&&(d+=String.fromCharCode(u));break}case b==11:break;case b==12:break;case b==13:{c+=`
${r}	${s}	${o}	${d.trim().replace("Init Combi","")}`,s++,d="";break}}}),e.userBank.clearRange({msb:88,lsb:0}),e.userBank.load(c),T()&&console.debug(c),e.forceVoiceRefresh()}).add([66,125],(a,i,d)=>{e.dispatchEvent("backlight",["green","orange","red",!1,"yellow","blue","purple"][a[0]]||"white")}).add([66,127],(a,i,d)=>{let r=a[a.length-1],s=a.subarray(0,a.length-1),o=N(s);o!=r&&(console.info(`NS5R screen dump checksum mismatch! Expected ${o}, got ${r}.`),console.debug(a));let c=new Uint8Array(5760);I(a,(u,f,b)=>{if(f<720)for(let E=0;E<8;E++)c[f*8+E]=u>>7-E&1}),e.dispatchEvent("screen",{type:"ns5r",data:c})}).add([76],(a,i,d)=>{e.#K.run([66,...a],i,d)}),this.#re.add([16,0,8,0],(a,i,d)=>{let r=(a[2]<<4)+a[3],s="K11 ";([()=>{e.switchMode("k11",!0),e.setPortMode(e.getTrackPort(i),2,w.k11),e.#v=!1,e.#y[w.k11][1]=r?4:0,console.info("MIDI reset: GMega/K11")},()=>{e.setEffectType(0,24,r),console.debug(`${s}reverb type: ${r}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{console.debug(`${s}reverb time: ${r}`)},()=>{console.debug(`${s}reverb time: ${r}`)},()=>{console.debug(`${s}reverb predelay: ${r}`)},()=>{console.debug(`${s}reverb predelay: ${r}`)},()=>{console.debug(`${s}depth high: ${r}`)},()=>{console.debug(`${s}depth high: ${r}`)},()=>{console.debug(`${s}depth low: ${r}`)},()=>{console.debug(`${s}depth low: ${r}`)}][a[0]]||(()=>{}))()}).add([16,0,8,1],(a,i,d)=>{e.dispatchEvent("mupromptex");let r=e.chRedir(a[1],i,!0),s=g.cc*r,o=g.rpn*r,c=(a[3]<<4)+a[4],u=`K11 CH${r+1} `;([()=>{c<128?(e.setChType(r,e.CH_MELODIC,w.k11),e.#e[s+m[0]]=0,e.#r[r]=c):(e.setChType(r,e.CH_DRUMS,w.k11),e.#r[r]=c-128),e.dispatchEvent("voice",{part:r})},()=>{let f=e.chRedir(c,i,!0);e.#u[r]=f,r!=f&&(e.buildRchTree(),console.info(`${u}receives from CH${f+1}`))},()=>{e.#e[s+m[7]]=c},()=>{uupThis.setChActive(r,c)},()=>{e.#e[s+m[10]]=c},()=>{e.#s[o+3]=c+40,e.#o[g.rpnt*r+2]=1,e.dispatchEvent("pitch",{part:r,pitch:e.getPitchShift(r)})},()=>{e.#s[o+1]=c>>1,e.#s[o+2]=c&1,e.#o[g.rpnt*r+1]=1,e.dispatchEvent("pitch",{part:r,pitch:e.getPitchShift(r)})},()=>{e.#e[s+m[91]]=c?127:0},()=>{},()=>{e.#e[s+m[74]]=c},()=>{e.#e[s+m[73]]=c},()=>{e.#e[s+m[72]]=c}][a[0]]||(()=>{}))()}).add([16,0,9,0],(a,i,d)=>{e.dispatchEvent("mupromptex");let r=(a[2]<<4)+a[3],s="GMLX ";([()=>{console.debug(`${s}reverb type: ${r}`)},()=>{console.debug(`${s}reverb time: ${r}`)},()=>{console.debug(`${s}reverb predelay: ${r}`)},()=>{console.debug(`${s}depth high: ${r}`)},()=>{console.debug(`${s}depth low: ${r}`)}][a[0]]||(()=>{}))()}).add([16,0,9,3],(a,i,d)=>{e.dispatchEvent("mupromptex");let r=(a[2]<<4)+a[3],s=e.chRedir(a[1],i,!0),o=s*g.cc;[()=>{r<128?(e.setChType(s,e.CH_MELODIC,w.k11),e.#e[o+m[0]]=0,e.#e[o+m[32]]=0,e.#r[s]=r):r<160?(e.setChType(s,e.CH_MELODIC,w.k11),e.#e[o+m[0]]=0,e.#e[o+m[32]]=7,e.#r[s]=r-100):(e.setChType(s,e.CH_DRUMS,w.k11),e.#e[o+m[0]]=122,e.#e[o+m[32]]=0,e.#r[s]=r-160),e.dispatchEvent("voice",{part:s})},()=>{let c=e.chRedir(r,i,!0);e.#u[s]=c,s!=c&&(e.buildRchTree(),console.info(`GMLX CH${s+1} receives from CH${c+1}`))}][a[0]]()}).add([16,0,9,4],(a,i,d)=>{e.dispatchEvent("mupromptex");let r=(a[2]<<4)+a[3],s=e.chRedir(a[1],i,!0),o=s*g.cc,c=s*g.rpn,u=`GMLX CH${s+1} `;[()=>{e.setChActive(s,r)},()=>{e.#e[o+m[7]]=r},()=>{e.#e[o+m[10]]=r},()=>{e.#e[o+m[91]]=r?127:0},()=>{e.#s[c+3]=r+40,e.#o[g.rpnt*s+2]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},()=>{e.#s[c+1]=r,e.#o[g.rpnt*s+1]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},()=>{e.#s[c]=r,e.#o[g.rpnt*s]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},()=>{}][a[0]]()}),this.#ie.add([66,93,64],(a,i,d)=>{let r=a[2];switch(a[0]){case 0:{switch(a[1]){case 4:{e.dispatchEvent("mupromptex"),e.#f=r*129/16383*100,e.dispatchEvent("mastervolume",e.#f);break}case 5:{e.dispatchEvent("mupromptex"),r-64;break}case 6:{e.dispatchEvent("mupromptex"),console.debug(`SG global reverb: ${r?"on":"off"}`);break}case 127:{e.switchMode("sg",!0),e.setPortMode(e.getTrackPort(i),1,w.sg);break}}break}case 1:{switch(a[1]){case 48:{e.dispatchEvent("mupromptex"),console.debug(`SG reverb type: ${ae[r]}`);break}}break}default:if(a[0]>>4==1){e.dispatchEvent("mupromptex");let s=e.chRedir(a[0]&15,i,!0);if(a[1]==2){let o=e.chRedir(r,i,!0);e.#u[s]=o,s!=o&&(e.buildRchTree(),console.info(`SG CH${s+1} receives from CH${o+1}`))}else a[1]==19&&(e.#e[g.cc*s+m[7]]=r)}else console.warn(`Unknown AKAI SG SysEx: ${a}`)}}),this.#se.add([9],(a,i,d)=>{e.dispatchEvent("mupromptex"),console.debug(`GZ set effect: ${["stage reverb","hall reverb","room reverb","chorus","tremolo","phaser","rotary speaker","enhancer","flanger","EQ"][a[0]]||"off"}`)}),this.#N.add([127,0],(a,i,d)=>{e.switchMode("motif");let r=new Uint8Array([127,1,...a]);e.#N.run(r,i,d)}).add([127,1,0,0],(a,i,d)=>{e.switchMode("s90es");let r="S90/Motif ES system ",s=a[0];a.subarray(1).forEach((o,c)=>{([()=>{e.#f=o*12900/16383,e.dispatchEvent("mastervolume",e.#f)}][s+c]||(()=>{console.info(`Unrecognized ${r}ID: ${s+c}`)}))()})}).add([127,1,0,36,54,1],(a,i,d)=>{e.switchMode("s90es");let r="S90/Motif ES reverb ",s=a[0];a.subarray(1).forEach((o,c)=>{([()=>{e.setEffectTypeRaw(0,!1,o&15|112)},()=>{e.setEffectTypeRaw(0,!0,o)}][s+c]||(()=>{}))()}),e.dispatchEvent("efxreverb",e.getEffectType(0))}).add([127,1,0,37,54,2],(a,i,d)=>{e.switchMode("s90es");let r="S90/Motif ES chorus ",s=a[0];a.subarray(1).forEach((o,c)=>{([()=>{e.setEffectTypeRaw(1,!1,o&15|112)},()=>{e.setEffectTypeRaw(1,!0,o)}][s+c]||(()=>{}))()}),e.dispatchEvent("efxchorus",e.getEffectType(1))}).add([127,1,0,34,54,3],(a,i,d)=>{e.switchMode("s90es");let r="S90/Motif ES insert 1 ",s=a[0];a.subarray(1).forEach((o,c)=>{([()=>{e.setEffectTypeRaw(3,!1,o&15|112)},()=>{e.setEffectTypeRaw(3,!0,o)}][s+c]||(()=>{}))()}),e.dispatchEvent("efxinsert0",e.getEffectType(3))}).add([127,1,0,34,54,4],(a,i,d)=>{e.switchMode("s90es");let r="S90/Motif ES insert 2 ",s=a[0];a.subarray(1).forEach((o,c)=>{([()=>{e.setEffectTypeRaw(4,!1,o&15|112)},()=>{e.setEffectTypeRaw(4,!0,o)}][s+c]||(()=>{}))()}),e.dispatchEvent("efxinsert1",e.getEffectType(4))}).add([127,1,0,35,54,17],(a,i,d)=>{e.switchMode("s90es");let r="S90/Motif ES variation ",s=a[0];a.subarray(1).forEach((o,c)=>{([()=>{e.setEffectTypeRaw(2,!1,o&15|112)},()=>{e.setEffectTypeRaw(2,!0,o)}][s+c]||(()=>{}))()}),e.dispatchEvent("efxdelay",e.getEffectType(2))}).add([127,1,0,58,55],(a,i,d)=>{e.dispatchEvent("mupromptex"),e.switchMode("s90es");let r=e.getTrackPort(i);if(e.#n[r]&&e.#n[r]!=e.#c.smotif)if(e.#X.dumpLimit==e.DUMP_MODE){console.warn(`Dump cancelled for track ${i}. Port ${String.fromCharCode(65+r)} mode "${R[e.#n[r]]}" mismatch, should be "${R[e.#c.smotif]}".`);return}else console.info(`Track ${i} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+r)}.`);let s=e.chRedir(a[0],i,!0),o=g.cc*s,c=a[1];a[0]>15&&(s=a[0]+32);let u=`Track ${i} S90/Motif ES bulk CH${s<128?s+1:"U"+(s-127)} `;console.debug(u,a),!(a[0]>15)&&a.subarray(2).forEach((f,b)=>{([()=>{e.#e[o+m[0]]=f,e.dispatchEvent("voice",{part:s})},()=>{f&&e.setChActive(s,1),e.#e[o+m[32]]=f,e.setChType(s,[32,40].indexOf(f)>-1?e.CH_DRUMS:e.CH_MELODIC,e.#t,!0),e.dispatchEvent("voice",{part:s})},()=>{f&&e.setChActive(s,1),e.#r[s]=f,e.dispatchEvent("voice",{part:s})},()=>{let E=e.chRedir(f,i,!0);e.#u[s]=E,s!=E&&(e.buildRchTree(),console.info(`${u}receives from CH${E+1}`))},()=>{e.#b[s]=f?0:1},!1,!1,!1,!1,!1,!1,!1,!1,()=>{f!=100&&e.setChActive(s,1),e.#e[o+m[7]]=f},()=>{f!=64&&e.setChActive(s,1),e.#e[o+m[10]]=f},!1,!1,!1,()=>{e.#e[o+m[91]]=f},()=>{f&&e.setChActive(s,1),e.#e[o+m[93]]=f},()=>{f&&e.setChActive(s,1),e.#e[o+m[94]]=f},()=>{f!=127&&e.setChActive(s,1),e.#e[o+m[128]]=f,e.allocateAce(s,128)},()=>{},()=>{f!=64&&e.setChActive(s,1),e.#e[o+m[74]]=f},()=>{f!=64&&e.setChActive(s,1),e.#e[o+m[71]]=f},!1,()=>{e.#e[o+m[65]]=f},()=>{e.#e[o+m[5]]=f},()=>{}][c+b]||(()=>{}))()})}).add([127,1,54,16],(a,i,d)=>{e.switchMode("s90es");let r=a[0];a.subarray(1).forEach((s,o)=>{let u=`S90/Motif ES EQ${(o>>2)+1} `;([()=>{let f=s-64},()=>{let f=X[s]},()=>{let f=s/10},()=>{let f=s}][r+o&3]||(()=>{}))()})}),this.#V.add([0,72,18,0,0,0,0],(a,i,d)=>{e.switchMode("sd",!0),e.setPortMode(e.getTrackPort(i),2,w.sd),console.info("MIDI reset: SD")}).add([0,72,18,16,0],(a,i,d)=>{e.dispatchEvent("mupromptex");let r=a[0]>>5,s=a[0]&31;switch(r){case 0:{let o=a[0]>>1,c=a[1];switch(o){case 1:{a.subarray(2).forEach((u,f,b)=>{let E=f+c;switch(E){case 0:{u&&(e.setEffectType(1,60,u-1),e.dispatchEvent("efxchorus",e.getEffectType(1)),console.debug(`SD MFX Cho: ${E} - ${u}`));break}}});break}case 2:{a.subarray(2).forEach((u,f)=>{let b=f+c;switch(b){case 0:{u&&(e.setEffectType(0,55+u,0),e.dispatchEvent("efxreverb",e.getEffectType(0)),console.debug(`SD MFX Rev: ${b} - ${u}`));break}}});break}case 3:case 4:case 5:{let u=o-1;a.subarray(2).forEach((f,b)=>{let E=b+c;switch(console.debug(`SD MFX ${u-2}: ${E} - ${f}`),E){case 0:{e.setEffectTypeRaw(u,62,f),e.dispatchEvent(`efx${u>2?"delay":"insert"+(u-4)}`,e.getEffectType(u));break}}}),console.debug(`SD MFX message:
%o`,a);break}default:console.debug(`Unknown SD-90 global effects message:
%o`,a)}break}case 1:{let o=e.chRedir(s,i,!0),c=a[1],u=o*g.cc;a.subarray(2).forEach((f,b)=>{let E=c+b;E<37?([()=>{},()=>{},0,()=>{},()=>{switch(e.#e[u+m[0]]=f,f){case 104:case 105:case 106:case 107:case 120:{e.#i[o]||e.setChType(o,e.CH_DRUMS);break}default:e.#i[o]&&e.setChType(o,e.CH_MELODIC)}e.dispatchEvent("voice",{part:o})},()=>{e.#e[u+m[32]]=f,e.dispatchEvent("voice",{part:o})},()=>{e.#r[o]=f,e.dispatchEvent("voice",{part:o})},()=>{e.#e[u+m[7]]=f},()=>{e.#e[u+m[10]]=f},()=>{},()=>{},()=>{f<2&&(e.#b[o]=f)},()=>{f<2&&(e.#e[u+m[68]]=f?127:0)},()=>{},()=>{f<2&&(e.#e[u+m[65]]=f?127:0)},()=>{e.#e[u+m[5]]=f&15<<4|e.#e[u+m[5]]&15},()=>{e.#e[u+m[5]]=f&15|(e.#e[u+m[5]]&240)>>4},()=>{e.#e[u+m[74]]=f},()=>{e.#e[u+m[71]]=f},()=>{e.#e[u+m[73]]=f},()=>{e.#e[u+m[72]]=f},0,0,0,0,0,0,0,()=>{e.#e[u+m[128]]=f,e.allocateAce(128)},()=>{e.#e[u+m[93]]=f},()=>{e.#e[u+m[91]]=f},0,0,()=>{e.#e[u+m[75]]=f},()=>{e.#e[u+m[76]]=f},()=>{e.#e[u+m[77]]=f},()=>{e.#e[u+m[78]]=f}][E]||(()=>{}))():E<63||(E<64?(e.#i[o]?e.#e[u+m[0]]=104|f:e.#e[u+m[0]]=96|f,e.dispatchEvent("voice",{part:o})):console.debug(`Unknown SD-90 global CH${o+1} param setup message:
%o`,a))});break}case 2:{let o=e.chRedir(s,i,!0),c=a[1];console.debug(`Unknown SD-90 global CH${o+1} MIDI setup message:
%o`,a.subarray(2));break}default:console.warn(`Unknown SD-90 global part setup message:
%o`,a)}}),e.#K.add([0,1,73,78],(a,i,d)=>{e.switchMode("krs"),e.setPortMode(e.getTrackPort(i),1,w.krs),console.debug("Might be KORG KROSS 2 mode reset... Not sure.")}).add([0,1,73,117,2,37],(a,i,d)=>{e.switchMode("krs");let r=e.getTrackPort(i);if(e.#n[r]&&e.#n[r]!=w.krs)if(e.#X.dumpLimit==e.DUMP_MODE){console.warn(`Dump cancelled. Port ${String.fromCharCode(65+r)} mode "${R[e.#n[r]]}" mismatch, should be "krs".`);return}else console.info(`Track ${i} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+r)}.`);e.setPortMode(e.getTrackPort(i),1,w.krs);let s="KROSS 2 BMT1 ",o="";I(a,(c,u)=>{if(u<24)o+=String.fromCharCode(Math.max(32,c));else if(!(u<1276)){let f=u-1276,b=e.chRedir(Math.floor(f/44),i,!0),E=f%44,$=g.cc*b;E<15?([()=>{c&&e.setChActive(b,1),e.#r[b]=c,e.dispatchEvent("voice",{part:b})},()=>{c&&e.setChActive(b,1),c<10?(e.#e[$+m[0]]=63,e.#e[$+m[32]]=c):c<20?(e.#e[$+m[0]]=121,e.#e[$+m[32]]=c-10):c<24&&(e.#e[$+m[0]]=[120,0,56,62][c-20],e.#e[$+m[32]]=0),e.dispatchEvent("voice",{part:b})},()=>{let x=e.chRedir(c&15,i,!0);e.#u[b]=x,console.info(`${s}CH${b+1} receives from CH${x+1}`)},!1,!1,()=>{e.#e[$+m[7]]=c},!1,()=>{},()=>{},!1,!1,!1,!1,!1,()=>{e.#e[$+m[10]]=c||128}][E]||(()=>{}))():E<36||([()=>{e.#e[$+m[74]]=(c+128&255)-64},()=>{e.#e[$+m[71]]=(c+128&255)-64},!1,!1,()=>{e.#e[$+m[73]]=(c+128&255)-64},()=>{e.#e[$+m[75]]=(c+128&255)-64},!1,()=>{e.#e[$+m[72]]=(c+128&255)-64}][E]||(()=>{}))()}}),o=o.trimRight(),e.dispatchEvent("metacommit",{type:"EORTitle",data:o})})}};var oe=je(Ue(),1);var Be=class{#t=!1;constructor(e,t,n,l){this.#t=e,this.start=t,this.end=n,this.data=l}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#t}},ne=class extends Be{constructor(e,t,n){super(!0,e,t,n)}},Ne=class extends Be{constructor(e,t){super(!1,e,e,t)}},ce=class extends Array{#t=-1;constructor(){super(...arguments)}resetIndex(e){this.#t=-1}fresh(){this.sort(function(e,t){return e.start==t.start?0:(+(e.start>t.start)<<1)-1}),this.forEach(function(e,t){e.index=t})}step(e,t=!1){let n=[];if(t)for(let l=0;l<this.length&&!(this[l].start>e);l++){if(this[l].end<e)continue;n.push(this[l])}else{let l=this.getRange(this.#t==-1?0:e-1,e),h=this;l.forEach(function(p){p.index>h.#t&&(n.push(p),h.#t=p.index)})}return n}getRange(e,t){e>t&&([e,t]=[t,e]);let n=[],l=-1,h=Math.ceil(Math.sqrt(this.length)),p=!0;for(let y=0;y<this.length;y+=h)this[y+h]?l<0&&this[y+h].start>=e&&(l=y):l=l<0?y:l;for(;p;)this[l]?.end<t?this[l].start>=e&&n.push(this[l]):p=!1,l++;return n}};var ht=0xffffffffffff,He=function(e){let t=new ce,n=this,l=e.timeDivision,h=120,p=new ce,y=0,v=0;p.push(new ne(0,ht,[120,0])),e.track.forEach(function(r){y=0,r.event.forEach(function(s){y+=s.deltaTime,s.type==255&&s?.metaType==81&&(h=6e7/s.data,p[p.length-1]&&p.push(new ne(y,0xffffffffffff,[h,0])))})}),p.fresh(),p.forEach(function(r,s,o){s>0&&(o[s-1].end=r.start)});let a=120;p.forEach(function(r,s,o){s>0&&(r.end==r.start?o.splice(o.indexOf(r),1):a==r.data[0]&&(o[s-1].end=r.end,o.splice(o.indexOf(r),1)),a=r.data[0])});let i=0,d=120;return p.forEach(function(r){let s=r.start,o=s/d/l*60+i;d=r.data[0],i=o-s/d/l*60,r.data[1]=i}),console.debug("All tempo changes: ",p),h=120,y=0,v=0,e.track.forEach(function(r,s){y=0,v=0;let o=s+1;r.event.forEach(function(c,u){y+=c.deltaTime;let f=p.step(y,!0)[0];f&&(h=f.data[0],v=f.data[1]);let b={type:c.type,data:c.data,track:o,part:0};c.type>14?b.meta=c.metaType:b.part=c.channel,t.push(new Ne(y/h/l*60+v,b))})}),t.fresh(),self.midiEvents=t,console.debug(`Parsed a type ${e.formatType} MIDI sequence.`),t};oe.default.customInterpreter=xe;var S=function(e,t,n){e.addEventListener(n,l=>{t.dispatchEvent(n,l.data)})},Xe=class extends W{device;#t;#m={};#T=[];#h="";#w=[];#k=[];#u=new Uint8ClampedArray(128);#i=new Uint8ClampedArray(128);#e=.5;#d=120;#r=4;#p=4;#b=0;#g=0;smoothingAtk=0;smoothingDcy=0;reset(){let e=this;e.dispatchEvent("reset"),e.#t?.resetIndex(),e.device.init(),e.#h="",e.#e=.5,e.#d=120,e.#r=4,e.#p=4,e.#b=0,e.#g=0,e.dispatchEvent("tempo",e.#d),e.dispatchEvent("title",e.#h)}init(){this.reset(),this.#t=void 0}async loadFile(e){this.#t=He(oe.default.parse(new Uint8Array(await e.arrayBuffer())))}async loadMap(e,t){let n=this,l=0,h=0,p=0,y,v;e.split(`
`).forEach((a,i)=>{if(!a)return;let d=a.split("	");if(i){if(!p)return;let r="",s="";d.forEach((o,c)=>{switch(c){case y:{r=o;break}case v:{s=o;break}}}),!n.#m[r]||t?(n.#m[r]=s,l++):self.debugMode&&console.debug(`Voice "${s}" (${r}) seems to be in conflict with (${n.#m[r]}).`),h++}else d.forEach((r,s)=>{switch(r){case"ID":{y=s,p++;break}case"Name":{v=s,p++;break}default:console.debug(`Unknown map field: ${r}`)}})}),console.debug(`Voice names: ${h} total, ${l} loaded.`),n?.device.forceVoiceRefresh()}async loadEfx(e,t){let n=this,l=0,h=0,p,y,v;e.split(`
`).forEach((a,i)=>{if(a)if(i){let d=0,r;a.split("	").forEach((s,o)=>{switch(o){case p:{d|=parseInt(s,16)<<8;break}case y:{d|=parseInt(s,16);break}case v:{r=s;break}}}),!n.#T[d]||t?(n.#T[d]=r,l++):self.debugMode&&console.debug(`EFX ID 0x${d.toString(16).padStart(4,"0")} (${r}) seems to be in conflict.`),h++}else a.split("	").forEach((d,r)=>{switch(d){case"MSB":{p=r;break}case"LSB":{y=r;break}case"Name":{v=r;break}default:console.debug(`Unknown EFX field: ${d}`)}})}),console.debug(`EFX: ${h} total, ${l} loaded.`),n.dispatchEvent("efxreverb",n.device.getEffectType(0)),n.dispatchEvent("efxchorus",n.device.getEffectType(1)),n.dispatchEvent("efxdelay",n.device.getEffectType(2)),n.dispatchEvent("efxinsert0",n.device.getEffectType(3)),n.dispatchEvent("efxinsert1",n.device.getEffectType(4)),n.dispatchEvent("efxinsert2",n.device.getEffectType(5)),n.dispatchEvent("efxinsert3",n.device.getEffectType(6))}switchMode(e,t=!1){this.device.switchMode(e,t)}getMode(){return this.device.getMode()}getVoice(){return this.device.getVoice(...arguments)}getChVoice(e){return this.device.getChVoice(e)}getMapped(e){return this.#m[e]||e}getEfx([e,t]){let n=e<<8|t;return this.#T[n]||`0x${n.toString(16).padStart(4,"0")}`}getVoxBm(e){if(!e)throw new Error("Voice object must be valid");let t=this;if(!t.voxBm)throw new Error("Voice bitmap repository isn't yet initialized");let n=t.voxBm.getBm(e.name);if(!n)switch(e.mode){case"xg":{switch(e.sid[0]){case 0:case 80:case 81:case 83:case 84:case 96:case 97:case 99:case 100:{n=t.voxBm.getBm(t.getVoice(D.bank0,e.sid[1],D.bank0,e.mode).name);break}}break}case"g2":case"sd":{switch(e.sid[0]){case 96:case 97:case 98:case 99:{n=t.voxBm.getBm(t.getVoice(D.bank0,e.sid[1],D.bank0,e.mode).name);break}case 104:case 105:case 106:case 107:{n=t.voxBm.getBm(t.getVoice(120,e.sid[1],D.bank0,e.mode).name);break}}break}case"gs":case"sc":case"k11":case"sg":case"gm":{switch(e.sid[0]){case 120:break;case 122:case 127:{n=t.voxBm.getBm(t.getVoice(120,e.sid[1],0,e.mode).name);break}default:n=t.voxBm.getBm(t.getVoice(0,e.sid[1],0,e.mode).name)}break}default:switch(e.sid[0]){case 56:{n=t.voxBm.getBm(t.getVoice(0,e.sid[1],0,e.mode).name);break}}}return n||(n=t.voxBm.getBm(t.getVoice(e.sid[0],e.sid[1],0,e.mode).name)),n}getChBm(e,t){let n=this;return t=t||n.getChVoice(e),n.getVoxBm(t)}get noteProgress(){return this.#g/this.#e}get noteOverall(){return this.noteProgress-this.#b}get noteBar(){return Math.floor(this.noteOverall/this.#r)}get noteBeat(){let e=this.noteOverall%this.#r;return e<0&&(e+=this.#r),e}getTimeSig(){return[this.#r,this.#p]}getTempo(){return this.#d}sendCmd(e){this.device.runJson(e)}render(e){e>this.#g&&(this.#g=e);let t=this.#t?.step(e)||[],n=0,l=new Set,h={},p=[],y=this,v=[];for(y.device.getStrength().forEach((E,$)=>{y.#i[$]=E}),y.device.newStrength(),t.forEach(function(E){let $=E.data,x=y.device.runJson($);switch(x?.reply){case"meta":{v.push(x);break}}x?.reply&&delete x.reply});y.#k.length>0;){let E=y.#k.shift(),$=E.part<<7|E.note;E.state?(l.add($),h[$]=E.velo):l.has($)&&(p.push({part:E.part,note:E.note,velo:h[$],state:y.device.NOTE_SUSTAIN}),n++)}v?.length>0&&y.dispatchEvent("meta",v);let a=y.device.getActive(),i=[],d=y.device.getPitch(),r=y.device.getCcAll(),s=y.device.getProgram(),o=y.device.getChType(),c=[],u=y.device.getStrength();u.forEach(function(E,$,x){x[$]=Math.max(y.#i[$],E);let C=x[$]-y.#u[$],H=m.length*$;if(C>=0){let J=4*.25**(r[H+m[73]]/64);y.#u[$]+=Math.ceil(C-C*y.smoothingAtk**J)}else{let J=4*.25**(r[H+m[72]]/64);y.#u[$]+=Math.floor(C-C*y.smoothingDcy**J)}});let f=0;return a.forEach(function(E,$){E&&(i[$]=y.device.getVel($),c[$]=y.device.getExt($),f+=i[$].size)}),{extraPoly:n,extraNotes:p,curPoly:f,chInUse:a,chKeyPr:i,chPitch:d,chProgr:s,chContr:r,chType:o,chExt:c,eventCount:t.length,title:y.#h,bitmap:y.device.getBitmap(),letter:y.device.getLetter(),texts:y.device.getTexts(),master:y.device.getMaster(),mode:y.device.getMode(),strength:y.#u.slice(),velo:u,rpn:y.device.getRpn(),tSig:y.getTimeSig(),tempo:y.getTempo(),noteBar:y.noteBar,noteBeat:y.noteBeat,ace:y.device.getAce(),rawVelo:y.device.getStrength(),rawStrength:y.device.getRawStrength(),rawPitch:y.device.getRawPitch(),efxSink:y.device.getEffectSink()}}constructor(e,t=.5,n=.5){super();let l=this;l.smoothingAtk=t,l.smoothingDcy=n,l.device=e,l.addEventListener("meta",function(h){h?.data?.forEach(function(p){(l.#w[p.meta]||console.debug).call(l,p.meta,p.data)})}),S(l.device,l,"mode"),S(l.device,l,"mastervolume"),S(l.device,l,"channelactive"),S(l.device,l,"channelmin"),S(l.device,l,"channelmax"),S(l.device,l,"portrange"),S(l.device,l,"portstart"),S(l.device,l,"channelreset"),S(l.device,l,"channeltoggle"),S(l.device,l,"screen"),S(l.device,l,"metacommit"),S(l.device,l,"voice"),S(l.device,l,"pitch"),S(l.device,l,"note"),S(l.device,l,"reset"),S(l.device,l,"banklevel"),S(l.device,l,"efxreverb"),S(l.device,l,"efxchorus"),S(l.device,l,"efxdelay"),S(l.device,l,"efxinsert0"),S(l.device,l,"efxinsert1"),S(l.device,l,"efxinsert2"),S(l.device,l,"efxinsert3"),S(l.device,l,"partefxtoggle"),l.addEventListener("note",function({data:h}){l.#k.push(h)}),l.#w[3]=function(h,p){l.#h?.length<1&&(l.#h=p,l.dispatchEvent("title",l.#h))},l.#w[81]=function(h,p){let y=l.noteProgress,v=l.#e||.5;l.#d=6e7/p,l.#e=p/1e6,l.#b+=y*(v/l.#e)-y,l.dispatchEvent("tempo",l.#d)},l.#w[88]=function(h,p){let y=l.noteProgress,v=l.noteOverall,a=l.noteBar,i=l.noteBeat,d=l.#r,r=l.#p;l.#r=p[0],l.#p=1<<p[1];let s=24*(32/p[3])/p[2];if(d!=l.#r){let o=a;l.#b-=o*(l.#r-d),i+1>=d&&(d<l.#r?l.#b-=Math.ceil(l.#r-i-1):l.#b+=l.#r)}l.dispatchEvent("tsig",l.getTimeSig())}}};var le=new Uint8Array(40),q=0,de,fa=setInterval(()=>{de&&(le[q]=!le[q],q++,q>34&&(q=0))},1e3/50);Uint8Array.prototype.render=function(e){let t=0,n=0,l=this.width||5,h=this.height||8;for(let p=0;p<this.length;p++)e(this[p],t,n,this),t++,t>=l&&(t=0,n++)};var Ve=class{#t=[];async load(e,t=!1,n="(internal)"){let l=this,h=0,p=0;console.debug(`Font "${n||"(internal)"}": loading started.`),e.split(`
`).forEach(function(y,v){if(v>0&&y?.length>0){let a=y.split("	"),i=parseInt(a[0],16);if(p++,l.#t[i]&&!t)return;let d=new Uint8Array(40);Array.from(a[1]).forEach(async function(r,s){let o=s&1?4:0,c=s>>1,u=parseInt(r,16),f=3;for(;u>0||f>=0;){let b=(o+f)*5+c;d[b]=u&1,u=u>>1,f--}}),l.#t[i]=d,h++}}),console.debug(`Font "${n||"(internal)"}": ${p} total, ${h} loaded.`)}async loadFile(e,t=!1){let n=this;console.debug(`Requested font file from "${e}".`),await n.load(await(await fetch(e)).text(),t,e),de=!1}constructor(...e){de=!0,(async()=>{for(let t=0;t<e.length;t++)await this.loadFile(e[t])})()}getCP(e){return this.#t[e]}getStr(e){let t=[],n=this;return Array.from(e).forEach(function(l){t.push(n.#t[l.charCodeAt(0)]||n.#t[32]||le)}),t}};var Q=16/9,Z=64,ut="Vx,Dr,D1,D2,D3,D4,D5,D6,D7,D8".split(","),pt=[1,3,6,8,10],Ge=[0,.5,1,1.5,2,3,3.5,4,4.5,5,5.5,6],gt=2*Math.PI,mt={"?":"Unset",gm:"General MIDI",g2:"General MIDI 2",xg:"Yamaha XG",gs:"Roland GS",sc:"Roland GS",mt32:"Roland MT-32",doc:"Yamaha DOC",qy10:"YAMAHA QY10",qy20:"YAMAHA QY20",sd:"Roland SD",x5d:"Korg X5D","05rw":"Korg 05R/W",ns5r:"Korg NS5R",k11:"Kawai K11",sg:"Akai SG",krs:"Korg KROSS 2",s90es:"Yamaha S90 ES",motif:"Yamaha Motif ES"},bt={Copyrite:"Copyright","Cmn.Text":"Text","C.Lyrics":"Lyrics","C.Marker":"Marker",CuePoint:"Cue Point",Instrmnt:"Instrument","Kar.Info":"Kar Info","Kar.Mode":"Karaoke","Kar.Lang":"Language",KarTitle:"Kar Title",KarLyric:"Kar Lyrics","Kar.Ver.":"Kar Version",SGLyrics:"SG Lyrics",TrkTitle:"Title",EORTitle:"Real Title",XfSngDte:"XF Date",XfSngRgn:"XF Region",XfSngCat:"XF Category",XfSongBt:"XF Beat",XfSngIns:"XF Instr.",XfSngVoc:"XF Vocalist",XfSngCmp:"XF Composer",XfSngLrc:"XF Lyricist",XfSngArr:"XF Arranger",XfSngPer:"XF Perform.",XfSngPrg:"XF Program.",XfSngTag:"XF Tags",XfKarLng:"XF Lang.",XfKarNme:"XF Name",XfKarCmp:"XK Composer",XfKarLrc:"XK Lyricist",XfKarArr:"XK Arranger",XfKarPer:"XK Perform.",XfKarPrg:"XK Program."},yt=["XfSongBt","XfSngIns"],fe=[[],[4,2],[3,2]],Et=[{l:0,t:0},{l:0,t:416},{l:960,t:0},{l:960,t:416}],_e={none:{font4:[0,0],font7:[0,0]},macos:{font4:[2,0],font7:[0,0]}},k=function(e,t,n={}){let l=document.createElement(e);t?.forEach(d=>{l.classList.add(d)});let{t:h,l:p,w:y,h:v,i:a,a:i}=n;return h?.constructor&&(l.style.top=h?.length?h:`${h}px`),p?.constructor&&(l.style.left=p?.length?p:`${p}px`),y?.constructor&&(l.style.width=y?.length?y:`${y}px`),v?.constructor&&(l.style.height=v?.length?v:`${v}px`),a?.constructor&&l.appendChild(document.createTextNode(a)),i?.constructor&&(l.style.textAlign=i),l};var M=function(e,t){t?.forEach(n=>{e.appendChild(n)})},O=function(e,t){t.forEach(n=>{e.classList.contains(n)&&e.classList.remove(n)})},B=function(e,t){t.forEach(n=>{e.classList.contains(n)||e.classList.add(n)})},vt=new Array(128).fill(0);vt.forEach((e,t,n)=>{n[t]=Math.floor(24*t/12.7)/10});var wt=new Array(128).fill(0);wt.forEach((e,t,n)=>{n[t]=Math.abs(Math.round(48*(t-64)/12.7)/10)});var Ke=new Array(11).fill(null);Ke.forEach((e,t,n)=>{n[t]=`${Math.round(t*12/.0128)/100}%`});var $t=new Array(128).fill(null);$t.forEach((e,t,n)=>{n[t]=`${Math.round(t/1.27)/100}`});var Fe=function(e,t){e.innerText=t,e.rNew=!0;let n=e.measureText(t);e.rWidth=n.width},ba=class extends Xe{#t=128;#m=!1;#T="";#h;#w=0;#k=0;#u=0;#i=0;#e=g.invalidCh;#d=1;#r=0;#p=0;#b=new Uint8Array(1280);#g=new Uint8Array(1280);#x=new Uint8Array(1280);#I=new Uint8Array(512);#O=new Uint8Array(512);#U=new Uint8Array(512);#M=new Uint8Array(g.ch);#s;#o;#H;#l;#P;#S="fcdaff";#a={};#R={};#n=[];#E={};#$={};eventViewMode=0;#z=[];#A="comb";glyphs=new Ve;#L(e,t,n,l=0,h=0){let p=this,{width:y,height:v}=e.canvas,a,i,d,r,s=p.#d,o=l>3,c=pt.indexOf(t%12)>-1;switch(p.#A){case"block":case"comb":{a=Math.round(t*y/128),i=Math.round((t+1)*y/128),d=i-a,r=s==1?2:1;break}case"piano":{a=Math.round((Math.floor(t/12)*7+Ge[t%12])*y/75*1.0044642857142856),i=Math.round((Math.floor(t/12)*7+Ge[t%12]+1)*y/75*1.0044642857142856)-1,d=i-a,r=s==1?3:1;break}case"line":{let u=t-h;Math.abs(h)>2&&(u=t-Math.sign(h)*2),i=Math.round((t+.5)*y/128),a=Math.round((u+.5)*y/128)}default:}switch(e.fillStyle=`#${c?p.#S:"ffffff"}${(n<<1|n>>6).toString(16).padStart(2,"0")}`,e.strokeStyle=e.fillStyle,e.lineWidth=s==1?4:2,e.lineDashOffset=0,p.#A){case"block":{let u=e.canvas.height-1;e.fillRect(a,1,d,u),o&&e.clearRect(a+r,r+1,d-(r<<1),u-(r<<1));break}case"comb":{let u=(c?Math.round((e.canvas.height<<1)/3):e.canvas.height)-1;e.fillRect(a,1,d,u),o&&e.clearRect(a+r,r+1,d-(r<<1),u-(r<<1));break}case"piano":{let u=(c?0:e.canvas.height>>1)+1,f=(e.canvas.height>>1)-1;e.fillRect(a,u,d,f),o&&e.clearRect(a+r,u+r,d-(r<<1),f-(r<<1));break}case"line":{if(o)switch(s){case 4:{e.setLineDash(fe[2]);break}default:e.setLineDash(fe[1])}else e.setLineDash(fe[0]),s!=4&&self?.document?.mozFullScreen&&(a+=.5,i+=.5);e.beginPath(),e.moveTo(a,(s==4||!o)&&self?.document?.mozFullScreen?2:1),e.lineTo(i,(v>>1)+1),e.lineTo(a,v),e.stroke();break}default:}}#q(e,t){let n=this;(e?.chInUse||t).forEach((l,h)=>{if(l){let p=n.#n[h>>4][h&15].cxt;p.clearRect(0,0,p.canvas.width,p.canvas.height),e.chKeyPr[h].forEach(({v:y,s:v},a)=>{n.#L(p,a,y,v,n.device.getPitchShift(h))})}})}#_(e){let t=this;Date.now()-t.#w>4e3&&(t.#k=0,t.#u=142-t.#E.view.clientHeight,(t.#h?.clientWidth||0)>840&&(t.#k=840-t.#h.clientWidth),t.#E.view.style.transform=`translateX(${t.#k}px) translateY(${t.#u}px)`,e&&(t.#w=0))}#y(){let e=self.innerWidth/self.innerHeight,t=1,n=self.innerWidth,l=self.innerHeight;e>=Q?(t=Math.min(Math.round(self.innerHeight/1080*1e4)/1e4,100),n=Math.ceil(self.innerHeight*Q)):e<Q&&(t=Math.min(Math.round(self.innerWidth/1920*1e4)/1e4,100),l=Math.ceil(self.innerWidth/Q)),this.#H.style.width=`${n}px`,this.#H.style.height=`${l}px`,this.#l.style.transform=`scale(${t})`}#c;#X(){let e=this,t=e.#s?.currentTime||0,n=e.render(t),l=Date.now(),h=n.curPoly+n.extraPoly;e.#i<h&&(e.#i=h),e.#a.curPoly.innerText=`${h}`.padStart(3,"0"),e.#a.maxPoly.innerText=`${e.#i}`.padStart(3,"0"),e.#s?.realtime?(e.#a.barCount.innerText="LINE",e.#a.barDelim.style.display="none",e.#a.barNote.innerText="IN"):(e.#a.barCount.innerText=n.noteBar+1,e.#a.barDelim.style.display="",e.#a.barNote.innerText=Math.floor(n.noteBeat)+1);let p=[7,11,1,91,93,94,74,5,256,256],y=e.#r+e.#d;for(let d=0;d<g.ch;d++){let r=d>>4,s=d*g.cc,o=d*g.ace,c=e.#n[r][d&15];if(n.chInUse[d]&&r>=e.#r&&r<y){p[8]=n.ace[o+0]||256,p[9]=n.ace[o+1]||256,c.ccVis.clearRect(0,0,109,25),c.ccVis.fillStyle=`#${e.#S}`;for(let b=0;b<p.length;b++){let E=p[b];if(E<256){let $=n.chContr[s+m[E]],x=Math.round($/12.7*24)/10;if(x>0){let C=24-x;c.ccVis.fillRect(b*6,C,4,x)}}}let u=n.chContr[s+m[10]]||1,f=Math.abs(u-64)/2.625;if(u<64?c.ccVis.fillRect(84-f,0,f,24):u>127?(c.ccVis.fillRect(60,0,49,24),c.ccVis.clearRect(61,1,47,22)):c.ccVis.fillRect(85,0,f,24),c.ccVis.fillStyle="#fff",c.ccVis.fillRect(84,0,1,24),c.metre.clearRect(0,0,121,25),c.metre.globalCompositeOperation="source-over",c.metre.rWidth>c.metre.canvas.width){c.metre.rNew&&(c.metre.rNew=!1,c.metre.rOffset=t);let b=t-(c.metre.rOffset||0),E=32,$=c.metre.rWidth-c.metre.canvas.width+E,x=b*-25%(c.metre.rWidth+E+48)+48;x>0&&(x=0),c.metre.fillText(c.metre.innerText,x,3+e.#P.font4[0]),Math.abs(x)>$&&c.metre.fillText(c.metre.innerText,x+c.metre.rWidth+E,3+e.#P.font4[0])}else c.metre.fillText(c.metre.innerText,0,3+e.#P.font4[0]);switch(c.metre.globalCompositeOperation="xor",c.metre.fillRect(0,0,n.strength[d]*121/255,25),c.extVis.clearRect(0,0,47,25),c.extVis.fillStyle="#fff",n.chExt[d][0]){case e.device.EXT_VL:{let b=(n.chContr[s+m[136]]-64)/64||n.rawPitch[d]/8192;b=b*-4+4;let E=+!!n.rawVelo[d]*(n.chContr[s+m[129]]*n.chContr[s+m[11]]/16129);!E&&n.rawStrength[d]&&(E=n.rawStrength[d]*n.chContr[s+m[11]]/16129),E*=32;let $=n.chContr[s+m[1]]/127*8;c.extVis.beginPath(),c.extVis.moveTo(0,12-b-3),c.extVis.lineTo(7+E,12),c.extVis.lineTo(0,12+b+3),c.extVis.fill(),c.extVis.fillStyle=`#${e.#S}`,c.extVis.beginPath(),c.extVis.ellipse(43,12,4,4+$,0,0,gt),c.extVis.fill();break}case e.device.EXT_DX:{n.chContr.subarray(s+m[142],s+m[157]+1).forEach((E,$)=>{$>=8&&(c.extVis.fillStyle=`#${e.#S}`);let x=$*3,C=(E-64)/5.82;C>=0?c.extVis.fillRect(x,12-C,2,C+1):c.extVis.fillRect(x,12,2,1-C)});break}}}}let v=new Array(g.ch);if(e.#n.forEach((d,r)=>{d.forEach((s,o)=>{s.refresh&&(s.refresh=!1,v[r<<7|o]=!0)})}),["line"].indexOf(e.#A)>-1)for(;e.#z.length>0;){let d=e.#z.shift();v[d.part]=!0}e.#q(n,v),n.extraNotes.forEach(d=>{let{part:r,note:s,velo:o,state:c}=d,u=e.#n[r>>4][r&15].cxt;e.#L(u,s,o,c,e.device.getPitchShift(r))});let a=e.#$.cxt;l>n.bitmap.expire?e.#U.fill(0):n.bitmap.bitmap.length>256?n.bitmap.bitmap.forEach((d,r)=>{e.#U[r]=d?255:0}):n.bitmap.bitmap.forEach((d,r)=>{e.#U[r<<1]=d?255:0,e.#U[r<<1|1]=d?255:0}),e.#x.fill(0),l<=n.letter.expire&&e.glyphs.getStr(n.letter.text).forEach((d,r)=>{let s=(r&15)*5,o=r>>4<<3;d.forEach((c,u)=>{let f=s+u%5,b=o+Math.floor(u/5);e.#x[b*80+f]=c?255:0})}),e.#I.forEach((d,r,s)=>{let o=e.#U[r];o>d?s[r]+=Math.min(o-d,Z):o<d&&(s[r]-=Math.min(d-o,Z))}),e.#b.forEach((d,r,s)=>{let o=e.#x[r];o>d?s[r]+=Math.min(o-d,Z):o<d&&(s[r]-=Math.min(d-o,Z))}),e.#I.forEach((d,r)=>{let s=r>>5,o=r&31;e.#O[r]!=d?(a.clearRect(252+(o<<2),s<<2,3,3),d&&(a.fillStyle=`#ffffff${d.toString(16).padStart(2,"0")}`,a.fillRect(252+(o<<2),s<<2,3,3))):self.debugMode&&(a.clearRect(252+(o<<2),s<<2,3,3),d&&(a.fillStyle=`#ff0000${d.toString(16).padStart(2,"0")}`,a.fillRect(252+(o<<2),s<<2,3,3)))}),e.#b.forEach((d,r)=>{let s=Math.floor(r/80),o=r%80;o+=Math.floor(o/5),e.#g[r]!=d?(a.clearRect(o<<2,(s|16)<<2,3,3),d&&(a.fillStyle=`#ffffff${d.toString(16).padStart(2,"0")}`,a.fillRect(o<<2,(s|16)<<2,3,3))):self.debugMode&&(a.clearRect(o<<2,(s|16)<<2,3,3),d&&(a.fillStyle=`#ff0000${d.toString(16).padStart(2,"0")}`,a.fillRect(o<<2,(s|16)<<2,3,3)))}),e.#O.forEach((d,r,s)=>{s[r]=e.#I[r]}),e.#g.forEach((d,r,s)=>{s[r]=e.#b[r]});let i=(self.performance||self.Date).now();switch(e.eventViewMode){case 0:{e.#a.events.innerText=`${n.eventCount}`.padStart(3,"0");break}case 1:{let d=1e3/(i-e.#p);d>99?(d=Math.round(d),e.#a.events.innerText=`${d}`):d>9?(d=Math.round(d*10)/10,e.#a.events.innerText=`${Math.floor(d)}.${Math.floor(d*10%10)}`):(d=Math.round(d*100)/100,e.#a.events.innerText=`${Math.floor(d)}.${Math.floor(d*100%100)}`);break}default:e.#a.events.innerText=""}e.#p=i}#Y;#f;get style(){return this.#A}set style(e){let t=this;t.#A=e,t.#q(t.render(t.#s?.currentTime||0)),O(t.#l,["cambiare-style-block","cambiare-style-comb","cambiare-style-piano","cambiare-style-line"]),B(t.#l,[`cambiare-style-${e}`])}setClockSource(e){this.#s=e}setPixelProfile(e){let t=this;if(_e[e]){let n=_e[e];t.#P=n,t.#l&&(t.#l.style.setProperty("--pcp-font4",`translate(${n.font4[1]}px, ${n.font4[0]}px)`),t.#l.style.setProperty("--pcp-font7",`translate(${n.font7[1]}px, ${n.font7[0]}px)`))}else throw new Error(`"${e}" is not a valid pixel correction profile`)}setMode(e){let t=this;O(t.#l,["cambiare-mode-gm","cambiare-mode-xg","cambiare-mode-gs","cambiare-mode-sc","cambiare-mode-ns5r","cambiare-mode-05rw","cambiare-mode-x5d","cambiare-mode-k11","cambiare-mode-sg","cambiare-mode-g2","cambiare-mode-mt32","cambiare-mode-doc","cambiare-mode-qy10","cambiare-mode-qy20","cambiare-mode-sd","cambiare-mode-krs","cambiare-mode-s90es","cambiare-mode-motif"]),e!="?"&&B(t.#l,[`cambiare-mode-${e}`]),t.#S={xg:"9efaa0",doc:"9efaa0",qy10:"9efaa0",qy20:"9efaa0",ns5r:"9efaa0",x5d:"9efaa0","05rw":"9efaa0",k11:"9efaa0",s90es:"9efaa0",motif:"9efaa0",gm:"a1f3ff",g2:"a1f3ff",krs:"a1f3ff",gs:"ffe1a5",sc:"ffe1a5",mt32:"ffe1a5",sd:"ffe1a5",sg:"ffdddd"}[e]||"fcdaff"}#G(e){let t=this,n=t.#d,l=t.#r;t.#n.forEach((h,p)=>{if(p>=l&&p<l+n){B(h.root,["port-active"]);let y=p-l,{l:v,t:a}=Et[y*(4/n)];h.root.style.top=`${a}px`,h.root.style.left=`${v}px`,h.forEach((i,d)=>{i.root.style.top=`${d*(n>2?26:52)}px`})}else O(h.root,["port-active"]),h.root.style.top="",h.root.style.left="",h.forEach((y,v)=>{y.root.style.top=""});e&&h.forEach((y,v)=>{y.cxt.canvas.width=t.#d==1?1193:495,y.cxt.canvas.height=t.#d==4?26:52})})}setPort(e){let t=this;O(t.#l,["cambiare-start0","cambiare-start1","cambiare-start2","cambiare-start3","cambiare-start4","cambiare-start5","cambiare-start6","cambiare-start7"]),B(t.#l,[`cambiare-start${e}`]),t.#r=e,t.#G(!1)}setRange(e){let t=this;O(t.#l,["cambiare-port1","cambiare-port2","cambiare-port4","cambiare-compact"]),B(t.#l,[`cambiare-${e}`]),t.#d=parseInt(e.slice(4))||1,t.#G(!0)}setFrameTime(e=20){let t=this;t.#f?.constructor&&clearInterval(t.#f),e<5?e=5:e>100&&(e=100),t.#f=setInterval(t.#Y,e),t.smoothingAtk=Math.pow(.1,e/20),t.smoothingDcy=Math.pow(.75,e/20)}attach(e){let t=this;t.#o=e;let n=k("div",["cambiare-container"]);e.appendChild(n),t.#H=n;let l=k("div",["cambiare-canvas","cambiare-port1","cambiare-start0","cambiare-style-block"]);n.appendChild(l),t.#l=l,self.addEventListener("resize",t.#c),t.#c(),t.setFrameTime(20),t.#a.root=k("div",["sect-info"]),t.#a.events=k("span",["field","pcp-font4"],{t:1,l:0,w:35,h:33}),t.#a.curPoly=k("span",["field","pcp-font4"],{t:1,l:52,w:35,h:33}),t.#a.maxPoly=k("span",["field","pcp-font4"],{t:1,l:98,w:35,h:33}),t.#a.sigN=k("span",["field","pcp-font4"],{t:1,l:194,w:23,h:33,a:"right"}),t.#a.sigD=k("span",["field","pcp-font4"],{t:1,l:232,w:23,h:33}),t.#a.barCount=k("span",["field","pcp-font4"],{t:1,l:304,w:35,h:33,a:"right"}),t.#a.barDelim=k("span",["field","field-label","pcp-font4"],{t:0,l:343,w:8,h:33,i:"/"}),t.#a.barNote=k("span",["field","pcp-font4"],{t:1,l:354,w:23,h:33}),t.#a.tempo=k("span",["field","pcp-font4"],{t:1,l:454,w:64,h:33,a:"right"}),t.#a.volume=k("span",["field","pcp-font4"],{t:1,l:562,w:63,h:33,a:"right"}),t.#a.mode=k("span",["field","pcp-font4"],{t:1,l:708,w:152,h:33}),t.#a.reverb=k("span",["field","pcp-font4"],{t:1,l:1e3,w:190,h:33}),t.#a.chorus=k("span",["field","pcp-font4"],{t:1,l:1240,w:190,h:33}),t.#a.delay=k("span",["field","pcp-font4"],{t:1,l:1475,w:190,h:33}),t.#a.insert=k("span",["field","pcp-font4"],{t:1,l:1706,w:190,h:33}),t.#a.title=k("span",["field","pcp-font4"],{t:35,l:50,w:810,h:33}),l.appendChild(t.#a.root),M(t.#a.root,[t.#a.events,t.#a.curPoly,k("span",["field","field-label","pcp-font4"],{t:1,l:89,w:5,h:33,i:":"}),t.#a.maxPoly,k("span",["field","field-key","pcp-font7"],{t:1,l:148,w:41,h:33,i:"TSig"}),t.#a.sigN,k("span",["field","field-label","pcp-font4"],{t:0,l:221,w:8,h:33,i:"/"}),t.#a.sigD,k("span",["field","field-key","pcp-font7"],{t:1,l:268,w:30,h:33,i:"Bar"}),t.#a.barCount,t.#a.barDelim,t.#a.barNote,k("span",["field","field-key","pcp-font7"],{t:1,l:390,w:61,h:33,i:"Tempo",a:"right"}),t.#a.tempo,k("span",["field","field-key","pcp-font7"],{t:1,l:528,w:29,h:33,i:"Vol"}),t.#a.volume,k("span",["field","field-label","pcp-font4"],{t:1,l:626,w:17,h:33,i:"%"}),k("span",["field","field-key","pcp-font7"],{t:1,l:652,w:52,h:33,i:"Mode"}),t.#a.mode,k("span",["field","field-key","pcp-font7"],{t:1,l:960,w:34,h:33,i:"Rev"}),t.#a.reverb,k("span",["field","field-key","pcp-font7"],{t:1,l:1198,w:36,h:33,i:"Cho"}),t.#a.chorus,k("span",["field","field-key","pcp-font7"],{t:1,l:1438,w:31,h:33,i:"Var"}),t.#a.delay,k("span",["field","field-key","pcp-font7"],{t:1,l:1673,w:27,h:33,i:"Ins"}),t.#a.insert,k("span",["field","field-key","pcp-font7"],{t:35,l:0,w:44,h:33,i:"Title"}),t.#a.title]),t.#R.root=k("div",["sect-mark"]),t.#R.left=k("div",["sect-mark-left","boundary"],{t:0,l:0}),t.#R.right=k("div",["sect-mark-right","boundary"],{t:0,l:960}),l.appendChild(t.#R.root),M(t.#R.root,[t.#R.left,t.#R.right]),M(t.#R.left,[k("span",["field","field-key"],{t:0,l:0,w:26,h:33,i:"CH"}),k("span",["field","field-key"],{t:0,l:30,w:49,h:33,i:"Voice"}),k("span",["field","field-key","mark-send-title"],{t:2,l:164,w:25,h:18,i:"Send"}),k("span",["field","field-label","mark-send-param"],{t:16,l:146,w:58,h:16,i:"VEMRCDBP12",a:"center"}),k("span",["field","field-key"],{t:0,l:212,w:35,h:33,i:"Pan"}),k("span",["field","field-key"],{t:0,l:256,w:45,h:33,i:"Note"})]),M(t.#R.right,[k("span",["field","field-key"],{t:0,l:0,w:26,h:33,i:"CH"}),k("span",["field","field-key"],{t:0,l:30,w:49,h:33,i:"Voice"}),k("span",["field","field-key","mark-send-title"],{t:2,l:164,w:25,h:18,i:"Send"}),k("span",["field","field-label","mark-send-param"],{t:16,l:146,w:58,h:16,i:"VEMRCDBP12",a:"center"}),k("span",["field","field-key"],{t:0,l:212,w:35,h:33,i:"Pan"}),k("span",["field","field-key"],{t:0,l:256,w:45,h:33,i:"Note"})]),t.#n.root=k("div",["sect-part"]);for(let h=0;h<g.ch>>4;h++){let p=h<<4;t.#n[h]=[],t.#n[h].root=k("div",["boundary",`part-port-${h}`]);for(let y=0;y<16;y++){let v=(p|y)+1;v>=100?v=`${Math.floor(v/10).toString(16)}${v%10}`:v=`${v}`.padStart(2,"0"),t.#n[h][y]={root:k("div",["boundary","part-channel"]),major:k("div",["boundary","part-info-major"]),minor:k("div",["boundary","part-info-minor"],{t:26}),keys:k("div",["boundary","part-keys"]),notes:k("div",["boundary","part-keyboard"]),cxt:k("canvas",["field"]).getContext("2d"),number:k("span",["field","field-label","pcp-font4"],{t:1,w:18,h:25,i:v}),voice:k("span",["field"],{l:22,t:1,w:121,h:25}),metre:k("canvas",["field"]).getContext("2d"),type:k("span",["field","field-label","pcp-font4"],{t:1,w:18,h:25}),std:k("span",["field","pcp-font4"],{l:22,t:1,w:20,h:25,a:"center"}),msb:k("span",["field","pcp-font4"],{l:48,t:1,w:27,h:25}),prg:k("span",["field","pcp-font4"],{l:81,t:1,w:27,h:25}),lsb:k("span",["field","pcp-font4"],{l:114,t:1,w:27,h:25}),ccVis:k("canvas",["field"],{l:145,t:1}).getContext("2d"),extVis:k("canvas",["field"],{l:207,t:1}).getContext("2d"),ccUpdate:!1};let a=t.#n[h][y];Ke.forEach(i=>{a.notes.appendChild(k("span",["field","part-csplit"],{l:i}))}),a.notes.appendChild(k("span",["field","part-csplit","part-cdive"],{l:0,w:"100%",h:1})),a.metre.canvas.width=121,a.metre.canvas.height=25,a.metre.fillStyle="#fff",a.metre.textBaseline="top",a.metre.font="20px 'PT Sans Narrow'",a.ccVis.canvas.width=109,a.ccVis.canvas.height=25,a.ccVis.fillStyle="#fff",a.extVis.canvas.width=47,a.extVis.canvas.height=25,a.extVis.fillStyle="#fff",M(a.notes,[a.cxt.canvas]),M(a.keys,[a.notes]),M(a.voice,[a.metre.canvas]),M(a.major,[a.number,a.voice,a.ccVis.canvas]),M(a.minor,[a.type,a.std,a.msb,a.prg,a.lsb,a.extVis.canvas]),M(a.root,[a.major,a.minor,a.keys]),M(t.#n[h].root,[a.root]),a.number.addEventListener("contextmenu",i=>{i.preventDefault(),i.stopImmediatePropagation();let d=h<<4|y;t.#M[d]=+!t.#M[d],[O,B][t.#M[d]](a.root,["part-hidden"])})}t.#n.root.appendChild(t.#n[h].root)}l.appendChild(t.#n.root),t.#E.root=k("div",["sect-meta"]),t.#E.view=k("div",["boundary"]),l.appendChild(t.#E.root),M(t.#E.root,[t.#E.view]),t.#$.root=k("div",["sect-pix","boundary"],{l:1529,t:950,w:379,h:127}),t.#$.cxt=k("canvas",["field"]).getContext("2d"),t.#$.fps=k("span",["field","field-key"],{l:0,w:"100%",h:1}),t.#$.cxt.canvas.width=379,t.#$.cxt.canvas.height=127,M(t.#$.root,[t.#$.cxt.canvas]),l.appendChild(t.#$.root),t.addEventListener("mode",h=>{t.#a.mode.innerText=`${mt[h.data]}`,t.setMode(h.data)}),t.addEventListener("mastervolume",h=>{let p=Math.round(h.data*100)/100;t.#a.volume.innerText=`${Math.floor(p)}.${`${Math.floor(p%1*100)}`.padStart(2,"0")}`}),t.addEventListener("tempo",h=>{let p=Math.round(h.data*100);t.#a.tempo.innerText=`${Math.floor(p/100)}.${`${Math.floor(p%100)}`.padStart(2,"0")}`}),t.addEventListener("tsig",h=>{[t.#a.sigN.innerText,t.#a.sigD.innerText]=h.data}),t.addEventListener("title",h=>{t.#a.title.innerText=h.data||"No Title"}),t.addEventListener("voice",({data:h})=>{let p=t.getChVoice(h.part),y=t.#n[h.part>>4][h.part&15];Fe(y.metre,t.getMapped(p.name)),y.type.innerText=ut[t.device.getChType()[h.part]],y.std.innerText=p.standard,y.msb.innerText=`${p.sid[0]}`.padStart(3,"0"),y.prg.innerText=`${p.sid[1]}`.padStart(3,"0"),y.lsb.innerText=`${p.sid[2]}`.padStart(3,"0")}),t.addEventListener("pitch",h=>{let{part:p,pitch:y}=h.data;t.#n[p>>4][p&15].notes.style.transform=`translateX(${y/1.28}%)`}),t.addEventListener("efxreverb",h=>{t.#a.reverb.innerText=t.getEfx(h.data)}),t.addEventListener("efxchorus",h=>{t.#a.chorus.innerText=t.getEfx(h.data)}),t.addEventListener("efxdelay",h=>{t.#a.delay.innerText=t.getEfx(h.data)}),t.addEventListener("efxinsert0",h=>{t.#a.insert.innerText=t.getEfx(h.data)}),t.addEventListener("partefxtoggle",h=>{let{part:p,active:y}=h.data;[O,B][y](t.#n[p>>4][p&15].number,["part-efx"])}),t.addEventListener("channeltoggle",h=>{let{part:p,active:y}=h.data;[O,B][y](t.#n[p>>4][p&15].root,["part-active"])}),t.addEventListener("channelactive",h=>{if(t.#e<g.ch){let y=t.#n[t.#e>>4][t.#e&15].number;O(y,["part-focus"])}let p=h.data;if(p<g.ch){let y=t.#n[p>>4][p&15].number;B(y,["part-focus"]),t.#e=p}}),t.addEventListener("metacommit",h=>{let p=h.data;if(t.#m&&p.type==t.#T&&t.#h)switch(p.type){case"C.Lyrics":case"KarLyric":case"SGLyrics":{M(t.#h,[k("span",["meta-slice"],{i:p.data})]);break}default:t.#h.childNodes[0].data+=p.data}else if(p.data?.length&&yt.indexOf(p.type)==-1){let y=k("div",["meta-line"]),v=k("span",["field","field-key","meta-type"],{i:bt[p.type]||p.type});switch(p.mask&&(v.style.display="none"),p.type){case"C.Lyrics":case"KarLyric":case"SGLyrics":{t.#h=k("span",["field","meta-data"]),M(t.#h,[k("span",["meta-slice"],{i:p.data})]);break}default:t.#h=k("span",["field","meta-data"],{i:p.data})}for(t.#E.view.appendChild(y),M(y,[v,t.#h]);t.#E.view.children.length>t.#t;)t.#E.view.children[0].remove()}t.#m=p.amend||!1,t.#T=p.type||"",t.#_()}),t.#E.view.style.transform="translateX(0px) translateY(140px)",t.dispatchEvent("mode","?"),t.dispatchEvent("mastervolume",100),t.dispatchEvent("tempo",120),t.dispatchEvent("tsig",[4,4]),t.dispatchEvent("title",""),t.dispatchEvent("efxreverb",t.device.getEffectType(0)),t.dispatchEvent("efxchorus",t.device.getEffectType(1)),t.dispatchEvent("efxdelay",t.device.getEffectType(2)),t.dispatchEvent("efxinsert0",t.device.getEffectType(3)),t.#G(!0)}detach(e){let t=this;self.removeEventListener("resize",t.#c),t.#l.remove(),t.#l=void 0,t.#H.remove(),t.#H=void 0,t.#o=void 0,clearInterval(t.#f)}constructor(e,t){super(new Oe,.1,.75);let n=this;n.#c=n.#y.bind(this),n.#Y=n.#X.bind(this),e&&n.attach(e),t&&n.setClockSource(t),n.setPixelProfile("none"),n.addEventListener("reset",()=>{n.#i=0,n.#m=!1,n.#T="",n.#h=null,n.#e=g.invalidCh;try{let l=n.#E.view.children;for(let h=l.length-1;h>=0;h--)l[h].remove();n.#E.view.style.transform="translateX(0px) translateY(140px)";for(let h=0;h<g.ch;h++){let p=n.#n[h>>4][h&15];O(p.root,["part-active"]),O(p.number,["part-efx","part-focus"]),Fe(p.metre,""),p.type.innerText="",p.std.innerText="",p.msb.innerText="",p.prg.innerText="",p.lsb.innerText="",p.notes.style.transform="",p.ccUpdate=!0}}catch{}}),n.addEventListener("pitch",({data:l})=>{n.#z.push(l)})}};export{ba as Cambiare};
