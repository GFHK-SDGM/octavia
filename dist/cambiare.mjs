var it=Object.create;var $e=Object.defineProperty;var st=Object.getOwnPropertyDescriptor;var nt=Object.getOwnPropertyNames;var ct=Object.getPrototypeOf,ot=Object.prototype.hasOwnProperty;var lt=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var dt=(e,t,s,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let u of nt(t))!ot.call(e,u)&&u!==s&&$e(e,u,{get:()=>t[u],enumerable:!(o=st(t,u))||o.enumerable});return e};var xe=(e,t,s)=>(s=e!=null?it(ct(e)):{},dt(t||!e||!e.__esModule?$e(s,"default",{value:e,enumerable:!0}):s,e));var me=lt((ra,pe)=>{(function(){"use strict";let e={fatal:!0},t=[new TextDecoder("iso-8859-15",e),new TextDecoder("utf-8",e),new TextDecoder("sjis",e),new TextDecoder("euc-jp",e),new TextDecoder("ascii")],s={debug:!1,parse:function(o,u){if(o instanceof Uint8Array)return s.Uint8(o);if(typeof o=="string")return s.Base64(o);if(o instanceof HTMLElement&&o.type==="file")return s.addListener(o,u);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(o,u){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(o===void 0||!(o instanceof HTMLElement)||o.tagName!=="INPUT"||o.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;u=u||function(){},o.addEventListener("change",function(p){if(!p.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let m=new FileReader;m.readAsArrayBuffer(p.target.files[0]),m.onload=function(y){u(s.Uint8(new Uint8Array(y.target.result)))}})},Base64:function(o){let u=function(y){var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(y=y.replace(/^.*?base64,/,""),y=String(y).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(y))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");y+="==".slice(2-(3&y.length));let l,h="",a,i,n=0;for(;n<y.length;)l=r.indexOf(y.charAt(n++))<<18|r.indexOf(y.charAt(n++))<<12|(a=r.indexOf(y.charAt(n++)))<<6|(i=r.indexOf(y.charAt(n++))),h+=a===64?String.fromCharCode(l>>16&255):i===64?String.fromCharCode(l>>16&255,l>>8&255):String.fromCharCode(l>>16&255,l>>8&255,255&l);return h}(o=String(o));var p=u.length;let m=new Uint8Array(new ArrayBuffer(p));for(let y=0;y<p;y++)m[y]=u.charCodeAt(y);return s.Uint8(m)},Uint8:function(m){let u={data:null,pointer:0,movePointer:function(a){return this.pointer+=a,this.pointer},readInt:function(a){if((a=Math.min(a,this.data.byteLength-this.pointer))<1)return-1;let i=0;if(1<a)for(let n=1;n<=a-1;n++)i+=this.data.getUint8(this.pointer)*Math.pow(256,a-n),this.pointer++;return i+=this.data.getUint8(this.pointer),this.pointer++,i},readStr:function(a){let i=new Uint8Array(a),n=!1,c;i.forEach((d,f)=>{i[f]=this.readInt(1)});for(let d=0;d<t.length;d++)if(!n)try{if(c=t[d].decode(i),d===0)for(let f=0;f<c.length;f++){let g=c.charCodeAt(f);if(g>191||g>127&&g<160)throw new RangeError(`Invalid code point: ${g}`)}n=!0,console.debug(`String byte sequence in ${t[d].encoding}`)}catch(f){console.debug(`SMF string ${f}`)}return c||"String byte sequence read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let a=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)a=this.readInt(1);else{let n=[];for(;128<=this.data.getUint8(this.pointer);)n.push(this.readInt(1)-128);var i=this.readInt(1);for(let c=1;c<=n.length;c++)a+=n[n.length-c]*Math.pow(128,c);a+=i}return a}};if(u.data=new DataView(m.buffer,m.byteOffset,m.byteLength),u.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;u.readInt(4);let p={};p.formatType=u.readInt(2),p.tracks=u.readInt(2),p.track=[];var m=u.readInt(1),y=u.readInt(1);128<=m?(p.timeDivision=[],p.timeDivision[0]=m-128,p.timeDivision[1]=y):p.timeDivision=256*m+y;for(let a=1;a<=p.tracks;a++){p.track[a-1]={event:[]};var r,l=u.readInt(4);if(l===-1)break;if(l!==1297379947)return!1;u.readInt(4);let i=0,n=!1,c,d;for(;!n&&(i++,p.track[a-1].event[i-1]={},p.track[a-1].event[i-1].deltaTime=u.readIntVLV(),(c=u.readInt(1))!==-1);)if(128<=c?d=c:(c=d,u.movePointer(-1)),c===255){p.track[a-1].event[i-1].type=255,p.track[a-1].event[i-1].metaType=u.readInt(1);var h=u.readIntVLV();switch(p.track[a-1].event[i-1].metaType){case 47:case-1:n=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:p.track[a-1].event[i-1].data=u.readStr(h);break;case 33:case 89:case 81:p.track[a-1].event[i-1].data=u.readInt(h);break;case 84:p.track[a-1].event[i-1].data=[],p.track[a-1].event[i-1].data[0]=u.readInt(1),p.track[a-1].event[i-1].data[1]=u.readInt(1),p.track[a-1].event[i-1].data[2]=u.readInt(1),p.track[a-1].event[i-1].data[3]=u.readInt(1),p.track[a-1].event[i-1].data[4]=u.readInt(1);break;case 88:p.track[a-1].event[i-1].data=[],p.track[a-1].event[i-1].data[0]=u.readInt(1),p.track[a-1].event[i-1].data[1]=u.readInt(1),p.track[a-1].event[i-1].data[2]=u.readInt(1),p.track[a-1].event[i-1].data[3]=u.readInt(1);break;default:this.customInterpreter!==null&&(p.track[a-1].event[i-1].data=this.customInterpreter(p.track[a-1].event[i-1].metaType,u,h)),this.customInterpreter!==null&&p.track[a-1].event[i-1].data!==!1||(u.readInt(h),p.track[a-1].event[i-1].data=u.readInt(h),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((c=c.toString(16).split(""))[1]||c.unshift("0"),p.track[a-1].event[i-1].type=parseInt(c[0],16),p.track[a-1].event[i-1].channel=parseInt(c[1],16),p.track[a-1].event[i-1].type){case 15:this.customInterpreter!==null&&(p.track[a-1].event[i-1].data=this.customInterpreter(p.track[a-1].event[i-1].type,u,!1)),this.customInterpreter!==null&&p.track[a-1].event[i-1].data!==!1||(r=u.readIntVLV(),p.track[a-1].event[i-1].data=u.readInt(r),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:p.track[a-1].event[i-1].data=[],p.track[a-1].event[i-1].data[0]=u.readInt(1),p.track[a-1].event[i-1].data[1]=u.readInt(1);break;case 12:case 13:p.track[a-1].event[i-1].data=u.readInt(1);break;case-1:n=!0;break;default:if(this.customInterpreter!==null&&(p.track[a-1].event[i-1].data=this.customInterpreter(p.track[a-1].event[i-1].metaType,u,!1)),this.customInterpreter===null||p.track[a-1].event[i-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return p},customInterpreter:null};if(typeof pe<"u")pe.exports=s;else{let o=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;o.MidiParser=s}})()});var Te=function(e,t){let s=Math.min(e.length,t.length),o=e.slice(0,s),u=t.slice(0,s),p=0,m=0;for(;m<s&&p==0;)p=Math.sign(o[m]-u[m]),m++;return p},I=function(e=""){this.name=e,this.pool=[],this.point=function(t,s=!1){if(this.pool.length>0){let o=this.pool.length,u=1<<Math.floor(Math.log2(o)),p=u,m=64;for(;u>=1&&m>=0;){if(m<=0)throw new Error("TTL reached.");if(p==o)p-=u;else{let r=Te(t,this.pool[p]);switch(r){case 0:{m=0;break}case 1:{p+u<=o&&(p+=u);break}case-1:{p!=0&&(p-=u);break}default:console.warn(`Unexpected result ${r}.`)}}u=u>>1,m--}let y=!0;if(p>=this.pool.length)y=!1;else{let r=this;this.pool[p].forEach(function(l,h,a){y&&l!=t[h]&&(y=!1)}),!y&&Te(t,this.pool[p])>0&&p++}return y||s?p:-1}else return s?0:-1},this.add=function(t,s){return t.data=s,this.pool.splice(this.point(t,!0),0,t),this},this.default=function(t){console.warn(`No match in "${this.name||"(unknown)"}" for "${t}". Default action not defined.`)},this.get=function(t){let s=this.point(t);if(s>-1)return this.pool[s].data;this.default(t)},this.run=function(t,...s){let o=this.point(t);o>-1?t.subarray?this.pool[o].data(t.subarray(this.pool[o].length),...s):this.pool[o].data(t.slice(this.pool[o].length),...s):this.default(t,...s)}};var ee=class{#t={};addEventListener(e,t){this.#t[e]||(this.#t[e]=[]),this.#t[e].unshift(t)}removeEventListener(e,t){if(this.#t[e]){let s=this.#t[e].indexOf(t);s>-1&&this.#t[e].splice(s,1),this.#t[e].length<1&&delete this.#t[e]}}dispatchEvent(e,t){let s=new Event(e),o=this;s.data=t,this.#t[e]?.length>0&&this.#t[e].forEach(function(u){try{u?.call(o,s)}catch(p){console.error(p)}}),this[`on${e}`]&&this[`on${e}`](s)}};var ft=["MSB","PRG","LSB","NME","ELC","DRM","LVL"],ht={krs:"KR",s90es:"ES",motif:"ES"},ut={krs:"Kr",s90es:"SE",motif:"ME"},oe=function(e){let t=Math.floor(e/10),s=e%10;return`${t.toString(16)}${s}`},le=class{#t;get bankInfo(){return this.#t}strictMode=!1;get(e=0,t=0,s=0,o,u=0){let p=[e,t,s],m,y=1,r=0,l,h,a=Array.from(arguments);switch(o){case"xg":{switch(e){case 0:{s===126?a[2]=125:s===127&&(a[2]=0);break}case 16:{s===126&&(a[2]=0);break}case 32:{s>125&&(a[2]=0),a[2]+=4;break}case 33:{(s>125||s===3)&&(a[2]=0),a[2]+=5;break}case 34:case 35:case 36:{s>125&&(a[2]=0),a[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:a[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{s===126&&(a[2]=0);break}case 48:case 64:case 126:case 127:{s===126&&(e===127&&t===0||(a[2]=0));break}}break}case"gs":case"sc":{e===0&&s<5?a[0]=49:e>125&&s<5&&s!==2&&(a[2]=e,a[0]=49);break}case"mt32":{e===0&&(a[0]=49);break}case"sd":{switch(e){case 121:{a[0]=96;break}case 120:{a[0]=104;break}}a[0]>>1===40?a[2]|=16:a[0]>95&&a[0]<100&&(a[2]|=16,t>>4===7&&(a[0]=96));break}case"g2":{e>>1===40?a[2]|=16:e>95&&e<100&&(a[2]|=16,t>>4===7&&(a[0]=96));break}case"sg":{e===8&&s===0&&(a[2]=5);break}case"05rw":case"x5d":{e&&e<56&&(a[0]=56);break}case"s90es":case"motif":case"cs6x":{if(e===0)break;switch(e){case 63:{switch(o){case"s90es":{s<8?a[2]+=17:s<32?a[2]+=13:a[2]=(a[2]>>3)+19;break}case"motif":{s<8?a[2]+=28:s<32?a[2]+=13:a[2]=(a[2]>>3)+19;break}}break}case 32:{s>125&&(a[2]=0),a[2]+=4;break}case 33:{(s>125||s===3)&&(a[2]=0),a[2]+=5;break}case 34:case 35:case 36:{s>125&&(a[2]=0),a[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:a[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{s===126&&(a[2]=0);break}}break}}let i=" ",n="M",c="",d=0,f=0;switch(a[0]){case 0:{switch(a[2]){case 127:{n="GM-a";break}case 126:{n="GM-n";break}case 7:{n="GM-k",c="GLX";break}case 5:{n="SG-a",c="000";break}case 4:{o==="gs"||o==="sc"?(n="GM-a",c="000"):(n="SP-l",c="C/M");break}case 3:case 2:case 1:{(o==="gs"||o==="sc")&&(n="GM-a",c="000");break}case 0:{n="GM-a";break}default:n="y",d=3}break}case 8:{o==="sg"?n="GM-s":n="r:";break}case 32:case 33:case 34:case 35:case 36:{o==="xg"&&(n=`${["AP","VL","PF","DX","AN"][e&7]}-${"abcdefgh"[s]}`,d=3);break}case 48:{c=`M${(a[2]>>3).toString().padStart(2,"0")}`,n=`y${c}`,d=1;break}case 49:{a[2]>>1===63?(n=`MT-${"ba"[a[2]&1]}`,c=`C${"-/"[a[2]&1]}M`):(n="GM-a",c="000");break}case 56:{n="GM-b";break}case 57:n=["yDOC","QY10","QY20"][a[2]-112]||"yMxv",c=["DOC","QY1","QY2"][a[2]-112]||"057";case 61:case 120:{n="rDrm";break}case 62:{n="kDrm";break}case 63:{if(a[2]<17){let $=a[2];n=$<10?"kP:":"kC:",n+=$%10}else a[2]<34?n=["Pre1","Pre2","Pre3","Pre4","Usr1","Usr2","DrmP","DrmU","Plg1","Plg2","Plg3","Pre1","Pre2","Pre3","Pre4","Pre5","Pre6"][a[2]-17]:n="Ds";d=1;break}case 64:{n="ySFX",c="SFX";break}case 67:{n="DX:S";break}case 80:case 81:case 82:case 83:{n=`Prg${"UABC"[a[0]-80]}`;break}case 88:case 89:case 90:case 91:{n=`Cmb${"UABC"[a[0]-88]}`;break}case 95:{n=`${["DR","PC"][a[2]]}-d`;break}case 96:{n=a[2]===106?"AP-a":a[2]>>4===1?"SDg":"PF",a[2]>63?f=63:a[2]>>4===1&&(f=16),d=3;break}case 97:{n=a[2]>>4===1?"SDa":"VL:",d=3,a[2]>>4===1?f=16:f=112;break}case 98:{n=a[2]>>4===1?"SDb":"SG-a",d=3,f=16;break}case 99:{n=a[2]>>4===1?"SDc":"DX",a[2]>63?f=63:a[2]>>4===1&&(f=16),d=3;break}case 100:{n="AN",a[2]>63?f=63:a[2]>>4===1&&(f=16),d=3;break}case 104:case 105:case 106:case 107:{n="SDd",f=104;break}case 121:{n=`GM-${a[2]?"":"a"}`,d=3;break}case 122:{n="lDrm";break}case 126:{n="yDrS";break}case 127:{a[2]===127?n="rDrm":n="yDrm";break}default:a[0]<48?n="r:":n="M"}n.length<4&&(n+=`${[e,s,a[0],a[2]][d]-f}`.padStart(4-n.length,"0")),c.length<3&&(c+=`${[e,s,e,s][d]}`.padStart(3-c.length,"0")),o==="xg"&&(e===0?a[2]<100?n=n.replace("y0","y:"):a[2]===125&&(n="y126"):e===16?(m=`Voice${((a[2]<<7)+a[1]+1).toString().padStart(3,"0")}`,i=" "):e===35&&s>>1===2&&(m=`DXCH_${(((a[2]&1)<<7)+t+1).toString().padStart(3,"0")}`,i=" "));let g=[a[0],a[1],a[2]];for(;!(m?.length>=0);)if(m=this.#t[a[1]||0][(a[0]<<8)+a[2]]?.name,m){let $=this.#t[a[1]||0][(a[0]<<8)+a[2]];y=$?.poly||y,r=$?.type||r,l=$?.drum,h=$?.level}else if(this.strictMode)m="",i="?";else if(a[0]===0&&a[1]===0&&a[2]===0)m="Unloaded";else if(this.#t[a[1]||0][a[0]<<8])a[0]===0?(a[2]=0,i="^"):a[2]<1?(a[0]=0,i="*"):(a[2]--,i="^");else if(e===48)a[0]=0,a[2]=0,i="!";else if(e===62)a[1]--,i=" ",a[1]<1&&!m?.length&&(a[0]=0,i="!");else if(e<63)a[0]===0?(a[2]=0,i="^"):a[2]<1?(a[0]=0,i="*"):a[2]--;else if(e===80)m=`PrgU:${t.toString().padStart(3,"0")}`,i="!";else if(e===88)m=`CmbU:${t.toString().padStart(3,"0")}`,i="!";else if(e===121)m=`GM2Vox0${s}`,i="#";else if(e===122)if(a[1]===32?a[1]:a[1]%=7,m=this.#t[a[1]||0][(a[0]<<8)+a[2]]?.name,m){i=" ";let $=this.#t[a[1]||0][(a[0]<<8)+a[2]];y=$?.poly||y,r=$?.type||r,l=$?.drum,h=$?.level}else m="",i="*";else a[1]===0?(m=`${e.toString().padStart(3,"0")} ${t.toString().padStart(3,"0")} ${s.toString().padStart(3,"0")}`,i="!"):a[0]===0?(a[2]=0,i="^"):a[2]>0?a[2]--:a[1]>0?(a[1]=0,i="!"):(a[0]=0,i="?");let v=[a[0],a[1],a[2]];switch(i){case"^":{switch(o){case"gs":case"sc":case"ns5r":{i=" ";break}}e===127&&i==="^"&&(i=" ");break}}let C="??";switch(a[0]){case 0:{a[2]===0?C="GM":a[2]===5||a[2]===7?C="KG":a[2]<126&&(C="XG");break}case 32:case 33:case 35:case 36:{a[2]>4?C=["AP","VL","PF","DX","AN"][a[0]-32]:C="GS";break}case 48:{C="MU";break}case 49:{a[2]>>1===63?C="MT":a[2]<5&&(C="GM");break}case 56:{C="AG";break}case 61:case 80:case 83:case 88:case 89:case 91:{C="AI";break}case 62:case 82:case 90:{C="XD";break}case 63:{a[2]<17?C="KR":a[2]<34?C="ES":C="DS";break}case 64:case 126:{C="XG";break}case 67:case 99:{C=a[2]>>4===1?"SD":"DX";break}case 81:{C="RW";break}case 95:{C=["DR","PC"][a[2]];break}case 96:{C=a[2]===106?"AP":a[2]>>4===1?"SD":"PF";break}case 97:{C=a[2]>>4===1?"SD":"VL";break}case 98:{C=a[2]>>4===1?"SD":"SG";break}case 100:{C="AN";break}case 104:case 105:case 106:case 107:{C="SD";break}case 120:{C=t===0?"GM":"GS";break}case 121:{C=a[2]?"G2":"GM";break}case 122:{C="KG";break}case 127:{C=a[2]===127?"MT":t===0?"GM":"XG";break}default:a[0]<48&&(a[0]===16&&o==="xg"?C="XG":C="GS")}if(i!==" ")switch(o){case"krs":case"s90es":case"motif":{m="",C=ht[o];break}default:self.debugMode&&(m="")}return{name:m||`${ut[o]||o.toUpperCase()}${oe(e||0)}${oe(t||0)}${oe(s||0)}`,poly:y,type:r,drum:l,level:h,iid:g,eid:v,sid:p,ending:i,sect:n,bank:c,standard:C,mode:o}}async load(e,t,s="(internal)",o){let u=this,p=[],m=0,y=0,r=0;e.split(`
`).forEach(function(l,h){let a=l.split("	"),i=[];if(h===0){if(a.forEach(function(n,c){p[ft.indexOf(n)]=c}),p.length<4){console.debug("Debugger launched.");debugger}}else{let n=0,c=0,d=0,f,g=1,v=0,C,$;a.forEach(function(A,K){switch(K){case p[0]:{n=parseInt(A);break}case p[1]:{c=parseInt(A);break}case p[2]:{d=parseInt(A);break}case p[3]:{f=A;break}case p[4]:{A=parseInt(A),A<16?g=A+1:(v=(A&15)+1,g=v);break}case p[5]:{$=A;break}case p[6]:{A?.constructor&&(C=parseInt(A));break}}}),u.#t[c]=u.#t[c]||[];let x=u.#t[c],P={msb:n,prg:c,lsb:d,name:f,poly:g,type:v,drum:$,level:C,priority:o},V=!1;o<x[n<<8|d]?.priority&&(V=!0,r++),(!x[n<<8|d]||V||t)&&(x[n<<8|d]=P,m++),y++}}),t||console.debug(`Map "${s}": ${y} total, ${m} loaded (${m-r} + ${r}).`)}clearRange(e){let t=e.prg!==void 0?e.prg.constructor===Array?e.prg:[e.prg,e.prg]:[0,127],s=e.msb!==void 0?e.msb.constructor===Array?e.msb:[e.msb,e.msb]:[0,127],o=e.lsb!==void 0?e.lsb.constructor===Array?e.lsb:[e.lsb,e.lsb]:[0,127];for(let u=s[0];u<=s[1];u++){let p=u<<8;for(let m=o[0];m<=o[1];m++){let y=p+m;for(let r=t[0];r<=t[1];r++)delete this.#t[r][y]}}}init(){this.#t=[];for(let e=0;e<128;e++)this.#t.push([""])}async loadFiles(...e){this.init();let t=this;e.forEach(async function(s,o){try{t.load(await(await fetch(`./data/bank/${s}.tsv`)).text(),!1,s,o)}catch{console.error(`Failed loading "${s}.tsv".`)}})}constructor(...e){this.loadFiles(...e)}};var Se=class{#t={};context;set(e,t){this.#t[e]=t}has(e){return!!this.#t[e]}async read(e,t){if(!this.has(e))throw new Error(`No decoder registered for "${e}"`);return await this.#t[e].call(this.context||this,t)}};var pt=function(e,t){let s=!0;return t.forEach((o,u)=>{s=s&&e[u]===o}),s},W=function(e){let t=0;return e.forEach(s=>{t*=256,t+=s}),t},X=new TextDecoder,q=new Se;q.set("s7e",async function(e){let t=new Uint8Array(await e.slice(0,65536).arrayBuffer()),s="MSB	LSB	PRG	NME",o=[0,0,0,0],u=32,p=0,m=0,y=!0,r=[],l=0;for(;y;){let h=t.subarray(p);([()=>{X.decode(h.subarray(0,4))==="YSFC"?(p+=80,m=1):p++},()=>{if(pt(h.subarray(0,4),o))r.forEach((a,i,n)=>{let c=W(t.subarray(a.start+4,a.start+8));a.length=c}),m=2;else{let a=X.decode(h.subarray(0,4)),i=W(h.subarray(4,8));r.push({type:a,start:i}),p+=8}},()=>{let a=r[l],i=t.subarray(a.start,a.start+a.length),n=32;switch(a.type){case"ENVC":{let c=u;for(;c<i.length;){let d=i.subarray(c,c+n),f=X.decode(d.subarray(0,10)).trimEnd();f.slice(0,5)==="Init "&&(f=""),f&&(s+=`
063	${(d[17]+13).toString().padStart(3,"0")}	${d[19].toString().padStart(3,"0")}	${f}`),c+=n}break}case"EDVC":{let c=u;for(;c<i.length;){let d=i.subarray(c,c+n),f=X.decode(d.subarray(0,10)).trimEnd();f.slice(0,5)==="Init "&&(f=""),f&&(s+=`
063	024	${d[19].toString().padStart(3,"0")}	${f}`),c+=n}break}case"EPVC":{let c=32,d=u;for(;d<i.length;){let f=i.subarray(d,d+c),g=X.decode(f.subarray(0,10)).trimEnd();g==="----------"&&(g=""),g&&(s+=`
063	${(f[17]+1).toString().padStart(3,"0")}	${f[19].toString().padStart(3,"0")}	${g}`),d+=c}break}}l++,l>=r.length&&(m=3,y=!1)}][m]||(()=>{y=!1}))()}return s});q.set("pcg",async function(e){let t=new Uint8Array(await e.arrayBuffer()),s="MSB	LSB	PRG	NME",o=100,u=0,p=0,m=!0,y=[],r=0;for(;m;){let l=t.subarray(o);([()=>{m=X.decode(l.subarray(0,4))==="INI2",p=l[15],o+=16,u=1},()=>{let h=X.decode(l.subarray(0,4)),a=l[5],i=l[7],n=l[11],c=W(l.subarray(12,16)),d=W(l.subarray(16,20)),f=W(l.subarray(36,40)),g=X.decode(l.subarray(44,44+n));y.push({type:h,tipMsb:a,tipLsb:i,nameLen:n,length:c,start:d,entryLen:f,name:g}),o+=64,p--,p<1&&(u=2)},()=>{let h=y[r],a=t.subarray(h.start,h.start+h.length);switch(h.type){case"PRG1":break;case"PBK1":{let i=63,n=(h.tipMsb?6:0)+h.tipLsb;for(let c=0;c<128;c++){let d=c*h.entryLen,f=a.subarray(d,d+h.entryLen),g=X.decode(f.subarray(0,24)).trimEnd().replace("InitProg","");g.length&&n>5&&(s+=`
${i.toString().padStart(3,"0")}	${n.toString().padStart(3,"0")}	${c.toString().padStart(3,"0")}	${g}`)}break}case"CBK1":{let i=63,n=(h.tipMsb?3:0)+h.tipLsb+10;for(let c=0;c<128;c++){let d=c*h.entryLen,f=a.subarray(d,d+h.entryLen),g=X.decode(f.subarray(0,24)).trimEnd().replace("InitCombi","");g.length&&n>12&&(s+=`
${i.toString().padStart(3,"0")}	${n.toString().padStart(3,"0")}	${c.toString().padStart(3,"0")}	${g}`)}break}}r++,r>=y.length&&(u=3,m=!1)}][u]||(()=>{m=!1}))()}return s});var Q=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]),Z=["melodic","drums","drum set 1","drum set 2","drum set 3","drum set 4","drum set 5","drum set 6","drum set 7","drum set 8"],mt=[17.1,18.6,20.2,21.8,23.3,24.9,26.5,28,29.6,31.2,32.8,34.3,35.9,37.5,39,40.6,42.2,43.7,45.3,46.9,48.4,50],F=[20,22,25,28,32,36,40,45,50,56,63,70,80,90,100,110,125,140,160,180,200,225,250,280,315,355,400,450,500,560,630,700,800,900,1e3,1100,1200,1400,1600,1800,2e3,2200,2500,2800,3200,3600,4e3,4500,5e3,5600,6300,7e3,8e3,9e3,1e4,11e3,12e3,14e3,16e3,18e3,2e4],Me=[0,.04,.08,.13,.17,.21,.25,.29,.34,.38,.42,.46,.51,.55,.59,.63,.67,.72,.76,.8,.84,.88,.93,.97,1.01,1.05,1.09,1.14,1.18,1.22,1.26,1.3,1.35,1.39,1.43,1.47,1.51,1.56,1.6,1.64,1.68,1.72,1.77,1.81,1.85,1.89,1.94,1.98,2.02,2.06,2.1,2.15,2.19,2.23,2.27,2.31,2.36,2.4,2.44,2.48,2.52,2.57,2.61,2.65,2.69,2.78,2.86,2.94,3.03,3.11,3.2,3.28,3.37,3.45,3.53,3.62,3.7,3.87,4.04,4.21,4,37,4.54,4.71,4.88,5.05,5.22,5.38,5.55,5.72,6.06,6.39,6.73,7.07,7.4,7.74,8.08,8.41,8.75,9.08,9.42,9.76,10.1,10.8,11.4,12.1,12.8,13.5,14.1,14.8,15.5,16.2,16.8,17.5,18.2,19.5,20.9,22.2,23.6,24.9,26.2,27.6,28.9,30.3,31.6,33,34.3,37,39.7],Re=function(e){let t=.1,s=-.3;return e>66?(t=5,s=315):e>56?(t=1,s=47):e>46&&(t=.5,s=18.5),t*e-s},Pe=function(e){return e>105?mt[e-106]:e>100?e*1.1-100:e/10},Ae=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),de={};`hi*,
ka,か
ki,き
ku,く
ke,け
ko,こ
ky,き!
kw,くl
tsu,つ
ts,つl
sa,さ
si,すぃ
su,す
se,せ
so,そ
shi,し
sh,し!
ta,た
ti,てぃ
tu,とぅ
te,て
to,と
tchy,ち!
tchi,ち
na,な
ni,に
nu,ぬ
ne,ね
no,の
ny,に!
nn,ん
ha,は
hi,ひ
hu,ほぅ
he,へ
ho,ほ
hy,ひ!
fa,ふぁ
fi,ふぃ
fu,ふ
fe,ふぇ
fo,ふぉ
ma,ま
mi,み
mu,む
me,め
mo,も
my,み!
mm,ㇺ
ra,ら
ri,り
ru,る
re,れ
ro,ろ
ry,り!
wa,わ
wi,ゐ
we,ゑ
wo,を
nga,か゚
ngi,き゚
ngu,く゚
nge,け゚
ngo,こ゚
ngy,き゚!
ng,ン
ga,が
gi,ぎ
gu,ぐ
ge,げ
go,ご
gy,ぎ!
gw,ぐl
za,ざ
zi,ずぃ
zu,ず
ze,ぜ
zo,ぞ
ja,じゃ
ji,じ
ju,じゅ
je,じぇ
jo,じょ
jy,じ!
da,だ
di,でぃ
du,どぅ
de,で
do,ど
dy,で!
ba,ば
bi,び
bu,ぶ
be,べ
bo,ぼ
by,び!
va,ゔぁ
vi,ゔぃ
vu,ゔ
ve,ゔぇ
vo,ゔぉ
pa,ぱ
pi,ぴ
pu,ぷ
pe,ペ
po,ぽ
py,ぴ!
!ya,ゃ
!yu,ゅ
!ye,ぇ
!yo,ょ
ya,や
yu,ゆ
ye,𛀁
yo,よ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
!a,ゃ
!u,ゅ
!e,ぇ
!o,ょ
la,ぁ
li,ぃ
lu,ぅ
le,ぇ
lo,ぉ
a,あ
i,い
u,う
e,え
o,お
*,っ
~,
^,
_,`.split(`
`).forEach(e=>{let t=e.split(",");de[t[0]]=t[1]});var De=function(e){let t=e;e[0]=="*"&&(t=t.slice(1)),["aa","ii","uu","ee","oo"].forEach(o=>{for(;t.indexOf(o)>-1;)t=t.replace(o,o[0])});for(let o in de)t=t.replaceAll(o,de[o]);t.indexOf("ん")==0&&t.length>1&&(t=t.slice(1));let s=t.indexOf("!");return s>-1&&t.length>1&&(t=t.slice(s+1)),t},Le=function(e){return e?e<96?`cc${e}`:["aftertouch","velocity","pitch bend"][e-96]:"off"},Oe={u8:["utf-8","Unicode"],l1:["l9","Pan-Latin"],jp:["sjis","Japanese"],kr:["iso-2022-kr","Korean"],hz:["gb18030","Simplified Chinese"],b5:["big5","Traditional Chinese"],cy:["koi8-ru","Cyrillic"],vn:["tcvn-5773-1993","Vietnamese"]},Ie={m:"Male",f:"Female",c:"Chorus",s:"Solo",p:"Plural",w:"Words",x:"Non-vocal"};var fe=["room 1","room 2","room 3","hall 1","hall 2","plate","delay","panning delay"],Ne=["chorus 1","chorus 2","chorus 3","chorus 4","feedback","flanger","short delay","short delay feedback"],Ue=["delay 1","delay 2","delay 3","delay 4","pan delay 1","pan delay 2","pan delay 3","pan delay 4","delay to reverb","pan repeat"];var gt={0:"thru",256:"stereo EQ",257:"spectrum",258:"enhancer",259:"humanizer",272:"overdrive",273:"distortion",288:"phaser",289:"auto wah",290:"rotary",291:"stereo flanger",292:"step flanger",293:"tremelo",294:"auto pan",304:"compressor",305:"limiter",320:"hexa chorus",321:"tremelo chorus",322:"stereo chorus",323:"space D",324:"3D chorus",336:"stereo delay",337:"modulated delay",338:"3-tap delay",339:"4-tap delay",340:"tremelo control delay",341:"reverb",342:"gate reverb",343:"3D delay",352:"2-pitch shifter",353:"feedback pitch shifter",368:"3D auto",369:"3D manual",370:"Lo-Fi 1",371:"Lo-Fi 2",512:"overdrive - chorus",513:"overdrive - flanger",514:"overdrive - delay",515:"distortion - chorus",516:"distortion - flanger",517:"distortion - delay",518:"enhancer - chorus",519:"enhancer - flanger",520:"enhancer - delay",521:"chorus - delay",522:"flanger - delay",523:"chorus - flanger",524:"rotary multi",1024:"guitar multi 1",1025:"guitar multi 2",1026:"guitar multi 3",1027:"clean guitar multi 1",1028:"clean guitar multi 2",1029:"bass multi",1030:"rhodes multi",1280:"keyboard multi",4352:"chorus / delay",4353:"flanger / delay",4354:"chorus / flanger",4355:"overdrive / distortion",4356:"overdrive / rotary",4357:"overdrive / phaser",4358:"overdrive / auto wah",4359:"phaser / rotary",4360:"phaser / auto wah"},bt={66307:["drive"],66309:["vowel",e=>"aiueo"[e]],94723:["pre-filter"],94724:["Lo-Fi type"],94725:["post-filter"],94979:["Lo-Fi type"],94980:["fill type",e=>["off","LPF","HPF"][e]],94984:["noise type",e=>["white","pink"][e]],94987:["disc type",e=>["LP","SP","EP","RND"]],94990:["hum type",e=>`${e+5}0Hz`],94993:["M/S",e=>["mono","stereo"][e]]},he=function(e){return gt[(e[0]-32<<8)+e[1]]||`0x${e[0].toString(16).padStart(2,"0")}${e[1].toString(16).padStart(2,"0")}`},Be=function(e,t,s){let o=(e[0]-32<<16)+(e[1]<<8)+t,u=bt[o]||{},p=u[0];if(p?.length)return p+=`: ${(u[1]||function(){})(s)||s}`,p},ue=[68,48,95,78,41,3,110,122,0];var L=function(e=64){return Math.round(2e3*Math.log10(e/64))/100},Ve=function(e,t,s){let o=[],u=s==!1?t.readIntVLV():s;e==0||e==127;for(let p=0;p<u;p++){let m=t.readInt(1);if(o.push(m),m!=247){if(m!=240){if(m>127)return console.debug(`Early termination: ${o}`),o.pop(),t.backOne(),t.backOne(),new Uint8Array(o)}}}return new Uint8Array(o)},G=function(e){let t=0;return e.forEach(s=>{t+=s,t=t&127}),~t+1&127},N=function(e,t){let s=0,o=0;for(let u=0;u<e.length;u++){let p=u%8-1,m=(o>>p&1)<<7,y=e[u];y+=m,u%8!==0?(t(y,s,e),s++):o=e[u]}};var J=function(e){let t=Math.floor(e*14.2);return t<128?t:0},T=function(){return self.Bun?!0:self.debugMode??!1};var ta="♭𝄫,𝄫,♭,,♯,𝄪,𝄪♯".split(",");var ga=xe(me(),1),R=["?","gm","gs","sc","xg","g2","mt32","doc","qy10","qy20","ns5r","x5d","05rw","k11","sg","sd","pa","krs","s90es","motif","cs6x","trin"],yt={gm2:"g2","mt-32":"mt32","c/m":"mt32",ag10:"05rw","ag-10":"05rw","05r/w":"05rw",x5:"05rw",x5dr:"x5d",gmega:"k11","kross 2":"krs","motif es":"motif","s90 es":"s90es",trinity:"trin","tr-rack":"trin"},Et=["melodic","drum","menu"],Xe={"?":[0,0,120,0,0],gm:[0,0,120,0,0],gs:[0,0,120,0,0],sc:[0,0,120,0,0],xg:[0,0,127,0,0],g2:[0,0,120,0,0],mt32:[0,127,127,0,127],doc:[57,112,127,57,112],qy10:[57,113,127,57,113],qy20:[57,114,127,57,114],ns5r:[0,0,61,0,0],x5d:[82,0,62,56,0],"05rw":[81,0,62,56,0],k11:[0,0,122,0,0],sg:[0,0,122,0,0],sd:[97,0,105,0,0],krs:[121,0,120,0,0],s90es:[0,0,127,0,0],motif:[0,0,127,0,0],cs6x:[0,0,127,0,0],trin:[0,0,127,0,0]},vt=[9,25,41,57,73,89,105,121],wt=[0,3,81,84,88],_e={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},te={0:0,1:1,2:3,5:4},He={0:0,1:1,2:2,5:3},Ge=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],be=[36,37,48,49,52,53],ie=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65],Ke={26:127,29:0,30:0,31:0,52:12,53:54},z=[0,1,2,4,5,6,7,8,10,11,12,13,14,15,16,17,18,19,20,21,22,26,28,32,38,40,41,42,43,44,45,46,47,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,80,81,82,83,84,91,92,93,94,95,98,99,100,101,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],Ct=[2,4,12,13,14,15,16,17,18,19,20,21,40,41,42,43,44,45,46,47,80,81,83,136,130,131,132,133,134,135,137,138,139,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],kt=[33,102,99,32,100,8,9,10],Fe=[0,16,25,40,32,64,24,48],w={};R.forEach((e,t)=>{w[e]=t});var E=[];z.forEach((e,t)=>{E[e]=t});var O={length:ie.length};ie.forEach((e,t)=>{O[e]=t});var $t={};Et.forEach((e,t)=>{$t[e]=t});var xt=function(e){let t=[],s=0;return e?.forEach(function(o,u){o===247?t.push(e.subarray(s,u)):o===240&&(s=u+1)}),t.length||t.push(e.subarray(0)),T()&&console.debug(t),t};var ge=8,b={port:ge,ch:ge<<4,chShift:Math.ceil(Math.log2(ge))+4,cc:z.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,rpnt:4,nrpn:be.length,ace:8,drm:8,dpn:ie.length,dnc:128,ext:3,efx:7,cvn:12,redir:32,vxPrim:3,invalidCh:255};b.chcc=b.cc*b.ch;var U={bank0:128},Tt=new TextDecoder("l9"),S=new Uint16Array(b.ch),Y=new Uint16Array(b.ch),St=new Uint16Array(b.ch),ae=new Uint16Array(b.ch),Mt=new Uint16Array(b.ch),re=new Uint16Array(b.ch),Ye=new Array(b.drm);for(let e=0;e<b.ch;e++)S[e]=e*b.cc,Y[e]=e*b.rpn,St[e]=e*b.nrpn,ae[e]=e*b.ace,Mt[e]=e*b.ext,re[e]=e*b.cvn;for(let e=0;e<b.drm;e++){Ye[e]=new Uint16Array(b.dpn);let t=e*b.dpn*b.dnc;for(let s=0;s<b.dpn;s++)Ye[e][s]=t+s*b.dnc}var ze=class extends ee{NOTE_IDLE=0;NOTE_ATTACK=1;NOTE_DECAY=2;NOTE_SUSTAIN=3;NOTE_HELD=4;NOTE_RELEASE=5;NOTE_SOSTENUTO_ATTACK=8;NOTE_SOSTENUTO_DECAY=9;NOTE_SOSTENUTO_SUSTAIN=10;NOTE_SOSTENUTO_HELD=11;NOTE_MUTED_RECOVERABLE=16;CH_MELODIC=0;CH_DRUMS=1;CH_DRUM1=2;CH_DRUM2=3;CH_DRUM3=4;CH_DRUM4=5;CH_DRUM5=6;CH_DRUM6=7;CH_DRUM7=8;CH_DRUM8=9;DUMP_ALL=0;DUMP_ONCE=1;DUMP_MODE=2;EXT_NONE=0;EXT_VL=1;EXT_DX=3;VLBC_SYSTEM=0;VLBC_BRTHEXPR=1;VLBC_VELOINIT=2;VLBC_VELOALL=3;CH_INACTIVE=0;CH_ACTIVE=1;CH_DISABLED=2;KARAOKE_NONE=0;KARAOKE_TEXT=1;KARAOKE_XF=2;#t=0;#p=0;#C=0;#S=new Array(11);get#k(){return this.#S[this.#p]}set#k(e){this.#S[this.#p]=e}#u=new Uint8Array(b.ch);#c=new Uint8Array(b.ch);#i=new Uint8Array(b.ch);#e=new Uint8Array(b.chcc<<1);#m=new Uint8Array(b.ch*b.ace);#r=new Uint8Array(b.ch*b.vxPrim);#b=new Uint8Array(b.ch*b.nn);#g=new Uint8Array(b.ch);#h=new Uint16Array(b.pl);#l=new Uint8Array(b.pl);#$=new Int16Array(b.ch);#O=new Uint8Array(b.ch);#Q=new Uint8Array(b.ch);#w=new Uint8Array(b.ch*b.ext);#s=new Uint8Array(b.ch*b.rpn);#o=new Uint8Array(b.ch*b.rpnt);#Z=new Int8Array(b.ch*be.length);#P=new Uint8Array(b.drm*b.dpn*b.dnc);#B=new Uint8Array(b.drm*2);#R=new Uint8Array(b.efx*3);#J=new Uint8Array(b.ch);#H=new Uint8Array(b.ch*b.redir);#x=new Uint8Array(b.port);#G=new Uint8Array(b.port);#y=new Uint8Array(b.ch);#L=new Uint8Array(b.ch);#z=new Uint8Array(b.ch*b.cvn);#I=new Uint8Array(128);#A=new Uint8Array(b.cmt*8);#M=new Uint8Array(1024);#K=new Uint8Array(b.cmt*64);#a={};modelEx={sc:{showBar:!0,invBar:!1,invDisp:!1,peakHold:1}};#n;#d;#v;#f=100;#W=0;#F=500;#j=0;#ee=0;#ce=32;#re=!1;#X="";#te=0;#se=0;#q=0;#V=!0;#E=0;#be=1;#me;#T=!1;#oe=new Array(b.ch);#_=[];#ie=new Uint8Array(b.ch);#ne=new Uint8Array(b.tr);baseBank=new le("gm2","ns5r","xg","gs","sd","gmega","plg-vl","plg-pf","plg-dx","plg-an","plg-dr","plg-sg","kross","s90es");userBank=new le("gm2");initOnReset=!1;aiEfxName="";polyIndexShrink=!0;polyIndexLatest=0;polyIndexLast=0;chRedir(e,t,s){let o=this;if(o.#ne[t])return(o.#ne[t]-1)*16+e;if(o.#t===w.sc||o.#t===w.sd){if(s===1)return e;let u=0,p=!0;for(;p;)o.#ie[e+u]===0?(o.#ie[e+u]=t,console.debug(`Assign track ${t} to channel ${e+u+1}.`),p=!1):this.#ie[e+u]===t?p=!1:(u+=16,u>=128&&(u=0,p=!1));return e+u}else return e}getTrackPort(e){return this.chRedir(0,e,!0)>>4}forceVoiceRefresh(){for(let e=0;e<b.ch;e++)this.#u[e]&&this.dispatchEvent("voice",{part:e})}#N=[];#le;#D={nOff:(e,t)=>{let s=e*128+t,o=this.#h.lastIndexOf(s);if(o>-1)if(this.getChCc(e,64)>>6)this.#l[o]=this.NOTE_HELD,this.dispatchEvent("note",{part:e,note:t,velo:this.#b[s],state:this.NOTE_HELD});else if(this.getChCc(e,66)>>6&&this.#l[o]===this.NOTE_SOSTENUTO_SUSTAIN)this.#l[o]=this.NOTE_SOSTENUTO_HELD,this.dispatchEvent("note",{part:e,note:t,velo:this.#b[s],state:this.NOTE_SOSTENUTO_HELD});else{this.#h[o]=0,this.#b[s]=0,this.#l[o]=this.NOTE_IDLE;let u=this.getExt(e)[1];(u===this.VLBC_VELOINIT||u===this.VLBC_VELOALL)&&this.setChCc(e,129,0),this.dispatchEvent("note",{part:e,note:t,velo:0,state:this.NOTE_IDLE})}if(this.#g[e]){for(let u=this.polyIndexLast;u>=0;u--)if(this.#h[u]>>7===e&&this.#l[u]!==0){this.#l[u]===this.NOTE_MUTED_RECOVERABLE&&(this.#l[u]=this.NOTE_SUSTAIN);break}}this.polyIndexShrink&&this.polyIndexLast>0&&this.#l[this.polyIndexLast]===0&&this.polyIndexLast--},nOn:(e,t,s)=>{let o=e*128+t,u=0;if(this.#g[e])for(let p=0;p<=this.polyIndexLast;p++)this.#h[p]>>7===e&&this.#l[p]!==0&&(this.#l[p]=this.NOTE_MUTED_RECOVERABLE);for(;this.#l[u]>0&&this.#h[u]!==o;)u++;if(u<b.pl){this.#h[u]=o,this.#b[o]=s,this.#l[u]=this.NOTE_SUSTAIN,this.#O[e]<s&&(this.#O[e]=s);let p=this.getExt(e)[1];(p===this.VLBC_VELOINIT||p===this.VLBC_VELOALL)&&this.setChCc(e,129,s),this.dispatchEvent("note",{part:e,note:t,velo:s,state:this.NOTE_SUSTAIN}),this.polyIndexLatest=u+1,u>this.polyIndexLast&&(this.polyIndexLast=u)}else console.error("Polyphony exceeded.")},nAt:(e,t,s)=>{},cAt:(e,t)=>{},hoOf:e=>{this.#l.forEach((t,s)=>{if(t===this.NOTE_HELD){let o=this.#h[s],u=o>>7;e===u&&(this.#l[s]=this.NOTE_IDLE,this.#h[s]=0,this.#b[o]=0,this.dispatchEvent("note",{part:e,note:o&127,velo:0,state:this.NOTE_IDLE}))}})},soOn:e=>{this.#l.forEach((t,s)=>{let o;switch(t){case this.NOTE_ATTACK:{o=this.NOTE_SOSTENUTO_ATTACK;break}case this.NOTE_DECAY:{o=this.NOTE_SOSTENUTO_DECAY;break}case this.NOTE_SUSTAIN:{o=this.NOTE_SOSTENUTO_SUSTAIN;break}}if(o){this.#l[s]=o;let u=this.#h[s];this.dispatchEvent("note",{part:e,note:u&127,velo:this.#b[u],state:o})}})},soOf:e=>{this.#l.forEach((t,s)=>{if(t===this.NOTE_SOSTENUTO_HELD){let o=this.#h[s],u=o>>7;e===u&&(this.#l[s]=this.NOTE_IDLE,this.#h[s]=0,this.#b[o]=0,this.dispatchEvent("note",{part:e,note:o&127,velo:0,state:this.NOTE_IDLE}))}})},ano:e=>{this.#h.forEach(t=>{let s=t>>7,o=t&127;t===0&&this.#b[0]===0||s===e&&this.#D.nOff(s,o)})}};#ge={8:function(e){let t=e.channel,s=e.data[0];this.#D.nOff(t,s)},9:function(e){let t=e.channel,s=this;if(s.getChModeId(t)===w.xg&&s.#i[t]>1){let p=s.getChDrumFirstWrite(t);p[0]&&p[1]!==b.invalidCh&&!s.#u[t]&&(s.copyChSetup(p[1],t),s.dispatchEvent("voice",{part:t}),console.debug(`Part CH${t+1} copied from CH${p[1]+1}.`))}s.setChActive(t,1);let o=e.data[0],u=e.data[1];u>0?s.#D.nOn(t,o,u):s.#D.nOff(t,o)},10:function(e){let t=e.channel,s=t*128+e.data[0];this.#h.indexOf(s)>-1&&(this.#b[s]=data[1],this.getExt(t)[1]===this.VLBC_VELOALL&&this.setChCc(t,129,data[1]),this.dispatchEvent("note",{part:t,note:e.data[0],velo:e.data[1],state:this.NOTE_SUSTAIN}))},11:function(e){let t=e.channel,s=this,o=s.#oe[t],u=o[e.data[0]];u&&(e.data[0]=u),[0,32].indexOf(e.data[0])>-1&&(()=>{switch(this.#t){case w.s90es:case w.motif:{if(e.data[0]===0){[0,63].indexOf(e.data[1])>-1&&s.setChActive(t,1);break}e.data[1]&&s.setChActive(t,1);break}default:break}})();let p=t*b.ext,m=s.getChModeId(t);switch(e.data[0]){case 96:return;case 97:return;case 120:return;case 121:{this.#D.ano(t),this.#$[t]=0,s.resetChCc(t,1,0),s.resetChCc(t,5,0),s.resetChCc(t,64,0),s.resetChCc(t,65,0),s.resetChCc(t,66,0),s.resetChCc(t,67,0),s.resetChCc(t,11,127),s.resetChCc(t,101,127),s.resetChCc(t,100,127),s.resetChCc(t,99,127),s.resetChCc(t,98,127);return}case 123:{this.#D.ano(t);return}case 124:{this.#D.ano(t);return}case 125:{this.#D.ano(t);return}case 126:{this.#g[t]=1,this.#D.ano(t);return}case 127:{this.#g[t]=0,this.#D.ano(t);return}}if(E[e.data[0]]===void 0)console.warn(`cc${e.data[0]} is not accepted.`);else{switch(Ct.indexOf(e.data[0])>-1&&this.allocateAce(t,e.data[0]),e.data[0]){case 0:{switch(T()&&console.debug(`${R[this.#t]}, CH${t+1}: ${e.data[1]}`),this.#t===0?e.data[1]<48?(this.#i[t]>0&&(e.data[1]=this.getChPrimitive(t,1,!1),e.data[1]=120,console.debug(`Forced channel ${t+1} to stay drums.`)),e.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${e.data[1]}`),this.switchMode("gs"))):e.data[1]===56?this.switchMode(this.#n.x5===82?"x5d":"05rw"):e.data[1]===62?this.switchMode(this.#n.x5===82?"x5d":"05rw"):e.data[1]===63?this.switchMode(R[this.#n.ds]):(e.data[1]===64||e.data[1]===127)&&this.switchMode("xg"):this.#t===w.gs||this.#t===w.sc?e.data[1]<56&&this.#i[t]>0&&(e.data[1]=this.getChPrimitive(t,1,!1),e.data[1]=120,console.debug(`Forced channel ${t+1} to stay drums.`)):this.#t===w.gm&&(e.data[1]<48?this.#i[t]>0&&(e.data[1]=120,this.switchMode("gs",!0),console.debug(`Forced channel ${t+1} to stay drums.`)):(e.data[1]===64||e.data[1]===127)&&this.switchMode("xg",!0)),this.#t){case w.xg:{[79,95,126,127].indexOf(e.data[1])>-1?this.#i[t]===0&&(this.setChType(t,this.CH_DRUM2),console.debug(`CH${t+1} set to drums by MSB.`)):this.#i[t]>0&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`)),[33,81,97].indexOf(e.data[1])>-1?this.#w[p]=this.EXT_VL:[35,67,83,99].indexOf(e.data[1])>-1?this.#w[p]=this.EXT_DX:this.#w[p]=this.EXT_NONE;break}case w["05rw"]:case w.x5d:case w.ns5r:{[61,62,126,127].indexOf(e.data[1])>-1?this.#i[t]===this.CH_MELODIC&&(this.setChType(t,this.CH_DRUM2),console.debug(`CH${t+1} set to drums by MSB.`)):[80,81,82,83].indexOf(e.data[1])>-1||this.#i[t]!==this.CH_MELODIC&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`));break}case w.sd:{[104,105,106,107].indexOf(e.data[1])>-1?this.#i[t]===0&&(this.setChType(t,this.CH_DRUM2),console.debug(`CH${t+1} set to drums by MSB.`)):this.#i[t]>0&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`));break}case w.g2:{e.data[1]===120?this.#i[t]===0&&(this.setChType(t,this.CH_DRUMS),console.debug(`CH${t+1} set to drums by MSB.`)):this.#i[t]>0&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`));break}}break}case 2:{this.getExt(t)[1]===this.VLBC_BRTHEXPR&&this.setChCc(t,129,e.data[1]);break}case 6:{if(this.#Q[t]){[w.xg,w.gs,w.sc,w.ns5r].indexOf(this.#t)<0&&console.warn(`NRPN commits are not available under "${R[this.#t]}" mode, even when they are supported in Octavia.`);let y=this.getChCc(t,99),r=this.getChCc(t,98);if(y===1){let l=kt.indexOf(r);if(l>-1)this.setChCc(t,71+l,e.data[1]),T()&&console.debug(`Redirected NRPN 1 ${r} to cc${71+l}.`),this.dispatchEvent("cc",{part:t,cc:71+l,data:e.data[1]});else{let h=be.indexOf(r);h>-1?this.#Z[t*10+h]=e.data[1]-64:console.warn(`NRPN 0x01${r.toString(16).padStart(2,"0")} is not supported.`),T()&&console.debug(`CH${t+1} voice NRPN ${r} commit`)}}else{if(ie.indexOf(y)<0){let h=`NRPN 0x${y.toString(16).padStart(2,"0")}${r.toString(16).padStart(2,"0")} `;console.warn(y===127?`${h}is not necessary. Consider removing it.`:`${h}is not supported.`)}else{let h=this.#i[t]-2;h<0?console.warn(`CH${t+1} cannot accept drum NRPN as type ${Z[this.#i[t]]}.`):this.#P[(h*b.dpn+O[y])*b.dnc+r]=e.data[1]}T()&&console.debug(`CH${t+1} (${Z[this.#i[t]]}) drum NRPN ${y} commit`)}}else{let y=te[this.getChCc(t,100)],r=He[this.getChCc(t,100)];if(this.getChCc(t,101)===0&&y!==void 0)switch(T()&&console.debug(`CH${t+1} RPN 0 ${this.getChCc(t,100)} commit: ${e.data[1]}`),e.data[1]=Math.min(Math.max(e.data[1],Ge[y][0]),Ge[y][1]),this.#s[t*b.rpn+y]=e.data[1],this.#o[t*b.rpnt+r]=1,m){case w.xg:case w.gs:case w.sc:case w.mt32:case w.s90es:case w.motif:case w.cs6x:{switch(this.getChCc(t,100)){case 1:case 2:{this.dispatchEvent("pitch",{part:t,pitch:this.getPitchShift(t)});break}}break}default:this.dispatchEvent("pitch",{part:t,pitch:this.getPitchShift(t)})}}break}case 32:{switch(T()&&console.debug(`${R[this.#t]}, CH${t+1} LSB: ${e.data[1]}`),this.#t){case w.s90es:case w.motif:{this.setChType(t,[32,40].indexOf(e.data[1])>-1?this.CH_DRUMS:this.CH_MELODIC,this.#t,!0);break}}this.getExt(t)[0],this.EXT_DX;break}case 38:{if(!this.#Q[t]){let y=te[this.getChCc(t,100)],r=He[this.getChCc(t,100)];this.getChCc(t,101)===0&&y!==void 0&&(this.#s[t*b.rpn+y+1]=e.data[1],this.#o[t*b.rpnt+r]=1)}break}case 64:{e.data[1]<64&&this.#D.hoOf(t);break}case 66:{e.data[1]>>6?this.#D.soOn(t):this.#D.soOf(t);break}case 98:case 99:{this.#Q[t]=1;break}case 100:case 101:{this.#Q[t]=0;break}}this.setChCc(t,e.data[0],e.data[1]),this.dispatchEvent("cc",{part:t,cc:e.data[0],data:e.data[1]})}s.getChModeId(t)===w.xg&&s.#i[t]&&s.setDrumFirstWrite(t)},12:function(e){let t=e.channel,s=this;switch(s.#t){case w.s90es:case w.motif:{e.data&&s.setChActive(t,1);break}default:s.setChActive(t,1)}let o=S[t];switch(s.getExt(t)[0]){case s.EXT_VL:break}s.#r[t]=e.data,s.#L[t]=0,s.pushChPrimitives(t),T()&&console.debug(`T:${e.track} C:${t} P:${e.data}`),s.dispatchEvent("voice",{part:t}),s.getChModeId(t)===w.xg&&s.#i[t]&&s.setDrumFirstWrite(t)},13:function(e){let t=this,s=e.channel;this.#h.forEach(function(o){let u=o>>7;s===u&&(t.#b[o]=e.data,t.dispatchEvent("note",{part:s,note:o&127,velo:e.data,state:t.NOTE_SUSTAIN}))})},14:function(e){let t=e.channel;this.#$[t]=e.data[1]*128+e.data[0]-8192,this.dispatchEvent("pitch",{part:t,pitch:this.getPitchShift(t)})},15:function(e){xt(e.data).forEach(t=>{let s=t[0],o=t[1];(this.#ye[s]||function(){console.debug(`Unknown manufacturer ${s}.`)})(o,t.subarray(2),e.track)})},248:function(e){},250:function(e){},251:function(e){},252:function(e){},254:function(e){},255:function(e){(this.#N[e.meta]||function(s,o,u){}).call(this,e.data,e.track,e.meta),e.meta!==32&&(this.#W=0);let t=wt.indexOf(e.meta)>-1;if(T()&&console.debug(e),t)return e.reply="meta",e}};#ye={64:(e,t,s)=>{this.#he.run(t,s,e)},65:(e,t,s)=>{if(t[0]<16)if(t[1]===72){let o=t[t.length-1],u=G(t.subarray(3,t.length-1));o===u?this.#Y.run(t.subarray(0,t.length-1),s,e):console.warn(`Bad SD checksum ${o} - should be ${u}.`)}else this.#Y.run(t,s,e);else{let o=t[t.length-1],u=G(t.subarray(2,t.length-1));o===u?this.#Y.run(t.subarray(0,t.length-1),s,e):console.warn(`Bad GS checksum ${o} - should be ${u}.`)}},66:(e,t,s)=>{this.#ae.run(t,s,e)},67:(e,t,s)=>{switch(e>>4){case 0:{let o=0;for(;t[o]===127&&o<4;)o++;let u=t[1+o]<<7|t[2+o];if(u+7+o!==t.length){console.warn(`Yamaha bulk dump length mismatch! Expected ${t.length-7-o}, received ${u}.`),console.debug(t);break}let p=G(t.subarray(1+o,t.length-1)),m=t[t.length-1];if(t[t.length-1]>>7)console.warn(`Yamaha bulk dump checksum invalid! Expected ${p}, received ${m}:
`),console.debug(t);else if(p!==m)console.warn(`Yamaha bulk dump checksum mismatch! Expected ${p}, received ${m}:
`),console.debug(t);else{let y=t.slice(2,t.length-1);for(let r=0;r<=o;r++)y[r]=t[r];this.#U.run(y,s,e&15)}break}case 1:{this.#U.run(t,s,e&15);break}case 2:{console.warn("Octavia doesn't yet support Yamaha bulk dump requests.");break}case 3:{console.warn("Octavia doesn't yet support Yamaha parameter requests.");break}case 7:{switch(e&15){case 14:{let o=new Uint8Array(t.length+1);o[0]=126,o.set(t,1),this.#U.run(o,s,0);break}default:console.warn(`Unknown Yamaha special SysEx type: ${e}.`)}break}default:console.warn(`Unknown Yamaha SysEx type: ${e>>4}.`)}},68:(e,t,s)=>{this.#pe.run(t,s,e)},71:(e,t,s)=>{this.#ue.run(t,s,e)},126:(e,t,s)=>{this.#de.run(t,s,e)},127:(e,t,s)=>{this.switchMode("gm"),this.#fe.run(t,s,e)}};#de;#fe;#U;#Y;#ae;#he;#ue;#pe;buildRchTree(){let e=[];this.#c.forEach((t,s)=>{t<b.ch&&(e[t]?.constructor||(e[t]=[]),e[t].push(s))}),this.#me=e}buildRccMap(){let e=this;for(let t=0;t<b.ch;t++)e.#oe[t]={};e.#H.forEach((t,s)=>{t&&(e.#oe[Math.floor(s/b.redir)][t]=s%b.redir|128)}),T()&&console.debug(e.#oe)}getActive(){return this.#u}getChActive(e){return this.#u[e]}getCc(e){if(typeof e!="number"||e<0||e>=b.ch)throw new RangeError(`Invalid part number: CH${e+1}`);let t=this,s=S[e];return t.#e.subarray(s,s+b.cc)}getChCc(e,t){let s=this;if(z.indexOf(t)<0)throw new Error("CC number not accepted");return s.#e[S[e]+E[t]]}setChCc(e=0,t,s){let o=this;if(z.indexOf(t)<0)throw new Error("CC number not accepted");if(s?.constructor!==Number)throw new TypeError("Expected numbers for value");let u=s&255,p=S[e]+E[t];o.#e[p]=u,o.#e[p+b.chcc]=1,o.dispatchEvent("cc",{part:e,cc:t,data:u})}getCcAll(){return this.#e.slice()}resetCc(e){}resetChCc(e,t,s){let o=this;s?.constructor&&o.setChCc(e,t,s),o.#e[S[e]+E[t]+b.chcc]=0}resetCcAll(){}isChCcWritten(e,t){if(z.indexOf(t)<0)throw new Error("CC number not accepted");return upThis.#e[S[e]+E[t]+b.chcc]}getChSource(){return this.#c}getChType(){return this.#i}setChType(e,t,s=0,o=!1){t&=15;let u=this;s=s||u.getChModeId(e),u.#i[e]=t,t>0&&!o&&(u.setChCc(e,0,u.#a[s][2]),u.pushChPrimitives(e))}setChActive(e,t=0){this.#u[e]!==t&&this.dispatchEvent("channeltoggle",{part:e,active:t}),this.#u[e]=t}getExt(e){let t=b.ext*e,s=this.#w.subarray(t,t+b.ext),o=new Uint8Array(s.length);return o.set(s),o[1]=o[1]||this.#be,o}getPitch(){return this.#$}getProgram(){return this.#r}getTexts(){return this.#_.slice()}getVel(e){let t=new Map,s=this;return s.#h.forEach(function(o,u){let p=o>>7,m=o&127;e===p&&s.#b[o]>0&&t.set(m,{v:s.#b[o],s:s.#l[u]})}),t}getBitmap(){return{bitmap:this.#k,expire:this.#C}}getLetter(){return{text:this.#X,set:this.#se,expire:this.#te}}getMode(){return R[this.#t]}getMaster(){return{volume:this.#f}}getRawStrength(){let e=this;return this.#h.forEach(function(t){let s=t>>7;e.#b[t]>e.#O[s]&&(e.#O[s]=e.#b[t])}),this.#O}getStrength(){let e=[],t=this;return this.getRawStrength().forEach(function(s,o){e[o]=Math.floor(s*t.getChCc(o,7)*t.getChCc(o,11)*t.#f/803288)}),e}getRpn(){return this.#s}getNrpn(){return this.#Z}getSubDb(){return self?.structuredClone(this.#a)}getDetect(){return self?.structuredClone(this.#n)}getVoice(e,t,s,o="?"){let u=this;w[o]?.constructor||(o="?");let p=w[o],m=e||u.#a[p][0],y=t,r=s||u.#a[p][1];m===U.bank0&&(m=0),r===U.bank0&&(r=0),o==="ns5r"&&m>0&&m<56&&(r=3);let l=u.userBank.get(m,y,r,o);if(o==="mt32"&&l.name.indexOf("MT-m:")===0){let h=parseInt(l.name.slice(5)),a=h*b.cmt,i="";u.#K.subarray(a,a+10).forEach(c=>{c>31&&(i+=String.fromCharCode(c))});let n=`MSB	LSB	PRG	NME
49	127	${y}	${i}`;u.userBank.load(n,!0),l.name=i,l.ending=" "}return(l.ending!==" "||!l.name.length)&&(l=u.baseBank.get(m,y,r,o)),l}getChPrimitive(e,t,s){if(t>=b.vxPrim||t?.constructor!==Number)throw new RangeError(`Invalid voice primitive component "${t}"`);if(typeof e!="number"||e<0||e>=b.ch)throw new RangeError(`Invalid part number: CH${e+1}`);let o=this,u=o.#r[t<<b.chShift|e];switch(t){case 1:case 2:{s&&(u=u||o.#a[o.getChModeId(e)][t-1]),u===U.bank0&&(u=0);break}}return u}getChPrimitives(e,t){let s=this,o=new Uint8Array(3);return o[1]=s.#r[e],o[0]=s.getChPrimitive(e,1,t),o[2]=s.getChPrimitive(e,2,t),o}pushChPrimitives(e){let t=this;t.#r[1<<b.chShift|e]=t.getChCc(e,0),t.#r[2<<b.chShift|e]=t.getChCc(e,32),t.dispatchEvent("voice",{part:e})}getChCvnBuffer(e,t=b.cvn){if(t>b.cvn||t<1)throw new RangeError("Invalid custom voice name buffer length");let s=re[e];return this.#z.subarray(s,s+t)}getChCvnRegister(e,t){if(t>=b.cvn||t<0)throw new RangeError("Invalid custom voice name register");return this.#z[re[e]+t]}setChCvnRegister(e,t,s=32){if(t>=b.cvn||t<0)throw new RangeError("Invalid custom voice name register");this.#z[re[e]+t]=Math.max(32,s&255)}getChCvnString(e,t){let s=Tt.decode(this.getChCvnBuffer(e));return t||(s=s.trimEnd()),s}getChVoice(e){let t=this,s=t.getVoice(...t.getChPrimitives(e),t.getChMode(e));if(t.#L[e]){let o="";switch(t.#t){case w.mt32:{t.#A.subarray(b.cmt*(e-1),b.cmt*(e-1)+10).forEach(u=>{o+=String.fromCharCode(Math.max(u,32))}),o=o.trimEnd();break}default:o=t.getChCvnString(e)}o.length&&(s.ending="~",s.name=o)}return s}getRawPitch(){return this.#$}getPitchShift(e){let t=this,s=e*b.rpn,o=t.#s[s];return t.#o[e*b.rpnt]?o>>7&&(o-=256):t.#t===w.mt32&&(o=12),t.#$[e]/8192*o+(t.#s[s+3]-64)+((t.#s[s+1]<<7)+t.#s[s+2]-8192)/8192}getEffectType(e=0){let t=3*e+1;return this.#R.subarray(t,t+2)}getPolyState(e=0){return this.#l[e]}setEffectTypeRaw(e=0,t,s){let o=3*e;this.#R[o]=1,this.#R[o+1+ +t]=s}setEffectType(e=0,t,s){this.setEffectTypeRaw(e,!1,t),this.setEffectTypeRaw(e,!0,s)}getEffectSink(){return this.#J}setLetterDisplay(e,t,s=0,o=3200){let u=this,p;u.#X=" ".repeat(s),e.forEach(m=>{u.#X+=String.fromCharCode(m>31?m:32),m<32&&(p=p||new Set,p.add(m))}),u.#se=Date.now(),u.#te=Date.now()+o,u.dispatchEvent("letter"),p&&(p=Array.from(p),p.forEach((m,y,r)=>{r[y]=m.toString(16).padStart(2,"0")}),console.warn(`${t}${t?" ":""}invalid code point${p.length>1?"s":""}: 0x${p.join(", 0x")}`))}setDetectionTargets(e="?",t=0){let s=this,o=-1;switch(e.replaceAll(", ",",").split(",").forEach(u=>{u=u.toLowerCase();let p=R.indexOf(yt[u]||u);T()&&console.debug(`Mapped mode "${u}" to ID "${p}".`),p>-1&&(o=p)}),T()&&console.debug(`Set detection target to ID "${o}".`),o>0&&(s.#n.x5=82,s.#n.ds=w.krs),o){case w["05rw"]:{s.#n.x5=81;break}case w.s90es:s.#n.ds=w.s90es,s.#n.smotif=w.s90es;case w.motif:s.#n.ds=w.motif,s.#n.smotif=w.motif}}setGsTargets(e=!1,t=4){if(!t)t=e?3:4;else{if(t>4||t<0)throw new Error(`Invalid GS level ${t}`);if(e&&t>>1!==1)throw new Error(`Invalid SC level ${t}`)}let s=this;s.#n[e?"sc":"gs"]=t,s.#a[w[e?"sc":"gs"]][1]=t,s.forceVoiceRefresh()}getConfigs(){return this.#v}setDumpLimit(e){if(e>2||e<0)throw new RangeError("Invalid dump limit.");this.#d.dumpLimit=e}allocateAce(e=0,t){let s=this;if(!t||t<128&&t>95){console.warn(`cc${t} cannot be allocated as an active custom effect.`);return}let o=!0,u=0,p=b.ace*e;for(;o&&u<b.ace;)s.#m[u+p]===t?o=!1:s.#m[u+p]||(o=!1,s.#m[u+p]=t,console.debug(`Allocated cc${t} to ACE slot ${u} in CH${e+1}.`)),u++;u>=b.ace&&console.warn(`ACE slots are full in CH${e+1}.`)}allocateAceAll(e){let t=this;if(!e||e<128&&e>95){console.warn(`cc${e} cannot be allocated as an active custom effect.`);return}for(let s=0;s<b.ch;s++){let o=!0,u=0,p=b.ace*s;for(;o&&u<b.ace;)t.#m[u+p]===e?o=!1:t.#m[u+p]||(o=!1,t.#m[u+p]=e),u++;u>=b.ace&&console.warn(`ACE slots are full in CH${s+1}.`)}}resetAce(){this.#m.fill(0),console.info("All ACE slots have been reset.")}resetChAceAll(e=0){this.#m.subarray(ae[e],ae[e]+b.ace).fill(0)}resetChAce(e=0,t){let s=!0,o=ae[e],u=o+b.ace;for(;s&&o<u;)this.#m[o]===t&&(this.#m[o]=0,s=!1),o++;s&&T()&&console.debug(`No ACE slot was allocated to cc${t} in CH${e+1}.`)}getAce(){return this.#m}getChAce(e=0,t=0){if(t<0||t>=b.ace)throw new RangeError("No such ACE slot");let s=this.#m[b.ace*e+t];if(s){if(z.indexOf(s)>=0)return this.getChCc(e,s);throw new Error(`Invalid ACE source in CH${e+1}: ${s}`)}else return 0}initDrums(){let e=this;e.#P.fill(64);for(let t=0;t<b.drm;t++){let s=t*b.dpn;for(let o in Ke){let u=Ke[o],p=(s+O[o])*b.dnc;e.#P.subarray(p,p+b.dnc).fill(u)}}}init(e=0){let t=this;t.#W=0,t.#a[w.xg][1]=0,t.dispatchEvent("banklevel",{mode:"xg",data:0}),t.#u.fill(0),t.#e.fill(0),t.#m.fill(0),t.#r.fill(0),t.#b.fill(0),t.#h.fill(0),t.#l.fill(0),t.#g.fill(0),t.#O.fill(0),t.#$.fill(0),t.#Z.fill(0),t.#o.fill(0),t.#w.fill(0),t.#x.fill(0),t.#G.fill(0),t.#y.fill(0),t.#H.fill(0),t.#f=100,t.#_=[],t.#F=500,t.#j=0,t.#ee=0,t.#re=!1,t.#C=0,t.#p=0,t.#k.fill(0),t.#E=t.KARAOKE_NONE,t.#q=0,t.#V=!0,t.#T=!1,t.initDrums(),t.polyIndexLatest=0,t.polyIndexLast=0,t.#c.forEach(function(s,o,u){u[o]=o}),e===0&&(t.dispatchEvent("mode","?"),t.#t=0,t.#ie.fill(0),t.#ne.fill(0),t.#te=0,t.#X=""),vt.forEach(s=>{t.setChCc(s,0,t.#a[t.getChModeId(s)][2])}),t.#i.fill(t.CH_MELODIC),t.#i[9]=t.CH_DRUM1,t.#i[25]=t.CH_DRUM3,t.#i[41]=t.CH_DRUMS,t.#i[57]=t.CH_DRUMS,t.#i[73]=t.CH_DRUM5,t.#i[89]=t.CH_DRUM7,t.#i[105]=t.CH_DRUMS,t.#i[121]=t.CH_DRUMS;for(let s=0;s<b.drm;s++)t.#B[s<<1]=0,t.#B[s<<1|1]=b.invalidCh;t.#M.fill(0),t.#K.fill(0),t.#I.fill(0),t.#A.fill(0),t.#L.fill(0),t.#z.fill(32),t.#R.fill(0),t.#J.fill(0),t.aiEfxName="",t.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),t.modelEx.sc.showBar=!0,t.modelEx.sc.invBar=!1,t.modelEx.sc.invDisp=!1,t.modelEx.sc.peakHold=1;for(let s=0;s<b.ch;s++){let o=S[s];t.#e[o+E[7]]=100,t.#e[o+E[11]]=127,t.#e[o+E[2]]=127,t.#e[o+E[10]]=64,t.#e.subarray(o+E[71],o+E[71]+8).fill(64),t.#e[o+E[128]]=127,t.#e.subarray(o+E[130],o+E[157]+1).fill(64),t.#e[o+E[91]]=40,t.#e[o+E[101]]=127,t.#e[o+E[100]]=127,t.#e[o+E[99]]=127,t.#e[o+E[98]]=127;let u=s*b.rpn;t.#s[u]=2,t.#s[u+1]=64,t.#s[u+2]=0,t.#s[u+3]=64,t.#s[u+4]=0,t.#s[u+5]=0;let p=s*b.ext;t.#w[p+1]=t.VLBC_BRTHEXPR;let m=s*b.redir;t.#H[m+8]=13}t.buildRchTree(),t.buildRccMap(),t.dispatchEvent("mastervolume",t.#f),t.dispatchEvent("efxreverb",t.getEffectType(0)),t.dispatchEvent("efxchorus",t.getEffectType(1)),t.dispatchEvent("efxdelay",t.getEffectType(2)),t.dispatchEvent("efxinsert0",t.getEffectType(3)),t.dispatchEvent("efxinsert1",t.getEffectType(4)),t.dispatchEvent("efxinsert2",t.getEffectType(5)),t.dispatchEvent("efxinsert3",t.getEffectType(6)),t.dispatchEvent("reset"),t.switchMode("?")}setChMode(e,t){let s=this;if(typeof e!="number"||e<0||e>=b.ch)throw new RangeError(`Invalid part number: CH${e+1}`);if(port<0||t>=R.length)throw new RangeError(`Invalid mode ID ${t}`);s.#y[e]=t,s.dispatchEvent("chmode",{part:e,id:t,mode:R[t]}),s.dispatchEvent("voice",{part:e})}getChMode(e,t){return R[this.getChModeId(e,t)]}getChModeId(e,t){return t?this.#y[e]||this.#x[e>>4]:this.#y[e]||this.#x[e>>4]||this.#t}setPortMode(e,t,s){let o=this;if(e<0||e>=b.ch>>4)throw new RangeError(`Invalid port ${e+1}`);if(t<1)throw new RangeError("Range must be a positive integer");if(e+t>=b.ch>>4)throw new RangeError("Range must be in bound");if(e<0||s>=R.length)throw new RangeError(`Invalid mode ID ${s}`);o.#G[e]=s;for(let u=e;u<e+t;u++){let p=o.#G[u];if(t>1&&p!==0&&p!==s)break;o.#x[u]=s;for(let m=u<<4;m<u+1<<4;m++)o.dispatchEvent("chmode",{part:m,id:s,mode:R[s]}),o.dispatchEvent("voice",{part:m})}}copyChSetup(e,t,s){if(e===t){console.warn(`Failed attempt at overwriting CH${e+1} with its own data.`);return}let o=this;if(s&&o.#u[t]){console.warn(`Failed attempt at copying setup data from CH${e+1} to CH${t+1}.`);return}let u=S[e],p=S[t];o.#r[t]=o.#r[e],o.#e.set(o.#e.subarray(u,u+b.cc),p),o.pushChPrimitives(t)}setDrumFirstWrite(e,t){let s=this,o=s.#i[e];if(o<2)return;let u=o-2;if(s.#B[u<<1])if(t)s.#B[u<<1]=0,T()&&console.debug(`First write part for drum set ${u+1} has been reset.`);else return;else t?console.warn(`First write part for drum set ${u+1} is already blank.`):(s.#B[u<<1]=1,s.#B[u<<1|1]=e,console.debug(`First write part for drum set ${u+1} is set to CH${e+1}.`))}getChDrumFirstWrite(e){let t=this,s=t.#i[e];if(s<2)return;let o=s-2;return t.#B.subarray(o<<1,o+1<<1)}getDrumFirstWrite(e){if(e>=0&&e<b.drm)return this.#B.subarray(e<<1,e+1<<1)}switchMode(e,t=!1,s=!1){let o=this,u=w[e];if(u>-1){if(o.#t===0||t){o.initOnReset&&t&&this.init(1),o.#t=u,o.#p=0;for(let m=0;m<b.ch;m++){let y=o.getChModeId(m,!0);o.#i[m]>0&&y===w["?"]&&(o.setChCc(m,0,o.#a[u][2]),T()&&console.debug(`CH${m+1} (${o.#i[m]}) (${o.getChMode(m)}), ${R[y]} (${o.#a[y][2]}) -> ${R[u]} (${o.#a[u][2]})`),o.pushChPrimitives(m))}switch(u){case w.mt32:{ue.forEach((m,y)=>{let r=y+1;o.#u[r]||(o.#r[r]=m,o.setChCc(r,91,127),o.pushChPrimitives(r))});for(let m=1;m<10;m++)o.dispatchEvent("voice",{part:m});break}}let p;switch(u){case w["?"]:case w.g2:{p=[52,4,52,18,0,255,0,255];break}case w.xg:{p=[1,0,65,0,5,0,64,0];break}case w.gm:case w.gs:case w.sc:{p=[40,4,40,18,40,32,32,0];break}case w.sd:{p=[58,0,60,0,61,0,61,0];break}case w["05rw"]:case w.x5d:case w.ns5r:{p=[44,1,44,19,0,255,0,255];break}case w.k11:case w.sg:{p=[24,0,0,255,0,255,0,255];break}case w.mt32:{p=[40,4,0,255,0,255,0,255];break}case w.doc:{p=[24,16,0,255,0,255,0,255];break}case w.motif:case w.s90es:case w.cs6x:{p=[129,0,133,0,130,0,0,0];break}default:p=[0,0,0,0,0,0,0,0]}for(let m=0;m<b.efx;m++)!o.#R[3*m]&&p[m<<1]?.constructor&&(o.#R[3*m+1]=p[2*m],o.#R[3*m+2]=p[2*m+1],o.dispatchEvent(`efx${["reverb","chorus","delay","insert0"][m]}`,o.getEffectType(m)));s&&o.setDetectionTargets(e),o.dispatchEvent("mode",e),o.forceVoiceRefresh()}}else throw new Error(`Unknown mode ${e}`)}newStrength(){this.#O.fill(0)}runJson(e){if(e.type>14)return e.type===15&&e.data.constructor!==Uint8Array&&(e.data=Uint8Array.from(e.data)),this.#ge[e.type].call(this,e);{let t=this.chRedir(e.part,e.track),s=!1;this.#me[t]?.forEach(o=>{e.channel=o,s=!0,this.#ge[e.type].call(this,e)}),s||console.warn(`${_e[e.type]?_e[e.type]:e.type}${[11,12].includes(e.type)?(e.data[0]!==void 0?e.data[0]:e.data).toString():""} event sent to CH${t+1} without any recipient.`)}this.#_.length>100&&this.#_.splice(100,this.#_.length-99)}runRaw(e){}async loadBank(e,t){let s=this;switch(e=e.toLowerCase(),e){case"s7e":{s.userBank.clearRange({msb:63,lsb:[21,22]}),s.userBank.clearRange({msb:63,lsb:[24,27]});break}case"pcg":{s.userBank.clearRange({msb:63,lsb:[6,9]}),s.userBank.clearRange({msb:63,lsb:[13,16]});break}default:throw new Error(`Unknown bank format ${e}`)}switch(e){case"s7e":case"pcg":{q.context=this,await s.userBank.load(await q.read(e,t),!1);break}}s.forceVoiceRefresh()}constructor(){super();let e=this;e.#k=new Uint8Array(256),e.#S[10]=new Uint8Array(512),e.#le=new I,e.#n={x5:82,ds:w.krs,smotif:w.s90es,gs:4,sc:3},e.#d={dumpLimit:e.DUMP_MODE},e.#v=new Proxy(e.#d,{set:()=>{}});for(let r in Xe){let l=w[r];l===void 0?console.debug(`SubDB build error: "${r}" does not exist`):e.#a[l]=new Uint8Array(Xe[r])}e.userBank.strictMode=!0,e.userBank.load(`MSB	PRG	LSB	NME
062	000	000	
122	000	000	
122	001	000	
122	002	000	
122	003	000	
122	004	000	
122	005	000	
122	006	000	`),e.addEventListener("metacommit",function(r){let{data:l}=r;e.#_[0]?.type===l.type&&e.#_[0]?.amend?(e.#_[0].amend=l.amend,e.#_[0].data+=l.data):e.#_.unshift(l)}),e.#N[1]=function(r){switch(r=r.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),r.substring(0,2)){case"@I":{e.#E=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"Kar.Info",data:r.substring(2)?.trimLeft()});break}case"@K":{e.#E=e.KARAOKE_TEXT;let l=r.substring(2);l!=="MIDI KARAOKE FILE"&&e.dispatchEvent("metacommit",{type:"Kar.Mode",data:l?.trimLeft()}),console.debug(`Karaoke mode active: ${l}`);break}case"@L":{e.#E=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"Kar.Lang",data:r.substring(2)?.trimLeft()});break}case"@T":{e.#E=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"KarTitle",data:r.substring(2)?.trimLeft()});break}case"@V":{e.#E=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"Kar.Ver.",data:r.substring(2)?.trimLeft()});break}case"XF":{let l=r.slice(2).split(":");switch(l[0]){case"hd":{l.slice(1).forEach((h,a)=>{h.length&&e.dispatchEvent("metacommit",{type:["XfSngDte","XfSngRgn","XfSngCat","XfSongBt","XfSngIns","XfSngVoc","XfSngCmp","XfSngLrc","XfSngArr","XfSngPer","XfSngPrg","XfSngTag"][a],data:h})});break}case"ln":{l.slice(1).forEach((h,a)=>{h.length&&e.dispatchEvent("metacommit",{type:["XfKarLng","XfKarNme","XfKarCmp","XfKarLrc","XfKarArr","XfKarPer","XfKarPrg"][a],data:h})});break}default:e.dispatchEvent("metacommit",{type:"XfUnData",data:r})}break}default:switch(e.#E){case e.KARAOKE_TEXT:{switch(r[0]){case"\\":{e.dispatchEvent("metacommit",{type:"KarLyric",data:"",amend:!1}),e.dispatchEvent("metacommit",{type:"KarLyric",data:r.substring(1),amend:!0});break}case"/":{e.dispatchEvent("metacommit",{type:"KarLyric",data:"",mask:!0,amend:!1}),e.dispatchEvent("metacommit",{type:"KarLyric",data:r.substring(1),mask:!0,amend:!0});break}default:e.dispatchEvent("metacommit",{type:"KarLyric",data:r,amend:!0})}break}default:r.split(`
`).forEach((l,h)=>{e.dispatchEvent("metacommit",{type:"Cmn.Text",data:l,mask:h!==0})})}}},e.#N[2]=function(r){e.dispatchEvent("metacommit",{type:"Copyrite",data:r})},e.#N[3]=function(r,l){l<1&&e.#W<1&&e.dispatchEvent("metacommit",{type:"TrkTitle",data:r})},e.#N[4]=function(r,l){e.dispatchEvent("metacommit",{type:"Instrmnt",data:r})},e.#N[5]=function(r){switch(e.#E){case e.KARAOKE_XF:{let l="";for(let h of r)switch(h){case"^":case"%":{l+=" ";break}case">":{l+="	";break}case"<":{e.dispatchEvent("metacommit",{type:"KarLyric",data:l,mask:e.#T,amend:!1}),l="",e.#T=!1;break}case"/":{e.dispatchEvent("metacommit",{type:"KarLyric",data:l,mask:!1,amend:!1}),l="",e.#T=!0;break}default:l+=h}l.length>0&&(e.dispatchEvent("metacommit",{type:"KarLyric",data:l,mask:e.#T,amend:!0}),e.#T=!1);break}default:{let l=0,h=!0,a=r.length-1;for(;h&&l<8;)switch(r.charCodeAt(l)){case 32:{l++;break}default:h=!1}switch(l>0&&(e.dispatchEvent("metacommit",{type:"C.Lyrics",data:r.substring(0,l),amend:!0,mask:e.#T,untimed:!0}),e.#T=!1),r.charCodeAt(a)){case 10:{e.dispatchEvent("metacommit",{type:"C.Lyrics",data:r.substring(l,a),amend:!1,mask:e.#T}),e.#T=!1;break}case 11:case 13:{e.dispatchEvent("metacommit",{type:"C.Lyrics",data:r.substring(l,a),amend:!1,mask:e.#T}),e.#T=!0;break}case 32:{e.dispatchEvent("metacommit",{type:"C.Lyrics",data:r.substring(l,a),amend:!0,mask:e.#T}),e.dispatchEvent("metacommit",{type:"C.Lyrics",data:" ",amend:!0,mask:!1,untimed:!0}),e.#T=!1;break}default:r.trim()===""?console.info("Blank line? Shouldn't happen."):e.dispatchEvent("metacommit",{type:"C.Lyrics",data:r,amend:!0,mask:e.#T}),e.#T=!1}break}}},e.#N[6]=function(r){e.dispatchEvent("metacommit",{type:"C.Marker",data:r})},e.#N[7]=function(r){switch(r[0]){case"$":{if(r.substring(1,5)==="Lyrc"){e.#E=e.KARAOKE_XF;let l=r.substring(6).split(":"),h=l[0].replaceAll(" ","").split(",");h.forEach((i,n,c)=>{c[n]=parseInt(i)-1});let a=Oe[l[2].substring(0,2).toLowerCase()];e.dispatchEvent("metacommit",{type:"XfMeloCh",data:`CH${l[0].replaceAll(" ","").split(",").join(", CH")}`,parsed:h}),e.dispatchEvent("metacommit",{type:"XfLyrOff",data:l[1],parsed:parseInt(l[1])}),e.dispatchEvent("metacommit",{type:"XfLyrEnc",data:a[1],parsed:a[0]}),e.#T=!1}else e.dispatchEvent("metacommit",{type:"CuePoint",data:r});break}case"#":{e.dispatchEvent("metacommit",{type:"XfScneNo",data:r.substring(1)});break}case"&":{r.length===2?(e.dispatchEvent("metacommit",{type:"XfSngPrt",data:Ie[r[1]]||`Unknown "${r[1]}"`}),e.#T=!1):e.dispatchEvent("metacommit",{type:"CuePoint",data:r});break}default:e.dispatchEvent("metacommit",{type:"CuePoint",data:r})}},e.#N[32]=function(r){e.#W=r[0]+1},e.#N[33]=function(r,l){T()&&console.debug(`Track ${l} requests getting assigned to port ${r}.`),e.#ne[l]=r+1},e.#N[81]=function(r,l){e.#F=r/1e3},e.#N[127]=function(r,l){e.#le.run(r,l)},e.#le.default=function(r){let l=[];for(let h=0;h<8&&h<r.length;h++)l.push(r[h].toString(16).padStart(2,"0").toUpperCase());console.warn(`Unrecognized implementation-specific byte sequence: ${l.join(" ")}${r.length>8?" ...":""}
%o`,r)},e.#le.add([67,0,1],(r,l)=>{T()&&console.debug(`XGworks port assign requests assigning track ${l} to port ${r[0]}.`),e.#ne[l]=r[0]+1}).add([67,123,1],(r,l)=>{let h=[];for(let a=0;a<r.length;a+=2){let i=r[a]>>4,n=r[a]&15;if(i<7&&n&&n<8){let c=new Uint8Array(5);c[0]=n-1,c[1]=i-3<<2,c[2]=r[a|1],h.push(c)}}e.dispatchEvent("metacommit",{type:"ChordCtl",src:"yxf",data:h}),console.debug("Yamaha XF chord data: %o",h)}).add([67,123,2],(r,l)=>{let h=new Uint8Array(2);h[0]=r[0]&15,h[1]=r[0]>>4,e.dispatchEvent("metacommit",{type:"RhrslMrk",src:"yxf",data:h}),console.debug(`Yamaha XF rehearsal mark: ${["Intro","Ending","Fill-in"][h[0]]??String.fromCharCode(62+h[0])}${"'".repeat(h[1])} %o`,h)}).add([67,123,96],(r,l)=>{let h=[0,0];r.subarray(1,3).forEach(a=>{h[0]=h[0]<<7,h[0]|=a&127}),r.subarray(3,5).forEach(a=>{h[1]=h[1]<<7,h[1]|=a&127}),e.dispatchEvent("metacommit",{type:"YStyleId",data:h}),console.debug(`Yamaha style ID: model ${h[0].toString(16)}, style ${h[1]+1}`)}),e.#de=new I("universal non-realtime"),e.#fe=new I("universal realtime"),e.#U=new I("Yamaha"),e.#Y=new I("Roland"),e.#ae=new I("Korg"),e.#he=new I("Kawai"),e.#ue=new I("Akai"),e.#pe=new I("Casio");let t=new I("DX7+ Dump"),s=function(r){let l=[];for(let h=0;h<8&&h<r.length;h++)l.push(r[h].toString(16).padStart(2,"0").toUpperCase());console.info(`Unrecognized SysEx in "${this.name}" set: ${l.join(" ")}${r.length>8?" ...":""}
%o`,r)};e.#de.default=s,e.#fe.default=s,e.#U.default=s,e.#Y.default=s,e.#ae.default=s,e.#he.default=s,e.#ue.default=s,e.#pe.default=s,t.default=s,e.#de.add([9],(r,l,h)=>{e.switchMode(["gm","?","g2"][r[0]-1],!0),e.setPortMode(e.getTrackPort(l),1,w[["gm","?","g2"][r[0]-1]]),e.#E=e.#E||e.KARAOKE_NONE,console.info(`MIDI reset: ${["GM","Init","GM2"][r[0]-1]}`),r[0]===2&&e.init()}),e.#fe.add([4,1],(r,l,h)=>{e.dispatchEvent("mupromptex"),e.#f=((r[1]<<7)+r[0])/16383*100,e.dispatchEvent("mastervolume",e.#f)}).add([4,3],(r,l,h)=>((r[1]<<7)+r[0]-8192)/8192).add([4,4],(r,l,h)=>r[1]-64).add([4,5],(r,l,h)=>{e.dispatchEvent("mupromptex");let a=r[0],i=r[1],n=r[2],c=3,d=c+(a<<1),f=d+i;if(a!==1){console.error(`Unsupported GM2 global parameter set: slotpath length too long (${a})!
`,r);return}let g=0,v=0,C=0;switch(r.subarray(c,d).forEach($=>{g=g<<7,g|=$}),r.subarray(d,f).forEach(($,x)=>{v|=$<<x*7}),r.subarray(f).forEach(($,x)=>{C|=$<<x*7}),T()&&console.debug(`GM2 global parameter: (${r.subarray(3,d)}; p: ${v}, v: ${C})`),g){case 129:{v===0&&(e.setEffectType(0,52,C),e.dispatchEvent("efxreverb",e.getEffectType(0)));break}case 130:{v===0&&(e.setEffectType(1,52,C|16),e.dispatchEvent("efxchorus",e.getEffectType(1)));break}default:T()&&console.debug("GM2 global paramater slot path unknown.")}}),this.#U.add([76,0,0],(r,l,h)=>{switch(r[0]){case 125:{e.initDrums(),console.info(`XG drum setup reset on drum kit ${r[1]}.`);break}case 126:{e.switchMode("xg",!0),e.setPortMode(e.getTrackPort(l),4,w.xg),e.#E=e.#E||e.KARAOKE_NONE,console.info("MIDI reset: XG");break}default:{e.dispatchEvent("mupromptex");let a=[0,0,0,0],i=(n,c)=>{a[c]=n};if(r.subarray(1).forEach((n,c)=>{let d=c+r[0];([i,i,i,i,f=>{this.#f=f*129/16383*100,e.dispatchEvent("mastervolume",e.#f)},f=>{},f=>{}][d]||(()=>{}))(n,c)}),r[0]<4){let n=0;a.forEach(c=>{n=n<<4,n+=c}),n-=1024,console.debug(`Master tune: ${n}`)}}}}).add([76,2,1],(r,l,h)=>{e.dispatchEvent("mupromptex");let a="XG ";r[0]<32?(a+="reverb ",r.subarray(1).forEach((i,n)=>{([c=>{e.setEffectTypeRaw(0,!1,c),console.info(`${a}main type: ${Q[c]}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},c=>{e.setEffectTypeRaw(0,!0,c),console.debug(`${a}sub type: ${c+1}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},c=>{console.debug(`${a}time: ${Re(c)}s`)},c=>{console.debug(`${a}diffusion: ${c}`)},c=>{console.debug(`${a}initial delay: ${c}`)},c=>{console.debug(`${a}HPF cutoff: ${F[c]}Hz`)},c=>{console.debug(`${a}LPF cutoff: ${F[c]}Hz`)},c=>{console.debug(`${a}width: ${c}`)},c=>{console.debug(`${a}height: ${c}`)},c=>{console.debug(`${a}depth: ${c}`)},c=>{console.debug(`${a}wall type: ${c}`)},c=>{console.debug(`${a}dry/wet: ${c}`)},c=>{console.debug(`${a}send: ${L(c)}dB`)},c=>{console.debug(`${a}pan: ${c-64}`)},!1,!1,c=>{console.debug(`${a}delay: ${c}`)},c=>{console.debug(`${a}density: ${c}`)},c=>{console.debug(`${a}balance: ${c}`)},c=>{},c=>{console.debug(`${a}feedback: ${c}`)},c=>{}][r[0]+n]||function(){console.warn(`Unknown XG reverb address: ${r[0]}.`)})(i)})):r[0]<64?(a+="chorus ",r.subarray(1).forEach((i,n)=>{([c=>{e.setEffectTypeRaw(1,!1,c),console.info(`${a}main type: ${Q[c]}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},c=>{e.setEffectTypeRaw(1,!0,c),console.debug(`${a}sub type: ${c+1}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},c=>{console.debug(`${a}LFO: ${Me[c]}Hz`)},c=>{},c=>{console.debug(`${a}feedback: ${c}`)},c=>{console.debug(`${a}delay offset: ${Pe(c)}ms`)},c=>{},c=>{console.debug(`${a}low: ${F[c]}Hz`)},c=>{console.debug(`${a}low: ${c-64}dB`)},c=>{console.debug(`${a}high: ${F[c]}Hz`)},c=>{console.debug(`${a}high: ${c-64}dB`)},c=>{console.debug(`${a}dry/wet: ${c}`)},c=>{console.debug(`${a}send: ${L(c)}dB`)},c=>{console.debug(`${a}pan: ${c-64}`)},c=>{console.debug(`${a}to reverb: ${L(c)}dB`)},!1,c=>{},c=>{},c=>{},c=>{console.debug(`${a}LFO phase diff: ${(c-64)*3}deg`)},c=>{console.debug(`${a}input mode: ${c?"stereo":"mono"}`)},c=>{}][r[0]-32+n]||function(){console.warn(`Unknown XG chorus address: ${r[0]}.`)})(i)})):r[0]<86?(a+="variation ",r.subarray(1).forEach((i,n)=>{([c=>{e.setEffectTypeRaw(2,!1,c),console.info(`${a}main type: ${Q[c]}`),e.dispatchEvent("efxdelay",e.getEffectType(2))},c=>{e.setEffectTypeRaw(2,!0,c),console.debug(`${a}sub type: ${c+1}`),e.dispatchEvent("efxdelay",e.getEffectType(2))}][r[0]-64+n]||function(){})(i)})):r[0]<97?(a+="variation ",r.subarray(1).forEach((i,n)=>{[c=>{console.debug(`${a}send: ${L(c)}dB`)},c=>{console.debug(`${a}pan: ${c-64}`)},c=>{console.debug(`${a}to reverb: ${L(c)}dB`)},c=>{console.debug(`${a}to chorus: ${L(c)}dB`)},c=>{console.debug(`${a}connection: ${c?"system":"insertion"}`)},c=>{console.debug(`${a}channel: CH${c+1}`)},c=>{console.debug(`${a}mod wheel: ${c-64}`)},c=>{console.debug(`${a}bend wheel: ${c-64}`)},c=>{console.debug(`${a}channel after touch: ${c-64}`)},c=>{console.debug(`${a}AC1: ${c-64}`)},c=>{console.debug(`${a}AC2: ${c-64}`)}][r[0]-86+n](i)})):r[0]>111&&r[0]<118?a+="variation ":console.warn(`Unknown XG variation address: ${r[0]}`)}).add([76,2,64],(r,l,h)=>{r.subarray(1).forEach((a,i)=>{let n=i+r[0];if(n===0)console.debug(`XG EQ preset: ${["flat","jazz","pop","rock","classic"][a]}`);else{let c=n-1>>2,d=n-1&3,f=`XG EQ ${c} ${["gain","freq","Q","shape"][d]}: `;[()=>{console.debug(`${f}${a-64}dB`)},()=>{console.debug(`${f}${a} (raw)`)},()=>{console.debug(`${f}${a/10}`)},()=>{console.debug(`${f}${["shelf","peak"][+!!a]}`)}][d]()}})}).add([76,3],(r,l,h)=>{e.dispatchEvent("mupromptex");let a=r[0],i=r[1],n=`XG Insertion ${r[0]+1} `;r.subarray(2).forEach((c,d)=>{([f=>{e.setEffectTypeRaw(3+a,!1,f),console.info(`${n}main type: ${Q[f]}`),e.dispatchEvent(`efxinsert${a}`,e.getEffectType(3+a))},f=>{e.setEffectTypeRaw(3+a,!0,f),console.debug(`${n}sub type: ${f+1}`),e.dispatchEvent(`efxinsert${a}`,e.getEffectType(3+a))}][i+d]||function(){})(c)})}).add([76,6,0],(r,l,h)=>{let a=r[0];a<64?e.setLetterDisplay(r.subarray(1),"XG letter display",a):e.#te=Date.now()}).add([76,7,0],(r,l,h)=>{let a=r[0];e.#p=0,e.#C=Date.now()+3200,e.#k.fill(0);let i=r.subarray(1);for(let n=0;n<a;n++)i.unshift(0);i.forEach(function(n,c){let d=Math.floor(c/16),f=c%16,g=(f*3+d)*7,v=7,C=0;for(g-=f*5,d===2&&(v=2);C<v;)e.#k[g+C]=n>>6-C&1,C++})}).add([76,8],(r,l)=>{e.dispatchEvent("mupromptex");let h=e.chRedir(r[0],l,!0),a=r[1],i=S[h],n=`XG CH${h+1} `,c=`Unknown XG part address ${a}.`,d=!0;r.subarray(2).forEach((f,g)=>{d=!0,a<1?console.debug(c):a<41?([()=>{e.setChCc(h,0,f),e.pushChPrimitives(h),e.dispatchEvent("voice",{part:h})},()=>{e.setChCc(h,32,f),e.pushChPrimitives(h),e.dispatchEvent("voice",{part:h})},()=>{e.#r[h]=f,e.dispatchEvent("voice",{part:h})},()=>{d=!1;let v=e.chRedir(f,l,!0),C=e.#c[h];e.#c[h]=v,(h!==v||v!==C)&&(e.buildRchTree(),console.info(`${n}receives from CH${v+1}`)),e.#u[h]||(e.copyChSetup(v,h,!0),console.debug(`${n}copied from CH${v+1}.`),e.setChActive(h,1),e.dispatchEvent("voice",{part:h}))},()=>{e.#g[h]=+!f},()=>{},()=>{d=!1,e.setChType(h,f,w.xg),console.debug(`${n}type: ${Z[f]||f}`),e.dispatchEvent("voice",{part:h})},()=>{e.#s[b.rpn*h+3]=f,e.#o[b.rpnt*h+2]=1,e.dispatchEvent("pitch",{part:h,pitch:e.getPitchShift(h)})},!1,!1,()=>{e.setChCc(h,7,f)},!1,!1,()=>{e.setChCc(h,10,f||128)},!1,!1,()=>{e.setChCc(h,128,f),e.allocateAce(h,128)},()=>{e.setChCc(h,93,f)},()=>{e.setChCc(h,91,f)},()=>{e.setChCc(h,94,f)},()=>{e.setChCc(h,76,f)},()=>{e.setChCc(h,77,f)},()=>{e.setChCc(h,78,f)},()=>{e.setChCc(h,74,f)},()=>{e.setChCc(h,71,f)},()=>{e.setChCc(h,73,f)},()=>{e.setChCc(h,75,f)},()=>{e.setChCc(h,72,f)}][a+g-1]||(()=>{}))():a<48?console.debug(c):a<111?a>102&&a<105&&e.setChCc(h,[5,65][a&1],f):a<114?console.debug(c):a<116?console.debug(`${n}EQ ${["bass","treble"][a&1]} gain: ${f-64}dB`):a<118?console.debug(c):a<120?console.debug(`${n}EQ ${["bass","treble"][a&1]} freq: ${f}`):console.debug(c)}),d&&e.#i[h]>1&&e.setDrumFirstWrite(h)}).add([76,9],(r,l)=>{let h=e.chRedir(r[0],l,!0),a=r[1],i=S[h],n=`PLG-VL CH${h+1} `;r.subarray(2).forEach((c,d)=>{let f=d+a;switch(f){case 1:{console.info(`${n}breath mode: ${["system","breath","velocity","touch EG"][c]}`);break}case 0:case 27:case 28:break;default:if(f<27){let g=f-3>>1,v=["pressure","embouchure","tonguing","scream","breath noise","growl","throat formant","harmonic enhancer","damping","absorption","amplification","brightness"][g];f&1?f<23?(console.debug(`${n}${v} control source: ${Le(c)}`),c&&c<96&&e.allocateAce(h,130+g),e.#H[b.redir*h+g+2]=c,e.buildRccMap()):console.debug(`${n}${v} scale break point: ${c}`):(console.debug(`${n}${v} depth: ${c-64}`),e.setChCc(h,130+g,c))}}})}).add([76,10],(r,l,h)=>{}).add([76,16],(r,l,h)=>{}).add([76,17,0,0],(r,l,h)=>{}).add([76,112],(r,l,h)=>{switch(console.debug(`XG enable PLG-${["VL","SG","DX","AN","PF","DR","PC","AP"][r[0]]} for CH${r[2]+1}.`),r[0]){case 0:{e.#w[b.ext*r[2]]=e.EXT_VL;break}case 2:{e.#w[b.ext*r[2]]=e.EXT_DX;break}default:e.#w[b.ext*r[2]]=e.EXT_NONE}}).add([73,0,0],(r,l)=>{let h=r[0],a="MU1000 System - ";r.subarray(1).forEach((i,n)=>{let c=h+n;c===8?console.debug(`${a}LCD contrast: ${i}.`):c===18?(e.#a[w.xg][1]=i?126:0,console.debug(`${a}default bank: ${i?"MU100 Native":"MU Basic"}.`),e.dispatchEvent("banklevel",{mode:"xg",data:+!!i}),e.forceVoiceRefresh()):c>=64&&c<69&&[()=>{e.dispatchEvent("channelactive",i)},()=>{i<8?(e.dispatchEvent("channelmin",i<<4),console.debug(`Octavia System: Minimum CH${(i<<4)+1}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{i<8?(e.dispatchEvent("channelmax",(i<<4)+15),console.debug(`Octavia System: Maximum CH${(i<<4)+16}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges")},()=>{e.#V=!!i,console.info(`Octavia System: RS receiving ${["dis","en"][i]}abled.`)}][c-64]()})}).add([73,10,0],(r,l)=>{let h=r[0],a=`MU1000 RS${e.#V?"":" (ignored)"}: `;if(h<16)switch(h){case 2:{let i=e.chRedir(0,l,!0);e.#V&&(e.dispatchEvent("portrange",4),e.dispatchEvent("portstart",i)),console.info(`${a}Show CH${i+1}~CH${i+64}`);break}case 3:{let i=e.chRedir(r[1]<<5,l,!0);e.#V&&(e.dispatchEvent("portrange",2),e.dispatchEvent("portstart",i)),console.info(`${a}Show CH${i+1}~CH${i+32}`);break}default:console.debug(`${a}unknown switch ${h} invoked.`)}else if(h<32){if(e.#V){let i=e.chRedir(h-16+(e.#q<<4),l,!0);e.dispatchEvent("channelactive",i)}}else if(h<36){let i=e.chRedir(h-32<<4,l,!0);e.#V&&(e.dispatchEvent("portrange",1),e.dispatchEvent("portstart",i>>4),e.#q=h-32),console.info(`${a}Show CH${i+1}~CH${i+16}`)}}).add([73,11,0],(r,l)=>{let h="MU1000 System - channel ",a="Octavia System - channel ",i=r[0];r.subarray(1).forEach((n,c)=>{let d=i+c;([()=>{e.setChActive(n,1),e.dispatchEvent("channelactive",n),T()&&console.debug(`${h}current part: CH${n+1}`)},()=>{n<5?(e.dispatchEvent("portrange",1<<n),console.debug(`${h}port range: ${1<<n} port(s)`)):(e.dispatchEvent("portrange",0),console.debug(`${h}port range: reset`))},()=>{n<16?(e.dispatchEvent("portstart",n),console.debug(`${a}start port: ${"ABCDEFGHIJKLMNOP"[n]}`)):(e.dispatchEvent("portstart",255),console.debug(`${a}start port: reset`))}][d]||(()=>{console.debug(`${h}unknown address: ${d}`)}))()})}).add([93,3],(r,l)=>{let h=e.chRedir(r[0],l,!0),a=`PLG-SG CH${h+1} `,i=Date.now();if(r[1]===0){let n="",c=0;r.subarray(2).forEach((d,f)=>{f%2===0?n+=Ae[d]||d.toString().padStart("0"):c+=d*13}),(i>=e.#j||e.#ee>=e.#ce)&&(e.dispatchEvent("metacommit",{type:"SGLyrics",data:"",amend:!1}),e.#re=i<e.#j,e.#ee=0),e.dispatchEvent("metacommit",{type:"SGLyrics",data:`${De(n)}`,amend:!0,mask:e.#re}),e.#ee++,e.#re=!1,e.#j=i+Math.ceil(c/2)+e.#F,T()&&console.debug(`${a}vocals: ${n}`)}else console.warn(`Unknown PLG-SG data: ${r}`)}).add([98,96],(r,l,h,a)=>{let i=e.chRedir(r[0],l,!0),n=S[i],c=r[1];r.subarray(2).forEach((d,f)=>{let g=c+f;if(!(g<10)){if(g===10)e.resetAce();else if(g<27){let v=g+131;e.setChCc(i,v,d),!a?.noAce&&d>0&&d!==64&&e.allocateAce(i,v),e.dispatchEvent("cc",{part:i,cc:v,data:d})}}})}).add([1,20],(r,l,h)=>{h===115?(e.switchMode("doc",!0),e.setPortMode(e.getTrackPort(l),1,w.doc),console.info("MIDI reset: DOC")):console.debug(`Unknown Yamaha SysEx: 67, ${h}, ${r.join(", ")}`)}).add([1,17,15,89],(r,l,h)=>{h===115?(e.setEffectType(0,24,r[0]|16),e.dispatchEvent("efxreverb",e.getEffectType(0))):console.debug(`Unknown Yamaha SysEx: 67, ${h}, ${r.join(", ")}`)}).add([1,24],(r,l,h)=>{if(h===115){for(let a=0;a<16;a++){let i=e.chRedir(a,l,!0);e.setChCc(i,91,127)}console.info("DOC Global Reverb: on")}else console.debug(`Unknown Yamaha SysEx: 67, ${h}, ${r.join(", ")}`)}).add([126,0],(r,l,h)=>{switch(r[1]){case 0:{e.dispatchEvent("metacommit",{type:"YMCSSect",data:"Disabled",raw:"Intro "}),console.debug("Yamaha Section Control is off.");break}case 127:{e.dispatchEvent("metacommit",{type:"YMCSSect",data:["Intro","Main A","Main B","Fill-in AB","Fill-in BA","Ending","Blank"][r[0]-8]??`invalid section ${r[0]}`,raw:["Intro ","Main A","Main B","FillAB","FillBA","Ending","Blank "][r[0]-8]??`ID: ${r[0]}`}),console.debug(`Yamaha Section Control switches to "${["intro","main A","main B","fill-in AB","fill-in BA","ending","blank"][r[0]-8]??`Invalid section ${r[0]}`}".`);break}default:console.debug(`Unknown YMCS section control: ${r[1]}`)}}).add([126,2],(r,l,h)=>{let a=[];for(let i=0;i<r.length;i+=2){let n=r[i]>>4,c=r[i]&15;if(n<7&&c&&c<8){let d=new Uint8Array(5);d[0]=c-1,d[1]=n-3<<2,d[2]=r[i|1],a.push(d)}}e.dispatchEvent("metacommit",{type:"ChordCtl",src:"ymcs",data:a}),console.debug("YMCS chord data: %o",a)});let o=function(r,l,h,a){},u=function(r,l){e.dispatchEvent("mupromptex");let h=r*b.dpn,a=l[0],i=l[1];l.subarray(2).forEach((n,c)=>{let d=c+i,f=-1;d<16?([()=>{f=24},()=>{f=25},()=>{f=26},()=>{},()=>{f=28},()=>{f=29},()=>{f=30},()=>{f=31},()=>{},()=>{},()=>{},()=>{f=20},()=>{f=21},()=>{f=22},()=>{f=23},()=>{}][d]||(()=>{console.debug(`Unknown XG-style drum param ${d} on set ${r+1}.`)}))():d<32||(d<40?([()=>{f=48},()=>{f=49},!1,!1,()=>{f=52},()=>{f=53}][d-32]||(()=>{console.debug(`Unknown XG-style drum param ${d} on set ${r+1}.`)}))():d<80||([()=>{f=36}][d-80]||(()=>{console.debug(`Unknown XG-style drum param ${d} on set ${r+1}.`)}))()),f>=0?(T()&&console.debug(h,f,a,n),e.#P[(h+O[f])*b.dnc+a]=n):T()&&console.debug(`XG-style drum param ${d} has no writes.`)})},p=function(r,l,h){e.dispatchEvent("mupromptex");let a=r*b.dpn,i=(l<<7)+h[0];h.subarray(1).forEach((n,c)=>{let d=c+i,f=d&127,g=d>>7,v=-1;g>1&&([()=>{v=26},()=>{},()=>{v=28},()=>{v=29},()=>{v=30},()=>{},()=>{},()=>{v=31}][g-2]||(()=>{console.debug(`Unknown GS-style drum param ${g} on set ${r+1}.`)}))(),v>-1?(T()&&console.debug(a,v,f,n),e.#P[(a+O[v])*b.dnc+f]=n):T()&&console.debug(`GS-style drum param ${g} has no writes.`)})};this.#U.add([76,48],(r,l,h)=>{u(0,r)}).add([76,49],(r,l,h)=>{u(1,r)}).add([76,50],(r,l,h)=>{u(2,r)}).add([76,51],(r,l,h)=>{u(3,r)}).add([76,52],(r,l,h)=>{u(4,r)}).add([76,53],(r,l,h)=>{u(5,r)}).add([76,54],(r,l,h)=>{u(6,r)}).add([76,55],(r,l,h)=>{u(7,r)}),this.#U.add([89,0],(r,l,h)=>{if(e.eprom){let a=r[0],i=(r[1]<<14)+(r[2]<<7)+r[3]+(e.eprom.offset||0);T()&&console.debug(`MU1000 EPROM trail to 0x${i.toString(16).padStart(6,"0")}, ${a} bytes.`);let n=e.eprom.data;r.subarray(4).forEach((c,d)=>{let f=d>>3,g=d&7;if(g===7)for(let v=0;v<7;v++)n[i+7*f+v]+=(c>>6-v&1)<<7;else n[i+7*f+g]=c})}}).add([89,1],(r,l,h)=>{let a=(r[0]<<21)+(r[1]<<14)+(r[2]<<7)+r[3];T()&&console.debug(`MU1000 EPROM jump to 0x${a.toString(16).padStart(6,"0")}.`),e.eprom&&(e.eprom.offset=a)}).add([89,2],(r,l,h)=>{if(e.eprom){let a=(r[0]<<21)+(r[1]<<14)+(r[2]<<7)+r[3]+(e.eprom.offset||0);T()&&console.debug(`MU1000 EPROM write to 0x${a.toString(16).padStart(6,"0")}.`);let i=e.eprom.data;r.subarray(4).forEach((n,c)=>{let d=c>>3,f=c&7;if(f===7)for(let g=0;g<7;g++)i[a+7*d+g]+=(n>>6-g&1)<<7;else i[a+7*d+f]=n})}}).add([89,3],(r,l,h)=>{}),this.#U.add([39,48],(r,l,h)=>{}).add([43,0,0],(r,l,h)=>{e.dispatchEvent("mupromptex");let a=[0,0,0,0],i=(n,c)=>{a[c]=n};if(r.subarray(1).forEach((n,c)=>{let d=c+r[0];[i,i,i,i,()=>{this.#f=n*129/16383*100,e.dispatchEvent("mastervolume",e.#f)},()=>n-64,()=>n||128,()=>n,()=>n,()=>{console.debug(`TG300 variation on cc${n}.`)}][d](n,d)}),r[0]<4){let n=0;a.forEach(c=>{n=n<<4,n+=c}),n-=1024,console.debug(`Master tune: ${n}`)}}).add([43,1,0],(r,l,h)=>{e.dispatchEvent("mupromptex")}).add([43,2],(r,l,h)=>{e.dispatchEvent("mupromptex");let a=e.chRedir(r[0],l,!0),i=r[1],n=S[a],c=`TG300 CH${a+1} `;r.subarray(2).forEach((d,f)=>{f<5?([()=>{},()=>{e.setChCc(a,0,d),e.pushChPrimitives(a),e.dispatchEvent("voice",{part:a})},()=>{e.setChCc(a,32,d),e.pushChPrimitives(a),e.dispatchEvent("voice",{part:a})},()=>{e.#r[a]=d,e.dispatchEvent("voice",{part:a})},()=>{let g=e.chRedir(d,l,!0),v=e.#c[a];e.#c[a]=g,(a!==g||g!==v)&&(e.buildRchTree(),console.info(`${c}receives from CH${g+1}`))}][f+i]||(()=>{}))(d,f+i):f<21||(f<47?([()=>{e.#g[a]=+!d},()=>{},()=>{},()=>{e.#s[b.rpn*a+3]=d,e.#o[b.rpnt*a+2]=1,e.dispatchEvent("pitch",{part:a,pitch:e.getPitchShift(a)})},()=>{},()=>{e.setChCc(a,7,d)},!1,!1,()=>{e.setChCc(a,10,d||128)},!1,!1,()=>{console.debug(`${c} AC1 at cc${d}`)},()=>{console.debug(`${c} AC2 at cc${d}`)},()=>{e.#e[n+E[128]]=d,e.allocateAce(a,128)},()=>{e.#e[n+E[93]]=d},()=>{e.#e[n+E[91]]=d},()=>{e.#e[n+E[94]]=d},()=>{e.#e[n+E[76]]=d},()=>{e.#e[n+E[77]]=d},()=>{e.#e[n+E[74]]=d},()=>{e.#e[n+E[71]]=d},()=>{e.#e[n+E[73]]=d},()=>{e.#e[n+E[75]]=d},()=>{e.#e[n+E[72]]=d},()=>{e.#e[n+E[78]]=d}][f+i-21]||(()=>{}))(d,f+i):f<95||([()=>{e.#e[n+E[65]]=d},()=>{e.#e[n+E[5]]=d}][f+i-95]||(()=>{}))(d,f+i))})}).add([43,7,0],(r,l,h)=>{let a=r[0];e.setLetterDisplay(r.subarray(1),"TG300 letter display",a)}).add([43,7,1],(r,l,h)=>{e.#p=0,e.#C=Date.now()+3200,e.#k.fill(0),r.forEach(function(a,i){let n=Math.floor(i/16),c=i%16,d=(c*3+n)*7,f=7,g=0;for(d-=c*5,n===2&&(f=2);g<f;)e.#k[d+g]=a>>6-g&1,g++})}),this.#Y.add([66,18,0,0,127],(r,l,h)=>{e.switchMode("sc",!0),e.setPortMode(e.getTrackPort(l),2,w.sc),e.#a[w.sc][1]=e.#n.sc,e.#E=e.KARAOKE_NONE,e.#ie.fill(0),console.info(`GS system to ${["single","dual"][r[0]]} mode.`)}).add([66,18,64,0],(r,l,h)=>{switch(r[0]){case 127:{e.switchMode("gs",!0),e.setPortMode(e.getTrackPort(l),4,w.gs),e.#a[w.gs][1]=e.#n.gs,e.#E=e.KARAOKE_NONE,e.#ie.fill(0),console.info("MIDI reset: GS");break}default:{e.dispatchEvent("mupromptex");let a=[0,0,0,0],i=(n,c)=>{a[c]=n};if(r.subarray(1).forEach((n,c)=>{let d=c+r[0];[i,i,i,i,f=>{this.#f=f*129/16383*100,e.dispatchEvent("mastervolume",e.#f)},f=>{},f=>{}][d](n,c)}),r[0]<4){let n=0;a.forEach(c=>{n=n<<4,n+=c}),n-=1024,console.debug(`Master tune: ${n}`)}}}}).add([66,18,64,1],(r,l,h)=>{e.dispatchEvent("mupromptex");let a=r[0];if(a<16){let i="".padStart(a," ");r.subarray(1).forEach((n,c)=>{i+=String.fromCharCode(Math.max(32,n))}),i=i.padEnd(16," "),console.debug(`GS patch name: ${i}`)}else a<48||(a<65?r.subarray(1).forEach((i,n)=>{let c=`GS ${a+n>55?"chorus":"reverb"} `;([()=>{console.info(`${c}type: ${fe[i]}`),e.setEffectType(0,40,i),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{},()=>{},()=>{},()=>{},()=>{},!1,()=>{console.debug(`${c}predelay: ${i}ms`)},()=>{console.info(`${c}type: ${Ne[i]}`),e.setEffectType(1,40,16+i),e.dispatchEvent("efxchorus",e.getEffectType(1))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${c}to reverb: ${L(i)}`)},()=>{console.debug(`${c}to delay: ${L(i)}`)}][a+n-48]||(()=>{}))()}):a<80?console.debug(`Unknown GS patch address: ${a}`):a<91?r.subarray(1).forEach((i,n)=>{let c="GS delay ";([()=>{console.info(`${c}type: ${Ue[i]}`),e.setEffectType(2,40,32+i),e.dispatchEvent("efxdelay",e.getEffectType(2))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${c}to reverb: ${L(i)}`)}][a+n-80]||(()=>{}))()}):console.debug(`Unknown GS patch address: ${a}`))}).add([66,18,64,2],(r,l,h)=>{let a="GS EQ ";r.subarray(1).forEach((i,n)=>{([()=>{console.debug(`${a}low freq: ${[200,400][i]}Hz`)},()=>{console.debug(`${a}low gain: ${i-64}dB`)},()=>{console.debug(`${a}high freq: ${[3e3,6e3][i]}Hz`)},()=>{console.debug(`${a}high gain: ${i-64}dB`)}][r[0]+n]||function(){console.warn(`Unknown GS EQ address: ${r[0]+n}`)})()})}).add([66,18,64,3],(r,l,h)=>{e.dispatchEvent("mupromptex");let a="GS EFX ",i=function(n,c){let d=Be(e.#R.subarray(10,12),c,n);d&&console.debug(`${a}${he(e.#R.subarray(10,12))} ${d}`)};r.subarray(1).forEach((n,c)=>{([()=>{e.setEffectTypeRaw(3,!1,32+n),e.dispatchEvent("efxinsert0",e.getEffectType(3))},()=>{e.setEffectTypeRaw(3,!0,n),console.info(`${a}type: ${he(e.#R.subarray(10,12))}`),e.dispatchEvent("efxinsert0",e.getEffectType(3))},!1,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,()=>{console.debug(`${a}to reverb: ${L(n)}dB`)},()=>{console.debug(`${a}to chorus: ${L(n)}dB`)},()=>{console.debug(`${a}to delay: ${L(n)}dB`)},!1,()=>{console.debug(`${a}1 source: ${n}`),n&&n<96&&e.allocateAceAll(n)},()=>{console.debug(`${a}1 depth: ${n-64}`)},()=>{console.debug(`${a}2 source: ${n}`),n&&n<96&&e.allocateAceAll(n)},()=>{console.debug(`${a}2 depth: ${n-64}`)},()=>{console.debug(`${a}to EQ: ${n?"ON":"OFF"}`)}][r[0]+c]||function(d,f){console.warn(`Unknown GS EFX address: ${f}`)})(n,r[0]+c)})}).add([66,18,65],(r,l,h)=>{p((r[0]>>4)+1<<1,r[0]&15,r.subarray(1))}).add([69,18,16],(r,l,h)=>{switch(r[0]){case 0:{let a=r[1];e.setLetterDisplay(r.subarray(2),"GS display text",a);break}case 8:{let a=r[1],i=e.modelEx.sc;r.subarray(2).forEach((n,c)=>{([()=>{i.showBar=!(n&1),i.invBar=n>>1&1,i.invDisp=n>>2&1},()=>{i.peakHold=n<4?n:1}][c+a]||(()=>{console.debug("Unsupported GS display type SysEx.")}))()});break}case 32:{e.#C=Date.now()+3200,r[1]===0&&(r[2]?(e.#p=Math.max(Math.min(r[2]-1,9),0),T()&&console.debug(`GS switch display page ${r[2]-1}.`)):(e.#p=0,e.#C=Date.now(),T()&&console.debug("GS disable display page.")));break}default:if(r[0]<6){e.#p>9&&(e.#p=0);let a=r[0]-1<<1|r[1]>>6;e.#p===a&&(e.#C=Date.now()+3200),e.#S[a]?.length||(e.#S[a]=new Uint8Array(256));let i=e.#S[a];T()&&console.debug(`GS frame draw page ${a}.`);let n=r[1]&63;i.fill(0),r.subarray(2).forEach(function(d,f){let g=f+n,v=Math.floor(g/16),C=g%16,$=(C*4+v)*5,x=5,P=0;for($-=C*4,v===3&&(x=1);P<x;)i[$+P]=d>>4-P&1,P++})}else console.warn(`Unknown GS display section: ${r[0]}`)}}).add([69,18,32],(r,l,h)=>{let a=r[0],i=r[1],n=r.subarray(2);if(a>>4){console.warn(`SC-8850 partial screen dump out of bounds: invalid bundle.
`,r);return}let c=i+n.length,d=i*6-(i*2428>>16<<1),f=c*6-(c*2428>>16<<1);if(d>640){console.warn(`SC-8850 partial screen dump out of bounds: invalid buffer range.
`,r);return}f>640&&(console.info(`SC-8850 partial screen dump out of bounds: invalid buffer end, automatically restricted.
`,r),f=640);let g=new Uint8Array(f-d);n.forEach(($,x)=>{let P=x+i,V=(P*2428&65535)*27>>16===26,A=P*6-(P*2428>>16<<1),K=V?2:0;for(;K<6;)g[A+(5-K)]=$>>K&1,K++});let v=a*108+i,C=v*6-(v*2428>>16<<1);e.dispatchEvent("screen",{type:"sc8850",offset:C,data:g}),T()&&console.debug(`SC-8850 screen dump: bundle ${a+1}, range ${d}~${f}`)});let m=function(r,l,h){e.dispatchEvent("mupromptex");let a=r[0],i=S[l],n=Y[l],c=`GS CH${l+1} `;a<3?(r.subarray(1).forEach((d,f)=>{[()=>{e.#e[i+E[0]]=d,e.pushChPrimitives(l)},()=>{e.#r[l]=d},()=>{let g=0;d<16?g=e.chRedir(d,h,!0):g=b.ch,e.#c[l]=g;let v=e.#c[l];e.#c[l]=g,(l!==g||g!==v)&&(e.buildRchTree(),console.info(`${c}receives from CH${g+1}`))}][a+f]()}),e.dispatchEvent("voice",{part:l})):a<19||(a<44?r.subarray(1).forEach((d,f)=>{([()=>{e.#g[l]=+!d},!1,()=>{e.setChType(l,d<<1,w.gs),console.debug(`${c}type: ${d?"drum ":"melodic"}${d||""}`)},()=>{e.#s[n+3]=d,e.#o[b.rpnt*l+2]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)})},!1,()=>{e.#e[i+E[7]]=d},!1,!1,()=>{e.#e[i+E[10]]=d||128},!1,!1,()=>{console.debug(`${c}CC 1: cc${d}`)},()=>{console.debug(`${c}CC 2: cc${d}`)},()=>{e.#e[i+E[93]]=d},()=>{e.#e[i+E[91]]=d},!1,!1,()=>{e.#s[n+1]=d,e.#o[b.rpnt*l+1]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)})},()=>{e.#s[n+2]=d,e.#o[b.rpnt*l+1]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)})},()=>{e.#e[i+E[94]]=d}][a+f-19]||(()=>{}))()}):a<76||console.debug(`Unknown GS part address: ${a}`))},y=function(r,l){let h=r[0],a=`GS CH${l+1} `;h<2?r.subarray(1).forEach((i,n)=>{[()=>{e.setChCc(l,32,i)},()=>{}][h+n]()}):h<32?console.warn(`Unknown GS misc address: ${h}`):h<35?r.subarray(1).forEach((i,n)=>{[()=>{console.debug(`${a}EQ: o${["ff","n"][i]}`)},()=>{},()=>{console.debug(`${a}EFX: o${["ff","n"][i]}`),e.#J[l]=i,e.dispatchEvent("partefxtoggle",{part:l,active:i})}][h+n-32]()}):console.warn(`Unknown GS misc address: ${h}`)};this.#Y.add([66,18,64,16],(r,l)=>{m(r,e.chRedir(9,l,!0),l)}).add([66,18,64,17],(r,l)=>{m(r,e.chRedir(0,l,!0),l)}).add([66,18,64,18],(r,l)=>{m(r,e.chRedir(1,l,!0),l)}).add([66,18,64,19],(r,l)=>{m(r,e.chRedir(2,l,!0),l)}).add([66,18,64,20],(r,l)=>{m(r,e.chRedir(3,l,!0),l)}).add([66,18,64,21],(r,l)=>{m(r,e.chRedir(4,l,!0),l)}).add([66,18,64,22],(r,l)=>{m(r,e.chRedir(5,l,!0),l)}).add([66,18,64,23],(r,l)=>{m(r,e.chRedir(6,l,!0),l)}).add([66,18,64,24],(r,l)=>{m(r,e.chRedir(7,l,!0),l)}).add([66,18,64,25],(r,l)=>{m(r,e.chRedir(8,l,!0),l)}).add([66,18,64,26],(r,l)=>{m(r,e.chRedir(10,l,!0),l)}).add([66,18,64,27],(r,l)=>{m(r,e.chRedir(11,l,!0),l)}).add([66,18,64,28],(r,l)=>{m(r,e.chRedir(12,l,!0),l)}).add([66,18,64,29],(r,l)=>{m(r,e.chRedir(13,l,!0),l)}).add([66,18,64,30],(r,l)=>{m(r,e.chRedir(14,l,!0),l)}).add([66,18,64,31],(r,l)=>{m(r,e.chRedir(15,l,!0),l)}).add([66,18,64,64],(r,l)=>{y(r,e.chRedir(9,l,!0))}).add([66,18,64,65],(r,l)=>{y(r,e.chRedir(0,l,!0))}).add([66,18,64,66],(r,l)=>{y(r,e.chRedir(1,l,!0))}).add([66,18,64,67],(r,l)=>{y(r,e.chRedir(2,l,!0))}).add([66,18,64,68],(r,l)=>{y(r,e.chRedir(3,l,!0))}).add([66,18,64,69],(r,l)=>{y(r,e.chRedir(4,l,!0))}).add([66,18,64,70],(r,l)=>{y(r,e.chRedir(5,l,!0))}).add([66,18,64,71],(r,l)=>{y(r,e.chRedir(6,l,!0))}).add([66,18,64,72],(r,l)=>{y(r,e.chRedir(7,l,!0))}).add([66,18,64,73],(r,l)=>{y(r,e.chRedir(8,l,!0))}).add([66,18,64,74],(r,l)=>{y(r,e.chRedir(10,l,!0))}).add([66,18,64,75],(r,l)=>{y(r,e.chRedir(11,l,!0))}).add([66,18,64,76],(r,l)=>{y(r,e.chRedir(12,l,!0))}).add([66,18,64,77],(r,l)=>{y(r,e.chRedir(13,l,!0))}).add([66,18,64,78],(r,l)=>{y(r,e.chRedir(14,l,!0))}).add([66,18,64,79],(r,l)=>{y(r,e.chRedir(15,l,!0))}),this.#ae.add([54,65],(r,l)=>{let h=e.#n.x5==="81"?"05rw":"x5d";e.switchMode(h,!0),e.setPortMode(e.getTrackPort(l),1,w[h]);let a=r[r.length-1],i=r.subarray(0,r.length-1),n=G(i);n!==a&&(console.info(`X5D multi parameters checksum mismatch! Expected ${n}, got ${a}.`),console.debug(r));let c=(r[1]<<7)+r[0],d=(r[3]<<7)+r[2],f=e.chRedir(c&15,l,!0),g=S[f];[()=>{d<1||(d<101?(e.setChType(f,e.CH_MELODIC,w.x5d),e.#r[f]=d-1,e.#e[g+E[0]]=e.#n.x5):d<229?(e.setChType(f,e.CH_MELODIC,w.x5d),e.#r[f]=d-101,e.#e[g+E[0]]=56):(e.setChType(f,e.CH_DRUMS,w.x5d),e.#r[f]=Fe[d-229]||0,e.#e[g+E[0]]=62)),e.pushChPrimitives(f),e.dispatchEvent("voice",{part:f})},()=>{e.#e[g+E[7]]=d},()=>{d<31&&(e.#e[g+E[10]]=Math.round((d-15)*4.2+64))},()=>{e.#e[g+E[93]]=J(d)},()=>{e.#e[g+E[91]]=J(d)},()=>{e.#s[f*b.rpn+3]=d>8191?d-16320:64+d,e.#o[b.rpnt*f+2]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)})},()=>{e.#s[f*b.rpn+1]=d>8191?d-16320:64+d,e.#o[b.rpnt*f+1]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)})},()=>{d>0&&(e.#s[f*b.rpn]=d,e.#o[b.rpnt*f]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)}))},()=>{}][c>>4]()}).add([54,76,0],(r,l)=>{e.dispatchEvent("mupromptex");let h=e.#n.x5==="81"?"05rw":"x5d";e.switchMode(h),e.setPortMode(e.getTrackPort(l),1,w[h]);let a="",i=e.#n.x5,n=0,c=0,d="MSB	PRG	LSB	NME";N(r,function(f,g){if(g<16400){let v=g%164;switch(!0){case v<10:{f>31&&(a+=String.fromCharCode(f));break}case v===10:break;case v===11:{d+=`
${i}	${n}	${c}	${a.trim().replace("Init Voice","")}`,n++,a="";break}}n>99&&(i=90,n=0)}}),e.userBank.clearRange({msb:e.#n.x5,prg:[0,99],lsb:0}),e.userBank.load(d),T()&&console.debug(d),e.forceVoiceRefresh()}).add([54,77,0],(r,l)=>{e.dispatchEvent("mupromptex");let h=e.#n.x5==="81"?"05rw":"x5d";e.switchMode(h),e.setPortMode(e.getTrackPort(l),1,w[h]);let a="",i=90,n=0,c=0,d="MSB	PRG	LSB	NME";N(r,function(f,g){if(g<13600){let v=g%136;switch(!0){case v<10:{f>31&&(a+=String.fromCharCode(f));break}case v===11:{d+=`
${i}	${n}	${c}	${a.trim().replace("Init Combi","")}`,n++,a="";break}}}}),e.userBank.clearRange({msb:90,prg:[0,99],lsb:0}),e.userBank.load(d),T()&&console.debug(d),e.forceVoiceRefresh()}).add([54,78],(r,l)=>{let h=e.#n.x5==="81"?"05rw":"x5d";e.switchMode(h),e.setPortMode(e.getTrackPort(l),1,w[h]),console.debug(`X5D mode switch requested: ${["combi","combi edit","prog","prog edit","multi","global"][r[0]]} mode.`)}).add([54,85],(r,l)=>{e.dispatchEvent("mupromptex");let h=e.#n.x5==="81"?"05rw":"x5d";e.switchMode(h),e.setPortMode(e.getTrackPort(l),1,w[h]),N(r,(a,i)=>{i>0&&i<3&&(e.setEffectType(i-1,44,a),e.dispatchEvent(`efx${["reverb","chorus"][i-1]}`,e.getEffectType(i-1)))})}).add([54,104],(r,l)=>{e.dispatchEvent("mupromptex");let h=e.#n.x5==="81"?"05rw":"x5d";e.switchMode(h,!0);let a=e.getTrackPort(l);if(e.#x[a]&&e.#x[a]!==w[h])if(e.#d.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${l}. Port ${String.fromCharCode(65+a)} mode "${R[e.#x[a]]}" mismatch, should be "${h}".`);return}else console.info(`Track ${l} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+a)}.`);e.setPortMode(a,1,w[h]),N(r,function(i,n,c,d){if(n<192){let f=e.chRedir(Math.floor(n/12),l,!0),g=S[f];switch(n%12){case 0:{i<128?(e.setChType(f,e.CH_MELODIC,w.x5d),e.#e[g+E[0]]=e.#n.x5,e.#r[f]=i):(e.setChType(f,e.CH_DRUMS,w.x5d),e.#e[g+E[0]]=62,e.#r[f]=Fe[i-128]),i>0&&e.setChActive(f,1),e.pushChPrimitives(f),e.dispatchEvent("voice",{part:f});break}case 1:{e.#e[g+E[7]]=i;break}case 2:{e.#s[f*b.rpn+3]=i>127?i-192:64+i,e.#o[b.rpnt*f+2]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)});break}case 3:{e.#s[f*b.rpn+1]=i>127?i-192:64+i,e.#o[b.rpnt*f+1]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)});break}case 4:{i<31&&(e.#e[g+E[10]]=Math.round((i-15)*4.2+64));break}case 5:{let v=i>>4,C=i&15;e.#e[g+E[91]]=J(C),e.#e[g+E[93]]=J(v);break}case 10:{e.#i[f]||(e.#e[g+E[0]]=i>>6?56:e.#n.x5,e.pushChPrimitives(f),e.dispatchEvent("voice",{part:f}));break}case 11:{let v=e.chRedir(i&15,l,!0),C=i>>4;e.#c[f]=i,(v!==f||C)&&console.info(`X5D Part CH${f+1} receives from CH${v+1}.`)}}}else{let f=e.chRedir(n-192,l,!0)}}),e.buildRchTree()}),this.#Y.add([22,18,127],(r,l,h)=>{e.switchMode("mt32",!0),e.setPortMode(e.getTrackPort(l),1,w.mt32),e.#E=e.KARAOKE_NONE,e.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),console.info("MIDI reset: MT-32")}).add([22,18,0],(r,l,h)=>{e.switchMode("mt32");let a=e.chRedir(h,l,!0),i=r[1];r.subarray(2).forEach((n,c)=>{let d=c+i;e.#I[d+(a-1)*16]=n,([!1,()=>{let f=e.#I[a-1<<4];if(f<3){if(e.#L[a]=1,f===2)for(let g=0;g<name.length;g++)e.#A[(a-1)*b.cmt+g]=e.#K[n*b.cmt+g];else{let g=e.baseBank.get(0,n+(f<<6),127,"mt32").name;for(let v=0;v<g.length;v++)e.#A[(a-1)*b.cmt+v]=g.charCodeAt(v)}e.dispatchEvent("voice",{part:a})}},()=>{e.#s[a*b.rpn+3]=n+40,e.#o[b.rpnt*a+2]=1},()=>{e.#s[a*b.rpn+1]=n+14,e.#o[b.rpnt*a+1]=1},()=>{e.#s[a*b.rpn]=n,e.#o[b.rpnt*a]=1},!1,()=>{e.setChCc(a,91,n?127:0)},!1,()=>{e.setChCc(a,7,n)},()=>{e.setChCc(a,10,Math.ceil(n*9.05))}][d]||(()=>{}))()})}).add([22,18,1],(r,l,h)=>{e.switchMode("mt32");let a=h&7;console.debug(`MT-32 slot #${h+1} Drum: ${r}`);let i=r[0]<<7|r[1];r.subarray(2).forEach((n,c)=>{let d=c+i,f=(d>>2)+24,g=d&3,v=a*b.dpn;if(T()&&console.debug(`MT-32 temp drum note ${f} param ${g}: ${n}`),f<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${f}`);return}[()=>{},()=>{e.#P[(v+O[26])*b.dnc+f]=Math.round(n*1.27)},()=>{e.#P[(v+O[26])*b.dnc+f]=n*9+1&127},()=>{e.#P[(v+O[26])*b.dnc+f]=n?127:0}][g]()})}).add([22,18,2],(r,l,h)=>{e.switchMode("mt32");let a=e.chRedir(h,l,!0),i=r[1]+(r[0]<<7);i<10&&(e.#L[a]=1),r.subarray(2).forEach((n,c)=>{let d=c+i;d<14&&(e.#A[(a-1)*b.cmt+d]=n)}),e.dispatchEvent("voice",{part:a})}).add([22,18,3],(r,l,h)=>{e.switchMode("mt32");let a=h&7;if(r[0]){let i=(r[0]-1<<7)+r[1]-16;r.subarray(2).forEach((n,c)=>{let d=c+i,f=(d>>2)+24,g=d&3,v=a*b.dpn;if(T()&&console.debug(`MT-32 dev drum note ${f} param ${g}: ${n}`),f<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${f}`);return}[()=>{},()=>{e.#P[(v+O[26])*b.dnc+f]=Math.round(n*1.27)},()=>{e.#P[(v+O[26])*b.dnc+f]=n*9+1&127},()=>{e.#P[(v+O[26])*b.dnc+f]=n?127:0}][g]()})}else{let i=r[1];r.subarray(2).forEach((n,c)=>{let d=c+i;e.#I[d]=n;let f=e.chRedir(1+(d>>4),l,!0),g=d&15;([!1,()=>{let v=e.#I[f-1<<4];if(v<3)if(e.#L[f]=1,v===2)for(let C=0;C<name.length;C++)e.#A[(f-1)*b.cmt+C]=e.#K[n*b.cmt+C];else{let C=e.baseBank.get(0,n+(v<<6),127,"mt32").name;for(let $=0;$<C.length;$++)e.#A[(f-1)*b.cmt+$]=C.charCodeAt($)}e.dispatchEvent("voice",{part:f})},()=>{e.#s[f*b.rpn+3]=n+40,e.#o[b.rpnt*f+2]=1},()=>{e.#s[f*b.rpn+1]=n+14,e.#o[b.rpnt*f+1]=1},()=>{e.#s[f*b.rpn]=n,e.#o[b.rpnt*f]=1},!1,()=>{e.setChCc(f,91,n?127:0)},!1,()=>{e.setChCc(f,7,n)},()=>{e.setChCc(f,10,Math.ceil(n*9.05))}][g]||(()=>{}))()})}}).add([22,18,4],(r,l,h)=>{e.switchMode("mt32");let a=r[1]+(r[0]<<7),i=[];r.subarray(2).forEach((n,c)=>{let d=c+a,f=e.chRedir(Math.floor(d/246+1),l,!0),g=d%246;g<14&&(e.#A[(f-1)*b.cmt+g]=n),g<10&&(e.#L[f]=1),i.indexOf(f)<0&&i.push(f)}),i.forEach(n=>{e.dispatchEvent("voice",{part:n})})}).add([22,18,5],(r,l,h)=>{e.switchMode("mt32");let a=(r[0]<<7)+r[1];r.subarray(2).forEach((i,n)=>{let c=a+n,d=Math.floor(c/8),f=c&7,g=d*8;e.#M[c]=i,([!1,()=>{let v=e.#M[g];if(v<3){let C="";if(v===2){let x=b.cmt*d;C=`MT-m:${i.toString().padStart(3,"0")}`}else C=e.baseBank.get(0,i+(v<<6),127,"mt32").name;e.userBank.clearRange({msb:0,lsb:127,prg:d});let $=`MSB	LSB	PRG	NME
49	127	${d}	${C}`;e.userBank.load($,!0)}}][f]||(()=>{}))()}),e.forceVoiceRefresh()}).add([22,18,8],(r,l,h)=>{e.switchMode("mt32");let a=((r[0]&1)<<7)+r[1],i=r[0]>>1,n=!1;if(r.subarray(2).forEach((c,d)=>{let f=a+d;f<b.cmt&&(e.#K[i*b.cmt+f]=c,n=!0)}),n){e.userBank.clearRange({msb:0,lsb:127,prg:i});let c=`MSB	LSB	PRG	NME
49	127	${i}	MT-m:${i}`;e.userBank.load(c,!0)}e.forceVoiceRefresh()}).add([22,18,16],(r,l,h)=>{e.switchMode("mt32");let a=r[1],i=!1,n=function(c,d){e.#c[d-12]=c,i=!0};r.subarray(2).forEach((c,d)=>{let f=d+a;([!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,n,n,n,n,n,n,n,n,n,()=>{e.#f=c,e.dispatchEvent("mastervolume",e.#f)}][f]||(()=>{}))(c,d)}),i&&e.buildRchTree()}).add([22,18,32],(r,l,h)=>{e.switchMode("mt32");let a=r[1],i=" ".repeat(a);r.subarray(2).forEach(n=>{n>31?i+=String.fromCharCode(n):i+=" "}),e.#X=i.padStart(20," "),e.#te=Date.now()+3200}).add([22,18,82],(r,l)=>{let h=e.chRedir(0,l,!0);for(let a=0;a<16;a++)e.#D.ano(h+a),a&&a<10&&(e.#r[h+a]=ue[a-1]);console.info("MT-32 alt reset complete.")}),this.#ae.add([66,0],(r,l)=>{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(l),2,w.ns5r),e.#E=e.KARAOKE_NONE,console.debug(`NS5R mode switch requested: ${["global","multi","prog edit","comb edit","drum edit","effect edit"][r[0]]} mode.`)}).add([66,1],(r,l)=>{let h=["ns5r","05rw"][r[0]];e.switchMode(h,!0),e.setPortMode(e.getTrackPort(l),2,w[h]),e.#E=e.KARAOKE_NONE}).add([66,18,0,0],(r,l)=>{let h=r[0];switch(h){case 124:case 126:case 127:{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(l),2,w.ns5r),e.#E=e.KARAOKE_NONE;break}case 125:{e.initDrums(),console.info(`NS5R drum setup reset on drum kit ${r[1]}.`);break}default:if(h<10){let a=[0,0,0,0],i=(n,c)=>{a[c]=n};if(r.subarray(1).forEach((n,c)=>{[i,i,i,i,()=>{e.#f=n*129/16383*100,e.dispatchEvent("mastervolume",e.#f)},()=>n-64,()=>n-64,()=>{},()=>{},()=>{}][h+c]()}),r[0]<4){let n=0;a.forEach(c=>{n=n<<4,n+=c}),n-=1024,console.debug(`Master tune: ${n}`)}}}}).add([66,18,0,1],(r,l)=>{}).add([66,18,0,2],(r,l)=>{}).add([66,18,1],(r,l)=>{e.dispatchEvent("mupromptex");let h=e.chRedir(r[0],l,!0),a=S[h],i=r[1],n=`NS5R CH${h+1} `;r.subarray(2).forEach((c,d)=>{let f=i+d;f<3?([()=>{e.#e[a+E[0]]=c||U.bank0,e.pushChPrimitives(h)},()=>{e.#e[a+E[32]]=c,e.pushChPrimitives(h)},()=>{e.#r[h]=c}][f](),e.dispatchEvent("voice",{part:h})):f<8||(f<14?[()=>{let g=e.chRedir(c,l,!0),v=e.#c[h];e.#c[h]=g,(h!==g||g!==v)&&(e.buildRchTree(),console.info(`${n}receives from CH${g+1}`))},()=>{e.#g[h]=+!c},()=>{e.setChType(h,c,w.ns5r),console.debug(`${n}type: ${Z[c]}`)},()=>{e.#s[b.rpn*h+3]=c,e.#o[b.rpnt*h+2]=1,e.dispatchEvent("pitch",{part:h,pitch:e.getPitchShift(h)})},()=>{},()=>{}][f-8]():f<16||(f<33?[()=>{e.#e[a+E[7]]=c},()=>{e.#e[a+E[11]]=c},()=>{},()=>{},()=>{e.#e[a+E[10]]=c||128},()=>{},()=>{},()=>{e.#e[a+E[93]]=c},()=>{e.#e[a+E[91]]=c},()=>{e.#e[a+E[76]]=c},()=>{e.#e[a+E[77]]=c},()=>{e.#e[a+E[78]]=c},()=>{e.#e[a+E[74]]=c},()=>{e.#e[a+E[71]]=c},()=>{e.#e[a+E[73]]=c},()=>{e.#e[a+E[75]]=c},()=>{e.#e[a+E[72]]=c}][f-16]():f<112||f<114&&[()=>{e.#e[a+E[5]]=c},()=>{e.#e[a+E[65]]=c}][f-112]()))})}).add([66,18,8,0],(r,l)=>{let h=r[0];if(h<32)e.setLetterDisplay(r.subarray(1,33),"NS5R letter display");else{let a=h-32;e.#C=Date.now()+3200,e.#p=10,e.#k.fill(0);let i=r.subarray(1),n=4;i.forEach(function(c,d){let f=d+a,g=f>>4,v=f&15;if(f<80){let C=g<n?c:c>>3,$=0,x=g<n?6:3;for(;C>0;)e.#k[v*32+g*7+(x-$)]=C&1,C=C>>1,$++}})}}).add([66,18,48],(r,l,h)=>{u(0,r)}).add([66,18,49],(r,l,h)=>{u(1,r)}).add([66,18,50],(r,l,h)=>{u(2,r)}).add([66,18,51],(r,l,h)=>{u(3,r)}).add([66,18,52],(r,l,h)=>{u(4,r)}).add([66,18,53],(r,l,h)=>{u(5,r)}).add([66,18,54],(r,l,h)=>{u(6,r)}).add([66,18,55],(r,l,h)=>{u(7,r)}).add([66,52],(r,l)=>{e.switchMode("ns5r"),e.#E=e.KARAOKE_NONE;let h="";N(r,(a,i)=>{i<8?(a>31&&(h+=String.fromCharCode(a)),i===7&&(e.aiEfxName=h)):i<10&&(e.setEffectType(i-8,44,a),e.dispatchEvent(`efx${["reverb","chorus"][i-8]}`,e.getEffectType(i-8)))})}).add([66,53],(r,l)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r"),e.#E=e.KARAOKE_NONE;let h="",a=r[r.length-1],i=r.subarray(0,r.length-1),n=G(i);n!==a&&(console.info(`NS5R current multi dump checksum mismatch! Expected ${n}, got ${a}.`),console.debug(r));let c=e.getTrackPort(l);if(e.#x[c]&&e.#x[c]!==w.ns5r)if(e.#d.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${l}. Port ${String.fromCharCode(65+c)} mode "${R[e.#x[c]]}" mismatch, should be "ns5r".`);return}else console.info(`Track ${l} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+c)}.`);e.setPortMode(c,2,w.ns5r),N(i,function(d,f){switch(!0){case f<2944:{let g=e.chRedir(Math.floor(f/92),l,!0),v=S[g];switch(f%92){case 0:{e.#e[v+E[0]]=d,e.pushChPrimitives(g),e.dispatchEvent("voice",{part:g});break}case 1:{e.#e[v+E[32]]=d,!d&&!e.#e[v+E[0]]&&(e.#e[v+E[0]]=U.bank0),e.pushChPrimitives(g),e.dispatchEvent("voice",{part:g});break}case 2:{e.#r[g]=d,d>0&&e.setChActive(g,1),e.dispatchEvent("voice",{part:g});break}case 3:{let C=e.chRedir(d,l,!0);e.#c[g]=C,g!==C&&console.info(`NS5R CH${g+1} receives from CH${C+1}.`);break}case 7:{e.#i[g]=d,e.dispatchEvent("voice",{part:g});break}case 8:{e.#s[g*b.rpn+3]=d<40||d>88?d+(d>63?-192:64):d,e.#o[b.rpnt*g+2]=1,e.dispatchEvent("pitch",{part:g,pitch:e.getPitchShift(g)});break}case 9:case 10:{e.#e[v+E[7]]=d;break}case 11:{e.#e[v+E[11]]=d;break}case 14:{e.#e[v+E[10]]=d||128;break}case 19:{e.#e[v+E[93]]=d;break}case 20:{e.#e[v+E[91]]=d;break}case 84:{e.#e[v+E[65]]=d;break}case 85:{e.#e[v+E[5]]=d;break}}break}case f<3096:break;case f<3134:{let g=f-3096;g<8?(d>31&&(h+=String.fromCharCode(d)),g===7&&(e.aiEfxName=h)):g<10&&(e.setEffectType(g-8,44,d),e.dispatchEvent(`efx${["reverb","chorus"][g-8]}`,e.getEffectType(g-8)));break}case f<8566:break}}),e.buildRchTree()}).add([66,54],(r,l)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r");let h="",a=80,i=0,n=0,c="MSB	PRG	LSB	NME";N(r,function(d,f){let g=f%158;switch(!0){case g<10:{d>31&&(h+=String.fromCharCode(d));break}case g===10:break;case g===11:{a=d&127;break}case g===12:{n=d&127;break}case g===13:{c+=`
${a}	${i}	${n}	${h.trim().replace("Init Voice","")}`,i++,h="";break}}}),e.userBank.clearRange({msb:80,lsb:0}),e.userBank.load(c),T()&&console.debug(c),e.forceVoiceRefresh()}).add([66,55],(r,l)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r");let h="",a=88,i=0,n=0,c="MSB	PRG	LSB	NME";N(r,function(d,f){let g=f%126;switch(!0){case g<10:{d>31&&(h+=String.fromCharCode(d));break}case g===11:break;case g===12:break;case g===13:{c+=`
${a}	${i}	${n}	${h.trim().replace("Init Combi","")}`,i++,h="";break}}}),e.userBank.clearRange({msb:88,lsb:0}),e.userBank.load(c),T()&&console.debug(c),e.forceVoiceRefresh()}).add([66,125],(r,l,h)=>{e.dispatchEvent("backlight",["green","orange","red",!1,"yellow","blue","purple"][r[0]]||"white")}).add([66,127],(r,l,h)=>{let a=r[r.length-1],i=r.subarray(0,r.length-1),n=G(i);n!==a&&(console.info(`NS5R screen dump checksum mismatch! Expected ${n}, got ${a}.`),console.debug(r));let c=new Uint8Array(5760);N(r,(d,f,g)=>{if(f<720)for(let v=0;v<8;v++)c[f*8+v]=d>>7-v&1}),e.dispatchEvent("screen",{type:"ns5r",data:c})}).add([76],(r,l,h)=>{e.#ae.run([66,...r],l,h)}),this.#he.add([16,0,8,0],(r,l,h)=>{let a=(r[2]<<4)+r[3],i="K11 ";([()=>{e.switchMode("k11",!0),e.setPortMode(e.getTrackPort(l),2,w.k11),e.#E=e.KARAOKE_NONE,e.#a[w.k11][1]=a?4:0,console.info("MIDI reset: GMega/K11")},()=>{e.setEffectType(0,24,a),console.debug(`${i}reverb type: ${a}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{console.debug(`${i}reverb time: ${a}`)},()=>{console.debug(`${i}reverb time: ${a}`)},()=>{console.debug(`${i}reverb predelay: ${a}`)},()=>{console.debug(`${i}reverb predelay: ${a}`)},()=>{console.debug(`${i}depth high: ${a}`)},()=>{console.debug(`${i}depth high: ${a}`)},()=>{console.debug(`${i}depth low: ${a}`)},()=>{console.debug(`${i}depth low: ${a}`)}][r[0]]||(()=>{}))()}).add([16,0,8,1],(r,l,h)=>{e.dispatchEvent("mupromptex");let a=e.chRedir(r[1],l,!0),i=S[a],n=Y[a],c=(r[3]<<4)+r[4],d=`GMega CH${a+1} `;([()=>{c<128?(e.setChType(a,e.CH_MELODIC,w.k11),e.#e[i+E[0]]=0,e.#r[a]=c):(e.setChType(a,e.CH_DRUMS,w.k11),e.#r[a]=c-128),e.pushChPrimitives(a),e.dispatchEvent("voice",{part:a})},()=>{let f=e.chRedir(c,l,!0),g=e.#c[a];e.#c[a]=f,(a!==f||f!==g)&&(e.buildRchTree(),console.info(`${d}receives from CH${f+1}`))},()=>{e.#e[i+E[7]]=c},()=>{uupThis.setChActive(a,c)},()=>{e.#e[i+E[10]]=c},()=>{e.#s[n+3]=c+40,e.#o[b.rpnt*a+2]=1,e.dispatchEvent("pitch",{part:a,pitch:e.getPitchShift(a)})},()=>{e.#s[n+1]=c>>1,e.#s[n+2]=c&1,e.#o[b.rpnt*a+1]=1,e.dispatchEvent("pitch",{part:a,pitch:e.getPitchShift(a)})},()=>{e.#e[i+E[91]]=c?127:0},()=>{},()=>{e.#e[i+E[74]]=c},()=>{e.#e[i+E[73]]=c},()=>{e.#e[i+E[72]]=c}][r[0]]||(()=>{}))()}).add([16,0,9,0],(r,l,h)=>{e.dispatchEvent("mupromptex");let a=(r[2]<<4)+r[3],i="GMLX ";([()=>{console.debug(`${i}reverb type: ${a}`)},()=>{console.debug(`${i}reverb time: ${a}`)},()=>{console.debug(`${i}reverb predelay: ${a}`)},()=>{console.debug(`${i}depth high: ${a}`)},()=>{console.debug(`${i}depth low: ${a}`)}][r[0]]||(()=>{}))()}).add([16,0,9,3],(r,l,h)=>{e.dispatchEvent("mupromptex");let a=(r[2]<<4)+r[3],i=e.chRedir(r[1],l,!0),n=S[i],c=`GMLX CH${i+1} `;[()=>{a<128?(e.setChType(i,e.CH_MELODIC,w.k11),e.#e[n+E[0]]=0,e.#e[n+E[32]]=0,e.#r[i]=a):a<160?(e.setChType(i,e.CH_MELODIC,w.k11),e.#e[n+E[0]]=0,e.#e[n+E[32]]=7,e.#r[i]=a-100):(e.setChType(i,e.CH_DRUMS,w.k11),e.#e[n+E[0]]=122,e.#e[n+E[32]]=0,e.#r[i]=a-160),e.pushChPrimitives(i),e.dispatchEvent("voice",{part:i})},()=>{let d=e.chRedir(a,l,!0),f=e.#c[i];e.#c[i]=d,(i!==d||d!==f)&&(e.buildRchTree(),console.info(`${c}receives from CH${d+1}`))}][r[0]]()}).add([16,0,9,4],(r,l,h)=>{e.dispatchEvent("mupromptex");let a=(r[2]<<4)+r[3],i=e.chRedir(r[1],l,!0),n=S[i],c=Y[i];[()=>{e.setChActive(i,a)},()=>{e.#e[n+E[7]]=a},()=>{e.#e[n+E[10]]=a},()=>{e.#e[n+E[91]]=a?127:0},()=>{e.#s[c+3]=a+40,e.#o[b.rpnt*i+2]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{e.#s[c+1]=a,e.#o[b.rpnt*i+1]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{e.#s[c]=a,e.#o[b.rpnt*i]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{}][r[0]]()}),this.#ue.add([66,93,64],(r,l,h)=>{let a=r[2];switch(r[0]){case 0:{switch(r[1]){case 4:{e.dispatchEvent("mupromptex"),e.#f=a*129/16383*100,e.dispatchEvent("mastervolume",e.#f);break}case 5:{e.dispatchEvent("mupromptex"),a-64;break}case 6:{e.dispatchEvent("mupromptex"),console.debug(`SG global reverb: ${a?"on":"off"}`);break}case 127:{e.switchMode("sg",!0),e.setPortMode(e.getTrackPort(l),1,w.sg);break}}break}case 1:{switch(r[1]){case 48:{e.dispatchEvent("mupromptex"),console.debug(`SG reverb type: ${fe[a]}`);break}}break}default:if(r[0]>>4===1){e.dispatchEvent("mupromptex");let i=e.chRedir(r[0]&15,l,!0);if(r[1]===2){let n=e.chRedir(a,l,!0),c=e.#c[i];e.#c[i]=n,(i!==n||n!==c)&&(e.buildRchTree(),console.info(`SG CH${i+1} receives from CH${n+1}`))}else r[1]===19&&e.setChCc(i,7,a)}else console.warn(`Unknown AKAI SG SysEx: ${r}`)}}),this.#pe.add([9],(r,l,h)=>{e.dispatchEvent("mupromptex"),console.debug(`GZ set effect: ${["stage reverb","hall reverb","room reverb","chorus","tremolo","phaser","rotary speaker","enhancer","flanger","EQ"][r[0]]||"off"}`)}),this.#U.add([127,0],(r,l,h)=>{e.switchMode("motif");let a=new Uint8Array([127,1,...r]);e.#U.run(a,l,h)}).add([127,1,0,0],(r,l,h)=>{e.switchMode("s90es");let a="S90/Motif ES system ",i=r[0];r.subarray(1).forEach((n,c)=>{([()=>{e.#f=n*12900/16383,e.dispatchEvent("mastervolume",e.#f)}][i+c]||(()=>{console.info(`Unrecognized ${a}ID: ${i+c}`)}))()})}).add([127,1,14],(r,l,h)=>{e.switchMode("s90es");let a="S90/Motif ES bulk header ",i=[];i[95]=(n,c,d)=>{console.debug(`${a}multi edit buffer: ${n[1]}`)},(i[r[0]]||(()=>{console.info(`Unrecognized ${a}ID: ${r[0]}.`)}))(r.subarray(1))}).add([127,1,15],(r,l,h)=>{e.switchMode("s90es");let a="S90/Motif ES bulk footer ",i=[];i[95]=(n,c,d)=>{console.debug(`${a}multi edit buffer: ${n[1]}`)},(i[r[0]]||(()=>{console.info(`Unrecognized ${a}ID: ${r[0]}.`)}))(r.subarray(1))}).add([127,1,54,1],(r,l,h)=>{e.switchMode("s90es");let a="S90/Motif ES reverb ",i=r[0];r.subarray(1).forEach((n,c)=>{([()=>{e.setEffectTypeRaw(0,!1,n&15|128)},()=>{e.setEffectTypeRaw(0,!0,n)}][i+c]||(()=>{}))()}),e.dispatchEvent("efxreverb",e.getEffectType(0))}).add([127,1,54,2],(r,l,h)=>{e.switchMode("s90es");let a="S90/Motif ES chorus ",i=r[0];r.subarray(1).forEach((n,c)=>{([()=>{e.setEffectTypeRaw(1,!1,n&15|128)},()=>{e.setEffectTypeRaw(1,!0,n)}][i+c]||(()=>{}))()}),e.dispatchEvent("efxchorus",e.getEffectType(1))}).add([127,1,54,3],(r,l,h)=>{e.switchMode("s90es");let a="S90/Motif ES insert 1 ",i=r[0];r.subarray(1).forEach((n,c)=>{([()=>{e.setEffectTypeRaw(3,!1,n&15|128)},()=>{e.setEffectTypeRaw(3,!0,n)}][i+c]||(()=>{}))()}),e.dispatchEvent("efxinsert0",e.getEffectType(3))}).add([127,1,54,4],(r,l,h)=>{e.switchMode("s90es");let a="S90/Motif ES insert 2 ",i=r[0];r.subarray(1).forEach((n,c)=>{([()=>{e.setEffectTypeRaw(4,!1,n&15|128)},()=>{e.setEffectTypeRaw(4,!0,n)}][i+c]||(()=>{}))()}),e.dispatchEvent("efxinsert1",e.getEffectType(4))}).add([127,1,54,16],(r,l,h)=>{e.switchMode("s90es");let a=r[0];r.subarray(1).forEach((i,n)=>{let d=`S90/Motif ES EQ${(n>>2)+1} `;([()=>{let f=i-64},()=>{let f=F[i]},()=>{let f=i/10},()=>{let f=i}][a+n&3]||(()=>{}))()})}).add([127,1,54,17],(r,l,h)=>{e.switchMode("s90es");let a="S90/Motif ES variation ",i=r[0];r.subarray(1).forEach((n,c)=>{([()=>{e.setEffectTypeRaw(2,!1,n&15|128)},()=>{e.setEffectTypeRaw(2,!0,n)}][i+c]||(()=>{}))()}),e.dispatchEvent("efxdelay",e.getEffectType(2))}).add([127,1,55],(r,l,h)=>{e.dispatchEvent("mupromptex"),e.switchMode("s90es");let a=e.getTrackPort(l);if(e.#x[a]&&e.#x[a]!==e.#n.smotif)if(e.#d.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${l}. Port ${String.fromCharCode(65+a)} mode "${R[e.#x[a]]}" mismatch, should be "${R[e.#n.smotif]}".`);return}else console.info(`Track ${l} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+a)}.`);let i=e.chRedir(r[0],l,!0),n=S[i],c=r[1];r[0]>15&&(i=r[0]+32);let d=`Track ${l} S90/Motif ES bulk CH${i<128?i+1:"U"+(i-127)} `;console.debug(d,r),!(r[0]>15)&&r.subarray(2).forEach((f,g)=>{([()=>{e.#e[n+E[0]]=f,e.pushChPrimitives(i),e.dispatchEvent("voice",{part:i})},()=>{f&&e.setChActive(i,1),e.#e[n+E[32]]=f,e.getChPrimitive(i,1)===63&&e.setChType(i,[32,40].indexOf(f)>-1?e.CH_DRUMS:e.CH_MELODIC,e.#t,!0),e.pushChPrimitives(i),e.dispatchEvent("voice",{part:i})},()=>{f&&e.setChActive(i,1),e.#r[i]=f,e.dispatchEvent("voice",{part:i})},()=>{let v=e.chRedir(f,l,!0),C=e.#c[i];e.#c[i]=v,(i!==v||v!==C)&&(e.buildRchTree(),console.info(`${d}receives from CH${v+1}`))},()=>{e.#g[i]=f?0:1},!1,!1,!1,!1,!1,!1,!1,!1,()=>{f!==100&&e.setChActive(i,1),e.#e[n+E[7]]=f},()=>{f!==64&&e.setChActive(i,1),e.#e[n+E[10]]=f},!1,!1,!1,()=>{e.#e[n+E[91]]=f},()=>{f&&e.setChActive(i,1),e.#e[n+E[93]]=f},()=>{f&&e.setChActive(i,1),e.#e[n+E[94]]=f},()=>{e.setChCc(i,128,f),f!==127&&(e.setChActive(i,1),e.allocateAce(i,128))},()=>{},()=>{f!==64&&e.setChActive(i,1),e.#e[n+E[74]]=f},()=>{f!==64&&e.setChActive(i,1),e.#e[n+E[71]]=f},!1,()=>{e.#e[n+E[65]]=f},()=>{e.#e[n+E[5]]=f},()=>{}][c+g]||(()=>{}))()})}),e.#U.add([100,14],(r,l,h)=>{e.switchMode("cs6x"),e.setPortMode(e.getTrackPort(l),1,w.cs6x);let a=["normal voice","plugin voice PLG","drums",,"performance",,"phrase clip"][r[0]>>4]??"invalid";r[0]&!0?a+=" edit buffer":r[0]>>4==1?a+=`${(r[0]&1)+1}`:a+=` ${["INT","EXT"][r[0]&1]}`,console.debug(`CS6x bulk dump for ${a} started.`)}).add([100,15],(r,l,h)=>{e.switchMode("cs6x");let a=["normal voice","plugin voice PLG","drums",,"performance",,"phrase clip"][r[0]>>4]??"invalid";r[0]&!0?a+=" edit buffer":r[0]>>4==1?a+=`${(r[0]&1)+1}`:a+=` ${["INT","EXT"][r[0]&1]}`,console.debug(`CS6x bulk dump for ${a} ended.`)}).add([100,76,112],(r,l,h)=>{e.switchMode("cs6x");let a=0,i=r[0];r.subarray(1).forEach((n,c)=>{let d=c+i;d<10?(e.setChCvnRegister(a,c,n&127),e.#L[a]=1):d<12||d<13&&console.debug(`Plugin voice type: ${n}`)}),e.dispatchEvent("voice",{part:a})}).add([100,76,0],(r,l,h)=>{e.switchMode("cs6x"),e.setPortMode(e.getTrackPort(l),1,w.cs6x);let a=0,i=r[0];r.subarray(1).forEach((n,c)=>{let d=c+i;([()=>{e.setChCc(a,7,n),n!==100&&e.setChActive(a,1)},,,()=>{e.#g[a]=n==0,e.setChCc(a,64,0),e.#D.ano(a),e.resetChAceAll(a)},,()=>{},,,()=>{e.setChCc(a,65,n?127:0)},()=>{e.setChCc(a,5,n)},,()=>{e.setChCc(a,91,n),n!==40&&e.setChActive(a,1)},()=>{e.setChCc(a,93,n),n&&e.setChActive(a,1)}][d]||(()=>{}))()})}).add([100,76,1],(r,l,h)=>{e.switchMode("cs6x");let a=0,i=r[0],n=!1;r.subarray(1).forEach((c,d)=>{let f=d+i;([()=>{e.setEffectTypeRaw(0,!1,c&15|128),n=!0},()=>{e.setEffectTypeRaw(0,!0,c),n=!0}][f]||(()=>{}))()}),n&&e.dispatchEvent("efxreverb",e.getEffectType(0))}).add([100,76,2],(r,l,h)=>{e.switchMode("cs6x");let a=0,i=r[0],n=!1;r.subarray(1).forEach((c,d)=>{let f=d+i;([()=>{e.setEffectTypeRaw(1,!1,c&15|128),n=!0},()=>{e.setEffectTypeRaw(1,!0,c),n=!0}][f]||(()=>{}))()}),n&&e.dispatchEvent("efxchorus",e.getEffectType(1))}).add([100,76,3],(r,l,h)=>{e.switchMode("cs6x");let a=0,i=r[0],n=!1;r.subarray(1).forEach((c,d)=>{let f=d+i;([()=>{e.setEffectTypeRaw(2,!1,c&15|128),n=!0},()=>{e.setEffectTypeRaw(2,!0,c),n=!0}][f]||(()=>{}))()}),n&&e.dispatchEvent("efxdelay",e.getEffectType(2))}).add([100,76,5],(r,l,h)=>{e.switchMode("cs6x")}).add([100,76,16],(r,l,h)=>{e.switchMode("cs6x");let a=0,i=r[0],n=!1;if(r.subarray(1).forEach((c,d)=>{let f=d+i;([()=>{e.setChCc(a,0,c),n=!0},()=>{e.setChCc(a,32,c),n=!0,c&&e.setChActive(a,1)},()=>{e.#r[a]=c,n=!0,c&&e.setChActive(a,1)},()=>{e.#o[Y[a]+te[2]]=1,e.#s[Y[a]+te[2]]=c,c&&e.setChActive(a,1)}][f]||(()=>{}))()}),n){switch(e.pushChPrimitives(a),e.dispatchEvent("voice",{part:a}),e.getChVoice(a).standard){case"DX":{e.#w[a]=e.EXT_DX;break}case"VL":{e.#w[a]=e.EXT_VL;break}}e.dispatchEvent("metacommit",{type:"OSysMeta",data:`CH${a+1} was renamed from "${e.getVoice(...e.getChPrimitives(a,!0),e.getChMode(a))?.name}" to "${e.getChCvnString(a)}".`})}}).add([100,76,32],(r,l,h)=>{e.switchMode("cs6x");let a=0,i=r[0],n=e.#w[a];switch(n){case e.EXT_DX:{r.length>2&&console.debug(r),r.subarray(1).forEach((c,d)=>{let f=d+i;if(f<6){let g=f+142;e.setChCc(a,g,c),c!==64&&e.allocateAce(a,g)}else if(f<12){let g=f+144;e.setChCc(a,g,c),c!==64&&e.allocateAce(a,g)}else([()=>{},()=>{},()=>{},()=>{}][f]||(()=>{}))()});break}case e.EXT_VL:{console.info(`Support for Modular System Plug-in writes is not yet present for plugin type ${n}.`);break}default:console.warn(`Unsupported plug-in type: ${n}`)}}),this.#Y.add([0,72,18,0,0,0,0],(r,l,h)=>{e.switchMode("sd",!0),e.setPortMode(e.getTrackPort(l),2,w.sd),console.info("MIDI reset: SD")}).add([0,72,18,16,0],(r,l,h)=>{e.dispatchEvent("mupromptex");let a=r[0]>>5,i=r[0]&31;switch(a){case 0:{let n=r[0]>>1,c=r[1];switch(n){case 1:{r.subarray(2).forEach((d,f,g)=>{let v=f+c;switch(v){case 0:{d&&(e.setEffectType(1,60,d-1),e.dispatchEvent("efxchorus",e.getEffectType(1)),console.debug(`SD MFX Cho: ${v} - ${d}`));break}}});break}case 2:{r.subarray(2).forEach((d,f)=>{let g=f+c;switch(g){case 0:{d&&(e.setEffectType(0,55+d,0),e.dispatchEvent("efxreverb",e.getEffectType(0)),console.debug(`SD MFX Rev: ${g} - ${d}`));break}}});break}case 3:case 4:case 5:{let d=n-1;r.subarray(2).forEach((f,g)=>{let v=g+c;switch(console.debug(`SD MFX ${d-2}: ${v} - ${f}`),v){case 0:{e.setEffectTypeRaw(d,62,f),e.dispatchEvent(`efx${d>2?"delay":"insert"+(d-4)}`,e.getEffectType(d));break}}}),console.debug(`SD MFX message:
%o`,r);break}default:console.debug(`Unknown SD-90 global effects message:
%o`,r)}break}case 1:{let n=e.chRedir(i,l,!0),c=r[1],d=S[n];r.subarray(2).forEach((f,g)=>{let v=c+g;v<37?([()=>{},()=>{},0,()=>{},()=>{switch(f){case 104:case 105:case 106:case 107:case 120:{e.#i[n]||e.setChType(n,e.CH_DRUMS);break}default:e.#i[n]&&e.setChType(n,e.CH_MELODIC)}e.setChCc(n,0,f),e.pushChPrimitives(n),e.dispatchEvent("voice",{part:n})},()=>{e.#e[d+E[32]]=f,e.pushChPrimitives(n),e.dispatchEvent("voice",{part:n})},()=>{e.#r[n]=f,e.dispatchEvent("voice",{part:n})},()=>{e.#e[d+E[7]]=f},()=>{e.#e[d+E[10]]=f},()=>{},()=>{},()=>{f<2&&(e.#g[n]=f)},()=>{f<2&&(e.#e[d+E[68]]=f?127:0)},()=>{},()=>{f<2&&(e.#e[d+E[65]]=f?127:0)},()=>{e.#e[d+E[5]]=f&15<<4|e.#e[d+E[5]]&15},()=>{e.#e[d+E[5]]=f&15|(e.#e[d+E[5]]&240)>>4},()=>{e.#e[d+E[74]]=f},()=>{e.#e[d+E[71]]=f},()=>{e.#e[d+E[73]]=f},()=>{e.#e[d+E[72]]=f},0,0,0,0,0,0,0,()=>{e.#e[d+E[128]]=f,e.allocateAce(128)},()=>{e.#e[d+E[93]]=f},()=>{e.#e[d+E[91]]=f},0,0,()=>{e.#e[d+E[75]]=f},()=>{e.#e[d+E[76]]=f},()=>{e.#e[d+E[77]]=f},()=>{e.#e[d+E[78]]=f}][v]||(()=>{}))():v<63||(v<64?(e.#i[n]?(e.#e[d+E[0]]=104|f,e.pushChPrimitives(n),e.dispatchEvent("voice",{part:n})):(e.#e[d+E[0]]=96|f,e.pushChPrimitives(n),e.dispatchEvent("voice",{part:n})),e.dispatchEvent("voice",{part:n})):console.debug(`Unknown SD-90 global CH${n+1} param setup message:
%o`,r))});break}case 2:{let n=e.chRedir(i,l,!0),c=r[1];console.debug(`Unknown SD-90 global CH${n+1} MIDI setup message:
%o`,r.subarray(2));break}default:console.warn(`Unknown SD-90 global part setup message:
%o`,r)}}),e.#ae.add([0,1,73,78],(r,l,h)=>{e.switchMode("krs"),e.setPortMode(e.getTrackPort(l),1,w.krs),console.debug("Might be KORG KROSS 2 mode reset... Not sure.")}).add([0,1,73,117,2,37],(r,l,h)=>{e.switchMode("krs");let a=e.getTrackPort(l);if(e.#x[a]&&e.#x[a]!==w.krs)if(e.#d.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled. Port ${String.fromCharCode(65+a)} mode "${R[e.#x[a]]}" mismatch, should be "krs".`);return}else console.info(`Track ${l} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+a)}.`);e.setPortMode(e.getTrackPort(l),1,w.krs);let i="KROSS 2 BMT1 ",n="";N(r,(c,d)=>{if(d<24)n+=String.fromCharCode(Math.max(32,c));else if(!(d<1276)){let f=d-1276,g=e.chRedir(Math.floor(f/44),l,!0),v=f%44,C=S[g];v<15?([()=>{c&&e.setChActive(g,1),e.#r[g]=c,e.dispatchEvent("voice",{part:g})},()=>{c&&e.setChActive(g,1),c<10?(e.#e[C+E[0]]=63,e.#e[C+E[32]]=c):c<20?(e.#e[C+E[0]]=121,e.#e[C+E[32]]=c-10):c<24&&(e.#e[C+E[0]]=[120,0,56,62][c-20],e.#e[C+E[32]]=0),e.pushChPrimitives(g),e.dispatchEvent("voice",{part:g})},()=>{let $=e.chRedir(c&15,l,!0);e.#c[g]=$,console.info(`${i}CH${g+1} receives from CH${$+1}`)},!1,!1,()=>{e.#e[C+E[7]]=c},!1,()=>{},()=>{},!1,!1,!1,!1,!1,()=>{e.#e[C+E[10]]=c||128}][v]||(()=>{}))():v<36||([()=>{e.#e[C+E[74]]=(c+128&255)-64},()=>{e.#e[C+E[71]]=(c+128&255)-64},!1,!1,()=>{e.#e[C+E[73]]=(c+128&255)-64},()=>{e.#e[C+E[75]]=(c+128&255)-64},!1,()=>{e.#e[C+E[72]]=(c+128&255)-64}][v]||(()=>{}))()}}),n=n.trimRight(),e.dispatchEvent("metacommit",{type:"EORTitle",data:n})})}};var ve=xe(me(),1);var We=class{#t=!1;constructor(e,t,s,o){this.#t=e,this.start=t,this.end=s,this.data=o}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#t}},ye=class extends We{constructor(e,t,s){super(!0,e,t,s)}},qe=class extends We{constructor(e,t){super(!1,e,e,t)}},Ee=class extends Array{#t=-1;constructor(){super(...arguments)}resetIndex(e){this.#t=-1}fresh(){this.sort(function(e,t){return e.start==t.start?0:(+(e.start>t.start)<<1)-1}),this.forEach(function(e,t){e.index=t})}step(e,t=!1){let s=[];if(t)for(let o=0;o<this.length&&!(this[o].start>e);o++){if(this[o].end<e)continue;s.push(this[o])}else{let o=this.getRange(this.#t==-1?0:e-1,e),u=this;o.forEach(function(p){p.index>u.#t&&(s.push(p),u.#t=p.index)})}return s}getRange(e,t){e>t&&([e,t]=[t,e]);let s=[],o=-1,u=Math.ceil(Math.sqrt(this.length)),p=!0;for(let m=0;m<this.length;m+=u)this[m+u]?o<0&&this[m+u].start>=e&&(o=m):o=o<0?m:o;for(;p;)this[o]?.end<t?this[o].start>=e&&s.push(this[o]):p=!1,o++;return s}};var Rt=0xffffffffffff,Qe=function(e){let t=new Ee,s=this,o=e.timeDivision,u=120,p=new Ee,m=0,y=0;p.push(new ye(0,Rt,[120,0])),e.track.forEach(function(a){m=0,a.event.forEach(function(i){m+=i.deltaTime,i.type===255&&i?.metaType===81&&(u=6e7/i.data,p[p.length-1]&&p.push(new ye(m,0xffffffffffff,[u,0])))})}),p.fresh(),p.forEach(function(a,i,n){i>0&&(n[i-1].end=a.start)});let r=120;p.forEach(function(a,i,n){i>0&&(a.end===a.start?n.splice(n.indexOf(a),1):r===a.data[0]&&(n[i-1].end=a.end,n.splice(n.indexOf(a),1)),r=a.data[0])});let l=0,h=120;return p.forEach(function(a){let i=a.start,n=i/h/o*60+l;h=a.data[0],l=n-i/h/o*60,a.data[1]=l}),console.debug("All tempo changes: ",p),u=120,m=0,y=0,e.track.forEach(function(a,i){m=0,y=0;let n=i+1;a.event.forEach(function(c,d){m+=c.deltaTime;let f=p.step(m,!0)[0];f&&(u=f.data[0],y=f.data[1]);let g={type:c.type,data:c.data,track:n,part:0};c.type>14?g.meta=c.metaType:g.part=c.channel,t.push(new qe(m/u/o*60+y,g))})}),t.fresh(),self.midiEvents=t,console.debug(`Parsed a type ${e.formatType} MIDI sequence.`),t};ve.default.customInterpreter=Ve;var M=function(e,t,s){e.addEventListener(s,o=>{t.dispatchEvent(s,o.data)})},Ze=class extends ee{device;#t;#p={};#C=[];#S="";#k=[];#u=[];#c=new Uint8ClampedArray(128);#i=new Uint8ClampedArray(128);#e=.5;#m=120;#r=4;#b=4;#g=0;#h=0;#l=new Array(b.ch);#$=new Uint8Array(b.ch);smoothAttack=0;smoothDecay=0;reset(){let e=this;e.dispatchEvent("reset"),e.#t?.resetIndex(),e.device.init(),e.#S="",e.#e=.5,e.#m=120,e.#r=4,e.#b=4,e.#g=0,e.#h=0,e.dispatchEvent("tempo",e.#m),e.dispatchEvent("title",e.#S)}init(){this.reset(),this.#t=void 0}async loadFile(e){this.#t=Qe(ve.default.parse(new Uint8Array(await e.arrayBuffer())))}async loadMap(e,t,s){let o=this,u=0,p=0,m=0,y=0,r,l;e.split(`
`).forEach((h,a)=>{if(!h)return;let i=h.split("	");if(a){if(!y)return;let n="",c="";i.forEach((f,g)=>{switch(g){case r:{n=f;break}case l:{c=f;break}}});let d=!1;o.#p[n]?.priority>s&&(d=!0,m++),!o.#p[n]||d||t?(o.#p[n]={name:c,priority:s},u++):self.debugMode&&console.debug(`Voice "${c}" (${n}) seems to be in conflict with (${o.#p[n]}).`),p++}else i.forEach((n,c)=>{switch(n){case"ID":{r=c,y++;break}case"Name":{l=c,y++;break}default:console.debug(`Unknown map field: ${n}`)}})}),console.debug(`Voice names: ${p} total, ${u} loaded (${u-m} + ${m}).`),o?.device.forceVoiceRefresh()}async loadMapPaths(e){let t=this;e.forEach(async(s,o)=>{t.loadMap(await(await fetch(s)).text(),0,o)})}async loadEfx(e,t){let s=this,o=0,u=0,p,m,y;e.split(`
`).forEach((r,l)=>{if(r)if(l){let h=0,a;r.split("	").forEach((i,n)=>{switch(n){case p:{h|=(parseInt(i,16)&255)<<8;break}case m:{h|=parseInt(i,16)&255;break}case y:{a=i;break}}}),!s.#C[h]||t?(s.#C[h]=a,o++):self.debugMode&&console.debug(`EFX ID 0x${h.toString(16).padStart(4,"0")} (${a}) seems to be in conflict.`),u++}else r.split("	").forEach((h,a)=>{switch(h){case"MSB":{p=a;break}case"LSB":{m=a;break}case"Name":{y=a;break}default:console.debug(`Unknown EFX field: ${h}`)}})}),console.debug(`EFX: ${u} total, ${o} loaded.`),s.dispatchEvent("efxreverb",s.device.getEffectType(0)),s.dispatchEvent("efxchorus",s.device.getEffectType(1)),s.dispatchEvent("efxdelay",s.device.getEffectType(2)),s.dispatchEvent("efxinsert0",s.device.getEffectType(3)),s.dispatchEvent("efxinsert1",s.device.getEffectType(4)),s.dispatchEvent("efxinsert2",s.device.getEffectType(5)),s.dispatchEvent("efxinsert3",s.device.getEffectType(6))}async loadModels(e,t){let s=this,o=0,u=0}async loadStyles(e,t){let s=this,o=0,u=0}switchMode(e,t=!1){this.device.switchMode(e,t)}getMode(){return this.device.getMode()}getVoice(){return this.device.getVoice(...arguments)}getChVoice(e){return this.device.getChVoice(e)}getChPrimitive(e,t,s){return this.device.getChPrimitive(e,t,s)}getChPrimitives(e,t){return this.device.getChPrimitives(e,t)}getMapped(e){return this.#p[e]?.name||e}getEfx([e,t]){let s=e<<8|t;return this.#C[s]||`0x${s.toString(16).padStart(4,"0")}`}getVoxBm(e){if(!e)throw new Error("Voice object must be valid");let t=this;if(!t.voxBm)throw new Error("Voice bitmap repository isn't yet initialized");let s=t.voxBm.getBm(e.name);if(!s)switch(e.mode){case"xg":{switch(e.sid[0]){case 0:case 80:case 81:case 83:case 84:case 96:case 97:case 99:case 100:{s=t.voxBm.getBm(t.getVoice(U.bank0,e.sid[1],U.bank0,e.mode).name);break}}break}case"g2":case"sd":{switch(e.sid[0]){case 96:case 97:case 98:case 99:{s=t.voxBm.getBm(t.getVoice(U.bank0,e.sid[1],U.bank0,e.mode).name);break}case 104:case 105:case 106:case 107:{s=t.voxBm.getBm(t.getVoice(120,e.sid[1],U.bank0,e.mode).name);break}}break}case"gs":case"sc":case"k11":case"sg":case"gm":{switch(e.sid[0]){case 120:break;case 122:case 127:{s=t.voxBm.getBm(t.getVoice(120,e.sid[1],0,e.mode).name);break}default:s=t.voxBm.getBm(t.getVoice(0,e.sid[1],0,e.mode).name)}break}default:switch(e.sid[0]){case 56:{s=t.voxBm.getBm(t.getVoice(0,e.sid[1],0,e.mode).name);break}}}return s||(s=t.voxBm.getBm(t.getVoice(e.sid[0],e.sid[1],0,e.mode).name)),s}getChBm(e,t){let s=this;t=t||s.getChVoice(e);let o=s.getVoxBm(t);if(!o){if(!s.sysBm)return;switch(t.mode){case"xg":{switch(t.sid[0]){case 126:{t.sid[1]>>1===56&&(o=s.sysBm.getBm("cat_smpl"));break}case 16:{o=s.sysBm.getBm("cat_smpl");break}case 64:case 67:{o=s.sysBm.getBm("cat_sfx");break}case 32:case 33:case 34:case 35:case 36:case 48:case 82:{o=s.sysBm.getBm("cat_xg");break}}break}default:switch(t.sid[0]){case 63:case 32:case 33:case 34:case 35:case 36:case 48:case 82:{o=s.sysBm.getBm("cat_mex");break}}}}return o||(s.device.getChType()[e]?o=s.sysBm.getBm("cat_drm"):o=s.sysBm.getBm("no_vox")),o}get noteProgress(){return this.#h/this.#e}get noteOverall(){return this.noteProgress-this.#g}get noteBar(){return Math.floor(this.noteOverall/this.#r)}get noteBeat(){let e=this.noteOverall%this.#r;return e<0&&(e+=this.#r),e}get noteOffset(){return this.#g}getTimeSig(){return[this.#r,this.#b]}getTempo(){return this.#m}eachVoice(e){this.#l.forEach(e)}sendCmd(e){this.device.runJson(e)}render(e){e>this.#h&&(this.#h=e);let t=this.#t?.step(e)||[],s=0,o=0,u=new Set,p={},m=[],y=this,r=[];for(y.device.getStrength().forEach(($,x)=>{y.#i[x]=$}),y.device.newStrength(),t.forEach(function($){let x=$.data,P=y.device.runJson(x);switch(P?.reply){case"meta":{r.push(P);break}}P?.reply&&delete P.reply});y.#u.length>0;){let $=y.#u.shift(),x=$.part<<7|$.note;$.state?(u.add(x),p[x]=$.velo):u.has(x)&&(m.push({part:$.part,note:$.note,velo:p[x],state:y.device.NOTE_SUSTAIN}),s++,o+=y.#$[$.part])}r?.length>0&&y.dispatchEvent("meta",r);let l=y.device.getActive(),h=[],a=y.device.getPitch(),i=y.device.getCcAll(),n=y.device.getProgram(),c=y.device.getChType(),d=[],f=y.device.getStrength();f.forEach(function($,x,P){P[x]=Math.max(y.#i[x],$);let V=P[x]-y.#c[x];if(V>=0){let A=4*.25**(y.device.getChCc(x,73)/64);y.#c[x]+=Math.ceil(V-V*y.smoothAttack**A)}else{let A=4*.25**(y.device.getChCc(x,72)/64);y.#c[x]+=Math.floor(V-V*y.smoothDecay**A)}});let g=0,v=0;return l.forEach(function($,x){$&&(h[x]=y.device.getVel(x),d[x]=y.device.getExt(x),g+=h[x].size,v+=h[x].size*y.#$[x])}),{extraPoly:s,extraPolyEC:o,extraNotes:m,curPoly:g,curPolyEC:v,chInUse:l,chKeyPr:h,chPitch:a,chProgr:n,chContr:i,chType:c,chExt:d,eventCount:t.length,title:y.#S,bitmap:y.device.getBitmap(),letter:y.device.getLetter(),texts:y.device.getTexts(),master:y.device.getMaster(),mode:y.device.getMode(),strength:y.#c.slice(),velo:f,rpn:y.device.getRpn(),tSig:y.getTimeSig(),tempo:y.getTempo(),noteBar:y.noteBar,noteBeat:y.noteBeat,ace:y.device.getAce(),rawVelo:y.device.getStrength(),rawStrength:y.device.getRawStrength(),rawPitch:y.device.getRawPitch(),efxSink:y.device.getEffectSink()}}constructor(e,t=.5,s=.5){super();let o=this;o.smoothAttack=t,o.smoothDecay=s,o.device=e,o.addEventListener("meta",function(u){u?.data?.forEach(function(p){(o.#k[p.meta]||console.debug).call(o,p.meta,p.data)})}),M(o.device,o,"mode"),M(o.device,o,"mastervolume"),M(o.device,o,"channelactive"),M(o.device,o,"channelmin"),M(o.device,o,"channelmax"),M(o.device,o,"portrange"),M(o.device,o,"portstart"),M(o.device,o,"channelreset"),M(o.device,o,"channeltoggle"),M(o.device,o,"screen"),M(o.device,o,"metacommit"),M(o.device,o,"voice"),M(o.device,o,"pitch"),M(o.device,o,"note"),M(o.device,o,"reset"),M(o.device,o,"banklevel"),M(o.device,o,"efxreverb"),M(o.device,o,"efxchorus"),M(o.device,o,"efxdelay"),M(o.device,o,"efxinsert0"),M(o.device,o,"efxinsert1"),M(o.device,o,"efxinsert2"),M(o.device,o,"efxinsert3"),M(o.device,o,"partefxtoggle"),M(o.device,o,"chmode"),o.addEventListener("note",function({data:u}){o.#u.push(u)}),o.addEventListener("voice",({data:u})=>{let p=o.getChVoice(u.part);o.#l[u.part]=p,o.#$[u.part]=p.poly??1}),o.addEventListener("reset",({data:u})=>{o.#$.fill(1)}),o.#$.fill(1),o.#k[3]=function(u,p){o.#S?.length<1&&(o.#S=p,o.dispatchEvent("title",o.#S))},o.#k[81]=function(u,p){let m=o.noteProgress,y=o.#e||.5;o.#m=6e7/p,o.#e=p/1e6,o.#g+=m*(y/o.#e)-m,o.dispatchEvent("tempo",o.#m)},o.#k[88]=function(u,p){let m=o.noteProgress,y=o.noteOverall,r=o.noteBar,l=o.noteBeat,h=o.#r,a=o.#b;o.#r=p[0],o.#b=1<<p[1];let i=24*(32/p[3])/p[2];if(h!==o.#r){let n=r;o.#g-=n*(o.#r-h),l+1>=h&&(h<o.#r?o.#g-=Math.ceil(o.#r-l-1):o.#g+=o.#r)}o.dispatchEvent("tsig",o.getTimeSig())}}};var Pt=class extends EventTarget{static sleep(e){return new Promise(t=>{self.AbortSignal?AbortSignal.timeout(e).addEventListener("abort",t):setTimeout(t,e)})}#t;#p;#C=!1;get finished(){return this.#C}finish(){this.#C=!0,this.#p&&this.#p()}wait(){if(!this.#C)return this.#t}constructor(){super(),this.#t=new Promise(e=>{this.#p=()=>{this.#C=!0,e()}})}},Je=Pt;var we=new Uint8Array(40),j=0,Ce,Na=setInterval(()=>{Ce&&(we[j]=!we[j],j++,j>34&&(j=0))},1e3/50);Uint8Array.prototype.render=function(e){let t=0,s=0,o=this.width||5,u=this.height||8;for(let p=0;p<this.length;p++)e(this[p],t,s,this),t++,t>=o&&(t=0,s++)};var je=class{#t=[];loaded=new Je;async load(e,t=!1,s="(internal)"){let o=this,u=0,p=0;console.debug(`Font "${s||"(internal)"}": loading started.`),e.split(`
`).forEach(function(m,y){if(y>0&&m?.length>0){let r=m.split("	"),l=parseInt(r[0],16);if(p++,o.#t[l]&&!t)return;let h=new Uint8Array(40);Array.from(r[1]).forEach(async function(a,i){let n=i&1?4:0,c=i>>1,d=parseInt(a,16),f=3;for(;d>0||f>=0;){let g=(n+f)*5+c;h[g]=d&1,d=d>>1,f--}}),h.width=5,h.height=8,o.#t[l]=h,u++}}),o.loaded.finished||o.loaded.finish(),console.debug(`Font "${s||"(internal)"}": ${p} total, ${u} loaded.`)}async loadFile(e,t=!1){let s=this;console.debug(`Requested font file from "${e}".`),await s.load(await(await fetch(e)).text(),t,e),Ce=!1}constructor(...e){Ce=!0,(async()=>{for(let t=0;t<e.length;t++)await this.loadFile(e[t])})()}getCP(e){return this.#t[e]}getStr(e){let t=[],s=this;return Array.from(e).forEach(function(o){t.push(s.#t[o.charCodeAt(0)]||s.#t[32]||we)}),t}keys(){return Object.keys(this.#t)}data(e){return this.#t[e]}};var se=16/9,ne=64,_=new Float64Array(49),At="Vx,Dr,D1,D2,D3,D4,D5,D6,D7,D8".split(","),Dt=[1,3,6,8,10],et=[0,.5,1,1.5,2,3,3.5,4,4.5,5,5.5,6],Lt=2*Math.PI,Ot={"?":"Unset",gm:"General MIDI",g2:"General MIDI 2",xg:"Yamaha XG",gs:"Roland GS",sc:"Roland GS",mt32:"Roland MT-32",doc:"Yamaha DOC",qy10:"YAMAHA QY10",qy20:"YAMAHA QY20",sd:"Roland SD",x5d:"Korg X5D","05rw":"Korg 05R/W",ns5r:"Korg NS5R",k11:"Kawai K11",sg:"Akai SG",krs:"Korg KROSS 2",s90es:"Yamaha S90 ES",cs6x:"Yamaha CS6x",motif:"Yamaha Motif ES"},It={Copyrite:"Copyright","Cmn.Text":"Text","C.Lyrics":"Lyrics","C.Marker":"Marker",CuePoint:"Cue Point",Instrmnt:"Instrument","Kar.Info":"Kar. Info","Kar.Mode":"Karaoke","Kar.Lang":"Language",KarTitle:"Kar. Title",KarLyric:"Kar. Lyrics","Kar.Ver.":"Kar. Version",SGLyrics:"SG Lyrics",TrkTitle:"Title",EORTitle:"Real Title",OSysMeta:"Octavia Sys.",XfSngDte:"XF Date",XfSngRgn:"XF Region",XfSngCat:"XF Category",XfSongBt:"XF Beat",XfSngIns:"XF Instr.",XfSngVoc:"XF Vocalist",XfSngCmp:"XF Compose",XfSngLrc:"XF Lyricist",XfSngArr:"XF Arranger",XfSngPer:"XF Perform.",XfSngPrg:"XF Program.",XfSngTag:"XF Tags",XfKarLng:"XF Lang.",XfKarNme:"XF Name",XfKarCmp:"XK Compo.",XfKarLrc:"XK Lyricist",XfKarArr:"XK Arranger",XfKarPer:"XK Perform.",XfKarPrg:"XK Program.",XfScneNo:"XF Scene #",XfMeloCh:"XF Melody",XfLyrOff:"XL Offset",XfLyrEnc:"XL Lang.",XfSngPrt:"XL Part",YMCSSect:"Section Ctrl.",YStyleId:"Active Style"},Nt=["XfSongBt","XfSngIns","XfSngVoc","XfLyrOff","XfSngRgn","ChordCtl","RhrslMrk"],ke=[[],[4,2],[3,2]],Ut=[{l:0,t:0},{l:0,t:416},{l:960,t:0},{l:960,t:416}],tt={none:{font4:[0,0],cfont4:[0,0],font7:[0,0]},macos:{font4:[2,0],cfont4:[1,0],font7:[0,0]},chromium:{font4:[1,0],cfont4:[0,0],font7:[1,0]}},ce={xg:["9efaa0","006415"],doc:["9efaa0","006415"],qy10:["9efaa0","006415"],qy20:["9efaa0","006415"],ns5r:["9efaa0","006415"],x5d:["9efaa0","006415"],"05rw":["9efaa0","006415"],k11:["9efaa0","006415"],s90es:["9efaa0","006415"],motif:["9efaa0","006415"],cs6x:["9efaa0","006415"],gm:["a1f3ff","005e88"],g2:["a1f3ff","005e88"],krs:["a1f3ff","005e88"],gs:["ffe1a5","804e00"],sc:["ffe1a5","804e00"],mt32:["ffe1a5","804e00"],sd:["ffe1a5","804e00"],sg:["ffdddd","990022"]};_.forEach((e,t,s)=>{s[t]=Math.PI*t/12});var k=function(e,t,s={}){let o=document.createElement(e);t?.forEach(h=>{o.classList.add(h)});let{t:u,l:p,w:m,h:y,i:r,a:l}=s;return u?.constructor&&(o.style.top=u?.length?u:`${u}px`),p?.constructor&&(o.style.left=p?.length?p:`${p}px`),m?.constructor&&(o.style.width=m?.length?m:`${m}px`),y?.constructor&&(o.style.height=y?.length?y:`${y}px`),r?.constructor&&o.appendChild(document.createTextNode(r)),l?.constructor&&(o.style.textAlign=l),o};var D=function(e,t){t?.forEach(s=>{e.appendChild(s)})},B=function(e,t){t.forEach(s=>{e.classList.contains(s)&&e.classList.remove(s)})},H=function(e,t){t.forEach(s=>{e.classList.contains(s)||e.classList.add(s)})},Bt=new Array(128).fill(0);Bt.forEach((e,t,s)=>{s[t]=Math.floor(24*t/12.7)/10});var Vt=new Array(128).fill(0);Vt.forEach((e,t,s)=>{s[t]=Math.abs(Math.round(48*(t-64)/12.7)/10)});var rt=new Array(11).fill(null);rt.forEach((e,t,s)=>{s[t]=`${Math.round(t*12/.0128)/100}%`});var Xt=new Array(128).fill(null);Xt.forEach((e,t,s)=>{s[t]=`${Math.round(t/1.27)/100}`});var at=function(e,t){e.innerText=t,e.rNew=!0;let s=e.measureText(t);e.rWidth=s.width};HTMLElement.prototype.setTextRaw=function(e){let t;this.childNodes[0]?.nodeType===3?(t=this.childNodes[0],t.data=e):(t=document.createTextNode(e),this.prepend(t))};var Ha=class extends Ze{#t=16;#p=32;#C=128;#S=!1;#k="";#u;#c=0;#i=0;#e=0;#m=0;#r=0;#b;#g=0;#h=!1;#l=b.invalidCh;#$=1;#O=0;#Q=0;#w=0;#s=new Uint8Array(1280);#o=new Uint8Array(1280);#Z=new Uint8Array(1280);#P=new Uint8Array(512);#B=new Uint8Array(512);#R=new Uint8Array(512);#J=new Uint8Array(b.ch);#H;#x;#G;#y;#L;#z="fcdaff";#I=new Array(b.ch);#A=new Array(b.ch);#M="ffffff";#K="?";#a={};#n={};#d=[];#v={};#f={};eventViewMode=0;useElementCount=!0;#W=[];#F="comb";glyphs=new je;panStyle=11;#j(e,t,s,o=0,u=0,p){let m=this,{width:y,height:r}=e.canvas,l,h,a,i,n=m.#$,c=0,d=Dt.indexOf(t%12)>-1;switch(o){case m.device.NOTE_HELD:case m.device.NOTE_SOSTENUTO_SUSTAIN:case m.device.NOTE_SOSTENUTO_HELD:{c=1;break}case m.device.NOTE_MUTED_RECOVERABLE:{c=2;break}}switch(m.#F){case"block":case"comb":{l=Math.round(t*y/128),h=Math.round((t+1)*y/128),a=h-l,i=n===1?2:1;break}case"piano":{l=Math.round((Math.floor(t/12)*7+et[t%12])*y/75*1.0044642857142856),h=Math.round((Math.floor(t/12)*7+et[t%12]+1)*y/75*1.0044642857142856)-1,a=h-l,i=n===1?3:1;break}case"line":{let f=t-u;Math.abs(u)>2&&(f=t-Math.sign(u)*2),h=Math.round((t+.5)*y/128),l=Math.round((f+.5)*y/128)}default:}switch(e.fillStyle=`#${d?m.getChAccent(p):m.#M}${(s<<1|s>>6).toString(16).padStart(2,"0")}`,e.strokeStyle=e.fillStyle,e.lineWidth=n===1?4:2,e.lineDashOffset=0,m.#F){case"block":{let f=e.canvas.height-1;e.fillRect(l,0,a,f),c>0&&e.clearRect(l+i,i,a-(i<<1),f-(i<<1)),c===2&&e.clearRect(l,i<<1,a,f-(i<<2));break}case"comb":{let f=(d?Math.round((e.canvas.height<<1)/3):e.canvas.height)-1;e.fillRect(l,0,a,f),c>0&&e.clearRect(l+i,i,a-(i<<1),f-(i<<1)),c===2&&e.clearRect(l,i<<1,a,f-(i<<2));break}case"piano":{let f=d?0:e.canvas.height>>1,g=(e.canvas.height>>1)-1;e.fillRect(l,f,a,g),c>0&&e.clearRect(l+i,f+i,a-(i<<1),g-(i<<1)),c===2&&e.clearRect(l,f+(i<<1),a,g-(i<<2));break}case"line":{if(c===1)switch(n){case 4:{e.setLineDash(ke[2]);break}default:e.setLineDash(ke[1])}else e.setLineDash(ke[0]),n!==4&&self?.document?.mozFullScreen&&(l+=.5,h+=.5);e.beginPath(),e.moveTo(l,(n===4||!c)&&self?.document?.mozFullScreen?1:0),e.lineTo(h,(r>>1)+1),e.lineTo(l,r),e.stroke();break}default:}}#ee(e,t){let s=this;(e?.chInUse||t).forEach((o,u)=>{if(o){let p=s.#d[u>>4][u&15].cxt;p.clearRect(0,0,p.canvas.width,p.canvas.height),e.chKeyPr[u].forEach(({v:m,s:y},r)=>{s.#j(p,r,m,y,s.device.getPitchShift(u),u)})}})}#ce(e){let t=this;Date.now()-t.#c>4e3&&(t.#i=0,t.#e=142-t.#v.view.clientHeight,(t.#u?.clientWidth||0)>840&&(t.#i=840-t.#u.clientWidth),t.#v.view.style.transform=`translateX(${t.#i}px) translateY(${t.#e}px)`,e&&(t.#c=0))}#re(){let e=self.innerWidth/self.innerHeight,t=1,s=self.innerWidth,o=self.innerHeight;e>=se?(t=Math.min(Math.round(self.innerHeight/1080*1e4)/1e4,100),s=Math.ceil(self.innerHeight*se)):e<se&&(t=Math.min(Math.round(self.innerWidth/1920*1e4)/1e4,100),o=Math.ceil(self.innerWidth/se)),this.#G.style.width=`${s}px`,this.#G.style.height=`${o}px`,this.#y.style.transform=`scale(${t})`}#X;#te(){let e=this,t=e.#H?.currentTime||0,s=e.render(t),o=Date.now(),u=s.curPoly+s.extraPoly,p=s.curPolyEC+s.extraPolyEC;e.#m<u&&(e.#m=u),e.#r<p&&(e.#r=p),e.#a.curPoly.setTextRaw(`${e.useElementCount?p:u}`.padStart(3,"0")),e.#a.maxPoly.setTextRaw(`${e.useElementCount?e.#r:e.#m}`.padStart(3,"0")),e.#H?.realtime?(e.#a.barCount.setTextRaw("LINE"),e.#a.barDelim.style.display="none",e.#a.barNote.setTextRaw("IN")):(e.#a.barCount.setTextRaw(s.noteBar+1),e.#a.barDelim.style.display="",e.#a.barNote.setTextRaw(Math.floor(s.noteBeat)+1));let m=[7,11,1,91,93,94,74,5,256,256],y=e.#O+e.#$;for(let a=0;a<b.ch;a++){let i=a>>4,n=a*b.cc,c=a*b.ace,d=e.#d[i][a&15];if(visualizer.device.getActive()[a]&&i>=e.#O&&i<y){m[8]=s.ace[c+0]||256,m[9]=s.ace[c+1]||256,d.ccVis.clearRect(0,0,109,25),d.ccVis.fillStyle=`#${e.getChAccent(a)}`,d.ccVis.strokeStyle=`#${e.getChAccent(a)}`,d.ccVis.lineWidth=2;for(let g=0;g<m.length;g++){let v=m[g];if(v<256){let C=s.chContr[n+E[v]],$=C*24/127;if($>0){let x=24-$;d.ccVis.fillRect(g*6,x,4,$)}}}let f=s.chContr[n+E[10]]||1;switch(e.panStyle){case 7:case 6:case 5:case 3:case 2:case 1:{let g=(f+125)*.024933275,v=(f-64)*.024933275;d.ccVis.beginPath(),f>127?e.panStyle>>1&1&&(d.ccVis.arc(84.5,22.5,21.5,0,_[12],!0),d.ccVis.stroke()):(e.panStyle>>1&1&&(f<64?(d.ccVis.arc(84.5,22.5,21.5,_[18],g,!0),d.ccVis.stroke()):f>64&&(d.ccVis.arc(84.5,22.5,21.5,_[18],g),d.ccVis.stroke())),e.panStyle&1&&(d.ccVis.strokeStyle=`#${e.#M}`,d.ccVis.lineWidth=e.panStyle>>2?1:3,d.ccVis.beginPath(),d.ccVis.moveTo(84.5,22.5),f===64?d.ccVis.lineTo(84.5,4):d.ccVis.lineTo(84.5+18*Math.sin(v),22.5-18.5*Math.cos(v)),d.ccVis.stroke())),e.panStyle>>2&1&&(d.ccVis.fillStyle=`#${e.#M}`,d.ccVis.beginPath(),d.ccVis.arc(84.5,22.5,2.5,0,_[4]),d.ccVis.fill());break}case 11:case 10:case 9:{let g=(f+77)*.033244367,v=(f-64)*.033244367;d.ccVis.beginPath(),f>127?e.panStyle>>1&1&&(d.ccVis.arc(84.5,16.5,15.5,_[26],_[34],!0),d.ccVis.stroke()):(e.panStyle>>1&1&&(f<64?(d.ccVis.arc(84.5,16.5,15.5,_[18],g,!0),d.ccVis.stroke()):f>64&&(d.ccVis.arc(84.5,16.5,15.5,_[18],g),d.ccVis.stroke())),e.panStyle&1&&(d.ccVis.strokeStyle=`#${e.#M}`,d.ccVis.lineWidth=3,d.ccVis.beginPath(),d.ccVis.moveTo(84.5,16.5),f===64?d.ccVis.lineTo(84.5,4):d.ccVis.lineTo(84.5+11.5*Math.sin(v),16.5-11.5*Math.cos(v)),d.ccVis.stroke())),(!(e.panStyle&1)||f>>7)&&(d.ccVis.fillStyle=`#${e.#M}`,d.ccVis.beginPath(),d.ccVis.arc(84.5,16.5,2.5,0,_[24]),d.ccVis.fill());break}default:{let g=Math.abs(f-64)/2.625;f<64?d.ccVis.fillRect(84-g,0,g,24):f>127?(d.ccVis.fillRect(60,0,49,24),d.ccVis.clearRect(61,1,47,22)):d.ccVis.fillRect(85,0,g,24),d.ccVis.fillStyle=`#${e.#M}`,d.ccVis.fillRect(84,0,1,24)}}if(d.metre.clearRect(0,0,121,25),d.metre.fillStyle=`#${e.#M}`,d.metre.globalCompositeOperation="source-over",d.metre.rWidth>d.metre.canvas.width){d.metre.rNew&&(d.metre.rNew=!1,d.metre.rOffset=t);let g=t-(d.metre.rOffset||0),v=32,C=d.metre.rWidth-d.metre.canvas.width+v,$=g*-25%(d.metre.rWidth+v+48)+48;$>0&&($=0),d.metre.fillText(d.metre.innerText,$,3+e.#L.cfont4[0]),Math.abs($)>C&&d.metre.fillText(d.metre.innerText,$+d.metre.rWidth+v,3+e.#L.cfont4[0])}else d.metre.fillText(d.metre.innerText,0,3+e.#L.cfont4[0]);switch(d.metre.globalCompositeOperation="xor",d.metre.fillRect(0,0,s.strength[a]*121/255,25),d.extVis.clearRect(0,0,47,25),d.extVis.fillStyle=`#${e.#M}`,s.chExt[a][0]){case e.device.EXT_VL:{let g=(s.chContr[n+E[136]]-64)/64||s.rawPitch[a]/8192;g=g*-4+4;let v=+(s.rawVelo[a]>0||s.chContr[n+E[1]]>0)*(s.chContr[n+E[129]]*s.chContr[n+E[11]]/16129);!v&&s.rawStrength[a]&&(v=s.rawStrength[a]*s.chContr[n+E[11]]/16129),v*=32;let C=s.chContr[n+E[1]]/127*8;d.extVis.beginPath(),d.extVis.moveTo(0,12-g-3),d.extVis.lineTo(7+v,12),d.extVis.lineTo(0,12+g+3),d.extVis.fill(),d.extVis.fillStyle=`#${e.getChAccent(a)}`,d.extVis.beginPath(),d.extVis.ellipse(43,12,4,4+C,0,0,Lt),d.extVis.fill();break}case e.device.EXT_DX:{s.chContr.subarray(n+E[142],n+E[157]+1).forEach((v,C)=>{C>=8&&(d.extVis.fillStyle=`#${e.getChAccent(a)}`);let $=C*3,x=(v-64)/5.82;x>=0?d.extVis.fillRect($,12-x,2,x+1):d.extVis.fillRect($,12,2,1-x)});break}}}}let r=new Array(b.ch);if(e.#d.forEach((a,i)=>{a.forEach((n,c)=>{n.refresh&&(n.refresh=!1,r[i<<7|c]=!0)})}),["line"].indexOf(e.#F)>-1)for(;e.#W.length>0;){let a=e.#W.shift();r[a.part]=!0}e.#ee(s,r),s.extraNotes.forEach(a=>{let{part:i,note:n,velo:c,state:d}=a,f=e.#d[i>>4][i&15].cxt;e.#j(f,n,c,d,e.device.getPitchShift(i),i)});let l=e.#f.cxt;if(o>s.bitmap.expire?e.#R.fill(0):s.bitmap.bitmap.length>256?s.bitmap.bitmap.forEach((a,i)=>{e.#R[i]=a?255:0}):s.bitmap.bitmap.forEach((a,i)=>{e.#R[i<<1]=a?255:0,e.#R[i<<1|1]=a?255:0}),e.#Z.fill(0),o<=s.letter.expire&&e.glyphs.getStr(s.letter.text).forEach((a,i)=>{let n=(i&15)*5,c=i>>4<<3;a.forEach((d,f)=>{let g=n+f%5,v=c+Math.floor(f/5);e.#Z[v*80+g]=d?255:0})}),e.#P.forEach((a,i,n)=>{let c=e.#R[i];c>a?n[i]+=Math.min(c-a,ne):c<a&&(n[i]-=Math.min(a-c,ne))}),e.#s.forEach((a,i,n)=>{let c=e.#Z[i];c>a?n[i]+=Math.min(c-a,ne):c<a&&(n[i]-=Math.min(a-c,ne))}),e.#P.forEach((a,i)=>{let n=i>>5,c=i&31;e.#B[i]!==a?(l.clearRect(252+(c<<2),n<<2,3,3),a&&(l.fillStyle=`#${e.#M}${a.toString(16).padStart(2,"0")}`,l.fillRect(252+(c<<2),n<<2,3,3))):T()&&(l.clearRect(252+(c<<2),n<<2,3,3),a&&(l.fillStyle=`#ff0000${a.toString(16).padStart(2,"0")}`,l.fillRect(252+(c<<2),n<<2,3,3)))}),e.#s.forEach((a,i)=>{let n=Math.floor(i/80),c=i%80;c+=Math.floor(c/5),e.#o[i]!==a?(l.clearRect(c<<2,(n|16)<<2,3,3),a&&(l.fillStyle=`#${e.#M}${a.toString(16).padStart(2,"0")}`,l.fillRect(c<<2,(n|16)<<2,3,3))):T()&&(l.clearRect(c<<2,(n|16)<<2,3,3),a&&(l.fillStyle=`#ff0000${a.toString(16).padStart(2,"0")}`,l.fillRect(c<<2,(n|16)<<2,3,3)))}),e.#B.forEach((a,i,n)=>{n[i]=e.#P[i]}),e.#o.forEach((a,i,n)=>{n[i]=e.#s[i]}),T()){l.clearRect(0,0,251,63);for(let a=0;a<=e.device.polyIndexLast;a++){let i=a&31,n=a>>5;if(a+1===e.device.polyIndexLatest)l.fillStyle="#ff0";else switch(e.device.getPolyState(a)){case e.device.NOTE_SUSTAIN:{l.fillStyle="#0f0";break}case e.device.NOTE_HELD:case e.device.NOTE_SOSTENUTO_HELD:{l.fillStyle="#0f7";break}case e.device.NOTE_SOSTENUTO_SUSTAIN:{l.fillStyle="#70f";break}case e.device.NOTE_MUTED_RECOVERABLE:{l.fillStyle="#f70";break}default:l.fillStyle="#f00"}l.fillRect(i<<2,n<<2,3,3)}}let h=(self.performance||self.Date).now();switch(e.eventViewMode){case 0:{e.#a.events.setTextRaw(`${s.eventCount}`.padStart(3,"0"));break}case 1:{let a=1e3/(h-e.#Q);a>99?(a=Math.round(a),e.#a.events.setTextRaw(`${a}`)):a>9?(a=Math.round(a*10)/10,e.#a.events.setTextRaw(`${Math.floor(a)}.${Math.floor(a*10%10)}`)):(a=Math.round(a*100)/100,e.#a.events.setTextRaw(`${Math.floor(a)}.${Math.floor(a*100%100)}`));break}case 2:{e.#a.events.setTextRaw(`${e.device.polyIndexLatest}`.padStart(3,"0"));break}default:e.#a.events.setTextRaw("???")}e.#Q=h}#se;#q;get style(){return this.#F}set style(e){let t=this;t.#F=e,t.#ee(t.render(t.#H?.currentTime||0)),B(t.#y,["cambiare-style-block","cambiare-style-comb","cambiare-style-piano","cambiare-style-line"]),H(t.#y,[`cambiare-style-${e}`])}getChMode(e=0,t){if(e>=b.ch)throw new RangeError("Invalid part number");let s=this;return t?s.#A[e]:s.#A[e]??s.#K}getChAccent(e=0){if(e>=b.ch)throw new RangeError("Invalid part number");let t=this;return t.#I[e]??t.#z}setClockSource(e){this.#H=e}setPixelProfile(e){let t=this;if(tt[e]){let s=tt[e];t.#L=s,t.#y&&(t.#y.style.setProperty("--pcp-font4",`translate(${s.font4[1]}px, ${s.font4[0]}px)`),t.#y.style.setProperty("--pcp-font7",`translate(${s.font7[1]}px, ${s.font7[0]}px)`))}else throw new Error(`"${e}" is not a valid pixel correction profile`)}setMode(e){let t=this;t.#K=e,t.#z=(ce[e]||["fcdaff","742b81"])[t.#w];for(let s of t.#y.classList)s.substring(0,14)==="cambiare-mode-"&&t.#y.classList.remove(s);e!=="?"&&t.#y.classList.add(`cambiare-mode-${e}`)}setChMode(e,t){let s=this;s.#A[e]=t;let o=s.#d[e>>4][e&15];for(let u of o.root.classList)u.substring(0,10)==="part-mode-"&&o.root.classList.remove(u);t!=="?"&&o.root.classList.add(`part-mode-${t}`)}setScheme(e=0){let t=this;t.#w=e?1:0,t.#M=["ffffff","000000"][t.#w],[B,H][t.#w](t.#y,["cambiare-scheme-light"]),t.#z=(ce[t.#K]||["fcdaff","742b81"])[t.#w];for(let s=0;s<b.ch;s++)if(t.device.getChActive(s)!==0&&t.#I[s]){let o=ce[t.#A[s]];o&&(t.#I[s]=o[t.#w])}}#V(e){let t=this,s=t.#$,o=t.#O;t.#d.forEach((u,p)=>{if(p>=o&&p<o+s){H(u.root,["port-active"]);let m=p-o,{l:y,t:r}=Ut[m*(4/s)];u.root.style.top=`${r}px`,u.root.style.left=`${y}px`,u.forEach((l,h)=>{l.root.style.top=`${h*(s>2?26:52)}px`})}else B(u.root,["port-active"]),u.root.style.top="",u.root.style.left="",u.forEach((m,y)=>{m.root.style.top=""});e&&u.forEach((m,y)=>{m.cxt.canvas.width=t.#$===1?1193:495,m.cxt.canvas.height=t.#$===4?26:52})})}setPort(e){let t=this;B(t.#y,["cambiare-start0","cambiare-start1","cambiare-start2","cambiare-start3","cambiare-start4","cambiare-start5","cambiare-start6","cambiare-start7"]),H(t.#y,[`cambiare-start${e}`]),t.#O=e,t.#V(!1)}setRange(e){let t=this;B(t.#y,["cambiare-port1","cambiare-port2","cambiare-port4","cambiare-compact"]),H(t.#y,[`cambiare-${e}`]),t.#$=parseInt(e.slice(4))||1,t.#V(!0)}setFrameTime(e=20){let t=this;t.#q?.constructor&&clearInterval(t.#q),e<5?e=5:e>500&&(e=500),t.#q=setInterval(t.#se,e),t.smoothingAtk=Math.pow(.1,e/20),t.smoothingDcy=Math.pow(.75,e/20)}attach(e){let t=this;t.#x=e;let s=k("div",["cambiare-container"]);e.appendChild(s),t.#G=s;let o=k("div",["cambiare-canvas","cambiare-port1","cambiare-start0","cambiare-style-block"]);s.appendChild(o),t.#y=o,self.addEventListener("resize",t.#X),t.#X(),t.setFrameTime(20),t.#a.root=k("div",["sect-info"]),t.#a.events=k("span",["field","pcp-font4"],{t:1,l:0,w:35,h:33}),t.#a.curPoly=k("span",["field","pcp-font4"],{t:1,l:52,w:35,h:33}),t.#a.maxPoly=k("span",["field","pcp-font4"],{t:1,l:98,w:35,h:33}),t.#a.sigN=k("span",["field","pcp-font4"],{t:1,l:194,w:23,h:33,a:"right"}),t.#a.sigD=k("span",["field","pcp-font4"],{t:1,l:232,w:23,h:33}),t.#a.barCount=k("span",["field","pcp-font4"],{t:1,l:304,w:35,h:33,a:"right"}),t.#a.barDelim=k("span",["field","field-label","pcp-font4"],{t:0,l:343,w:8,h:33,i:"/"}),t.#a.barNote=k("span",["field","pcp-font4"],{t:1,l:354,w:23,h:33}),t.#a.tempo=k("span",["field","pcp-font4"],{t:1,l:454,w:64,h:33,a:"right"}),t.#a.volume=k("span",["field","pcp-font4"],{t:1,l:562,w:63,h:33,a:"right"}),t.#a.mode=k("span",["field","pcp-font4"],{t:1,l:708,w:152,h:33}),t.#a.reverb=k("span",["field","pcp-font4"],{t:1,l:1e3,w:190,h:33}),t.#a.chorus=k("span",["field","pcp-font4"],{t:1,l:1240,w:190,h:33}),t.#a.delay=k("span",["field","pcp-font4"],{t:1,l:1475,w:190,h:33}),t.#a.insert=k("span",["field","pcp-font4"],{t:1,l:1706,w:190,h:33}),t.#a.title=k("span",["field","pcp-font4"],{t:35,l:50,w:810,h:33}),o.appendChild(t.#a.root),D(t.#a.root,[t.#a.events,t.#a.curPoly,k("span",["field","field-label","pcp-font4"],{t:1,l:89,w:5,h:33,i:":"}),t.#a.maxPoly,k("span",["field","field-key","pcp-font7"],{t:1,l:148,w:41,h:33,i:"TSig"}),t.#a.sigN,k("span",["field","field-label","pcp-font4"],{t:0,l:221,w:8,h:33,i:"/"}),t.#a.sigD,k("span",["field","field-key","pcp-font7"],{t:1,l:268,w:30,h:33,i:"Bar"}),t.#a.barCount,t.#a.barDelim,t.#a.barNote,k("span",["field","field-key","pcp-font7"],{t:1,l:390,w:61,h:33,i:"Tempo",a:"right"}),t.#a.tempo,k("span",["field","field-key","pcp-font7"],{t:1,l:528,w:29,h:33,i:"Vol"}),t.#a.volume,k("span",["field","field-label","pcp-font4"],{t:1,l:626,w:17,h:33,i:"%"}),k("span",["field","field-key","pcp-font7"],{t:1,l:652,w:52,h:33,i:"Mode"}),t.#a.mode,k("span",["field","field-key","pcp-font7"],{t:1,l:960,w:34,h:33,i:"Rev"}),t.#a.reverb,k("span",["field","field-key","pcp-font7"],{t:1,l:1198,w:36,h:33,i:"Cho"}),t.#a.chorus,k("span",["field","field-key","pcp-font7"],{t:1,l:1438,w:31,h:33,i:"Var"}),t.#a.delay,k("span",["field","field-key","pcp-font7"],{t:1,l:1673,w:27,h:33,i:"Ins"}),t.#a.insert,k("span",["field","field-key","pcp-font7"],{t:35,l:0,w:44,h:33,i:"Title"}),t.#a.title]),t.#n.root=k("div",["sect-mark"]),t.#n.left=k("div",["sect-mark-left","boundary"],{t:0,l:0}),t.#n.right=k("div",["sect-mark-right","boundary"],{t:0,l:960}),o.appendChild(t.#n.root),D(t.#n.root,[t.#n.left,t.#n.right]),D(t.#n.left,[k("span",["field","field-key"],{t:0,l:0,w:26,h:33,i:"CH"}),k("span",["field","field-key"],{t:0,l:30,w:49,h:33,i:"Voice"}),k("span",["field","field-key","mark-send-title"],{t:2,l:164,w:25,h:18,i:"Send"}),k("span",["field","field-label","mark-send-param"],{t:16,l:146,w:58,h:16,i:"VEMRCDBP12",a:"center"}),k("span",["field","field-key"],{t:0,l:212,w:35,h:33,i:"Pan"}),k("span",["field","field-key"],{t:0,l:256,w:45,h:33,i:"Note"})]),D(t.#n.right,[k("span",["field","field-key"],{t:0,l:0,w:26,h:33,i:"CH"}),k("span",["field","field-key"],{t:0,l:30,w:49,h:33,i:"Voice"}),k("span",["field","field-key","mark-send-title"],{t:2,l:164,w:25,h:18,i:"Send"}),k("span",["field","field-label","mark-send-param"],{t:16,l:146,w:58,h:16,i:"VEMRCDBP12",a:"center"}),k("span",["field","field-key"],{t:0,l:212,w:35,h:33,i:"Pan"}),k("span",["field","field-key"],{t:0,l:256,w:45,h:33,i:"Note"})]),t.#d.root=k("div",["sect-part"]);for(let u=0;u<b.ch>>4;u++){let p=u<<4;t.#d[u]=[],t.#d[u].root=k("div",["boundary",`part-port-${u}`]);for(let m=0;m<16;m++){let y=(p|m)+1;y>=100?y=`${Math.floor(y/10).toString(16)}${y%10}`:y=`${y}`.padStart(2,"0"),t.#d[u][m]={root:k("div",["boundary","part-channel"]),major:k("div",["boundary","part-info-major"]),minor:k("div",["boundary","part-info-minor"],{t:26}),keys:k("div",["boundary","part-keys"]),notes:k("div",["boundary","part-keyboard"]),cxt:k("canvas",["field"]).getContext("2d"),number:k("span",["field","field-label","pcp-font4"],{t:1,w:18,h:25,i:y}),voice:k("span",["field"],{l:22,t:1,w:121,h:25}),metre:k("canvas",["field"]).getContext("2d"),type:k("span",["field","field-label","pcp-font4"],{t:1,w:18,h:25}),std:k("span",["field","pcp-font4"],{l:22,t:1,w:20,h:25,a:"center"}),msb:k("span",["field","pcp-font4"],{l:48,t:1,w:27,h:25}),prg:k("span",["field","pcp-font4"],{l:81,t:1,w:27,h:25}),lsb:k("span",["field","pcp-font4"],{l:114,t:1,w:27,h:25}),ccVis:k("canvas",["field"],{l:145,t:1}).getContext("2d"),extVis:k("canvas",["field"],{l:207,t:1}).getContext("2d"),ccUpdate:!1};let r=t.#d[u][m];rt.forEach(l=>{r.notes.appendChild(k("span",["field","part-csplit"],{l}))}),r.notes.appendChild(k("span",["field","part-csplit","part-cdive"],{l:0,w:"100%",h:1})),r.metre.canvas.width=121,r.metre.canvas.height=25,r.metre.textBaseline="top",r.metre.font="20px 'PT Sans Narrow'",r.ccVis.canvas.width=109,r.ccVis.canvas.height=25,r.ccVis.fillStyle=`#${t.#M}`,r.extVis.canvas.width=47,r.extVis.canvas.height=25,r.extVis.fillStyle=`#${t.#M}`,D(r.notes,[r.cxt.canvas]),D(r.keys,[r.notes]),D(r.voice,[r.metre.canvas]),D(r.major,[r.number,r.voice,r.ccVis.canvas]),D(r.minor,[r.type,r.std,r.msb,r.prg,r.lsb,r.extVis.canvas]),D(r.root,[r.major,r.minor,r.keys]),D(t.#d[u].root,[r.root]),r.number.addEventListener("contextmenu",l=>{l.preventDefault(),l.stopImmediatePropagation();let h=u<<4|m;t.#J[h]=+!t.#J[h],[B,H][t.#J[h]](r.root,["part-hidden"])})}t.#d.root.appendChild(t.#d[u].root)}o.appendChild(t.#d.root),t.#v.root=k("div",["sect-meta"]),t.#v.view=k("div",["boundary"]),o.appendChild(t.#v.root),D(t.#v.root,[t.#v.view]),t.#f.root=k("div",["sect-pix","boundary"],{l:1529,t:950,w:379,h:127}),t.#f.cxt=k("canvas",["field"]).getContext("2d"),t.#f.fps=k("span",["field","field-key"],{l:0,w:"100%",h:1}),t.#f.cxt.canvas.width=379,t.#f.cxt.canvas.height=127,D(t.#f.root,[t.#f.cxt.canvas]),o.appendChild(t.#f.root),t.addEventListener("mode",u=>{t.#a.mode.setTextRaw(`${Ot[u.data]}`),t.setMode(u.data)}),t.addEventListener("mastervolume",u=>{let p=Math.round(u.data*100)/100;t.#a.volume.setTextRaw(`${Math.floor(p)}.${`${Math.floor(p%1*100)}`.padStart(2,"0")}`)}),t.addEventListener("tempo",u=>{let p=Math.round(u.data*100);t.#a.tempo.setTextRaw(`${Math.floor(p/100)}.${`${Math.floor(p%100)}`.padStart(2,"0")}`)}),t.addEventListener("tsig",u=>{[t.#a.sigN.innerText,t.#a.sigD.innerText]=u.data}),t.addEventListener("title",u=>{t.#a.title.setTextRaw(u.data||"No Title")}),t.addEventListener("voice",({data:u})=>{let p=t.getChVoice(u.part),m=t.#d[u.part>>4][u.part&15];at(m.metre,t.getMapped(p.name)),m.type.setTextRaw(At[t.device.getChType()[u.part]]),m.std.setTextRaw(p.standard),m.msb.setTextRaw(`${p.sid[0]}`.padStart(3,"0")),m.prg.setTextRaw(`${p.sid[1]}`.padStart(3,"0")),m.lsb.setTextRaw(`${p.sid[2]}`.padStart(3,"0"))}),t.addEventListener("pitch",u=>{let{part:p,pitch:m}=u.data;t.#d[p>>4][p&15].notes.style.transform=`translateX(${m/1.28}%)`}),t.addEventListener("efxreverb",u=>{t.#a.reverb.setTextRaw(t.getEfx(u.data))}),t.addEventListener("efxchorus",u=>{t.#a.chorus.setTextRaw(t.getEfx(u.data))}),t.addEventListener("efxdelay",u=>{t.#a.delay.setTextRaw(t.getEfx(u.data))}),t.addEventListener("efxinsert0",u=>{t.#a.insert.setTextRaw(t.getEfx(u.data))}),t.addEventListener("partefxtoggle",u=>{let{part:p,active:m}=u.data;[B,H][m](t.#d[p>>4][p&15].number,["part-efx"])}),t.addEventListener("channeltoggle",u=>{let{part:p,active:m}=u.data;[B,H][m](t.#d[p>>4][p&15].root,["part-active"])}),t.addEventListener("channelactive",u=>{if(t.#l<b.ch){let m=t.#d[t.#l>>4][t.#l&15].number;B(m,["part-focus"])}let p=u.data;if(p<b.ch){let m=t.#d[p>>4][p&15].number;H(m,["part-focus"]),t.#l=p}}),t.addEventListener("metacommit",u=>{let p=u.data,m=!1;if(t.#S&&p.type===t.#k&&t.#u){switch(p.type){case"C.Lyrics":case"KarLyric":case"SGLyrics":{D(t.#u,[k("span",["meta-slice"],{i:p.data})]);break}default:t.#u.childNodes[0].data+=p.data}m=!0}else if(p.data?.length&&Nt.indexOf(p.type)===-1){let y=k("div",["meta-line"]),r=k("span",["field","field-key","meta-type"],{i:It[p.type]||p.type});switch(p.mask&&(r.style.display="none"),p.type){case"C.Lyrics":case"KarLyric":case"SGLyrics":{t.#u=k("span",["field","meta-data"]),D(t.#u,[k("span",["meta-slice"],{i:p.data})]);break}default:t.#u=k("span",["field","meta-data"],{i:p.data})}for(t.#v.view.appendChild(y),D(y,[r,t.#u]),t.#v.view.children.length>t.#p&&(t.#g=Date.now()+500,t.#h===0&&console.debug("Meta event garbage collector triggered."),t.#h=1);t.#v.view.children.length>t.#C;)t.#v.view.children[0].remove();m=!0}m&&(t.#S=p.amend??!1,t.#k=p.type??""),t.#ce()}),t.#v.view.style.transform="translateX(0px) translateY(140px)",t.#b=setInterval(async()=>{let u=Date.now();if(t.#h!==0)switch(t.#h){case 1:{if(u<t.#g)break;t.#v.view.style.transition="none";let p=0;for(;t.#v.view.children.length>t.#t;)t.#v.view.children[0].remove(),p++;t.#ce(),console.debug(`Meta event garbage collector removed ${p} events.`),t.#h=2;break}case 2:{if(u<t.#g+100)break;t.#v.view.style.transition="",T()&&console.debug("Meta event garbage collector restored meta animation."),t.#h=0;break}}},40),t.dispatchEvent("mode","?"),t.dispatchEvent("mastervolume",100),t.dispatchEvent("tempo",120),t.dispatchEvent("tsig",[4,4]),t.dispatchEvent("title",""),t.dispatchEvent("efxreverb",t.device.getEffectType(0)),t.dispatchEvent("efxchorus",t.device.getEffectType(1)),t.dispatchEvent("efxdelay",t.device.getEffectType(2)),t.dispatchEvent("efxinsert0",t.device.getEffectType(3)),t.#V(!0)}detach(e){let t=this;self.removeEventListener("resize",t.#X),t.#y.remove(),t.#y=void 0,t.#G.remove(),t.#G=void 0,t.#x=void 0,clearInterval(t.#q),clearInterval(t.#b)}constructor(e,t){super(new ze,.1,.75);let s=this;s.#X=s.#re.bind(this),s.#se=s.#te.bind(this),s.#I.fill(null),s.#A.fill(null),e&&s.attach(e),t&&s.setClockSource(t),s.setPixelProfile("none"),s.addEventListener("reset",()=>{s.#m=0,s.#r=0,s.#S=!1,s.#k="",s.#u=null,s.#l=b.invalidCh,s.#I.fill(null),s.#A.fill(null);try{let o=s.#v.view.children;for(let u=o.length-1;u>=0;u--)o[u].remove();s.#v.view.style.transform="translateX(0px) translateY(140px)";for(let u=0;u<b.ch;u++){let p=s.#d[u>>4][u&15];B(p.root,["part-active"]),B(p.number,["part-efx","part-focus"]);for(let m of p.root.classList)m.substring(0,10)==="part-mode-"&&p.root.classList.remove(m);at(p.metre,""),p.type.setTextRaw(""),p.std.setTextRaw(""),p.msb.setTextRaw(""),p.prg.setTextRaw(""),p.lsb.setTextRaw(""),p.notes.style.transform="",p.ccUpdate=!0}}catch{}}),s.addEventListener("chmode",({data:o})=>{let{part:u,mode:p}=o;s.setChMode(u,p);let m=ce[p];m&&(s.#I[u]=m[s.#w])}),s.addEventListener("pitch",({data:o})=>{s.#W.push(o)})}};export{Ha as Cambiare};
